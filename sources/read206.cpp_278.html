
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>read206.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2016 Werner Schweer and others</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENSE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;xml.h&quot;</a>
<a name="ln14">#include &quot;score.h&quot;</a>
<a name="ln15">#include &quot;staff.h&quot;</a>
<a name="ln16">#include &quot;revisions.h&quot;</a>
<a name="ln17">#include &quot;part.h&quot;</a>
<a name="ln18">#include &quot;page.h&quot;</a>
<a name="ln19">#include &quot;style.h&quot;</a>
<a name="ln20">#include &quot;sym.h&quot;</a>
<a name="ln21">#include &quot;arpeggio.h&quot;</a>
<a name="ln22">#include &quot;audio.h&quot;</a>
<a name="ln23">#include &quot;sig.h&quot;</a>
<a name="ln24">#include &quot;barline.h&quot;</a>
<a name="ln25">#include &quot;measure.h&quot;</a>
<a name="ln26">#include &quot;ambitus.h&quot;</a>
<a name="ln27">#include &quot;bend.h&quot;</a>
<a name="ln28">#include &quot;chordline.h&quot;</a>
<a name="ln29">#include &quot;hook.h&quot;</a>
<a name="ln30">#include &quot;tuplet.h&quot;</a>
<a name="ln31">#include &quot;systemdivider.h&quot;</a>
<a name="ln32">#include &quot;spacer.h&quot;</a>
<a name="ln33">#include &quot;keysig.h&quot;</a>
<a name="ln34">#include &quot;stafftext.h&quot;</a>
<a name="ln35">#include &quot;dynamic.h&quot;</a>
<a name="ln36">#include &quot;drumset.h&quot;</a>
<a name="ln37">#include &quot;timesig.h&quot;</a>
<a name="ln38">#include &quot;slur.h&quot;</a>
<a name="ln39">#include &quot;tie.h&quot;</a>
<a name="ln40">#include &quot;chord.h&quot;</a>
<a name="ln41">#include &quot;rest.h&quot;</a>
<a name="ln42">#include &quot;breath.h&quot;</a>
<a name="ln43">#include &quot;repeat.h&quot;</a>
<a name="ln44">#include &quot;utils.h&quot;</a>
<a name="ln45">#include &quot;read206.h&quot;</a>
<a name="ln46">#include &quot;excerpt.h&quot;</a>
<a name="ln47">#include &quot;articulation.h&quot;</a>
<a name="ln48">#include &quot;volta.h&quot;</a>
<a name="ln49">#include &quot;pedal.h&quot;</a>
<a name="ln50">#include &quot;hairpin.h&quot;</a>
<a name="ln51">#include &quot;glissando.h&quot;</a>
<a name="ln52">#include &quot;ottava.h&quot;</a>
<a name="ln53">#include &quot;trill.h&quot;</a>
<a name="ln54">#include &quot;rehearsalmark.h&quot;</a>
<a name="ln55">#include &quot;box.h&quot;</a>
<a name="ln56">#include &quot;textframe.h&quot;</a>
<a name="ln57">#include &quot;textline.h&quot;</a>
<a name="ln58">#include &quot;fingering.h&quot;</a>
<a name="ln59">#include &quot;fermata.h&quot;</a>
<a name="ln60">#include &quot;image.h&quot;</a>
<a name="ln61">#include &quot;stem.h&quot;</a>
<a name="ln62">#include &quot;stemslash.h&quot;</a>
<a name="ln63">#include &quot;undo.h&quot;</a>
<a name="ln64">#include &quot;lyrics.h&quot;</a>
<a name="ln65">#include &quot;tempotext.h&quot;</a>
<a name="ln66">#include &quot;measurenumber.h&quot;</a>
<a name="ln67">#include &quot;marker.h&quot;</a>
<a name="ln68"> </a>
<a name="ln69">#ifdef OMR</a>
<a name="ln70">#include &quot;omr/omr.h&quot;</a>
<a name="ln71">#include &quot;omr/omrpage.h&quot;</a>
<a name="ln72">#endif</a>
<a name="ln73"> </a>
<a name="ln74"> </a>
<a name="ln75">namespace Ms {</a>
<a name="ln76"> </a>
<a name="ln77">static void readText206(XmlReader&amp; e, TextBase* t, Element* be);</a>
<a name="ln78"> </a>
<a name="ln79">//---------------------------------------------------------</a>
<a name="ln80">//   StyleVal206</a>
<a name="ln81">//    this is a list of default style values which are</a>
<a name="ln82">//    different in 3.x</a>
<a name="ln83">//</a>
<a name="ln84">// TODO: remove style values which are equal</a>
<a name="ln85">//---------------------------------------------------------</a>
<a name="ln86"> </a>
<a name="ln87">struct StyleVal2 {</a>
<a name="ln88">            Sid idx;</a>
<a name="ln89">            QVariant val;</a>
<a name="ln90">            };</a>
<a name="ln91">      static const StyleVal2 style206[] = {</a>
<a name="ln92">      { Sid::staffUpperBorder,            Spatium(7.0)  },</a>
<a name="ln93">      { Sid::staffLowerBorder,            Spatium(7.0)  },</a>
<a name="ln94">      { Sid::staffDistance,               Spatium(6.5)  },</a>
<a name="ln95">      { Sid::akkoladeDistance,            Spatium(6.5)  },</a>
<a name="ln96">      { Sid::minSystemDistance,           Spatium(8.5)  },</a>
<a name="ln97">      { Sid::maxSystemDistance,           Spatium(15.0) },</a>
<a name="ln98"> </a>
<a name="ln99">//      { Sid::lyricsMinBottomDistance,     Spatium(4.0)  },      // no longer makes sense</a>
<a name="ln100">      { Sid::lyricsLineHeight,            QVariant(1.0) },</a>
<a name="ln101">      { Sid::lyricsDashForce,             QVariant(false) },</a>
<a name="ln102">      { Sid::figuredBassFontFamily,       QVariant(QString(&quot;MScoreBC&quot;)) },</a>
<a name="ln103">      { Sid::figuredBassFontSize,         QVariant(8.0) },</a>
<a name="ln104">      { Sid::figuredBassYOffset,          QVariant(6.0) },</a>
<a name="ln105">      { Sid::figuredBassLineHeight,       QVariant(1.0) },</a>
<a name="ln106">      { Sid::figuredBassAlignment,        QVariant(0) },</a>
<a name="ln107">      { Sid::figuredBassStyle,            QVariant(0) },</a>
<a name="ln108">      { Sid::systemFrameDistance,         Spatium(7.0) },</a>
<a name="ln109">      { Sid::frameSystemDistance,         Spatium(7.0) },</a>
<a name="ln110">      { Sid::minMeasureWidth,             Spatium(5.0) },</a>
<a name="ln111">      { Sid::barWidth,                    Spatium(0.16) },      // 0.1875</a>
<a name="ln112">      { Sid::doubleBarWidth,              Spatium(0.16) },</a>
<a name="ln113">      { Sid::endBarWidth,                 Spatium(0.5) },       // 0.5</a>
<a name="ln114">      { Sid::doubleBarDistance,           Spatium(0.46) },     // 0.3 + doubleBarWidth</a>
<a name="ln115">      { Sid::endBarDistance,              Spatium(0.65) },     // 0.3</a>
<a name="ln116">      { Sid::repeatBarTips,               QVariant(false) },</a>
<a name="ln117">      { Sid::startBarlineSingle,          QVariant(false) },</a>
<a name="ln118">      { Sid::startBarlineMultiple,        QVariant(true) },</a>
<a name="ln119">      { Sid::bracketWidth,                Spatium(0.45) },</a>
<a name="ln120">      { Sid::bracketDistance,             Spatium(0.1) },</a>
<a name="ln121">      { Sid::akkoladeWidth,               Spatium(1.6) },</a>
<a name="ln122">      { Sid::akkoladeBarDistance,         Spatium(.4) },</a>
<a name="ln123">      { Sid::clefLeftMargin,              Spatium(0.64) },</a>
<a name="ln124">      { Sid::keysigLeftMargin,            Spatium(0.5) },</a>
<a name="ln125">      { Sid::timesigLeftMargin,           Spatium(0.5) },</a>
<a name="ln126">      { Sid::clefKeyRightMargin,          Spatium(1.75) },</a>
<a name="ln127">      { Sid::clefBarlineDistance,         Spatium(0.5) },</a>
<a name="ln128">      { Sid::stemWidth,                   Spatium(0.13) },      // 0.09375</a>
<a name="ln129">      { Sid::shortenStem,                 QVariant(true) },</a>
<a name="ln130">      { Sid::shortStemProgression,        Spatium(0.25) },</a>
<a name="ln131">      { Sid::shortestStem,                Spatium(2.25) },</a>
<a name="ln132">      { Sid::beginRepeatLeftMargin,       Spatium(1.0) },</a>
<a name="ln133">      { Sid::minNoteDistance,             Spatium(0.25) },      // 0.4</a>
<a name="ln134">      { Sid::barNoteDistance,             Spatium(1.2) },</a>
<a name="ln135">      { Sid::barAccidentalDistance,       Spatium(.3) },</a>
<a name="ln136">      { Sid::multiMeasureRestMargin,      Spatium(1.2) },</a>
<a name="ln137">      { Sid::noteBarDistance,             Spatium(1.0) },</a>
<a name="ln138">      { Sid::measureSpacing,              QVariant(1.2) },</a>
<a name="ln139">      { Sid::staffLineWidth,              Spatium(0.08) },      // 0.09375</a>
<a name="ln140">      { Sid::ledgerLineWidth,             Spatium(0.16) },     // 0.1875</a>
<a name="ln141">      { Sid::ledgerLineLength,            Spatium(.6) },     // notehead width + this value</a>
<a name="ln142">      { Sid::accidentalDistance,          Spatium(0.22) },</a>
<a name="ln143">      { Sid::accidentalNoteDistance,      Spatium(0.22) },</a>
<a name="ln144">      { Sid::beamWidth,                   Spatium(0.5) },           // was 0.48</a>
<a name="ln145">      { Sid::beamDistance,                QVariant(0.5) },          // 0.25sp</a>
<a name="ln146">      { Sid::beamMinLen,                  QVariant(1.32) },      // 1.316178 exactly notehead width</a>
<a name="ln147">      { Sid::beamNoSlope,                 QVariant(false) },</a>
<a name="ln148">      { Sid::dotMag,                      QVariant(1.0) },</a>
<a name="ln149">      { Sid::dotNoteDistance,             QVariant(0.35) },</a>
<a name="ln150">      { Sid::dotRestDistance,             QVariant(0.25) },</a>
<a name="ln151">      { Sid::dotDotDistance,              QVariant(0.5) },</a>
<a name="ln152">      { Sid::propertyDistanceHead,        QVariant(1.0) },</a>
<a name="ln153">      { Sid::propertyDistanceStem,        QVariant(1.8) },</a>
<a name="ln154">      { Sid::propertyDistance,            QVariant(1.0) },</a>
<a name="ln155">      { Sid::articulationMag,             QVariant(1.0) },</a>
<a name="ln156">      { Sid::lastSystemFillLimit,         QVariant(0.3) },</a>
<a name="ln157">      { Sid::hairpinPosBelow,             QPointF(0.0, 3.5) },</a>
<a name="ln158">      { Sid::hairpinHeight,               QVariant(1.2) },</a>
<a name="ln159">      { Sid::hairpinContHeight,           QVariant(0.5) },</a>
<a name="ln160">      { Sid::hairpinLineWidth,            QVariant(0.13) },</a>
<a name="ln161">      { Sid::pedalPosBelow,               QPointF(0.0, 4) },</a>
<a name="ln162">      { Sid::pedalLineWidth,              QVariant(.15) },</a>
<a name="ln163">      { Sid::pedalLineStyle,              QVariant(int(Qt::SolidLine)) },</a>
<a name="ln164">      { Sid::trillPosAbove,               QPointF(0.0, -1) },</a>
<a name="ln165">      { Sid::harmonyFretDist,             QVariant(0.5) },</a>
<a name="ln166">      { Sid::minHarmonyDistance,          QVariant(0.5) },</a>
<a name="ln167">      { Sid::maxHarmonyBarDistance,       QVariant(3.0) },</a>
<a name="ln168">      { Sid::capoPosition,                QVariant(0) },</a>
<a name="ln169">      { Sid::fretNumMag,                  QVariant(2.0) },</a>
<a name="ln170">      { Sid::fretNumPos,                  QVariant(0) },</a>
<a name="ln171">      { Sid::fretY,                       QVariant(2.0) },</a>
<a name="ln172">      { Sid::showPageNumber,              QVariant(true) },</a>
<a name="ln173">      { Sid::showPageNumberOne,           QVariant(false) },</a>
<a name="ln174">      { Sid::pageNumberOddEven,           QVariant(true) },</a>
<a name="ln175">      { Sid::showMeasureNumber,           QVariant(true) },</a>
<a name="ln176">      { Sid::showMeasureNumberOne,        QVariant(false) },</a>
<a name="ln177">      { Sid::measureNumberInterval,       QVariant(5) },</a>
<a name="ln178">      { Sid::measureNumberSystem,         QVariant(true) },</a>
<a name="ln179">      { Sid::measureNumberAllStaffs,      QVariant(false) },</a>
<a name="ln180">      { Sid::smallNoteMag,                QVariant(.7) },</a>
<a name="ln181">      { Sid::graceNoteMag,                QVariant(0.7) },</a>
<a name="ln182">      { Sid::smallStaffMag,               QVariant(0.7) },</a>
<a name="ln183">      { Sid::smallClefMag,                QVariant(0.8) },</a>
<a name="ln184">      { Sid::genClef,                     QVariant(true) },</a>
<a name="ln185">      { Sid::genKeysig,                   QVariant(true) },</a>
<a name="ln186">      { Sid::genCourtesyTimesig,          QVariant(true) },</a>
<a name="ln187">      { Sid::genCourtesyKeysig,           QVariant(true) },</a>
<a name="ln188">      { Sid::genCourtesyClef,             QVariant(true) },</a>
<a name="ln189">      { Sid::swingRatio,                  QVariant(60)   },</a>
<a name="ln190">      { Sid::swingUnit,                   QVariant(QString(&quot;&quot;)) },</a>
<a name="ln191">      { Sid::useStandardNoteNames,        QVariant(true) },</a>
<a name="ln192">      { Sid::useGermanNoteNames,          QVariant(false) },</a>
<a name="ln193">      { Sid::useFullGermanNoteNames,      QVariant(false) },</a>
<a name="ln194">      { Sid::useSolfeggioNoteNames,       QVariant(false) },</a>
<a name="ln195">      { Sid::useFrenchNoteNames,          QVariant(false) },</a>
<a name="ln196">      { Sid::automaticCapitalization,     QVariant(true) },</a>
<a name="ln197">      { Sid::lowerCaseMinorChords,        QVariant(false) },</a>
<a name="ln198">      { Sid::lowerCaseBassNotes,          QVariant(false) },</a>
<a name="ln199">      { Sid::allCapsNoteNames,            QVariant(false) },</a>
<a name="ln200">      { Sid::chordStyle,                  QVariant(QString(&quot;std&quot;)) },</a>
<a name="ln201">      { Sid::chordsXmlFile,               QVariant(false) },</a>
<a name="ln202">      { Sid::chordDescriptionFile,        QVariant(QString(&quot;chords_std.xml&quot;)) },</a>
<a name="ln203">      { Sid::concertPitch,                QVariant(false) },</a>
<a name="ln204">      { Sid::createMultiMeasureRests,     QVariant(false) },</a>
<a name="ln205">      { Sid::minEmptyMeasures,            QVariant(2) },</a>
<a name="ln206">      { Sid::minMMRestWidth,              Spatium(4) },</a>
<a name="ln207">      { Sid::hideEmptyStaves,             QVariant(false) },</a>
<a name="ln208">      { Sid::dontHideStavesInFirstSystem, QVariant(true) },</a>
<a name="ln209">      { Sid::hideInstrumentNameIfOneInstrument, QVariant(true) },</a>
<a name="ln210">      { Sid::gateTime,                    QVariant(100) },</a>
<a name="ln211">      { Sid::tenutoGateTime,              QVariant(100) },</a>
<a name="ln212">      { Sid::staccatoGateTime,            QVariant(50) },</a>
<a name="ln213">      { Sid::slurGateTime,                QVariant(100) },</a>
<a name="ln214">      { Sid::ArpeggioNoteDistance,        QVariant(.5) },</a>
<a name="ln215">      { Sid::ArpeggioLineWidth,           QVariant(.18) },</a>
<a name="ln216">      { Sid::ArpeggioHookLen,             QVariant(.8) },</a>
<a name="ln217">      { Sid::SlurEndWidth,                QVariant(.07) },</a>
<a name="ln218">      { Sid::SlurMidWidth,                QVariant(.15) },</a>
<a name="ln219">      { Sid::SlurDottedWidth,             QVariant(.1) },</a>
<a name="ln220">      { Sid::MinTieLength,                QVariant(1.0) },</a>
<a name="ln221">      { Sid::SectionPause,                QVariant(qreal(3.0)) },</a>
<a name="ln222">      { Sid::MusicalSymbolFont,           QVariant(QString(&quot;Emmentaler&quot;)) },</a>
<a name="ln223">      { Sid::MusicalTextFont,             QVariant(QString(&quot;MScore Text&quot;)) },</a>
<a name="ln224">      { Sid::showHeader,                  QVariant(false) },</a>
<a name="ln225">      { Sid::headerFirstPage,             QVariant(false) },</a>
<a name="ln226">      { Sid::headerOddEven,               QVariant(true) },</a>
<a name="ln227">      { Sid::evenHeaderL,                 QVariant(QString()) },</a>
<a name="ln228">      { Sid::evenHeaderC,                 QVariant(QString()) },</a>
<a name="ln229">      { Sid::evenHeaderR,                 QVariant(QString()) },</a>
<a name="ln230">      { Sid::oddHeaderL,                  QVariant(QString()) },</a>
<a name="ln231">      { Sid::oddHeaderC,                  QVariant(QString()) },</a>
<a name="ln232">      { Sid::oddHeaderR,                  QVariant(QString()) },</a>
<a name="ln233">      { Sid::showFooter,                  QVariant(true) },</a>
<a name="ln234">      { Sid::footerFirstPage,             QVariant(true) },</a>
<a name="ln235">      { Sid::footerOddEven,               QVariant(true) },</a>
<a name="ln236">      { Sid::evenFooterL,                 QVariant(QString(&quot;$p&quot;)) },</a>
<a name="ln237">      { Sid::evenFooterC,                 QVariant(QString(&quot;$:copyright:&quot;)) },</a>
<a name="ln238">      { Sid::evenFooterR,                 QVariant(QString()) },</a>
<a name="ln239">      { Sid::oddFooterL,                  QVariant(QString()) },</a>
<a name="ln240">      { Sid::oddFooterC,                  QVariant(QString(&quot;$:copyright:&quot;)) },</a>
<a name="ln241">      { Sid::oddFooterR,                  QVariant(QString(&quot;$p&quot;)) },</a>
<a name="ln242">      { Sid::voltaPosAbove,               QPointF(0.0, -3.0) },</a>
<a name="ln243">      { Sid::voltaHook,                   QVariant(1.9) },</a>
<a name="ln244">      { Sid::voltaLineWidth,              QVariant(.1) },</a>
<a name="ln245">      { Sid::voltaLineStyle,              QVariant(int(Qt::SolidLine)) },</a>
<a name="ln246">      { Sid::ottavaPosAbove,              QPointF(0.0, -3.0) },</a>
<a name="ln247">      { Sid::ottavaHookAbove,             QVariant(1.9) },</a>
<a name="ln248">      { Sid::ottavaHookBelow,             QVariant(-1.9) },</a>
<a name="ln249">      { Sid::ottavaLineWidth,             QVariant(.1) },</a>
<a name="ln250">      { Sid::ottavaLineStyle,             QVariant(int(Qt::DashLine)) },</a>
<a name="ln251">      { Sid::ottavaNumbersOnly,           true },</a>
<a name="ln252">      { Sid::tabClef,                     QVariant(int(ClefType::TAB)) },</a>
<a name="ln253">      { Sid::tremoloWidth,                QVariant(1.2) },  // tremolo stroke width: notehead width</a>
<a name="ln254">      { Sid::tremoloBoxHeight,            QVariant(0.65) },</a>
<a name="ln255">      { Sid::tremoloStrokeWidth,          QVariant(0.5) },  // was 0.35</a>
<a name="ln256">      { Sid::tremoloDistance,             QVariant(0.8) },</a>
<a name="ln257">      // TODO { Sid::tremoloBeamLengthMultiplier, QVariant(0.62) },</a>
<a name="ln258">      // TODO { Sid::tremoloMaxBeamLength,        QVariant(12.0) },</a>
<a name="ln259">      { Sid::linearStretch,               QVariant(qreal(1.5)) },</a>
<a name="ln260">      { Sid::crossMeasureValues,          QVariant(false) },</a>
<a name="ln261">      { Sid::keySigNaturals,              QVariant(int(KeySigNatural::NONE)) },</a>
<a name="ln262"> </a>
<a name="ln263">      { Sid::tupletMaxSlope,              QVariant(qreal(0.5)) },</a>
<a name="ln264">      { Sid::tupletOufOfStaff,            QVariant(true) },</a>
<a name="ln265">      { Sid::tupletVHeadDistance,         QVariant(.5) },</a>
<a name="ln266">      { Sid::tupletVStemDistance,         QVariant(.25) },</a>
<a name="ln267">      { Sid::tupletStemLeftDistance,      QVariant(.5) },</a>
<a name="ln268">      { Sid::tupletStemRightDistance,     QVariant(.5) },</a>
<a name="ln269">      { Sid::tupletNoteLeftDistance,      QVariant(0.0) },</a>
<a name="ln270">      { Sid::tupletNoteRightDistance,     QVariant(0.0) },</a>
<a name="ln271"> </a>
<a name="ln272">      { Sid::barreLineWidth,              QVariant(1.0) },</a>
<a name="ln273">      { Sid::fretMag,                     QVariant(1.0) },</a>
<a name="ln274">      { Sid::scaleBarlines,               QVariant(true) },</a>
<a name="ln275">      { Sid::barGraceDistance,            QVariant(.6) },</a>
<a name="ln276">      { Sid::rehearsalMarkFrameRound,     QVariant(20)    },</a>
<a name="ln277">      { Sid::dynamicsFontStyle,           int(FontStyle::Italic) },</a>
<a name="ln278"> </a>
<a name="ln279">//      { Sid::staffTextFontFace,           &quot;FreeSerif&quot; },</a>
<a name="ln280">//      { Sid::staffTextFontSize,           10.0 },</a>
<a name="ln281">//      { Sid::staffTextFontBold,           false },</a>
<a name="ln282">//      { Sid::staffTextFontItalic,         false },</a>
<a name="ln283">//      { Sid::staffTextFontUnderline,      false },</a>
<a name="ln284">      { Sid::staffTextAlign,              QVariant::fromValue(Align::LEFT | Align::TOP) },      // different from 3.x</a>
<a name="ln285">//      { Sid::staffTextOffsetType,         int(OffsetType::SPATIUM)   },</a>
<a name="ln286">//      { Sid::staffTextPlacement,          int(Placement::ABOVE) },</a>
<a name="ln287">      { Sid::staffTextPosAbove,           QPointF(.0, -4.0) },</a>
<a name="ln288">//      { Sid::staffTextMinDistance,        Spatium(0.5)  },</a>
<a name="ln289">//      { Sid::staffTextFrameType,          int(FrameType::NO_FRAME) },</a>
<a name="ln290">//      { Sid::staffTextFramePadding,       0.2 },</a>
<a name="ln291">//      { Sid::staffTextFrameWidth,         0.1 },</a>
<a name="ln292">//      { Sid::staffTextFrameRound,         0  },</a>
<a name="ln293">//      { Sid::staffTextFrameFgColor,       QColor(0, 0, 0, 255) },</a>
<a name="ln294">//      { Sid::staffTextFrameBgColor,       QColor(255, 255, 255, 0) },</a>
<a name="ln295">      { Sid::defaultFrameRound,           QVariant(25) },</a>
<a name="ln296">      { Sid::defaultFrameWidth,           Spatium(0.2) },</a>
<a name="ln297">      { Sid::defaultFramePadding,         Spatium(0.5) },</a>
<a name="ln298"> </a>
<a name="ln299">      { Sid::titleFrameRound,             QVariant(25) },</a>
<a name="ln300">      { Sid::titleFrameWidth,             Spatium(0.2) },</a>
<a name="ln301">      { Sid::titleFramePadding,           Spatium(0.5) },</a>
<a name="ln302"> </a>
<a name="ln303">      { Sid::subTitleFrameRound,          QVariant(25) },</a>
<a name="ln304">      { Sid::subTitleFrameWidth,          Spatium(0.2) },</a>
<a name="ln305">      { Sid::subTitleFramePadding,        Spatium(0.5) },</a>
<a name="ln306"> </a>
<a name="ln307">      { Sid::composerFrameRound,          QVariant(25) },</a>
<a name="ln308">      { Sid::composerFrameWidth,          Spatium(0.2) },</a>
<a name="ln309">      { Sid::composerFramePadding,        Spatium(0.5) },</a>
<a name="ln310"> </a>
<a name="ln311">      { Sid::lyricistFrameRound,          QVariant(25) },</a>
<a name="ln312">      { Sid::lyricistFrameWidth,          Spatium(0.2) },</a>
<a name="ln313">      { Sid::lyricistFramePadding,        Spatium(0.5) },</a>
<a name="ln314"> </a>
<a name="ln315">      { Sid::fingeringFrameRound,          QVariant(25) },</a>
<a name="ln316">      { Sid::fingeringFrameWidth,          Spatium(0.2) },</a>
<a name="ln317">      { Sid::fingeringFramePadding,        Spatium(0.5) },</a>
<a name="ln318"> </a>
<a name="ln319">      { Sid::lhGuitarFingeringFrameRound,       QVariant(25) },</a>
<a name="ln320">      { Sid::lhGuitarFingeringFrameWidth,       Spatium(0.2) },</a>
<a name="ln321">      { Sid::lhGuitarFingeringFramePadding,     Spatium(0.5) },</a>
<a name="ln322"> </a>
<a name="ln323">      { Sid::rhGuitarFingeringFrameRound,       QVariant(25) },</a>
<a name="ln324">      { Sid::rhGuitarFingeringFrameWidth,       Spatium(0.2) },</a>
<a name="ln325">      { Sid::rhGuitarFingeringFramePadding,     Spatium(0.5) },</a>
<a name="ln326"> </a>
<a name="ln327">      { Sid::partInstrumentFrameRound,    QVariant(25) },</a>
<a name="ln328">      { Sid::partInstrumentFrameWidth,    Spatium(0.2) },</a>
<a name="ln329">      { Sid::partInstrumentFramePadding,  Spatium(0.5) },</a>
<a name="ln330"> </a>
<a name="ln331">      { Sid::tempoFrameRound,             QVariant(0)  },</a>
<a name="ln332">      { Sid::tempoFrameWidth,             Spatium(0.2) },</a>
<a name="ln333">      { Sid::tempoFramePadding,           Spatium(0.5) },</a>
<a name="ln334"> </a>
<a name="ln335">      { Sid::tempoFrameRound,             QVariant(25) },</a>
<a name="ln336">      { Sid::tempoFrameWidth,             Spatium(0.2) },</a>
<a name="ln337">      { Sid::tempoFramePadding,           Spatium(0.5) },</a>
<a name="ln338"> </a>
<a name="ln339">      { Sid::systemTextFrameRound,        QVariant(25) },</a>
<a name="ln340">      { Sid::systemTextFrameWidth,        Spatium(0.2) },</a>
<a name="ln341">      { Sid::systemTextFramePadding,      Spatium(0.5) },</a>
<a name="ln342"> </a>
<a name="ln343">      { Sid::staffTextFrameRound,         QVariant(25) },</a>
<a name="ln344">      { Sid::staffTextFrameWidth,         Spatium(0.2) },</a>
<a name="ln345">      { Sid::staffTextFramePadding,       Spatium(0.5) },</a>
<a name="ln346"> </a>
<a name="ln347">      { Sid::rehearsalMarkFrameRound,     QVariant(20) },</a>
<a name="ln348">      { Sid::rehearsalMarkFrameWidth,     Spatium(0.2) },</a>
<a name="ln349">      { Sid::rehearsalMarkFramePadding,   Spatium(0.5) },</a>
<a name="ln350"> </a>
<a name="ln351">      { Sid::repeatLeftFrameRound,        QVariant(25) },</a>
<a name="ln352">      { Sid::repeatLeftFrameWidth,        Spatium(0.2) },</a>
<a name="ln353">      { Sid::repeatLeftFramePadding,      Spatium(0.5) },</a>
<a name="ln354"> </a>
<a name="ln355">      { Sid::repeatRightFrameRound,       QVariant(25) },</a>
<a name="ln356">      { Sid::repeatRightFrameWidth,       Spatium(0.2) },</a>
<a name="ln357">      { Sid::repeatRightFramePadding,     Spatium(0.5) },</a>
<a name="ln358">      };</a>
<a name="ln359"> </a>
<a name="ln360">//---------------------------------------------------------</a>
<a name="ln361">//   excessTextStyles206</a>
<a name="ln362">//    The first map has the name of the style as the string</a>
<a name="ln363">//    The second map has the mapping of each Sid that the style identifies</a>
<a name="ln364">//    to the default value for that sid.</a>
<a name="ln365">//---------------------------------------------------------</a>
<a name="ln366"> </a>
<a name="ln367">static std::map&lt;QString, std::map&lt;Sid, QVariant&gt;&gt; excessTextStyles206;</a>
<a name="ln368"> </a>
<a name="ln369">//---------------------------------------------------------</a>
<a name="ln370">//   setPageFormat</a>
<a name="ln371">//    set Style from PageFormat</a>
<a name="ln372">//---------------------------------------------------------</a>
<a name="ln373"> </a>
<a name="ln374">void setPageFormat(MStyle* style, const PageFormat&amp; pf)</a>
<a name="ln375">      {</a>
<a name="ln376">      style-&gt;set(Sid::pageWidth,            pf.size().width());</a>
<a name="ln377">      style-&gt;set(Sid::pageHeight,           pf.size().height());</a>
<a name="ln378">      style-&gt;set(Sid::pagePrintableWidth,   pf.printableWidth());</a>
<a name="ln379">      style-&gt;set(Sid::pageEvenLeftMargin,   pf.evenLeftMargin());</a>
<a name="ln380">      style-&gt;set(Sid::pageOddLeftMargin,    pf.oddLeftMargin());</a>
<a name="ln381">      style-&gt;set(Sid::pageEvenTopMargin,    pf.evenTopMargin());</a>
<a name="ln382">      style-&gt;set(Sid::pageEvenBottomMargin, pf.evenBottomMargin());</a>
<a name="ln383">      style-&gt;set(Sid::pageOddTopMargin,     pf.oddTopMargin());</a>
<a name="ln384">      style-&gt;set(Sid::pageOddBottomMargin,  pf.oddBottomMargin());</a>
<a name="ln385">      style-&gt;set(Sid::pageTwosided,         pf.twosided());</a>
<a name="ln386">      }</a>
<a name="ln387"> </a>
<a name="ln388">//---------------------------------------------------------</a>
<a name="ln389">//   initPageFormat</a>
<a name="ln390">//    initialize PageFormat from Style</a>
<a name="ln391">//---------------------------------------------------------</a>
<a name="ln392"> </a>
<a name="ln393">void initPageFormat(MStyle* style, PageFormat* pf)</a>
<a name="ln394">      {</a>
<a name="ln395">      QSizeF sz;</a>
<a name="ln396">      sz.setWidth(style-&gt;value(Sid::pageWidth).toReal());</a>
<a name="ln397">      sz.setHeight(style-&gt;value(Sid::pageHeight).toReal());</a>
<a name="ln398">      pf-&gt;setSize(sz);</a>
<a name="ln399">      pf-&gt;setPrintableWidth(style-&gt;value(Sid::pagePrintableWidth).toReal());</a>
<a name="ln400">      pf-&gt;setEvenLeftMargin(style-&gt;value(Sid::pageEvenLeftMargin).toReal());</a>
<a name="ln401">      pf-&gt;setOddLeftMargin(style-&gt;value(Sid::pageOddLeftMargin).toReal());</a>
<a name="ln402">      pf-&gt;setEvenTopMargin(style-&gt;value(Sid::pageEvenTopMargin).toReal());</a>
<a name="ln403">      pf-&gt;setEvenBottomMargin(style-&gt;value(Sid::pageEvenBottomMargin).toReal());</a>
<a name="ln404">      pf-&gt;setOddTopMargin(style-&gt;value(Sid::pageOddTopMargin).toReal());</a>
<a name="ln405">      pf-&gt;setOddBottomMargin(style-&gt;value(Sid::pageOddBottomMargin).toReal());</a>
<a name="ln406">      pf-&gt;setTwosided(style-&gt;value(Sid::pageTwosided).toBool());</a>
<a name="ln407">      }</a>
<a name="ln408"> </a>
<a name="ln409">//---------------------------------------------------------</a>
<a name="ln410">//   readPageFormat</a>
<a name="ln411">//---------------------------------------------------------</a>
<a name="ln412"> </a>
<a name="ln413">void readPageFormat(MStyle* style, XmlReader&amp; e)</a>
<a name="ln414">      {</a>
<a name="ln415">      PageFormat pf;</a>
<a name="ln416">      initPageFormat(style, &amp;pf);</a>
<a name="ln417">      pf.read(e);</a>
<a name="ln418">      setPageFormat(style, pf);</a>
<a name="ln419">      }</a>
<a name="ln420"> </a>
<a name="ln421">//---------------------------------------------------------</a>
<a name="ln422">//   readTextStyle206</a>
<a name="ln423">//---------------------------------------------------------</a>
<a name="ln424"> </a>
<a name="ln425">void readTextStyle206(MStyle* style, XmlReader&amp; e, std::map&lt;QString, std::map&lt;Sid, QVariant&gt;&gt;&amp; excessStyles)</a>
<a name="ln426">      {</a>
<a name="ln427">      QString family = &quot;FreeSerif&quot;;</a>
<a name="ln428">      double size = 10;</a>
<a name="ln429">      bool sizeIsSpatiumDependent = false;</a>
<a name="ln430">      FontStyle fontStyle = FontStyle::Normal;</a>
<a name="ln431">      Align align = Align::LEFT;</a>
<a name="ln432">      QPointF offset;</a>
<a name="ln433">      OffsetType offsetType = OffsetType::SPATIUM;</a>
<a name="ln434"> </a>
<a name="ln435">      FrameType frameType = FrameType::NO_FRAME;</a>
<a name="ln436">      Spatium paddingWidth(0.0);</a>
<a name="ln437">      Spatium frameWidth(0.0);</a>
<a name="ln438">      QColor foregroundColor = QColor(0, 0, 0, 255);</a>
<a name="ln439">      QColor backgroundColor = QColor(255, 255, 255, 0);</a>
<a name="ln440"> </a>
<a name="ln441">      Placement placement = Placement::ABOVE;</a>
<a name="ln442">      bool placementValid = false;</a>
<a name="ln443"> </a>
<a name="ln444">      QString name = e.attribute(&quot;name&quot;);</a>
<a name="ln445">      QColor frameColor = QColor(0, 0, 0, 255);</a>
<a name="ln446"> </a>
<a name="ln447">      bool systemFlag = false;</a>
<a name="ln448">      qreal lineWidth = -1.0;</a>
<a name="ln449"> </a>
<a name="ln450">      while (e.readNextStartElement()) {</a>
<a name="ln451">            const QStringRef&amp; tag(e.name());</a>
<a name="ln452"> </a>
<a name="ln453">            if (tag == &quot;name&quot;)</a>
<a name="ln454">                  name = e.readElementText();</a>
<a name="ln455">            else if (tag == &quot;family&quot;)</a>
<a name="ln456">                  family = e.readElementText();</a>
<a name="ln457">            else if (tag == &quot;size&quot;)</a>
<a name="ln458">                  size = e.readDouble();</a>
<a name="ln459">            else if (tag == &quot;bold&quot;) {</a>
<a name="ln460">                  if (e.readInt())</a>
<a name="ln461">                        fontStyle = fontStyle + FontStyle::Bold;</a>
<a name="ln462">                  }</a>
<a name="ln463">            else if (tag == &quot;italic&quot;) {</a>
<a name="ln464">                  if (e.readInt())</a>
<a name="ln465">                        fontStyle = fontStyle + FontStyle::Italic;</a>
<a name="ln466">                  }</a>
<a name="ln467">            else if (tag == &quot;underline&quot;) {</a>
<a name="ln468">                  if (e.readInt())</a>
<a name="ln469">                        fontStyle = fontStyle + FontStyle::Underline;</a>
<a name="ln470">                  }</a>
<a name="ln471">            else if (tag == &quot;align&quot;)</a>
<a name="ln472">                  align = Align(e.readInt());</a>
<a name="ln473">            else if (tag == &quot;anchor&quot;)     // obsolete</a>
<a name="ln474">                  e.skipCurrentElement();</a>
<a name="ln475"> </a>
<a name="ln476">            else if (tag == &quot;halign&quot;) {</a>
<a name="ln477">                  const QString&amp; val(e.readElementText());</a>
<a name="ln478">                  if (val == &quot;center&quot;)</a>
<a name="ln479">                        align = align | Align::HCENTER;</a>
<a name="ln480">                  else if (val == &quot;right&quot;)</a>
<a name="ln481">                        align = align | Align::RIGHT;</a>
<a name="ln482">                  else if (val == &quot;left&quot;)</a>
<a name="ln483">                        ;</a>
<a name="ln484">                  else</a>
<a name="ln485">                        qDebug(&quot;Text::readProperties: unknown alignment: &lt;%s&gt;&quot;, qPrintable(val));</a>
<a name="ln486">                  }</a>
<a name="ln487">            else if (tag == &quot;valign&quot;) {</a>
<a name="ln488">                  const QString&amp; val(e.readElementText());</a>
<a name="ln489">                  if (val == &quot;center&quot;)</a>
<a name="ln490">                        align = align | Align::VCENTER;</a>
<a name="ln491">                  else if (val == &quot;bottom&quot;)</a>
<a name="ln492">                        align = align | Align::BOTTOM;</a>
<a name="ln493">                  else if (val == &quot;baseline&quot;)</a>
<a name="ln494">                        align = align | Align::BASELINE;</a>
<a name="ln495">                  else if (val == &quot;top&quot;)</a>
<a name="ln496">                        ;</a>
<a name="ln497">                  else</a>
<a name="ln498">                        qDebug(&quot;Text::readProperties: unknown alignment: &lt;%s&gt;&quot;, qPrintable(val));</a>
<a name="ln499">                  }</a>
<a name="ln500">            else if (tag == &quot;xoffset&quot;) {</a>
<a name="ln501">                  qreal xo = e.readDouble();</a>
<a name="ln502">                  if (offsetType == OffsetType::ABS)</a>
<a name="ln503">                        xo /= INCH;</a>
<a name="ln504">                  offset.setX(xo);</a>
<a name="ln505">                  }</a>
<a name="ln506">            else if (tag == &quot;yoffset&quot;) {</a>
<a name="ln507">                  qreal yo = e.readDouble();</a>
<a name="ln508">                  if (offsetType == OffsetType::ABS)</a>
<a name="ln509">                        yo /= INCH;</a>
<a name="ln510">                  offset.setY(yo);</a>
<a name="ln511">                  }</a>
<a name="ln512">            else if (tag == &quot;rxoffset&quot; || tag == &quot;ryoffset&quot;)         // obsolete</a>
<a name="ln513">                  e.readDouble();</a>
<a name="ln514">            else if (tag == &quot;offsetType&quot;) {</a>
<a name="ln515">                  const QString&amp; val(e.readElementText());</a>
<a name="ln516">                  OffsetType ot = OffsetType::ABS;</a>
<a name="ln517">                  if (val == &quot;spatium&quot; || val == &quot;1&quot;)</a>
<a name="ln518">                        ot = OffsetType::SPATIUM;</a>
<a name="ln519">                  if (ot != offsetType) {</a>
<a name="ln520">                        offsetType = ot;</a>
<a name="ln521">                        if (ot == OffsetType::ABS)</a>
<a name="ln522">                              offset /= INCH;  // convert spatium -&gt; inch</a>
<a name="ln523">                        else</a>
<a name="ln524">                              offset *= INCH;  // convert inch -&gt; spatium</a>
<a name="ln525">                        }</a>
<a name="ln526">                  }</a>
<a name="ln527">            else if (tag == &quot;sizeIsSpatiumDependent&quot; || tag == &quot;spatiumSizeDependent&quot;)</a>
<a name="ln528">                  sizeIsSpatiumDependent = e.readInt();</a>
<a name="ln529">            else if (tag == &quot;frameWidth&quot;) { // obsolete</a>
<a name="ln530">                  frameType = FrameType::SQUARE;</a>
<a name="ln531">                  /*frameWidthMM =*/ e.readDouble();</a>
<a name="ln532">                  }</a>
<a name="ln533">            else if (tag == &quot;frameWidthS&quot;) {</a>
<a name="ln534">                  frameType = FrameType::SQUARE;</a>
<a name="ln535">                  frameWidth = Spatium(e.readDouble());</a>
<a name="ln536">                  }</a>
<a name="ln537">            else if (tag == &quot;frame&quot;)</a>
<a name="ln538">                  frameType = e.readInt() ? FrameType::SQUARE : FrameType::NO_FRAME;</a>
<a name="ln539">            else if (tag == &quot;paddingWidth&quot;)          // obsolete</a>
<a name="ln540">                  /*paddingWidthMM =*/ e.readDouble();</a>
<a name="ln541">            else if (tag == &quot;paddingWidthS&quot;)</a>
<a name="ln542">                  paddingWidth = Spatium(e.readDouble());</a>
<a name="ln543">            else if (tag == &quot;frameRound&quot;)</a>
<a name="ln544">                  e.readInt();</a>
<a name="ln545">            else if (tag == &quot;frameColor&quot;)</a>
<a name="ln546">                  frameColor = e.readColor();</a>
<a name="ln547">            else if (tag == &quot;foregroundColor&quot;)</a>
<a name="ln548">                  foregroundColor = e.readColor();</a>
<a name="ln549">            else if (tag == &quot;backgroundColor&quot;)</a>
<a name="ln550">                  backgroundColor = e.readColor();</a>
<a name="ln551">            else if (tag == &quot;circle&quot;)</a>
<a name="ln552">                  frameType = e.readInt() ? FrameType::CIRCLE : FrameType::NO_FRAME;</a>
<a name="ln553">            else if (tag == &quot;systemFlag&quot;)</a>
<a name="ln554">                  systemFlag = e.readInt();</a>
<a name="ln555">            else if (tag == &quot;placement&quot;) {</a>
<a name="ln556">                  QString value(e.readElementText());</a>
<a name="ln557">                  if (value == &quot;above&quot;)</a>
<a name="ln558">                        placement = Placement::ABOVE;</a>
<a name="ln559">                  else if (value == &quot;below&quot;)</a>
<a name="ln560">                        placement = Placement::BELOW;</a>
<a name="ln561">                  placementValid = true;</a>
<a name="ln562">                  }</a>
<a name="ln563">            else if (tag == &quot;lineWidth&quot;)</a>
<a name="ln564">                  lineWidth = e.readDouble();</a>
<a name="ln565">            else</a>
<a name="ln566">                  e.unknown();</a>
<a name="ln567">            }</a>
<a name="ln568">      if (family == &quot;MuseJazz&quot;)</a>
<a name="ln569">            family = &quot;MuseJazz Text&quot;;</a>
<a name="ln570"> </a>
<a name="ln571">      struct StyleTable {</a>
<a name="ln572">            const char* name;</a>
<a name="ln573">            Tid ss;</a>
<a name="ln574">            } styleTable[] = {</a>
<a name="ln575">            { &quot;&quot;,                        Tid::DEFAULT },</a>
<a name="ln576">            { &quot;Title&quot;,                   Tid::TITLE },</a>
<a name="ln577">            { &quot;Subtitle&quot;,                Tid::SUBTITLE },</a>
<a name="ln578">            { &quot;Composer&quot;,                Tid::COMPOSER },</a>
<a name="ln579">            { &quot;Lyricist&quot;,                Tid::POET },</a>
<a name="ln580">            { &quot;Lyrics Odd Lines&quot;,        Tid::LYRICS_ODD },</a>
<a name="ln581">            { &quot;Lyrics Even Lines&quot;,       Tid::LYRICS_EVEN },</a>
<a name="ln582">            { &quot;Fingering&quot;,               Tid::FINGERING },</a>
<a name="ln583">            { &quot;LH Guitar Fingering&quot;,     Tid::LH_GUITAR_FINGERING },</a>
<a name="ln584">            { &quot;RH Guitar Fingering&quot;,     Tid::RH_GUITAR_FINGERING },</a>
<a name="ln585">            { &quot;String Number&quot;,           Tid::STRING_NUMBER },</a>
<a name="ln586">            { &quot;Instrument Name (Long)&quot;,  Tid::INSTRUMENT_LONG },</a>
<a name="ln587">            { &quot;Instrument Name (Short)&quot;, Tid::INSTRUMENT_SHORT },</a>
<a name="ln588">            { &quot;Instrument Name (Part)&quot;,  Tid::INSTRUMENT_EXCERPT },</a>
<a name="ln589">            { &quot;Dynamics&quot;,                Tid::DYNAMICS },</a>
<a name="ln590">            { &quot;Technique&quot;,               Tid::EXPRESSION },</a>
<a name="ln591">            { &quot;Tempo&quot;,                   Tid::TEMPO },</a>
<a name="ln592">            { &quot;Metronome&quot;,               Tid::METRONOME },</a>
<a name="ln593">            { &quot;Measure Number&quot;,          Tid::MEASURE_NUMBER },</a>
<a name="ln594">            { &quot;Translator&quot;,              Tid::TRANSLATOR },</a>
<a name="ln595">            { &quot;Tuplet&quot;,                  Tid::TUPLET },</a>
<a name="ln596">            { &quot;System&quot;,                  Tid::SYSTEM },</a>
<a name="ln597">            { &quot;Staff&quot;,                   Tid::STAFF },</a>
<a name="ln598">            { &quot;Chord Symbol&quot;,            Tid::HARMONY_A },</a>
<a name="ln599">            { &quot;Rehearsal Mark&quot;,          Tid::REHEARSAL_MARK },</a>
<a name="ln600">            { &quot;Repeat Text Left&quot;,        Tid::REPEAT_LEFT },</a>
<a name="ln601">            { &quot;Repeat Text Right&quot;,       Tid::REPEAT_RIGHT },</a>
<a name="ln602">            { &quot;Frame&quot;,                   Tid::FRAME },</a>
<a name="ln603">            { &quot;Text Line&quot;,               Tid::TEXTLINE },</a>
<a name="ln604">            { &quot;Glissando&quot;,               Tid::GLISSANDO },</a>
<a name="ln605">            { &quot;Ottava&quot;,                  Tid::OTTAVA },</a>
<a name="ln606">            { &quot;Pedal&quot;,                   Tid::PEDAL },</a>
<a name="ln607">            { &quot;Hairpin&quot;,                 Tid::HAIRPIN },</a>
<a name="ln608">            { &quot;Bend&quot;,                    Tid::BEND },</a>
<a name="ln609">            { &quot;Header&quot;,                  Tid::HEADER },</a>
<a name="ln610">            { &quot;Footer&quot;,                  Tid::FOOTER },</a>
<a name="ln611">            { &quot;Instrument Change&quot;,       Tid::INSTRUMENT_CHANGE },</a>
<a name="ln612">            { &quot;Repeat Text&quot;,             Tid::IGNORED_STYLES, },     // Repeat Text style no longer exists</a>
<a name="ln613">            { &quot;Figured Bass&quot;,            Tid::IGNORED_STYLES, },     // F.B. data are in style properties</a>
<a name="ln614">            { &quot;Volta&quot;,                   Tid::VOLTA },</a>
<a name="ln615">            };</a>
<a name="ln616">      Tid ss = Tid::TEXT_STYLES;</a>
<a name="ln617">      for (const auto&amp; i : styleTable) {</a>
<a name="ln618">            if (name == i.name) {</a>
<a name="ln619">                  ss = i.ss;</a>
<a name="ln620">                  break;</a>
<a name="ln621">                  }</a>
<a name="ln622">            }</a>
<a name="ln623"> </a>
<a name="ln624">      if (ss == Tid::IGNORED_STYLES)</a>
<a name="ln625">            return;</a>
<a name="ln626"> </a>
<a name="ln627">      bool isExcessStyle = false;</a>
<a name="ln628">      if (ss == Tid::TEXT_STYLES) {</a>
<a name="ln629">            ss = e.addUserTextStyle(name);</a>
<a name="ln630">            if (ss == Tid::TEXT_STYLES) {</a>
<a name="ln631">                  qDebug(&quot;unhandled substyle &lt;%s&gt;&quot;, qPrintable(name));</a>
<a name="ln632">                  isExcessStyle = true;</a>
<a name="ln633">                  }</a>
<a name="ln634">            else {</a>
<a name="ln635">                  int idx = int(ss) - int(Tid::USER1);</a>
<a name="ln636">                  if ((int(ss) &lt; int(Tid::USER1)) || (int(ss) &gt; int(Tid::USER12))) {</a>
<a name="ln637">                        qDebug(&quot;User style index %d outside of range.&quot;, idx);</a>
<a name="ln638">                        return;</a>
<a name="ln639">                        }</a>
<a name="ln640">                  Sid sid[] = { Sid::user1Name, Sid::user2Name, Sid::user3Name, Sid::user4Name, Sid::user5Name, Sid::user6Name,</a>
<a name="ln641">                                Sid::user7Name, Sid::user8Name, Sid::user9Name, Sid::user10Name, Sid::user11Name, Sid::user12Name};</a>
<a name="ln642">                  style-&gt;set(sid[idx], name);</a>
<a name="ln643">                  }</a>
<a name="ln644">            }</a>
<a name="ln645"> </a>
<a name="ln646">      std::map&lt;Sid, QVariant&gt; excessPairs;</a>
<a name="ln647">      const TextStyle* ts;</a>
<a name="ln648">      if (isExcessStyle)</a>
<a name="ln649">            ts = textStyle(&quot;User-1&quot;);</a>
<a name="ln650">      else</a>
<a name="ln651">            ts = textStyle(ss);</a>
<a name="ln652">      for (const auto&amp; i : *ts) {</a>
<a name="ln653">            QVariant value;</a>
<a name="ln654">            if (i.sid == Sid::NOSTYLE)</a>
<a name="ln655">                  break;</a>
<a name="ln656">            switch (i.pid) {</a>
<a name="ln657">                  case Pid::SUB_STYLE:</a>
<a name="ln658">                        value = int(ss);</a>
<a name="ln659">                        break;</a>
<a name="ln660">                  case Pid::BEGIN_FONT_FACE:</a>
<a name="ln661">                  case Pid::CONTINUE_FONT_FACE:</a>
<a name="ln662">                  case Pid::END_FONT_FACE:</a>
<a name="ln663">                  case Pid::FONT_FACE:</a>
<a name="ln664">                        value = family;</a>
<a name="ln665">                        break;</a>
<a name="ln666">                  case Pid::BEGIN_FONT_SIZE:</a>
<a name="ln667">                  case Pid::CONTINUE_FONT_SIZE:</a>
<a name="ln668">                  case Pid::END_FONT_SIZE:</a>
<a name="ln669">                  case Pid::FONT_SIZE:</a>
<a name="ln670">                        value = size;</a>
<a name="ln671">                        break;</a>
<a name="ln672">                  case Pid::BEGIN_FONT_STYLE:</a>
<a name="ln673">                  case Pid::CONTINUE_FONT_STYLE:</a>
<a name="ln674">                  case Pid::END_FONT_STYLE:</a>
<a name="ln675">                  case Pid::FONT_STYLE:</a>
<a name="ln676">                        value = int(fontStyle);</a>
<a name="ln677">                        break;</a>
<a name="ln678">                  case Pid::FRAME_TYPE:</a>
<a name="ln679">                        value = int(frameType);</a>
<a name="ln680">                        break;</a>
<a name="ln681">                  case Pid::FRAME_WIDTH:</a>
<a name="ln682">                        value = frameWidth;</a>
<a name="ln683">                        break;</a>
<a name="ln684">                  case Pid::FRAME_PADDING:</a>
<a name="ln685">                        value = paddingWidth;</a>
<a name="ln686">                        break;</a>
<a name="ln687">                  case Pid::FRAME_FG_COLOR:</a>
<a name="ln688">                        value = frameColor;</a>
<a name="ln689">                        break;</a>
<a name="ln690">                  case Pid::FRAME_BG_COLOR:</a>
<a name="ln691">                        value = backgroundColor;</a>
<a name="ln692">                        break;</a>
<a name="ln693">                  case Pid::SIZE_SPATIUM_DEPENDENT:</a>
<a name="ln694">                        value = sizeIsSpatiumDependent;</a>
<a name="ln695">                        break;</a>
<a name="ln696">                  case Pid::BEGIN_TEXT_ALIGN:</a>
<a name="ln697">                  case Pid::CONTINUE_TEXT_ALIGN:</a>
<a name="ln698">                  case Pid::END_TEXT_ALIGN:</a>
<a name="ln699">                  case Pid::ALIGN:</a>
<a name="ln700">                        value = QVariant::fromValue(align);</a>
<a name="ln701">                        break;</a>
<a name="ln702">#if 0  //TODO-offset</a>
<a name="ln703">                  case Pid::OFFSET:</a>
<a name="ln704">                        if (offsetValid) {</a>
<a name="ln705">                              if (ss == Tid::TEMPO) {</a>
<a name="ln706">                                    style-&gt;set(Sid::tempoPosAbove, Spatium(offset.y()));</a>
<a name="ln707">                                    offset = QPointF();</a>
<a name="ln708">                                    }</a>
<a name="ln709">                              else if (ss == Tid::STAFF) {</a>
<a name="ln710">                                    style-&gt;set(Sid::staffTextPosAbove, Spatium(offset.y()));</a>
<a name="ln711">                                    offset = QPointF();</a>
<a name="ln712">                                    }</a>
<a name="ln713">                              else if (ss == Tid::REHEARSAL_MARK) {</a>
<a name="ln714">                                    style-&gt;set(Sid::rehearsalMarkPosAbove, Spatium(offset.y()));</a>
<a name="ln715">                                    offset = QPointF();</a>
<a name="ln716">                                    }</a>
<a name="ln717">                              value = offset;</a>
<a name="ln718">                              }</a>
<a name="ln719">                        break;</a>
<a name="ln720">                  case Pid::OFFSET_TYPE:</a>
<a name="ln721">                        value = int(offsetType);</a>
<a name="ln722">                        break;</a>
<a name="ln723">#endif</a>
<a name="ln724">                  case Pid::SYSTEM_FLAG:</a>
<a name="ln725">                        value = systemFlag;</a>
<a name="ln726">                        break;</a>
<a name="ln727">                  case Pid::BEGIN_HOOK_HEIGHT:</a>
<a name="ln728">                  case Pid::END_HOOK_HEIGHT:</a>
<a name="ln729">                        value = QVariant();</a>
<a name="ln730">                        break;</a>
<a name="ln731">                  case Pid::PLACEMENT:</a>
<a name="ln732">                        if (placementValid)</a>
<a name="ln733">                              value = int(placement);</a>
<a name="ln734">                        break;</a>
<a name="ln735">                  case Pid::LINE_WIDTH:</a>
<a name="ln736">                        if (lineWidth != -1.0)</a>
<a name="ln737">                              value = lineWidth;</a>
<a name="ln738">                        break;</a>
<a name="ln739">                  default:</a>
<a name="ln740">//                        qDebug(&quot;unhandled property &lt;%s&gt;%d&quot;, propertyName(i.pid), int (i.pid));</a>
<a name="ln741">                        break;</a>
<a name="ln742">                  }</a>
<a name="ln743">            if (value.isValid()) {</a>
<a name="ln744">                  if (isExcessStyle)</a>
<a name="ln745">                        excessPairs[i.sid] = value;</a>
<a name="ln746">                  else</a>
<a name="ln747">                        style-&gt;set(i.sid, value);</a>
<a name="ln748">                  }</a>
<a name="ln749">//            else</a>
<a name="ln750">//                  qDebug(&quot;invalid style value &lt;%s&gt; pid&lt;%s&gt;&quot;, MStyle::valueName(i.sid), propertyName(i.pid));</a>
<a name="ln751">            }</a>
<a name="ln752"> </a>
<a name="ln753">      if (isExcessStyle &amp;&amp; excessPairs.size() &gt; 0)</a>
<a name="ln754">            excessStyles[name] = excessPairs;</a>
<a name="ln755">      }</a>
<a name="ln756"> </a>
<a name="ln757">//---------------------------------------------------------</a>
<a name="ln758">//   readAccidental206</a>
<a name="ln759">//---------------------------------------------------------</a>
<a name="ln760"> </a>
<a name="ln761">void readAccidental206(Accidental* a, XmlReader&amp; e)</a>
<a name="ln762">      {</a>
<a name="ln763">      while (e.readNextStartElement()) {</a>
<a name="ln764">            const QStringRef&amp; tag(e.name());</a>
<a name="ln765">            if (tag == &quot;bracket&quot;) {</a>
<a name="ln766">                  int i = e.readInt();</a>
<a name="ln767">                  if (i == 0 || i == 1)</a>
<a name="ln768">                        a-&gt;setBracket(AccidentalBracket(i));</a>
<a name="ln769">                  }</a>
<a name="ln770">            else if (tag == &quot;subtype&quot;) {</a>
<a name="ln771">                  QString text = e.readElementText();</a>
<a name="ln772">                  const static std::map&lt;QString, AccidentalType&gt; accMap = {</a>
<a name="ln773">                     {&quot;none&quot;,               AccidentalType::NONE},</a>
<a name="ln774">                     {&quot;sharp&quot;,              AccidentalType::SHARP},</a>
<a name="ln775">                     {&quot;flat&quot;,               AccidentalType::FLAT},</a>
<a name="ln776">                     {&quot;natural&quot;,            AccidentalType::NATURAL},</a>
<a name="ln777">                     {&quot;double sharp&quot;,       AccidentalType::SHARP2},</a>
<a name="ln778">                     {&quot;double flat&quot;,        AccidentalType::FLAT2},</a>
<a name="ln779">                     {&quot;flat-slash&quot;,         AccidentalType::FLAT_SLASH},</a>
<a name="ln780">                     {&quot;flat-slash2&quot;,        AccidentalType::FLAT_SLASH2},</a>
<a name="ln781">                     {&quot;mirrored-flat2&quot;,     AccidentalType::MIRRORED_FLAT2},</a>
<a name="ln782">                     {&quot;mirrored-flat&quot;,      AccidentalType::MIRRORED_FLAT},</a>
<a name="ln783">                     {&quot;sharp-slash&quot;,        AccidentalType::SHARP_SLASH},</a>
<a name="ln784">                     {&quot;sharp-slash2&quot;,       AccidentalType::SHARP_SLASH2},</a>
<a name="ln785">                     {&quot;sharp-slash3&quot;,       AccidentalType::SHARP_SLASH3},</a>
<a name="ln786">                     {&quot;sharp-slash4&quot;,       AccidentalType::SHARP_SLASH4},</a>
<a name="ln787">                     {&quot;sharp arrow up&quot;,     AccidentalType::SHARP_ARROW_UP},</a>
<a name="ln788">                     {&quot;sharp arrow down&quot;,   AccidentalType::SHARP_ARROW_DOWN},</a>
<a name="ln789">                     {&quot;flat arrow up&quot;,      AccidentalType::FLAT_ARROW_UP},</a>
<a name="ln790">                     {&quot;flat arrow down&quot;,    AccidentalType::FLAT_ARROW_DOWN},</a>
<a name="ln791">                     {&quot;natural arrow up&quot;,   AccidentalType::NATURAL_ARROW_UP},</a>
<a name="ln792">                     {&quot;natural arrow down&quot;, AccidentalType::NATURAL_ARROW_DOWN},</a>
<a name="ln793">                     {&quot;sori&quot;,               AccidentalType::SORI},</a>
<a name="ln794">                     {&quot;koron&quot;,              AccidentalType::KORON}</a>
<a name="ln795">                     };</a>
<a name="ln796">                  auto it = accMap.find(text);</a>
<a name="ln797">                  if (it == accMap.end()) {</a>
<a name="ln798">                        qDebug(&quot;invalid type %s&quot;, qPrintable(text));</a>
<a name="ln799">                        a-&gt;setAccidentalType(AccidentalType::NONE);</a>
<a name="ln800">                        }</a>
<a name="ln801">                  else</a>
<a name="ln802">                        a-&gt;setAccidentalType(it-&gt;second);</a>
<a name="ln803">                  }</a>
<a name="ln804">            else if (tag == &quot;role&quot;) {</a>
<a name="ln805">                  AccidentalRole r = AccidentalRole(e.readInt());</a>
<a name="ln806">                  if (r == AccidentalRole::AUTO || r == AccidentalRole::USER)</a>
<a name="ln807">                        a-&gt;setRole(r);</a>
<a name="ln808">                  }</a>
<a name="ln809">            else if (tag == &quot;small&quot;)</a>
<a name="ln810">                  a-&gt;setSmall(e.readInt());</a>
<a name="ln811">            else if (a-&gt;Element::readProperties(e))</a>
<a name="ln812">                  ;</a>
<a name="ln813">            else</a>
<a name="ln814">                  e.unknown();</a>
<a name="ln815">            }</a>
<a name="ln816">      }</a>
<a name="ln817"> </a>
<a name="ln818">static NoteHead::Group convertHeadGroup(int i)</a>
<a name="ln819">      {</a>
<a name="ln820">      NoteHead::Group val;</a>
<a name="ln821">      switch (i) {</a>
<a name="ln822">            case 1:</a>
<a name="ln823">                  val = NoteHead::Group::HEAD_CROSS;</a>
<a name="ln824">                  break;</a>
<a name="ln825">            case 2:</a>
<a name="ln826">                  val = NoteHead::Group::HEAD_DIAMOND;</a>
<a name="ln827">                  break;</a>
<a name="ln828">            case 3:</a>
<a name="ln829">                  val = NoteHead::Group::HEAD_TRIANGLE_DOWN;</a>
<a name="ln830">                  break;</a>
<a name="ln831">            case 4:</a>
<a name="ln832">                  val = NoteHead::Group::HEAD_MI;</a>
<a name="ln833">                  break;</a>
<a name="ln834">            case 5:</a>
<a name="ln835">                  val = NoteHead::Group::HEAD_SLASH;</a>
<a name="ln836">                  break;</a>
<a name="ln837">            case 6:</a>
<a name="ln838">                  val = NoteHead::Group::HEAD_XCIRCLE;</a>
<a name="ln839">                  break;</a>
<a name="ln840">            case 7:</a>
<a name="ln841">                  val = NoteHead::Group::HEAD_DO;</a>
<a name="ln842">                  break;</a>
<a name="ln843">            case 8:</a>
<a name="ln844">                  val = NoteHead::Group::HEAD_RE;</a>
<a name="ln845">                  break;</a>
<a name="ln846">            case 9:</a>
<a name="ln847">                  val = NoteHead::Group::HEAD_FA;</a>
<a name="ln848">                  break;</a>
<a name="ln849">            case 10:</a>
<a name="ln850">                  val = NoteHead::Group::HEAD_LA;</a>
<a name="ln851">                  break;</a>
<a name="ln852">            case 11:</a>
<a name="ln853">                  val = NoteHead::Group::HEAD_TI;</a>
<a name="ln854">                  break;</a>
<a name="ln855">            case 12:</a>
<a name="ln856">                  val = NoteHead::Group::HEAD_SOL;</a>
<a name="ln857">                  break;</a>
<a name="ln858">            case 13:</a>
<a name="ln859">                  val = NoteHead::Group::HEAD_BREVIS_ALT;</a>
<a name="ln860">                  break;</a>
<a name="ln861">            case 0:</a>
<a name="ln862">            default:</a>
<a name="ln863">                  val = NoteHead::Group::HEAD_NORMAL;</a>
<a name="ln864">            }</a>
<a name="ln865">      return val;</a>
<a name="ln866">      }</a>
<a name="ln867"> </a>
<a name="ln868">static NoteHead::Type convertHeadType(int i)</a>
<a name="ln869">      {</a>
<a name="ln870">      NoteHead::Type val;</a>
<a name="ln871">      switch (i) {</a>
<a name="ln872">            case 0:</a>
<a name="ln873">                  val = NoteHead::Type::HEAD_WHOLE;</a>
<a name="ln874">                  break;</a>
<a name="ln875">            case 1:</a>
<a name="ln876">                  val = NoteHead::Type::HEAD_HALF;</a>
<a name="ln877">                  break;</a>
<a name="ln878">            case 2:</a>
<a name="ln879">                  val = NoteHead::Type::HEAD_QUARTER;</a>
<a name="ln880">                  break;</a>
<a name="ln881">            case 3:</a>
<a name="ln882">                  val = NoteHead::Type::HEAD_BREVIS;</a>
<a name="ln883">                  break;</a>
<a name="ln884">            default:</a>
<a name="ln885">                  val = NoteHead::Type::HEAD_AUTO;;</a>
<a name="ln886">            }</a>
<a name="ln887">      return val;</a>
<a name="ln888">      }</a>
<a name="ln889"> </a>
<a name="ln890">//---------------------------------------------------------</a>
<a name="ln891">//   ArticulationNames</a>
<a name="ln892">//---------------------------------------------------------</a>
<a name="ln893"> </a>
<a name="ln894">static struct ArticulationNames {</a>
<a name="ln895">      SymId id;</a>
<a name="ln896">      const char* name;</a>
<a name="ln897">      } articulationNames[] = {</a>
<a name="ln898">      { SymId::fermataAbove,              &quot;fermata&quot;,                   },</a>
<a name="ln899">      { SymId::fermataShortAbove,         &quot;shortfermata&quot;,              },</a>
<a name="ln900">      { SymId::fermataLongAbove,          &quot;longfermata&quot;,               },</a>
<a name="ln901">      { SymId::fermataVeryLongAbove,      &quot;verylongfermata&quot;,           },</a>
<a name="ln902">      { SymId::articAccentAbove,          &quot;sforzato&quot;,                  },</a>
<a name="ln903">      { SymId::articStaccatoAbove,        &quot;staccato&quot;,                  },</a>
<a name="ln904">      { SymId::articStaccatissimoAbove,   &quot;staccatissimo&quot;,             },</a>
<a name="ln905">      { SymId::articTenutoAbove,          &quot;tenuto&quot;,                    },</a>
<a name="ln906">      { SymId::articTenutoStaccatoAbove,  &quot;portato&quot;,                   },</a>
<a name="ln907">      { SymId::articMarcatoAbove,         &quot;marcato&quot;,                   },</a>
<a name="ln908">      { SymId::guitarFadeIn,              &quot;fadein&quot;,                    },</a>
<a name="ln909">      { SymId::guitarFadeOut,             &quot;fadeout&quot;,                   },</a>
<a name="ln910">      { SymId::guitarVolumeSwell,         &quot;volumeswell&quot;,               },</a>
<a name="ln911">      { SymId::wiggleSawtooth,            &quot;wigglesawtooth&quot;,            },</a>
<a name="ln912">      { SymId::wiggleSawtoothWide,        &quot;wigglesawtoothwide&quot;,        },</a>
<a name="ln913">      { SymId::wiggleVibratoLargeFaster,  &quot;wigglevibratolargefaster&quot;,  },</a>
<a name="ln914">      { SymId::wiggleVibratoLargeSlowest, &quot;wigglevibratolargeslowest&quot;, },</a>
<a name="ln915">      { SymId::brassMuteOpen,             &quot;ouvert&quot;,                    },</a>
<a name="ln916">      { SymId::brassMuteClosed,           &quot;plusstop&quot;,                  },</a>
<a name="ln917">      { SymId::stringsUpBow,              &quot;upbow&quot;,                     },</a>
<a name="ln918">      { SymId::stringsDownBow,            &quot;downbow&quot;,                   },</a>
<a name="ln919">      { SymId::ornamentTurnInverted,      &quot;reverseturn&quot;,               },</a>
<a name="ln920">      { SymId::ornamentTurn,              &quot;turn&quot;,                      },</a>
<a name="ln921">      { SymId::ornamentTrill,             &quot;trill&quot;,                     },</a>
<a name="ln922">      { SymId::ornamentMordent,           &quot;prall&quot;,                     },</a>
<a name="ln923">      { SymId::ornamentMordentInverted,   &quot;mordent&quot;,                   },</a>
<a name="ln924">      { SymId::ornamentTremblement,       &quot;prallprall&quot;,                },</a>
<a name="ln925">      { SymId::ornamentPrallMordent,      &quot;prallmordent&quot;,              },</a>
<a name="ln926">      { SymId::ornamentUpPrall,           &quot;upprall&quot;,                   },</a>
<a name="ln927">      { SymId::ornamentUpMordent,         &quot;upmordent&quot;,                 },</a>
<a name="ln928">      { SymId::ornamentDownMordent,       &quot;downmordent&quot;,               },</a>
<a name="ln929">      { SymId::ornamentPrallDown,         &quot;pralldown&quot;,                 },</a>
<a name="ln930">      { SymId::ornamentPrallUp,           &quot;prallup&quot;,                   },</a>
<a name="ln931">      { SymId::ornamentLinePrall,         &quot;lineprall&quot;,                 },</a>
<a name="ln932">      { SymId::ornamentPrecompSlide,      &quot;schleifer&quot;,                 },</a>
<a name="ln933">      { SymId::pluckedSnapPizzicatoAbove, &quot;snappizzicato&quot;,             },</a>
<a name="ln934">      { SymId::stringsThumbPosition,      &quot;thumb&quot;,                     },</a>
<a name="ln935">      { SymId::luteFingeringRHThumb,      &quot;lutefingeringthumb&quot;,        },</a>
<a name="ln936">      { SymId::luteFingeringRHFirst,      &quot;lutefingering1st&quot;,          },</a>
<a name="ln937">      { SymId::luteFingeringRHSecond,     &quot;lutefingering2nd&quot;,          },</a>
<a name="ln938">      { SymId::luteFingeringRHThird,      &quot;lutefingering3rd&quot;,          },</a>
<a name="ln939"> </a>
<a name="ln940">      { SymId::ornamentPrecompMordentUpperPrefix, &quot;downprall&quot;   },</a>
<a name="ln941">      { SymId::ornamentPrecompMordentUpperPrefix, &quot;ornamentDownPrall&quot;   },</a>
<a name="ln942">      };</a>
<a name="ln943"> </a>
<a name="ln944">//---------------------------------------------------------</a>
<a name="ln945">//   oldArticulationNames2SymId</a>
<a name="ln946">//---------------------------------------------------------</a>
<a name="ln947"> </a>
<a name="ln948">SymId oldArticulationNames2SymId(const QString&amp; s)</a>
<a name="ln949">      {</a>
<a name="ln950">      for (auto i : articulationNames) {</a>
<a name="ln951">            if (i.name == s)</a>
<a name="ln952">                  return i.id;</a>
<a name="ln953">            }</a>
<a name="ln954">      return SymId::noSym;</a>
<a name="ln955">      }</a>
<a name="ln956"> </a>
<a name="ln957">//---------------------------------------------------------</a>
<a name="ln958">//   readDrumset</a>
<a name="ln959">//---------------------------------------------------------</a>
<a name="ln960"> </a>
<a name="ln961">static void readDrumset(Drumset* ds, XmlReader&amp; e)</a>
<a name="ln962">      {</a>
<a name="ln963">      int pitch = e.intAttribute(&quot;pitch&quot;, -1);</a>
<a name="ln964">      if (pitch &lt; 0 || pitch &gt; 127) {</a>
<a name="ln965">            qDebug(&quot;load drumset: invalid pitch %d&quot;, pitch);</a>
<a name="ln966">            return;</a>
<a name="ln967">            }</a>
<a name="ln968">      while (e.readNextStartElement()) {</a>
<a name="ln969">            const QStringRef&amp; tag(e.name());</a>
<a name="ln970">            if (tag == &quot;head&quot;)</a>
<a name="ln971">                  ds-&gt;drum(pitch).notehead = convertHeadGroup(e.readInt());</a>
<a name="ln972">            else if (tag == &quot;variants&quot;) {</a>
<a name="ln973">                  while(e.readNextStartElement()) {</a>
<a name="ln974">                        const QStringRef&amp; tagv(e.name());</a>
<a name="ln975">                        if (tagv == &quot;variant&quot;) {</a>
<a name="ln976">                              DrumInstrumentVariant div;</a>
<a name="ln977">                              div.pitch = e.attribute(&quot;pitch&quot;).toInt();</a>
<a name="ln978">                              while (e.readNextStartElement()) {</a>
<a name="ln979">                                    const QStringRef&amp; taga(e.name());</a>
<a name="ln980">                                    if (taga == &quot;articulation&quot;) {</a>
<a name="ln981">                                          QString oldArticulationName = e.readElementText();</a>
<a name="ln982">                                          SymId oldId = oldArticulationNames2SymId(oldArticulationName);</a>
<a name="ln983">                                          div.articulationName = Articulation::symId2ArticulationName(oldId);</a>
<a name="ln984">                                          }</a>
<a name="ln985">                                    else if (taga == &quot;tremolo&quot;) {</a>
<a name="ln986">                                          div.tremolo = Tremolo::name2Type(e.readElementText());</a>
<a name="ln987">                                          }</a>
<a name="ln988">                                    }</a>
<a name="ln989">                              ds-&gt;drum(pitch).addVariant(div);</a>
<a name="ln990">                              }</a>
<a name="ln991">                        }</a>
<a name="ln992">                  }</a>
<a name="ln993">            else if (ds-&gt;readProperties(e, pitch))</a>
<a name="ln994">                  ;</a>
<a name="ln995">            else</a>
<a name="ln996">                  e.unknown();</a>
<a name="ln997">            }</a>
<a name="ln998">      }</a>
<a name="ln999"> </a>
<a name="ln1000">//---------------------------------------------------------</a>
<a name="ln1001">//   readInstrument</a>
<a name="ln1002">//---------------------------------------------------------</a>
<a name="ln1003"> </a>
<a name="ln1004">static void readInstrument(Instrument *i, Part* p, XmlReader&amp; e)</a>
<a name="ln1005">      {</a>
<a name="ln1006">      int program = -1;</a>
<a name="ln1007">      int bank    = 0;</a>
<a name="ln1008">      int volume  = 100;</a>
<a name="ln1009">      int pan     = 60;</a>
<a name="ln1010">      int chorus  = 30;</a>
<a name="ln1011">      int reverb  = 30;</a>
<a name="ln1012">      bool customDrumset = false;</a>
<a name="ln1013">      i-&gt;clearChannels();       // remove default channel</a>
<a name="ln1014">      while (e.readNextStartElement()) {</a>
<a name="ln1015">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1016">            if (tag == &quot;Drum&quot;) {</a>
<a name="ln1017">                  // if we see one of this tags, a custom drumset will</a>
<a name="ln1018">                  // be created</a>
<a name="ln1019">                  if (!i-&gt;drumset())</a>
<a name="ln1020">                        i-&gt;setDrumset(new Drumset(*smDrumset));</a>
<a name="ln1021">                  if (!customDrumset) {</a>
<a name="ln1022">                        i-&gt;drumset()-&gt;clear();</a>
<a name="ln1023">                        customDrumset = true;</a>
<a name="ln1024">                        }</a>
<a name="ln1025">                  readDrumset(i-&gt;drumset(), e);</a>
<a name="ln1026">                  }</a>
<a name="ln1027"> </a>
<a name="ln1028">            else if (i-&gt;readProperties(e, p, &amp;customDrumset))</a>
<a name="ln1029">                  ;</a>
<a name="ln1030">            else</a>
<a name="ln1031">                 e.unknown();</a>
<a name="ln1032">            }</a>
<a name="ln1033"> </a>
<a name="ln1034">      // Read single-note dynamics from template</a>
<a name="ln1035">      i-&gt;setSingleNoteDynamicsFromTemplate();</a>
<a name="ln1036"> </a>
<a name="ln1037">      if (i-&gt;channel().empty()) {      // for backward compatibility</a>
<a name="ln1038">            Channel* a = new Channel;</a>
<a name="ln1039">            a-&gt;setName(Channel::DEFAULT_NAME);</a>
<a name="ln1040">            a-&gt;setProgram(program);</a>
<a name="ln1041">            a-&gt;setBank(bank);</a>
<a name="ln1042">            a-&gt;setVolume(volume);</a>
<a name="ln1043">            a-&gt;setPan(pan);</a>
<a name="ln1044">            a-&gt;setReverb(reverb);</a>
<a name="ln1045">            a-&gt;setChorus(chorus);</a>
<a name="ln1046">            i-&gt;appendChannel(a);</a>
<a name="ln1047">            }</a>
<a name="ln1048">      if (i-&gt;useDrumset()) {</a>
<a name="ln1049">            if (i-&gt;channel()[0]-&gt;bank() == 0)</a>
<a name="ln1050">                  i-&gt;channel()[0]-&gt;setBank(128);</a>
<a name="ln1051">            }</a>
<a name="ln1052">      }</a>
<a name="ln1053"> </a>
<a name="ln1054">//---------------------------------------------------------</a>
<a name="ln1055">//   readStaff</a>
<a name="ln1056">//---------------------------------------------------------</a>
<a name="ln1057"> </a>
<a name="ln1058">static void readStaff(Staff* staff, XmlReader&amp; e)</a>
<a name="ln1059">      {</a>
<a name="ln1060">      while (e.readNextStartElement()) {</a>
<a name="ln1061">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1062">            if (tag == &quot;type&quot;) {    // obsolete</a>
<a name="ln1063">                  int staffTypeIdx = e.readInt();</a>
<a name="ln1064">                  qDebug(&quot;obsolete: Staff::read staffTypeIdx %d&quot;, staffTypeIdx);</a>
<a name="ln1065">                  }</a>
<a name="ln1066">            else if (tag == &quot;neverHide&quot;) {</a>
<a name="ln1067">                  bool v = e.readInt();</a>
<a name="ln1068">                  if (v)</a>
<a name="ln1069">                        staff-&gt;setHideWhenEmpty(Staff::HideMode::NEVER);</a>
<a name="ln1070">                  }</a>
<a name="ln1071">            else if (tag == &quot;barLineSpan&quot;) {</a>
<a name="ln1072">                  staff-&gt;setBarLineFrom(e.intAttribute(&quot;from&quot;, 0));</a>
<a name="ln1073">                  staff-&gt;setBarLineTo(e.intAttribute(&quot;to&quot;, 0));</a>
<a name="ln1074">                  int span     = e.readInt();</a>
<a name="ln1075">                  staff-&gt;setBarLineSpan(span - 1);</a>
<a name="ln1076">                  }</a>
<a name="ln1077">            else if (staff-&gt;readProperties(e))</a>
<a name="ln1078">                  ;</a>
<a name="ln1079">            else</a>
<a name="ln1080">                  e.unknown();</a>
<a name="ln1081">            }</a>
<a name="ln1082">      }</a>
<a name="ln1083"> </a>
<a name="ln1084">//---------------------------------------------------------</a>
<a name="ln1085">//   readPart</a>
<a name="ln1086">//---------------------------------------------------------</a>
<a name="ln1087"> </a>
<a name="ln1088">void readPart206(Part* part, XmlReader&amp; e)</a>
<a name="ln1089">      {</a>
<a name="ln1090">      while (e.readNextStartElement()) {</a>
<a name="ln1091">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1092">            if (tag == &quot;Instrument&quot;) {</a>
<a name="ln1093">                  Instrument* i = part-&gt;_instruments.instrument(/* tick */ -1);</a>
<a name="ln1094">                  readInstrument(i, part, e);</a>
<a name="ln1095">                  Drumset* ds = i-&gt;drumset();</a>
<a name="ln1096">                  Staff*   s = part-&gt;staff(0);</a>
<a name="ln1097">                  int lld = s ? qRound(s-&gt;lineDistance(Fraction(0,1))) : 1;</a>
<a name="ln1098">                  if (ds &amp;&amp; s &amp;&amp; lld &gt; 1) {</a>
<a name="ln1099">                        for (int j = 0; j &lt; DRUM_INSTRUMENTS; ++j)</a>
<a name="ln1100">                              ds-&gt;drum(j).line /= lld;</a>
<a name="ln1101">                        }</a>
<a name="ln1102">                  }</a>
<a name="ln1103">            else if (tag == &quot;Staff&quot;) {</a>
<a name="ln1104">                  Staff* staff = new Staff(part-&gt;score());</a>
<a name="ln1105">                  staff-&gt;setPart(part);</a>
<a name="ln1106">                  part-&gt;score()-&gt;staves().push_back(staff);</a>
<a name="ln1107">                  part-&gt;staves()-&gt;push_back(staff);</a>
<a name="ln1108">                  readStaff(staff, e);</a>
<a name="ln1109">                  }</a>
<a name="ln1110">            else if (part-&gt;readProperties(e))</a>
<a name="ln1111">                  ;</a>
<a name="ln1112">            else</a>
<a name="ln1113">                  e.unknown();</a>
<a name="ln1114">            }</a>
<a name="ln1115">      }</a>
<a name="ln1116"> </a>
<a name="ln1117">//---------------------------------------------------------</a>
<a name="ln1118">//   readAmbitus</a>
<a name="ln1119">//---------------------------------------------------------</a>
<a name="ln1120"> </a>
<a name="ln1121">static void readAmbitus(Ambitus* ambitus, XmlReader&amp; e)</a>
<a name="ln1122">      {</a>
<a name="ln1123">      while (e.readNextStartElement()) {</a>
<a name="ln1124">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1125">            if (tag == &quot;head&quot;)</a>
<a name="ln1126">                  ambitus-&gt;setNoteHeadGroup(convertHeadGroup(e.readInt()));</a>
<a name="ln1127">            else if (tag == &quot;headType&quot;)</a>
<a name="ln1128">                  ambitus-&gt;setNoteHeadType(convertHeadType(e.readInt()));</a>
<a name="ln1129">            else if (ambitus-&gt;readProperties(e))</a>
<a name="ln1130">                  ;</a>
<a name="ln1131">            else</a>
<a name="ln1132">                  e.unknown();</a>
<a name="ln1133">            }</a>
<a name="ln1134">      }</a>
<a name="ln1135"> </a>
<a name="ln1136">//---------------------------------------------------------</a>
<a name="ln1137">//   readNote</a>
<a name="ln1138">//---------------------------------------------------------</a>
<a name="ln1139"> </a>
<a name="ln1140">static void readNote(Note* note, XmlReader&amp; e)</a>
<a name="ln1141">      {</a>
<a name="ln1142">      note-&gt;setTpc1(Tpc::TPC_INVALID);</a>
<a name="ln1143">      note-&gt;setTpc2(Tpc::TPC_INVALID);</a>
<a name="ln1144"> </a>
<a name="ln1145">      while (e.readNextStartElement()) {</a>
<a name="ln1146">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1147">            if (tag == &quot;Accidental&quot;) {</a>
<a name="ln1148">                  Accidental* a = new Accidental(note-&gt;score());</a>
<a name="ln1149">                  a-&gt;setTrack(note-&gt;track());</a>
<a name="ln1150">                  readAccidental206(a, e);</a>
<a name="ln1151">                  note-&gt;add(a);</a>
<a name="ln1152">                  }</a>
<a name="ln1153">            else if (tag == &quot;head&quot;) {</a>
<a name="ln1154">                  int i = e.readInt();</a>
<a name="ln1155">                  NoteHead::Group val = convertHeadGroup(i);</a>
<a name="ln1156">                  note-&gt;setHeadGroup(val);</a>
<a name="ln1157">                  }</a>
<a name="ln1158">            else if (tag == &quot;headType&quot;) {</a>
<a name="ln1159">                  int i = e.readInt();</a>
<a name="ln1160">                  NoteHead::Type val = convertHeadType(i);</a>
<a name="ln1161">                  note-&gt;setHeadType(val);</a>
<a name="ln1162">                  }</a>
<a name="ln1163">            else if (readNoteProperties206(note, e))</a>
<a name="ln1164">                  ;</a>
<a name="ln1165">            else</a>
<a name="ln1166">                  e.unknown();</a>
<a name="ln1167">            }</a>
<a name="ln1168">      // ensure sane values:</a>
<a name="ln1169">      note-&gt;setPitch(limit(note-&gt;pitch(), 0, 127));</a>
<a name="ln1170"> </a>
<a name="ln1171">      if (!tpcIsValid(note-&gt;tpc1()) &amp;&amp; !tpcIsValid(note-&gt;tpc2())) {</a>
<a name="ln1172">            Key key = (note-&gt;staff() &amp;&amp; note-&gt;chord()) ? note-&gt;staff()-&gt;key(note-&gt;chord()-&gt;tick()) : Key::C;</a>
<a name="ln1173">            int tpc = pitch2tpc(note-&gt;pitch(), key, Prefer::NEAREST);</a>
<a name="ln1174">            if (note-&gt;concertPitch())</a>
<a name="ln1175">                  note-&gt;setTpc1(tpc);</a>
<a name="ln1176">            else</a>
<a name="ln1177">                  note-&gt;setTpc2(tpc);</a>
<a name="ln1178">            }</a>
<a name="ln1179">      if (!(tpcIsValid(note-&gt;tpc1()) &amp;&amp; tpcIsValid(note-&gt;tpc2()))) {</a>
<a name="ln1180">            Fraction tick = note-&gt;chord() ? note-&gt;chord()-&gt;tick() : Fraction(-1,1);</a>
<a name="ln1181">            Interval v = note-&gt;staff() ? note-&gt;part()-&gt;instrument(tick)-&gt;transpose() : Interval();</a>
<a name="ln1182">            if (tpcIsValid(note-&gt;tpc1())) {</a>
<a name="ln1183">                  v.flip();</a>
<a name="ln1184">                  if (v.isZero())</a>
<a name="ln1185">                        note-&gt;setTpc2(note-&gt;tpc1());</a>
<a name="ln1186">                  else</a>
<a name="ln1187">                        note-&gt;setTpc2(Ms::transposeTpc(note-&gt;tpc1(), v, true));</a>
<a name="ln1188">                  }</a>
<a name="ln1189">            else {</a>
<a name="ln1190">                  if (v.isZero())</a>
<a name="ln1191">                        note-&gt;setTpc1(note-&gt;tpc2());</a>
<a name="ln1192">                  else</a>
<a name="ln1193">                        note-&gt;setTpc1(Ms::transposeTpc(note-&gt;tpc2(), v, true));</a>
<a name="ln1194">                  }</a>
<a name="ln1195">            }</a>
<a name="ln1196">#if 0</a>
<a name="ln1197">      // TODO - adapt this code</a>
<a name="ln1198"> </a>
<a name="ln1199">      // check consistency of pitch, tpc1, tpc2, and transposition</a>
<a name="ln1200">      // see note in InstrumentChange::read() about a known case of tpc corruption produced in 2.0.x</a>
<a name="ln1201">      // but since there are other causes of tpc corruption (eg, https://musescore.org/en/node/74746)</a>
<a name="ln1202">      // including perhaps some we don't know about yet,</a>
<a name="ln1203">      // we will attempt to fix some problems here regardless of version</a>
<a name="ln1204"> </a>
<a name="ln1205">      if (staff() &amp;&amp; !staff()-&gt;isDrumStaff(e.tick()) &amp;&amp; !e.pasteMode() &amp;&amp; !MScore::testMode) {</a>
<a name="ln1206">            int tpc1Pitch = (tpc2pitch(_tpc[0]) + 12) % 12;</a>
<a name="ln1207">            int tpc2Pitch = (tpc2pitch(_tpc[1]) + 12) % 12;</a>
<a name="ln1208">            int soundingPitch = _pitch % 12;</a>
<a name="ln1209">            if (tpc1Pitch != soundingPitch) {</a>
<a name="ln1210">                  qDebug(&quot;bad tpc1 - soundingPitch = %d, tpc1 = %d&quot;, soundingPitch, tpc1Pitch);</a>
<a name="ln1211">                  _pitch += tpc1Pitch - soundingPitch;</a>
<a name="ln1212">                  }</a>
<a name="ln1213">            if (staff()) {</a>
<a name="ln1214">                  Interval v = staff()-&gt;part()-&gt;instrument(e.tick())-&gt;transpose();</a>
<a name="ln1215">                  int writtenPitch = (_pitch - v.chromatic) % 12;</a>
<a name="ln1216">                  if (tpc2Pitch != writtenPitch) {</a>
<a name="ln1217">                        qDebug(&quot;bad tpc2 - writtenPitch = %d, tpc2 = %d&quot;, writtenPitch, tpc2Pitch);</a>
<a name="ln1218">                        if (concertPitch()) {</a>
<a name="ln1219">                              // assume we want to keep sounding pitch</a>
<a name="ln1220">                              // so fix written pitch (tpc only)</a>
<a name="ln1221">                              v.flip();</a>
<a name="ln1222">                              _tpc[1] = Ms::transposeTpc(_tpc[0], v, true);</a>
<a name="ln1223">                              }</a>
<a name="ln1224">                        else {</a>
<a name="ln1225">                              // assume we want to keep written pitch</a>
<a name="ln1226">                              // so fix sounding pitch (both tpc and pitch)</a>
<a name="ln1227">                              _tpc[0] = Ms::transposeTpc(_tpc[1], v, true);</a>
<a name="ln1228">                              _pitch += tpc2Pitch - writtenPitch;</a>
<a name="ln1229">                              }</a>
<a name="ln1230">                        }</a>
<a name="ln1231">                  }</a>
<a name="ln1232">            }</a>
<a name="ln1233">#endif</a>
<a name="ln1234">      }</a>
<a name="ln1235"> </a>
<a name="ln1236">//---------------------------------------------------------</a>
<a name="ln1237">//   adjustPlacement</a>
<a name="ln1238">//---------------------------------------------------------</a>
<a name="ln1239"> </a>
<a name="ln1240">static void adjustPlacement(Element* e)</a>
<a name="ln1241">      {</a>
<a name="ln1242">      if (!e || !e-&gt;staff())</a>
<a name="ln1243">            return;</a>
<a name="ln1244"> </a>
<a name="ln1245">      // element to use to determine placement</a>
<a name="ln1246">      // for spanners, choose first segment</a>
<a name="ln1247">      Element* ee;</a>
<a name="ln1248">      Spanner* spanner;</a>
<a name="ln1249">      if (e-&gt;isSpanner()) {</a>
<a name="ln1250">            spanner = toSpanner(e);</a>
<a name="ln1251">            if (spanner-&gt;spannerSegments().empty())</a>
<a name="ln1252">                  return;</a>
<a name="ln1253">            ee = spanner-&gt;spannerSegments().front();</a>
<a name="ln1254">            if (!ee)</a>
<a name="ln1255">                  return;</a>
<a name="ln1256">            }</a>
<a name="ln1257">      else {</a>
<a name="ln1258">            spanner = nullptr;</a>
<a name="ln1259">            ee = e;</a>
<a name="ln1260">            }</a>
<a name="ln1261"> </a>
<a name="ln1262">      // determine placement based on offset</a>
<a name="ln1263">      // anything below staff will be set to below</a>
<a name="ln1264">      qreal staffHeight = e-&gt;staff()-&gt;height();</a>
<a name="ln1265">      qreal threshold = staffHeight;</a>
<a name="ln1266">      qreal offsetAdjust = 0.0;</a>
<a name="ln1267">      Placement defaultPlacement = Placement(e-&gt;propertyDefault(Pid::PLACEMENT).toInt());</a>
<a name="ln1268">      Placement newPlacement;</a>
<a name="ln1269">      // most offsets will be recorded as relative to top staff line</a>
<a name="ln1270">      // exceptions are styled offsets on elements with default placement below</a>
<a name="ln1271">      qreal normalize;</a>
<a name="ln1272">      if (defaultPlacement == Placement::BELOW &amp;&amp; ee-&gt;propertyFlags(Pid::OFFSET) == PropertyFlags::STYLED)</a>
<a name="ln1273">            normalize = staffHeight;</a>
<a name="ln1274">      else</a>
<a name="ln1275">            normalize = 0.0;</a>
<a name="ln1276">      qreal ypos = ee-&gt;offset().y() + normalize;</a>
<a name="ln1277">      if (ypos &gt;= threshold) {</a>
<a name="ln1278">            newPlacement = Placement::BELOW;</a>
<a name="ln1279">            offsetAdjust -= staffHeight;</a>
<a name="ln1280">            }</a>
<a name="ln1281">      else {</a>
<a name="ln1282">            newPlacement = Placement::ABOVE;</a>
<a name="ln1283">            }</a>
<a name="ln1284"> </a>
<a name="ln1285">      // set placement</a>
<a name="ln1286">      e-&gt;setProperty(Pid::PLACEMENT, int(newPlacement));</a>
<a name="ln1287">      if (newPlacement != defaultPlacement)</a>
<a name="ln1288">            e-&gt;setPropertyFlags(Pid::PLACEMENT, PropertyFlags::UNSTYLED);</a>
<a name="ln1289"> </a>
<a name="ln1290">      // adjust offset</a>
<a name="ln1291">      if (spanner) {</a>
<a name="ln1292">            // adjust segments individually</a>
<a name="ln1293">            for (auto a : spanner-&gt;spannerSegments()) {</a>
<a name="ln1294">                  // spanner segments share the placement setting of the spanner</a>
<a name="ln1295">                  // just adjust offset</a>
<a name="ln1296">                  if (defaultPlacement == Placement::BELOW &amp;&amp; a-&gt;propertyFlags(Pid::OFFSET) == PropertyFlags::STYLED)</a>
<a name="ln1297">                        normalize = staffHeight;</a>
<a name="ln1298">                  else</a>
<a name="ln1299">                        normalize = 0.0;</a>
<a name="ln1300">                  qreal yp = a-&gt;offset().y() + normalize;</a>
<a name="ln1301">                  a-&gt;ryoffset() += normalize + offsetAdjust;</a>
<a name="ln1302"> </a>
<a name="ln1303">                  // if any segments are offset to opposite side of staff from placement,</a>
<a name="ln1304">                  // or if they are within staff,</a>
<a name="ln1305">                  // disable autoplace</a>
<a name="ln1306">                  bool disableAutoplace;</a>
<a name="ln1307">                  if (yp + a-&gt;height() &lt;= 0.0)</a>
<a name="ln1308">                        disableAutoplace = (newPlacement == Placement::BELOW);</a>
<a name="ln1309">                  else if (yp &gt; staffHeight)</a>
<a name="ln1310">                        disableAutoplace = (newPlacement == Placement::ABOVE);</a>
<a name="ln1311">                  else</a>
<a name="ln1312">                        disableAutoplace = true;</a>
<a name="ln1313">                  if (disableAutoplace)</a>
<a name="ln1314">                        a-&gt;setAutoplace(false);</a>
<a name="ln1315">                  // needed for https://musescore.org/en/node/281312</a>
<a name="ln1316">                  // ideally we would rebase and calculate new offset</a>
<a name="ln1317">                  // but this may not be possible</a>
<a name="ln1318">                  // since original offset is relative to system</a>
<a name="ln1319">                  a-&gt;rxoffset() = 0;</a>
<a name="ln1320">                  }</a>
<a name="ln1321">            }</a>
<a name="ln1322">      else {</a>
<a name="ln1323">            e-&gt;ryoffset() += normalize + offsetAdjust;</a>
<a name="ln1324">            // if within staff, disable autoplace</a>
<a name="ln1325">            if (ypos + e-&gt;height() &gt; 0.0 &amp;&amp; ypos &lt;= staffHeight)</a>
<a name="ln1326">                  e-&gt;setAutoplace(false);</a>
<a name="ln1327">            }</a>
<a name="ln1328">      }</a>
<a name="ln1329"> </a>
<a name="ln1330">//---------------------------------------------------------</a>
<a name="ln1331">//   readNoteProperties206</a>
<a name="ln1332">//---------------------------------------------------------</a>
<a name="ln1333"> </a>
<a name="ln1334">bool readNoteProperties206(Note* note, XmlReader&amp; e)</a>
<a name="ln1335">      {</a>
<a name="ln1336">      const QStringRef&amp; tag(e.name());</a>
<a name="ln1337"> </a>
<a name="ln1338">      if (tag == &quot;pitch&quot;)</a>
<a name="ln1339">            note-&gt;setPitch(e.readInt());</a>
<a name="ln1340">      else if (tag == &quot;tpc&quot;) {</a>
<a name="ln1341">            const int tpc = e.readInt();</a>
<a name="ln1342">            note-&gt;setTpc1(tpc);</a>
<a name="ln1343">            note-&gt;setTpc2(tpc);</a>
<a name="ln1344">            }</a>
<a name="ln1345">      else if (tag == &quot;track&quot;)            // for performance</a>
<a name="ln1346">            note-&gt;setTrack(e.readInt());</a>
<a name="ln1347">      else if (tag == &quot;Accidental&quot;) {</a>
<a name="ln1348">            Accidental* a = new Accidental(note-&gt;score());</a>
<a name="ln1349">            a-&gt;setTrack(note-&gt;track());</a>
<a name="ln1350">            a-&gt;read(e);</a>
<a name="ln1351">            note-&gt;add(a);</a>
<a name="ln1352">            }</a>
<a name="ln1353">      else if (tag == &quot;Tie&quot;) {</a>
<a name="ln1354">            Tie* tie = new Tie(note-&gt;score());</a>
<a name="ln1355">            tie-&gt;setParent(note);</a>
<a name="ln1356">            tie-&gt;setTrack(note-&gt;track());</a>
<a name="ln1357">            readTie206(e, tie);</a>
<a name="ln1358">            tie-&gt;setStartNote(note);</a>
<a name="ln1359">            note-&gt;setTieFor(tie);</a>
<a name="ln1360">            }</a>
<a name="ln1361">      else if (tag == &quot;tpc2&quot;)</a>
<a name="ln1362">            note-&gt;setTpc2(e.readInt());</a>
<a name="ln1363">      else if (tag == &quot;small&quot;)</a>
<a name="ln1364">            note-&gt;setSmall(e.readInt());</a>
<a name="ln1365">      else if (tag == &quot;mirror&quot;)</a>
<a name="ln1366">            note-&gt;readProperty(e, Pid::MIRROR_HEAD);</a>
<a name="ln1367">      else if (tag == &quot;dotPosition&quot;)</a>
<a name="ln1368">            note-&gt;readProperty(e, Pid::DOT_POSITION);</a>
<a name="ln1369">      else if (tag == &quot;fixed&quot;)</a>
<a name="ln1370">            note-&gt;setFixed(e.readBool());</a>
<a name="ln1371">      else if (tag == &quot;fixedLine&quot;)</a>
<a name="ln1372">            note-&gt;setFixedLine(e.readInt());</a>
<a name="ln1373">      else if (tag == &quot;head&quot;)</a>
<a name="ln1374">            note-&gt;readProperty(e, Pid::HEAD_GROUP);</a>
<a name="ln1375">      else if (tag == &quot;velocity&quot;)</a>
<a name="ln1376">            note-&gt;setVeloOffset(e.readInt());</a>
<a name="ln1377">      else if (tag == &quot;play&quot;)</a>
<a name="ln1378">            note-&gt;setPlay(e.readInt());</a>
<a name="ln1379">      else if (tag == &quot;tuning&quot;)</a>
<a name="ln1380">            note-&gt;setTuning(e.readDouble());</a>
<a name="ln1381">      else if (tag == &quot;fret&quot;)</a>
<a name="ln1382">            note-&gt;setFret(e.readInt());</a>
<a name="ln1383">      else if (tag == &quot;string&quot;)</a>
<a name="ln1384">            note-&gt;setString(e.readInt());</a>
<a name="ln1385">      else if (tag == &quot;ghost&quot;)</a>
<a name="ln1386">            note-&gt;setGhost(e.readInt());</a>
<a name="ln1387">      else if (tag == &quot;headType&quot;)</a>
<a name="ln1388">            note-&gt;readProperty(e, Pid::HEAD_TYPE);</a>
<a name="ln1389">      else if (tag == &quot;veloType&quot;)</a>
<a name="ln1390">            note-&gt;readProperty(e, Pid::VELO_TYPE);</a>
<a name="ln1391">      else if (tag == &quot;line&quot;)</a>
<a name="ln1392">            note-&gt;setLine(e.readInt());</a>
<a name="ln1393">      else if (tag == &quot;Fingering&quot;) {</a>
<a name="ln1394">            Fingering* f = new Fingering(note-&gt;score());</a>
<a name="ln1395">            f-&gt;setTrack(note-&gt;track());</a>
<a name="ln1396">            readText206(e, f, note);</a>
<a name="ln1397">            note-&gt;add(f);</a>
<a name="ln1398">            }</a>
<a name="ln1399">      else if (tag == &quot;Symbol&quot;) {</a>
<a name="ln1400">            Symbol* s = new Symbol(note-&gt;score());</a>
<a name="ln1401">            s-&gt;setTrack(note-&gt;track());</a>
<a name="ln1402">            s-&gt;read(e);</a>
<a name="ln1403">            note-&gt;add(s);</a>
<a name="ln1404">            }</a>
<a name="ln1405">      else if (tag == &quot;Image&quot;) {</a>
<a name="ln1406">            if (MScore::noImages)</a>
<a name="ln1407">                  e.skipCurrentElement();</a>
<a name="ln1408">            else {</a>
<a name="ln1409">                  Image* image = new Image(note-&gt;score());</a>
<a name="ln1410">                  image-&gt;setTrack(note-&gt;track());</a>
<a name="ln1411">                  image-&gt;read(e);</a>
<a name="ln1412">                  note-&gt;add(image);</a>
<a name="ln1413">                  }</a>
<a name="ln1414">            }</a>
<a name="ln1415">      else if (tag == &quot;Bend&quot;) {</a>
<a name="ln1416">            Bend* b = new Bend(note-&gt;score());</a>
<a name="ln1417">            b-&gt;setTrack(note-&gt;track());</a>
<a name="ln1418">            b-&gt;read(e);</a>
<a name="ln1419">            note-&gt;add(b);</a>
<a name="ln1420">            }</a>
<a name="ln1421">      else if (tag == &quot;NoteDot&quot;) {</a>
<a name="ln1422">            NoteDot* dot = new NoteDot(note-&gt;score());</a>
<a name="ln1423">            dot-&gt;read(e);</a>
<a name="ln1424">            note-&gt;add(dot);</a>
<a name="ln1425">            }</a>
<a name="ln1426">      else if (tag == &quot;Events&quot;) {</a>
<a name="ln1427">            note-&gt;playEvents().clear();    // remove default event</a>
<a name="ln1428">            while (e.readNextStartElement()) {</a>
<a name="ln1429">                  const QStringRef&amp; etag(e.name());</a>
<a name="ln1430">                  if (etag == &quot;Event&quot;) {</a>
<a name="ln1431">                        NoteEvent ne;</a>
<a name="ln1432">                        ne.read(e);</a>
<a name="ln1433">                        note-&gt;playEvents().append(ne);</a>
<a name="ln1434">                        }</a>
<a name="ln1435">                  else</a>
<a name="ln1436">                        e.unknown();</a>
<a name="ln1437">                  }</a>
<a name="ln1438">            if (Chord* ch = note-&gt;chord())</a>
<a name="ln1439">                  ch-&gt;setPlayEventType(PlayEventType::User);</a>
<a name="ln1440">            }</a>
<a name="ln1441">      else if (tag == &quot;endSpanner&quot;) {</a>
<a name="ln1442">            int id = e.intAttribute(&quot;id&quot;);</a>
<a name="ln1443">            Spanner* sp = e.findSpanner(id);</a>
<a name="ln1444">            if (sp) {</a>
<a name="ln1445">                  sp-&gt;setEndElement(note);</a>
<a name="ln1446">                  if (sp-&gt;isTie())</a>
<a name="ln1447">                        note-&gt;setTieBack(toTie(sp));</a>
<a name="ln1448">                  else {</a>
<a name="ln1449">                        if (sp-&gt;isGlissando() &amp;&amp; note-&gt;parent() &amp;&amp; note-&gt;parent()-&gt;isChord())</a>
<a name="ln1450">                              toChord(note-&gt;parent())-&gt;setEndsGlissando(true);</a>
<a name="ln1451">                        note-&gt;addSpannerBack(sp);</a>
<a name="ln1452">                        }</a>
<a name="ln1453">                  e.removeSpanner(sp);</a>
<a name="ln1454">                  }</a>
<a name="ln1455">            else {</a>
<a name="ln1456">                  // End of a spanner whose start element will appear later;</a>
<a name="ln1457">                  // may happen for cross-staff spanner from a lower to a higher staff</a>
<a name="ln1458">                  // (for instance a glissando from bass to treble staff of piano).</a>
<a name="ln1459">                  // Create a place-holder spanner with end data</a>
<a name="ln1460">                  // (a TextLine is used only because both Spanner or SLine are abstract,</a>
<a name="ln1461">                  // the actual class does not matter, as long as it is derived from Spanner)</a>
<a name="ln1462">                  int id1 = e.intAttribute(&quot;id&quot;, -1);</a>
<a name="ln1463">                  Staff* staff = note-&gt;staff();</a>
<a name="ln1464">                  if (id1 != -1 &amp;&amp;</a>
<a name="ln1465">                              // DISABLE if pasting into a staff with linked staves</a>
<a name="ln1466">                              // because the glissando is not properly cloned into the linked staves</a>
<a name="ln1467">                              staff &amp;&amp; (!e.pasteMode() || !staff-&gt;links() || staff-&gt;links()-&gt;empty())) {</a>
<a name="ln1468">                        Spanner* placeholder = new TextLine(note-&gt;score());</a>
<a name="ln1469">                        placeholder-&gt;setAnchor(Spanner::Anchor::NOTE);</a>
<a name="ln1470">                        placeholder-&gt;setEndElement(note);</a>
<a name="ln1471">                        placeholder-&gt;setTrack2(note-&gt;track());</a>
<a name="ln1472">                        placeholder-&gt;setTick(Fraction(0,1));</a>
<a name="ln1473">                        placeholder-&gt;setTick2(e.tick());</a>
<a name="ln1474">                        e.addSpanner(id1, placeholder);</a>
<a name="ln1475">                        }</a>
<a name="ln1476">                  }</a>
<a name="ln1477">            e.readNext();</a>
<a name="ln1478">            }</a>
<a name="ln1479">      else if (tag == &quot;TextLine&quot;</a>
<a name="ln1480">            || tag == &quot;Glissando&quot;) {</a>
<a name="ln1481">            Spanner* sp = toSpanner(Element::name2Element(tag, note-&gt;score()));</a>
<a name="ln1482">            // check this is not a lower-to-higher cross-staff spanner we already got</a>
<a name="ln1483">            int id = e.intAttribute(&quot;id&quot;);</a>
<a name="ln1484">            Spanner* placeholder = e.findSpanner(id);</a>
<a name="ln1485">            if (placeholder &amp;&amp; placeholder-&gt;endElement()) {</a>
<a name="ln1486">                  // if it is, fill end data from place-holder</a>
<a name="ln1487">                  sp-&gt;setAnchor(Spanner::Anchor::NOTE);           // make sure we can set a Note as end element</a>
<a name="ln1488">                  sp-&gt;setEndElement(placeholder-&gt;endElement());</a>
<a name="ln1489">                  sp-&gt;setTrack2(placeholder-&gt;track2());</a>
<a name="ln1490">                  sp-&gt;setTick(e.tick());                          // make sure tick2 will be correct</a>
<a name="ln1491">                  sp-&gt;setTick2(placeholder-&gt;tick2());</a>
<a name="ln1492">                  toNote(placeholder-&gt;endElement())-&gt;addSpannerBack(sp);</a>
<a name="ln1493">                  // remove no longer needed place-holder before reading the new spanner,</a>
<a name="ln1494">                  // as reading it also adds it to XML reader list of spanners,</a>
<a name="ln1495">                  // which would overwrite the place-holder</a>
<a name="ln1496">                  e.removeSpanner(placeholder);</a>
<a name="ln1497">                  delete placeholder;</a>
<a name="ln1498">                  }</a>
<a name="ln1499">            sp-&gt;setTrack(note-&gt;track());</a>
<a name="ln1500">            sp-&gt;read(e);</a>
<a name="ln1501">            Staff* staff = note-&gt;staff();</a>
<a name="ln1502">            // DISABLE pasting of glissandi into staves with other lionked staves</a>
<a name="ln1503">            // because the glissando is not properly cloned into the linked staves</a>
<a name="ln1504">            if (e.pasteMode() &amp;&amp; staff &amp;&amp; staff-&gt;links() &amp;&amp; !staff-&gt;links()-&gt;empty()) {</a>
<a name="ln1505">                  e.removeSpanner(sp);    // read() added the element to the XMLReader: remove it</a>
<a name="ln1506">                  delete sp;</a>
<a name="ln1507">                  }</a>
<a name="ln1508">            else {</a>
<a name="ln1509">                  sp-&gt;setAnchor(Spanner::Anchor::NOTE);</a>
<a name="ln1510">                  sp-&gt;setStartElement(note);</a>
<a name="ln1511">                  sp-&gt;setTick(e.tick());</a>
<a name="ln1512">                  note-&gt;addSpannerFor(sp);</a>
<a name="ln1513">                  sp-&gt;setParent(note);</a>
<a name="ln1514">                  }</a>
<a name="ln1515">            adjustPlacement(sp);</a>
<a name="ln1516">            }</a>
<a name="ln1517">      else if (tag == &quot;offset&quot;)</a>
<a name="ln1518">            note-&gt;Element::readProperties(e);</a>
<a name="ln1519">      else if (note-&gt;Element::readProperties(e))</a>
<a name="ln1520">            ;</a>
<a name="ln1521">      else</a>
<a name="ln1522">            return false;</a>
<a name="ln1523">      return true;</a>
<a name="ln1524">      }</a>
<a name="ln1525"> </a>
<a name="ln1526">//---------------------------------------------------------</a>
<a name="ln1527">//   readTextPropertyStyle206</a>
<a name="ln1528">//    This reads only the 'style' tag, so that it can be read</a>
<a name="ln1529">//    before setting anything else.</a>
<a name="ln1530">//---------------------------------------------------------</a>
<a name="ln1531"> </a>
<a name="ln1532">static bool readTextPropertyStyle206(XmlReader&amp; e, TextBase* t, Element* be, QStringRef elementName)</a>
<a name="ln1533">      {</a>
<a name="ln1534">      QString s;</a>
<a name="ln1535">      if (e.readAheadAvailable()) {</a>
<a name="ln1536">            e.performReadAhead([&amp;s, &amp;elementName](QIODevice&amp; dev) {</a>
<a name="ln1537">                  const QString closeTag = QString(&quot;&lt;/&quot;).append(elementName.toString()).append(&quot;&gt;&quot;);</a>
<a name="ln1538">                  QByteArray arrLine = dev.readLine();</a>
<a name="ln1539">                  while (!arrLine.isEmpty()) {</a>
<a name="ln1540">                        QString line(arrLine);</a>
<a name="ln1541">                        if (line.contains(&quot;&lt;style&gt;&quot;)) {</a>
<a name="ln1542">                              QRegExp re(&quot;&lt;style&gt;([^&lt;]+)&lt;/style&gt;&quot;);</a>
<a name="ln1543">                              if (re.indexIn(line) &gt; -1)</a>
<a name="ln1544">                                    s = re.cap(1);</a>
<a name="ln1545">                              return;</a>
<a name="ln1546">                              }</a>
<a name="ln1547">                        else if (line.contains(closeTag)) {</a>
<a name="ln1548">                              return;</a>
<a name="ln1549">                              }</a>
<a name="ln1550"> </a>
<a name="ln1551">                        arrLine = dev.readLine();</a>
<a name="ln1552">                        }</a>
<a name="ln1553">                  });</a>
<a name="ln1554">            }</a>
<a name="ln1555">      else</a>
<a name="ln1556">            return false;</a>
<a name="ln1557"> </a>
<a name="ln1558">      if (s.isEmpty())</a>
<a name="ln1559">            return true;</a>
<a name="ln1560"> </a>
<a name="ln1561">      if (!be-&gt;isTuplet()) {      // Hack</a>
<a name="ln1562">            if (excessTextStyles206.find(s) != excessTextStyles206.end()) {</a>
<a name="ln1563">                  // Init the text with a style that can't be stored as a user style</a>
<a name="ln1564">                  // due to the limit on the number of user styles possible.</a>
<a name="ln1565">                  // Use User-1, since it has all the possible user style pids</a>
<a name="ln1566">                  t-&gt;initTid(Tid::DEFAULT);</a>
<a name="ln1567">                  std::map&lt;Sid, QVariant&gt; styleVals = excessTextStyles206[s];</a>
<a name="ln1568">                  for (const StyledProperty&amp; p : *textStyle(&quot;User-1&quot;)) {</a>
<a name="ln1569">                        if (t-&gt;getProperty(p.pid) == t-&gt;propertyDefault(p.pid) &amp;&amp; styleVals.find(p.sid) != styleVals.end())</a>
<a name="ln1570">                              t-&gt;setProperty(p.pid, styleVals[p.sid]);</a>
<a name="ln1571">                        }</a>
<a name="ln1572">                  }</a>
<a name="ln1573">            else {</a>
<a name="ln1574">                  Tid ss;</a>
<a name="ln1575">                  ss = e.lookupUserTextStyle(s);</a>
<a name="ln1576">                  if (ss == Tid::TEXT_STYLES)</a>
<a name="ln1577">                        ss = textStyleFromName(s);</a>
<a name="ln1578">                  if (ss != Tid::TEXT_STYLES)</a>
<a name="ln1579">                        t-&gt;initTid(ss);</a>
<a name="ln1580">                  }</a>
<a name="ln1581">            }</a>
<a name="ln1582"> </a>
<a name="ln1583">      return true;</a>
<a name="ln1584">      }</a>
<a name="ln1585"> </a>
<a name="ln1586">//---------------------------------------------------------</a>
<a name="ln1587">//   readTextProperties206</a>
<a name="ln1588">//---------------------------------------------------------</a>
<a name="ln1589"> </a>
<a name="ln1590">static bool readTextProperties206(XmlReader&amp; e, TextBase* t)</a>
<a name="ln1591">      {</a>
<a name="ln1592">      const QStringRef&amp; tag(e.name());</a>
<a name="ln1593">      if (tag == &quot;style&quot;) {</a>
<a name="ln1594">            e.skipCurrentElement(); // read in readTextPropertyStyle206</a>
<a name="ln1595">            }</a>
<a name="ln1596">      else if (tag == &quot;foregroundColor&quot;)  // same as &quot;color&quot; ?</a>
<a name="ln1597">            e.skipCurrentElement();</a>
<a name="ln1598">      else if (tag == &quot;frame&quot;) {</a>
<a name="ln1599">            t-&gt;setFrameType(e.readBool() ? FrameType::SQUARE : FrameType::NO_FRAME);</a>
<a name="ln1600">            t-&gt;setPropertyFlags(Pid::FRAME_TYPE, PropertyFlags::UNSTYLED);</a>
<a name="ln1601">            }</a>
<a name="ln1602">      else if (tag == &quot;frameRound&quot;)</a>
<a name="ln1603">            t-&gt;readProperty(e, Pid::FRAME_ROUND);</a>
<a name="ln1604">      else if (tag == &quot;circle&quot;) {</a>
<a name="ln1605">            if (e.readBool())</a>
<a name="ln1606">                  t-&gt;setFrameType(FrameType::CIRCLE);</a>
<a name="ln1607">            else {</a>
<a name="ln1608">                  if (t-&gt;circle())</a>
<a name="ln1609">                        t-&gt;setFrameType(FrameType::SQUARE);</a>
<a name="ln1610">                  }</a>
<a name="ln1611">            t-&gt;setPropertyFlags(Pid::FRAME_TYPE, PropertyFlags::UNSTYLED);</a>
<a name="ln1612">            }</a>
<a name="ln1613">      else if (tag == &quot;paddingWidthS&quot;)</a>
<a name="ln1614">            t-&gt;readProperty(e, Pid::FRAME_PADDING);</a>
<a name="ln1615">      else if (tag == &quot;frameWidthS&quot;)</a>
<a name="ln1616">            t-&gt;readProperty(e, Pid::FRAME_WIDTH);</a>
<a name="ln1617">      else if (tag == &quot;frameColor&quot;)</a>
<a name="ln1618">            t-&gt;readProperty(e, Pid::FRAME_FG_COLOR);</a>
<a name="ln1619">      else if (tag == &quot;backgroundColor&quot;)</a>
<a name="ln1620">            t-&gt;readProperty(e, Pid::FRAME_BG_COLOR);</a>
<a name="ln1621">      else if (tag == &quot;halign&quot;) {</a>
<a name="ln1622">            Align align = Align(int(t-&gt;align()) &amp; int(~Align::HMASK));</a>
<a name="ln1623">            const QString&amp; val(e.readElementText());</a>
<a name="ln1624">            if (val == &quot;center&quot;)</a>
<a name="ln1625">                  align = align | Align::HCENTER;</a>
<a name="ln1626">            else if (val == &quot;right&quot;)</a>
<a name="ln1627">                  align = align | Align::RIGHT;</a>
<a name="ln1628">            else if (val == &quot;left&quot;)</a>
<a name="ln1629">                  ;</a>
<a name="ln1630">            else</a>
<a name="ln1631">                  qDebug(&quot;unknown alignment: &lt;%s&gt;&quot;, qPrintable(val));</a>
<a name="ln1632">            t-&gt;setAlign(align);</a>
<a name="ln1633">            t-&gt;setPropertyFlags(Pid::ALIGN, PropertyFlags::UNSTYLED);</a>
<a name="ln1634">            }</a>
<a name="ln1635">      else if (tag == &quot;valign&quot;) {</a>
<a name="ln1636">            Align align = Align(int(t-&gt;align()) &amp; int(~Align::VMASK));</a>
<a name="ln1637">            const QString&amp; val(e.readElementText());</a>
<a name="ln1638">            if (val == &quot;center&quot;)</a>
<a name="ln1639">                  align = align | Align::VCENTER;</a>
<a name="ln1640">            else if (val == &quot;bottom&quot;)</a>
<a name="ln1641">                  align = align | Align::BOTTOM;</a>
<a name="ln1642">            else if (val == &quot;baseline&quot;)</a>
<a name="ln1643">                  align = align | Align::BASELINE;</a>
<a name="ln1644">            else if (val == &quot;top&quot;)</a>
<a name="ln1645">                  ;</a>
<a name="ln1646">            else</a>
<a name="ln1647">                  qDebug(&quot;unknown alignment: &lt;%s&gt;&quot;, qPrintable(val));</a>
<a name="ln1648">            t-&gt;setAlign(align);</a>
<a name="ln1649">            t-&gt;setPropertyFlags(Pid::ALIGN, PropertyFlags::UNSTYLED);</a>
<a name="ln1650">            }</a>
<a name="ln1651">      else if (tag == &quot;pos&quot;) {</a>
<a name="ln1652">            t-&gt;readProperty(e, Pid::OFFSET);</a>
<a name="ln1653">            if ((char(t-&gt;align()) &amp; char(Align::VMASK)) == char(Align::TOP))</a>
<a name="ln1654">                  t-&gt;ryoffset() += .5 * t-&gt;score()-&gt;spatium();     // HACK: bbox is different in 2.x</a>
<a name="ln1655">            adjustPlacement(t);</a>
<a name="ln1656">            }</a>
<a name="ln1657">      else if (!t-&gt;readProperties(e))</a>
<a name="ln1658">            return false;</a>
<a name="ln1659">      return true;</a>
<a name="ln1660">      }</a>
<a name="ln1661"> </a>
<a name="ln1662">//---------------------------------------------------------</a>
<a name="ln1663">//   readText206</a>
<a name="ln1664">//---------------------------------------------------------</a>
<a name="ln1665"> </a>
<a name="ln1666">static void readText206(XmlReader&amp; e, TextBase* t, Element* be)</a>
<a name="ln1667">      {</a>
<a name="ln1668">      readTextPropertyStyle206(e, t, be, e.name());</a>
<a name="ln1669">      while (e.readNextStartElement()) {</a>
<a name="ln1670">            if (!readTextProperties206(e, t))</a>
<a name="ln1671">                  e.unknown();</a>
<a name="ln1672">            }</a>
<a name="ln1673">      }</a>
<a name="ln1674"> </a>
<a name="ln1675">//---------------------------------------------------------</a>
<a name="ln1676">//   read</a>
<a name="ln1677">//---------------------------------------------------------</a>
<a name="ln1678"> </a>
<a name="ln1679">static void readTempoText(TempoText* t, XmlReader&amp; e)</a>
<a name="ln1680">      {</a>
<a name="ln1681">      readTextPropertyStyle206(e, t, t, e.name());</a>
<a name="ln1682">      while (e.readNextStartElement()) {</a>
<a name="ln1683">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1684">            if (tag == &quot;tempo&quot;)</a>
<a name="ln1685">                  t-&gt;setTempo(e.readDouble());</a>
<a name="ln1686">            else if (tag == &quot;followText&quot;)</a>
<a name="ln1687">                  t-&gt;setFollowText(e.readInt());</a>
<a name="ln1688">            else if (!readTextProperties206(e, t))</a>
<a name="ln1689">                  e.unknown();</a>
<a name="ln1690">            }</a>
<a name="ln1691">      // check sanity</a>
<a name="ln1692">      if (t-&gt;xmlText().isEmpty()) {</a>
<a name="ln1693">            t-&gt;setXmlText(QString(&quot;&lt;sym&gt;metNoteQuarterUp&lt;/sym&gt; = %1&quot;).arg(lrint(60 * t-&gt;tempo())));</a>
<a name="ln1694">            t-&gt;setVisible(false);</a>
<a name="ln1695">            }</a>
<a name="ln1696">      else</a>
<a name="ln1697">            t-&gt;setXmlText(t-&gt;xmlText().replace(&quot;&lt;sym&gt;unicode&quot;, &quot;&lt;sym&gt;met&quot;));</a>
<a name="ln1698">      }</a>
<a name="ln1699"> </a>
<a name="ln1700">//---------------------------------------------------------</a>
<a name="ln1701">//   readMarker</a>
<a name="ln1702">//---------------------------------------------------------</a>
<a name="ln1703"> </a>
<a name="ln1704">static void readMarker(Marker* m, XmlReader&amp; e)</a>
<a name="ln1705">      {</a>
<a name="ln1706">      readTextPropertyStyle206(e, m, m, e.name());</a>
<a name="ln1707">      Marker::Type mt = Marker::Type::SEGNO;</a>
<a name="ln1708"> </a>
<a name="ln1709">      while (e.readNextStartElement()) {</a>
<a name="ln1710">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1711">            if (tag == &quot;label&quot;) {</a>
<a name="ln1712">                  QString s(e.readElementText());</a>
<a name="ln1713">                  m-&gt;setLabel(s);</a>
<a name="ln1714">                  mt = m-&gt;markerType(s);</a>
<a name="ln1715">                  }</a>
<a name="ln1716">            else if (!readTextProperties206(e, m))</a>
<a name="ln1717">                  e.unknown();</a>
<a name="ln1718">            }</a>
<a name="ln1719">      m-&gt;setMarkerType(mt);</a>
<a name="ln1720">      }</a>
<a name="ln1721"> </a>
<a name="ln1722">//---------------------------------------------------------</a>
<a name="ln1723">//   readDynamic</a>
<a name="ln1724">//---------------------------------------------------------</a>
<a name="ln1725"> </a>
<a name="ln1726">static void readDynamic(Dynamic* d, XmlReader&amp; e)</a>
<a name="ln1727">      {</a>
<a name="ln1728">      readTextPropertyStyle206(e, d, d, e.name());</a>
<a name="ln1729">      while (e.readNextStartElement()) {</a>
<a name="ln1730">            const QStringRef&amp; tag = e.name();</a>
<a name="ln1731">            if (tag == &quot;subtype&quot;)</a>
<a name="ln1732">                  d-&gt;setDynamicType(e.readElementText());</a>
<a name="ln1733">            else if (tag == &quot;velocity&quot;)</a>
<a name="ln1734">                  d-&gt;setVelocity(e.readInt());</a>
<a name="ln1735">            else if (tag == &quot;dynType&quot;)</a>
<a name="ln1736">                  d-&gt;setDynRange(Dynamic::Range(e.readInt()));</a>
<a name="ln1737">            else if (!readTextProperties206(e, d))</a>
<a name="ln1738">                  e.unknown();</a>
<a name="ln1739">            }</a>
<a name="ln1740">      }</a>
<a name="ln1741"> </a>
<a name="ln1742">//---------------------------------------------------------</a>
<a name="ln1743">//   readTuplet</a>
<a name="ln1744">//---------------------------------------------------------</a>
<a name="ln1745"> </a>
<a name="ln1746">static void readTuplet(Tuplet* tuplet, XmlReader&amp; e)</a>
<a name="ln1747">      {</a>
<a name="ln1748">      tuplet-&gt;setId(e.intAttribute(&quot;id&quot;, 0));</a>
<a name="ln1749">      while (e.readNextStartElement()) {</a>
<a name="ln1750">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1751">            if (tag == &quot;Number&quot;) {</a>
<a name="ln1752">                  Text* _number = new Text(tuplet-&gt;score());</a>
<a name="ln1753">                  _number-&gt;setParent(tuplet);</a>
<a name="ln1754">                  _number-&gt;setComposition(true);</a>
<a name="ln1755">                  tuplet-&gt;setNumber(_number);</a>
<a name="ln1756">                  // _number reads property defaults from parent tuplet as &quot;composition&quot; is set:</a>
<a name="ln1757">                  tuplet-&gt;resetNumberProperty();</a>
<a name="ln1758">                  readText206(e, _number, tuplet);</a>
<a name="ln1759">                  _number-&gt;setVisible(tuplet-&gt;visible());     //?? override saved property</a>
<a name="ln1760">                  _number-&gt;setTrack(tuplet-&gt;track());</a>
<a name="ln1761">                  // move property flags from _number</a>
<a name="ln1762">                  for (auto p : { Pid::FONT_FACE, Pid::FONT_SIZE, Pid::FONT_STYLE, Pid::ALIGN, Pid::SIZE_SPATIUM_DEPENDENT })</a>
<a name="ln1763">                        tuplet-&gt;setPropertyFlags(p, _number-&gt;propertyFlags(p));</a>
<a name="ln1764">                  }</a>
<a name="ln1765">            else if (!readTupletProperties206(e, tuplet))</a>
<a name="ln1766">                  e.unknown();</a>
<a name="ln1767">            }</a>
<a name="ln1768">      Fraction r = (tuplet-&gt;ratio() == Fraction(1,1)) ? tuplet-&gt;ratio() : tuplet-&gt;ratio().reduced();</a>
<a name="ln1769">      Fraction f(r.denominator(), tuplet-&gt;baseLen().fraction().denominator());</a>
<a name="ln1770">      tuplet-&gt;setTicks(f.reduced());</a>
<a name="ln1771">      }</a>
<a name="ln1772"> </a>
<a name="ln1773">//---------------------------------------------------------</a>
<a name="ln1774">//   readLyrics</a>
<a name="ln1775">//---------------------------------------------------------</a>
<a name="ln1776"> </a>
<a name="ln1777">static void readLyrics(Lyrics* lyrics, XmlReader&amp; e)</a>
<a name="ln1778">      {</a>
<a name="ln1779">      int   iEndTick = 0;           // used for backward compatibility</a>
<a name="ln1780">      Text* _verseNumber = 0;</a>
<a name="ln1781"> </a>
<a name="ln1782">      while (e.readNextStartElement()) {</a>
<a name="ln1783">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1784">            if (tag == &quot;endTick&quot;) {</a>
<a name="ln1785">                  // store &lt;endTick&gt; tag value until a &lt;ticks&gt; tag has been read</a>
<a name="ln1786">                  // which positions this lyrics element in the score</a>
<a name="ln1787">                  iEndTick = e.readInt();</a>
<a name="ln1788">                  }</a>
<a name="ln1789">            else if (tag == &quot;Number&quot;) {</a>
<a name="ln1790">                  _verseNumber = new Text(lyrics-&gt;score());</a>
<a name="ln1791">                  readText206(e, _verseNumber, lyrics);</a>
<a name="ln1792">                  _verseNumber-&gt;setParent(lyrics);</a>
<a name="ln1793">                  }</a>
<a name="ln1794">            else if (tag == &quot;style&quot;)</a>
<a name="ln1795">                  e.readElementText();    // ignore style</a>
<a name="ln1796">            else if (!lyrics-&gt;readProperties(e))</a>
<a name="ln1797">                  e.unknown();</a>
<a name="ln1798">            }</a>
<a name="ln1799"> </a>
<a name="ln1800">      // if any endTick, make it relative to current tick</a>
<a name="ln1801">      if (iEndTick)</a>
<a name="ln1802">            lyrics-&gt;setTicks(Fraction::fromTicks(iEndTick) - e.tick());</a>
<a name="ln1803">      if (_verseNumber) {</a>
<a name="ln1804">            // TODO: add text to main text</a>
<a name="ln1805">            delete _verseNumber;</a>
<a name="ln1806">            }</a>
<a name="ln1807">      lyrics-&gt;setAutoplace(true);</a>
<a name="ln1808">      if (!lyrics-&gt;isStyled(Pid::OFFSET) &amp;&amp; !e.pasteMode()) {</a>
<a name="ln1809">            // fix offset for pre-3.1 scores</a>
<a name="ln1810">            // 2.x and earlier: y offset was relative to staff; x offset was relative to center of notehead</a>
<a name="ln1811">            lyrics-&gt;rxoffset() -= lyrics-&gt;symWidth(SymId::noteheadBlack) * 0.5;</a>
<a name="ln1812">            //lyrics-&gt;ryoffset() -= lyrics-&gt;placeBelow() &amp;&amp; lyrics-&gt;staff() ? lyrics-&gt;staff()-&gt;height() : 0.0;</a>
<a name="ln1813">            // temporarily set placement to above, since the original offset is relative to top of staff</a>
<a name="ln1814">            // depend on adjustPlacement() to change the placement if appropriate</a>
<a name="ln1815">            lyrics-&gt;setPlacement(Placement::ABOVE);</a>
<a name="ln1816">            adjustPlacement(lyrics);</a>
<a name="ln1817">            }</a>
<a name="ln1818">      }</a>
<a name="ln1819"> </a>
<a name="ln1820">//---------------------------------------------------------</a>
<a name="ln1821">//   readDurationProperties206</a>
<a name="ln1822">//---------------------------------------------------------</a>
<a name="ln1823"> </a>
<a name="ln1824">bool readDurationProperties206(XmlReader&amp; e, DurationElement* de)</a>
<a name="ln1825">      {</a>
<a name="ln1826">      if (e.name() == &quot;Tuplet&quot;) {</a>
<a name="ln1827">            int i = e.readInt();</a>
<a name="ln1828">            Tuplet* t = e.findTuplet(i);</a>
<a name="ln1829">            if (!t) {</a>
<a name="ln1830">                  qDebug(&quot;readDurationProperties206(): Tuplet id %d not found&quot;, i);</a>
<a name="ln1831">                  t = de-&gt;score()-&gt;searchTuplet(e, i);</a>
<a name="ln1832">                  if (t) {</a>
<a name="ln1833">                        qDebug(&quot;   ...found outside measure, input file corrupted?&quot;);</a>
<a name="ln1834">                        e.addTuplet(t);</a>
<a name="ln1835">                        }</a>
<a name="ln1836">                  }</a>
<a name="ln1837">            if (t) {</a>
<a name="ln1838">                  de-&gt;setTuplet(t);</a>
<a name="ln1839">                  if (!de-&gt;score()-&gt;undoStack()-&gt;active())     // HACK, also added in Undo::AddElement()</a>
<a name="ln1840">                        t-&gt;add(de);</a>
<a name="ln1841">                  }</a>
<a name="ln1842">            return true;</a>
<a name="ln1843">            }</a>
<a name="ln1844">      else if (de-&gt;Element::readProperties(e))</a>
<a name="ln1845">            return true;</a>
<a name="ln1846">      return false;</a>
<a name="ln1847">      }</a>
<a name="ln1848"> </a>
<a name="ln1849">//---------------------------------------------------------</a>
<a name="ln1850">//   readTupletProperties206</a>
<a name="ln1851">//---------------------------------------------------------</a>
<a name="ln1852"> </a>
<a name="ln1853">bool readTupletProperties206(XmlReader&amp; e, Tuplet* de)</a>
<a name="ln1854">      {</a>
<a name="ln1855">      const QStringRef&amp; tag(e.name());</a>
<a name="ln1856"> </a>
<a name="ln1857">      if (de-&gt;readStyledProperty(e, tag))</a>
<a name="ln1858">            ;</a>
<a name="ln1859">      else if (tag == &quot;normalNotes&quot;)</a>
<a name="ln1860">            de-&gt;setProperty(Pid::NORMAL_NOTES, e.readInt());</a>
<a name="ln1861">      else if (tag == &quot;actualNotes&quot;)</a>
<a name="ln1862">            de-&gt;setProperty(Pid::ACTUAL_NOTES, e.readInt());</a>
<a name="ln1863">      else if (tag == &quot;p1&quot;)</a>
<a name="ln1864">            de-&gt;setProperty(Pid::P1, e.readPoint() * de-&gt;score()-&gt;spatium());</a>
<a name="ln1865">      else if (tag == &quot;p2&quot;)</a>
<a name="ln1866">            de-&gt;setProperty(Pid::P2, e.readPoint() * de-&gt;score()-&gt;spatium());</a>
<a name="ln1867">      else if (tag == &quot;baseNote&quot;)</a>
<a name="ln1868">            de-&gt;setBaseLen(TDuration(e.readElementText()));</a>
<a name="ln1869">      else if (tag == &quot;Number&quot;) {</a>
<a name="ln1870">            Text* _number = new Text(de-&gt;score());</a>
<a name="ln1871">            de-&gt;setNumber(_number);</a>
<a name="ln1872">            _number-&gt;setComposition(true);</a>
<a name="ln1873">            _number-&gt;setParent(de);</a>
<a name="ln1874">//            _number-&gt;setSubStyleId(SubStyleId::TUPLET);</a>
<a name="ln1875">//            initSubStyle(SubStyleId::TUPLET);   // hack: initialize number</a>
<a name="ln1876">            for (auto p : { Pid::FONT_FACE, Pid::FONT_SIZE, Pid::FONT_STYLE, Pid::ALIGN })</a>
<a name="ln1877">                  _number-&gt;resetProperty(p);</a>
<a name="ln1878">            readText206(e, _number, de);</a>
<a name="ln1879">            _number-&gt;setVisible(de-&gt;visible());     //?? override saved property</a>
<a name="ln1880">            _number-&gt;setTrack(de-&gt;track());</a>
<a name="ln1881">            // move property flags from _number</a>
<a name="ln1882">            for (auto p : { Pid::FONT_FACE, Pid::FONT_SIZE, Pid::FONT_STYLE, Pid::ALIGN })</a>
<a name="ln1883">                  de-&gt;setPropertyFlags(p, _number-&gt;propertyFlags(p));</a>
<a name="ln1884">            }</a>
<a name="ln1885">      else if (!readDurationProperties206(e, de))</a>
<a name="ln1886">            return false;</a>
<a name="ln1887">      return true;</a>
<a name="ln1888">      }</a>
<a name="ln1889"> </a>
<a name="ln1890">//---------------------------------------------------------</a>
<a name="ln1891">//   readChordRestProperties206</a>
<a name="ln1892">//---------------------------------------------------------</a>
<a name="ln1893"> </a>
<a name="ln1894">bool readChordRestProperties206(XmlReader&amp; e, ChordRest* ch)</a>
<a name="ln1895">      {</a>
<a name="ln1896">      const QStringRef&amp; tag(e.name());</a>
<a name="ln1897"> </a>
<a name="ln1898">      if (tag == &quot;durationType&quot;) {</a>
<a name="ln1899">            ch-&gt;setDurationType(e.readElementText());</a>
<a name="ln1900">            if (ch-&gt;actualDurationType().type() != TDuration::DurationType::V_MEASURE) {</a>
<a name="ln1901">                  if (ch-&gt;score()-&gt;mscVersion() &lt; 112 &amp;&amp; (ch-&gt;type() == ElementType::REST) &amp;&amp;</a>
<a name="ln1902">                              // for backward compatibility, convert V_WHOLE rests to V_MEASURE</a>
<a name="ln1903">                              // if long enough to fill a measure.</a>
<a name="ln1904">                              // OTOH, freshly created (un-initialized) rests have numerator == 0 (&lt; 4/4)</a>
<a name="ln1905">                              // (see Fraction() constructor in fraction.h; this happens for instance</a>
<a name="ln1906">                              // when pasting selection from clipboard): they should not be converted</a>
<a name="ln1907">                              ch-&gt;ticks().numerator() != 0 &amp;&amp;</a>
<a name="ln1908">                              // rest durations are initialized to full measure duration when</a>
<a name="ln1909">                              // created upon reading the &lt;Rest&gt; tag (see Measure::read() )</a>
<a name="ln1910">                              // so a V_WHOLE rest in a measure of 4/4 or less =&gt; V_MEASURE</a>
<a name="ln1911">                              (ch-&gt;actualDurationType()==TDuration::DurationType::V_WHOLE &amp;&amp; ch-&gt;ticks() &lt;= Fraction(4, 4)) ) {</a>
<a name="ln1912">                        // old pre 2.0 scores: convert</a>
<a name="ln1913">                        ch-&gt;setDurationType(TDuration::DurationType::V_MEASURE);</a>
<a name="ln1914">                        }</a>
<a name="ln1915">                  else  // not from old score: set duration fraction from duration type</a>
<a name="ln1916">                        ch-&gt;setTicks(ch-&gt;actualDurationType().fraction());</a>
<a name="ln1917">                  }</a>
<a name="ln1918">            else {</a>
<a name="ln1919">                  if (ch-&gt;score()-&gt;mscVersion() &lt;= 114) {</a>
<a name="ln1920">                        SigEvent event = ch-&gt;score()-&gt;sigmap()-&gt;timesig(e.tick());</a>
<a name="ln1921">                        ch-&gt;setTicks(event.timesig());</a>
<a name="ln1922">                        }</a>
<a name="ln1923">                  }</a>
<a name="ln1924">            }</a>
<a name="ln1925">      else if (tag == &quot;BeamMode&quot;) {</a>
<a name="ln1926">            QString val(e.readElementText());</a>
<a name="ln1927">            Beam::Mode bm = Beam::Mode::AUTO;</a>
<a name="ln1928">            if (val == &quot;auto&quot;)</a>
<a name="ln1929">                  bm = Beam::Mode::AUTO;</a>
<a name="ln1930">            else if (val == &quot;begin&quot;)</a>
<a name="ln1931">                  bm = Beam::Mode::BEGIN;</a>
<a name="ln1932">            else if (val == &quot;mid&quot;)</a>
<a name="ln1933">                  bm = Beam::Mode::MID;</a>
<a name="ln1934">            else if (val == &quot;end&quot;)</a>
<a name="ln1935">                  bm = Beam::Mode::END;</a>
<a name="ln1936">            else if (val == &quot;no&quot;)</a>
<a name="ln1937">                  bm = Beam::Mode::NONE;</a>
<a name="ln1938">            else if (val == &quot;begin32&quot;)</a>
<a name="ln1939">                  bm = Beam::Mode::BEGIN32;</a>
<a name="ln1940">            else if (val == &quot;begin64&quot;)</a>
<a name="ln1941">                  bm = Beam::Mode::BEGIN64;</a>
<a name="ln1942">            else</a>
<a name="ln1943">                  bm = Beam::Mode(val.toInt());</a>
<a name="ln1944">            ch-&gt;setBeamMode(bm);</a>
<a name="ln1945">            }</a>
<a name="ln1946">      else if (tag == &quot;Articulation&quot;) {</a>
<a name="ln1947">            Element* el = readArticulation(ch, e);</a>
<a name="ln1948">            if (el-&gt;isFermata())</a>
<a name="ln1949">                  ch-&gt;segment()-&gt;add(el);</a>
<a name="ln1950">            else</a>
<a name="ln1951">                  ch-&gt;add(el);</a>
<a name="ln1952">            }</a>
<a name="ln1953">      else if (tag == &quot;leadingSpace&quot; || tag == &quot;trailingSpace&quot;) {</a>
<a name="ln1954">            qDebug(&quot;ChordRest: %s obsolete&quot;, tag.toLocal8Bit().data());</a>
<a name="ln1955">            e.skipCurrentElement();</a>
<a name="ln1956">            }</a>
<a name="ln1957">      else if (tag == &quot;Beam&quot;) {</a>
<a name="ln1958">            int id = e.readInt();</a>
<a name="ln1959">            Beam* beam = e.findBeam(id);</a>
<a name="ln1960">            if (beam)</a>
<a name="ln1961">                  beam-&gt;add(ch);        // also calls ch-&gt;setBeam(beam)</a>
<a name="ln1962">            else</a>
<a name="ln1963">                  qDebug(&quot;Beam id %d not found&quot;, id);</a>
<a name="ln1964">            }</a>
<a name="ln1965">      else if (tag == &quot;small&quot;)</a>
<a name="ln1966">            ch-&gt;setSmall(e.readInt());</a>
<a name="ln1967">      else if (tag == &quot;duration&quot;)</a>
<a name="ln1968">            ch-&gt;setTicks(e.readFraction());</a>
<a name="ln1969">      else if (tag == &quot;ticklen&quot;) {      // obsolete (version &lt; 1.12)</a>
<a name="ln1970">            int mticks = ch-&gt;score()-&gt;sigmap()-&gt;timesig(e.tick()).timesig().ticks();</a>
<a name="ln1971">            int i = e.readInt();</a>
<a name="ln1972">            if (i == 0)</a>
<a name="ln1973">                  i = mticks;</a>
<a name="ln1974">            if ((ch-&gt;type() == ElementType::REST) &amp;&amp; (mticks == i)) {</a>
<a name="ln1975">                  ch-&gt;setDurationType(TDuration::DurationType::V_MEASURE);</a>
<a name="ln1976">                  ch-&gt;setTicks(Fraction::fromTicks(i));</a>
<a name="ln1977">                  }</a>
<a name="ln1978">            else {</a>
<a name="ln1979">                  Fraction f = Fraction::fromTicks(i);</a>
<a name="ln1980">                  ch-&gt;setTicks(f);</a>
<a name="ln1981">                  ch-&gt;setDurationType(TDuration(f));</a>
<a name="ln1982">                  }</a>
<a name="ln1983">            }</a>
<a name="ln1984">      else if (tag == &quot;dots&quot;)</a>
<a name="ln1985">            ch-&gt;setDots(e.readInt());</a>
<a name="ln1986">      else if (tag == &quot;move&quot;)</a>
<a name="ln1987">            ch-&gt;setStaffMove(e.readInt());</a>
<a name="ln1988">      else if (tag == &quot;Slur&quot;) {</a>
<a name="ln1989">            int id = e.intAttribute(&quot;id&quot;);</a>
<a name="ln1990">            if (id == 0)</a>
<a name="ln1991">                  id = e.intAttribute(&quot;number&quot;);                  // obsolete</a>
<a name="ln1992">            Spanner* spanner = e.findSpanner(id);</a>
<a name="ln1993">            QString atype(e.attribute(&quot;type&quot;));</a>
<a name="ln1994"> </a>
<a name="ln1995">            if (!spanner) {</a>
<a name="ln1996">                  if (atype == &quot;stop&quot;) {</a>
<a name="ln1997">                        SpannerValues sv;</a>
<a name="ln1998">                        sv.spannerId = id;</a>
<a name="ln1999">                        sv.track2    = ch-&gt;track();</a>
<a name="ln2000">                        sv.tick2     = e.tick();</a>
<a name="ln2001">                        e.addSpannerValues(sv);</a>
<a name="ln2002">                        }</a>
<a name="ln2003">                  else if (atype == &quot;start&quot;)</a>
<a name="ln2004">                        qDebug(&quot;spanner: start without spanner&quot;);</a>
<a name="ln2005">                  }</a>
<a name="ln2006">            else {</a>
<a name="ln2007">                  if (atype == &quot;start&quot;) {</a>
<a name="ln2008">                        if (spanner-&gt;ticks() &gt; Fraction(0,1) &amp;&amp; spanner-&gt;tick() == Fraction(-1,1)) // stop has been read first</a>
<a name="ln2009">                              spanner-&gt;setTicks(spanner-&gt;ticks() - e.tick() - Fraction::fromTicks(1));</a>
<a name="ln2010">                        spanner-&gt;setTick(e.tick());</a>
<a name="ln2011">                        spanner-&gt;setTrack(ch-&gt;track());</a>
<a name="ln2012">                        if (spanner-&gt;type() == ElementType::SLUR)</a>
<a name="ln2013">                              spanner-&gt;setStartElement(ch);</a>
<a name="ln2014">                        if (e.pasteMode()) {</a>
<a name="ln2015">                              for (ScoreElement* el : spanner-&gt;linkList()) {</a>
<a name="ln2016">                                    if (el == spanner)</a>
<a name="ln2017">                                          continue;</a>
<a name="ln2018">                                    Spanner* ls = static_cast&lt;Spanner*&gt;(el);</a>
<a name="ln2019">                                    ls-&gt;setTick(spanner-&gt;tick());</a>
<a name="ln2020">                                    for (ScoreElement* ee : ch-&gt;linkList()) {</a>
<a name="ln2021">                                          ChordRest* cr = toChordRest(ee);</a>
<a name="ln2022">                                          if (cr-&gt;score() == ee-&gt;score() &amp;&amp; cr-&gt;staffIdx() == ls-&gt;staffIdx()) {</a>
<a name="ln2023">                                                ls-&gt;setTrack(cr-&gt;track());</a>
<a name="ln2024">                                                if (ls-&gt;type() == ElementType::SLUR)</a>
<a name="ln2025">                                                      ls-&gt;setStartElement(cr);</a>
<a name="ln2026">                                                break;</a>
<a name="ln2027">                                                }</a>
<a name="ln2028">                                          }</a>
<a name="ln2029">                                    }</a>
<a name="ln2030">                              }</a>
<a name="ln2031">                        }</a>
<a name="ln2032">                  else if (atype == &quot;stop&quot;) {</a>
<a name="ln2033">                        spanner-&gt;setTick2(e.tick());</a>
<a name="ln2034">                        spanner-&gt;setTrack2(ch-&gt;track());</a>
<a name="ln2035">                        if (spanner-&gt;isSlur())</a>
<a name="ln2036">                              spanner-&gt;setEndElement(ch);</a>
<a name="ln2037">                        ChordRest* start = toChordRest(spanner-&gt;startElement());</a>
<a name="ln2038">                        if (start)</a>
<a name="ln2039">                              spanner-&gt;setTrack(start-&gt;track());</a>
<a name="ln2040">                        if (e.pasteMode()) {</a>
<a name="ln2041">                              for (ScoreElement* el : spanner-&gt;linkList()) {</a>
<a name="ln2042">                                    if (el == spanner)</a>
<a name="ln2043">                                          continue;</a>
<a name="ln2044">                                    Spanner* ls = static_cast&lt;Spanner*&gt;(el);</a>
<a name="ln2045">                                    ls-&gt;setTick2(spanner-&gt;tick2());</a>
<a name="ln2046">                                    for (ScoreElement* ee : ch-&gt;linkList()) {</a>
<a name="ln2047">                                          ChordRest* cr = toChordRest(ee);</a>
<a name="ln2048">                                          if (cr-&gt;score() == ee-&gt;score() &amp;&amp; cr-&gt;staffIdx() == ls-&gt;staffIdx()) {</a>
<a name="ln2049">                                                ls-&gt;setTrack2(cr-&gt;track());</a>
<a name="ln2050">                                                if (ls-&gt;type() == ElementType::SLUR)</a>
<a name="ln2051">                                                      ls-&gt;setEndElement(cr);</a>
<a name="ln2052">                                                break;</a>
<a name="ln2053">                                                }</a>
<a name="ln2054">                                          }</a>
<a name="ln2055">                                    }</a>
<a name="ln2056">                              }</a>
<a name="ln2057">                        }</a>
<a name="ln2058">                  else</a>
<a name="ln2059">                        qDebug(&quot;readChordRestProperties206(): unknown Slur type &lt;%s&gt;&quot;, qPrintable(atype));</a>
<a name="ln2060">                  }</a>
<a name="ln2061">            e.readNext();</a>
<a name="ln2062">            }</a>
<a name="ln2063">      else if (tag == &quot;Lyrics&quot;) {</a>
<a name="ln2064">            Lyrics* l = new Lyrics(ch-&gt;score());</a>
<a name="ln2065">            l-&gt;setTrack(e.track());</a>
<a name="ln2066">            readLyrics(l, e);</a>
<a name="ln2067">            ch-&gt;add(l);</a>
<a name="ln2068">            }</a>
<a name="ln2069">      else if (tag == &quot;pos&quot;) {</a>
<a name="ln2070">            QPointF pt = e.readPoint();</a>
<a name="ln2071">            ch-&gt;setOffset(pt * ch-&gt;spatium());</a>
<a name="ln2072">            }</a>
<a name="ln2073">      else if (ch-&gt;isRest() &amp;&amp; tag == &quot;Image&quot;){</a>
<a name="ln2074">            if (MScore::noImages)</a>
<a name="ln2075">                  e.skipCurrentElement();</a>
<a name="ln2076">            else {</a>
<a name="ln2077">                  Image *image = new Image(ch-&gt;score());</a>
<a name="ln2078">                  image-&gt;setTrack(e.track());</a>
<a name="ln2079">                  image-&gt;read(e);</a>
<a name="ln2080">                  ch-&gt;add(image);</a>
<a name="ln2081">                  }</a>
<a name="ln2082">            }</a>
<a name="ln2083">      else if (!readDurationProperties206(e, ch))</a>
<a name="ln2084">            return false;</a>
<a name="ln2085">      return true;</a>
<a name="ln2086">      }</a>
<a name="ln2087"> </a>
<a name="ln2088">//---------------------------------------------------------</a>
<a name="ln2089">//   readChordProperties206</a>
<a name="ln2090">//---------------------------------------------------------</a>
<a name="ln2091"> </a>
<a name="ln2092">bool readChordProperties206(XmlReader&amp; e, Chord* ch)</a>
<a name="ln2093">      {</a>
<a name="ln2094">      const QStringRef&amp; tag(e.name());</a>
<a name="ln2095"> </a>
<a name="ln2096">      if (tag == &quot;Note&quot;) {</a>
<a name="ln2097">            Note* note = new Note(ch-&gt;score());</a>
<a name="ln2098">            // the note needs to know the properties of the track it belongs to</a>
<a name="ln2099">            note-&gt;setTrack(ch-&gt;track());</a>
<a name="ln2100">            note-&gt;setChord(ch);</a>
<a name="ln2101">            readNote(note, e);</a>
<a name="ln2102">            ch-&gt;add(note);</a>
<a name="ln2103">            }</a>
<a name="ln2104">      else if (readChordRestProperties206(e, ch))</a>
<a name="ln2105">            ;</a>
<a name="ln2106">      else if (tag == &quot;Stem&quot;) {</a>
<a name="ln2107">            Stem* s = new Stem(ch-&gt;score());</a>
<a name="ln2108">            s-&gt;read(e);</a>
<a name="ln2109">            ch-&gt;add(s);</a>
<a name="ln2110">            }</a>
<a name="ln2111">      else if (tag == &quot;Hook&quot;) {</a>
<a name="ln2112">            Hook* hook = new Hook(ch-&gt;score());</a>
<a name="ln2113">            hook-&gt;read(e);</a>
<a name="ln2114">            ch-&gt;add(hook);</a>
<a name="ln2115">            }</a>
<a name="ln2116">      else if (tag == &quot;appoggiatura&quot;) {</a>
<a name="ln2117">            ch-&gt;setNoteType(NoteType::APPOGGIATURA);</a>
<a name="ln2118">            e.readNext();</a>
<a name="ln2119">            }</a>
<a name="ln2120">      else if (tag == &quot;acciaccatura&quot;) {</a>
<a name="ln2121">            ch-&gt;setNoteType(NoteType::ACCIACCATURA);</a>
<a name="ln2122">            e.readNext();</a>
<a name="ln2123">            }</a>
<a name="ln2124">      else if (tag == &quot;grace4&quot;) {</a>
<a name="ln2125">            ch-&gt;setNoteType(NoteType::GRACE4);</a>
<a name="ln2126">            e.readNext();</a>
<a name="ln2127">            }</a>
<a name="ln2128">      else if (tag == &quot;grace16&quot;) {</a>
<a name="ln2129">            ch-&gt;setNoteType(NoteType::GRACE16);</a>
<a name="ln2130">            e.readNext();</a>
<a name="ln2131">            }</a>
<a name="ln2132">      else if (tag == &quot;grace32&quot;) {</a>
<a name="ln2133">            ch-&gt;setNoteType(NoteType::GRACE32);</a>
<a name="ln2134">            e.readNext();</a>
<a name="ln2135">            }</a>
<a name="ln2136">      else if (tag == &quot;grace8after&quot;) {</a>
<a name="ln2137">            ch-&gt;setNoteType(NoteType::GRACE8_AFTER);</a>
<a name="ln2138">            e.readNext();</a>
<a name="ln2139">            }</a>
<a name="ln2140">      else if (tag == &quot;grace16after&quot;) {</a>
<a name="ln2141">            ch-&gt;setNoteType(NoteType::GRACE16_AFTER);</a>
<a name="ln2142">            e.readNext();</a>
<a name="ln2143">            }</a>
<a name="ln2144">      else if (tag == &quot;grace32after&quot;) {</a>
<a name="ln2145">            ch-&gt;setNoteType(NoteType::GRACE32_AFTER);</a>
<a name="ln2146">            e.readNext();</a>
<a name="ln2147">            }</a>
<a name="ln2148">      else if (tag == &quot;StemSlash&quot;) {</a>
<a name="ln2149">            StemSlash* ss = new StemSlash(ch-&gt;score());</a>
<a name="ln2150">            ss-&gt;read(e);</a>
<a name="ln2151">            ch-&gt;add(ss);</a>
<a name="ln2152">            }</a>
<a name="ln2153">      else if (ch-&gt;readProperty(tag, e, Pid::STEM_DIRECTION))</a>
<a name="ln2154">            ;</a>
<a name="ln2155">      else if (tag == &quot;noStem&quot;)</a>
<a name="ln2156">            ch-&gt;setNoStem(e.readInt());</a>
<a name="ln2157">      else if (tag == &quot;Arpeggio&quot;) {</a>
<a name="ln2158">            Arpeggio* arpeggio = new Arpeggio(ch-&gt;score());</a>
<a name="ln2159">            arpeggio-&gt;setTrack(ch-&gt;track());</a>
<a name="ln2160">            arpeggio-&gt;read(e);</a>
<a name="ln2161">            arpeggio-&gt;setParent(ch);</a>
<a name="ln2162">            ch-&gt;add(arpeggio);</a>
<a name="ln2163">            }</a>
<a name="ln2164">      // old glissando format, chord-to-chord, attached to its final chord</a>
<a name="ln2165">      else if (tag == &quot;Glissando&quot;) {</a>
<a name="ln2166">            // the measure we are reading is not inserted in the score yet</a>
<a name="ln2167">            // as well as, possibly, the glissando intended initial chord;</a>
<a name="ln2168">            // then we cannot fully link the glissando right now;</a>
<a name="ln2169">            // temporarily attach the glissando to its final note as a back spanner;</a>
<a name="ln2170">            // after the whole score is read, Score::connectTies() will look for</a>
<a name="ln2171">            // the suitable initial note</a>
<a name="ln2172">            Note* finalNote = ch-&gt;upNote();</a>
<a name="ln2173">            Glissando* gliss = new Glissando(ch-&gt;score());</a>
<a name="ln2174">            gliss-&gt;read(e);</a>
<a name="ln2175">            gliss-&gt;setAnchor(Spanner::Anchor::NOTE);</a>
<a name="ln2176">            gliss-&gt;setStartElement(nullptr);</a>
<a name="ln2177">            gliss-&gt;setEndElement(nullptr);</a>
<a name="ln2178">            // in TAB, use straight line with no text</a>
<a name="ln2179">            if (ch-&gt;score()-&gt;staff(e.track() &gt;&gt; 2)-&gt;isTabStaff(ch-&gt;tick())) {</a>
<a name="ln2180">                  gliss-&gt;setGlissandoType(GlissandoType::STRAIGHT);</a>
<a name="ln2181">                  gliss-&gt;setShowText(false);</a>
<a name="ln2182">                  }</a>
<a name="ln2183">            finalNote-&gt;addSpannerBack(gliss);</a>
<a name="ln2184">            }</a>
<a name="ln2185">      else if (tag == &quot;Tremolo&quot;) {</a>
<a name="ln2186">            Tremolo* tremolo = new Tremolo(ch-&gt;score());</a>
<a name="ln2187">            tremolo-&gt;setTrack(ch-&gt;track());</a>
<a name="ln2188">            tremolo-&gt;read(e);</a>
<a name="ln2189">            tremolo-&gt;setParent(ch);</a>
<a name="ln2190">            tremolo-&gt;setDurationType(ch-&gt;durationType());</a>
<a name="ln2191">            ch-&gt;setTremolo(tremolo);</a>
<a name="ln2192">            }</a>
<a name="ln2193">      else if (tag == &quot;tickOffset&quot;)       // obsolete</a>
<a name="ln2194">            ;</a>
<a name="ln2195">      else if (tag == &quot;ChordLine&quot;) {</a>
<a name="ln2196">            ChordLine* cl = new ChordLine(ch-&gt;score());</a>
<a name="ln2197">            cl-&gt;read(e);</a>
<a name="ln2198">            QPointF o = cl-&gt;offset();</a>
<a name="ln2199">            cl-&gt;setOffset(0.0, 0.0);</a>
<a name="ln2200">            ch-&gt;add(cl);</a>
<a name="ln2201">            e.fixOffsets().append({cl, o});</a>
<a name="ln2202">            }</a>
<a name="ln2203">      else</a>
<a name="ln2204">            return false;</a>
<a name="ln2205">      return true;</a>
<a name="ln2206">      }</a>
<a name="ln2207"> </a>
<a name="ln2208">//---------------------------------------------------------</a>
<a name="ln2209">//   convertDoubleArticulations</a>
<a name="ln2210">//    Replace double articulations with proper SMuFL</a>
<a name="ln2211">//    symbols which were not available for use prior to 3.0</a>
<a name="ln2212">//---------------------------------------------------------</a>
<a name="ln2213"> </a>
<a name="ln2214">static void convertDoubleArticulations(Chord* chord, XmlReader&amp; e)</a>
<a name="ln2215">      {</a>
<a name="ln2216">      std::vector&lt;Articulation*&gt; pairableArticulations;</a>
<a name="ln2217">      for (Articulation* a : chord-&gt;articulations()) {</a>
<a name="ln2218">            if (a-&gt;isStaccato() || a-&gt;isTenuto()</a>
<a name="ln2219">               || a-&gt;isAccent() || a-&gt;isMarcato()) {</a>
<a name="ln2220">                  pairableArticulations.push_back(a);</a>
<a name="ln2221">                  };</a>
<a name="ln2222">            }</a>
<a name="ln2223">      if (pairableArticulations.size() != 2)</a>
<a name="ln2224">            // Do not replace triple articulation if this happens</a>
<a name="ln2225">            return;</a>
<a name="ln2226"> </a>
<a name="ln2227">      SymId newSymId = SymId::noSym;</a>
<a name="ln2228">      for (int i = 0; i &lt; 2; ++i) {</a>
<a name="ln2229">            if (newSymId != SymId::noSym)</a>
<a name="ln2230">                  break;</a>
<a name="ln2231">            Articulation* ai = pairableArticulations[i];</a>
<a name="ln2232">            Articulation* aj = pairableArticulations[(i == 0) ? 1 : 0];</a>
<a name="ln2233">            if (ai-&gt;isStaccato()) {</a>
<a name="ln2234">                  if (aj-&gt;isAccent())</a>
<a name="ln2235">                        newSymId = SymId::articAccentStaccatoAbove;</a>
<a name="ln2236">                  else if (aj-&gt;isMarcato())</a>
<a name="ln2237">                        newSymId = SymId::articMarcatoStaccatoAbove;</a>
<a name="ln2238">                  else if (aj-&gt;isTenuto())</a>
<a name="ln2239">                        newSymId = SymId::articTenutoStaccatoAbove;</a>
<a name="ln2240">                  }</a>
<a name="ln2241">            else if (ai-&gt;isTenuto()) {</a>
<a name="ln2242">                  if (aj-&gt;isAccent())</a>
<a name="ln2243">                        newSymId = SymId::articTenutoAccentAbove;</a>
<a name="ln2244">                  else if (aj-&gt;isMarcato())</a>
<a name="ln2245">                        newSymId = SymId::articMarcatoTenutoAbove;</a>
<a name="ln2246">                  }</a>
<a name="ln2247">            }</a>
<a name="ln2248"> </a>
<a name="ln2249">      if (newSymId != SymId::noSym) {</a>
<a name="ln2250">            // We reuse old articulation and change symbol ID</a>
<a name="ln2251">            // rather than constructing a new articulation</a>
<a name="ln2252">            // in order to preserve its other properties.</a>
<a name="ln2253">            Articulation* newArtic = pairableArticulations[0];</a>
<a name="ln2254">            for (Articulation* a : pairableArticulations) {</a>
<a name="ln2255">                  chord-&gt;remove(a);</a>
<a name="ln2256">                  if (a != newArtic) {</a>
<a name="ln2257">                        if (LinkedElements* link = a-&gt;links())</a>
<a name="ln2258">                              e.linkIds().remove(link-&gt;lid());</a>
<a name="ln2259">                        delete a;</a>
<a name="ln2260">                        }</a>
<a name="ln2261">                  }</a>
<a name="ln2262"> </a>
<a name="ln2263">            ArticulationAnchor anchor = newArtic-&gt;anchor();</a>
<a name="ln2264">            newArtic-&gt;setSymId(newSymId);</a>
<a name="ln2265">            newArtic-&gt;setAnchor(anchor);</a>
<a name="ln2266">            chord-&gt;add(newArtic);</a>
<a name="ln2267">            }</a>
<a name="ln2268">      }</a>
<a name="ln2269"> </a>
<a name="ln2270">//---------------------------------------------------------</a>
<a name="ln2271">//   readChord</a>
<a name="ln2272">//---------------------------------------------------------</a>
<a name="ln2273"> </a>
<a name="ln2274">static void readChord(Chord* chord, XmlReader&amp; e)</a>
<a name="ln2275">      {</a>
<a name="ln2276">      while (e.readNextStartElement()) {</a>
<a name="ln2277">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2278">            if (tag == &quot;Note&quot;) {</a>
<a name="ln2279">                  Note* note = new Note(chord-&gt;score());</a>
<a name="ln2280">                  // the note needs to know the properties of the track it belongs to</a>
<a name="ln2281">                  note-&gt;setTrack(chord-&gt;track());</a>
<a name="ln2282">                  note-&gt;setChord(chord);</a>
<a name="ln2283">                  readNote(note, e);</a>
<a name="ln2284">                  chord-&gt;add(note);</a>
<a name="ln2285">                  }</a>
<a name="ln2286">            else if (tag == &quot;Stem&quot;) {</a>
<a name="ln2287">                  Stem* stem = new Stem(chord-&gt;score());</a>
<a name="ln2288">                  while (e.readNextStartElement()) {</a>
<a name="ln2289">                        const QStringRef&amp; t(e.name());</a>
<a name="ln2290">                        if (t == &quot;subtype&quot;)        // obsolete</a>
<a name="ln2291">                              e.skipCurrentElement();</a>
<a name="ln2292">                        else if (!stem-&gt;readProperties(e))</a>
<a name="ln2293">                              e.unknown();</a>
<a name="ln2294">                        }</a>
<a name="ln2295">                  chord-&gt;add(stem);</a>
<a name="ln2296">                  }</a>
<a name="ln2297">            else if (tag == &quot;Lyrics&quot;) {</a>
<a name="ln2298">                  Lyrics* lyrics = new Lyrics(chord-&gt;score());</a>
<a name="ln2299">                  lyrics-&gt;setTrack(e.track());</a>
<a name="ln2300">                  readLyrics(lyrics, e);</a>
<a name="ln2301">                  chord-&gt;add(lyrics);</a>
<a name="ln2302">                  }</a>
<a name="ln2303">            else if (readChordProperties206(e, chord))</a>
<a name="ln2304">                  ;</a>
<a name="ln2305">            else</a>
<a name="ln2306">                  e.unknown();</a>
<a name="ln2307">            }</a>
<a name="ln2308">      convertDoubleArticulations(chord, e);</a>
<a name="ln2309">      }</a>
<a name="ln2310"> </a>
<a name="ln2311">//---------------------------------------------------------</a>
<a name="ln2312">//   readRest</a>
<a name="ln2313">//---------------------------------------------------------</a>
<a name="ln2314"> </a>
<a name="ln2315">static void readRest(Rest* rest, XmlReader&amp; e)</a>
<a name="ln2316">      {</a>
<a name="ln2317">      while (e.readNextStartElement()) {</a>
<a name="ln2318">            if (!readChordRestProperties206(e, rest))</a>
<a name="ln2319">                  e.unknown();</a>
<a name="ln2320">            }</a>
<a name="ln2321">      }</a>
<a name="ln2322"> </a>
<a name="ln2323">//---------------------------------------------------------</a>
<a name="ln2324">//   readTextLineProperties</a>
<a name="ln2325">//---------------------------------------------------------</a>
<a name="ln2326"> </a>
<a name="ln2327">static bool readTextLineProperties(XmlReader&amp; e, TextLineBase* tl)</a>
<a name="ln2328">      {</a>
<a name="ln2329">      const QStringRef&amp; tag(e.name());</a>
<a name="ln2330"> </a>
<a name="ln2331">      if (tag == &quot;beginText&quot;) {</a>
<a name="ln2332">            Text* text = new Text(tl-&gt;score());</a>
<a name="ln2333">            readText206(e, text, tl);</a>
<a name="ln2334">            tl-&gt;setBeginText(text-&gt;xmlText());</a>
<a name="ln2335">            delete text;</a>
<a name="ln2336">            }</a>
<a name="ln2337">      else if (tag == &quot;continueText&quot;) {</a>
<a name="ln2338">            Text* text = new Text(tl-&gt;score());</a>
<a name="ln2339">            readText206(e, text, tl);</a>
<a name="ln2340">            tl-&gt;setContinueText(text-&gt;xmlText());</a>
<a name="ln2341">            delete text;</a>
<a name="ln2342">            }</a>
<a name="ln2343">      else if (tag == &quot;endText&quot;) {</a>
<a name="ln2344">            Text* text = new Text(tl-&gt;score());</a>
<a name="ln2345">            readText206(e, text, tl);</a>
<a name="ln2346">            tl-&gt;setEndText(text-&gt;xmlText());</a>
<a name="ln2347">            delete text;</a>
<a name="ln2348">            }</a>
<a name="ln2349">      else if (tag == &quot;beginHook&quot;)</a>
<a name="ln2350">            tl-&gt;setBeginHookType(e.readBool() ? HookType::HOOK_90 : HookType::NONE);</a>
<a name="ln2351">      else if (tag == &quot;endHook&quot;)</a>
<a name="ln2352">            tl-&gt;setEndHookType(e.readBool() ? HookType::HOOK_90 : HookType::NONE);</a>
<a name="ln2353">      else if (tag == &quot;beginHookType&quot;)</a>
<a name="ln2354">            tl-&gt;setBeginHookType(e.readInt() == 0 ? HookType::HOOK_90 : HookType::HOOK_45);</a>
<a name="ln2355">      else if (tag == &quot;endHookType&quot;)</a>
<a name="ln2356">            tl-&gt;setEndHookType(e.readInt() == 0 ? HookType::HOOK_90 : HookType::HOOK_45);</a>
<a name="ln2357">      else if (tl-&gt;readProperties(e))</a>
<a name="ln2358">            return true;</a>
<a name="ln2359">      return true;</a>
<a name="ln2360">      }</a>
<a name="ln2361"> </a>
<a name="ln2362">//---------------------------------------------------------</a>
<a name="ln2363">//   readVolta206</a>
<a name="ln2364">//---------------------------------------------------------</a>
<a name="ln2365"> </a>
<a name="ln2366">static void readVolta206(XmlReader&amp; e, Volta* volta)</a>
<a name="ln2367">      {</a>
<a name="ln2368">      while (e.readNextStartElement()) {</a>
<a name="ln2369">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2370">            if (tag == &quot;endings&quot;) {</a>
<a name="ln2371">                  QString s = e.readElementText();</a>
<a name="ln2372">                  QStringList sl = s.split(&quot;,&quot;, QString::SkipEmptyParts);</a>
<a name="ln2373">                  volta-&gt;endings().clear();</a>
<a name="ln2374">                  for (const QString&amp; l : sl) {</a>
<a name="ln2375">                        int i = l.simplified().toInt();</a>
<a name="ln2376">                        volta-&gt;endings().append(i);</a>
<a name="ln2377">                        }</a>
<a name="ln2378">                  }</a>
<a name="ln2379">            else if (tag == &quot;lineWidth&quot;) {</a>
<a name="ln2380">                  volta-&gt;setLineWidth(e.readDouble() * volta-&gt;spatium());</a>
<a name="ln2381">                  // TODO lineWidthStyle = PropertyStyle::UNSTYLED;</a>
<a name="ln2382">                  }</a>
<a name="ln2383">            else if (!readTextLineProperties(e, volta))</a>
<a name="ln2384">                  e.unknown();</a>
<a name="ln2385">            }</a>
<a name="ln2386">      adjustPlacement(volta);</a>
<a name="ln2387">      }</a>
<a name="ln2388"> </a>
<a name="ln2389">//---------------------------------------------------------</a>
<a name="ln2390">//   readPedal</a>
<a name="ln2391">//---------------------------------------------------------</a>
<a name="ln2392"> </a>
<a name="ln2393">static void readPedal(XmlReader&amp; e, Pedal* pedal)</a>
<a name="ln2394">      {</a>
<a name="ln2395">      while (e.readNextStartElement()) {</a>
<a name="ln2396">            if (!readTextLineProperties(e, pedal))</a>
<a name="ln2397">                  e.unknown();</a>
<a name="ln2398">            }</a>
<a name="ln2399">      adjustPlacement(pedal);</a>
<a name="ln2400">      }</a>
<a name="ln2401"> </a>
<a name="ln2402">//---------------------------------------------------------</a>
<a name="ln2403">//   readOttava</a>
<a name="ln2404">//---------------------------------------------------------</a>
<a name="ln2405"> </a>
<a name="ln2406">static void readOttava(XmlReader&amp; e, Ottava* ottava)</a>
<a name="ln2407">      {</a>
<a name="ln2408">      while (e.readNextStartElement()) {</a>
<a name="ln2409">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2410">            if (tag == &quot;subtype&quot;) {</a>
<a name="ln2411">                  QString s = e.readElementText();</a>
<a name="ln2412">                  bool ok;</a>
<a name="ln2413">                  int idx = s.toInt(&amp;ok);</a>
<a name="ln2414">                  if (!ok) {</a>
<a name="ln2415">                        idx = 0;    // OttavaType::OTTAVA_8VA;</a>
<a name="ln2416">                        int i = 0;</a>
<a name="ln2417">                        for (auto p :  { &quot;8va&quot;,&quot;8vb&quot;,&quot;15ma&quot;,&quot;15mb&quot;,&quot;22ma&quot;,&quot;22mb&quot; } ) {</a>
<a name="ln2418">                              if (p == s) {</a>
<a name="ln2419">                                    idx = i;</a>
<a name="ln2420">                                    break;</a>
<a name="ln2421">                                    }</a>
<a name="ln2422">                              ++i;</a>
<a name="ln2423">                              }</a>
<a name="ln2424">                        }</a>
<a name="ln2425">                  ottava-&gt;setOttavaType(OttavaType(idx));</a>
<a name="ln2426">                  }</a>
<a name="ln2427">            else if (tag == &quot;numbersOnly&quot;) {</a>
<a name="ln2428">                  ottava-&gt;setNumbersOnly(e.readBool());</a>
<a name="ln2429">                  //TODO numbersOnlyStyle = PropertyFlags::UNSTYLED;</a>
<a name="ln2430">                  }</a>
<a name="ln2431">            else if (!readTextLineProperties(e, ottava))</a>
<a name="ln2432">                  e.unknown();</a>
<a name="ln2433">            }</a>
<a name="ln2434">      ottava-&gt;styleChanged();</a>
<a name="ln2435">      adjustPlacement(ottava);</a>
<a name="ln2436">      }</a>
<a name="ln2437"> </a>
<a name="ln2438">//---------------------------------------------------------</a>
<a name="ln2439">//   readHairpin206</a>
<a name="ln2440">//---------------------------------------------------------</a>
<a name="ln2441"> </a>
<a name="ln2442">void readHairpin206(XmlReader&amp; e, Hairpin* h)</a>
<a name="ln2443">      {</a>
<a name="ln2444">      bool useText = false;</a>
<a name="ln2445">      while (e.readNextStartElement()) {</a>
<a name="ln2446">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2447">            if (tag == &quot;subtype&quot;)</a>
<a name="ln2448">                  h-&gt;setHairpinType(HairpinType(e.readInt()));</a>
<a name="ln2449">            else if (tag == &quot;lineWidth&quot;) {</a>
<a name="ln2450">                  h-&gt;setLineWidth(e.readDouble() * h-&gt;spatium());</a>
<a name="ln2451">                  // lineWidthStyle = PropertyFlags::UNSTYLED;</a>
<a name="ln2452">                  }</a>
<a name="ln2453">            else if (tag == &quot;hairpinHeight&quot;) {</a>
<a name="ln2454">                  h-&gt;setHairpinHeight(Spatium(e.readDouble()));</a>
<a name="ln2455">                  // hairpinHeightStyle = PropertyFlags::UNSTYLED;</a>
<a name="ln2456">                  }</a>
<a name="ln2457">            else if (tag == &quot;hairpinContHeight&quot;) {</a>
<a name="ln2458">                  h-&gt;setHairpinContHeight(Spatium(e.readDouble()));</a>
<a name="ln2459">                  // hairpinContHeightStyle = PropertyFlags::UNSTYLED;</a>
<a name="ln2460">                  }</a>
<a name="ln2461">            else if (tag == &quot;hairpinCircledTip&quot;)</a>
<a name="ln2462">                  h-&gt;setHairpinCircledTip(e.readInt());</a>
<a name="ln2463">            else if (tag == &quot;veloChange&quot;)</a>
<a name="ln2464">                  h-&gt;setVeloChange(e.readInt());</a>
<a name="ln2465">            else if (tag == &quot;dynType&quot;)</a>
<a name="ln2466">                  h-&gt;setDynRange(Dynamic::Range(e.readInt()));</a>
<a name="ln2467">            else if (tag == &quot;useTextLine&quot;) {      // &lt; 206</a>
<a name="ln2468">                  e.readInt();</a>
<a name="ln2469">                  if (h-&gt;hairpinType() == HairpinType::CRESC_HAIRPIN)</a>
<a name="ln2470">                        h-&gt;setHairpinType(HairpinType::CRESC_LINE);</a>
<a name="ln2471">                  else if (h-&gt;hairpinType() == HairpinType::DECRESC_HAIRPIN)</a>
<a name="ln2472">                        h-&gt;setHairpinType(HairpinType::DECRESC_LINE);</a>
<a name="ln2473">                  useText = true;</a>
<a name="ln2474">                  }</a>
<a name="ln2475">            else if (!readTextLineProperties(e, h))</a>
<a name="ln2476">                  e.unknown();</a>
<a name="ln2477">            }</a>
<a name="ln2478">      if (!useText) {</a>
<a name="ln2479">            h-&gt;setBeginText(&quot;&quot;);</a>
<a name="ln2480">            h-&gt;setContinueText(&quot;&quot;);</a>
<a name="ln2481">            h-&gt;setEndText(&quot;&quot;);</a>
<a name="ln2482">            }</a>
<a name="ln2483">      adjustPlacement(h);</a>
<a name="ln2484">      }</a>
<a name="ln2485"> </a>
<a name="ln2486">//---------------------------------------------------------</a>
<a name="ln2487">//   readTrill206</a>
<a name="ln2488">//---------------------------------------------------------</a>
<a name="ln2489"> </a>
<a name="ln2490">void readTrill206(XmlReader&amp; e, Trill* t)</a>
<a name="ln2491">      {</a>
<a name="ln2492">      while (e.readNextStartElement()) {</a>
<a name="ln2493">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2494">            if (tag == &quot;subtype&quot;)</a>
<a name="ln2495">                  t-&gt;setTrillType(e.readElementText());</a>
<a name="ln2496">            else if (tag == &quot;Accidental&quot;) {</a>
<a name="ln2497">                  Accidental* _accidental = new Accidental(t-&gt;score());</a>
<a name="ln2498">                  readAccidental206(_accidental, e);</a>
<a name="ln2499">                  _accidental-&gt;setParent(t);</a>
<a name="ln2500">                  t-&gt;setAccidental(_accidental);</a>
<a name="ln2501">                  }</a>
<a name="ln2502">            else if (tag == &quot;ornamentStyle&quot;)</a>
<a name="ln2503">                  t-&gt;readProperty(e, Pid::ORNAMENT_STYLE);</a>
<a name="ln2504">            else if (tag == &quot;play&quot;)</a>
<a name="ln2505">                  t-&gt;setPlayArticulation(e.readBool());</a>
<a name="ln2506">            else if (!t-&gt;SLine::readProperties(e))</a>
<a name="ln2507">                  e.unknown();</a>
<a name="ln2508">            }</a>
<a name="ln2509">      adjustPlacement(t);</a>
<a name="ln2510">      }</a>
<a name="ln2511"> </a>
<a name="ln2512">//---------------------------------------------------------</a>
<a name="ln2513">//   readTextLine206</a>
<a name="ln2514">//---------------------------------------------------------</a>
<a name="ln2515"> </a>
<a name="ln2516">void readTextLine206(XmlReader&amp; e, TextLineBase* tlb)</a>
<a name="ln2517">      {</a>
<a name="ln2518">      while (e.readNextStartElement()) {</a>
<a name="ln2519">            if (!readTextLineProperties(e, tlb))</a>
<a name="ln2520">                  e.unknown();</a>
<a name="ln2521">            }</a>
<a name="ln2522">      adjustPlacement(tlb);</a>
<a name="ln2523">      }</a>
<a name="ln2524"> </a>
<a name="ln2525">//---------------------------------------------------------</a>
<a name="ln2526">//   setFermataPlacement</a>
<a name="ln2527">//    set fermata placement from old ArticulationAnchor</a>
<a name="ln2528">//    for backwards compatibility</a>
<a name="ln2529">//---------------------------------------------------------</a>
<a name="ln2530"> </a>
<a name="ln2531">static void setFermataPlacement(Element* el, ArticulationAnchor anchor, Direction direction)</a>
<a name="ln2532">      {</a>
<a name="ln2533">      if (direction == Direction::UP)</a>
<a name="ln2534">            el-&gt;setPlacement(Placement::ABOVE);</a>
<a name="ln2535">      else if (direction == Direction::DOWN)</a>
<a name="ln2536">            el-&gt;setPlacement(Placement::BELOW);</a>
<a name="ln2537">      else {</a>
<a name="ln2538">            switch (anchor) {</a>
<a name="ln2539">                  case ArticulationAnchor::TOP_STAFF:</a>
<a name="ln2540">                  case ArticulationAnchor::TOP_CHORD:</a>
<a name="ln2541">                        el-&gt;setPlacement(Placement::ABOVE);</a>
<a name="ln2542">                        break;</a>
<a name="ln2543"> </a>
<a name="ln2544">                  case ArticulationAnchor::BOTTOM_STAFF:</a>
<a name="ln2545">                  case ArticulationAnchor::BOTTOM_CHORD:</a>
<a name="ln2546">                        el-&gt;setPlacement(Placement::BELOW);</a>
<a name="ln2547">                        break;</a>
<a name="ln2548"> </a>
<a name="ln2549">                  case ArticulationAnchor::CHORD:</a>
<a name="ln2550">                        break;</a>
<a name="ln2551">                  default:</a>
<a name="ln2552">                        break;</a>
<a name="ln2553">                  }</a>
<a name="ln2554">            }</a>
<a name="ln2555">      }</a>
<a name="ln2556"> </a>
<a name="ln2557">//---------------------------------------------------------</a>
<a name="ln2558">//   readArticulation</a>
<a name="ln2559">//---------------------------------------------------------</a>
<a name="ln2560"> </a>
<a name="ln2561">Element* readArticulation(Element* parent, XmlReader&amp; e)</a>
<a name="ln2562">      {</a>
<a name="ln2563">      Element* el = 0;</a>
<a name="ln2564">      SymId sym = SymId::fermataAbove;          // default -- backward compatibility (no type = ufermata in 1.2)</a>
<a name="ln2565">      ArticulationAnchor anchor  = ArticulationAnchor::TOP_STAFF;</a>
<a name="ln2566">      Direction direction = Direction::AUTO;</a>
<a name="ln2567">      Score* score = parent-&gt;score();</a>
<a name="ln2568">      int track = parent-&gt;track();</a>
<a name="ln2569">      double timeStretch = 0.0;</a>
<a name="ln2570">      bool useDefaultPlacement = true;</a>
<a name="ln2571"> </a>
<a name="ln2572">      while (e.readNextStartElement()) {</a>
<a name="ln2573">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2574">            if (tag == &quot;subtype&quot;) {</a>
<a name="ln2575">                  QString s = e.readElementText();</a>
<a name="ln2576">                  if (s[0].isDigit()) {</a>
<a name="ln2577">                        int oldType = s.toInt();</a>
<a name="ln2578">                        sym = articulationNames[oldType].id;</a>
<a name="ln2579">                        }</a>
<a name="ln2580">                  else {</a>
<a name="ln2581">                        sym = oldArticulationNames2SymId(s);</a>
<a name="ln2582">                        if (sym == SymId::noSym) {</a>
<a name="ln2583">                              struct {</a>
<a name="ln2584">                                    const char* name;</a>
<a name="ln2585">                                    bool up;</a>
<a name="ln2586">                                    SymId id;</a>
<a name="ln2587">                                    } al[] =</a>
<a name="ln2588">                                    {</a>
<a name="ln2589">                                    { &quot;fadein&quot;,                    true,  SymId::guitarFadeIn },</a>
<a name="ln2590">                                    { &quot;fadeout&quot;,                   true,  SymId::guitarFadeOut },</a>
<a name="ln2591">                                    { &quot;volumeswell&quot;,               true,  SymId::guitarVolumeSwell },</a>
<a name="ln2592">                                    { &quot;wigglesawtooth&quot;,            true,  SymId::wiggleSawtooth },</a>
<a name="ln2593">                                    { &quot;wigglesawtoothwide&quot;,        true,  SymId::wiggleSawtoothWide },</a>
<a name="ln2594">                                    { &quot;wigglevibratolargefaster&quot;,  true,  SymId::wiggleVibratoLargeFaster },</a>
<a name="ln2595">                                    { &quot;wigglevibratolargeslowest&quot;, true,  SymId::wiggleVibratoLargeSlowest },</a>
<a name="ln2596">                                    { &quot;umarcato&quot;,                  true,  SymId::articMarcatoAbove },</a>
<a name="ln2597">                                    { &quot;dmarcato&quot;,                  false, SymId::articMarcatoBelow },</a>
<a name="ln2598">                                    { &quot;ufermata&quot;,                  true,  SymId::fermataAbove },</a>
<a name="ln2599">                                    { &quot;dfermata&quot;,                  false, SymId::fermataBelow },</a>
<a name="ln2600">                                    { &quot;ushortfermata&quot;,             true,  SymId::fermataShortAbove },</a>
<a name="ln2601">                                    { &quot;dshortfermata&quot;,             false, SymId::fermataShortBelow },</a>
<a name="ln2602">                                    { &quot;ulongfermata&quot;,              true,  SymId::fermataLongAbove },</a>
<a name="ln2603">                                    { &quot;dlongfermata&quot;,              false, SymId::fermataLongBelow },</a>
<a name="ln2604">                                    { &quot;uverylongfermata&quot;,          true,  SymId::fermataVeryLongAbove },</a>
<a name="ln2605">                                    { &quot;dverylongfermata&quot;,          false, SymId::fermataVeryLongBelow },</a>
<a name="ln2606"> </a>
<a name="ln2607">                                    // watch out, bug in 1.2 uportato and dportato are reversed</a>
<a name="ln2608">                                    { &quot;dportato&quot;,                  true,  SymId::articTenutoStaccatoAbove },</a>
<a name="ln2609">                                    { &quot;uportato&quot;,                  false, SymId::articTenutoStaccatoBelow },</a>
<a name="ln2610">                                    { &quot;ustaccatissimo&quot;,            true,  SymId::articStaccatissimoAbove },</a>
<a name="ln2611">                                    { &quot;dstaccatissimo&quot;,            false, SymId::articStaccatissimoBelow }</a>
<a name="ln2612">                                    };</a>
<a name="ln2613">                              int i;</a>
<a name="ln2614">                              int n = sizeof(al) / sizeof(*al);</a>
<a name="ln2615">                              for (i = 0; i &lt; n; ++i) {</a>
<a name="ln2616">                                    if (s == al[i].name) {</a>
<a name="ln2617">                                          sym       = al[i].id;</a>
<a name="ln2618">                                          bool up   = al[i].up;</a>
<a name="ln2619">                                          direction = up ? Direction::UP : Direction::DOWN;</a>
<a name="ln2620">                                          if ((direction == Direction::DOWN) != (track &amp; 1))</a>
<a name="ln2621">                                                useDefaultPlacement = false;</a>
<a name="ln2622">                                          break;</a>
<a name="ln2623">                                          }</a>
<a name="ln2624">                                    }</a>
<a name="ln2625">                              if (i == n) {</a>
<a name="ln2626">                                    sym = Sym::name2id(s);</a>
<a name="ln2627">                                    if (sym == SymId::noSym)</a>
<a name="ln2628">                                          qDebug(&quot;Articulation: unknown type &lt;%s&gt;&quot;, qPrintable(s));</a>
<a name="ln2629">                                    }</a>
<a name="ln2630">                              }</a>
<a name="ln2631">                        }</a>
<a name="ln2632">                  switch (sym) {</a>
<a name="ln2633">                        case SymId::fermataAbove:</a>
<a name="ln2634">                        case SymId::fermataBelow:</a>
<a name="ln2635">                        case SymId::fermataShortAbove:</a>
<a name="ln2636">                        case SymId::fermataShortBelow:</a>
<a name="ln2637">                        case SymId::fermataLongAbove:</a>
<a name="ln2638">                        case SymId::fermataLongBelow:</a>
<a name="ln2639">                        case SymId::fermataVeryLongAbove:</a>
<a name="ln2640">                        case SymId::fermataVeryLongBelow:</a>
<a name="ln2641">                              el = new Fermata(sym, score);</a>
<a name="ln2642">                              break;</a>
<a name="ln2643">                        default:</a>
<a name="ln2644">                              el = new Articulation(sym, score);</a>
<a name="ln2645">                              toArticulation(el)-&gt;setDirection(direction);</a>
<a name="ln2646">                              break;</a>
<a name="ln2647">                        };</a>
<a name="ln2648">                  }</a>
<a name="ln2649">            else if (tag == &quot;anchor&quot;) {</a>
<a name="ln2650">                  useDefaultPlacement = false;</a>
<a name="ln2651">                  if (!el || el-&gt;isFermata())</a>
<a name="ln2652">                        anchor = ArticulationAnchor(e.readInt());</a>
<a name="ln2653">                  else</a>
<a name="ln2654">                        el-&gt;readProperties(e);</a>
<a name="ln2655">                  }</a>
<a name="ln2656">            else  if (tag == &quot;direction&quot;) {</a>
<a name="ln2657">                  useDefaultPlacement = false;</a>
<a name="ln2658">                  if (!el || el-&gt;isFermata())</a>
<a name="ln2659">                        direction = toDirection(e.readElementText());</a>
<a name="ln2660">                  else</a>
<a name="ln2661">                        el-&gt;readProperties(e);</a>
<a name="ln2662">                  }</a>
<a name="ln2663">            else if (tag == &quot;timeStretch&quot;) {</a>
<a name="ln2664">                  timeStretch = e.readDouble();</a>
<a name="ln2665">                  }</a>
<a name="ln2666">            else {</a>
<a name="ln2667">                  if (!el) {</a>
<a name="ln2668">                        qDebug(&quot;not handled &lt;%s&gt;&quot;, qPrintable(tag.toString()));</a>
<a name="ln2669">                        }</a>
<a name="ln2670">                  if (!el || !el-&gt;readProperties(e))</a>
<a name="ln2671">                        e.unknown();</a>
<a name="ln2672">                  }</a>
<a name="ln2673">            }</a>
<a name="ln2674">      // Special case for &quot;no type&quot; = ufermata, with missing subtype tag</a>
<a name="ln2675">      if (!el)</a>
<a name="ln2676">            el = new Fermata(sym, score);</a>
<a name="ln2677">      if (el-&gt;isFermata()) {</a>
<a name="ln2678">            if (timeStretch != 0.0)</a>
<a name="ln2679">                  el-&gt;setProperty(Pid::TIME_STRETCH, timeStretch);</a>
<a name="ln2680">            if (useDefaultPlacement)</a>
<a name="ln2681">                  el-&gt;setPlacement(track &amp; 1 ? Placement::BELOW : Placement::ABOVE);</a>
<a name="ln2682">            else</a>
<a name="ln2683">                  setFermataPlacement(el, anchor, direction);</a>
<a name="ln2684">            }</a>
<a name="ln2685">      el-&gt;setTrack(track);</a>
<a name="ln2686">      return el;</a>
<a name="ln2687">      }</a>
<a name="ln2688"> </a>
<a name="ln2689">//---------------------------------------------------------</a>
<a name="ln2690">//   readSlurTieProperties</a>
<a name="ln2691">//---------------------------------------------------------</a>
<a name="ln2692"> </a>
<a name="ln2693">static bool readSlurTieProperties(XmlReader&amp; e, SlurTie* st)</a>
<a name="ln2694">      {</a>
<a name="ln2695">      const QStringRef&amp; tag(e.name());</a>
<a name="ln2696"> </a>
<a name="ln2697">      if (st-&gt;readProperty(tag, e, Pid::SLUR_DIRECTION))</a>
<a name="ln2698">            ;</a>
<a name="ln2699">      else if (tag == &quot;lineType&quot;)</a>
<a name="ln2700">            st-&gt;setLineType(e.readInt());</a>
<a name="ln2701">      else if (tag == &quot;SlurSegment&quot;) {</a>
<a name="ln2702">            SlurTieSegment* s = st-&gt;newSlurTieSegment();</a>
<a name="ln2703">            s-&gt;read(e);</a>
<a name="ln2704">            st-&gt;add(s);</a>
<a name="ln2705">            }</a>
<a name="ln2706">      else if (!st-&gt;Element::readProperties(e))</a>
<a name="ln2707">            return false;</a>
<a name="ln2708">      return true;</a>
<a name="ln2709">      }</a>
<a name="ln2710"> </a>
<a name="ln2711">//---------------------------------------------------------</a>
<a name="ln2712">//   readSlur206</a>
<a name="ln2713">//---------------------------------------------------------</a>
<a name="ln2714"> </a>
<a name="ln2715">void readSlur206(XmlReader&amp; e, Slur* s)</a>
<a name="ln2716">      {</a>
<a name="ln2717">      s-&gt;setTrack(e.track());      // set staff</a>
<a name="ln2718">      e.addSpanner(e.intAttribute(&quot;id&quot;), s);</a>
<a name="ln2719">      while (e.readNextStartElement()) {</a>
<a name="ln2720">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2721">            if (tag == &quot;track2&quot;)</a>
<a name="ln2722">                  s-&gt;setTrack2(e.readInt());</a>
<a name="ln2723">            else if (tag == &quot;startTrack&quot;)       // obsolete</a>
<a name="ln2724">                  s-&gt;setTrack(e.readInt());</a>
<a name="ln2725">            else if (tag == &quot;endTrack&quot;)         // obsolete</a>
<a name="ln2726">                  e.readInt();</a>
<a name="ln2727">            else if (!readSlurTieProperties(e, s))</a>
<a name="ln2728">                  e.unknown();</a>
<a name="ln2729">            }</a>
<a name="ln2730">      if (s-&gt;track2() == -1)</a>
<a name="ln2731">            s-&gt;setTrack2(s-&gt;track());</a>
<a name="ln2732">      }</a>
<a name="ln2733"> </a>
<a name="ln2734">//---------------------------------------------------------</a>
<a name="ln2735">//   readTie206</a>
<a name="ln2736">//---------------------------------------------------------</a>
<a name="ln2737"> </a>
<a name="ln2738">void readTie206(XmlReader&amp; e, Tie* t)</a>
<a name="ln2739">      {</a>
<a name="ln2740">      e.addSpanner(e.intAttribute(&quot;id&quot;), t);</a>
<a name="ln2741">      while (e.readNextStartElement()) {</a>
<a name="ln2742">            if (readSlurTieProperties(e, t))</a>
<a name="ln2743">                  ;</a>
<a name="ln2744">            else</a>
<a name="ln2745">                  e.unknown();</a>
<a name="ln2746">            }</a>
<a name="ln2747">      if (t-&gt;score()-&gt;mscVersion() &lt;= 114 &amp;&amp; t-&gt;spannerSegments().size() == 1) {</a>
<a name="ln2748">            // ignore manual adjustments to single-segment ties in older scores</a>
<a name="ln2749">            TieSegment* ss = t-&gt;frontSegment();</a>
<a name="ln2750">            QPointF zeroP;</a>
<a name="ln2751">            ss-&gt;ups(Grip::START).off     = zeroP;</a>
<a name="ln2752">            ss-&gt;ups(Grip::BEZIER1).off   = zeroP;</a>
<a name="ln2753">            ss-&gt;ups(Grip::BEZIER2).off   = zeroP;</a>
<a name="ln2754">            ss-&gt;ups(Grip::END).off       = zeroP;</a>
<a name="ln2755">            ss-&gt;setOffset(zeroP);</a>
<a name="ln2756">            ss-&gt;setUserOff2(zeroP);</a>
<a name="ln2757">            }</a>
<a name="ln2758">      }</a>
<a name="ln2759"> </a>
<a name="ln2760">//---------------------------------------------------------</a>
<a name="ln2761">//   readMeasure</a>
<a name="ln2762">//---------------------------------------------------------</a>
<a name="ln2763"> </a>
<a name="ln2764">static void readMeasure(Measure* m, int staffIdx, XmlReader&amp; e)</a>
<a name="ln2765">      {</a>
<a name="ln2766">      Segment* segment = 0;</a>
<a name="ln2767">      qreal _spatium = m-&gt;spatium();</a>
<a name="ln2768">      Score* score = m-&gt;score();</a>
<a name="ln2769"> </a>
<a name="ln2770">      QList&lt;Chord*&gt; graceNotes;</a>
<a name="ln2771">      e.tuplets().clear();</a>
<a name="ln2772">      e.setTrack(staffIdx * VOICES);</a>
<a name="ln2773"> </a>
<a name="ln2774">      m-&gt;createStaves(staffIdx);</a>
<a name="ln2775"> </a>
<a name="ln2776">      // tick is obsolete</a>
<a name="ln2777">      if (e.hasAttribute(&quot;tick&quot;))</a>
<a name="ln2778">            e.setTick(Fraction::fromTicks(score-&gt;fileDivision(e.intAttribute(&quot;tick&quot;))));</a>
<a name="ln2779"> </a>
<a name="ln2780">      bool irregular;</a>
<a name="ln2781">      if (e.hasAttribute(&quot;len&quot;)) {</a>
<a name="ln2782">            QStringList sl = e.attribute(&quot;len&quot;).split('/');</a>
<a name="ln2783">            if (sl.size() == 2)</a>
<a name="ln2784">                  m-&gt;setTicks(Fraction(sl[0].toInt(), sl[1].toInt()));</a>
<a name="ln2785">            else</a>
<a name="ln2786">                  qDebug(&quot;illegal measure size &lt;%s&gt;&quot;, qPrintable(e.attribute(&quot;len&quot;)));</a>
<a name="ln2787">            irregular = true;</a>
<a name="ln2788">            score-&gt;sigmap()-&gt;add(m-&gt;tick().ticks(), SigEvent(m-&gt;ticks(), m-&gt;timesig()));</a>
<a name="ln2789">            score-&gt;sigmap()-&gt;add(m-&gt;endTick().ticks(), SigEvent(m-&gt;timesig()));</a>
<a name="ln2790">            }</a>
<a name="ln2791">      else</a>
<a name="ln2792">            irregular = false;</a>
<a name="ln2793"> </a>
<a name="ln2794">      Staff* staff = score-&gt;staff(staffIdx);</a>
<a name="ln2795">      Fraction timeStretch(staff-&gt;timeStretch(m-&gt;tick()));</a>
<a name="ln2796"> </a>
<a name="ln2797">      // keep track of tick of previous element</a>
<a name="ln2798">      // this allows markings that need to apply to previous element to do so</a>
<a name="ln2799">      // even though we may have already advanced to next tick position</a>
<a name="ln2800">      Fraction lastTick = e.tick();</a>
<a name="ln2801"> </a>
<a name="ln2802">      while (e.readNextStartElement()) {</a>
<a name="ln2803">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2804"> </a>
<a name="ln2805">            if (tag == &quot;move&quot;)</a>
<a name="ln2806">                  e.setTick(e.readFraction() + m-&gt;tick());</a>
<a name="ln2807">            else if (tag == &quot;tick&quot;) {</a>
<a name="ln2808">                  e.setTick(Fraction::fromTicks(score-&gt;fileDivision(e.readInt())));</a>
<a name="ln2809">                  lastTick = e.tick();</a>
<a name="ln2810">                  }</a>
<a name="ln2811">            else if (tag == &quot;BarLine&quot;) {</a>
<a name="ln2812">                  Fermata* fermataAbove = nullptr;</a>
<a name="ln2813">                  Fermata* fermataBelow = nullptr;</a>
<a name="ln2814">                  BarLine* bl = new BarLine(score);</a>
<a name="ln2815">                  bl-&gt;setTrack(e.track());</a>
<a name="ln2816">                  while (e.readNextStartElement()) {</a>
<a name="ln2817">                        const QStringRef&amp; t(e.name());</a>
<a name="ln2818">                        if (t == &quot;subtype&quot;)</a>
<a name="ln2819">                              bl-&gt;setBarLineType(e.readElementText());</a>
<a name="ln2820">                        else if (t == &quot;customSubtype&quot;)                      // obsolete</a>
<a name="ln2821">                              e.readInt();</a>
<a name="ln2822">                        else if (t == &quot;span&quot;) {</a>
<a name="ln2823">                              //TODO bl-&gt;setSpanFrom(e.intAttribute(&quot;from&quot;, bl-&gt;spanFrom()));  // obsolete</a>
<a name="ln2824">                              // bl-&gt;setSpanTo(e.intAttribute(&quot;to&quot;, bl-&gt;spanTo()));            // obsolete</a>
<a name="ln2825">                              int span = e.readInt();</a>
<a name="ln2826">                              if (span)</a>
<a name="ln2827">                                    span--;</a>
<a name="ln2828">                              bl-&gt;setSpanStaff(span);</a>
<a name="ln2829">                              }</a>
<a name="ln2830">                        else if (t == &quot;spanFromOffset&quot;)</a>
<a name="ln2831">                              bl-&gt;setSpanFrom(e.readInt());</a>
<a name="ln2832">                        else if (t == &quot;spanToOffset&quot;)</a>
<a name="ln2833">                              bl-&gt;setSpanTo(e.readInt());</a>
<a name="ln2834">                        else if (t == &quot;Articulation&quot;) {</a>
<a name="ln2835">                              Element* el = readArticulation(bl, e);</a>
<a name="ln2836">                              if (el-&gt;isFermata()) {</a>
<a name="ln2837">                                    if (el-&gt;placement() == Placement::ABOVE)</a>
<a name="ln2838">                                          fermataAbove = toFermata(el);</a>
<a name="ln2839">                                    else {</a>
<a name="ln2840">                                          fermataBelow = toFermata(el);</a>
<a name="ln2841">                                          fermataBelow-&gt;setTrack((bl-&gt;staffIdx() + bl-&gt;spanStaff()) * VOICES);</a>
<a name="ln2842">                                          }</a>
<a name="ln2843">                                    }</a>
<a name="ln2844">                              else</a>
<a name="ln2845">                                    bl-&gt;add(el);</a>
<a name="ln2846">                              }</a>
<a name="ln2847">                        else if (!bl-&gt;Element::readProperties(e))</a>
<a name="ln2848">                              e.unknown();</a>
<a name="ln2849">                        }</a>
<a name="ln2850">                  //</a>
<a name="ln2851">                  //  StartRepeatBarLine: always at the beginning tick of a measure, always BarLineType::START_REPEAT</a>
<a name="ln2852">                  //  BarLine:            in the middle of a measure, has no semantic</a>
<a name="ln2853">                  //  EndBarLine:         at the end tick of a measure</a>
<a name="ln2854">                  //  BeginBarLine:       first segment of a measure</a>
<a name="ln2855"> </a>
<a name="ln2856">                  SegmentType st;</a>
<a name="ln2857">                  if ((e.tick() != m-&gt;tick()) &amp;&amp; (e.tick() != m-&gt;endTick()))</a>
<a name="ln2858">                        st = SegmentType::BarLine;</a>
<a name="ln2859">                  else if (bl-&gt;barLineType() == BarLineType::START_REPEAT &amp;&amp; e.tick() == m-&gt;tick())</a>
<a name="ln2860">                        st = SegmentType::StartRepeatBarLine;</a>
<a name="ln2861">                  else if (e.tick() == m-&gt;tick() &amp;&amp; segment == 0)</a>
<a name="ln2862">                        st = SegmentType::BeginBarLine;</a>
<a name="ln2863">                  else</a>
<a name="ln2864">                        st = SegmentType::EndBarLine;</a>
<a name="ln2865">                  segment = m-&gt;getSegment(st, e.tick());</a>
<a name="ln2866">                  segment-&gt;add(bl);</a>
<a name="ln2867">                  bl-&gt;layout();</a>
<a name="ln2868">                  if (fermataAbove)</a>
<a name="ln2869">                        segment-&gt;add(fermataAbove);</a>
<a name="ln2870">                  if (fermataBelow)</a>
<a name="ln2871">                        segment-&gt;add(fermataBelow);</a>
<a name="ln2872">                  }</a>
<a name="ln2873">            else if (tag == &quot;Chord&quot;) {</a>
<a name="ln2874">                  Chord* chord = new Chord(score);</a>
<a name="ln2875">                  chord-&gt;setTrack(e.track());</a>
<a name="ln2876">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln2877">                  chord-&gt;setParent(segment);</a>
<a name="ln2878">                  readChord(chord, e);</a>
<a name="ln2879">                  if (chord-&gt;noteType() != NoteType::NORMAL)</a>
<a name="ln2880">                        graceNotes.push_back(chord);</a>
<a name="ln2881">                  else {</a>
<a name="ln2882">                        segment-&gt;add(chord);</a>
<a name="ln2883">                        for (int i = 0; i &lt; graceNotes.size(); ++i) {</a>
<a name="ln2884">                              Chord* gc = graceNotes[i];</a>
<a name="ln2885">                              gc-&gt;setGraceIndex(i);</a>
<a name="ln2886">                              chord-&gt;add(gc);</a>
<a name="ln2887">                              }</a>
<a name="ln2888">                        graceNotes.clear();</a>
<a name="ln2889">                        Fraction crticks = chord-&gt;actualTicks();</a>
<a name="ln2890">                        lastTick         = e.tick();</a>
<a name="ln2891">                        e.incTick(crticks);</a>
<a name="ln2892">                        }</a>
<a name="ln2893">                  }</a>
<a name="ln2894">            else if (tag == &quot;Rest&quot;) {</a>
<a name="ln2895">                  Rest* rest = new Rest(score);</a>
<a name="ln2896">                  rest-&gt;setDurationType(TDuration::DurationType::V_MEASURE);</a>
<a name="ln2897">                  rest-&gt;setTicks(m-&gt;timesig()/timeStretch);</a>
<a name="ln2898">                  rest-&gt;setTrack(e.track());</a>
<a name="ln2899">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln2900">                  rest-&gt;setParent(segment);</a>
<a name="ln2901">                  readRest(rest, e);</a>
<a name="ln2902">                  segment-&gt;add(rest);</a>
<a name="ln2903"> </a>
<a name="ln2904">                  if (!rest-&gt;ticks().isValid())     // hack</a>
<a name="ln2905">                        rest-&gt;setTicks(m-&gt;timesig()/timeStretch);</a>
<a name="ln2906"> </a>
<a name="ln2907">                  lastTick = e.tick();</a>
<a name="ln2908">                  e.incTick(rest-&gt;actualTicks());</a>
<a name="ln2909">                  }</a>
<a name="ln2910">            else if (tag == &quot;Breath&quot;) {</a>
<a name="ln2911">                  Breath* breath = new Breath(score);</a>
<a name="ln2912">                  breath-&gt;setTrack(e.track());</a>
<a name="ln2913">                  Fraction tick = e.tick();</a>
<a name="ln2914">                  breath-&gt;read(e);</a>
<a name="ln2915">                  // older scores placed the breath segment right after the chord to which it applies</a>
<a name="ln2916">                  // rather than before the next chordrest segment with an element for the staff</a>
<a name="ln2917">                  // result would be layout too far left if there are other segments due to notes in other staves</a>
<a name="ln2918">                  // we need to find tick of chord to which this applies, and add its duration</a>
<a name="ln2919">                  Fraction prevTick;</a>
<a name="ln2920">                  if (e.tick() &lt; tick)</a>
<a name="ln2921">                        prevTick = e.tick();    // use our own tick if we explicitly reset to earlier position</a>
<a name="ln2922">                  else</a>
<a name="ln2923">                        prevTick = lastTick;    // otherwise use tick of previous tick/chord/rest tag</a>
<a name="ln2924">                  // find segment</a>
<a name="ln2925">                  Segment* prev = m-&gt;findSegment(SegmentType::ChordRest, prevTick);</a>
<a name="ln2926">                  if (prev) {</a>
<a name="ln2927">                        // find chordrest</a>
<a name="ln2928">                        ChordRest* lastCR = toChordRest(prev-&gt;element(e.track()));</a>
<a name="ln2929">                        if (lastCR)</a>
<a name="ln2930">                              tick = prevTick + lastCR-&gt;actualTicks();</a>
<a name="ln2931">                        }</a>
<a name="ln2932">                  segment = m-&gt;getSegment(SegmentType::Breath, tick);</a>
<a name="ln2933">                  segment-&gt;add(breath);</a>
<a name="ln2934">                  }</a>
<a name="ln2935">            else if (tag == &quot;endSpanner&quot;) {</a>
<a name="ln2936">                  int id = e.attribute(&quot;id&quot;).toInt();</a>
<a name="ln2937">                  Spanner* spanner = e.findSpanner(id);</a>
<a name="ln2938">                  if (spanner) {</a>
<a name="ln2939">                        spanner-&gt;setTicks(e.tick() - spanner-&gt;tick());</a>
<a name="ln2940">                        // if (spanner-&gt;track2() == -1)</a>
<a name="ln2941">                              // the absence of a track tag [?] means the</a>
<a name="ln2942">                              // track is the same as the beginning of the slur</a>
<a name="ln2943">                        if (spanner-&gt;track2() == -1)</a>
<a name="ln2944">                              spanner-&gt;setTrack2(spanner-&gt;track() ? spanner-&gt;track() : e.track());</a>
<a name="ln2945">                        }</a>
<a name="ln2946">                  else {</a>
<a name="ln2947">                        // remember &quot;endSpanner&quot; values</a>
<a name="ln2948">                        SpannerValues sv;</a>
<a name="ln2949">                        sv.spannerId = id;</a>
<a name="ln2950">                        sv.track2    = e.track();</a>
<a name="ln2951">                        sv.tick2     = e.tick();</a>
<a name="ln2952">                        e.addSpannerValues(sv);</a>
<a name="ln2953">                        }</a>
<a name="ln2954">                  e.readNext();</a>
<a name="ln2955">                  }</a>
<a name="ln2956">            else if (tag == &quot;Slur&quot;) {</a>
<a name="ln2957">                  Slur *sl = new Slur(score);</a>
<a name="ln2958">                  sl-&gt;setTick(e.tick());</a>
<a name="ln2959">                  readSlur206(e, sl);</a>
<a name="ln2960">                  //</a>
<a name="ln2961">                  // check if we already saw &quot;endSpanner&quot;</a>
<a name="ln2962">                  //</a>
<a name="ln2963">                  int id = e.spannerId(sl);</a>
<a name="ln2964">                  const SpannerValues* sv = e.spannerValues(id);</a>
<a name="ln2965">                  if (sv) {</a>
<a name="ln2966">                        sl-&gt;setTick2(sv-&gt;tick2);</a>
<a name="ln2967">                        sl-&gt;setTrack2(sv-&gt;track2);</a>
<a name="ln2968">                        }</a>
<a name="ln2969">                  score-&gt;addSpanner(sl);</a>
<a name="ln2970">                  }</a>
<a name="ln2971">            else if (tag == &quot;HairPin&quot;</a>
<a name="ln2972">               || tag == &quot;Pedal&quot;</a>
<a name="ln2973">               || tag == &quot;Ottava&quot;</a>
<a name="ln2974">               || tag == &quot;Trill&quot;</a>
<a name="ln2975">               || tag == &quot;TextLine&quot;</a>
<a name="ln2976">               || tag == &quot;Volta&quot;) {</a>
<a name="ln2977">                  Spanner* sp = toSpanner(Element::name2Element(tag, score));</a>
<a name="ln2978">                  sp-&gt;setTrack(e.track());</a>
<a name="ln2979">                  sp-&gt;setTick(e.tick());</a>
<a name="ln2980">                  sp-&gt;eraseSpannerSegments();</a>
<a name="ln2981">                  e.addSpanner(e.intAttribute(&quot;id&quot;, -1), sp);</a>
<a name="ln2982"> </a>
<a name="ln2983">                  if (tag == &quot;Volta&quot;)</a>
<a name="ln2984">                        readVolta206(e, toVolta(sp));</a>
<a name="ln2985">                  else if (tag == &quot;Pedal&quot;)</a>
<a name="ln2986">                        readPedal(e, toPedal(sp));</a>
<a name="ln2987">                  else if (tag == &quot;Ottava&quot;)</a>
<a name="ln2988">                        readOttava(e, toOttava(sp));</a>
<a name="ln2989">                  else if (tag == &quot;HairPin&quot;)</a>
<a name="ln2990">                        readHairpin206(e, toHairpin(sp));</a>
<a name="ln2991">                  else if (tag == &quot;Trill&quot;)</a>
<a name="ln2992">                        readTrill206(e, toTrill(sp));</a>
<a name="ln2993">                  else</a>
<a name="ln2994">                        readTextLine206(e, toTextLineBase(sp));</a>
<a name="ln2995">                  score-&gt;addSpanner(sp);</a>
<a name="ln2996">                  //</a>
<a name="ln2997">                  // check if we already saw &quot;endSpanner&quot;</a>
<a name="ln2998">                  //</a>
<a name="ln2999">                  int id = e.spannerId(sp);</a>
<a name="ln3000">                  const SpannerValues* sv = e.spannerValues(id);</a>
<a name="ln3001">                  if (sv) {</a>
<a name="ln3002">                        sp-&gt;setTicks(sv-&gt;tick2 - sp-&gt;tick());</a>
<a name="ln3003">                        sp-&gt;setTrack2(sv-&gt;track2);</a>
<a name="ln3004">                        }</a>
<a name="ln3005">                  }</a>
<a name="ln3006">            else if (tag == &quot;RepeatMeasure&quot;) {</a>
<a name="ln3007">                  RepeatMeasure* rm = new RepeatMeasure(score);</a>
<a name="ln3008">                  rm-&gt;setTrack(e.track());</a>
<a name="ln3009">                  readRest(rm, e);</a>
<a name="ln3010">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln3011">                  segment-&gt;add(rm);</a>
<a name="ln3012">                  lastTick = e.tick();</a>
<a name="ln3013">                  e.incTick(m-&gt;ticks());</a>
<a name="ln3014">                  }</a>
<a name="ln3015">            else if (tag == &quot;Clef&quot;) {</a>
<a name="ln3016">                  Clef* clef = new Clef(score);</a>
<a name="ln3017">                  clef-&gt;setTrack(e.track());</a>
<a name="ln3018">                  clef-&gt;read(e);</a>
<a name="ln3019">                  clef-&gt;setGenerated(false);</a>
<a name="ln3020">                  if (e.tick().isZero()) {</a>
<a name="ln3021">                        if (score-&gt;staff(staffIdx)-&gt;clef(Fraction(0,1)) != clef-&gt;clefType())</a>
<a name="ln3022">                              score-&gt;staff(staffIdx)-&gt;setDefaultClefType(clef-&gt;clefType());</a>
<a name="ln3023">                        if (clef-&gt;links() &amp;&amp; clef-&gt;links()-&gt;size() == 1) {</a>
<a name="ln3024">                              e.linkIds().remove(clef-&gt;links()-&gt;lid());</a>
<a name="ln3025">                              qDebug(&quot;remove link %d&quot;, clef-&gt;links()-&gt;lid());</a>
<a name="ln3026">                              }</a>
<a name="ln3027">                        delete clef;</a>
<a name="ln3028">                        continue;</a>
<a name="ln3029">                        }</a>
<a name="ln3030">                  // there may be more than one clef segment for same tick position</a>
<a name="ln3031">                  if (!segment) {</a>
<a name="ln3032">                        // this is the first segment of measure</a>
<a name="ln3033">                        segment = m-&gt;getSegment(SegmentType::Clef, e.tick());</a>
<a name="ln3034">                        }</a>
<a name="ln3035">                  else {</a>
<a name="ln3036">                        bool firstSegment = false;</a>
<a name="ln3037">                        // the first clef may be missing and is added later in layout</a>
<a name="ln3038">                        for (Segment* s = m-&gt;segments().first(); s &amp;&amp; s-&gt;tick() == e.tick(); s = s-&gt;next()) {</a>
<a name="ln3039">                              if (s-&gt;segmentType() == SegmentType::Clef</a>
<a name="ln3040">                                    // hack: there may be other segment types which should</a>
<a name="ln3041">                                    // generate a clef at current position</a>
<a name="ln3042">                                 || s-&gt;segmentType() == SegmentType::StartRepeatBarLine</a>
<a name="ln3043">                                 ) {</a>
<a name="ln3044">                                    firstSegment = true;</a>
<a name="ln3045">                                    break;</a>
<a name="ln3046">                                    }</a>
<a name="ln3047">                              }</a>
<a name="ln3048">                        if (firstSegment) {</a>
<a name="ln3049">                              Segment* ns = 0;</a>
<a name="ln3050">                              if (segment-&gt;next()) {</a>
<a name="ln3051">                                    ns = segment-&gt;next();</a>
<a name="ln3052">                                    while (ns &amp;&amp; ns-&gt;tick() &lt; e.tick())</a>
<a name="ln3053">                                          ns = ns-&gt;next();</a>
<a name="ln3054">                                    }</a>
<a name="ln3055">                              segment = 0;</a>
<a name="ln3056">                              for (Segment* s = ns; s &amp;&amp; s-&gt;tick() == e.tick(); s = s-&gt;next()) {</a>
<a name="ln3057">                                    if (s-&gt;segmentType() == SegmentType::Clef) {</a>
<a name="ln3058">                                          segment = s;</a>
<a name="ln3059">                                          break;</a>
<a name="ln3060">                                          }</a>
<a name="ln3061">                                    }</a>
<a name="ln3062">                              if (!segment) {</a>
<a name="ln3063">                                    segment = new Segment(m, SegmentType::Clef, e.tick() - m-&gt;tick());</a>
<a name="ln3064">                                    m-&gt;segments().insert(segment, ns);</a>
<a name="ln3065">                                    }</a>
<a name="ln3066">                              }</a>
<a name="ln3067">                        else {</a>
<a name="ln3068">                              // this is the first clef: move to left</a>
<a name="ln3069">                              segment = m-&gt;getSegment(SegmentType::Clef, e.tick());</a>
<a name="ln3070">                              }</a>
<a name="ln3071">                        }</a>
<a name="ln3072">                  if (e.tick() != m-&gt;tick())</a>
<a name="ln3073">                        clef-&gt;setSmall(true);         // TODO: layout does this ?</a>
<a name="ln3074">                  segment-&gt;add(clef);</a>
<a name="ln3075">                  }</a>
<a name="ln3076">            else if (tag == &quot;TimeSig&quot;) {</a>
<a name="ln3077">                  TimeSig* ts = new TimeSig(score);</a>
<a name="ln3078">                  ts-&gt;setTrack(e.track());</a>
<a name="ln3079">                  ts-&gt;read(e);</a>
<a name="ln3080">                  // if time sig not at beginning of measure =&gt; courtesy time sig</a>
<a name="ln3081">                  Fraction currTick = e.tick();</a>
<a name="ln3082">                  bool courtesySig = (currTick &gt; m-&gt;tick());</a>
<a name="ln3083">                  if (courtesySig) {</a>
<a name="ln3084">                        // if courtesy sig., just add it without map processing</a>
<a name="ln3085">                        segment = m-&gt;getSegment(SegmentType::TimeSigAnnounce, currTick);</a>
<a name="ln3086">                        segment-&gt;add(ts);</a>
<a name="ln3087">                        }</a>
<a name="ln3088">                  else {</a>
<a name="ln3089">                        // if 'real' time sig., do full process</a>
<a name="ln3090">                        segment = m-&gt;getSegment(SegmentType::TimeSig, currTick);</a>
<a name="ln3091">                        segment-&gt;add(ts);</a>
<a name="ln3092"> </a>
<a name="ln3093">                        timeStretch = ts-&gt;stretch().reduced();</a>
<a name="ln3094">                        m-&gt;setTimesig(ts-&gt;sig() / timeStretch);</a>
<a name="ln3095"> </a>
<a name="ln3096">                        if (irregular) {</a>
<a name="ln3097">                              score-&gt;sigmap()-&gt;add(m-&gt;tick().ticks(), SigEvent(m-&gt;ticks(), m-&gt;timesig()));</a>
<a name="ln3098">                              score-&gt;sigmap()-&gt;add(m-&gt;endTick().ticks(), SigEvent(m-&gt;timesig()));</a>
<a name="ln3099">                              }</a>
<a name="ln3100">                        else {</a>
<a name="ln3101">                              m-&gt;setTicks(m-&gt;timesig());</a>
<a name="ln3102">                              score-&gt;sigmap()-&gt;add(m-&gt;tick().ticks(), SigEvent(m-&gt;timesig()));</a>
<a name="ln3103">                              }</a>
<a name="ln3104">                        }</a>
<a name="ln3105">                  }</a>
<a name="ln3106">            else if (tag == &quot;KeySig&quot;) {</a>
<a name="ln3107">                  KeySig* ks = new KeySig(score);</a>
<a name="ln3108">                  ks-&gt;setTrack(e.track());</a>
<a name="ln3109">                  ks-&gt;read(e);</a>
<a name="ln3110">                  Fraction curTick = e.tick();</a>
<a name="ln3111">                  if (!ks-&gt;isCustom() &amp;&amp; !ks-&gt;isAtonal() &amp;&amp; ks-&gt;key() == Key::C &amp;&amp; curTick.isZero()) {</a>
<a name="ln3112">                        // ignore empty key signature</a>
<a name="ln3113">                        qDebug(&quot;remove keysig c at tick 0&quot;);</a>
<a name="ln3114">                        if (ks-&gt;links()) {</a>
<a name="ln3115">                              if (ks-&gt;links()-&gt;size() == 1)</a>
<a name="ln3116">                                    e.linkIds().remove(ks-&gt;links()-&gt;lid());</a>
<a name="ln3117">                              }</a>
<a name="ln3118">                        delete ks;</a>
<a name="ln3119">                        }</a>
<a name="ln3120">                  else {</a>
<a name="ln3121">                        // if key sig not at beginning of measure =&gt; courtesy key sig</a>
<a name="ln3122">                        bool courtesySig = (curTick == m-&gt;endTick());</a>
<a name="ln3123">                        segment = m-&gt;getSegment(courtesySig ? SegmentType::KeySigAnnounce : SegmentType::KeySig, curTick);</a>
<a name="ln3124">                        segment-&gt;add(ks);</a>
<a name="ln3125">                        if (!courtesySig)</a>
<a name="ln3126">                              staff-&gt;setKey(curTick, ks-&gt;keySigEvent());</a>
<a name="ln3127">                        }</a>
<a name="ln3128">                  }</a>
<a name="ln3129">            else if (tag == &quot;Text&quot; || tag == &quot;StaffText&quot;) {</a>
<a name="ln3130">                  // MuseScore 3 has different types for system text and</a>
<a name="ln3131">                  // staff text while MuseScore 2 didn't.</a>
<a name="ln3132">                  // We need to decide first which one we should create.</a>
<a name="ln3133">                  QString styleName;</a>
<a name="ln3134">                  if (e.readAheadAvailable()) {</a>
<a name="ln3135">                        e.performReadAhead([&amp;styleName, tag](QIODevice&amp; dev) {</a>
<a name="ln3136">                              const QString closeTag = QString(&quot;&lt;/&quot;).append(tag).append(&quot;&gt;&quot;);</a>
<a name="ln3137">                              QByteArray arrLine = dev.readLine();</a>
<a name="ln3138">                              while (!arrLine.isEmpty()) {</a>
<a name="ln3139">                                    QString line(arrLine);</a>
<a name="ln3140">                                    if (line.contains(&quot;&lt;style&gt;&quot;)) {</a>
<a name="ln3141">                                          QRegExp re(&quot;&lt;style&gt;([A-z0-9]+)&lt;/style&gt;&quot;);</a>
<a name="ln3142">                                          if (re.indexIn(line) &gt; -1)</a>
<a name="ln3143">                                                styleName = re.cap(1);</a>
<a name="ln3144">                                          return;</a>
<a name="ln3145">                                          }</a>
<a name="ln3146">                                    if (line.contains(closeTag))</a>
<a name="ln3147">                                          return;</a>
<a name="ln3148">                                    arrLine = dev.readLine();</a>
<a name="ln3149">                                    }</a>
<a name="ln3150">                              });</a>
<a name="ln3151">                        }</a>
<a name="ln3152">                  StaffTextBase* t;</a>
<a name="ln3153">                  if (styleName == &quot;System&quot;   || styleName == &quot;Tempo&quot;</a>
<a name="ln3154">                     || styleName == &quot;Marker&quot; || styleName == &quot;Jump&quot;</a>
<a name="ln3155">                     || styleName == &quot;Volta&quot;) // TODO: is it possible to get it from style?</a>
<a name="ln3156">                        t = new SystemText(score);</a>
<a name="ln3157">                  else</a>
<a name="ln3158">                        t = new StaffText(score);</a>
<a name="ln3159">                  t-&gt;setTrack(e.track());</a>
<a name="ln3160">                  readText206(e, t, t);</a>
<a name="ln3161">                  if (t-&gt;empty()) {</a>
<a name="ln3162">                        if (t-&gt;links()) {</a>
<a name="ln3163">                              if (t-&gt;links()-&gt;size() == 1) {</a>
<a name="ln3164">                                    qDebug(&quot;reading empty text: deleted lid = %d&quot;, t-&gt;links()-&gt;lid());</a>
<a name="ln3165">                                    e.linkIds().remove(t-&gt;links()-&gt;lid());</a>
<a name="ln3166">                                    delete t;</a>
<a name="ln3167">                                    }</a>
<a name="ln3168">                              }</a>
<a name="ln3169">                        }</a>
<a name="ln3170">                  else {</a>
<a name="ln3171">#if 0</a>
<a name="ln3172">                        // This code was added at commit ed5b615</a>
<a name="ln3173">                        // but it seems to no longer be appropriate.</a>
<a name="ln3174">                        // autoplace is usually true,</a>
<a name="ln3175">                        // exception is text within staff,</a>
<a name="ln3176">                        // and in this case offset is already correct without further adjustment.</a>
<a name="ln3177">                        if (!t-&gt;autoplace()) {</a>
<a name="ln3178">                              // adjust position</a>
<a name="ln3179">                              qreal userY = t-&gt;offset().y() / t-&gt;spatium();</a>
<a name="ln3180">                              qreal yo = -(-2.0 - userY) * t-&gt;spatium();</a>
<a name="ln3181">                              t-&gt;layout();</a>
<a name="ln3182">                              t-&gt;setAlign(Align::LEFT | Align::TOP);</a>
<a name="ln3183">                              t-&gt;ryoffset() = yo;</a>
<a name="ln3184">                              }</a>
<a name="ln3185">#endif</a>
<a name="ln3186">                        segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln3187">                        segment-&gt;add(t);</a>
<a name="ln3188">                        }</a>
<a name="ln3189">                  }</a>
<a name="ln3190"> </a>
<a name="ln3191">            //----------------------------------------------------</a>
<a name="ln3192">            // Annotation</a>
<a name="ln3193"> </a>
<a name="ln3194">            else if (tag == &quot;Dynamic&quot;) {</a>
<a name="ln3195">                  Dynamic* dyn = new Dynamic(score);</a>
<a name="ln3196">                  dyn-&gt;setTrack(e.track());</a>
<a name="ln3197">                  readDynamic(dyn, e);</a>
<a name="ln3198">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln3199">                  segment-&gt;add(dyn);</a>
<a name="ln3200">                  }</a>
<a name="ln3201">            else if (tag == &quot;RehearsalMark&quot;) {</a>
<a name="ln3202">                  RehearsalMark* el = new RehearsalMark(score);</a>
<a name="ln3203">                  el-&gt;setTrack(e.track());</a>
<a name="ln3204">                  readText206(e, el, el);</a>
<a name="ln3205">//                  el-&gt;setOffset(el-&gt;offset() - el-&gt;score()-&gt;styleValue(Pid::OFFSET, Sid::rehearsalMarkPosAbove).toPointF());</a>
<a name="ln3206">//                  if (el-&gt;offset().isNull())</a>
<a name="ln3207">//                        el-&gt;setAutoplace(true);</a>
<a name="ln3208">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln3209">                  segment-&gt;add(el);</a>
<a name="ln3210">                  }</a>
<a name="ln3211">#if 0</a>
<a name="ln3212">            else if (tag == &quot;StaffText&quot;) {</a>
<a name="ln3213">                  StaffText* el = new StaffText(score);</a>
<a name="ln3214">                  el-&gt;setTrack(e.track());</a>
<a name="ln3215"> </a>
<a name="ln3216">                  while (e.readNextStartElement()) {</a>
<a name="ln3217">                        const QStringRef&amp; tag(e.name());</a>
<a name="ln3218">                        if (tag == &quot;foregroundColor&quot;)</a>
<a name="ln3219">                              e.skipCurrentElement();</a>
<a name="ln3220">                        else if (!el-&gt;readProperties(e))</a>
<a name="ln3221">                              e.unknown();</a>
<a name="ln3222">                        }</a>
<a name="ln3223">                  TextBase* tt = static_cast&lt;TextBase*&gt;(el);</a>
<a name="ln3224">                  tt-&gt;setXmlText(tt-&gt;xmlText().replace(&quot;&lt;sym&gt;unicode&quot;, &quot;&lt;sym&gt;met&quot;));</a>
<a name="ln3225">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln3226">                  segment-&gt;add(el);</a>
<a name="ln3227">                  }</a>
<a name="ln3228">#endif</a>
<a name="ln3229">            else if (tag == &quot;Harmony&quot;</a>
<a name="ln3230">               || tag == &quot;FretDiagram&quot;</a>
<a name="ln3231">               || tag == &quot;TremoloBar&quot;</a>
<a name="ln3232">               || tag == &quot;Symbol&quot;</a>
<a name="ln3233">               || tag == &quot;InstrumentChange&quot;</a>
<a name="ln3234">               || tag == &quot;StaffState&quot;</a>
<a name="ln3235">               || tag == &quot;FiguredBass&quot;</a>
<a name="ln3236">               ) {</a>
<a name="ln3237">                  Element* el = Element::name2Element(tag, score);</a>
<a name="ln3238">                  // hack - needed because tick tags are unreliable in 1.3 scores</a>
<a name="ln3239">                  // for symbols attached to anything but a measure</a>
<a name="ln3240">                  el-&gt;setTrack(e.track());</a>
<a name="ln3241">                  el-&gt;read(e);</a>
<a name="ln3242">                  if (el-&gt;staff() &amp;&amp; (el-&gt;isHarmony() || el-&gt;isFretDiagram() || el-&gt;isInstrumentChange()))</a>
<a name="ln3243">                        adjustPlacement(el);</a>
<a name="ln3244">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln3245">                  segment-&gt;add(el);</a>
<a name="ln3246">                  }</a>
<a name="ln3247">            else if (tag == &quot;Tempo&quot;) {</a>
<a name="ln3248">                  TempoText* tt = new TempoText(score);</a>
<a name="ln3249">                  // hack - needed because tick tags are unreliable in 1.3 scores</a>
<a name="ln3250">                  // for symbols attached to anything but a measure</a>
<a name="ln3251">                  tt-&gt;setTrack(e.track());</a>
<a name="ln3252">                  readTempoText(tt, e);</a>
<a name="ln3253">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln3254">                  segment-&gt;add(tt);</a>
<a name="ln3255">                  }</a>
<a name="ln3256">            else if (tag == &quot;Marker&quot; || tag == &quot;Jump&quot;) {</a>
<a name="ln3257">                  Element* el = Element::name2Element(tag, score);</a>
<a name="ln3258">                  el-&gt;setTrack(e.track());</a>
<a name="ln3259">                  if (tag == &quot;Marker&quot;) {</a>
<a name="ln3260">                        Marker* ma = toMarker(el);</a>
<a name="ln3261">                        readMarker(ma, e);</a>
<a name="ln3262">                        Element* markerEl = toElement(ma);</a>
<a name="ln3263">                        m-&gt;add(markerEl);</a>
<a name="ln3264">                        }</a>
<a name="ln3265">                  else {</a>
<a name="ln3266">                        el-&gt;read(e);</a>
<a name="ln3267">                        m-&gt;add(el);</a>
<a name="ln3268">                        }</a>
<a name="ln3269">                  }</a>
<a name="ln3270">            else if (tag == &quot;Image&quot;) {</a>
<a name="ln3271">                  if (MScore::noImages)</a>
<a name="ln3272">                        e.skipCurrentElement();</a>
<a name="ln3273">                  else {</a>
<a name="ln3274">                        Element* el = Element::name2Element(tag, score);</a>
<a name="ln3275">                        el-&gt;setTrack(e.track());</a>
<a name="ln3276">                        el-&gt;read(e);</a>
<a name="ln3277">                        segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln3278">                        segment-&gt;add(el);</a>
<a name="ln3279">                        }</a>
<a name="ln3280">                  }</a>
<a name="ln3281">            //----------------------------------------------------</a>
<a name="ln3282">            else if (tag == &quot;stretch&quot;) {</a>
<a name="ln3283">                  double val = e.readDouble();</a>
<a name="ln3284">                  if (val &lt; 0.0)</a>
<a name="ln3285">                        val = 0;</a>
<a name="ln3286">                  m-&gt;setUserStretch(val);</a>
<a name="ln3287">                  }</a>
<a name="ln3288">            else if (tag == &quot;noOffset&quot;)</a>
<a name="ln3289">                  m-&gt;setNoOffset(e.readInt());</a>
<a name="ln3290">            else if (tag == &quot;measureNumberMode&quot;)</a>
<a name="ln3291">                  m-&gt;setMeasureNumberMode(MeasureNumberMode(e.readInt()));</a>
<a name="ln3292">            else if (tag == &quot;irregular&quot;)</a>
<a name="ln3293">                  m-&gt;setIrregular(e.readBool());</a>
<a name="ln3294">            else if (tag == &quot;breakMultiMeasureRest&quot;)</a>
<a name="ln3295">                  m-&gt;setBreakMultiMeasureRest(e.readBool());</a>
<a name="ln3296">            else if (tag == &quot;sysInitBarLineType&quot;) {</a>
<a name="ln3297">                  const QString&amp; val(e.readElementText());</a>
<a name="ln3298">                  BarLine* barLine = new BarLine(score);</a>
<a name="ln3299">                  barLine-&gt;setTrack(e.track());</a>
<a name="ln3300">                  barLine-&gt;setBarLineType(val);</a>
<a name="ln3301">                  segment = m-&gt;getSegment(SegmentType::BeginBarLine, m-&gt;tick());</a>
<a name="ln3302">                  segment-&gt;add(barLine);</a>
<a name="ln3303">                  }</a>
<a name="ln3304">            else if (tag == &quot;Tuplet&quot;) {</a>
<a name="ln3305">                  Tuplet* tuplet = new Tuplet(score);</a>
<a name="ln3306">                  tuplet-&gt;setTrack(e.track());</a>
<a name="ln3307">                  tuplet-&gt;setTick(e.tick());</a>
<a name="ln3308">                  tuplet-&gt;setParent(m);</a>
<a name="ln3309">                  readTuplet(tuplet, e);</a>
<a name="ln3310">                  e.addTuplet(tuplet);</a>
<a name="ln3311">                  }</a>
<a name="ln3312">            else if (tag == &quot;startRepeat&quot;) {</a>
<a name="ln3313">                  m-&gt;setRepeatStart(true);</a>
<a name="ln3314">                  e.readNext();</a>
<a name="ln3315">                  }</a>
<a name="ln3316">            else if (tag == &quot;endRepeat&quot;) {</a>
<a name="ln3317">                  m-&gt;setRepeatCount(e.readInt());</a>
<a name="ln3318">                  m-&gt;setRepeatEnd(true);</a>
<a name="ln3319">                  }</a>
<a name="ln3320">            else if (tag == &quot;vspacer&quot; || tag == &quot;vspacerDown&quot;) {</a>
<a name="ln3321">                  if (!m-&gt;vspacerDown(staffIdx)) {</a>
<a name="ln3322">                        Spacer* spacer = new Spacer(score);</a>
<a name="ln3323">                        spacer-&gt;setSpacerType(SpacerType::DOWN);</a>
<a name="ln3324">                        spacer-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln3325">                        m-&gt;add(spacer);</a>
<a name="ln3326">                        }</a>
<a name="ln3327">                  m-&gt;vspacerDown(staffIdx)-&gt;setGap(e.readDouble() * _spatium);</a>
<a name="ln3328">                  }</a>
<a name="ln3329">            else if (tag == &quot;vspacer&quot; || tag == &quot;vspacerUp&quot;) {</a>
<a name="ln3330">                  if (!m-&gt;vspacerUp(staffIdx)) {</a>
<a name="ln3331">                        Spacer* spacer = new Spacer(score);</a>
<a name="ln3332">                        spacer-&gt;setSpacerType(SpacerType::UP);</a>
<a name="ln3333">                        spacer-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln3334">                        m-&gt;add(spacer);</a>
<a name="ln3335">                        }</a>
<a name="ln3336">                  m-&gt;vspacerUp(staffIdx)-&gt;setGap(e.readDouble() * _spatium);</a>
<a name="ln3337">                  }</a>
<a name="ln3338">            else if (tag == &quot;visible&quot;)</a>
<a name="ln3339">                  m-&gt;setStaffVisible(staffIdx, e.readInt());</a>
<a name="ln3340">            else if (tag == &quot;slashStyle&quot;)</a>
<a name="ln3341">                  m-&gt;setStaffStemless(staffIdx, e.readInt());</a>
<a name="ln3342">            else if (tag == &quot;Beam&quot;) {</a>
<a name="ln3343">                  Beam* beam = new Beam(score);</a>
<a name="ln3344">                  beam-&gt;setTrack(e.track());</a>
<a name="ln3345">                  beam-&gt;read(e);</a>
<a name="ln3346">                  beam-&gt;setParent(0);</a>
<a name="ln3347">                  e.addBeam(beam);</a>
<a name="ln3348">                  }</a>
<a name="ln3349">            else if (tag == &quot;Segment&quot;) {</a>
<a name="ln3350">                  if (segment) segment-&gt;read(e);</a>
<a name="ln3351">                  else e.unknown();</a>
<a name="ln3352">                  }</a>
<a name="ln3353">            else if (tag == &quot;MeasureNumber&quot;) {</a>
<a name="ln3354">                  MeasureNumber* noText = new MeasureNumber(score);</a>
<a name="ln3355">                  readText206(e, noText, m);</a>
<a name="ln3356">                  noText-&gt;setTrack(e.track());</a>
<a name="ln3357">                  noText-&gt;setParent(m);</a>
<a name="ln3358">                  m-&gt;setNoText(noText-&gt;staffIdx(), noText);</a>
<a name="ln3359">                  }</a>
<a name="ln3360">            else if (tag == &quot;SystemDivider&quot;) {</a>
<a name="ln3361">                  SystemDivider* sd = new SystemDivider(score);</a>
<a name="ln3362">                  sd-&gt;read(e);</a>
<a name="ln3363">                  m-&gt;add(sd);</a>
<a name="ln3364">                  }</a>
<a name="ln3365">            else if (tag == &quot;Ambitus&quot;) {</a>
<a name="ln3366">                  Ambitus* range = new Ambitus(score);</a>
<a name="ln3367">                  readAmbitus(range, e);</a>
<a name="ln3368">                  segment = m-&gt;getSegment(SegmentType::Ambitus, e.tick());</a>
<a name="ln3369">                  range-&gt;setParent(segment);          // a parent segment is needed for setTrack() to work</a>
<a name="ln3370">                  range-&gt;setTrack(trackZeroVoice(e.track()));</a>
<a name="ln3371">                  segment-&gt;add(range);</a>
<a name="ln3372">                  }</a>
<a name="ln3373">            else if (tag == &quot;multiMeasureRest&quot;) {</a>
<a name="ln3374">                  m-&gt;setMMRestCount(e.readInt());</a>
<a name="ln3375">                  // set tick to previous measure</a>
<a name="ln3376">                  m-&gt;setTick(e.lastMeasure()-&gt;tick());</a>
<a name="ln3377">                  e.setTick(e.lastMeasure()-&gt;tick());</a>
<a name="ln3378">                  }</a>
<a name="ln3379">            else if (m-&gt;MeasureBase::readProperties(e))</a>
<a name="ln3380">                  ;</a>
<a name="ln3381">            else</a>
<a name="ln3382">                  e.unknown();</a>
<a name="ln3383">            }</a>
<a name="ln3384">      e.checkTuplets();</a>
<a name="ln3385">      m-&gt;connectTremolo();</a>
<a name="ln3386">      }</a>
<a name="ln3387"> </a>
<a name="ln3388">//---------------------------------------------------------</a>
<a name="ln3389">//   readBox</a>
<a name="ln3390">//---------------------------------------------------------</a>
<a name="ln3391"> </a>
<a name="ln3392">static void readBox(Box* b, XmlReader&amp; e)</a>
<a name="ln3393">      {</a>
<a name="ln3394">      b-&gt;setLeftMargin(0.0);</a>
<a name="ln3395">      b-&gt;setRightMargin(0.0);</a>
<a name="ln3396">      b-&gt;setTopMargin(0.0);</a>
<a name="ln3397">      b-&gt;setBottomMargin(0.0);</a>
<a name="ln3398">      b-&gt;setTopGap(0.0);</a>
<a name="ln3399">      b-&gt;setBottomGap(0.0);</a>
<a name="ln3400">      b-&gt;setPropertyFlags(Pid::TOP_GAP, PropertyFlags::UNSTYLED);</a>
<a name="ln3401">      b-&gt;setPropertyFlags(Pid::BOTTOM_GAP, PropertyFlags::UNSTYLED);</a>
<a name="ln3402"> </a>
<a name="ln3403">      b-&gt;setBoxHeight(Spatium(0));     // override default set in constructor</a>
<a name="ln3404">      b-&gt;setBoxWidth(Spatium(0));</a>
<a name="ln3405">      bool keepMargins = false;        // whether original margins have to be kept when reading old file</a>
<a name="ln3406"> </a>
<a name="ln3407">      while (e.readNextStartElement()) {</a>
<a name="ln3408">            const QStringRef&amp; tag(e.name());</a>
<a name="ln3409">            if (tag == &quot;HBox&quot;) {</a>
<a name="ln3410">                  HBox* hb = new HBox(b-&gt;score());</a>
<a name="ln3411">                  hb-&gt;read(e);</a>
<a name="ln3412">                  b-&gt;add(hb);</a>
<a name="ln3413">                  keepMargins = true;     // in old file, box nesting used outer box margins</a>
<a name="ln3414">                  }</a>
<a name="ln3415">            else if (tag == &quot;VBox&quot;) {</a>
<a name="ln3416">                  VBox* vb = new VBox(b-&gt;score());</a>
<a name="ln3417">                  vb-&gt;read(e);</a>
<a name="ln3418">                  b-&gt;add(vb);</a>
<a name="ln3419">                  keepMargins = true;     // in old file, box nesting used outer box margins</a>
<a name="ln3420">                  }</a>
<a name="ln3421">            else if (tag == &quot;Text&quot;) {</a>
<a name="ln3422">                  Text* t;</a>
<a name="ln3423">                  if (b-&gt;isTBox()) {</a>
<a name="ln3424">                        t = toTBox(b)-&gt;text();</a>
<a name="ln3425">                        readText206(e, t, t);</a>
<a name="ln3426">                        }</a>
<a name="ln3427">                  else {</a>
<a name="ln3428">                        t = new Text(b-&gt;score());</a>
<a name="ln3429">                        readText206(e, t, t);</a>
<a name="ln3430">                        if (t-&gt;empty()) {</a>
<a name="ln3431">                              qDebug(&quot;read empty text&quot;);</a>
<a name="ln3432">                              }</a>
<a name="ln3433">                        else</a>
<a name="ln3434">                              b-&gt;add(t);</a>
<a name="ln3435">                        }</a>
<a name="ln3436">                  }</a>
<a name="ln3437">            else if (!b-&gt;readProperties(e))</a>
<a name="ln3438">                  e.unknown();</a>
<a name="ln3439">            }</a>
<a name="ln3440"> </a>
<a name="ln3441">      // with .msc versions prior to 1.17, box margins were only used when nesting another box inside this box:</a>
<a name="ln3442">      // for backward compatibility set them to 0 in all other cases</a>
<a name="ln3443"> </a>
<a name="ln3444">      if (b-&gt;score()-&gt;mscVersion() &lt;= 114 &amp;&amp; (b-&gt;isHBox() || b-&gt;isVBox()) &amp;&amp; !keepMargins)  {</a>
<a name="ln3445">            b-&gt;setLeftMargin(0.0);</a>
<a name="ln3446">            b-&gt;setRightMargin(0.0);</a>
<a name="ln3447">            b-&gt;setTopMargin(0.0);</a>
<a name="ln3448">            b-&gt;setBottomMargin(0.0);</a>
<a name="ln3449">            }</a>
<a name="ln3450">      }</a>
<a name="ln3451"> </a>
<a name="ln3452">//---------------------------------------------------------</a>
<a name="ln3453">//   readStaffContent</a>
<a name="ln3454">//---------------------------------------------------------</a>
<a name="ln3455"> </a>
<a name="ln3456">static void readStaffContent(Score* score, XmlReader&amp; e)</a>
<a name="ln3457">      {</a>
<a name="ln3458">      int staff = e.intAttribute(&quot;id&quot;, 1) - 1;</a>
<a name="ln3459">      e.setTick(Fraction(0,1));</a>
<a name="ln3460">      e.setTrack(staff * VOICES);</a>
<a name="ln3461">      Box* lastReadBox = nullptr;</a>
<a name="ln3462">      bool readMeasureLast = false;</a>
<a name="ln3463"> </a>
<a name="ln3464">      if (staff == 0) {</a>
<a name="ln3465">            while (e.readNextStartElement()) {</a>
<a name="ln3466">                  const QStringRef&amp; tag(e.name());</a>
<a name="ln3467"> </a>
<a name="ln3468">                  if (tag == &quot;Measure&quot;) {</a>
<a name="ln3469">                        if (lastReadBox) {</a>
<a name="ln3470">                              lastReadBox-&gt;setBottomGap(lastReadBox-&gt;bottomGap() + lastReadBox-&gt;propertyDefault(Pid::BOTTOM_GAP).toReal());</a>
<a name="ln3471">                              lastReadBox = nullptr;</a>
<a name="ln3472">                              }</a>
<a name="ln3473">                        readMeasureLast = true;</a>
<a name="ln3474"> </a>
<a name="ln3475">                        Measure* measure = 0;</a>
<a name="ln3476">                        measure = new Measure(score);</a>
<a name="ln3477">                        measure-&gt;setTick(e.tick());</a>
<a name="ln3478">                        //</a>
<a name="ln3479">                        // inherit timesig from previous measure</a>
<a name="ln3480">                        //</a>
<a name="ln3481">                        Measure* m = e.lastMeasure(); // measure-&gt;prevMeasure();</a>
<a name="ln3482">                        Fraction f(m ? m-&gt;timesig() : Fraction(4,4));</a>
<a name="ln3483">                        measure-&gt;setTicks(f);</a>
<a name="ln3484">                        measure-&gt;setTimesig(f);</a>
<a name="ln3485"> </a>
<a name="ln3486">                        readMeasure(measure, staff, e);</a>
<a name="ln3487">                        measure-&gt;checkMeasure(staff);</a>
<a name="ln3488">                        if (!measure-&gt;isMMRest()) {</a>
<a name="ln3489">                              score-&gt;measures()-&gt;add(measure);</a>
<a name="ln3490">                              e.setLastMeasure(measure);</a>
<a name="ln3491">                              e.setTick(measure-&gt;endTick());</a>
<a name="ln3492">                              }</a>
<a name="ln3493">                        else {</a>
<a name="ln3494">                              // this is a multi measure rest</a>
<a name="ln3495">                              // always preceded by the first measure it replaces</a>
<a name="ln3496">                              Measure* lm = e.lastMeasure();</a>
<a name="ln3497"> </a>
<a name="ln3498">                              if (lm) {</a>
<a name="ln3499">                                    lm-&gt;setMMRest(measure);</a>
<a name="ln3500">                                    measure-&gt;setTick(lm-&gt;tick());</a>
<a name="ln3501">                                    }</a>
<a name="ln3502">                              }</a>
<a name="ln3503">                        }</a>
<a name="ln3504">                  else if (tag == &quot;HBox&quot; || tag == &quot;VBox&quot; || tag == &quot;TBox&quot; || tag == &quot;FBox&quot;) {</a>
<a name="ln3505">                        Box* b = toBox(Element::name2Element(tag, score));</a>
<a name="ln3506">                        readBox(b, e);</a>
<a name="ln3507">                        b-&gt;setTick(e.tick());</a>
<a name="ln3508">                        score-&gt;measures()-&gt;add(b);</a>
<a name="ln3509"> </a>
<a name="ln3510">                        // If it's the first box, and comes before any measures, reset to</a>
<a name="ln3511">                        // 301 default.</a>
<a name="ln3512">                        if (!readMeasureLast &amp;&amp; !lastReadBox) {</a>
<a name="ln3513">                              b-&gt;setTopGap(b-&gt;propertyDefault(Pid::TOP_GAP).toReal());</a>
<a name="ln3514">                              b-&gt;setPropertyFlags(Pid::TOP_GAP, PropertyFlags::STYLED);</a>
<a name="ln3515">                              }</a>
<a name="ln3516">                        else if (readMeasureLast)</a>
<a name="ln3517">                              b-&gt;setTopGap(b-&gt;topGap() + b-&gt;propertyDefault(Pid::TOP_GAP).toReal());</a>
<a name="ln3518"> </a>
<a name="ln3519">                        lastReadBox = b;</a>
<a name="ln3520">                        readMeasureLast = false;</a>
<a name="ln3521">                        }</a>
<a name="ln3522">                  else if (tag == &quot;tick&quot;)</a>
<a name="ln3523">                        e.setTick(Fraction::fromTicks(score-&gt;fileDivision(e.readInt())));</a>
<a name="ln3524">                  else</a>
<a name="ln3525">                        e.unknown();</a>
<a name="ln3526">                  }</a>
<a name="ln3527">            }</a>
<a name="ln3528">      else {</a>
<a name="ln3529">            Measure* measure = score-&gt;firstMeasure();</a>
<a name="ln3530">            while (e.readNextStartElement()) {</a>
<a name="ln3531">                  const QStringRef&amp; tag(e.name());</a>
<a name="ln3532"> </a>
<a name="ln3533">                  if (tag == &quot;Measure&quot;) {</a>
<a name="ln3534">                        if (measure == 0) {</a>
<a name="ln3535">                              qDebug(&quot;Score::readStaff(): missing measure!&quot;);</a>
<a name="ln3536">                              measure = new Measure(score);</a>
<a name="ln3537">                              measure-&gt;setTick(e.tick());</a>
<a name="ln3538">                              score-&gt;measures()-&gt;add(measure);</a>
<a name="ln3539">                              }</a>
<a name="ln3540">                        e.setTick(measure-&gt;tick());</a>
<a name="ln3541">                        readMeasure(measure, staff, e);</a>
<a name="ln3542">                        measure-&gt;checkMeasure(staff);</a>
<a name="ln3543">                        if (measure-&gt;isMMRest())</a>
<a name="ln3544">                              measure = e.lastMeasure()-&gt;nextMeasure();</a>
<a name="ln3545">                        else {</a>
<a name="ln3546">                              e.setLastMeasure(measure);</a>
<a name="ln3547">                              if (measure-&gt;mmRest())</a>
<a name="ln3548">                                    measure = measure-&gt;mmRest();</a>
<a name="ln3549">                              else</a>
<a name="ln3550">                                    measure = measure-&gt;nextMeasure();</a>
<a name="ln3551">                              }</a>
<a name="ln3552">                        }</a>
<a name="ln3553">                  else if (tag == &quot;tick&quot;)</a>
<a name="ln3554">                        e.setTick(Fraction::fromTicks(score-&gt;fileDivision(e.readInt())));</a>
<a name="ln3555">                  else</a>
<a name="ln3556">                        e.unknown();</a>
<a name="ln3557">                  }</a>
<a name="ln3558">            }</a>
<a name="ln3559">      }</a>
<a name="ln3560"> </a>
<a name="ln3561">//---------------------------------------------------------</a>
<a name="ln3562">//   readStyle</a>
<a name="ln3563">//---------------------------------------------------------</a>
<a name="ln3564"> </a>
<a name="ln3565">static void readStyle(MStyle* style, XmlReader&amp; e)</a>
<a name="ln3566">      {</a>
<a name="ln3567">      QString oldChordDescriptionFile = style-&gt;value(Sid::chordDescriptionFile).toString();</a>
<a name="ln3568">      bool chordListTag = false;</a>
<a name="ln3569">      excessTextStyles206.clear();</a>
<a name="ln3570">      while (e.readNextStartElement()) {</a>
<a name="ln3571">            QString tag = e.name().toString();</a>
<a name="ln3572">            if (tag == &quot;TextStyle&quot;)</a>
<a name="ln3573">                  readTextStyle206(style, e, excessTextStyles206);</a>
<a name="ln3574">            else if (tag == &quot;Spatium&quot;)</a>
<a name="ln3575">                  style-&gt;set(Sid::spatium, e.readDouble() * DPMM);</a>
<a name="ln3576">            else if (tag == &quot;page-layout&quot;)</a>
<a name="ln3577">                  readPageFormat(style, e);</a>
<a name="ln3578">            else if (tag == &quot;displayInConcertPitch&quot;)</a>
<a name="ln3579">                  style-&gt;set(Sid::concertPitch, QVariant(bool(e.readInt())));</a>
<a name="ln3580">            else if (tag == &quot;pedalY&quot;) {</a>
<a name="ln3581">                  qreal y = e.readDouble();</a>
<a name="ln3582">                  style-&gt;set(Sid::pedalPosBelow, QPointF(0.0, y));</a>
<a name="ln3583">                  }</a>
<a name="ln3584">            else if (tag == &quot;lyricsDistance&quot;) {</a>
<a name="ln3585">                  qreal y = e.readDouble();</a>
<a name="ln3586">                  style-&gt;set(Sid::lyricsPosBelow, QPointF(0.0, y));</a>
<a name="ln3587">                  }</a>
<a name="ln3588">            else if (tag == &quot;lyricsMinBottomDistance&quot;) {</a>
<a name="ln3589">                  // no longer meaningful since it is now measured from skyline rather than staff</a>
<a name="ln3590">                  //style-&gt;set(Sid::lyricsMinBottomDistance, QPointF(0.0, y));</a>
<a name="ln3591">                  e.skipCurrentElement();</a>
<a name="ln3592">                  }</a>
<a name="ln3593">            else if (tag == &quot;ottavaHook&quot;) {</a>
<a name="ln3594">                  qreal y = qAbs(e.readDouble());</a>
<a name="ln3595">                  style-&gt;set(Sid::ottavaHookAbove, y);</a>
<a name="ln3596">                  style-&gt;set(Sid::ottavaHookBelow, -y);</a>
<a name="ln3597">                  }</a>
<a name="ln3598">            else if (tag == &quot;endBarDistance&quot;) {</a>
<a name="ln3599">                  double d = e.readDouble();</a>
<a name="ln3600">                  d += style-&gt;value(Sid::barWidth).toDouble();</a>
<a name="ln3601">                  d += style-&gt;value(Sid::endBarWidth).toDouble();</a>
<a name="ln3602">                  style-&gt;set(Sid::endBarDistance, QVariant(d));</a>
<a name="ln3603">                  }</a>
<a name="ln3604">            else if (tag == &quot;ChordList&quot;) {</a>
<a name="ln3605">                  style-&gt;chordList()-&gt;clear();</a>
<a name="ln3606">                  style-&gt;chordList()-&gt;read(e);</a>
<a name="ln3607">                  style-&gt;setCustomChordList(true);</a>
<a name="ln3608">                  for (ChordFont f : style-&gt;chordList()-&gt;fonts) {</a>
<a name="ln3609">                        if (f.family == &quot;MuseJazz&quot;) {</a>
<a name="ln3610">                              f.family = &quot;MuseJazz Text&quot;;</a>
<a name="ln3611">                              }</a>
<a name="ln3612">                        }</a>
<a name="ln3613">                  chordListTag = true;</a>
<a name="ln3614">                  }</a>
<a name="ln3615">            else if (tag == &quot;harmonyY&quot;) {</a>
<a name="ln3616">                  qreal val = -e.readDouble();</a>
<a name="ln3617">                  if (val &gt; 0.0) {</a>
<a name="ln3618">                        style-&gt;set(Sid::harmonyPlacement, int(Placement::BELOW));</a>
<a name="ln3619">                        style-&gt;set(Sid::chordSymbolAPosBelow,  QPointF(.0, val));</a>
<a name="ln3620">                        }</a>
<a name="ln3621">                  else {</a>
<a name="ln3622">                        style-&gt;set(Sid::harmonyPlacement, int(Placement::ABOVE));</a>
<a name="ln3623">                        style-&gt;set(Sid::chordSymbolAPosBelow,  QPointF(.0, val));</a>
<a name="ln3624">                        }</a>
<a name="ln3625">                  }</a>
<a name="ln3626">            else {</a>
<a name="ln3627">                  if (!style-&gt;readProperties(e)) {</a>
<a name="ln3628">                        e.skipCurrentElement();</a>
<a name="ln3629">                        }</a>
<a name="ln3630">                  }</a>
<a name="ln3631">            }</a>
<a name="ln3632"> </a>
<a name="ln3633">      // if we just specified a new chord description file</a>
<a name="ln3634">      // and didn't encounter a ChordList tag</a>
<a name="ln3635">      // then load the chord description file</a>
<a name="ln3636"> </a>
<a name="ln3637">      QString newChordDescriptionFile = style-&gt;value(Sid::chordDescriptionFile).toString();</a>
<a name="ln3638">      if (newChordDescriptionFile != oldChordDescriptionFile &amp;&amp; !chordListTag) {</a>
<a name="ln3639">            if (!newChordDescriptionFile.startsWith(&quot;chords_&quot;) &amp;&amp; style-&gt;value(Sid::chordStyle).toString() == &quot;std&quot;) {</a>
<a name="ln3640">                  // should not normally happen,</a>
<a name="ln3641">                  // but treat as &quot;old&quot; (114) score just in case</a>
<a name="ln3642">                  style-&gt;set(Sid::chordStyle, QVariant(QString(&quot;custom&quot;)));</a>
<a name="ln3643">                  style-&gt;set(Sid::chordsXmlFile, QVariant(true));</a>
<a name="ln3644">                  qDebug(&quot;StyleData::load: custom chord description file %s with chordStyle == std&quot;, qPrintable(newChordDescriptionFile));</a>
<a name="ln3645">                  }</a>
<a name="ln3646">            if (style-&gt;value(Sid::chordStyle).toString() == &quot;custom&quot;)</a>
<a name="ln3647">                  style-&gt;setCustomChordList(true);</a>
<a name="ln3648">            else</a>
<a name="ln3649">                  style-&gt;setCustomChordList(false);</a>
<a name="ln3650">            style-&gt;chordList()-&gt;unload();</a>
<a name="ln3651">            }</a>
<a name="ln3652"> </a>
<a name="ln3653">      // make sure we have a chordlist</a>
<a name="ln3654">      if (!chordListTag)</a>
<a name="ln3655">            style-&gt;checkChordList();</a>
<a name="ln3656">      }</a>
<a name="ln3657"> </a>
<a name="ln3658">//---------------------------------------------------------</a>
<a name="ln3659">//   readScore</a>
<a name="ln3660">//---------------------------------------------------------</a>
<a name="ln3661"> </a>
<a name="ln3662">static bool readScore(Score* score, XmlReader&amp; e)</a>
<a name="ln3663">      {</a>
<a name="ln3664">      while (e.readNextStartElement()) {</a>
<a name="ln3665">            e.setTrack(-1);</a>
<a name="ln3666">            const QStringRef&amp; tag(e.name());</a>
<a name="ln3667">            if (tag == &quot;Staff&quot;)</a>
<a name="ln3668">                  readStaffContent(score, e);</a>
<a name="ln3669">            else if (tag == &quot;siglist&quot;)</a>
<a name="ln3670">                  score-&gt;sigmap()-&gt;read(e, score-&gt;fileDivision());</a>
<a name="ln3671">            else if (tag == &quot;Omr&quot;) {</a>
<a name="ln3672">#ifdef OMR</a>
<a name="ln3673">                  score-&gt;masterScore()-&gt;setOmr(new Omr(score));</a>
<a name="ln3674">                  score-&gt;masterScore()-&gt;omr()-&gt;read(e);</a>
<a name="ln3675">#else</a>
<a name="ln3676">                  e.skipCurrentElement();</a>
<a name="ln3677">#endif</a>
<a name="ln3678">                  }</a>
<a name="ln3679">            else if (tag == &quot;Audio&quot;) {</a>
<a name="ln3680">                  score-&gt;setAudio(new Audio);</a>
<a name="ln3681">                  score-&gt;audio()-&gt;read(e);</a>
<a name="ln3682">                  }</a>
<a name="ln3683">            else if (tag == &quot;showOmr&quot;)</a>
<a name="ln3684">                  score-&gt;masterScore()-&gt;setShowOmr(e.readInt());</a>
<a name="ln3685">            else if (tag == &quot;playMode&quot;)</a>
<a name="ln3686">                  score-&gt;setPlayMode(PlayMode(e.readInt()));</a>
<a name="ln3687">            else if (tag == &quot;LayerTag&quot;) {</a>
<a name="ln3688">                  int id = e.intAttribute(&quot;id&quot;);</a>
<a name="ln3689">                  const QString&amp; t = e.attribute(&quot;tag&quot;);</a>
<a name="ln3690">                  QString val(e.readElementText());</a>
<a name="ln3691">                  if (id &gt;= 0 &amp;&amp; id &lt; 32) {</a>
<a name="ln3692">                        score-&gt;layerTags()[id] = t;</a>
<a name="ln3693">                        score-&gt;layerTagComments()[id] = val;</a>
<a name="ln3694">                        }</a>
<a name="ln3695">                  }</a>
<a name="ln3696">            else if (tag == &quot;Layer&quot;) {</a>
<a name="ln3697">                  Layer layer;</a>
<a name="ln3698">                  layer.name = e.attribute(&quot;name&quot;);</a>
<a name="ln3699">                  layer.tags = e.attribute(&quot;mask&quot;).toUInt();</a>
<a name="ln3700">                  score-&gt;layer().append(layer);</a>
<a name="ln3701">                  e.readNext();</a>
<a name="ln3702">                  }</a>
<a name="ln3703">            else if (tag == &quot;currentLayer&quot;)</a>
<a name="ln3704">                  score-&gt;setCurrentLayer(e.readInt());</a>
<a name="ln3705">            else if (tag == &quot;Synthesizer&quot;)</a>
<a name="ln3706">                  score-&gt;synthesizerState().read(e);</a>
<a name="ln3707">            else if (tag == &quot;page-offset&quot;)</a>
<a name="ln3708">                  score-&gt;setPageNumberOffset(e.readInt());</a>
<a name="ln3709">            else if (tag == &quot;Division&quot;)</a>
<a name="ln3710">                  score-&gt;setFileDivision(e.readInt());</a>
<a name="ln3711">            else if (tag == &quot;showInvisible&quot;)</a>
<a name="ln3712">                  score-&gt;setShowInvisible(e.readInt());</a>
<a name="ln3713">            else if (tag == &quot;showUnprintable&quot;)</a>
<a name="ln3714">                  score-&gt;setShowUnprintable(e.readInt());</a>
<a name="ln3715">            else if (tag == &quot;showFrames&quot;)</a>
<a name="ln3716">                  score-&gt;setShowFrames(e.readInt());</a>
<a name="ln3717">            else if (tag == &quot;showMargins&quot;)</a>
<a name="ln3718">                  score-&gt;setShowPageborders(e.readInt());</a>
<a name="ln3719">            else if (tag == &quot;Style&quot;) {</a>
<a name="ln3720">                  qreal sp = score-&gt;style().value(Sid::spatium).toDouble();</a>
<a name="ln3721">                  readStyle(&amp;score-&gt;style(), e);</a>
<a name="ln3722">                  if (score-&gt;style().value(Sid::MusicalTextFont).toString() == &quot;MuseJazz&quot;)</a>
<a name="ln3723">                        score-&gt;style().set(Sid::MusicalTextFont, &quot;MuseJazz Text&quot;);</a>
<a name="ln3724">                  // if (_layoutMode == LayoutMode::FLOAT || _layoutMode == LayoutMode::SYSTEM) {</a>
<a name="ln3725">                  if (score-&gt;layoutMode() == LayoutMode::FLOAT) {</a>
<a name="ln3726">                        // style should not change spatium in</a>
<a name="ln3727">                        // float mode</a>
<a name="ln3728">                        score-&gt;style().set(Sid::spatium, sp);</a>
<a name="ln3729">                        }</a>
<a name="ln3730">                  score-&gt;setScoreFont(ScoreFont::fontFactory(score-&gt;style().value(Sid::MusicalSymbolFont).toString()));</a>
<a name="ln3731">                  }</a>
<a name="ln3732">            else if (tag == &quot;copyright&quot; || tag == &quot;rights&quot;) {</a>
<a name="ln3733">                  Text* text = new Text(score);</a>
<a name="ln3734">                  readText206(e, text, text);</a>
<a name="ln3735">                  score-&gt;setMetaTag(&quot;copyright&quot;, text-&gt;xmlText());</a>
<a name="ln3736">                  delete text;</a>
<a name="ln3737">                  }</a>
<a name="ln3738">            else if (tag == &quot;movement-number&quot;)</a>
<a name="ln3739">                  score-&gt;setMetaTag(&quot;movementNumber&quot;, e.readElementText());</a>
<a name="ln3740">            else if (tag == &quot;movement-title&quot;)</a>
<a name="ln3741">                  score-&gt;setMetaTag(&quot;movementTitle&quot;, e.readElementText());</a>
<a name="ln3742">            else if (tag == &quot;work-number&quot;)</a>
<a name="ln3743">                  score-&gt;setMetaTag(&quot;workNumber&quot;, e.readElementText());</a>
<a name="ln3744">            else if (tag == &quot;work-title&quot;)</a>
<a name="ln3745">                  score-&gt;setMetaTag(&quot;workTitle&quot;, e.readElementText());</a>
<a name="ln3746">            else if (tag == &quot;source&quot;)</a>
<a name="ln3747">                  score-&gt;setMetaTag(&quot;source&quot;, e.readElementText());</a>
<a name="ln3748">            else if (tag == &quot;metaTag&quot;) {</a>
<a name="ln3749">                  QString name = e.attribute(&quot;name&quot;);</a>
<a name="ln3750">                  score-&gt;setMetaTag(name, e.readElementText());</a>
<a name="ln3751">                  }</a>
<a name="ln3752">            else if (tag == &quot;Part&quot;) {</a>
<a name="ln3753">                  Part* part = new Part(score);</a>
<a name="ln3754">                  readPart206(part, e);</a>
<a name="ln3755">                  score-&gt;parts().push_back(part);</a>
<a name="ln3756">                  }</a>
<a name="ln3757">            else if ((tag == &quot;HairPin&quot;)   // TODO: do this elements exist here?</a>
<a name="ln3758">                || (tag == &quot;Ottava&quot;)</a>
<a name="ln3759">                || (tag == &quot;TextLine&quot;)</a>
<a name="ln3760">                || (tag == &quot;Volta&quot;)</a>
<a name="ln3761">                || (tag == &quot;Trill&quot;)</a>
<a name="ln3762">                || (tag == &quot;Slur&quot;)</a>
<a name="ln3763">                || (tag == &quot;Pedal&quot;)) {</a>
<a name="ln3764">                  Spanner* s = toSpanner(Element::name2Element(tag, score));</a>
<a name="ln3765">                  if (tag == &quot;HairPin&quot;)</a>
<a name="ln3766">                        readHairpin206(e, toHairpin(s));</a>
<a name="ln3767">                  else if (tag == &quot;Ottava&quot;)</a>
<a name="ln3768">                        readOttava(e, toOttava(s));</a>
<a name="ln3769">                  else if (tag == &quot;TextLine&quot;)</a>
<a name="ln3770">                        readTextLine206(e, toTextLine(s));</a>
<a name="ln3771">                  else if (tag == &quot;Volta&quot;)</a>
<a name="ln3772">                        readVolta206(e, toVolta(s));</a>
<a name="ln3773">                  else if (tag == &quot;Trill&quot;)</a>
<a name="ln3774">                        readTrill206(e, toTrill(s));</a>
<a name="ln3775">                  else if (tag == &quot;Slur&quot;)</a>
<a name="ln3776">                        readSlur206(e, toSlur(s));</a>
<a name="ln3777">                  else {</a>
<a name="ln3778">                        Q_ASSERT(tag == &quot;Pedal&quot;);</a>
<a name="ln3779">                        readPedal(e, toPedal(s));</a>
<a name="ln3780">                        }</a>
<a name="ln3781">                  score-&gt;addSpanner(s);</a>
<a name="ln3782">                  }</a>
<a name="ln3783">            else if (tag == &quot;Excerpt&quot;) {</a>
<a name="ln3784">                  if (MScore::noExcerpts)</a>
<a name="ln3785">                        e.skipCurrentElement();</a>
<a name="ln3786">                  else {</a>
<a name="ln3787">                        if (score-&gt;isMaster()) {</a>
<a name="ln3788">                              Excerpt* ex = new Excerpt(static_cast&lt;MasterScore*&gt;(score));</a>
<a name="ln3789">                              ex-&gt;read(e);</a>
<a name="ln3790">                              score-&gt;excerpts().append(ex);</a>
<a name="ln3791">                              }</a>
<a name="ln3792">                        else {</a>
<a name="ln3793">                              qDebug(&quot;read206: readScore(): part cannot have parts&quot;);</a>
<a name="ln3794">                              e.skipCurrentElement();</a>
<a name="ln3795">                              }</a>
<a name="ln3796">                        }</a>
<a name="ln3797">                  }</a>
<a name="ln3798">            else if (tag == &quot;Score&quot;) {          // recursion</a>
<a name="ln3799">                  if (MScore::noExcerpts)</a>
<a name="ln3800">                        e.skipCurrentElement();</a>
<a name="ln3801">                  else {</a>
<a name="ln3802">                        e.tracks().clear();</a>
<a name="ln3803">                        MasterScore* m = score-&gt;masterScore();</a>
<a name="ln3804">                        Score* s = new Score(m, MScore::baseStyle());</a>
<a name="ln3805">                        Excerpt* ex = new Excerpt(m);</a>
<a name="ln3806"> </a>
<a name="ln3807">                        ex-&gt;setPartScore(s);</a>
<a name="ln3808">                        e.setLastMeasure(nullptr);</a>
<a name="ln3809">                        readScore(s, e);</a>
<a name="ln3810">                        ex-&gt;setTracks(e.tracks());</a>
<a name="ln3811">                        m-&gt;addExcerpt(ex);</a>
<a name="ln3812">                        }</a>
<a name="ln3813">                  }</a>
<a name="ln3814">            else if (tag == &quot;PageList&quot;)</a>
<a name="ln3815">                  e.skipCurrentElement();</a>
<a name="ln3816">            else if (tag == &quot;name&quot;) {</a>
<a name="ln3817">                  QString n = e.readElementText();</a>
<a name="ln3818">                  if (!score-&gt;isMaster())             //ignore the name if it's not a child score</a>
<a name="ln3819">                        score-&gt;excerpt()-&gt;setTitle(n);</a>
<a name="ln3820">                  }</a>
<a name="ln3821">            else if (tag == &quot;layoutMode&quot;) {</a>
<a name="ln3822">                  QString s = e.readElementText();</a>
<a name="ln3823">                  if (s == &quot;line&quot;)</a>
<a name="ln3824">                        score-&gt;setLayoutMode(LayoutMode::LINE);</a>
<a name="ln3825">                  else if (s == &quot;system&quot;)</a>
<a name="ln3826">                        score-&gt;setLayoutMode(LayoutMode::SYSTEM);</a>
<a name="ln3827">                  else</a>
<a name="ln3828">                        qDebug(&quot;layoutMode: %s&quot;, qPrintable(s));</a>
<a name="ln3829">                  }</a>
<a name="ln3830">            else</a>
<a name="ln3831">                  e.unknown();</a>
<a name="ln3832">            }</a>
<a name="ln3833">      if (e.error() != QXmlStreamReader::NoError) {</a>
<a name="ln3834">            qDebug(&quot;%s: xml read error at line %lld col %lld: %s&quot;,</a>
<a name="ln3835">               qPrintable(e.getDocName()), e.lineNumber(), e.columnNumber(),</a>
<a name="ln3836">               e.name().toUtf8().data());</a>
<a name="ln3837">            MScore::lastError = QObject::tr(&quot;XML read error at line %1, column %2: %3&quot;).arg(e.lineNumber()).arg(e.columnNumber()).arg(e.name().toString());</a>
<a name="ln3838">            return false;</a>
<a name="ln3839">            }</a>
<a name="ln3840"> </a>
<a name="ln3841">      score-&gt;connectTies();</a>
<a name="ln3842"> </a>
<a name="ln3843">      score-&gt;setFileDivision(MScore::division);</a>
<a name="ln3844"> </a>
<a name="ln3845">      //</a>
<a name="ln3846">      //    sanity check for barLineSpan</a>
<a name="ln3847">      //</a>
<a name="ln3848">#if 0 // TODO:barline</a>
<a name="ln3849">      for (Staff* st : score-&gt;staves()) {</a>
<a name="ln3850">            int barLineSpan = st-&gt;barLineSpan();</a>
<a name="ln3851">            int idx = st-&gt;idx();</a>
<a name="ln3852">            int n = score-&gt;nstaves();</a>
<a name="ln3853">            if (idx + barLineSpan &gt; n) {</a>
<a name="ln3854">                  qDebug(&quot;bad span: idx %d  span %d staves %d&quot;, idx, barLineSpan, n);</a>
<a name="ln3855">                  // span until last staff</a>
<a name="ln3856">                  barLineSpan = n - idx;</a>
<a name="ln3857">                  st-&gt;setBarLineSpan(barLineSpan);</a>
<a name="ln3858">                  }</a>
<a name="ln3859">            else if (idx == 0 &amp;&amp; barLineSpan == 0) {</a>
<a name="ln3860">                  qDebug(&quot;bad span: idx %d  span %d staves %d&quot;, idx, barLineSpan, n);</a>
<a name="ln3861">                  // span from the first staff until the start of the next span</a>
<a name="ln3862">                  barLineSpan = 1;</a>
<a name="ln3863">                  for (int i = 1; i &lt; n; ++i) {</a>
<a name="ln3864">                        if (score-&gt;staff(i)-&gt;barLineSpan() == 0)</a>
<a name="ln3865">                              ++barLineSpan;</a>
<a name="ln3866">                        else</a>
<a name="ln3867">                              break;</a>
<a name="ln3868">                        }</a>
<a name="ln3869">                  st-&gt;setBarLineSpan(barLineSpan);</a>
<a name="ln3870">                  }</a>
<a name="ln3871">            // check spanFrom</a>
<a name="ln3872">            int minBarLineFrom = st-&gt;lines(0) == 1 ? BARLINE_SPAN_1LINESTAFF_FROM : MIN_BARLINE_SPAN_FROMTO;</a>
<a name="ln3873">            if (st-&gt;barLineFrom() &lt; minBarLineFrom)</a>
<a name="ln3874">                  st-&gt;setBarLineFrom(minBarLineFrom);</a>
<a name="ln3875">            if (st-&gt;barLineFrom() &gt; st-&gt;lines(0) * 2)</a>
<a name="ln3876">                  st-&gt;setBarLineFrom(st-&gt;lines(0) * 2);</a>
<a name="ln3877">            // check spanTo</a>
<a name="ln3878">            Staff* stTo = st-&gt;barLineSpan() &lt;= 1 ? st : score-&gt;staff(idx + st-&gt;barLineSpan() - 1);</a>
<a name="ln3879">            // 1-line staves have special bar line spans</a>
<a name="ln3880">            int maxBarLineTo        = stTo-&gt;lines(0) == 1 ? BARLINE_SPAN_1LINESTAFF_TO : stTo-&gt;lines(0)*2;</a>
<a name="ln3881">            int defaultBarLineTo    = stTo-&gt;lines(0) == 1 ? BARLINE_SPAN_1LINESTAFF_TO : (stTo-&gt;lines(0) - 1) * 2;</a>
<a name="ln3882">            if (st-&gt;barLineTo() == UNKNOWN_BARLINE_TO)</a>
<a name="ln3883">                  st-&gt;setBarLineTo(defaultBarLineTo);</a>
<a name="ln3884">            if (st-&gt;barLineTo() &lt; MIN_BARLINE_SPAN_FROMTO)</a>
<a name="ln3885">                  st-&gt;setBarLineTo(MIN_BARLINE_SPAN_FROMTO);</a>
<a name="ln3886">            if (st-&gt;barLineTo() &gt; maxBarLineTo)</a>
<a name="ln3887">                  st-&gt;setBarLineTo(maxBarLineTo);</a>
<a name="ln3888">            // on single staff span, check spanFrom and spanTo are distant enough</a>
<a name="ln3889">            if (st-&gt;barLineSpan() == 1) {</a>
<a name="ln3890">                  if (st-&gt;barLineTo() - st-&gt;barLineFrom() &lt; MIN_BARLINE_FROMTO_DIST) {</a>
<a name="ln3891">                        st-&gt;setBarLineFrom(0);</a>
<a name="ln3892">                        st-&gt;setBarLineTo(defaultBarLineTo);</a>
<a name="ln3893">                        }</a>
<a name="ln3894">                  }</a>
<a name="ln3895">            }</a>
<a name="ln3896">#endif</a>
<a name="ln3897">      score-&gt;fixTicks();</a>
<a name="ln3898">      if (score-&gt;isMaster()) {</a>
<a name="ln3899">            MasterScore* ms = static_cast&lt;MasterScore*&gt;(score);</a>
<a name="ln3900">            if (!ms-&gt;omr())</a>
<a name="ln3901">                  ms-&gt;setShowOmr(false);</a>
<a name="ln3902">            ms-&gt;rebuildMidiMapping();</a>
<a name="ln3903">            ms-&gt;updateChannel();</a>
<a name="ln3904"> //           ms-&gt;createPlayEvents();</a>
<a name="ln3905">            }</a>
<a name="ln3906">      return true;</a>
<a name="ln3907">      }</a>
<a name="ln3908"> </a>
<a name="ln3909">//---------------------------------------------------------</a>
<a name="ln3910">//   read</a>
<a name="ln3911">//  &lt;page-layout&gt;</a>
<a name="ln3912">//      &lt;page-height&gt;</a>
<a name="ln3913">//      &lt;page-width&gt;</a>
<a name="ln3914">//      &lt;landscape&gt;1&lt;/landscape&gt;</a>
<a name="ln3915">//      &lt;page-margins type=&quot;both&quot;&gt;</a>
<a name="ln3916">//         &lt;left-margin&gt;28.3465&lt;/left-margin&gt;</a>
<a name="ln3917">//         &lt;right-margin&gt;28.3465&lt;/right-margin&gt;</a>
<a name="ln3918">//         &lt;top-margin&gt;28.3465&lt;/top-margin&gt;</a>
<a name="ln3919">//         &lt;bottom-margin&gt;56.6929&lt;/bottom-margin&gt;</a>
<a name="ln3920">//         &lt;/page-margins&gt;</a>
<a name="ln3921">//      &lt;/page-layout&gt;</a>
<a name="ln3922">//---------------------------------------------------------</a>
<a name="ln3923"> </a>
<a name="ln3924">void PageFormat::read(XmlReader&amp; e)</a>
<a name="ln3925">      {</a>
<a name="ln3926">      qreal _oddRightMargin  = 0.0;</a>
<a name="ln3927">      qreal _evenRightMargin = 0.0;</a>
<a name="ln3928">      QString type;</a>
<a name="ln3929"> </a>
<a name="ln3930">      while (e.readNextStartElement()) {</a>
<a name="ln3931">            const QStringRef&amp; tag(e.name());</a>
<a name="ln3932">            if (tag == &quot;page-margins&quot;) {</a>
<a name="ln3933">                  type = e.attribute(&quot;type&quot;,&quot;both&quot;);</a>
<a name="ln3934">                  qreal lm = 0.0, rm = 0.0, tm = 0.0, bm = 0.0;</a>
<a name="ln3935">                  while (e.readNextStartElement()) {</a>
<a name="ln3936">                        const QStringRef&amp; t(e.name());</a>
<a name="ln3937">                        qreal val = e.readDouble() * 0.5 / PPI;</a>
<a name="ln3938">                        if (t == &quot;left-margin&quot;)</a>
<a name="ln3939">                              lm = val;</a>
<a name="ln3940">                        else if (t == &quot;right-margin&quot;)</a>
<a name="ln3941">                              rm = val;</a>
<a name="ln3942">                        else if (t == &quot;top-margin&quot;)</a>
<a name="ln3943">                              tm = val;</a>
<a name="ln3944">                        else if (t == &quot;bottom-margin&quot;)</a>
<a name="ln3945">                              bm = val;</a>
<a name="ln3946">                        else</a>
<a name="ln3947">                              e.unknown();</a>
<a name="ln3948">                        }</a>
<a name="ln3949">                  _twosided = type == &quot;odd&quot; || type == &quot;even&quot;;</a>
<a name="ln3950">                  if (type == &quot;odd&quot; || type == &quot;both&quot;) {</a>
<a name="ln3951">                        _oddLeftMargin   = lm;</a>
<a name="ln3952">                        _oddRightMargin  = rm;</a>
<a name="ln3953">                        _oddTopMargin    = tm;</a>
<a name="ln3954">                        _oddBottomMargin = bm;</a>
<a name="ln3955">                        }</a>
<a name="ln3956">                  if (type == &quot;even&quot; || type == &quot;both&quot;) {</a>
<a name="ln3957">                        _evenLeftMargin   = lm;</a>
<a name="ln3958">                        _evenRightMargin  = rm;</a>
<a name="ln3959">                        _evenTopMargin    = tm;</a>
<a name="ln3960">                        _evenBottomMargin = bm;</a>
<a name="ln3961">                        }</a>
<a name="ln3962">                  }</a>
<a name="ln3963">            else if (tag == &quot;page-height&quot;)</a>
<a name="ln3964">                  _size.rheight() = e.readDouble() * 0.5 / PPI;</a>
<a name="ln3965">            else if (tag == &quot;page-width&quot;)</a>
<a name="ln3966">                  _size.rwidth() = e.readDouble() * .5 / PPI;</a>
<a name="ln3967">            else</a>
<a name="ln3968">                  e.unknown();</a>
<a name="ln3969">            }</a>
<a name="ln3970">      qreal w1        = _size.width() - _oddLeftMargin - _oddRightMargin;</a>
<a name="ln3971">      qreal w2        = _size.width() - _evenLeftMargin - _evenRightMargin;</a>
<a name="ln3972">      _printableWidth = qMin(w1, w2);     // silently adjust right margins</a>
<a name="ln3973">      }</a>
<a name="ln3974"> </a>
<a name="ln3975">//---------------------------------------------------------</a>
<a name="ln3976">//   read206</a>
<a name="ln3977">//    import old version &gt; 1.3  and &lt; 3.x files</a>
<a name="ln3978">//---------------------------------------------------------</a>
<a name="ln3979"> </a>
<a name="ln3980">Score::FileError MasterScore::read206(XmlReader&amp; e)</a>
<a name="ln3981">      {</a>
<a name="ln3982">      for (unsigned int i = 0; i &lt; sizeof(style206)/sizeof(*style206); ++i)</a>
<a name="ln3983">            style().set(style206[i].idx, style206[i].val);</a>
<a name="ln3984"> </a>
<a name="ln3985">      while (e.readNextStartElement()) {</a>
<a name="ln3986">            const QStringRef&amp; tag(e.name());</a>
<a name="ln3987">            if (tag == &quot;programVersion&quot;) {</a>
<a name="ln3988">                  setMscoreVersion(e.readElementText());</a>
<a name="ln3989">                  parseVersion(mscoreVersion());</a>
<a name="ln3990">                  }</a>
<a name="ln3991">            else if (tag == &quot;programRevision&quot;)</a>
<a name="ln3992">                  setMscoreRevision(e.readIntHex());</a>
<a name="ln3993">            else if (tag == &quot;Score&quot;) {</a>
<a name="ln3994">                  if (!readScore(this, e))</a>
<a name="ln3995">                        return FileError::FILE_BAD_FORMAT;</a>
<a name="ln3996">                  }</a>
<a name="ln3997">            else if (tag == &quot;Revision&quot;) {</a>
<a name="ln3998">                  Revision* revision = new Revision;</a>
<a name="ln3999">                  revision-&gt;read(e);</a>
<a name="ln4000">                  revisions()-&gt;add(revision);</a>
<a name="ln4001">                  }</a>
<a name="ln4002">            }</a>
<a name="ln4003">      int id = 1;</a>
<a name="ln4004">      for (LinkedElements* le : e.linkIds())</a>
<a name="ln4005">            le-&gt;setLid(this, id++);</a>
<a name="ln4006"> </a>
<a name="ln4007">      for (Staff* s : staves())</a>
<a name="ln4008">            s-&gt;updateOttava();</a>
<a name="ln4009"> </a>
<a name="ln4010">      // fix segment span</a>
<a name="ln4011">      SegmentType st = SegmentType::BarLineType;</a>
<a name="ln4012">      for (Segment* s = firstSegment(st); s; s = s-&gt;next1(st)) {</a>
<a name="ln4013">            for (int staffIdx = 0; staffIdx &lt; nstaves(); ++staffIdx) {</a>
<a name="ln4014">                  BarLine* b = toBarLine(s-&gt;element(staffIdx * VOICES));</a>
<a name="ln4015">                  if (!b)</a>
<a name="ln4016">                        continue;</a>
<a name="ln4017">                  int sp = b-&gt;spanStaff();</a>
<a name="ln4018">                  if (sp &lt;= 0)</a>
<a name="ln4019">                        continue;</a>
<a name="ln4020">                  for (int span = 1; span &lt;= sp; ++span) {</a>
<a name="ln4021">                        BarLine* nb = toBarLine(s-&gt;element((staffIdx + span) * VOICES));</a>
<a name="ln4022">                        if (!nb) {</a>
<a name="ln4023">                              nb = b-&gt;clone();</a>
<a name="ln4024">                              nb-&gt;setTrack((staffIdx + span) * VOICES);</a>
<a name="ln4025">                              s-&gt;add(nb);</a>
<a name="ln4026">                              }</a>
<a name="ln4027">                        nb-&gt;setSpanStaff(sp - span);</a>
<a name="ln4028">                        }</a>
<a name="ln4029">                  staffIdx += sp;</a>
<a name="ln4030">                  }</a>
<a name="ln4031">            }</a>
<a name="ln4032">      for (int staffIdx = 0; staffIdx &lt; nstaves(); ++staffIdx) {</a>
<a name="ln4033">            Staff* s = staff(staffIdx);</a>
<a name="ln4034">            int sp = s-&gt;barLineSpan();</a>
<a name="ln4035">            if (sp &lt;= 0)</a>
<a name="ln4036">                  continue;</a>
<a name="ln4037">            for (int span = 1; span &lt;= sp; ++span) {</a>
<a name="ln4038">                  Staff* ns = staff(staffIdx + span);</a>
<a name="ln4039">                  ns-&gt;setBarLineSpan(sp - span);</a>
<a name="ln4040">                  }</a>
<a name="ln4041">            staffIdx += sp;</a>
<a name="ln4042">            }</a>
<a name="ln4043"> </a>
<a name="ln4044">      // fix positions</a>
<a name="ln4045">      //    offset = saved offset - layout position</a>
<a name="ln4046">      doLayout();</a>
<a name="ln4047">      for (auto i : e.fixOffsets()) {</a>
<a name="ln4048">            i.first-&gt;setOffset(i.second - i.first-&gt;pos());</a>
<a name="ln4049">            }</a>
<a name="ln4050"> </a>
<a name="ln4051">      // treat reading a 2.06 file as import</a>
<a name="ln4052">      // on save warn if old file will be overwritten</a>
<a name="ln4053">      setCreated(true);</a>
<a name="ln4054">      // don't autosave (as long as there's no change to the score)</a>
<a name="ln4055">      setAutosaveDirty(false);</a>
<a name="ln4056"> </a>
<a name="ln4057">      return FileError::FILE_NO_ERROR;</a>
<a name="ln4058">      }</a>
<a name="ln4059"> </a>
<a name="ln4060">}</a>
<a name="ln4061"> </a>

</code></pre>
<div class="balloon" rel="485"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="498"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="631"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="798"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="1515"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v774/" target="_blank">V774</a> The 'sp' pointer was used after the memory was released.</p></div>
<div class="balloon" rel="1631"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="1647"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="1954"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="2059"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="2628"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="2668"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="2786"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="3644"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="3828"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
