
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>hairpin.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2011 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;hairpin.h&quot;</a>
<a name="ln14">#include &quot;style.h&quot;</a>
<a name="ln15">#include &quot;xml.h&quot;</a>
<a name="ln16">#include &quot;utils.h&quot;</a>
<a name="ln17">#include &quot;score.h&quot;</a>
<a name="ln18">#include &quot;measure.h&quot;</a>
<a name="ln19">#include &quot;segment.h&quot;</a>
<a name="ln20">#include &quot;system.h&quot;</a>
<a name="ln21">#include &quot;undo.h&quot;</a>
<a name="ln22">#include &quot;staff.h&quot;</a>
<a name="ln23">#include &quot;mscore.h&quot;</a>
<a name="ln24">#include &quot;chord.h&quot;</a>
<a name="ln25">#include &quot;changeMap.h&quot;</a>
<a name="ln26"> </a>
<a name="ln27">namespace Ms {</a>
<a name="ln28"> </a>
<a name="ln29">//---------------------------------------------------------</a>
<a name="ln30">//   hairpinStyle</a>
<a name="ln31">//---------------------------------------------------------</a>
<a name="ln32"> </a>
<a name="ln33">static const ElementStyle hairpinStyle {</a>
<a name="ln34">      { Sid::hairpinFontFace,                    Pid::BEGIN_FONT_FACE            },</a>
<a name="ln35">      { Sid::hairpinFontSize,                    Pid::BEGIN_FONT_SIZE            },</a>
<a name="ln36">      { Sid::hairpinFontStyle,                   Pid::BEGIN_FONT_STYLE           },</a>
<a name="ln37">      { Sid::hairpinText,                        Pid::BEGIN_TEXT                 },</a>
<a name="ln38">      { Sid::hairpinTextAlign,                   Pid::BEGIN_TEXT_ALIGN           },</a>
<a name="ln39">      { Sid::hairpinFontFace,                    Pid::CONTINUE_FONT_FACE         },</a>
<a name="ln40">      { Sid::hairpinFontSize,                    Pid::CONTINUE_FONT_SIZE         },</a>
<a name="ln41">      { Sid::hairpinFontStyle,                   Pid::CONTINUE_FONT_STYLE        },</a>
<a name="ln42">      { Sid::hairpinText,                        Pid::CONTINUE_TEXT              },</a>
<a name="ln43">      { Sid::hairpinTextAlign,                   Pid::CONTINUE_TEXT_ALIGN        },</a>
<a name="ln44">      { Sid::hairpinFontFace,                    Pid::END_FONT_FACE              },</a>
<a name="ln45">      { Sid::hairpinFontSize,                    Pid::END_FONT_SIZE              },</a>
<a name="ln46">      { Sid::hairpinFontStyle,                   Pid::END_FONT_STYLE             },</a>
<a name="ln47">      { Sid::hairpinTextAlign,                   Pid::END_TEXT_ALIGN             },</a>
<a name="ln48">      { Sid::hairpinLineWidth,                   Pid::LINE_WIDTH                 },</a>
<a name="ln49">      { Sid::hairpinHeight,                      Pid::HAIRPIN_HEIGHT             },</a>
<a name="ln50">      { Sid::hairpinContHeight,                  Pid::HAIRPIN_CONT_HEIGHT        },</a>
<a name="ln51">      { Sid::hairpinPlacement,                   Pid::PLACEMENT                  },</a>
<a name="ln52">      { Sid::hairpinPosBelow,                    Pid::OFFSET                     },</a>
<a name="ln53">      { Sid::hairpinLineStyle,                   Pid::LINE_STYLE                 },</a>
<a name="ln54">      };</a>
<a name="ln55"> </a>
<a name="ln56">//---------------------------------------------------------</a>
<a name="ln57">//   HairpinSegment</a>
<a name="ln58">//---------------------------------------------------------</a>
<a name="ln59"> </a>
<a name="ln60">HairpinSegment::HairpinSegment(Spanner* sp, Score* s)</a>
<a name="ln61">   : TextLineBaseSegment(sp, s, ElementFlag::MOVABLE | ElementFlag::ON_STAFF)</a>
<a name="ln62">      {</a>
<a name="ln63">      }</a>
<a name="ln64"> </a>
<a name="ln65">bool HairpinSegment::acceptDrop(EditData&amp; data) const</a>
<a name="ln66">      {</a>
<a name="ln67">      Element* e = data.dropElement;</a>
<a name="ln68">      if (e-&gt;isDynamic())</a>
<a name="ln69">            return true;</a>
<a name="ln70">      return false;</a>
<a name="ln71">      }</a>
<a name="ln72"> </a>
<a name="ln73">Element* HairpinSegment::drop(EditData&amp; data)</a>
<a name="ln74">      {</a>
<a name="ln75">      Element* e = data.dropElement;</a>
<a name="ln76">      if (e-&gt;isDynamic()) {</a>
<a name="ln77">            Dynamic* d = toDynamic(e);</a>
<a name="ln78">            hairpin()-&gt;undoChangeProperty(Pid::END_TEXT, d-&gt;xmlText());</a>
<a name="ln79">            }</a>
<a name="ln80">      return 0;</a>
<a name="ln81">      }</a>
<a name="ln82"> </a>
<a name="ln83">//---------------------------------------------------------</a>
<a name="ln84">//   layout</a>
<a name="ln85">//---------------------------------------------------------</a>
<a name="ln86"> </a>
<a name="ln87">void HairpinSegment::layout()</a>
<a name="ln88">      {</a>
<a name="ln89">      const qreal _spatium = spatium();</a>
<a name="ln90">      const int _trck = track();</a>
<a name="ln91">      Dynamic* sd = nullptr;</a>
<a name="ln92">      Dynamic* ed = nullptr;</a>
<a name="ln93">      qreal dymax = hairpin()-&gt;placeBelow() ? -10000.0 : 10000.0;</a>
<a name="ln94">      if (autoplace() &amp;&amp; !score()-&gt;isPalette()) {</a>
<a name="ln95">            Segment* start = hairpin()-&gt;startSegment();</a>
<a name="ln96">            Segment* end = hairpin()-&gt;endSegment();</a>
<a name="ln97">            // Try to fit between adjacent dynamics</a>
<a name="ln98">            qreal minDynamicsDistance = score()-&gt;styleP(Sid::autoplaceHairpinDynamicsDistance) * staff()-&gt;mag(tick());</a>
<a name="ln99">            const System* sys = system();</a>
<a name="ln100">            if (isSingleType() || isBeginType()) {</a>
<a name="ln101">                  if (start &amp;&amp; start-&gt;system() == sys) {</a>
<a name="ln102">                        sd = toDynamic(start-&gt;findAnnotation(ElementType::DYNAMIC, _trck, _trck));</a>
<a name="ln103">                        if (!sd) {</a>
<a name="ln104">                              // Dynamics might have been added to the previous</a>
<a name="ln105">                              // segment rather than exactly to hairpin start,</a>
<a name="ln106">                              // search in that segment too.</a>
<a name="ln107">                              start = start-&gt;prev(SegmentType::ChordRest);</a>
<a name="ln108">                              if (start &amp;&amp; start-&gt;system() == sys)</a>
<a name="ln109">                                    sd = toDynamic(start-&gt;findAnnotation(ElementType::DYNAMIC, _trck, _trck));</a>
<a name="ln110">                              }</a>
<a name="ln111">                        }</a>
<a name="ln112">                  if (sd &amp;&amp; sd-&gt;addToSkyline() &amp;&amp; sd-&gt;placement() == hairpin()-&gt;placement()) {</a>
<a name="ln113">                        const qreal sdRight = sd-&gt;bbox().right() + sd-&gt;pos().x()</a>
<a name="ln114">                                              + sd-&gt;segment()-&gt;pos().x() + sd-&gt;measure()-&gt;pos().x();</a>
<a name="ln115">                        const qreal dist    = qMax(sdRight - pos().x() + minDynamicsDistance, 0.0);</a>
<a name="ln116">                        rxpos()  += dist;</a>
<a name="ln117">                        rxpos2() -= dist;</a>
<a name="ln118">                        // prepare to align vertically</a>
<a name="ln119">                        dymax = sd-&gt;pos().y();</a>
<a name="ln120">                        }</a>
<a name="ln121">                  }</a>
<a name="ln122">            if (isSingleType() || isEndType()) {</a>
<a name="ln123">                  if (end &amp;&amp; end-&gt;tick() &lt; sys-&gt;endTick() &amp;&amp; start != end) {</a>
<a name="ln124">                        // checking ticks rather than systems</a>
<a name="ln125">                        // systems may be unknown at layout stage.</a>
<a name="ln126">                        ed = toDynamic(end-&gt;findAnnotation(ElementType::DYNAMIC, _trck, _trck));</a>
<a name="ln127">                        }</a>
<a name="ln128">                  if (ed &amp;&amp; ed-&gt;addToSkyline() &amp;&amp; ed-&gt;placement() == hairpin()-&gt;placement()) {</a>
<a name="ln129">                        const qreal edLeft  = ed-&gt;bbox().left() + ed-&gt;pos().x()</a>
<a name="ln130">                                              + ed-&gt;segment()-&gt;pos().x() + ed-&gt;measure()-&gt;pos().x();</a>
<a name="ln131">                        const qreal dist    = edLeft - pos2().x() - pos().x() - minDynamicsDistance;</a>
<a name="ln132">                        const qreal extendThreshold = 3.0 * _spatium;   // TODO: style setting</a>
<a name="ln133">                        if (dist &lt; 0.0)</a>
<a name="ln134">                              rxpos2() += dist;       // always shorten</a>
<a name="ln135">                        else if (dist &gt;= extendThreshold &amp;&amp; hairpin()-&gt;endText().isEmpty() &amp;&amp; minDynamicsDistance &gt; 0.0)</a>
<a name="ln136">                              rxpos2() += dist;       // lengthen only if appropriate</a>
<a name="ln137">                        // prepare to align vertically</a>
<a name="ln138">                        if (hairpin()-&gt;placeBelow())</a>
<a name="ln139">                              dymax = qMax(dymax, ed-&gt;pos().y());</a>
<a name="ln140">                        else</a>
<a name="ln141">                              dymax = qMin(dymax, ed-&gt;pos().y());</a>
<a name="ln142">                        }</a>
<a name="ln143">                  }</a>
<a name="ln144">            }</a>
<a name="ln145"> </a>
<a name="ln146">      HairpinType type = hairpin()-&gt;hairpinType();</a>
<a name="ln147">      if (hairpin()-&gt;isLineType()) {</a>
<a name="ln148">            twoLines = false;</a>
<a name="ln149">            TextLineBaseSegment::layout();</a>
<a name="ln150">            drawCircledTip   = false;</a>
<a name="ln151">            circledTipRadius = 0.0;</a>
<a name="ln152">            }</a>
<a name="ln153">      else {</a>
<a name="ln154">            twoLines  = true;</a>
<a name="ln155"> </a>
<a name="ln156">            hairpin()-&gt;setBeginTextAlign(Align::LEFT | Align::VCENTER);</a>
<a name="ln157">            hairpin()-&gt;setEndTextAlign(Align::RIGHT | Align::VCENTER);</a>
<a name="ln158"> </a>
<a name="ln159">            qreal x1 = 0.0;</a>
<a name="ln160">            TextLineBaseSegment::layout();</a>
<a name="ln161">            if (!_text-&gt;empty())</a>
<a name="ln162">                  x1 = _text-&gt;width() + _spatium * .5;</a>
<a name="ln163"> </a>
<a name="ln164">            QTransform t;</a>
<a name="ln165">            qreal h1 = hairpin()-&gt;hairpinHeight().val()     * _spatium * .5;</a>
<a name="ln166">            qreal h2 = hairpin()-&gt;hairpinContHeight().val() * _spatium * .5;</a>
<a name="ln167"> </a>
<a name="ln168">            qreal x = pos2().x();</a>
<a name="ln169">            if (!_endText-&gt;empty())</a>
<a name="ln170">                  x -= (_endText-&gt;width() + _spatium * .5);       // 0.5 spatium distance</a>
<a name="ln171">            if (x &lt; _spatium)             // minimum size of hairpin</a>
<a name="ln172">                  x = _spatium;</a>
<a name="ln173">            qreal y = pos2().y();</a>
<a name="ln174">            qreal len = sqrt(x * x + y * y);</a>
<a name="ln175">            t.rotateRadians(asin(y/len));</a>
<a name="ln176"> </a>
<a name="ln177">            drawCircledTip   =  hairpin()-&gt;hairpinCircledTip();</a>
<a name="ln178">            circledTipRadius = drawCircledTip ? 0.6 * _spatium * .5 : 0.0;</a>
<a name="ln179"> </a>
<a name="ln180">            QLine l1, l2;</a>
<a name="ln181"> </a>
<a name="ln182">            switch (type) {</a>
<a name="ln183">                  case HairpinType::CRESC_HAIRPIN: {</a>
<a name="ln184">                        switch (spannerSegmentType()) {</a>
<a name="ln185">                              case SpannerSegmentType::SINGLE:</a>
<a name="ln186">                              case SpannerSegmentType::BEGIN:</a>
<a name="ln187">                                    l1.setLine(x1 + circledTipRadius * 2.0, 0.0, len, h1);</a>
<a name="ln188">                                    l2.setLine(x1 + circledTipRadius * 2.0, 0.0, len, -h1);</a>
<a name="ln189">                                    circledTip.setX(x1 + circledTipRadius );</a>
<a name="ln190">                                    circledTip.setY(0.0);</a>
<a name="ln191">                                    break;</a>
<a name="ln192"> </a>
<a name="ln193">                              case SpannerSegmentType::MIDDLE:</a>
<a name="ln194">                              case SpannerSegmentType::END:</a>
<a name="ln195">                                    drawCircledTip = false;</a>
<a name="ln196">                                    l1.setLine(x1,  h2, len, h1);</a>
<a name="ln197">                                    l2.setLine(x1, -h2, len, -h1);</a>
<a name="ln198">                                    break;</a>
<a name="ln199">                              }</a>
<a name="ln200">                        }</a>
<a name="ln201">                        break;</a>
<a name="ln202">                  case HairpinType::DECRESC_HAIRPIN: {</a>
<a name="ln203">                        switch (spannerSegmentType()) {</a>
<a name="ln204">                              case SpannerSegmentType::SINGLE:</a>
<a name="ln205">                              case SpannerSegmentType::END:</a>
<a name="ln206">                                    l1.setLine(x1,  h1, len - circledTipRadius * 2, 0.0);</a>
<a name="ln207">                                    l2.setLine(x1, -h1, len - circledTipRadius * 2, 0.0);</a>
<a name="ln208">                                    circledTip.setX(len - circledTipRadius);</a>
<a name="ln209">                                    circledTip.setY(0.0);</a>
<a name="ln210">                                    break;</a>
<a name="ln211">                              case SpannerSegmentType::BEGIN:</a>
<a name="ln212">                              case SpannerSegmentType::MIDDLE:</a>
<a name="ln213">                                    drawCircledTip = false;</a>
<a name="ln214">                                    l1.setLine(x1,  h1, len, + h2);</a>
<a name="ln215">                                    l2.setLine(x1, -h1, len, - h2);</a>
<a name="ln216">                                    break;</a>
<a name="ln217">                              }</a>
<a name="ln218">                        }</a>
<a name="ln219">                        break;</a>
<a name="ln220">                  default:</a>
<a name="ln221">                        break;</a>
<a name="ln222">                  }</a>
<a name="ln223"> </a>
<a name="ln224">            // Do Coord rotation</a>
<a name="ln225">            l1 = t.map(l1);</a>
<a name="ln226">            l2 = t.map(l2);</a>
<a name="ln227">            if (drawCircledTip )</a>
<a name="ln228">                  circledTip = t.map(circledTip);</a>
<a name="ln229"> </a>
<a name="ln230">            points[0] = l1.p1();</a>
<a name="ln231">            points[1] = l1.p2();</a>
<a name="ln232">            points[2] = l2.p1();</a>
<a name="ln233">            points[3] = l2.p2();</a>
<a name="ln234">            npoints   = 4;</a>
<a name="ln235"> </a>
<a name="ln236">            QRectF r = QRectF(l1.p1(), l1.p2()).normalized() | QRectF(l2.p1(), l2.p2()).normalized();</a>
<a name="ln237">            if (!_text-&gt;empty())</a>
<a name="ln238">                  r |= _text-&gt;bbox();</a>
<a name="ln239">            if (!_endText-&gt;empty())</a>
<a name="ln240">                  r |= _endText-&gt;bbox().translated(x + _endText-&gt;bbox().width(), 0.0);</a>
<a name="ln241">            qreal w  = point(score()-&gt;styleS(Sid::hairpinLineWidth));</a>
<a name="ln242">            setbbox(r.adjusted(-w*.5, -w*.5, w, w));</a>
<a name="ln243">            }</a>
<a name="ln244">      if (!parent()) {</a>
<a name="ln245">            rpos() = QPointF();</a>
<a name="ln246">            roffset() = QPointF();</a>
<a name="ln247">            return;</a>
<a name="ln248">            }</a>
<a name="ln249"> </a>
<a name="ln250">      if (isStyled(Pid::OFFSET))</a>
<a name="ln251">            roffset() = hairpin()-&gt;propertyDefault(Pid::OFFSET).toPointF();</a>
<a name="ln252"> </a>
<a name="ln253">      // rebase vertical offset on drag</a>
<a name="ln254">      qreal rebase = 0.0;</a>
<a name="ln255">      if (offsetChanged() != OffsetChange::NONE)</a>
<a name="ln256">            rebase = rebaseOffset();</a>
<a name="ln257"> </a>
<a name="ln258">      if (autoplace()) {</a>
<a name="ln259">            qreal ymax = pos().y();</a>
<a name="ln260">            qreal d;</a>
<a name="ln261">            qreal ddiff = hairpin()-&gt;isLineType() ? 0.0 : _spatium * 0.5;</a>
<a name="ln262"> </a>
<a name="ln263">            qreal sp = spatium();</a>
<a name="ln264">            qreal md = minDistance().val() * sp;</a>
<a name="ln265"> </a>
<a name="ln266">            bool above = spanner()-&gt;placeAbove();</a>
<a name="ln267">            SkylineLine sl(!above);</a>
<a name="ln268">            Shape sh = shape();</a>
<a name="ln269">            sl.add(sh.translated(pos()));</a>
<a name="ln270">            if (above) {</a>
<a name="ln271">                  d  = system()-&gt;topDistance(staffIdx(), sl);</a>
<a name="ln272">                  if (d &gt; -md)</a>
<a name="ln273">                        ymax -= d + md;</a>
<a name="ln274">                  // align hairpin with dynamics</a>
<a name="ln275">                  if (!hairpin()-&gt;diagonal())</a>
<a name="ln276">                        ymax = qMin(ymax, dymax - ddiff);</a>
<a name="ln277">                  }</a>
<a name="ln278">            else {</a>
<a name="ln279">                  d  = system()-&gt;bottomDistance(staffIdx(), sl);</a>
<a name="ln280">                  if (d &gt; -md)</a>
<a name="ln281">                        ymax += d + md;</a>
<a name="ln282">                  // align hairpin with dynamics</a>
<a name="ln283">                  if (!hairpin()-&gt;diagonal())</a>
<a name="ln284">                        ymax = qMax(ymax, dymax - ddiff);</a>
<a name="ln285">                  }</a>
<a name="ln286">            qreal yd = ymax - pos().y();</a>
<a name="ln287">            if (yd != 0.0) {</a>
<a name="ln288">                  if (offsetChanged() != OffsetChange::NONE) {</a>
<a name="ln289">                        // user moved element within the skyline</a>
<a name="ln290">                        // we may need to adjust minDistance, yd, and/or offset</a>
<a name="ln291">                        qreal adj = pos().y() + rebase;</a>
<a name="ln292">                        bool inStaff = above ? sh.bottom() + adj &gt; 0.0 : sh.top() + adj &lt; staff()-&gt;height();</a>
<a name="ln293">                        rebaseMinDistance(md, yd, sp, rebase, above, inStaff);</a>
<a name="ln294">                        }</a>
<a name="ln295">                  rypos() += yd;</a>
<a name="ln296">                  }</a>
<a name="ln297"> </a>
<a name="ln298">            if (hairpin()-&gt;addToSkyline() &amp;&amp; !hairpin()-&gt;diagonal()) {</a>
<a name="ln299">                  // align dynamics with hairpin</a>
<a name="ln300">                  if (sd &amp;&amp; sd-&gt;autoplace() &amp;&amp; sd-&gt;placement() == hairpin()-&gt;placement()) {</a>
<a name="ln301">                        qreal ny = y() + ddiff - sd-&gt;offset().y();</a>
<a name="ln302">                        if (sd-&gt;placeAbove())</a>
<a name="ln303">                              ny = qMin(ny, sd-&gt;ipos().y());</a>
<a name="ln304">                        else</a>
<a name="ln305">                              ny = qMax(ny, sd-&gt;ipos().y());</a>
<a name="ln306">                        if (sd-&gt;ipos().y() != ny) {</a>
<a name="ln307">                              sd-&gt;rypos() = ny;</a>
<a name="ln308">                              if (sd-&gt;addToSkyline()) {</a>
<a name="ln309">                                    Segment* s = sd-&gt;segment();</a>
<a name="ln310">                                    Measure* m = s-&gt;measure();</a>
<a name="ln311">                                    QRectF r = sd-&gt;bbox().translated(sd-&gt;pos());</a>
<a name="ln312">                                    s-&gt;staffShape(sd-&gt;staffIdx()).add(r);</a>
<a name="ln313">                                    r = sd-&gt;bbox().translated(sd-&gt;pos() + s-&gt;pos() + m-&gt;pos());</a>
<a name="ln314">                                    m-&gt;system()-&gt;staff(sd-&gt;staffIdx())-&gt;skyline().add(r);</a>
<a name="ln315">                                    }</a>
<a name="ln316">                              }</a>
<a name="ln317">                        }</a>
<a name="ln318">                  if (ed &amp;&amp; ed-&gt;autoplace() &amp;&amp; ed-&gt;placement() == hairpin()-&gt;placement()) {</a>
<a name="ln319">                        qreal ny = y() + ddiff - ed-&gt;offset().y();</a>
<a name="ln320">                        if (ed-&gt;placeAbove())</a>
<a name="ln321">                              ny = qMin(ny, ed-&gt;ipos().y());</a>
<a name="ln322">                        else</a>
<a name="ln323">                              ny = qMax(ny, ed-&gt;ipos().y());</a>
<a name="ln324">                        if (ed-&gt;ipos().y() != ny) {</a>
<a name="ln325">                              ed-&gt;rypos() = ny;</a>
<a name="ln326">                              if (ed-&gt;addToSkyline()) {</a>
<a name="ln327">                                    Segment* s = ed-&gt;segment();</a>
<a name="ln328">                                    Measure* m = s-&gt;measure();</a>
<a name="ln329">                                    QRectF r = ed-&gt;bbox().translated(ed-&gt;pos());</a>
<a name="ln330">                                    s-&gt;staffShape(ed-&gt;staffIdx()).add(r);</a>
<a name="ln331">                                    r = ed-&gt;bbox().translated(ed-&gt;pos() + s-&gt;pos() + m-&gt;pos());</a>
<a name="ln332">                                    m-&gt;system()-&gt;staff(ed-&gt;staffIdx())-&gt;skyline().add(r);</a>
<a name="ln333">                                    }</a>
<a name="ln334">                              }</a>
<a name="ln335">                        }</a>
<a name="ln336">                  }</a>
<a name="ln337">            }</a>
<a name="ln338">      setOffsetChanged(false);</a>
<a name="ln339">      }</a>
<a name="ln340"> </a>
<a name="ln341">//---------------------------------------------------------</a>
<a name="ln342">//   shape</a>
<a name="ln343">//---------------------------------------------------------</a>
<a name="ln344"> </a>
<a name="ln345">Shape HairpinSegment::shape() const</a>
<a name="ln346">      {</a>
<a name="ln347">      switch (hairpin()-&gt;hairpinType()) {</a>
<a name="ln348">            case HairpinType::CRESC_HAIRPIN:</a>
<a name="ln349">            case HairpinType::DECRESC_HAIRPIN:</a>
<a name="ln350">                  return Shape(bbox());</a>
<a name="ln351">            case HairpinType::DECRESC_LINE:</a>
<a name="ln352">            case HairpinType::CRESC_LINE:</a>
<a name="ln353">            default:</a>
<a name="ln354">                  return TextLineBaseSegment::shape();</a>
<a name="ln355">            }</a>
<a name="ln356">      }</a>
<a name="ln357"> </a>
<a name="ln358">//---------------------------------------------------------</a>
<a name="ln359">//   gripsPositions</a>
<a name="ln360">//---------------------------------------------------------</a>
<a name="ln361"> </a>
<a name="ln362">std::vector&lt;QPointF&gt; HairpinSegment::gripsPositions(const EditData&amp;) const</a>
<a name="ln363">      {</a>
<a name="ln364">      qreal _spatium = spatium();</a>
<a name="ln365">      qreal x = pos2().x();</a>
<a name="ln366">      if (x &lt; _spatium)             // minimum size of hairpin</a>
<a name="ln367">            x = _spatium;</a>
<a name="ln368">      qreal y = pos2().y();</a>
<a name="ln369">      QPointF p(x, y);</a>
<a name="ln370"> </a>
<a name="ln371">      // Calc QPointF for Grip Aperture</a>
<a name="ln372">      QTransform doRotation;</a>
<a name="ln373">      QPointF gripLineAperturePoint;</a>
<a name="ln374">      qreal h1 = hairpin()-&gt;hairpinHeight().val() * spatium() * .5;</a>
<a name="ln375">      qreal len = sqrt( x * x + y * y );</a>
<a name="ln376">      doRotation.rotateRadians(asin(y/len));</a>
<a name="ln377">      qreal lineApertureX;</a>
<a name="ln378">      qreal offsetX = 10;                               // Horizontal offset for x Grip</a>
<a name="ln379">      if (len &lt; offsetX * 3)                            // For small hairpin, offset = 30% of len</a>
<a name="ln380">          offsetX = len/3;                              // else offset is fixed to 10</a>
<a name="ln381"> </a>
<a name="ln382">      if (hairpin()-&gt;hairpinType() == HairpinType::CRESC_HAIRPIN)</a>
<a name="ln383">            lineApertureX = len - offsetX;              // End of CRESCENDO - Offset</a>
<a name="ln384">      else</a>
<a name="ln385">            lineApertureX = offsetX;                    // Begin of DECRESCENDO + Offset</a>
<a name="ln386">      qreal lineApertureH = ( len - offsetX ) * h1/len; // Vertical position for y grip</a>
<a name="ln387">      gripLineAperturePoint.setX( lineApertureX );</a>
<a name="ln388">      gripLineAperturePoint.setY( lineApertureH );</a>
<a name="ln389">      gripLineAperturePoint = doRotation.map(gripLineAperturePoint);</a>
<a name="ln390"> </a>
<a name="ln391">      std::vector&lt;QPointF&gt; grips(gripsCount());</a>
<a name="ln392"> </a>
<a name="ln393">      // End calc position grip aperture</a>
<a name="ln394">      QPointF pp(pagePos());</a>
<a name="ln395">      grips[int(Grip::START)] = pp;</a>
<a name="ln396">      grips[int(Grip::END)] = p + pp;</a>
<a name="ln397">      grips[int(Grip::MIDDLE)] = p * .5 + pp;</a>
<a name="ln398">      grips[int(Grip::APERTURE)] = gripLineAperturePoint + pp;</a>
<a name="ln399"> </a>
<a name="ln400">      return grips;</a>
<a name="ln401">      }</a>
<a name="ln402"> </a>
<a name="ln403">//---------------------------------------------------------</a>
<a name="ln404">//   startEditDrag</a>
<a name="ln405">//---------------------------------------------------------</a>
<a name="ln406"> </a>
<a name="ln407">void HairpinSegment::startEditDrag(EditData&amp; ed)</a>
<a name="ln408">      {</a>
<a name="ln409">      TextLineBaseSegment::startEditDrag(ed);</a>
<a name="ln410">      ElementEditData* eed = ed.getData(this);</a>
<a name="ln411"> </a>
<a name="ln412">      eed-&gt;pushProperty(Pid::HAIRPIN_HEIGHT);</a>
<a name="ln413">      eed-&gt;pushProperty(Pid::HAIRPIN_CONT_HEIGHT);</a>
<a name="ln414">      }</a>
<a name="ln415"> </a>
<a name="ln416">//---------------------------------------------------------</a>
<a name="ln417">//   editDrag</a>
<a name="ln418">//---------------------------------------------------------</a>
<a name="ln419"> </a>
<a name="ln420">void HairpinSegment::editDrag(EditData&amp; ed)</a>
<a name="ln421">      {</a>
<a name="ln422">      if (ed.curGrip == Grip::APERTURE) {</a>
<a name="ln423">            qreal newHeight = hairpin()-&gt;hairpinHeight().val() + ed.delta.y()/spatium()/.5;</a>
<a name="ln424">            if (newHeight &lt; 0.5)</a>
<a name="ln425">                  newHeight = 0.5;</a>
<a name="ln426">            hairpin()-&gt;setHairpinHeight(Spatium(newHeight));</a>
<a name="ln427">            triggerLayout();</a>
<a name="ln428">            }</a>
<a name="ln429">      TextLineBaseSegment::editDrag(ed);</a>
<a name="ln430">      }</a>
<a name="ln431"> </a>
<a name="ln432">//---------------------------------------------------------</a>
<a name="ln433">//   draw</a>
<a name="ln434">//---------------------------------------------------------</a>
<a name="ln435"> </a>
<a name="ln436">void HairpinSegment::draw(QPainter* painter) const</a>
<a name="ln437">      {</a>
<a name="ln438">      TextLineBaseSegment::draw(painter);</a>
<a name="ln439"> </a>
<a name="ln440">#if 0</a>
<a name="ln441">      QColor color;</a>
<a name="ln442">      if ((selected() &amp;&amp; !(score() &amp;&amp; score()-&gt;printing())) || !hairpin()-&gt;visible())</a>
<a name="ln443">            color = curColor();</a>
<a name="ln444">      else</a>
<a name="ln445">            color = hairpin()-&gt;lineColor();</a>
<a name="ln446">#endif</a>
<a name="ln447">      QColor color = curColor(hairpin()-&gt;visible(), hairpin()-&gt;lineColor());</a>
<a name="ln448">      qreal w = hairpin()-&gt;lineWidth();</a>
<a name="ln449">      if (staff())</a>
<a name="ln450">            w *= staff()-&gt;mag(hairpin()-&gt;tick());</a>
<a name="ln451">      QPen pen(color, w, hairpin()-&gt;lineStyle());</a>
<a name="ln452">      painter-&gt;setPen(pen);</a>
<a name="ln453"> </a>
<a name="ln454">      if (drawCircledTip) {</a>
<a name="ln455">            painter-&gt;setBrush(Qt::NoBrush);</a>
<a name="ln456">            painter-&gt;drawEllipse( circledTip,circledTipRadius,circledTipRadius );</a>
<a name="ln457">            }</a>
<a name="ln458">      }</a>
<a name="ln459"> </a>
<a name="ln460">//---------------------------------------------------------</a>
<a name="ln461">//   propertyDelegate</a>
<a name="ln462">//---------------------------------------------------------</a>
<a name="ln463"> </a>
<a name="ln464">Element* HairpinSegment::propertyDelegate(Pid pid)</a>
<a name="ln465">      {</a>
<a name="ln466">      if (pid == Pid::HAIRPIN_TYPE</a>
<a name="ln467">         || pid == Pid::VELO_CHANGE</a>
<a name="ln468">         || pid == Pid::VELO_CHANGE_METHOD</a>
<a name="ln469">         || pid == Pid::SINGLE_NOTE_DYNAMICS</a>
<a name="ln470">         || pid == Pid::HAIRPIN_CIRCLEDTIP</a>
<a name="ln471">         || pid == Pid::HAIRPIN_HEIGHT</a>
<a name="ln472">         || pid == Pid::HAIRPIN_CONT_HEIGHT</a>
<a name="ln473">         || pid == Pid::DYNAMIC_RANGE</a>
<a name="ln474">         || pid == Pid::LINE_STYLE</a>
<a name="ln475">            )</a>
<a name="ln476">            return spanner();</a>
<a name="ln477">      return TextLineBaseSegment::propertyDelegate(pid);</a>
<a name="ln478">      }</a>
<a name="ln479"> </a>
<a name="ln480">//---------------------------------------------------------</a>
<a name="ln481">//   getPropertyStyle</a>
<a name="ln482">//---------------------------------------------------------</a>
<a name="ln483"> </a>
<a name="ln484">Sid HairpinSegment::getPropertyStyle(Pid pid) const</a>
<a name="ln485">      {</a>
<a name="ln486">      switch (pid) {</a>
<a name="ln487">            case Pid::OFFSET:</a>
<a name="ln488">                  if (hairpin()-&gt;isLineType())</a>
<a name="ln489">                        return spanner()-&gt;placeAbove() ? Sid::hairpinLinePosAbove : Sid::hairpinLinePosBelow;</a>
<a name="ln490">                  return spanner()-&gt;placeAbove() ? Sid::hairpinPosAbove : Sid::hairpinPosBelow;</a>
<a name="ln491">            case Pid::BEGIN_TEXT:</a>
<a name="ln492">                  switch (hairpin()-&gt;hairpinType()) {</a>
<a name="ln493">                        default:</a>
<a name="ln494">                              return Sid::hairpinText;</a>
<a name="ln495">                        case HairpinType::CRESC_LINE:</a>
<a name="ln496">                              return Sid::hairpinCrescText;</a>
<a name="ln497">                        case HairpinType::DECRESC_LINE:</a>
<a name="ln498">                              return Sid::hairpinDecrescText;</a>
<a name="ln499">                        }</a>
<a name="ln500">                  break;</a>
<a name="ln501">            case Pid::CONTINUE_TEXT:</a>
<a name="ln502">                  switch (hairpin()-&gt;hairpinType()) {</a>
<a name="ln503">                        default:</a>
<a name="ln504">                              return Sid::hairpinText;</a>
<a name="ln505">                        case HairpinType::CRESC_LINE:</a>
<a name="ln506">                              return Sid::hairpinCrescContText;</a>
<a name="ln507">                        case HairpinType::DECRESC_LINE:</a>
<a name="ln508">                              return Sid::hairpinDecrescContText;</a>
<a name="ln509">                        }</a>
<a name="ln510">                  break;</a>
<a name="ln511">            case Pid::LINE_STYLE:</a>
<a name="ln512">                  return hairpin()-&gt;isLineType() ? Sid::hairpinLineLineStyle : Sid::hairpinLineStyle;</a>
<a name="ln513">            default:</a>
<a name="ln514">                  break;</a>
<a name="ln515">            }</a>
<a name="ln516">      return TextLineBaseSegment::getPropertyStyle(pid);</a>
<a name="ln517">      }</a>
<a name="ln518"> </a>
<a name="ln519">Sid Hairpin::getPropertyStyle(Pid pid) const</a>
<a name="ln520">      {</a>
<a name="ln521">      switch (pid) {</a>
<a name="ln522">            case Pid::OFFSET:</a>
<a name="ln523">                  if (isLineType())</a>
<a name="ln524">                        return placeAbove() ? Sid::hairpinLinePosAbove : Sid::hairpinLinePosBelow;</a>
<a name="ln525">                  return placeAbove() ? Sid::hairpinPosAbove : Sid::hairpinPosBelow;</a>
<a name="ln526">            case Pid::BEGIN_TEXT:</a>
<a name="ln527">                  switch (hairpinType()) {</a>
<a name="ln528">                        default:</a>
<a name="ln529">                              return Sid::hairpinText;</a>
<a name="ln530">                        case HairpinType::CRESC_LINE:</a>
<a name="ln531">                              return Sid::hairpinCrescText;</a>
<a name="ln532">                        case HairpinType::DECRESC_LINE:</a>
<a name="ln533">                              return Sid::hairpinDecrescText;</a>
<a name="ln534">                        }</a>
<a name="ln535">                  break;</a>
<a name="ln536">            case Pid::CONTINUE_TEXT:</a>
<a name="ln537">                  switch (hairpinType()) {</a>
<a name="ln538">                        default:</a>
<a name="ln539">                              return Sid::hairpinText;</a>
<a name="ln540">                        case HairpinType::CRESC_LINE:</a>
<a name="ln541">                              return Sid::hairpinCrescContText;</a>
<a name="ln542">                        case HairpinType::DECRESC_LINE:</a>
<a name="ln543">                              return Sid::hairpinDecrescContText;</a>
<a name="ln544">                        }</a>
<a name="ln545">                  break;</a>
<a name="ln546">            case Pid::LINE_STYLE:</a>
<a name="ln547">                  return isLineType() ? Sid::hairpinLineLineStyle : Sid::hairpinLineStyle;</a>
<a name="ln548">            default:</a>
<a name="ln549">                  break;</a>
<a name="ln550">            }</a>
<a name="ln551">      return TextLineBase::getPropertyStyle(pid);</a>
<a name="ln552">      }</a>
<a name="ln553"> </a>
<a name="ln554">//---------------------------------------------------------</a>
<a name="ln555">//   Hairpin</a>
<a name="ln556">//---------------------------------------------------------</a>
<a name="ln557"> </a>
<a name="ln558">Hairpin::Hairpin(Score* s)</a>
<a name="ln559">   : TextLineBase(s)</a>
<a name="ln560">      {</a>
<a name="ln561">      initElementStyle(&amp;hairpinStyle);</a>
<a name="ln562"> </a>
<a name="ln563">      resetProperty(Pid::BEGIN_TEXT_PLACE);</a>
<a name="ln564">      resetProperty(Pid::CONTINUE_TEXT_PLACE);</a>
<a name="ln565">      resetProperty(Pid::HAIRPIN_TYPE);</a>
<a name="ln566">      resetProperty(Pid::LINE_VISIBLE);</a>
<a name="ln567"> </a>
<a name="ln568">      _hairpinCircledTip     = false;</a>
<a name="ln569">      _veloChange            = 0;</a>
<a name="ln570">      _dynRange              = Dynamic::Range::PART;</a>
<a name="ln571">      _singleNoteDynamics    = true;</a>
<a name="ln572">      _veloChangeMethod      = ChangeMethod::NORMAL;</a>
<a name="ln573">      }</a>
<a name="ln574"> </a>
<a name="ln575">//---------------------------------------------------------</a>
<a name="ln576">//   setHairpinType</a>
<a name="ln577">//---------------------------------------------------------</a>
<a name="ln578"> </a>
<a name="ln579">void Hairpin::setHairpinType(HairpinType val)</a>
<a name="ln580">      {</a>
<a name="ln581">      if (_hairpinType == val)</a>
<a name="ln582">            return;</a>
<a name="ln583">      _hairpinType = val;</a>
<a name="ln584">#if 0</a>
<a name="ln585">      switch (_hairpinType) {</a>
<a name="ln586">            case HairpinType::CRESC_HAIRPIN:</a>
<a name="ln587">            case HairpinType::DECRESC_HAIRPIN:</a>
<a name="ln588">                  setBeginText(&quot;&quot;);</a>
<a name="ln589">                  setContinueText(&quot;&quot;);</a>
<a name="ln590">                  setLineStyle(Qt::SolidLine);</a>
<a name="ln591">                  break;</a>
<a name="ln592">            case HairpinType::CRESC_LINE:</a>
<a name="ln593">                  setBeginText(&quot;cresc.&quot;);</a>
<a name="ln594">                  setContinueText(&quot;(cresc.)&quot;);</a>
<a name="ln595">                  setLineStyle(Qt::CustomDashLine);</a>
<a name="ln596">                  break;</a>
<a name="ln597">            case HairpinType::DECRESC_LINE:</a>
<a name="ln598">                  setBeginText(&quot;dim.&quot;);</a>
<a name="ln599">                  setContinueText(&quot;(dim.)&quot;);</a>
<a name="ln600">                  setLineStyle(Qt::CustomDashLine);</a>
<a name="ln601">                  break;</a>
<a name="ln602">            case HairpinType::INVALID:</a>
<a name="ln603">                  break;</a>
<a name="ln604">            };</a>
<a name="ln605">#endif</a>
<a name="ln606">      styleChanged();</a>
<a name="ln607">      }</a>
<a name="ln608"> </a>
<a name="ln609">//---------------------------------------------------------</a>
<a name="ln610">//   layout</a>
<a name="ln611">//    compute segments from tick() to _tick2</a>
<a name="ln612">//---------------------------------------------------------</a>
<a name="ln613"> </a>
<a name="ln614">void Hairpin::layout()</a>
<a name="ln615">      {</a>
<a name="ln616">      setPos(0.0, 0.0);</a>
<a name="ln617">      TextLineBase::layout();</a>
<a name="ln618">      }</a>
<a name="ln619"> </a>
<a name="ln620">//---------------------------------------------------------</a>
<a name="ln621">//   createLineSegment</a>
<a name="ln622">//---------------------------------------------------------</a>
<a name="ln623"> </a>
<a name="ln624">static const ElementStyle hairpinSegmentStyle {</a>
<a name="ln625">      { Sid::hairpinPosBelow, Pid::OFFSET },</a>
<a name="ln626">      { Sid::hairpinMinDistance, Pid::MIN_DISTANCE },</a>
<a name="ln627">      };</a>
<a name="ln628"> </a>
<a name="ln629">LineSegment* Hairpin::createLineSegment()</a>
<a name="ln630">      {</a>
<a name="ln631">      HairpinSegment* h = new HairpinSegment(this, score());</a>
<a name="ln632">      h-&gt;setTrack(track());</a>
<a name="ln633">      h-&gt;initElementStyle(&amp;hairpinSegmentStyle);</a>
<a name="ln634">      return h;</a>
<a name="ln635">      }</a>
<a name="ln636"> </a>
<a name="ln637">//---------------------------------------------------------</a>
<a name="ln638">//   write</a>
<a name="ln639">//---------------------------------------------------------</a>
<a name="ln640"> </a>
<a name="ln641">void Hairpin::write(XmlWriter&amp; xml) const</a>
<a name="ln642">      {</a>
<a name="ln643">      if (!xml.canWrite(this))</a>
<a name="ln644">            return;</a>
<a name="ln645">      xml.stag(this);</a>
<a name="ln646">      xml.tag(&quot;subtype&quot;, int(_hairpinType));</a>
<a name="ln647">      writeProperty(xml, Pid::VELO_CHANGE);</a>
<a name="ln648">      writeProperty(xml, Pid::HAIRPIN_CIRCLEDTIP);</a>
<a name="ln649">      writeProperty(xml, Pid::DYNAMIC_RANGE);</a>
<a name="ln650">//      writeProperty(xml, Pid::BEGIN_TEXT);</a>
<a name="ln651">      writeProperty(xml, Pid::END_TEXT);</a>
<a name="ln652">//      writeProperty(xml, Pid::CONTINUE_TEXT);</a>
<a name="ln653">      writeProperty(xml, Pid::LINE_VISIBLE);</a>
<a name="ln654">      writeProperty(xml, Pid::SINGLE_NOTE_DYNAMICS);</a>
<a name="ln655">      writeProperty(xml, Pid::VELO_CHANGE_METHOD);</a>
<a name="ln656"> </a>
<a name="ln657">      for (const StyledProperty&amp; spp : *styledProperties()) {</a>
<a name="ln658">            if (!isStyled(spp.pid))</a>
<a name="ln659">                  writeProperty(xml, spp.pid);</a>
<a name="ln660">            }</a>
<a name="ln661">      SLine::writeProperties(xml);</a>
<a name="ln662">      xml.etag();</a>
<a name="ln663">      }</a>
<a name="ln664"> </a>
<a name="ln665">//---------------------------------------------------------</a>
<a name="ln666">//   read</a>
<a name="ln667">//---------------------------------------------------------</a>
<a name="ln668"> </a>
<a name="ln669">void Hairpin::read(XmlReader&amp; e)</a>
<a name="ln670">      {</a>
<a name="ln671">      eraseSpannerSegments();</a>
<a name="ln672"> </a>
<a name="ln673">      while (e.readNextStartElement()) {</a>
<a name="ln674">            const QStringRef&amp; tag(e.name());</a>
<a name="ln675">            if (tag == &quot;subtype&quot;)</a>
<a name="ln676">                  setHairpinType(HairpinType(e.readInt()));</a>
<a name="ln677">            else if (readStyledProperty(e, tag))</a>
<a name="ln678">                  ;</a>
<a name="ln679">            else if (tag == &quot;hairpinCircledTip&quot;)</a>
<a name="ln680">                  _hairpinCircledTip = e.readInt();</a>
<a name="ln681">            else if (tag == &quot;veloChange&quot;)</a>
<a name="ln682">                  _veloChange = e.readInt();</a>
<a name="ln683">            else if (tag == &quot;dynType&quot;)</a>
<a name="ln684">                  _dynRange = Dynamic::Range(e.readInt());</a>
<a name="ln685">            else if (tag == &quot;useTextLine&quot;) {      // obsolete</a>
<a name="ln686">                  e.readInt();</a>
<a name="ln687">                  if (hairpinType() == HairpinType::CRESC_HAIRPIN)</a>
<a name="ln688">                        setHairpinType(HairpinType::CRESC_LINE);</a>
<a name="ln689">                  else if (hairpinType() == HairpinType::DECRESC_HAIRPIN)</a>
<a name="ln690">                        setHairpinType(HairpinType::DECRESC_LINE);</a>
<a name="ln691">                  }</a>
<a name="ln692">            else if (tag == &quot;singleNoteDynamics&quot;)</a>
<a name="ln693">                  _singleNoteDynamics = e.readBool();</a>
<a name="ln694">            else if (tag == &quot;veloChangeMethod&quot;)</a>
<a name="ln695">                  _veloChangeMethod = ChangeMap::nameToChangeMethod(e.readElementText());</a>
<a name="ln696">            else if (!TextLineBase::readProperties(e))</a>
<a name="ln697">                  e.unknown();</a>
<a name="ln698">            }</a>
<a name="ln699">      styleChanged();</a>
<a name="ln700">      }</a>
<a name="ln701"> </a>
<a name="ln702">//---------------------------------------------------------</a>
<a name="ln703">//   getProperty</a>
<a name="ln704">//---------------------------------------------------------</a>
<a name="ln705"> </a>
<a name="ln706">QVariant Hairpin::getProperty(Pid id) const</a>
<a name="ln707">      {</a>
<a name="ln708">      switch (id) {</a>
<a name="ln709">            case Pid::HAIRPIN_CIRCLEDTIP:</a>
<a name="ln710">                return _hairpinCircledTip;</a>
<a name="ln711">            case Pid::HAIRPIN_TYPE:</a>
<a name="ln712">                return int(_hairpinType);</a>
<a name="ln713">            case Pid::VELO_CHANGE:</a>
<a name="ln714">                  return _veloChange;</a>
<a name="ln715">            case Pid::DYNAMIC_RANGE:</a>
<a name="ln716">                  return int(_dynRange);</a>
<a name="ln717">            case Pid::HAIRPIN_HEIGHT:</a>
<a name="ln718">                  return _hairpinHeight;</a>
<a name="ln719">            case Pid::HAIRPIN_CONT_HEIGHT:</a>
<a name="ln720">                  return _hairpinContHeight;</a>
<a name="ln721">            case Pid::SINGLE_NOTE_DYNAMICS:</a>
<a name="ln722">                  return _singleNoteDynamics;</a>
<a name="ln723">            case Pid::VELO_CHANGE_METHOD:</a>
<a name="ln724">                  return int(_veloChangeMethod);</a>
<a name="ln725">            default:</a>
<a name="ln726">                  return TextLineBase::getProperty(id);</a>
<a name="ln727">            }</a>
<a name="ln728">      }</a>
<a name="ln729"> </a>
<a name="ln730">//---------------------------------------------------------</a>
<a name="ln731">//   setProperty</a>
<a name="ln732">//---------------------------------------------------------</a>
<a name="ln733"> </a>
<a name="ln734">bool Hairpin::setProperty(Pid id, const QVariant&amp; v)</a>
<a name="ln735">      {</a>
<a name="ln736">      switch (id) {</a>
<a name="ln737">            case Pid::HAIRPIN_CIRCLEDTIP:</a>
<a name="ln738">                _hairpinCircledTip = v.toBool();</a>
<a name="ln739">                break;</a>
<a name="ln740">            case Pid::HAIRPIN_TYPE:</a>
<a name="ln741">                  setHairpinType(HairpinType(v.toInt()));</a>
<a name="ln742">                  break;</a>
<a name="ln743">            case Pid::VELO_CHANGE:</a>
<a name="ln744">                  _veloChange = v.toInt();</a>
<a name="ln745">                  break;</a>
<a name="ln746">            case Pid::DYNAMIC_RANGE:</a>
<a name="ln747">                  _dynRange = Dynamic::Range(v.toInt());</a>
<a name="ln748">                  break;</a>
<a name="ln749">            case Pid::HAIRPIN_HEIGHT:</a>
<a name="ln750">                  _hairpinHeight = v.value&lt;Spatium&gt;();</a>
<a name="ln751">                  break;</a>
<a name="ln752">            case Pid::HAIRPIN_CONT_HEIGHT:</a>
<a name="ln753">                  _hairpinContHeight = v.value&lt;Spatium&gt;();</a>
<a name="ln754">                  break;</a>
<a name="ln755">            case Pid::SINGLE_NOTE_DYNAMICS:</a>
<a name="ln756">                  _singleNoteDynamics = v.toBool();</a>
<a name="ln757">                  break;</a>
<a name="ln758">            case Pid::VELO_CHANGE_METHOD:</a>
<a name="ln759">                  _veloChangeMethod = ChangeMethod(v.toInt());</a>
<a name="ln760">                  break;</a>
<a name="ln761">            default:</a>
<a name="ln762">                  return TextLineBase::setProperty(id, v);</a>
<a name="ln763">            }</a>
<a name="ln764">      triggerLayout();</a>
<a name="ln765">      return true;</a>
<a name="ln766">      }</a>
<a name="ln767"> </a>
<a name="ln768">//---------------------------------------------------------</a>
<a name="ln769">//   propertyDefault</a>
<a name="ln770">//---------------------------------------------------------</a>
<a name="ln771"> </a>
<a name="ln772">QVariant Hairpin::propertyDefault(Pid id) const</a>
<a name="ln773">      {</a>
<a name="ln774">      switch (id) {</a>
<a name="ln775">            case Pid::HAIRPIN_CIRCLEDTIP:</a>
<a name="ln776">                  return false;</a>
<a name="ln777"> </a>
<a name="ln778">            case Pid::VELO_CHANGE:</a>
<a name="ln779">                  return 0;</a>
<a name="ln780"> </a>
<a name="ln781">            case Pid::DYNAMIC_RANGE:</a>
<a name="ln782">                  return int(Dynamic::Range::PART);</a>
<a name="ln783"> </a>
<a name="ln784">            case Pid::LINE_STYLE:</a>
<a name="ln785">                  if (isLineType())</a>
<a name="ln786">                        return int(Qt::CustomDashLine);</a>
<a name="ln787">                  return int(Qt::SolidLine);</a>
<a name="ln788"> </a>
<a name="ln789">            case Pid::BEGIN_TEXT:</a>
<a name="ln790">                  if (_hairpinType == HairpinType::CRESC_LINE)</a>
<a name="ln791">                        return QString(&quot;cresc.&quot;);</a>
<a name="ln792">                  if (_hairpinType == HairpinType::DECRESC_LINE)</a>
<a name="ln793">                        return QString(&quot;dim.&quot;);</a>
<a name="ln794">                  return QString();</a>
<a name="ln795"> </a>
<a name="ln796">            case Pid::CONTINUE_TEXT:</a>
<a name="ln797">            case Pid::END_TEXT:</a>
<a name="ln798">                  if (_hairpinType == HairpinType::CRESC_LINE)</a>
<a name="ln799">                        return QString(&quot;(cresc.)&quot;);</a>
<a name="ln800">                  if (_hairpinType == HairpinType::DECRESC_LINE)</a>
<a name="ln801">                        return QString(&quot;(dim.)&quot;);</a>
<a name="ln802">                  return QString(&quot;&quot;);</a>
<a name="ln803"> </a>
<a name="ln804">            case Pid::BEGIN_TEXT_PLACE:</a>
<a name="ln805">            case Pid::CONTINUE_TEXT_PLACE:</a>
<a name="ln806">                  return int(PlaceText::LEFT);</a>
<a name="ln807"> </a>
<a name="ln808">            case Pid::BEGIN_TEXT_OFFSET:</a>
<a name="ln809">            case Pid::CONTINUE_TEXT_OFFSET:</a>
<a name="ln810">            case Pid::END_TEXT_OFFSET:</a>
<a name="ln811">                  return QPointF();</a>
<a name="ln812"> </a>
<a name="ln813">            case Pid::BEGIN_HOOK_TYPE:</a>
<a name="ln814">            case Pid::END_HOOK_TYPE:</a>
<a name="ln815">                  return int(HookType::NONE);</a>
<a name="ln816"> </a>
<a name="ln817">            case Pid::BEGIN_HOOK_HEIGHT:</a>
<a name="ln818">            case Pid::END_HOOK_HEIGHT:</a>
<a name="ln819">                  return Spatium(0.0);</a>
<a name="ln820"> </a>
<a name="ln821">            case Pid::LINE_VISIBLE:</a>
<a name="ln822">                  return true;</a>
<a name="ln823"> </a>
<a name="ln824">            case Pid::HAIRPIN_TYPE:</a>
<a name="ln825">                  return int(HairpinType::CRESC_HAIRPIN);</a>
<a name="ln826"> </a>
<a name="ln827">            case Pid::SINGLE_NOTE_DYNAMICS:</a>
<a name="ln828">                  return true;</a>
<a name="ln829"> </a>
<a name="ln830">            case Pid::VELO_CHANGE_METHOD:</a>
<a name="ln831">                  return int(ChangeMethod::NORMAL);</a>
<a name="ln832"> </a>
<a name="ln833">            case Pid::PLACEMENT:</a>
<a name="ln834">                  return score()-&gt;styleV(Sid::hairpinPlacement);</a>
<a name="ln835"> </a>
<a name="ln836">            default:</a>
<a name="ln837">                  return TextLineBase::propertyDefault(id);</a>
<a name="ln838">            }</a>
<a name="ln839">      }</a>
<a name="ln840"> </a>
<a name="ln841">//---------------------------------------------------------</a>
<a name="ln842">//   Hairpin::propertyId</a>
<a name="ln843">//---------------------------------------------------------</a>
<a name="ln844"> </a>
<a name="ln845">Pid Hairpin::propertyId(const QStringRef&amp; name) const</a>
<a name="ln846">      {</a>
<a name="ln847">      if (name == &quot;subtype&quot;)</a>
<a name="ln848">            return Pid::HAIRPIN_TYPE;</a>
<a name="ln849">      return TextLineBase::propertyId(name);</a>
<a name="ln850">      }</a>
<a name="ln851"> </a>
<a name="ln852">//---------------------------------------------------------</a>
<a name="ln853">//   accessibleInfo</a>
<a name="ln854">//---------------------------------------------------------</a>
<a name="ln855"> </a>
<a name="ln856">QString Hairpin::accessibleInfo() const</a>
<a name="ln857">      {</a>
<a name="ln858">      QString rez = TextLineBase::accessibleInfo();</a>
<a name="ln859">      switch (hairpinType()) {</a>
<a name="ln860">            case HairpinType::CRESC_HAIRPIN:</a>
<a name="ln861">                  rez += &quot;: &quot; + QObject::tr(&quot;Crescendo&quot;);</a>
<a name="ln862">                  break;</a>
<a name="ln863">            case HairpinType::DECRESC_HAIRPIN:</a>
<a name="ln864">                  rez += &quot;: &quot; + QObject::tr(&quot;Decrescendo&quot;);</a>
<a name="ln865">                  break;</a>
<a name="ln866">            default:</a>
<a name="ln867">                  rez += &quot;: &quot; + QObject::tr(&quot;Custom&quot;);</a>
<a name="ln868">            }</a>
<a name="ln869">      return rez;</a>
<a name="ln870">      }</a>
<a name="ln871"> </a>
<a name="ln872">}</a>
<a name="ln873"> </a>

</code></pre>
<div class="balloon" rel="60"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: drawCircledTip, circledTipRadius.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
