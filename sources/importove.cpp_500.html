
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>importove.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MusE Score</a>
<a name="ln3">//  Linux Music Score Editor</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2009 Werner Schweer and others</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2.</a>
<a name="ln9">//</a>
<a name="ln10">//  This program is distributed in the hope that it will be useful,</a>
<a name="ln11">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">//  GNU General Public License for more details.</a>
<a name="ln14">//</a>
<a name="ln15">//  You should have received a copy of the GNU General Public License</a>
<a name="ln16">//  along with this program; if not, write to the Free Software</a>
<a name="ln17">//  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</a>
<a name="ln18">//=============================================================================</a>
<a name="ln19"> </a>
<a name="ln20">#include &quot;ove.h&quot;</a>
<a name="ln21"> </a>
<a name="ln22">#include &quot;globals.h&quot;</a>
<a name="ln23">//#include &quot;musescore.h&quot;</a>
<a name="ln24">#include &quot;libmscore/sig.h&quot;</a>
<a name="ln25">#include &quot;libmscore/tempo.h&quot;</a>
<a name="ln26">#include &quot;libmscore/arpeggio.h&quot;</a>
<a name="ln27">#include &quot;libmscore/articulation.h&quot;</a>
<a name="ln28">#include &quot;libmscore/barline.h&quot;</a>
<a name="ln29">#include &quot;libmscore/box.h&quot;</a>
<a name="ln30">#include &quot;libmscore/bracket.h&quot;</a>
<a name="ln31">#include &quot;libmscore/breath.h&quot;</a>
<a name="ln32">#include &quot;libmscore/chord.h&quot;</a>
<a name="ln33">#include &quot;libmscore/clef.h&quot;</a>
<a name="ln34">#include &quot;libmscore/drumset.h&quot;</a>
<a name="ln35">#include &quot;libmscore/dynamic.h&quot;</a>
<a name="ln36">#include &quot;libmscore/hairpin.h&quot;</a>
<a name="ln37">#include &quot;libmscore/harmony.h&quot;</a>
<a name="ln38">#include &quot;libmscore/glissando.h&quot;</a>
<a name="ln39">#include &quot;libmscore/keysig.h&quot;</a>
<a name="ln40">#include &quot;libmscore/layoutbreak.h&quot;</a>
<a name="ln41">#include &quot;libmscore/lyrics.h&quot;</a>
<a name="ln42">#include &quot;libmscore/measure.h&quot;</a>
<a name="ln43">#include &quot;libmscore/note.h&quot;</a>
<a name="ln44">#include &quot;libmscore/accidental.h&quot;</a>
<a name="ln45">#include &quot;libmscore/ottava.h&quot;</a>
<a name="ln46">#include &quot;libmscore/part.h&quot;</a>
<a name="ln47">#include &quot;libmscore/pedal.h&quot;</a>
<a name="ln48">#include &quot;libmscore/pitchspelling.h&quot;</a>
<a name="ln49">#include &quot;preferences.h&quot;</a>
<a name="ln50">#include &quot;libmscore/repeat.h&quot;</a>
<a name="ln51">#include &quot;libmscore/rest.h&quot;</a>
<a name="ln52">#include &quot;libmscore/score.h&quot;</a>
<a name="ln53">#include &quot;libmscore/segment.h&quot;</a>
<a name="ln54">#include &quot;libmscore/slur.h&quot;</a>
<a name="ln55">#include &quot;libmscore/tie.h&quot;</a>
<a name="ln56">#include &quot;libmscore/staff.h&quot;</a>
<a name="ln57">#include &quot;libmscore/tempotext.h&quot;</a>
<a name="ln58">#include &quot;libmscore/text.h&quot;</a>
<a name="ln59">#include &quot;libmscore/timesig.h&quot;</a>
<a name="ln60">#include &quot;libmscore/tuplet.h&quot;</a>
<a name="ln61">#include &quot;libmscore/tremolo.h&quot;</a>
<a name="ln62">#include &quot;libmscore/volta.h&quot;</a>
<a name="ln63">#include &quot;libmscore/chordlist.h&quot;</a>
<a name="ln64">#include &quot;libmscore/rehearsalmark.h&quot;</a>
<a name="ln65">#include &quot;libmscore/marker.h&quot;</a>
<a name="ln66">#include &quot;libmscore/jump.h&quot;</a>
<a name="ln67">#include &quot;libmscore/sym.h&quot;</a>
<a name="ln68">#include &quot;libmscore/bracketItem.h&quot;</a>
<a name="ln69"> </a>
<a name="ln70">using namespace Ms;</a>
<a name="ln71"> </a>
<a name="ln72">class MeasureToTick {</a>
<a name="ln73">public:</a>
<a name="ln74">      MeasureToTick();</a>
<a name="ln75">      ~MeasureToTick();</a>
<a name="ln76"> </a>
<a name="ln77">public:</a>
<a name="ln78">      void build(OVE::OveSong* ove, int quarter);</a>
<a name="ln79"> </a>
<a name="ln80">      int getTick(int measure, int tick_pos);</a>
<a name="ln81">      static int unitToTick(int unit, int quarter);</a>
<a name="ln82"> </a>
<a name="ln83">      struct TimeTick	{</a>
<a name="ln84">            int numerator_;</a>
<a name="ln85">            int denominator_;</a>
<a name="ln86">            int measure_;</a>
<a name="ln87">            int tick_;</a>
<a name="ln88">            bool isSymbol_;</a>
<a name="ln89"> </a>
<a name="ln90">            TimeTick():numerator_(4), denominator_(4), measure_(0), tick_(0), isSymbol_(false){}</a>
<a name="ln91">            };</a>
<a name="ln92">      QList&lt;TimeTick&gt; getTimeTicks() const;</a>
<a name="ln93"> </a>
<a name="ln94">private:</a>
<a name="ln95">      int quarter_;</a>
<a name="ln96">      OVE::OveSong* ove_;</a>
<a name="ln97">      QList&lt;TimeTick&gt; tts_;</a>
<a name="ln98">      };</a>
<a name="ln99"> </a>
<a name="ln100">int getMeasureTick(int quarter, int num, int den){</a>
<a name="ln101">      return quarter * 4 * num / den;</a>
<a name="ln102">      }</a>
<a name="ln103"> </a>
<a name="ln104">MeasureToTick::MeasureToTick(){</a>
<a name="ln105">      quarter_ = 480;</a>
<a name="ln106">      ove_ = 0;</a>
<a name="ln107">      }</a>
<a name="ln108"> </a>
<a name="ln109">MeasureToTick::~MeasureToTick(){</a>
<a name="ln110">      }</a>
<a name="ln111"> </a>
<a name="ln112">void MeasureToTick::build(OVE::OveSong* ove, int quarter){</a>
<a name="ln113">      unsigned int i;</a>
<a name="ln114">      int currentTick = 0;</a>
<a name="ln115">      unsigned int measureCount = ove-&gt;getMeasureCount();</a>
<a name="ln116"> </a>
<a name="ln117">      quarter_ = quarter;</a>
<a name="ln118">      ove_ = ove;</a>
<a name="ln119">      tts_.clear();</a>
<a name="ln120"> </a>
<a name="ln121">      for(i=0; i&lt;measureCount; ++i)	{</a>
<a name="ln122">            OVE::Measure* measure = ove_-&gt;getMeasure(i);</a>
<a name="ln123">            OVE::TimeSignature* time = measure-&gt;getTime();</a>
<a name="ln124">            TimeTick tt;</a>
<a name="ln125">            bool change = false;</a>
<a name="ln126"> </a>
<a name="ln127">            tt.tick_ = currentTick;</a>
<a name="ln128">            tt.numerator_ = time-&gt;getNumerator();</a>
<a name="ln129">            tt.denominator_ = time-&gt;getDenominator();</a>
<a name="ln130">            tt.measure_ = i;</a>
<a name="ln131">            tt.isSymbol_ = time-&gt;getIsSymbol();</a>
<a name="ln132"> </a>
<a name="ln133">            if( i == 0 ){</a>
<a name="ln134">                  change = true;</a>
<a name="ln135">                  } else {</a>
<a name="ln136">                  OVE::TimeSignature* previousTime = ove_-&gt;getMeasure(i-1)-&gt;getTime();</a>
<a name="ln137"> </a>
<a name="ln138">                  if( time-&gt;getNumerator() != previousTime-&gt;getNumerator() ||</a>
<a name="ln139">                      time-&gt;getDenominator() != previousTime-&gt;getDenominator() ){</a>
<a name="ln140">                        change = true;</a>
<a name="ln141">                        } else if(time-&gt;getIsSymbol() != previousTime-&gt;getIsSymbol()){</a>
<a name="ln142">                        change = true;</a>
<a name="ln143">                        }</a>
<a name="ln144">                  }</a>
<a name="ln145"> </a>
<a name="ln146">            if( change ){</a>
<a name="ln147">                  tts_.push_back(tt);</a>
<a name="ln148">                  }</a>
<a name="ln149"> </a>
<a name="ln150">            currentTick += getMeasureTick(quarter_, tt.numerator_, tt.denominator_);</a>
<a name="ln151">            }</a>
<a name="ln152">      }</a>
<a name="ln153"> </a>
<a name="ln154">int MeasureToTick::getTick(int measure, int tick_pos){</a>
<a name="ln155">      TimeTick tt;</a>
<a name="ln156"> </a>
<a name="ln157">      for(int i=0; i&lt;tts_.size(); ++i) {</a>
<a name="ln158">            if( measure &gt;= tts_[i].measure_ &amp;&amp; ( i==tts_.size()-1 || measure &lt; tts_[i+1].measure_ ) ) {</a>
<a name="ln159">                  int measuresTick = (measure - tts_[i].measure_) * getMeasureTick(quarter_, tts_[i].numerator_, tts_[i].denominator_);</a>
<a name="ln160">                  return tts_[i].tick_ + measuresTick + tick_pos;</a>
<a name="ln161">                  }</a>
<a name="ln162">            }</a>
<a name="ln163"> </a>
<a name="ln164">      return 0;</a>
<a name="ln165">      }</a>
<a name="ln166"> </a>
<a name="ln167">int MeasureToTick::unitToTick(int unit, int quarter) {</a>
<a name="ln168">      // 0x100 correspond to quarter tick</a>
<a name="ln169">      float ratio = (float)unit / (float)256.0;</a>
<a name="ln170">      int tick = ratio * quarter;</a>
<a name="ln171">      return tick;</a>
<a name="ln172">      }</a>
<a name="ln173"> </a>
<a name="ln174">QList&lt;MeasureToTick::TimeTick&gt; MeasureToTick::getTimeTicks() const {</a>
<a name="ln175">      return tts_;</a>
<a name="ln176">      }</a>
<a name="ln177"> </a>
<a name="ln178">///////////////////////////////////////////////////////////////////</a>
<a name="ln179">class OveToMScore {</a>
<a name="ln180">public:</a>
<a name="ln181">      OveToMScore();</a>
<a name="ln182">      ~OveToMScore();</a>
<a name="ln183"> </a>
<a name="ln184">public:</a>
<a name="ln185">      void convert(OVE::OveSong* oveData, Score* score);</a>
<a name="ln186"> </a>
<a name="ln187">private:</a>
<a name="ln188">      void createStructure();</a>
<a name="ln189">      void convertHeader();</a>
<a name="ln190">      void convertGroups();</a>
<a name="ln191">      void convertTrackHeader(OVE::Track* track, Part* part);</a>
<a name="ln192">      void convertTrackElements(int track);</a>
<a name="ln193">      void convertLineBreak();</a>
<a name="ln194">      void convertSignatures();</a>
<a name="ln195">      void convertMeasures();</a>
<a name="ln196">      void convertMeasure(Measure* measure);</a>
<a name="ln197">      void convertMeasureMisc(Measure* measure, int part, int staff, int track);</a>
<a name="ln198">      void convertNotes(Measure* measure, int part, int staff, int track);</a>
<a name="ln199">      void convertArticulation(Measure* measure, ChordRest* cr, int track, int absTick, OVE::Articulation* art);</a>
<a name="ln200">      void convertLyrics(Measure* measure, int part, int staff, int track);</a>
<a name="ln201">      void convertHarmonys(Measure* measure, int part, int staff, int track);</a>
<a name="ln202">      void convertRepeats(Measure* measure, int part, int staff, int track);</a>
<a name="ln203">      void convertDynamics(Measure* measure, int part, int staff, int track);</a>
<a name="ln204">      void convertExpressions(Measure* measure, int part, int staff, int track);</a>
<a name="ln205">      void convertLines(Measure* measure);</a>
<a name="ln206">      void convertSlurs(Measure* measure, int part, int staff, int track);</a>
<a name="ln207">      void convertGlissandos(Measure* measure, int part, int staff, int track);</a>
<a name="ln208">      void convertWedges(Measure* measure, int part, int staff, int track);</a>
<a name="ln209">      void convertOctaveShifts(Measure* measure, int part, int staff, int track);</a>
<a name="ln210"> </a>
<a name="ln211">      OVE::NoteContainer* getContainerByPos(int part, int staff, const OVE::MeasurePos&amp; pos);</a>
<a name="ln212">      //OVE::MusicData* getMusicDataByUnit(int part, int staff, int measure, int unit, OVE::MusicDataType type);</a>
<a name="ln213">      OVE::MusicData* getCrossMeasureElementByPos(int part, int staff, const OVE::MeasurePos&amp; pos, int voice, OVE::MusicDataType type);</a>
<a name="ln214">      ChordRest* findChordRestByPos(int absTick, int track);</a>
<a name="ln215"> </a>
<a name="ln216">      void clearUp();</a>
<a name="ln217"> </a>
<a name="ln218">private:</a>
<a name="ln219">      OVE::OveSong* ove_;</a>
<a name="ln220">      Score* score_;</a>
<a name="ln221">      MeasureToTick* mtt_;</a>
<a name="ln222"> </a>
<a name="ln223">      Pedal* pedal_;</a>
<a name="ln224">      };</a>
<a name="ln225"> </a>
<a name="ln226">OveToMScore::OveToMScore() {</a>
<a name="ln227">      ove_ = 0;</a>
<a name="ln228">      mtt_ = new MeasureToTick();</a>
<a name="ln229">      pedal_ = 0;</a>
<a name="ln230">      }</a>
<a name="ln231"> </a>
<a name="ln232">OveToMScore::~OveToMScore() {</a>
<a name="ln233">      delete mtt_;</a>
<a name="ln234">      }</a>
<a name="ln235"> </a>
<a name="ln236">void OveToMScore::convert(OVE::OveSong* ove, Score* score) {</a>
<a name="ln237">      ove_ = ove;</a>
<a name="ln238">      score_ = score;</a>
<a name="ln239">      mtt_-&gt;build(ove_, ove_-&gt;getQuarter());</a>
<a name="ln240"> </a>
<a name="ln241">      convertHeader();</a>
<a name="ln242">      createStructure();</a>
<a name="ln243">      convertGroups();</a>
<a name="ln244">      convertSignatures();</a>
<a name="ln245">      //convertLineBreak();</a>
<a name="ln246"> </a>
<a name="ln247">      int staffCount = 0;</a>
<a name="ln248">      for(int i=0; i&lt;ove_-&gt;getPartCount(); ++i ){</a>
<a name="ln249">            int partStaffCount = ove_-&gt;getStaffCount(i) ;</a>
<a name="ln250">            Part* part = score_-&gt;parts().at(i);</a>
<a name="ln251"> </a>
<a name="ln252">            for(int j=0; j&lt;partStaffCount; ++j){</a>
<a name="ln253">                  OVE::Track* track = ove_-&gt;getTrack(i, j);</a>
<a name="ln254"> </a>
<a name="ln255">                  convertTrackHeader(track, part);</a>
<a name="ln256">                  }</a>
<a name="ln257"> </a>
<a name="ln258">            staffCount += partStaffCount;</a>
<a name="ln259">            }</a>
<a name="ln260"> </a>
<a name="ln261">      convertMeasures();</a>
<a name="ln262"> </a>
<a name="ln263">      // convert elements by ove track sequence</a>
<a name="ln264">      staffCount = 0;</a>
<a name="ln265">      for(int i=0; i&lt;ove_-&gt;getPartCount(); ++i ){</a>
<a name="ln266">            int partStaffCount = ove_-&gt;getStaffCount(i) ;</a>
<a name="ln267"> </a>
<a name="ln268">            for(int j=0; j&lt;partStaffCount; ++j){</a>
<a name="ln269">                  int trackIndex = staffCount + j;</a>
<a name="ln270"> </a>
<a name="ln271">                  convertTrackElements(trackIndex);</a>
<a name="ln272">                  }</a>
<a name="ln273"> </a>
<a name="ln274">            staffCount += partStaffCount;</a>
<a name="ln275">            }</a>
<a name="ln276"> </a>
<a name="ln277">      clearUp();</a>
<a name="ln278">      }</a>
<a name="ln279"> </a>
<a name="ln280">void OveToMScore::createStructure() {</a>
<a name="ln281">      int i;</a>
<a name="ln282">      for(i=0; i&lt;ove_-&gt;getPartCount(); ++i ){</a>
<a name="ln283">            int partStaffCount = ove_-&gt;getStaffCount(i) ;</a>
<a name="ln284">            Part* part = new Part(score_);</a>
<a name="ln285"> </a>
<a name="ln286">            for(int j=0; j&lt;partStaffCount; ++j){</a>
<a name="ln287">                  //OVE::Track* track = ove_-&gt;getTrack(i, j);</a>
<a name="ln288">                  Staff* staff = new Staff(score_);</a>
<a name="ln289">                  staff-&gt;setPart(part);</a>
<a name="ln290"> </a>
<a name="ln291">                  part-&gt;staves()-&gt;push_back(staff);</a>
<a name="ln292">                  score_-&gt;staves().push_back(staff);</a>
<a name="ln293">                  }</a>
<a name="ln294"> </a>
<a name="ln295">            score_-&gt;appendPart(part);</a>
<a name="ln296">            part-&gt;setStaves(partStaffCount);</a>
<a name="ln297">            }</a>
<a name="ln298"> </a>
<a name="ln299">      for(i = 0; i &lt;ove_-&gt;getMeasureCount(); ++i) {</a>
<a name="ln300">            Measure* measure  = new Measure(score_);</a>
<a name="ln301">            int tick = mtt_-&gt;getTick(i, 0);</a>
<a name="ln302">            measure-&gt;setTick(Fraction::fromTicks(tick));</a>
<a name="ln303">            measure-&gt;setNo(i);</a>
<a name="ln304">            score_-&gt;measures()-&gt;add(measure);</a>
<a name="ln305">            }</a>
<a name="ln306">      }</a>
<a name="ln307"> </a>
<a name="ln308">void OveToMScore::clearUp() {</a>
<a name="ln309">      if(pedal_ != NULL) {</a>
<a name="ln310">            delete pedal_;</a>
<a name="ln311">            pedal_ = 0;</a>
<a name="ln312">            }</a>
<a name="ln313">      }</a>
<a name="ln314"> </a>
<a name="ln315">OVE::Staff* getStaff(const OVE::OveSong* ove, int track) {</a>
<a name="ln316">      if (ove-&gt;getLineCount() &gt; 0) {</a>
<a name="ln317">            OVE::Line* line = ove-&gt;getLine(0);</a>
<a name="ln318">            if(line != 0 &amp;&amp; line-&gt;getStaffCount() &gt; 0) {</a>
<a name="ln319">                  OVE::Staff* staff = line-&gt;getStaff(track);</a>
<a name="ln320">                  return staff;</a>
<a name="ln321">                  }</a>
<a name="ln322">            }</a>
<a name="ln323"> </a>
<a name="ln324">      return 0;</a>
<a name="ln325">      }</a>
<a name="ln326"> </a>
<a name="ln327">void addText(VBox* &amp; vbox, Score* s, QString strTxt, Tid stl) {</a>
<a name="ln328">      if (!strTxt.isEmpty()) {</a>
<a name="ln329">            Text* text = new Text(s, stl);</a>
<a name="ln330">            text-&gt;setPlainText(strTxt);</a>
<a name="ln331">            if(vbox == 0) {</a>
<a name="ln332">                  vbox = new VBox(s);</a>
<a name="ln333">                  }</a>
<a name="ln334">            vbox-&gt;add(text);</a>
<a name="ln335">            }</a>
<a name="ln336">      }</a>
<a name="ln337"> </a>
<a name="ln338">void OveToMScore::convertHeader() {</a>
<a name="ln339">      VBox* vbox = 0;</a>
<a name="ln340">      QList&lt;QString&gt; titles = ove_-&gt;getTitles();</a>
<a name="ln341">      if( !titles.empty() &amp;&amp; !titles[0].isEmpty() ) {</a>
<a name="ln342">            QString title = titles[0];</a>
<a name="ln343">            score_-&gt;setMetaTag(&quot;movementTitle&quot;, title);</a>
<a name="ln344">            addText(vbox, score_, title, Tid::TITLE);</a>
<a name="ln345">            }</a>
<a name="ln346"> </a>
<a name="ln347">      QList&lt;QString&gt; copyrights = ove_-&gt;getCopyrights();</a>
<a name="ln348">      if( !copyrights.empty() &amp;&amp; !copyrights[0].isEmpty() ) {</a>
<a name="ln349">            QString copyright = copyrights[0];</a>
<a name="ln350">            score_-&gt;setMetaTag(&quot;copyright&quot;, copyright);</a>
<a name="ln351">            }</a>
<a name="ln352"> </a>
<a name="ln353">      QList&lt;QString&gt; annotates = ove_-&gt;getAnnotates();</a>
<a name="ln354">      if( !annotates.empty() &amp;&amp; !annotates[0].isEmpty() ) {</a>
<a name="ln355">            QString annotate = annotates[0];</a>
<a name="ln356">            addText(vbox, score_, annotate, Tid::POET);</a>
<a name="ln357">            }</a>
<a name="ln358"> </a>
<a name="ln359">      QList&lt;QString&gt; writers = ove_-&gt;getWriters();</a>
<a name="ln360">      if(!writers.empty()) {</a>
<a name="ln361">            QString composer = writers[0];</a>
<a name="ln362">            score_-&gt;setMetaTag(&quot;composer&quot;, composer);</a>
<a name="ln363">            addText(vbox, score_, composer, Tid::COMPOSER);</a>
<a name="ln364">            }</a>
<a name="ln365"> </a>
<a name="ln366">      if(writers.size() &gt; 1) {</a>
<a name="ln367">            QString lyricist = writers[1];</a>
<a name="ln368">            addText(vbox, score_, lyricist, Tid::POET);</a>
<a name="ln369">            }</a>
<a name="ln370"> </a>
<a name="ln371">      if (vbox) {</a>
<a name="ln372">            vbox-&gt;setTick(Fraction(0,1));</a>
<a name="ln373">            score_-&gt;measures()-&gt;add(vbox);</a>
<a name="ln374">            }</a>
<a name="ln375">      }</a>
<a name="ln376"> </a>
<a name="ln377">void OveToMScore::convertGroups() {</a>
<a name="ln378">      int i;</a>
<a name="ln379">      int staffCount = 0;</a>
<a name="ln380">      const QList&lt;Part*&gt;&amp; parts = score_-&gt;parts();</a>
<a name="ln381">      for(i=0; i&lt;ove_-&gt;getPartCount(); ++i ){</a>
<a name="ln382">            int partStaffCount = ove_-&gt;getStaffCount(i);</a>
<a name="ln383">            //if(parts == 0)</a>
<a name="ln384">            //	continue;</a>
<a name="ln385">            Part* part = parts.at(i);</a>
<a name="ln386">            if(part == 0)</a>
<a name="ln387">                  continue;</a>
<a name="ln388"> </a>
<a name="ln389">            for(int j=0; j&lt;partStaffCount; ++j){</a>
<a name="ln390">                  int staffIndex = staffCount + j;</a>
<a name="ln391">                  Staff* staff = score_-&gt;staff(staffIndex);</a>
<a name="ln392">                  if(staff == 0)</a>
<a name="ln393">                        continue;</a>
<a name="ln394"> </a>
<a name="ln395">                  // brace</a>
<a name="ln396">                  if( j == 0 &amp;&amp; partStaffCount == 2 ) {</a>
<a name="ln397">                        staff-&gt;setBracketType(0, BracketType::BRACE);</a>
<a name="ln398">                        staff-&gt;setBracketSpan(0, 2);</a>
<a name="ln399">                        staff-&gt;setBarLineSpan(2);</a>
<a name="ln400">                        }</a>
<a name="ln401"> </a>
<a name="ln402">                  // bracket</a>
<a name="ln403">                  OVE::Staff* staffPtr = getStaff(ove_, staffIndex);</a>
<a name="ln404">                  if(staffPtr != 0 &amp;&amp; staffPtr-&gt;getGroupType() == OVE::GroupType::Bracket) {</a>
<a name="ln405">                        int span = staffPtr-&gt;getGroupStaffCount() + 1;</a>
<a name="ln406">                        int endStaff = staffIndex + span;</a>
<a name="ln407">                        if(span &gt; 0 &amp;&amp; endStaff &gt;= staffIndex &amp;&amp; endStaff &lt;= ove_-&gt;getTrackCount()) {</a>
<a name="ln408">                              staff-&gt;addBracket(new BracketItem(staff-&gt;score(), BracketType::NORMAL, span));</a>
<a name="ln409">                              staff-&gt;setBarLineSpan(span);</a>
<a name="ln410">                              }</a>
<a name="ln411">                        }</a>
<a name="ln412">                  }</a>
<a name="ln413"> </a>
<a name="ln414">            staffCount += partStaffCount;</a>
<a name="ln415">            }</a>
<a name="ln416">      }</a>
<a name="ln417"> </a>
<a name="ln418">ClefType OveClefToClef(OVE::ClefType type){</a>
<a name="ln419">      ClefType clef = ClefType::G;</a>
<a name="ln420">      switch(type){</a>
<a name="ln421">            case OVE::ClefType::Treble:{</a>
<a name="ln422">                  clef = ClefType::G;</a>
<a name="ln423">                  break;</a>
<a name="ln424">                  }</a>
<a name="ln425">            case OVE::ClefType::Bass:{</a>
<a name="ln426">                  clef = ClefType::F;</a>
<a name="ln427">                  break;</a>
<a name="ln428">                  }</a>
<a name="ln429">            case OVE::ClefType::Alto:{</a>
<a name="ln430">                  clef = ClefType::C3;</a>
<a name="ln431">                  break;</a>
<a name="ln432">                  }</a>
<a name="ln433">            case OVE::ClefType::UpAlto:{</a>
<a name="ln434">                  clef = ClefType::C4;</a>
<a name="ln435">                  break;</a>
<a name="ln436">                  }</a>
<a name="ln437">            case OVE::ClefType::DownDownAlto:{</a>
<a name="ln438">                  clef = ClefType::C1;</a>
<a name="ln439">                  break;</a>
<a name="ln440">                  }</a>
<a name="ln441">            case OVE::ClefType::DownAlto:{</a>
<a name="ln442">                  clef = ClefType::C2;</a>
<a name="ln443">                  break;</a>
<a name="ln444">                  }</a>
<a name="ln445">            case OVE::ClefType::UpUpAlto:{</a>
<a name="ln446">                  clef = ClefType::C5;</a>
<a name="ln447">                  break;</a>
<a name="ln448">                  }</a>
<a name="ln449">            case OVE::ClefType::Treble8va:{</a>
<a name="ln450">                  clef = ClefType::G8_VA;</a>
<a name="ln451">                  break;</a>
<a name="ln452">                  }</a>
<a name="ln453">            case OVE::ClefType::Bass8va:{</a>
<a name="ln454">                  clef = ClefType::F_8VA;</a>
<a name="ln455">                  break;</a>
<a name="ln456">                  }</a>
<a name="ln457">            case OVE::ClefType::Treble8vb:{</a>
<a name="ln458">                  clef = ClefType::G8_VB;</a>
<a name="ln459">                  break;</a>
<a name="ln460">                  }</a>
<a name="ln461">            case OVE::ClefType::Bass8vb:{</a>
<a name="ln462">                  clef = ClefType::F8_VB;</a>
<a name="ln463">                  break;</a>
<a name="ln464">                  }</a>
<a name="ln465">            case OVE::ClefType::Percussion1:{</a>
<a name="ln466">                  clef = ClefType::PERC;</a>
<a name="ln467">                  break;</a>
<a name="ln468">                  }</a>
<a name="ln469">            case OVE::ClefType::Percussion2:{</a>
<a name="ln470">                  clef = ClefType::PERC2;</a>
<a name="ln471">                  break;</a>
<a name="ln472">                  }</a>
<a name="ln473">            case OVE::ClefType::TAB:{</a>
<a name="ln474">                  clef = ClefType::TAB;</a>
<a name="ln475">                  break;</a>
<a name="ln476">                  }</a>
<a name="ln477">            default:</a>
<a name="ln478">                  break;</a>
<a name="ln479">            }</a>
<a name="ln480">      return clef;</a>
<a name="ln481">      }</a>
<a name="ln482"> </a>
<a name="ln483">NoteHead::Group getHeadGroup(OVE::NoteHeadType type) {</a>
<a name="ln484">      NoteHead::Group headGroup = NoteHead::Group::HEAD_NORMAL;</a>
<a name="ln485">      switch (type) {</a>
<a name="ln486">            case OVE::NoteHeadType::Standard: {</a>
<a name="ln487">                  headGroup = NoteHead::Group::HEAD_NORMAL;</a>
<a name="ln488">                  break;</a>
<a name="ln489">                  }</a>
<a name="ln490">            case OVE::NoteHeadType::Invisible: {</a>
<a name="ln491">                  break;</a>
<a name="ln492">                  }</a>
<a name="ln493">            case OVE::NoteHeadType::Rhythmic_Slash: {</a>
<a name="ln494">                  headGroup = NoteHead::Group::HEAD_SLASH;</a>
<a name="ln495">                  break;</a>
<a name="ln496">                  }</a>
<a name="ln497">            case OVE::NoteHeadType::Percussion: {</a>
<a name="ln498">                  headGroup = NoteHead::Group::HEAD_XCIRCLE;</a>
<a name="ln499">                  break;</a>
<a name="ln500">                  }</a>
<a name="ln501">            case OVE::NoteHeadType::Closed_Rhythm: {</a>
<a name="ln502">                  headGroup = NoteHead::Group::HEAD_CROSS;</a>
<a name="ln503">                  break;</a>
<a name="ln504">                  }</a>
<a name="ln505">            case OVE::NoteHeadType::Open_Rhythm: {</a>
<a name="ln506">                  headGroup = NoteHead::Group::HEAD_CROSS;</a>
<a name="ln507">                  break;</a>
<a name="ln508">                  }</a>
<a name="ln509">            case OVE::NoteHeadType::Closed_Slash: {</a>
<a name="ln510">                  headGroup = NoteHead::Group::HEAD_SLASH;</a>
<a name="ln511">                  break;</a>
<a name="ln512">                  }</a>
<a name="ln513">            case OVE::NoteHeadType::Open_Slash: {</a>
<a name="ln514">                  headGroup = NoteHead::Group::HEAD_SLASH;</a>
<a name="ln515">                  break;</a>
<a name="ln516">                  }</a>
<a name="ln517">            case OVE::NoteHeadType::Closed_Do: {</a>
<a name="ln518">                  headGroup = NoteHead::Group::HEAD_DO;</a>
<a name="ln519">                  break;</a>
<a name="ln520">                  }</a>
<a name="ln521">            case OVE::NoteHeadType::Open_Do: {</a>
<a name="ln522">                  headGroup = NoteHead::Group::HEAD_DO;</a>
<a name="ln523">                  break;</a>
<a name="ln524">                  }</a>
<a name="ln525">            case OVE::NoteHeadType::Closed_Re: {</a>
<a name="ln526">                  headGroup = NoteHead::Group::HEAD_RE;</a>
<a name="ln527">                  break;</a>
<a name="ln528">                  }</a>
<a name="ln529">            case OVE::NoteHeadType::Open_Re: {</a>
<a name="ln530">                  headGroup = NoteHead::Group::HEAD_RE;</a>
<a name="ln531">                  break;</a>
<a name="ln532">                  }</a>
<a name="ln533">            case OVE::NoteHeadType::Closed_Mi: {</a>
<a name="ln534">                  headGroup = NoteHead::Group::HEAD_MI;</a>
<a name="ln535">                  break;</a>
<a name="ln536">                  }</a>
<a name="ln537">            case OVE::NoteHeadType::Open_Mi: {</a>
<a name="ln538">                  headGroup = NoteHead::Group::HEAD_MI;</a>
<a name="ln539">                  break;</a>
<a name="ln540">                  }</a>
<a name="ln541">            case OVE::NoteHeadType::Closed_Fa: {</a>
<a name="ln542">                  headGroup = NoteHead::Group::HEAD_FA;</a>
<a name="ln543">                  break;</a>
<a name="ln544">                  }</a>
<a name="ln545">            case OVE::NoteHeadType::Open_Fa: {</a>
<a name="ln546">                  headGroup = NoteHead::Group::HEAD_FA;</a>
<a name="ln547">                  break;</a>
<a name="ln548">                  }</a>
<a name="ln549">            case OVE::NoteHeadType::Closed_Sol: {</a>
<a name="ln550">                  break;</a>
<a name="ln551">                  }</a>
<a name="ln552">            case OVE::NoteHeadType::Open_Sol: {</a>
<a name="ln553">                  break;</a>
<a name="ln554">                  }</a>
<a name="ln555">            case OVE::NoteHeadType::Closed_La: {</a>
<a name="ln556">                  headGroup = NoteHead::Group::HEAD_LA;</a>
<a name="ln557">                  break;</a>
<a name="ln558">                  }</a>
<a name="ln559">            case OVE::NoteHeadType::Open_La: {</a>
<a name="ln560">                  headGroup = NoteHead::Group::HEAD_LA;</a>
<a name="ln561">                  break;</a>
<a name="ln562">                  }</a>
<a name="ln563">            case OVE::NoteHeadType::Closed_Ti: {</a>
<a name="ln564">                  headGroup = NoteHead::Group::HEAD_TI;</a>
<a name="ln565">                  break;</a>
<a name="ln566">                  }</a>
<a name="ln567">            case OVE::NoteHeadType::Open_Ti: {</a>
<a name="ln568">                  headGroup = NoteHead::Group::HEAD_TI;</a>
<a name="ln569">                  break;</a>
<a name="ln570">                  }</a>
<a name="ln571">            default: {</a>
<a name="ln572">                  break;</a>
<a name="ln573">                  }</a>
<a name="ln574">            }</a>
<a name="ln575"> </a>
<a name="ln576">      return headGroup;</a>
<a name="ln577">      }</a>
<a name="ln578"> </a>
<a name="ln579">void OveToMScore::convertTrackHeader(OVE::Track* track, Part* part){</a>
<a name="ln580">      if(track == 0 || part == 0)</a>
<a name="ln581">            return;</a>
<a name="ln582"> </a>
<a name="ln583">      QString longName = track-&gt;getName();</a>
<a name="ln584">      if (longName != QString() &amp;&amp; track-&gt;getShowName()){</a>
<a name="ln585">            part-&gt;setPlainLongName(longName);</a>
<a name="ln586">            }</a>
<a name="ln587"> </a>
<a name="ln588">      QString shortName = track-&gt;getBriefName();</a>
<a name="ln589">      if (shortName != QString() &amp;&amp; track-&gt;getShowBriefName()) {</a>
<a name="ln590">            part-&gt;setPlainShortName(shortName);</a>
<a name="ln591">            }</a>
<a name="ln592"> </a>
<a name="ln593">      part-&gt;setMidiProgram(track-&gt;getPatch());</a>
<a name="ln594"> </a>
<a name="ln595">      if (ove_-&gt;getShowTransposeTrack() &amp;&amp; track-&gt;getTranspose() != 0 ) {</a>
<a name="ln596">            Ms::Interval interval = part-&gt;instrument()-&gt;transpose();</a>
<a name="ln597">            interval.diatonic = -track-&gt;getTranspose();</a>
<a name="ln598">            part-&gt;instrument()-&gt;setTranspose(interval);</a>
<a name="ln599">            }</a>
<a name="ln600"> </a>
<a name="ln601">      // DrumSet</a>
<a name="ln602">      if(track-&gt;getStartClef()==OVE::ClefType::Percussion1 || track-&gt;getStartClef()==OVE::ClefType::Percussion2) {</a>
<a name="ln603">            //use overture drumset</a>
<a name="ln604">            Drumset* drumset = new Drumset();</a>
<a name="ln605">            for (int i = 0; i &lt; DRUM_INSTRUMENTS; ++i) {</a>
<a name="ln606">                  drumset-&gt;drum(i).name     = smDrumset-&gt;drum(i).name;</a>
<a name="ln607">                  drumset-&gt;drum(i).notehead = smDrumset-&gt;drum(i).notehead;</a>
<a name="ln608">                  drumset-&gt;drum(i).line     = smDrumset-&gt;drum(i).line;</a>
<a name="ln609">                  drumset-&gt;drum(i).stemDirection = smDrumset-&gt;drum(i).stemDirection;</a>
<a name="ln610">                  drumset-&gt;drum(i).voice     = smDrumset-&gt;drum(i).voice;</a>
<a name="ln611">                  drumset-&gt;drum(i).shortcut = 0;</a>
<a name="ln612">                  }</a>
<a name="ln613">            QList&lt;OVE::Track::DrumNode&gt; nodes = track-&gt;getDrumKit();</a>
<a name="ln614">            for (int i=0; i&lt;nodes.size(); ++i) {</a>
<a name="ln615">                  int pitch = nodes[i].pitch_;</a>
<a name="ln616">                  OVE::Track::DrumNode node = nodes[i];</a>
<a name="ln617">                  if (pitch &lt; DRUM_INSTRUMENTS) {</a>
<a name="ln618">                        drumset-&gt;drum(pitch).line = node.line_;</a>
<a name="ln619">                        drumset-&gt;drum(pitch).notehead = getHeadGroup(OVE::NoteHeadType(node.headType_));</a>
<a name="ln620">                        drumset-&gt;drum(pitch).voice = node.voice_;</a>
<a name="ln621">                        }</a>
<a name="ln622">                  }</a>
<a name="ln623"> </a>
<a name="ln624">            part-&gt;instrument()-&gt;channel(0)-&gt;setBank(128);</a>
<a name="ln625">            part-&gt;setMidiProgram(0);</a>
<a name="ln626">            part-&gt;instrument()-&gt;setDrumset(smDrumset);</a>
<a name="ln627">            part-&gt;instrument()-&gt;setDrumset(drumset);</a>
<a name="ln628">            }</a>
<a name="ln629">      }</a>
<a name="ln630"> </a>
<a name="ln631">static OttavaType OctaveShiftTypeToInt(OVE::OctaveShiftType type) {</a>
<a name="ln632">      OttavaType subtype = OttavaType::OTTAVA_8VA;</a>
<a name="ln633">      switch (type) {</a>
<a name="ln634">            case OVE::OctaveShiftType::OS_8: {</a>
<a name="ln635">                  subtype = OttavaType::OTTAVA_8VA;</a>
<a name="ln636">                  break;</a>
<a name="ln637">                  }</a>
<a name="ln638">            case OVE::OctaveShiftType::OS_15: {</a>
<a name="ln639">                  subtype = OttavaType::OTTAVA_15MA;</a>
<a name="ln640">                  break;</a>
<a name="ln641">                  }</a>
<a name="ln642">            case OVE::OctaveShiftType::OS_Minus_8: {</a>
<a name="ln643">                  subtype = OttavaType::OTTAVA_8VB;</a>
<a name="ln644">                  break;</a>
<a name="ln645">                  }</a>
<a name="ln646">            case OVE::OctaveShiftType::OS_Minus_15: {</a>
<a name="ln647">                  subtype = OttavaType::OTTAVA_15MB;</a>
<a name="ln648">                  break;</a>
<a name="ln649">                  }</a>
<a name="ln650">            default:</a>
<a name="ln651">                  break;</a>
<a name="ln652">            }</a>
<a name="ln653"> </a>
<a name="ln654">      return subtype;</a>
<a name="ln655">      }</a>
<a name="ln656"> </a>
<a name="ln657">void OveToMScore::convertTrackElements(int track) {</a>
<a name="ln658">      Ottava* ottava = 0;</a>
<a name="ln659"> </a>
<a name="ln660">      for(int i=0; i&lt;ove_-&gt;getTrackBarCount(); ++i) {</a>
<a name="ln661">            OVE::MeasureData* measureData = ove_-&gt;getMeasureData(track, i);</a>
<a name="ln662">            if(measureData == 0)</a>
<a name="ln663">                  continue;</a>
<a name="ln664"> </a>
<a name="ln665">            // octave shift</a>
<a name="ln666">            QList&lt;OVE::MusicData*&gt; octaves = measureData-&gt;getMusicDatas(OVE::MusicDataType::OctaveShift_EndPoint);</a>
<a name="ln667">            for(int j=0; j&lt;octaves.size(); ++j) {</a>
<a name="ln668">                  OVE::OctaveShiftEndPoint* octave = static_cast&lt;OVE::OctaveShiftEndPoint*&gt;(octaves[j]);</a>
<a name="ln669">                  int absTick = mtt_-&gt;getTick(i, octave-&gt;getTick());</a>
<a name="ln670"> </a>
<a name="ln671">                  if(octave-&gt;getOctaveShiftPosition() == OVE::OctaveShiftPosition::Start) {</a>
<a name="ln672">                        if(ottava == 0) {</a>
<a name="ln673">                              ottava = new Ottava(score_);</a>
<a name="ln674">                              ottava-&gt;setTrack(track * VOICES);</a>
<a name="ln675">                              ottava-&gt;setOttavaType(OctaveShiftTypeToInt(octave-&gt;getOctaveShiftType()));</a>
<a name="ln676"> </a>
<a name="ln677">                              int y_off = 0;</a>
<a name="ln678">                              switch (octave-&gt;getOctaveShiftType()) {</a>
<a name="ln679">                                    case OVE::OctaveShiftType::OS_8:</a>
<a name="ln680">                                    case OVE::OctaveShiftType::OS_15: {</a>
<a name="ln681">                                          y_off = -3;</a>
<a name="ln682">                                          break;</a>
<a name="ln683">                                          }</a>
<a name="ln684">                                    case OVE::OctaveShiftType::OS_Minus_8:</a>
<a name="ln685">                                    case OVE::OctaveShiftType::OS_Minus_15: {</a>
<a name="ln686">                                          y_off = 8;</a>
<a name="ln687">                                          break;</a>
<a name="ln688">                                          }</a>
<a name="ln689">                                    default:{</a>
<a name="ln690">                                          break;</a>
<a name="ln691">                                          }</a>
<a name="ln692">                                    }</a>
<a name="ln693"> </a>
<a name="ln694">                              if(y_off != 0) {</a>
<a name="ln695">                                    ottava-&gt;setOffset(QPointF(0, y_off * score_-&gt;spatium()));</a>
<a name="ln696">                                    }</a>
<a name="ln697"> </a>
<a name="ln698">                              ottava-&gt;setTick(Fraction::fromTicks(absTick));</a>
<a name="ln699"> </a>
<a name="ln700">                              } else {</a>
<a name="ln701">                              qDebug(&quot;overlapping octave-shift not supported&quot;);</a>
<a name="ln702">                              delete ottava;</a>
<a name="ln703">                              ottava = 0;</a>
<a name="ln704">                              }</a>
<a name="ln705">                        } else if (octave-&gt;getOctaveShiftPosition() == OVE::OctaveShiftPosition::Stop) {</a>
<a name="ln706">                        if(ottava != 0) {</a>
<a name="ln707">                              ottava-&gt;setTick2(Fraction::fromTicks(absTick));</a>
<a name="ln708">                              score_-&gt;addSpanner(ottava);</a>
<a name="ln709">                              ottava-&gt;staff()-&gt;updateOttava();</a>
<a name="ln710">                              ottava = 0;</a>
<a name="ln711">                              } else {</a>
<a name="ln712">                              qDebug(&quot;octave-shift stop without start&quot;);</a>
<a name="ln713">                              }</a>
<a name="ln714">                        }</a>
<a name="ln715">                  }</a>
<a name="ln716">            }</a>
<a name="ln717">      }</a>
<a name="ln718"> </a>
<a name="ln719">void OveToMScore::convertLineBreak(){</a>
<a name="ln720">      for (MeasureBase* mb = score_-&gt;measures()-&gt;first(); mb; mb = mb-&gt;next()) {</a>
<a name="ln721">            if (mb-&gt;type() != ElementType::MEASURE)</a>
<a name="ln722">                  continue;</a>
<a name="ln723">            Measure* measure = static_cast&lt;Measure*&gt; (mb);</a>
<a name="ln724"> </a>
<a name="ln725">            for (int i = 0; i &lt; ove_-&gt;getLineCount(); ++i) {</a>
<a name="ln726">                  OVE::Line* line = ove_-&gt;getLine(i);</a>
<a name="ln727">                  if (measure-&gt;no() &gt; 0) {</a>
<a name="ln728">                        if ((int)line-&gt;getBeginBar() + (int)line-&gt;getBarCount()-1 == measure-&gt;no()) {</a>
<a name="ln729">                              LayoutBreak* lb = new LayoutBreak(score_);</a>
<a name="ln730">                              lb-&gt;setTrack(0);</a>
<a name="ln731">                              lb-&gt;setLayoutBreakType(LayoutBreak::Type::LINE);</a>
<a name="ln732">                              measure-&gt;add(lb);</a>
<a name="ln733">                              }</a>
<a name="ln734">                        }</a>
<a name="ln735">                  }</a>
<a name="ln736">            }</a>
<a name="ln737">      }</a>
<a name="ln738"> </a>
<a name="ln739">void OveToMScore::convertSignatures(){</a>
<a name="ln740">      int i;</a>
<a name="ln741">      int j;</a>
<a name="ln742">      int k;</a>
<a name="ln743"> </a>
<a name="ln744">      // Time</a>
<a name="ln745">      const QList&lt;MeasureToTick::TimeTick&gt; tts = mtt_-&gt;getTimeTicks() ;</a>
<a name="ln746">      for( i=0; i&lt;(int)tts.size(); ++i ){</a>
<a name="ln747">            MeasureToTick::TimeTick tt = tts[i];</a>
<a name="ln748">            Fraction f(tt.numerator_, tt.denominator_);</a>
<a name="ln749"> </a>
<a name="ln750">            TimeSigMap* sigmap = score_-&gt;sigmap();</a>
<a name="ln751">            sigmap-&gt;add(tt.tick_, f);</a>
<a name="ln752"> </a>
<a name="ln753">            Measure* measure  = score_-&gt;tick2measure(Fraction::fromTicks(tt.tick_));</a>
<a name="ln754">            if(measure){</a>
<a name="ln755">                  for(int staffIdx = 0; staffIdx &lt; score_-&gt;nstaves(); ++staffIdx) {</a>
<a name="ln756">                        TimeSigType subtype = TimeSigType::NORMAL;</a>
<a name="ln757">                        if(tt.numerator_ == 4 &amp;&amp; tt.denominator_ == 4 &amp;&amp; tt.isSymbol_ ){</a>
<a name="ln758">                              subtype = TimeSigType::FOUR_FOUR;</a>
<a name="ln759">                              } else if(tt.numerator_ == 2 &amp;&amp; tt.denominator_ == 2 &amp;&amp; tt.isSymbol_ ){</a>
<a name="ln760">                              subtype = TimeSigType::ALLA_BREVE;</a>
<a name="ln761">                              }</a>
<a name="ln762"> </a>
<a name="ln763">                        TimeSig* ts = new TimeSig(score_);</a>
<a name="ln764">                        ts-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln765">                        ts-&gt;setSig(Fraction(tt.numerator_, tt.denominator_), subtype);</a>
<a name="ln766"> </a>
<a name="ln767">                        Segment* seg = measure-&gt;getSegment(SegmentType::TimeSig, Fraction::fromTicks(tt.tick_));</a>
<a name="ln768">                        seg-&gt;add(ts);</a>
<a name="ln769">                        }</a>
<a name="ln770">                  }</a>
<a name="ln771">            }</a>
<a name="ln772"> </a>
<a name="ln773">      // Key</a>
<a name="ln774">      int staffCount = 0;</a>
<a name="ln775">      bool createKey = false ;</a>
<a name="ln776">      for(i=0; i&lt;ove_-&gt;getPartCount(); ++i ){</a>
<a name="ln777">            int partStaffCount = ove_-&gt;getStaffCount(i) ;</a>
<a name="ln778"> </a>
<a name="ln779">            for(j=0; j&lt;partStaffCount; ++j){</a>
<a name="ln780">                  for(k=0; k&lt;ove_-&gt;getMeasureCount(); ++k){</a>
<a name="ln781">                        OVE::MeasureData* measureData = ove_-&gt;getMeasureData(i, j, k) ;</a>
<a name="ln782"> </a>
<a name="ln783">                        if( measureData != 0 ){</a>
<a name="ln784">                              OVE::Key* keyPtr = measureData-&gt;getKey() ;</a>
<a name="ln785"> </a>
<a name="ln786">                              if( k == 0 || keyPtr-&gt;getKey() != keyPtr-&gt;getPreviousKey() )	{</a>
<a name="ln787">                                    int tick = mtt_-&gt;getTick(k, 0);</a>
<a name="ln788">                                    int keyValue = keyPtr-&gt;getKey();</a>
<a name="ln789">                                    Measure* measure = score_-&gt;tick2measure(Fraction::fromTicks(tick));</a>
<a name="ln790">                                    if(measure){</a>
<a name="ln791">                                          KeySigEvent ke;</a>
<a name="ln792">                                          ke.setKey(Key(keyValue));</a>
<a name="ln793">                                          score_-&gt;staff(staffCount+j)-&gt;setKey(Fraction::fromTicks(tick), ke);</a>
<a name="ln794"> </a>
<a name="ln795">                                          KeySig* keysig = new KeySig(score_);</a>
<a name="ln796">                                          keysig-&gt;setTrack((staffCount+j) * VOICES);</a>
<a name="ln797">                                          keysig-&gt;setKeySigEvent(ke);</a>
<a name="ln798"> </a>
<a name="ln799">                                          Segment* s = measure-&gt;getSegment(SegmentType::KeySig, Fraction::fromTicks(tick));</a>
<a name="ln800">                                          s-&gt;add(keysig);</a>
<a name="ln801"> </a>
<a name="ln802">                                          createKey = true;</a>
<a name="ln803">                                          }</a>
<a name="ln804">                                    }</a>
<a name="ln805">                              }</a>
<a name="ln806">                        }</a>
<a name="ln807">                  }</a>
<a name="ln808"> </a>
<a name="ln809">            staffCount += partStaffCount;</a>
<a name="ln810">            }</a>
<a name="ln811"> </a>
<a name="ln812">      if( !createKey ){</a>
<a name="ln813">            staffCount = 0;</a>
<a name="ln814">            for(i=0; i&lt;ove_-&gt;getPartCount(); ++i ){</a>
<a name="ln815">                  int partStaffCount = ove_-&gt;getStaffCount(i) ;</a>
<a name="ln816"> </a>
<a name="ln817">                  for(j=0; j&lt;partStaffCount; ++j){</a>
<a name="ln818">                        Measure* measure = score_-&gt;tick2measure(Fraction::fromTicks(mtt_-&gt;getTick(0, 0)));</a>
<a name="ln819">                        if(measure){</a>
<a name="ln820">                              KeySig* keysig = new KeySig(score_);</a>
<a name="ln821">                              keysig-&gt;setTrack((staffCount+j) * VOICES);</a>
<a name="ln822">                              keysig-&gt;setKeySigEvent(KeySigEvent());</a>
<a name="ln823"> </a>
<a name="ln824">                              Segment* s = measure-&gt;getSegment(SegmentType::KeySig, Fraction(0,1));</a>
<a name="ln825">                              s-&gt;add(keysig);</a>
<a name="ln826">                              }</a>
<a name="ln827">                        }</a>
<a name="ln828">                  staffCount += partStaffCount;</a>
<a name="ln829">                  }</a>
<a name="ln830">            }</a>
<a name="ln831"> </a>
<a name="ln832">      // Clef</a>
<a name="ln833">      staffCount = 0;</a>
<a name="ln834">      for(i=0; i&lt;ove_-&gt;getPartCount(); ++i){</a>
<a name="ln835">            int partStaffCount = ove_-&gt;getStaffCount(i) ;</a>
<a name="ln836">            for(j=0; j&lt;partStaffCount; ++j){</a>
<a name="ln837">                  // start clef</a>
<a name="ln838">                  Staff* staff = score_-&gt;staff(staffCount+j);</a>
<a name="ln839">                  if(staff){</a>
<a name="ln840">                        OVE::Track* track = ove_-&gt;getTrack(i, j);</a>
<a name="ln841">                        ClefType clefType = OveClefToClef(track-&gt;getStartClef());</a>
<a name="ln842">                        Measure* measure = score_-&gt;tick2measure(Fraction(0,1));</a>
<a name="ln843">                        //				staff-&gt;setClef(0, clefType);</a>
<a name="ln844"> </a>
<a name="ln845">                        // note: also generate symbol for tick 0</a>
<a name="ln846">                        // was not necessary before 0.9.6</a>
<a name="ln847">                        Clef* clef = new Clef(score_);</a>
<a name="ln848">                        clef-&gt;setClefType(clefType);</a>
<a name="ln849">                        clef-&gt;setTrack((staffCount+j)*VOICES);</a>
<a name="ln850"> </a>
<a name="ln851">                        Segment* s = measure-&gt;getSegment(SegmentType::HeaderClef, Fraction(0,1));</a>
<a name="ln852">                        s-&gt;add(clef);</a>
<a name="ln853">                        }</a>
<a name="ln854"> </a>
<a name="ln855">                  // clef in measure</a>
<a name="ln856">                  for(k=0; k&lt;ove_-&gt;getMeasureCount(); ++k){</a>
<a name="ln857">                        OVE::MeasureData* measureData = ove_-&gt;getMeasureData(i, j, k);</a>
<a name="ln858">                        QList&lt;OVE::MusicData*&gt; clefs = measureData-&gt;getMusicDatas(OVE::MusicDataType::Clef);</a>
<a name="ln859">                        Measure* measure = score_-&gt;tick2measure(Fraction::fromTicks(mtt_-&gt;getTick(k, 0)));</a>
<a name="ln860"> </a>
<a name="ln861">                        for( int l=0; l&lt;clefs.size(); ++l){</a>
<a name="ln862">                              if(measure != 0){</a>
<a name="ln863">                                    OVE::Clef* clefPtr = static_cast&lt;OVE::Clef*&gt;(clefs[l]);</a>
<a name="ln864">                                    int absTick = mtt_-&gt;getTick(k, clefPtr-&gt;getTick());</a>
<a name="ln865">                                    ClefType clefType = OveClefToClef(clefPtr-&gt;getClefType());</a>
<a name="ln866"> </a>
<a name="ln867">                                    Clef* clef = new Clef(score_);</a>
<a name="ln868">                                    clef-&gt;setClefType(clefType);</a>
<a name="ln869">                                    clef-&gt;setTrack((staffCount+j)*VOICES);</a>
<a name="ln870"> </a>
<a name="ln871">                                    Segment* s = measure-&gt;getSegment(SegmentType::Clef, Fraction::fromTicks(absTick));</a>
<a name="ln872">                                    s-&gt;add(clef);</a>
<a name="ln873">                                    }</a>
<a name="ln874">                              }</a>
<a name="ln875">                        }</a>
<a name="ln876">                  }</a>
<a name="ln877"> </a>
<a name="ln878">            staffCount += partStaffCount;</a>
<a name="ln879">            }</a>
<a name="ln880"> </a>
<a name="ln881">      // Tempo</a>
<a name="ln882">      std::map&lt;int, double&gt; tempos;</a>
<a name="ln883">      for(i=0; i&lt;ove_-&gt;getPartCount(); ++i){</a>
<a name="ln884">            int partStaffCount = ove_-&gt;getStaffCount(i);</a>
<a name="ln885"> </a>
<a name="ln886">            for(j=0; j&lt;partStaffCount; ++j){</a>
<a name="ln887">                  for(k=0; k&lt;ove_-&gt;getMeasureCount(); ++k){</a>
<a name="ln888">                        OVE::Measure* measure = ove_-&gt;getMeasure(k);</a>
<a name="ln889">                        OVE::MeasureData* measureData = ove_-&gt;getMeasureData(i, j, k);</a>
<a name="ln890">                        QList&lt;OVE::MusicData*&gt; tempoPtrs = measureData-&gt;getMusicDatas(OVE::MusicDataType::Tempo);</a>
<a name="ln891"> </a>
<a name="ln892">                        if(k==0 || ( k&gt;0 &amp;&amp; qAbs(measure-&gt;getTypeTempo()-ove_-&gt;getMeasure(k-1)-&gt;getTypeTempo())&gt;0.01 )){</a>
<a name="ln893">                              int tick = mtt_-&gt;getTick(k, 0);</a>
<a name="ln894">                              tempos[tick] = measure-&gt;getTypeTempo();</a>
<a name="ln895">                              }</a>
<a name="ln896"> </a>
<a name="ln897">                        for(int l=0; l&lt;tempoPtrs.size(); ++l) {</a>
<a name="ln898">                              OVE::Tempo* ptr = static_cast&lt;OVE::Tempo*&gt;(tempoPtrs[l]);</a>
<a name="ln899">                              int tick = mtt_-&gt;getTick(measure-&gt;getBarNumber()-&gt;getIndex(), ptr-&gt;getTick());</a>
<a name="ln900">                              double tempo = ptr-&gt;getQuarterTempo()&gt;0 ? ptr-&gt;getQuarterTempo() : 1.0;</a>
<a name="ln901"> </a>
<a name="ln902">                              tempos[tick] = tempo;</a>
<a name="ln903">                              }</a>
<a name="ln904">                        }</a>
<a name="ln905">                  }</a>
<a name="ln906">            }</a>
<a name="ln907"> </a>
<a name="ln908">      std::map&lt;int, double&gt;::iterator it;</a>
<a name="ln909">      int lastTempo = 0;</a>
<a name="ln910">      for(it=tempos.begin(); it!=tempos.end(); ++it) {</a>
<a name="ln911">            if( it==tempos.begin() || (*it).second != lastTempo ) {</a>
<a name="ln912">                  double tpo = ((*it).second) / 60.0;</a>
<a name="ln913">                  score_-&gt;setTempo(Fraction::fromTicks((*it).first), tpo);</a>
<a name="ln914">                  }</a>
<a name="ln915"> </a>
<a name="ln916">            lastTempo = (*it).second;</a>
<a name="ln917">            }</a>
<a name="ln918">      }</a>
<a name="ln919"> </a>
<a name="ln920">int ContainerToTick(OVE::NoteContainer* container, int quarter){</a>
<a name="ln921">      int tick = OVE::NoteTypeToTick(container-&gt;getNoteType(), quarter);</a>
<a name="ln922"> </a>
<a name="ln923">      int dotLength = tick;</a>
<a name="ln924">      for( int i=0; i&lt;container-&gt;getDot(); ++i ) {</a>
<a name="ln925">            dotLength /= 2;</a>
<a name="ln926">            }</a>
<a name="ln927">      dotLength = tick - dotLength;</a>
<a name="ln928"> </a>
<a name="ln929">      if(container-&gt;getTuplet() &gt; 0) {</a>
<a name="ln930">            tick = tick * container-&gt;getSpace() / container-&gt;getTuplet();</a>
<a name="ln931">            }</a>
<a name="ln932"> </a>
<a name="ln933">      tick += dotLength;</a>
<a name="ln934"> </a>
<a name="ln935">      return tick;</a>
<a name="ln936">      }</a>
<a name="ln937"> </a>
<a name="ln938">const OVE::Tuplet* getTuplet(const QList&lt;OVE::MusicData*&gt;&amp; tuplets, int unit){</a>
<a name="ln939">      for(int i=0; i&lt;tuplets.size(); ++i){</a>
<a name="ln940">            const OVE::MusicData* data = tuplets[i];</a>
<a name="ln941">            if(unit &gt;= data-&gt;start()-&gt;getOffset() &amp;&amp; unit &lt;= data-&gt;stop()-&gt;getOffset()){</a>
<a name="ln942">                  const OVE::Tuplet* tuplet = static_cast&lt;OVE::Tuplet*&gt;(tuplets[i]);</a>
<a name="ln943">                  return tuplet;</a>
<a name="ln944">                  }</a>
<a name="ln945">            }</a>
<a name="ln946">      return 0;</a>
<a name="ln947">      }</a>
<a name="ln948"> </a>
<a name="ln949">TDuration OveNoteType_To_Duration(OVE::NoteType noteType){</a>
<a name="ln950">      TDuration d;</a>
<a name="ln951">      switch(noteType){</a>
<a name="ln952">            case OVE::NoteType::Note_DoubleWhole: {</a>
<a name="ln953">                  d.setType(TDuration::DurationType::V_BREVE);</a>
<a name="ln954">                  break;</a>
<a name="ln955">                  }</a>
<a name="ln956">            case OVE::NoteType::Note_Whole: {</a>
<a name="ln957">                  d.setType(TDuration::DurationType::V_WHOLE);</a>
<a name="ln958">                  break;</a>
<a name="ln959">                  }</a>
<a name="ln960">            case OVE::NoteType::Note_Half: {</a>
<a name="ln961">                  d.setType(TDuration::DurationType::V_HALF);</a>
<a name="ln962">                  break;</a>
<a name="ln963">                  }</a>
<a name="ln964">            case OVE::NoteType::Note_Quarter: {</a>
<a name="ln965">                  d.setType(TDuration::DurationType::V_QUARTER);</a>
<a name="ln966">                  break;</a>
<a name="ln967">                  }</a>
<a name="ln968">            case OVE::NoteType::Note_Eight: {</a>
<a name="ln969">                  d.setType(TDuration::DurationType::V_EIGHTH);</a>
<a name="ln970">                  break;</a>
<a name="ln971">                  }</a>
<a name="ln972">            case OVE::NoteType::Note_Sixteen: {</a>
<a name="ln973">                  d.setType(TDuration::DurationType::V_16TH);</a>
<a name="ln974">                  break;</a>
<a name="ln975">                  }</a>
<a name="ln976">            case OVE::NoteType::Note_32: {</a>
<a name="ln977">                  d.setType(TDuration::DurationType::V_32ND);</a>
<a name="ln978">                  break;</a>
<a name="ln979">                  }</a>
<a name="ln980">            case OVE::NoteType::Note_64: {</a>
<a name="ln981">                  d.setType(TDuration::DurationType::V_64TH);</a>
<a name="ln982">                  break;</a>
<a name="ln983">                  }</a>
<a name="ln984">            case OVE::NoteType::Note_128: {</a>
<a name="ln985">                  d.setType(TDuration::DurationType::V_128TH);</a>
<a name="ln986">                  break;</a>
<a name="ln987">                  }</a>
<a name="ln988">            case OVE::NoteType::Note_256: {</a>
<a name="ln989">                  d.setType(TDuration::DurationType::V_256TH);</a>
<a name="ln990">                  break;</a>
<a name="ln991">                  }</a>
<a name="ln992">            default:</a>
<a name="ln993">                  d.setType(TDuration::DurationType::V_QUARTER);</a>
<a name="ln994">                  break;</a>
<a name="ln995">            }</a>
<a name="ln996"> </a>
<a name="ln997">      return d;</a>
<a name="ln998">      }</a>
<a name="ln999"> </a>
<a name="ln1000">int accidentalToAlter(OVE::AccidentalType type) {</a>
<a name="ln1001">      int alter = 0;</a>
<a name="ln1002"> </a>
<a name="ln1003">      switch( type ) {</a>
<a name="ln1004">            case OVE::AccidentalType::Normal:</a>
<a name="ln1005">            case OVE::AccidentalType::Natural:</a>
<a name="ln1006">            case OVE::AccidentalType::Natural_Caution: {</a>
<a name="ln1007">                  alter = 0;</a>
<a name="ln1008">                  break;</a>
<a name="ln1009">                  }</a>
<a name="ln1010">            case OVE::AccidentalType::Sharp:</a>
<a name="ln1011">            case OVE::AccidentalType::Sharp_Caution: {</a>
<a name="ln1012">                  alter = 1;</a>
<a name="ln1013">                  break;</a>
<a name="ln1014">                  }</a>
<a name="ln1015">            case OVE::AccidentalType::Flat:</a>
<a name="ln1016">            case OVE::AccidentalType::Flat_Caution: {</a>
<a name="ln1017">                  alter = -1;</a>
<a name="ln1018">                  break;</a>
<a name="ln1019">                  }</a>
<a name="ln1020">            case OVE::AccidentalType::DoubleSharp:</a>
<a name="ln1021">            case OVE::AccidentalType::DoubleSharp_Caution: {</a>
<a name="ln1022">                  alter = 2;</a>
<a name="ln1023">                  break;</a>
<a name="ln1024">                  }</a>
<a name="ln1025">            case OVE::AccidentalType::DoubleFlat:</a>
<a name="ln1026">            case OVE::AccidentalType::DoubleFlat_Caution: {</a>
<a name="ln1027">                  alter = -2;</a>
<a name="ln1028">                  break;</a>
<a name="ln1029">                  }</a>
<a name="ln1030">            default:</a>
<a name="ln1031">                  break;</a>
<a name="ln1032">            }</a>
<a name="ln1033"> </a>
<a name="ln1034">      return alter;</a>
<a name="ln1035">      }</a>
<a name="ln1036"> </a>
<a name="ln1037">void getMiddleToneOctave(OVE::ClefType clef, OVE::ToneType&amp; tone, int&amp; octave) {</a>
<a name="ln1038">      tone = OVE::ToneType::B;</a>
<a name="ln1039">      octave = 4;</a>
<a name="ln1040"> </a>
<a name="ln1041">      switch ( clef ) {</a>
<a name="ln1042">            case OVE::ClefType::Treble: {</a>
<a name="ln1043">                  tone = OVE::ToneType::B;</a>
<a name="ln1044">                  octave = 4;</a>
<a name="ln1045">                  break;</a>
<a name="ln1046">                  }</a>
<a name="ln1047">            case OVE::ClefType::Treble8va: {</a>
<a name="ln1048">                  tone = OVE::ToneType::B;</a>
<a name="ln1049">                  octave = 5;</a>
<a name="ln1050">                  break;</a>
<a name="ln1051">                  }</a>
<a name="ln1052">            case OVE::ClefType::Treble8vb: {</a>
<a name="ln1053">                  tone = OVE::ToneType::B;</a>
<a name="ln1054">                  octave = 3;</a>
<a name="ln1055">                  break;</a>
<a name="ln1056">                  }</a>
<a name="ln1057">            case OVE::ClefType::Bass: {</a>
<a name="ln1058">                  tone = OVE::ToneType::D;</a>
<a name="ln1059">                  octave = 3;</a>
<a name="ln1060">                  break;</a>
<a name="ln1061">                  }</a>
<a name="ln1062">            case OVE::ClefType::Bass8va: {</a>
<a name="ln1063">                  tone = OVE::ToneType::D;</a>
<a name="ln1064">                  octave = 4;</a>
<a name="ln1065">                  break;</a>
<a name="ln1066">                  }</a>
<a name="ln1067">            case OVE::ClefType::Bass8vb: {</a>
<a name="ln1068">                  tone = OVE::ToneType::D;</a>
<a name="ln1069">                  octave = 2;</a>
<a name="ln1070">                  break;</a>
<a name="ln1071">                  }</a>
<a name="ln1072">            case OVE::ClefType::Alto: {</a>
<a name="ln1073">                  tone = OVE::ToneType::C;</a>
<a name="ln1074">                  octave = 4;</a>
<a name="ln1075">                  break;</a>
<a name="ln1076">                  }</a>
<a name="ln1077">            case OVE::ClefType::UpAlto: {</a>
<a name="ln1078">                  tone = OVE::ToneType::A;</a>
<a name="ln1079">                  octave = 3;</a>
<a name="ln1080">                  break;</a>
<a name="ln1081">                  }</a>
<a name="ln1082">            case OVE::ClefType::DownDownAlto: {</a>
<a name="ln1083">                  tone = OVE::ToneType::G;</a>
<a name="ln1084">                  octave = 4;</a>
<a name="ln1085">                  break;</a>
<a name="ln1086">                  }</a>
<a name="ln1087">            case OVE::ClefType::DownAlto: {</a>
<a name="ln1088">                  tone = OVE::ToneType::E;</a>
<a name="ln1089">                  octave = 4;</a>
<a name="ln1090">                  break;</a>
<a name="ln1091">                  }</a>
<a name="ln1092">            case OVE::ClefType::UpUpAlto: {</a>
<a name="ln1093">                  tone = OVE::ToneType::F;</a>
<a name="ln1094">                  octave = 3;</a>
<a name="ln1095">                  break;</a>
<a name="ln1096">                  }</a>
<a name="ln1097">            case OVE::ClefType::Percussion1: {</a>
<a name="ln1098">                  tone = OVE::ToneType::A;</a>
<a name="ln1099">                  octave = 3;</a>
<a name="ln1100">                  break;</a>
<a name="ln1101">                  }</a>
<a name="ln1102">            case OVE::ClefType::Percussion2: {</a>
<a name="ln1103">                  tone = OVE::ToneType::A;</a>
<a name="ln1104">                  octave = 3;</a>
<a name="ln1105">                  break;</a>
<a name="ln1106">                  }</a>
<a name="ln1107">            case OVE::ClefType::TAB: {</a>
<a name="ln1108">                  break;</a>
<a name="ln1109">                  }</a>
<a name="ln1110">            default:</a>
<a name="ln1111">                  break;</a>
<a name="ln1112">            }</a>
<a name="ln1113">      }</a>
<a name="ln1114"> </a>
<a name="ln1115">OVE::ClefType getClefType(OVE::MeasureData* measure, int tick) {</a>
<a name="ln1116">      OVE::ClefType type = measure-&gt;getClef()-&gt;getClefType();</a>
<a name="ln1117">      QList&lt;OVE::MusicData*&gt; clefs = measure-&gt;getMusicDatas(OVE::MusicDataType::Clef);</a>
<a name="ln1118"> </a>
<a name="ln1119">      for(int i=0; i&lt;clefs.size(); ++i){</a>
<a name="ln1120">            if(tick &lt; clefs[i]-&gt;getTick()){</a>
<a name="ln1121">                  break;</a>
<a name="ln1122">                  }</a>
<a name="ln1123">            if(tick &gt;= clefs[i]-&gt;getTick()){</a>
<a name="ln1124">                  OVE::Clef* clef = static_cast&lt;OVE::Clef*&gt;(clefs[i]);</a>
<a name="ln1125">                  type = clef-&gt;getClefType();</a>
<a name="ln1126">                  }</a>
<a name="ln1127">            }</a>
<a name="ln1128"> </a>
<a name="ln1129">      return type;</a>
<a name="ln1130">      }</a>
<a name="ln1131"> </a>
<a name="ln1132">void OveToMScore::convertMeasures() {</a>
<a name="ln1133">      for (MeasureBase* mb = score_-&gt;measures()-&gt;first(); mb; mb = mb-&gt;next()) {</a>
<a name="ln1134">            if (mb-&gt;type() != ElementType::MEASURE)</a>
<a name="ln1135">                  continue;</a>
<a name="ln1136">            Measure* measure = static_cast&lt;Measure*&gt;(mb);</a>
<a name="ln1137">            int tick = measure-&gt;tick().ticks();</a>
<a name="ln1138">            measure-&gt;setTicks(score_-&gt;sigmap()-&gt;timesig(tick).timesig());</a>
<a name="ln1139">            measure-&gt;setTimesig(score_-&gt;sigmap()-&gt;timesig(tick).timesig()); //?</a>
<a name="ln1140">            convertMeasure(measure);</a>
<a name="ln1141">            }</a>
<a name="ln1142"> </a>
<a name="ln1143">      //  convert based on notes</a>
<a name="ln1144">      for (MeasureBase* mb = score_-&gt;measures()-&gt;first(); mb; mb = mb-&gt;next()) {</a>
<a name="ln1145">            if (mb-&gt;type() != ElementType::MEASURE)</a>
<a name="ln1146">                  continue;</a>
<a name="ln1147">            Measure* measure = static_cast&lt;Measure*&gt;(mb);</a>
<a name="ln1148"> </a>
<a name="ln1149">            convertLines(measure);</a>
<a name="ln1150">            }</a>
<a name="ln1151">      }</a>
<a name="ln1152"> </a>
<a name="ln1153">void OveToMScore::convertMeasure(Measure* measure){</a>
<a name="ln1154">      int staffCount = 0;</a>
<a name="ln1155">      int measureCount = ove_-&gt;getMeasureCount();</a>
<a name="ln1156"> </a>
<a name="ln1157">      for (int i=0; i &lt; ove_-&gt;getPartCount(); ++i) {</a>
<a name="ln1158">            int partStaffCount = ove_-&gt;getStaffCount(i);</a>
<a name="ln1159"> </a>
<a name="ln1160">            for (int j=0; j &lt; partStaffCount; ++j) {</a>
<a name="ln1161">                  int measureID = measure-&gt;no();</a>
<a name="ln1162"> </a>
<a name="ln1163">                  if (measureID &gt;= 0 &amp;&amp; measureID &lt; measureCount) {</a>
<a name="ln1164">                        int trackIndex = (staffCount + j) * VOICES;</a>
<a name="ln1165"> </a>
<a name="ln1166">                        convertMeasureMisc(measure, i, j, trackIndex);</a>
<a name="ln1167">                        convertNotes(measure, i, j, trackIndex);</a>
<a name="ln1168">                        convertLyrics(measure, i, j, trackIndex);</a>
<a name="ln1169">                        convertHarmonys(measure, i, j, trackIndex);</a>
<a name="ln1170">                        convertRepeats(measure, i, j, trackIndex);</a>
<a name="ln1171">                        convertDynamics(measure, i, j, trackIndex);</a>
<a name="ln1172">                        convertExpressions(measure, i, j, trackIndex);</a>
<a name="ln1173">                        }</a>
<a name="ln1174">                  }</a>
<a name="ln1175"> </a>
<a name="ln1176">            staffCount += partStaffCount;</a>
<a name="ln1177">            }</a>
<a name="ln1178">      }</a>
<a name="ln1179"> </a>
<a name="ln1180">void OveToMScore::convertLines(Measure* measure){</a>
<a name="ln1181">      int staffCount = 0;</a>
<a name="ln1182">      int measureCount = ove_-&gt;getMeasureCount();</a>
<a name="ln1183"> </a>
<a name="ln1184">      for( int i=0; i&lt;ove_-&gt;getPartCount(); ++i ){</a>
<a name="ln1185">            int partStaffCount = ove_-&gt;getStaffCount(i);</a>
<a name="ln1186"> </a>
<a name="ln1187">            for( int j=0; j&lt;partStaffCount; ++j ){</a>
<a name="ln1188">                  int measureID = measure-&gt;no();</a>
<a name="ln1189"> </a>
<a name="ln1190">                  if (measureID &gt;= 0 &amp;&amp; measureID &lt; measureCount) {</a>
<a name="ln1191">                        int trackIndex = (staffCount + j) * VOICES;</a>
<a name="ln1192"> </a>
<a name="ln1193">                        convertSlurs(measure, i, j, trackIndex);</a>
<a name="ln1194">                        convertGlissandos(measure, i, j, trackIndex);</a>
<a name="ln1195">                        convertWedges(measure, i, j, trackIndex);</a>
<a name="ln1196">                        }</a>
<a name="ln1197">                  }</a>
<a name="ln1198"> </a>
<a name="ln1199">            staffCount += partStaffCount;</a>
<a name="ln1200">            }</a>
<a name="ln1201">      }</a>
<a name="ln1202"> </a>
<a name="ln1203">void OveToMScore::convertMeasureMisc(Measure* measure, int part, int staff, int track){</a>
<a name="ln1204">      OVE::Measure* measurePtr = ove_-&gt;getMeasure(measure-&gt;no());</a>
<a name="ln1205">      OVE::MeasureData* measureData = ove_-&gt;getMeasureData(part, staff, measure-&gt;no());</a>
<a name="ln1206">      if(measurePtr == 0 || measureData == 0)</a>
<a name="ln1207">            return;</a>
<a name="ln1208"> </a>
<a name="ln1209">      // pickup</a>
<a name="ln1210">      if(measurePtr-&gt;getIsPickup()){</a>
<a name="ln1211">            measure-&gt;setIrregular(true);</a>
<a name="ln1212">            }</a>
<a name="ln1213"> </a>
<a name="ln1214">      // multiple measure rest</a>
<a name="ln1215">      if(measurePtr-&gt;getIsMultiMeasureRest()){</a>
<a name="ln1216">            measure-&gt;setBreakMultiMeasureRest(true);</a>
<a name="ln1217">            }</a>
<a name="ln1218"> </a>
<a name="ln1219">      // barline</a>
<a name="ln1220">      BarLineType bartype = BarLineType::NORMAL;</a>
<a name="ln1221"> </a>
<a name="ln1222">      switch(measurePtr-&gt;getRightBarline()) {</a>
<a name="ln1223">            case OVE::BarLineType::Default:{</a>
<a name="ln1224">                  bartype = BarLineType::NORMAL;</a>
<a name="ln1225">                  break;</a>
<a name="ln1226">                  }</a>
<a name="ln1227">            case OVE::BarLineType::Double:{</a>
<a name="ln1228">                  bartype = BarLineType::DOUBLE;</a>
<a name="ln1229">                  break;</a>
<a name="ln1230">                  }</a>
<a name="ln1231">            case OVE::BarLineType::Final:{</a>
<a name="ln1232">                  bartype = BarLineType::END;</a>
<a name="ln1233">                  break;</a>
<a name="ln1234">                  }</a>
<a name="ln1235">            case OVE::BarLineType::Null:{</a>
<a name="ln1236">                  bartype = BarLineType::NORMAL;</a>
<a name="ln1237">                  break;</a>
<a name="ln1238">                  }</a>
<a name="ln1239">            case OVE::BarLineType::RepeatLeft:{</a>
<a name="ln1240">                  bartype = BarLineType::START_REPEAT;</a>
<a name="ln1241">                  measure-&gt;setRepeatStart(true);</a>
<a name="ln1242">                  break;</a>
<a name="ln1243">                  }</a>
<a name="ln1244">            case OVE::BarLineType::RepeatRight:{</a>
<a name="ln1245">                  bartype = BarLineType::END_REPEAT;</a>
<a name="ln1246">                  measure-&gt;setRepeatEnd(true);</a>
<a name="ln1247">                  break;</a>
<a name="ln1248">                  }</a>
<a name="ln1249">            case OVE::BarLineType::Dashed:{</a>
<a name="ln1250">                  bartype = BarLineType::BROKEN;</a>
<a name="ln1251">                  break;</a>
<a name="ln1252">                  }</a>
<a name="ln1253">            default:</a>
<a name="ln1254">                  break;</a>
<a name="ln1255">            }</a>
<a name="ln1256"> </a>
<a name="ln1257">      if (bartype != BarLineType::NORMAL &amp;&amp; bartype != BarLineType::END_REPEAT &amp;&amp; bartype != BarLineType::START_REPEAT &amp;&amp; bartype != BarLineType::END_START_REPEAT &amp;&amp; bartype != BarLineType::END)</a>
<a name="ln1258">            measure-&gt;setEndBarLineType(bartype, 0);</a>
<a name="ln1259"> </a>
<a name="ln1260">      if (bartype == BarLineType::END_REPEAT)</a>
<a name="ln1261">            measure-&gt;setRepeatEnd(true);</a>
<a name="ln1262"> </a>
<a name="ln1263">      if(measurePtr-&gt;getLeftBarline() == OVE::BarLineType::RepeatLeft){</a>
<a name="ln1264">            //bartype = BarLineType::START_REPEAT;</a>
<a name="ln1265">            measure-&gt;setRepeatStart(true);</a>
<a name="ln1266">            }</a>
<a name="ln1267"> </a>
<a name="ln1268">      // rehearsal</a>
<a name="ln1269">      int i;</a>
<a name="ln1270">      QList&lt;OVE::MusicData*&gt; texts = measureData-&gt;getMusicDatas(OVE::MusicDataType::Text);</a>
<a name="ln1271">      for(i=0; i&lt;texts.size(); ++i){</a>
<a name="ln1272">            OVE::Text* textPtr = static_cast&lt;OVE::Text*&gt;(texts[i]);</a>
<a name="ln1273">            if(textPtr-&gt;getTextType() == OVE::Text::Type::Rehearsal){</a>
<a name="ln1274">                  RehearsalMark* text = new RehearsalMark(score_);</a>
<a name="ln1275">                  text-&gt;setPlainText(textPtr-&gt;getText());</a>
<a name="ln1276">//TODO:ws                  text-&gt;setAbove(true);</a>
<a name="ln1277">                  text-&gt;setTrack(track);</a>
<a name="ln1278"> </a>
<a name="ln1279">                  Segment* s = measure-&gt;getSegment(SegmentType::ChordRest,</a>
<a name="ln1280">                     Fraction::fromTicks(mtt_-&gt;getTick(measure-&gt;no(), 0)));</a>
<a name="ln1281">                  s-&gt;add(text);</a>
<a name="ln1282">                  }</a>
<a name="ln1283">            }</a>
<a name="ln1284"> </a>
<a name="ln1285">      // tempo</a>
<a name="ln1286">      QList&lt;OVE::MusicData*&gt; tempos = measureData-&gt;getMusicDatas(OVE::MusicDataType::Tempo);</a>
<a name="ln1287">      for(i=0; i&lt;tempos.size(); ++i){</a>
<a name="ln1288">            OVE::Tempo* tempoPtr = static_cast&lt;OVE::Tempo*&gt;(tempos[i]);</a>
<a name="ln1289">            TempoText* t = new TempoText(score_);</a>
<a name="ln1290">            int absTick = mtt_-&gt;getTick(measure-&gt;no(), tempoPtr-&gt;getTick());</a>
<a name="ln1291">            double tpo = (tempoPtr-&gt;getQuarterTempo())/60.0;</a>
<a name="ln1292"> </a>
<a name="ln1293">            score_-&gt;setTempo(Fraction::fromTicks(absTick), tpo);</a>
<a name="ln1294"> </a>
<a name="ln1295">            t-&gt;setTempo(tpo);</a>
<a name="ln1296">            QString durationTempoL;</a>
<a name="ln1297">            QString durationTempoR;</a>
<a name="ln1298">            if (static_cast&lt;int&gt;(tempoPtr-&gt;getLeftNoteType()))</a>
<a name="ln1299">                  durationTempoL = TempoText::duration2tempoTextString(OveNoteType_To_Duration(tempoPtr-&gt;getLeftNoteType()));</a>
<a name="ln1300">            if (static_cast&lt;int&gt;(tempoPtr-&gt;getRightNoteType()))</a>
<a name="ln1301">                  durationTempoR = TempoText::duration2tempoTextString(OveNoteType_To_Duration(tempoPtr-&gt;getRightNoteType()));</a>
<a name="ln1302">            QString textTempo;</a>
<a name="ln1303">            if (tempoPtr-&gt;getShowBeforeText())</a>
<a name="ln1304">                  textTempo += (tempoPtr-&gt;getLeftText()).toHtmlEscaped();</a>
<a name="ln1305">            if (tempoPtr-&gt;getShowMark()) {</a>
<a name="ln1306">                  if (!textTempo.isEmpty())</a>
<a name="ln1307">                        textTempo += &quot; &quot;;</a>
<a name="ln1308">                  if (tempoPtr-&gt;getShowParenthesis())</a>
<a name="ln1309">                        textTempo += &quot;(&quot;;</a>
<a name="ln1310">                  textTempo += durationTempoL;</a>
<a name="ln1311">                  if (tempoPtr-&gt;getLeftNoteDot())</a>
<a name="ln1312">                        textTempo += &quot;&lt;sym&gt;space&lt;/sym&gt;&lt;sym&gt;metAugmentationDot&lt;/sym&gt;&quot;;</a>
<a name="ln1313">                  textTempo += &quot; = &quot;;</a>
<a name="ln1314">                  switch (tempoPtr-&gt;getRightSideType()) {</a>
<a name="ln1315">                        case 1:</a>
<a name="ln1316">                              textTempo += durationTempoR;</a>
<a name="ln1317">                              if (tempoPtr-&gt;getRightNoteDot())</a>
<a name="ln1318">                                    textTempo += &quot;&lt;sym&gt;space&lt;/sym&gt;&lt;sym&gt;metAugmentationDot&lt;/sym&gt;&quot;;</a>
<a name="ln1319">                              break;</a>
<a name="ln1320">                        case 2:</a>
<a name="ln1321">                              textTempo += (tempoPtr-&gt;getRightText()).toHtmlEscaped();</a>
<a name="ln1322">                              break;</a>
<a name="ln1323">                        case 3:</a>
<a name="ln1324">                              textTempo += QString::number(qFloor(tempoPtr-&gt;getTypeTempo()));</a>
<a name="ln1325">                              break;</a>
<a name="ln1326">                        case 0:</a>
<a name="ln1327">                        default:</a>
<a name="ln1328">                              textTempo += QString::number(tempoPtr-&gt;getTypeTempo());</a>
<a name="ln1329">                              break;</a>
<a name="ln1330">                        }</a>
<a name="ln1331">                  if (tempoPtr-&gt;getShowParenthesis())</a>
<a name="ln1332">                        textTempo += &quot;)&quot;;</a>
<a name="ln1333">                  }</a>
<a name="ln1334">            if (textTempo.isEmpty()) {</a>
<a name="ln1335">                  textTempo = durationTempoL;</a>
<a name="ln1336">                  if (tempoPtr-&gt;getLeftNoteDot())</a>
<a name="ln1337">                        textTempo += &quot;&lt;sym&gt;space&lt;/sym&gt;&lt;sym&gt;metAugmentationDot&lt;/sym&gt;&quot;;</a>
<a name="ln1338">                  textTempo += &quot; = &quot; + QString::number(tempoPtr-&gt;getTypeTempo());</a>
<a name="ln1339">                  t-&gt;setVisible(false);</a>
<a name="ln1340">                  }</a>
<a name="ln1341">            t-&gt;setXmlText(textTempo);</a>
<a name="ln1342">//TODO:ws            t-&gt;setAbove(true);</a>
<a name="ln1343">            t-&gt;setTrack(track);</a>
<a name="ln1344"> </a>
<a name="ln1345">            Segment* s = measure-&gt;getSegment(SegmentType::ChordRest, Fraction::fromTicks(absTick));</a>
<a name="ln1346">            s-&gt;add(t);</a>
<a name="ln1347">            }</a>
<a name="ln1348">      }</a>
<a name="ln1349"> </a>
<a name="ln1350">// beam in grace</a>
<a name="ln1351">int getGraceLevel(const QList&lt;OVE::NoteContainer*&gt;&amp; containers, int tick, int unit){</a>
<a name="ln1352">      int graceCount = 0;</a>
<a name="ln1353">      int level = 0; // normal chord rest</a>
<a name="ln1354"> </a>
<a name="ln1355">      for(int i=0; i&lt;containers.size(); ++i){</a>
<a name="ln1356">            OVE::NoteContainer* container = containers[i];</a>
<a name="ln1357">            if(container-&gt;getTick() &gt; tick)</a>
<a name="ln1358">                  break;</a>
<a name="ln1359"> </a>
<a name="ln1360">            if(container-&gt;getIsGrace() &amp;&amp; container-&gt;getTick() == tick){</a>
<a name="ln1361">                  ++graceCount;</a>
<a name="ln1362"> </a>
<a name="ln1363">                  if(unit &lt;= container-&gt;start()-&gt;getOffset()){</a>
<a name="ln1364">                        ++level;</a>
<a name="ln1365">                        }</a>
<a name="ln1366">                  }</a>
<a name="ln1367">            }</a>
<a name="ln1368"> </a>
<a name="ln1369">      return level;</a>
<a name="ln1370">      }</a>
<a name="ln1371"> </a>
<a name="ln1372">bool isRestDefaultLine(OVE::Note* rest, OVE::NoteType noteType) {</a>
<a name="ln1373">      bool isDefault = true;</a>
<a name="ln1374">      switch (noteType) {</a>
<a name="ln1375">            case OVE::NoteType::Note_DoubleWhole:</a>
<a name="ln1376">            case OVE::NoteType::Note_Whole:</a>
<a name="ln1377">            case OVE::NoteType::Note_Half:</a>
<a name="ln1378">            case OVE::NoteType::Note_Quarter: {</a>
<a name="ln1379">                  if(rest-&gt;getLine() != 0)</a>
<a name="ln1380">                        isDefault = false;</a>
<a name="ln1381">                  break;</a>
<a name="ln1382">                  }</a>
<a name="ln1383">            case OVE::NoteType::Note_Eight: {</a>
<a name="ln1384">                  if(rest-&gt;getLine() != 1)</a>
<a name="ln1385">                        isDefault = false;</a>
<a name="ln1386">                  break;</a>
<a name="ln1387">                  }</a>
<a name="ln1388">            case OVE::NoteType::Note_Sixteen:</a>
<a name="ln1389">            case OVE::NoteType::Note_32: {</a>
<a name="ln1390">                  if(rest-&gt;getLine() != -1)</a>
<a name="ln1391">                        isDefault = false;</a>
<a name="ln1392">                  break;</a>
<a name="ln1393">                  }</a>
<a name="ln1394">            case OVE::NoteType::Note_64: {</a>
<a name="ln1395">                  if(rest-&gt;getLine() != -3)</a>
<a name="ln1396">                        isDefault = false;</a>
<a name="ln1397">                  break;</a>
<a name="ln1398">                  }</a>
<a name="ln1399">            case OVE::NoteType::Note_128: {</a>
<a name="ln1400">                  if(rest-&gt;getLine() != -4)</a>
<a name="ln1401">                        isDefault = false;</a>
<a name="ln1402">                  break;</a>
<a name="ln1403">                  }</a>
<a name="ln1404">            default: {</a>
<a name="ln1405">                  break;</a>
<a name="ln1406">                  }</a>
<a name="ln1407">            }</a>
<a name="ln1408"> </a>
<a name="ln1409">      return isDefault;</a>
<a name="ln1410">      }</a>
<a name="ln1411"> </a>
<a name="ln1412">Drumset* getDrumset(Score* score, int part) {</a>
<a name="ln1413">      Part* p = score-&gt;parts().at(part);</a>
<a name="ln1414">      return const_cast&lt;Drumset*&gt;(p-&gt;instrument()-&gt;drumset());   //TODO: remove cast</a>
<a name="ln1415">      }</a>
<a name="ln1416"> </a>
<a name="ln1417">void OveToMScore::convertNotes(Measure* measure, int part, int staff, int track){</a>
<a name="ln1418">      int j;</a>
<a name="ln1419">      OVE::MeasureData* measureData = ove_-&gt;getMeasureData(part, staff, measure-&gt;no());</a>
<a name="ln1420">      QList&lt;OVE::NoteContainer*&gt; containers = measureData-&gt;getNoteContainers();</a>
<a name="ln1421">      QList&lt;OVE::MusicData*&gt; tuplets = measureData-&gt;getCrossMeasureElements(OVE::MusicDataType::Tuplet, OVE::MeasureData::PairType::Start);</a>
<a name="ln1422">      QList&lt;OVE::MusicData*&gt; beams = measureData-&gt;getCrossMeasureElements(OVE::MusicDataType::Beam, OVE::MeasureData::PairType::Start);</a>
<a name="ln1423">      Tuplet* tuplet = 0;</a>
<a name="ln1424">      ChordRest* cr = 0;</a>
<a name="ln1425">      int partStaffCount = ove_-&gt;getStaffCount(part);</a>
<a name="ln1426"> </a>
<a name="ln1427">      if(containers.empty()){</a>
<a name="ln1428">            int absTick = mtt_-&gt;getTick(measure-&gt;no(), 0);</a>
<a name="ln1429"> </a>
<a name="ln1430">            cr = new Rest(score_);</a>
<a name="ln1431">            cr-&gt;setTicks(measure-&gt;ticks());</a>
<a name="ln1432">            cr-&gt;setDurationType(TDuration::DurationType::V_MEASURE);</a>
<a name="ln1433">            cr-&gt;setTrack(track);</a>
<a name="ln1434">            Segment* s = measure-&gt;getSegment(SegmentType::ChordRest, Fraction::fromTicks(absTick));</a>
<a name="ln1435">            s-&gt;add(cr);</a>
<a name="ln1436">            }</a>
<a name="ln1437">      QList&lt;Ms::Chord*&gt; graceNotes;</a>
<a name="ln1438">      for (int i = 0; i &lt; containers.size(); ++i) {</a>
<a name="ln1439">            OVE::NoteContainer* container = containers[i];</a>
<a name="ln1440">            int tick = mtt_-&gt;getTick(measure-&gt;no(), container-&gt;getTick());</a>
<a name="ln1441">            int noteTrack = track + container-&gt;getVoice();</a>
<a name="ln1442"> </a>
<a name="ln1443">            if (container-&gt;getIsRest()) {</a>
<a name="ln1444">                  TDuration duration = OveNoteType_To_Duration(container-&gt;getNoteType());</a>
<a name="ln1445">                  duration.setDots(container-&gt;getDot());</a>
<a name="ln1446"> </a>
<a name="ln1447">                  cr = new Rest(score_);</a>
<a name="ln1448">                  cr-&gt;setTicks(duration.fraction());</a>
<a name="ln1449">                  cr-&gt;setDurationType(duration);</a>
<a name="ln1450">                  cr-&gt;setTrack(noteTrack);</a>
<a name="ln1451">                  cr-&gt;setVisible(container-&gt;getShow());</a>
<a name="ln1452">                  Segment* s = measure-&gt;getSegment(SegmentType::ChordRest, Fraction::fromTicks(tick));</a>
<a name="ln1453">                  s-&gt;add(cr);</a>
<a name="ln1454"> </a>
<a name="ln1455">                  QList&lt;OVE::Note*&gt; notes = container-&gt;getNotesRests();</a>
<a name="ln1456">                  for (j = 0; j &lt; notes.size(); ++j) {</a>
<a name="ln1457">                        OVE::Note* notePtr = notes[j];</a>
<a name="ln1458">                        if(!isRestDefaultLine(notePtr, container-&gt;getNoteType()) &amp;&amp; notePtr-&gt;getLine() != 0) {</a>
<a name="ln1459">                              double yOffset = -(double)(notePtr-&gt;getLine());</a>
<a name="ln1460">                              int stepOffset = cr-&gt;staff()-&gt;staffType(cr-&gt;tick())-&gt;stepOffset();</a>
<a name="ln1461">                              int lineOffset = static_cast&lt;Ms::Rest*&gt;(cr)-&gt;computeLineOffset(5);</a>
<a name="ln1462">                              yOffset -= qreal(lineOffset + stepOffset);</a>
<a name="ln1463">                              yOffset *= score_-&gt;spatium()/2.0;</a>
<a name="ln1464">                              cr-&gt;ryoffset() = yOffset;</a>
<a name="ln1465">                              cr-&gt;setAutoplace(false);</a>
<a name="ln1466">                              }</a>
<a name="ln1467">                        }</a>
<a name="ln1468">                  }</a>
<a name="ln1469">            else {</a>
<a name="ln1470">                  QList&lt;OVE::Note*&gt; notes = container-&gt;getNotesRests();</a>
<a name="ln1471"> </a>
<a name="ln1472">                  cr = measure-&gt;findChord(Fraction::fromTicks(tick), noteTrack);</a>
<a name="ln1473">                  if (cr == 0) {</a>
<a name="ln1474">                        cr = new Ms::Chord(score_);</a>
<a name="ln1475">                        cr-&gt;setTrack(noteTrack);</a>
<a name="ln1476"> </a>
<a name="ln1477">                        // grace</a>
<a name="ln1478">                        if (container-&gt;getIsGrace()) {</a>
<a name="ln1479">                              TDuration duration = OveNoteType_To_Duration(container-&gt;getGraceNoteType());</a>
<a name="ln1480">                              duration.setDots(container-&gt;getDot());</a>
<a name="ln1481">                              ((Ms::Chord*) cr)-&gt;setNoteType(NoteType::APPOGGIATURA);</a>
<a name="ln1482"> </a>
<a name="ln1483">                              if (duration.type() == TDuration::DurationType::V_QUARTER) {</a>
<a name="ln1484">                                    ((Ms::Chord*) cr)-&gt;setNoteType(NoteType::GRACE4);</a>
<a name="ln1485">                                    cr-&gt;setDurationType(TDuration::DurationType::V_QUARTER);</a>
<a name="ln1486">                                    } else if (duration.type() == TDuration::DurationType::V_16TH) {</a>
<a name="ln1487">                                    ((Ms::Chord*) cr)-&gt;setNoteType(NoteType::GRACE16);</a>
<a name="ln1488">                                    cr-&gt;setDurationType(TDuration::DurationType::V_16TH);</a>
<a name="ln1489">                                    } else if (duration.type() == TDuration::DurationType::V_32ND) {</a>
<a name="ln1490">                                    ((Ms::Chord*) cr)-&gt;setNoteType(NoteType::GRACE32);</a>
<a name="ln1491">                                    cr-&gt;setDurationType(TDuration::DurationType::V_32ND);</a>
<a name="ln1492">                                    } else {</a>
<a name="ln1493">                                    cr-&gt;setDurationType(TDuration::DurationType::V_EIGHTH);</a>
<a name="ln1494">                                    }</a>
<a name="ln1495"> </a>
<a name="ln1496">                              // st = SegmentType::Grace;</a>
<a name="ln1497">                              }</a>
<a name="ln1498">                        else {</a>
<a name="ln1499">                              TDuration duration = OveNoteType_To_Duration(container-&gt;getNoteType());</a>
<a name="ln1500">                              duration.setDots(container-&gt;getDot());</a>
<a name="ln1501"> </a>
<a name="ln1502">                              if (duration.type() == TDuration::DurationType::V_INVALID)</a>
<a name="ln1503">                                    duration.setType(TDuration::DurationType::V_QUARTER);</a>
<a name="ln1504">                              cr-&gt;setDurationType(duration);</a>
<a name="ln1505">                              // append grace notes before</a>
<a name="ln1506">                              int ii = -1;</a>
<a name="ln1507">                              for (ii = graceNotes.size() - 1; ii &gt;= 0; ii--) {</a>
<a name="ln1508">                                    Ms::Chord* gc = graceNotes[ii];</a>
<a name="ln1509">                                    if(gc-&gt;voice() == cr-&gt;voice()){</a>
<a name="ln1510">                                          cr-&gt;add(gc);</a>
<a name="ln1511">                                          }</a>
<a name="ln1512">                                    }</a>
<a name="ln1513">                              graceNotes.clear();</a>
<a name="ln1514">                              }</a>
<a name="ln1515">                        cr-&gt;setTicks(cr-&gt;durationType().fraction());</a>
<a name="ln1516"> </a>
<a name="ln1517">                        if(!container-&gt;getIsGrace()) {</a>
<a name="ln1518">                              Segment* s = measure-&gt;getSegment(SegmentType::ChordRest, Fraction::fromTicks(tick));</a>
<a name="ln1519">                              s-&gt;add(cr);</a>
<a name="ln1520">                              }</a>
<a name="ln1521">                        else {</a>
<a name="ln1522">                              graceNotes.append(static_cast&lt;Ms::Chord*&gt;(cr));</a>
<a name="ln1523">                              }</a>
<a name="ln1524">                        }</a>
<a name="ln1525"> </a>
<a name="ln1526">                  cr-&gt;setVisible(container-&gt;getShow());</a>
<a name="ln1527">                  cr-&gt;setSmall(container-&gt;getIsCue());</a>
<a name="ln1528">                  for (j = 0; j &lt; notes.size(); ++j) {</a>
<a name="ln1529">                        OVE::Note* oveNote = notes[j];</a>
<a name="ln1530">                        Note* note = new Note(score_);</a>
<a name="ln1531">                        int pitch = oveNote-&gt;getNote();</a>
<a name="ln1532"> </a>
<a name="ln1533">                        //note-&gt;setTrack(noteTrack);</a>
<a name="ln1534">                        note-&gt;setVeloType(Note::ValueType::USER_VAL);</a>
<a name="ln1535">                        note-&gt;setVeloOffset(oveNote-&gt;getOnVelocity());</a>
<a name="ln1536">                        note-&gt;setPitch(pitch);</a>
<a name="ln1537"> </a>
<a name="ln1538">                        // tpc</a>
<a name="ln1539">                        bool setDirection = false;</a>
<a name="ln1540">                        OVE::ClefType clefType = getClefType(measureData, container-&gt;getTick());</a>
<a name="ln1541">                        if(clefType == OVE::ClefType::Percussion1 || clefType == OVE::ClefType::Percussion2) {</a>
<a name="ln1542">                              Drumset* drumset = getDrumset(score_, part);</a>
<a name="ln1543">                              if(drumset != 0) {</a>
<a name="ln1544">                                    if (!drumset-&gt;isValid(pitch) || pitch == -1) {</a>
<a name="ln1545">                                          qDebug(&quot;unmapped drum note 0x%02x %d&quot;, note-&gt;pitch(), note-&gt;pitch());</a>
<a name="ln1546">                                          }</a>
<a name="ln1547">                                    else {</a>
<a name="ln1548">                                          note-&gt;setHeadGroup(drumset-&gt;noteHead(pitch));</a>
<a name="ln1549">                                          int line = drumset-&gt;line(pitch);</a>
<a name="ln1550">                                          note-&gt;setLine(line);</a>
<a name="ln1551">                                          note-&gt;setTpcFromPitch();</a>
<a name="ln1552">                                          ((Ms::Chord*) cr)-&gt;setStemDirection(drumset-&gt;stemDirection(pitch));</a>
<a name="ln1553">                                          setDirection = true;</a>
<a name="ln1554">                                          }</a>
<a name="ln1555">                                    }</a>
<a name="ln1556">                              else {</a>
<a name="ln1557">                              	// no drumset, we don't allow mid staff percussion</a>
<a name="ln1558">                                    note-&gt;setTpc(14);</a>
<a name="ln1559">                              	}</a>
<a name="ln1560">                              }</a>
<a name="ln1561">                        else {</a>
<a name="ln1562">                              const int OCTAVE = 7;</a>
<a name="ln1563">                              OVE::ToneType clefMiddleTone;</a>
<a name="ln1564">                              int clefMiddleOctave;</a>
<a name="ln1565">                              getMiddleToneOctave(clefType, clefMiddleTone, clefMiddleOctave);</a>
<a name="ln1566">                              int absLine = static_cast&lt;int&gt;(clefMiddleTone) + clefMiddleOctave * OCTAVE + oveNote-&gt;getLine();</a>
<a name="ln1567">                              if ((partStaffCount == 2) &amp;&amp; oveNote-&gt;getOffsetStaff())</a>
<a name="ln1568">                                    absLine += 2 * (oveNote-&gt;getOffsetStaff());</a>
<a name="ln1569">                              int tone = absLine % OCTAVE;</a>
<a name="ln1570">                              int alter = accidentalToAlter(oveNote-&gt;getAccidental());</a>
<a name="ln1571">                              NoteVal nv(pitch);</a>
<a name="ln1572">                              note-&gt;setTrack(cr-&gt;track());</a>
<a name="ln1573">                              note-&gt;setNval(nv, Fraction::fromTicks(tick));</a>
<a name="ln1574">                              // note-&gt;setTpcFromPitch();</a>
<a name="ln1575">                              note-&gt;setTpc(step2tpc(tone, AccidentalVal(alter)));</a>
<a name="ln1576">                              if (oveNote-&gt;getShowAccidental()) {</a>
<a name="ln1577">                                    Ms::Accidental* a = new Accidental(score_);</a>
<a name="ln1578">                                    bool bracket = static_cast&lt;int&gt;(oveNote-&gt;getAccidental()) &amp; 0x8;</a>
<a name="ln1579">                                    AccidentalType at = Ms::AccidentalType::NONE;</a>
<a name="ln1580">                                    switch(alter) {</a>
<a name="ln1581">                                          case 0: at = Ms::AccidentalType::NATURAL; break;</a>
<a name="ln1582">                                          case 1: at = Ms::AccidentalType::SHARP; break;</a>
<a name="ln1583">                                          case -1: at = Ms::AccidentalType::FLAT; break;</a>
<a name="ln1584">                                          case 2: at = Ms::AccidentalType::SHARP2; break;</a>
<a name="ln1585">                                          case -2: at = Ms::AccidentalType::FLAT2; break;</a>
<a name="ln1586">                                          }</a>
<a name="ln1587">                                    a-&gt;setAccidentalType(at);</a>
<a name="ln1588">                                    a-&gt;setBracket(AccidentalBracket(bracket));</a>
<a name="ln1589">                                    a-&gt;setRole(Ms::AccidentalRole::USER);</a>
<a name="ln1590">                                    note-&gt;add(a);</a>
<a name="ln1591">                                    }</a>
<a name="ln1592">                              note-&gt;setHeadGroup(getHeadGroup(oveNote-&gt;getHeadType()));</a>
<a name="ln1593">                              }</a>
<a name="ln1594">                        if ((oveNote-&gt;getHeadType() == OVE::NoteHeadType::Invisible) || !(oveNote-&gt;getShow()))</a>
<a name="ln1595">                              note-&gt;setVisible(false);</a>
<a name="ln1596">                        // tie</a>
<a name="ln1597">                        if ((int(oveNote-&gt;getTiePos()) &amp; int(OVE::TiePos::LeftEnd)) == int(OVE::TiePos::LeftEnd)) {</a>
<a name="ln1598">                              Tie* tie = new Tie(score_);</a>
<a name="ln1599">                              note-&gt;setTieFor(tie);</a>
<a name="ln1600">                              tie-&gt;setStartNote(note);</a>
<a name="ln1601">                              tie-&gt;setTrack(noteTrack);</a>
<a name="ln1602">                              }</a>
<a name="ln1603"> </a>
<a name="ln1604">                        // pitch must be set before adding note to chord as note</a>
<a name="ln1605">                        // is inserted into pitch sorted list (ws)</a>
<a name="ln1606">                        cr-&gt;add(note);</a>
<a name="ln1607"> </a>
<a name="ln1608">                        //cr-&gt;setVisible(oveNote-&gt;getShow());</a>
<a name="ln1609">                        ((Ms::Chord*) cr)-&gt;setNoStem(int(container-&gt;getNoteType()) &lt;= int(OVE::NoteType::Note_Whole));</a>
<a name="ln1610">                        if(!setDirection)</a>
<a name="ln1611">                              ((Ms::Chord*) cr)-&gt;setStemDirection(container-&gt;getStemUp() ? Direction::UP : Direction::DOWN);</a>
<a name="ln1612"> </a>
<a name="ln1613">                        // cross staff</a>
<a name="ln1614">                        int staffMove = 0;</a>
<a name="ln1615">                        if(partStaffCount == 2) { /*treble-bass*/</a>
<a name="ln1616">                              staffMove = oveNote-&gt;getOffsetStaff();</a>
<a name="ln1617">                              }</a>
<a name="ln1618">                        cr-&gt;setStaffMove(staffMove);</a>
<a name="ln1619">                        }</a>
<a name="ln1620">                  }</a>
<a name="ln1621"> </a>
<a name="ln1622">            // beam</a>
<a name="ln1623">            //Beam::Mode bm = container-&gt;getIsRest() ? Beam::Mode::NONE : Beam::Mode::AUTO;</a>
<a name="ln1624">            Beam::Mode bm = Beam::Mode::NONE;</a>
<a name="ln1625">            if(container-&gt;getInBeam()){</a>
<a name="ln1626">                  OVE::MeasurePos pos = container-&gt;start()-&gt;shiftMeasure(0);</a>
<a name="ln1627">                  OVE::MusicData* data = getCrossMeasureElementByPos(part, staff, pos, container-&gt;getVoice(), OVE::MusicDataType::Beam);</a>
<a name="ln1628"> </a>
<a name="ln1629">                  if(data != 0){</a>
<a name="ln1630">                        OVE::Beam* beam = static_cast&lt;OVE::Beam*&gt;(data);</a>
<a name="ln1631">                        OVE::MeasurePos startPos = beam-&gt;start()-&gt;shiftMeasure(0);</a>
<a name="ln1632">                        OVE::MeasurePos stopPos = beam-&gt;stop()-&gt;shiftMeasure(beam-&gt;start()-&gt;getMeasure());</a>
<a name="ln1633"> </a>
<a name="ln1634">                        if(startPos == pos){</a>
<a name="ln1635">                              bm = Beam::Mode::BEGIN;</a>
<a name="ln1636">                              }</a>
<a name="ln1637">                        else if(stopPos == pos){</a>
<a name="ln1638">                              bm = Beam::Mode::END;</a>
<a name="ln1639">                              }</a>
<a name="ln1640">                        else{</a>
<a name="ln1641">                              bm = Beam::Mode::MID;</a>
<a name="ln1642">                              }</a>
<a name="ln1643">                        }</a>
<a name="ln1644">                  }</a>
<a name="ln1645">            cr-&gt;setBeamMode(bm);</a>
<a name="ln1646"> </a>
<a name="ln1647">            // tuplet</a>
<a name="ln1648">            if (container-&gt;getTuplet() &gt; 0) {</a>
<a name="ln1649">                  if (tuplet == 0) {</a>
<a name="ln1650">                        bool create = true;</a>
<a name="ln1651"> </a>
<a name="ln1652">                        // check tuplet start</a>
<a name="ln1653">                        if(container-&gt;getNoteType() &lt; OVE::NoteType::Note_Eight) {</a>
<a name="ln1654">                              const OVE::Tuplet* oveTuplet = getTuplet(tuplets, container-&gt;start()-&gt;getOffset());</a>
<a name="ln1655">                              if(oveTuplet == 0) {</a>
<a name="ln1656">                                    create = false;</a>
<a name="ln1657">                                    }</a>
<a name="ln1658">                              }</a>
<a name="ln1659"> </a>
<a name="ln1660">                        if(create) {</a>
<a name="ln1661">                              tuplet = new Tuplet(score_);</a>
<a name="ln1662">                              tuplet-&gt;setTrack(noteTrack);</a>
<a name="ln1663">                              tuplet-&gt;setRatio(Fraction(container-&gt;getTuplet(), container-&gt;getSpace()));</a>
<a name="ln1664">                              TDuration duration = OveNoteType_To_Duration(container-&gt;getNoteType());</a>
<a name="ln1665">                              tuplet-&gt;setBaseLen(duration);</a>
<a name="ln1666">//                              tuplet-&gt;setTick(tick);</a>
<a name="ln1667">                              tuplet-&gt;setParent(measure);</a>
<a name="ln1668">                              //measure-&gt;add(tuplet);</a>
<a name="ln1669">                              }</a>
<a name="ln1670">                        }</a>
<a name="ln1671"> </a>
<a name="ln1672">                  if (tuplet != 0) {</a>
<a name="ln1673">                        cr-&gt;setTuplet(tuplet);</a>
<a name="ln1674">                        tuplet-&gt;add(cr);</a>
<a name="ln1675">                        }</a>
<a name="ln1676"> </a>
<a name="ln1677">                  if (tuplet != 0) {</a>
<a name="ln1678">                        // check tuplet end</a>
<a name="ln1679">                        const OVE::Tuplet* oveTuplet = getTuplet(tuplets, container-&gt;start()-&gt;getOffset());</a>
<a name="ln1680">                        if (oveTuplet != 0) {</a>
<a name="ln1681">                              //set direction</a>
<a name="ln1682">                              tuplet-&gt;setDirection(oveTuplet-&gt;getLeftShoulder()-&gt;getYOffset() &lt; 0 ? Direction::UP : Direction::DOWN);</a>
<a name="ln1683"> </a>
<a name="ln1684">                              if(container-&gt;start()-&gt;getOffset() == oveTuplet-&gt;stop()-&gt;getOffset()){</a>
<a name="ln1685">                                    tuplet = 0;</a>
<a name="ln1686">                                    }</a>
<a name="ln1687">                              }</a>
<a name="ln1688">                        }</a>
<a name="ln1689">                  }</a>
<a name="ln1690"> </a>
<a name="ln1691">            // articulation</a>
<a name="ln1692">            QList&lt;OVE::Articulation*&gt; articulations = container-&gt;getArticulations();</a>
<a name="ln1693">            for (j = 0; j &lt; articulations.size(); ++j) {</a>
<a name="ln1694">                  convertArticulation(measure, cr, noteTrack, tick, articulations[j]);</a>
<a name="ln1695">                  }</a>
<a name="ln1696">            }</a>
<a name="ln1697">      }</a>
<a name="ln1698"> </a>
<a name="ln1699">void OveToMScore::convertArticulation(</a>
<a name="ln1700">            Measure* measure, ChordRest* cr,</a>
<a name="ln1701">            int track, int absTick, OVE::Articulation* art){</a>
<a name="ln1702"> </a>
<a name="ln1703">      switch ( art-&gt;getArtType() ) {</a>
<a name="ln1704">            case OVE::ArticulationType::Major_Trill :</a>
<a name="ln1705">            case OVE::ArticulationType::Minor_Trill :{</a>
<a name="ln1706">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1707">                  a-&gt;setSymId(SymId::ornamentTrill);</a>
<a name="ln1708">                  cr-&gt;add(a);</a>
<a name="ln1709">                  break;</a>
<a name="ln1710">                  }</a>
<a name="ln1711">            case OVE::ArticulationType::Trill_Section :{</a>
<a name="ln1712">                  break;</a>
<a name="ln1713">                  }</a>
<a name="ln1714">            case OVE::ArticulationType::Inverted_Short_Mordent :</a>
<a name="ln1715">            case OVE::ArticulationType::Inverted_Long_Mordent :{</a>
<a name="ln1716">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1717">                  a-&gt;setSymId(SymId::ornamentMordent);</a>
<a name="ln1718">                  cr-&gt;add(a);</a>
<a name="ln1719">                  break;</a>
<a name="ln1720">                  }</a>
<a name="ln1721">            case OVE::ArticulationType::Short_Mordent :{</a>
<a name="ln1722">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1723">                  a-&gt;setSymId(SymId::ornamentMordentInverted);</a>
<a name="ln1724">                  cr-&gt;add(a);</a>
<a name="ln1725">                  break;</a>
<a name="ln1726">                  }</a>
<a name="ln1727">            case OVE::ArticulationType::Turn :{</a>
<a name="ln1728">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1729">                  a-&gt;setSymId(SymId::ornamentTurn);</a>
<a name="ln1730">                  cr-&gt;add(a);</a>
<a name="ln1731">                  break;</a>
<a name="ln1732">                  }</a>
<a name="ln1733">                  //	case OVE::ArticulationType::Flat_Accidental_For_Trill :</a>
<a name="ln1734">                  //	case OVE::ArticulationType::Sharp_Accidental_For_Trill :</a>
<a name="ln1735">                  //	case OVE::ArticulationType::Natural_Accidental_For_Trill :</a>
<a name="ln1736">            case OVE::ArticulationType::Tremolo_Eighth :{</a>
<a name="ln1737">                  Tremolo* t = new Tremolo(score_);</a>
<a name="ln1738">                  t-&gt;setTremoloType(TremoloType::R8);</a>
<a name="ln1739">                  cr-&gt;add(t);</a>
<a name="ln1740">                  break;</a>
<a name="ln1741">                  }</a>
<a name="ln1742">            case OVE::ArticulationType::Tremolo_Sixteenth :{</a>
<a name="ln1743">                  Tremolo* t = new Tremolo(score_);</a>
<a name="ln1744">                  t-&gt;setTremoloType(TremoloType::R16);</a>
<a name="ln1745">                  cr-&gt;add(t);</a>
<a name="ln1746">                  break;</a>
<a name="ln1747">                  }</a>
<a name="ln1748">            case OVE::ArticulationType::Tremolo_Thirty_Second :{</a>
<a name="ln1749">                  Tremolo* t = new Tremolo(score_);</a>
<a name="ln1750">                  t-&gt;setTremoloType(TremoloType::R32);</a>
<a name="ln1751">                  cr-&gt;add(t);</a>
<a name="ln1752">                  break;</a>
<a name="ln1753">                  }</a>
<a name="ln1754">            case OVE::ArticulationType::Tremolo_Sixty_Fourth :{</a>
<a name="ln1755">                  Tremolo* t = new Tremolo(score_);</a>
<a name="ln1756">                  t-&gt;setTremoloType(TremoloType::R64);</a>
<a name="ln1757">                  cr-&gt;add(t);</a>
<a name="ln1758">                  break;</a>
<a name="ln1759">                  }</a>
<a name="ln1760">            case OVE::ArticulationType::Marcato :{</a>
<a name="ln1761">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1762">                  a-&gt;setSymId(SymId::articAccentAbove);</a>
<a name="ln1763">                  cr-&gt;add(a);</a>
<a name="ln1764">                  break;</a>
<a name="ln1765">                  }</a>
<a name="ln1766">            case OVE::ArticulationType::Marcato_Dot :{</a>
<a name="ln1767">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1768">                  a-&gt;setSymId(SymId::articAccentAbove);</a>
<a name="ln1769">                  cr-&gt;add(a);</a>
<a name="ln1770"> </a>
<a name="ln1771">                  a = new Articulation(score_);</a>
<a name="ln1772">                  a-&gt;setSymId(SymId::articStaccatoAbove);</a>
<a name="ln1773">                  cr-&gt;add(a);</a>
<a name="ln1774">                  break;</a>
<a name="ln1775">                  }</a>
<a name="ln1776">            case OVE::ArticulationType::Heavy_Attack :{</a>
<a name="ln1777">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1778">                  a-&gt;setSymId(SymId::articAccentAbove);</a>
<a name="ln1779">                  cr-&gt;add(a);</a>
<a name="ln1780"> </a>
<a name="ln1781">                  a = new Articulation(score_);</a>
<a name="ln1782">                  a-&gt;setSymId(SymId::articTenutoAbove);</a>
<a name="ln1783">                  cr-&gt;add(a);</a>
<a name="ln1784">                  break;</a>
<a name="ln1785">                  }</a>
<a name="ln1786">            case OVE::ArticulationType::SForzando :{</a>
<a name="ln1787">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1788">                  a-&gt;setUp(true);</a>
<a name="ln1789">                  a-&gt;setSymId(SymId::articMarcatoAbove);</a>
<a name="ln1790">                  cr-&gt;add(a);</a>
<a name="ln1791">                  break;</a>
<a name="ln1792">                  }</a>
<a name="ln1793">            case OVE::ArticulationType::SForzando_Inverted :{</a>
<a name="ln1794">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1795">                  a-&gt;setUp(false);</a>
<a name="ln1796">                  a-&gt;setSymId(SymId::articMarcatoAbove);</a>
<a name="ln1797">                  cr-&gt;add(a);</a>
<a name="ln1798">                  break;</a>
<a name="ln1799">                  }</a>
<a name="ln1800">            case OVE::ArticulationType::SForzando_Dot :{</a>
<a name="ln1801">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1802">                  a-&gt;setUp(true);</a>
<a name="ln1803">                  a-&gt;setSymId(SymId::articMarcatoAbove);</a>
<a name="ln1804">                  cr-&gt;add(a);</a>
<a name="ln1805"> </a>
<a name="ln1806">                  a = new Articulation(score_);</a>
<a name="ln1807">                  a-&gt;setSymId(SymId::articStaccatoAbove);</a>
<a name="ln1808">                  cr-&gt;add(a);</a>
<a name="ln1809">                  break;</a>
<a name="ln1810">                  }</a>
<a name="ln1811">            case OVE::ArticulationType::SForzando_Dot_Inverted :{</a>
<a name="ln1812">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1813">                  a-&gt;setUp(false);</a>
<a name="ln1814">                  a-&gt;setSymId(SymId::articMarcatoAbove);</a>
<a name="ln1815">                  cr-&gt;add(a);</a>
<a name="ln1816"> </a>
<a name="ln1817">                  a = new Articulation(score_);</a>
<a name="ln1818">                  a-&gt;setSymId(SymId::articStaccatoAbove);</a>
<a name="ln1819">                  cr-&gt;add(a);</a>
<a name="ln1820">                  break;</a>
<a name="ln1821">                  }</a>
<a name="ln1822">            case OVE::ArticulationType::Heavier_Attack :{</a>
<a name="ln1823">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1824">                  a-&gt;setUp(true);</a>
<a name="ln1825">                  a-&gt;setSymId(SymId::articMarcatoAbove);</a>
<a name="ln1826">                  cr-&gt;add(a);</a>
<a name="ln1827"> </a>
<a name="ln1828">                  a = new Articulation(score_);</a>
<a name="ln1829">                  a-&gt;setSymId(SymId::articTenutoAbove);</a>
<a name="ln1830">                  cr-&gt;add(a);</a>
<a name="ln1831">                  break;</a>
<a name="ln1832">                  }</a>
<a name="ln1833">            case OVE::ArticulationType::Staccatissimo :{</a>
<a name="ln1834">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1835">                  a-&gt;setUp(true);</a>
<a name="ln1836">                  a-&gt;setSymId(SymId::articStaccatissimoAbove);</a>
<a name="ln1837">                  cr-&gt;add(a);</a>
<a name="ln1838">                  break;</a>
<a name="ln1839">                  }</a>
<a name="ln1840">            case OVE::ArticulationType::Staccato :{</a>
<a name="ln1841">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1842">                  a-&gt;setSymId(SymId::articStaccatoAbove);</a>
<a name="ln1843">                  cr-&gt;add(a);</a>
<a name="ln1844">                  break;</a>
<a name="ln1845">                  }</a>
<a name="ln1846">            case OVE::ArticulationType::Tenuto :{</a>
<a name="ln1847">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1848">                  a-&gt;setSymId(SymId::articTenutoAbove);</a>
<a name="ln1849">                  cr-&gt;add(a);</a>
<a name="ln1850">                  break;</a>
<a name="ln1851">                  }</a>
<a name="ln1852">            case OVE::ArticulationType::Pause :{</a>
<a name="ln1853">                  Breath* b = new Breath(score_);</a>
<a name="ln1854">                  b-&gt;setTrack(track);</a>
<a name="ln1855">                  Segment* seg = measure-&gt;getSegment(SegmentType::Breath,</a>
<a name="ln1856">                     Fraction::fromTicks(absTick + (cr ? cr-&gt;actualTicks().ticks() : 0)));</a>
<a name="ln1857">                  seg-&gt;add(b);</a>
<a name="ln1858">                  break;</a>
<a name="ln1859">                  }</a>
<a name="ln1860">            case OVE::ArticulationType::Grand_Pause :{</a>
<a name="ln1861">                  // TODO?</a>
<a name="ln1862">                  break;</a>
<a name="ln1863">                  }</a>
<a name="ln1864">            case OVE::ArticulationType::Up_Bow :{</a>
<a name="ln1865">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1866">                  a-&gt;setSymId(SymId::stringsUpBow);</a>
<a name="ln1867">                  cr-&gt;add(a);</a>
<a name="ln1868">                  break;</a>
<a name="ln1869">                  }</a>
<a name="ln1870">            case OVE::ArticulationType::Down_Bow :{</a>
<a name="ln1871">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1872">                  a-&gt;setSymId(SymId::stringsDownBow);</a>
<a name="ln1873">                  cr-&gt;add(a);</a>
<a name="ln1874">                  break;</a>
<a name="ln1875">                  }</a>
<a name="ln1876">            case OVE::ArticulationType::Up_Bow_Inverted :{</a>
<a name="ln1877">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1878">                  a-&gt;setSymId(SymId::stringsUpBow);</a>
<a name="ln1879">                  a-&gt;ryoffset() = 5.3;</a>
<a name="ln1880">                  cr-&gt;add(a);</a>
<a name="ln1881">                  break;</a>
<a name="ln1882">                  }</a>
<a name="ln1883">            case OVE::ArticulationType::Down_Bow_Inverted :{</a>
<a name="ln1884">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1885">                  a-&gt;setSymId(SymId::stringsDownBow);</a>
<a name="ln1886">                  a-&gt;ryoffset() = 5.3;</a>
<a name="ln1887">                  cr-&gt;add(a);</a>
<a name="ln1888">                  break;</a>
<a name="ln1889">                  }</a>
<a name="ln1890">            case OVE::ArticulationType::Natural_Harmonic :{</a>
<a name="ln1891">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1892">                  a-&gt;setSymId(SymId::stringsHarmonic);</a>
<a name="ln1893">                  cr-&gt;add(a);</a>
<a name="ln1894">                  break;</a>
<a name="ln1895">                  }</a>
<a name="ln1896">            case OVE::ArticulationType::Artificial_Harmonic :{</a>
<a name="ln1897">                  break;</a>
<a name="ln1898">                  }</a>
<a name="ln1899">            case OVE::ArticulationType::Finger_1 :</a>
<a name="ln1900">            case OVE::ArticulationType::Finger_2 :</a>
<a name="ln1901">            case OVE::ArticulationType::Finger_3 :</a>
<a name="ln1902">            case OVE::ArticulationType::Finger_4 :</a>
<a name="ln1903">            case OVE::ArticulationType::Finger_5 :{</a>
<a name="ln1904">                  break;</a>
<a name="ln1905">                  }</a>
<a name="ln1906">            case OVE::ArticulationType::Plus_Sign :{</a>
<a name="ln1907">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1908">                  a-&gt;setSymId(SymId::brassMuteClosed);</a>
<a name="ln1909">                  cr-&gt;add(a);</a>
<a name="ln1910">                  break;</a>
<a name="ln1911">                  }</a>
<a name="ln1912">            case OVE::ArticulationType::Arpeggio :{</a>
<a name="ln1913">                  // there can be only one</a>
<a name="ln1914">                  if (!(static_cast&lt;Ms::Chord*&gt;(cr))-&gt;arpeggio()) {</a>
<a name="ln1915">                        Arpeggio* a = new Arpeggio(score_);</a>
<a name="ln1916">                        a-&gt;setArpeggioType(ArpeggioType::NORMAL);</a>
<a name="ln1917">                        /*      	if (art-&gt;getPlacementAbove()){</a>
<a name="ln1918">            a-&gt;setSubtype(ArpeggioType::UP);</a>
<a name="ln1919">         }else {</a>
<a name="ln1920">            a-&gt;setSubtype(ARpeggioType::DOWN);</a>
<a name="ln1921">         }*/</a>
<a name="ln1922">                        cr-&gt;add(a);</a>
<a name="ln1923">                        }</a>
<a name="ln1924"> </a>
<a name="ln1925">                  break;</a>
<a name="ln1926">                  }</a>
<a name="ln1927">            case OVE::ArticulationType::Fermata :{</a>
<a name="ln1928">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1929">                  a-&gt;setUp(true);</a>
<a name="ln1930">                  a-&gt;setSymId(SymId::fermataAbove);</a>
<a name="ln1931">                  cr-&gt;add(a);</a>
<a name="ln1932">                  break;</a>
<a name="ln1933">                  }</a>
<a name="ln1934">            case OVE::ArticulationType::Fermata_Inverted :{</a>
<a name="ln1935">                  Articulation* a = new Articulation(score_);</a>
<a name="ln1936">                  a-&gt;setDirection(Direction::DOWN);</a>
<a name="ln1937">                  a-&gt;setSymId(SymId::fermataBelow);</a>
<a name="ln1938">                  cr-&gt;add(a);</a>
<a name="ln1939">                  break;</a>
<a name="ln1940">                  }</a>
<a name="ln1941">            case OVE::ArticulationType::Pedal_Down :{</a>
<a name="ln1942">                  if (pedal_) {</a>
<a name="ln1943">                        delete pedal_;</a>
<a name="ln1944">                        pedal_ = 0;</a>
<a name="ln1945">                        }</a>
<a name="ln1946">                  else {</a>
<a name="ln1947">                        pedal_ = new Pedal(score_);</a>
<a name="ln1948">                        pedal_-&gt;setTrack(track);</a>
<a name="ln1949">                        Segment* seg = measure-&gt;getSegment(SegmentType::ChordRest, Fraction::fromTicks(absTick));</a>
<a name="ln1950">                        pedal_-&gt;setTick(seg-&gt;tick());</a>
<a name="ln1951">                        }</a>
<a name="ln1952">                  break;</a>
<a name="ln1953">                  }</a>
<a name="ln1954">            case OVE::ArticulationType::Pedal_Up :{</a>
<a name="ln1955">                  if(pedal_){</a>
<a name="ln1956">                        Segment* seg = measure-&gt;getSegment(SegmentType::ChordRest, Fraction::fromTicks(absTick));</a>
<a name="ln1957">                        pedal_-&gt;setTick2(seg-&gt;tick());</a>
<a name="ln1958">                        score_-&gt;addSpanner(pedal_);</a>
<a name="ln1959">                        pedal_ = 0;</a>
<a name="ln1960">                        }</a>
<a name="ln1961">                  break;</a>
<a name="ln1962">                  }</a>
<a name="ln1963">                  //	case OVE::ArticulationType::Toe_Pedal :</a>
<a name="ln1964">                  //	case OVE::ArticulationType::Heel_Pedal :</a>
<a name="ln1965">                  //	case OVE::ArticulationType::Toe_To_Heel_Pedal :</a>
<a name="ln1966">                  //	case OVE::ArticulationType::Heel_To_Toe_Pedal :</a>
<a name="ln1967">                  //	case OVE::ArticulationType::Open_String :</a>
<a name="ln1968">            default:</a>
<a name="ln1969">                  break;</a>
<a name="ln1970">            }</a>
<a name="ln1971">      }</a>
<a name="ln1972"> </a>
<a name="ln1973">void OveToMScore::convertLyrics(Measure* measure, int part, int staff, int track){</a>
<a name="ln1974">      OVE::MeasureData* measureData = ove_-&gt;getMeasureData(part, staff, measure-&gt;no());</a>
<a name="ln1975">      if(measureData == 0)</a>
<a name="ln1976">            return;</a>
<a name="ln1977"> </a>
<a name="ln1978">      QList&lt;OVE::MusicData*&gt; lyrics = measureData-&gt;getMusicDatas(OVE::MusicDataType::Lyric);</a>
<a name="ln1979"> </a>
<a name="ln1980">      for(int i=0; i&lt;lyrics.size(); ++i){</a>
<a name="ln1981">            OVE::Lyric* oveLyric = static_cast&lt;OVE::Lyric*&gt;(lyrics[i]);</a>
<a name="ln1982">            int tick = mtt_-&gt;getTick(measure-&gt;no(), oveLyric-&gt;getTick());</a>
<a name="ln1983"> </a>
<a name="ln1984">            Lyrics* lyric = new Lyrics(score_);</a>
<a name="ln1985">            lyric-&gt;setNo(oveLyric-&gt;getVerse());</a>
<a name="ln1986">            lyric-&gt;setPlainText(oveLyric-&gt;getLyric());</a>
<a name="ln1987">            lyric-&gt;setTrack(track);</a>
<a name="ln1988">            Segment* segment = measure-&gt;getSegment(SegmentType::ChordRest, Fraction::fromTicks(tick));</a>
<a name="ln1989">            if (segment-&gt;element(track))</a>
<a name="ln1990">                  static_cast&lt;ChordRest*&gt;(segment-&gt;element(track))-&gt;add(lyric);</a>
<a name="ln1991">            }</a>
<a name="ln1992">      }</a>
<a name="ln1993"> </a>
<a name="ln1994">void OveToMScore::convertHarmonys(Measure* measure, int part, int staff, int track){</a>
<a name="ln1995">      OVE::MeasureData* measureData = ove_-&gt;getMeasureData(part, staff, measure-&gt;no());</a>
<a name="ln1996">      if(measureData == 0)</a>
<a name="ln1997">            return;</a>
<a name="ln1998"> </a>
<a name="ln1999">      QList&lt;OVE::MusicData*&gt; harmonys = measureData-&gt;getMusicDatas(OVE::MusicDataType::Harmony);</a>
<a name="ln2000"> </a>
<a name="ln2001">      for(int i=0; i&lt;harmonys.size(); ++i){</a>
<a name="ln2002">            OVE::Harmony* harmonyPtr = static_cast&lt;OVE::Harmony*&gt;(harmonys[i]);</a>
<a name="ln2003">            int absTick = mtt_-&gt;getTick(measure-&gt;no(), harmonyPtr-&gt;getTick());</a>
<a name="ln2004"> </a>
<a name="ln2005">            Harmony* harmony = new Harmony(score_);</a>
<a name="ln2006"> </a>
<a name="ln2007">            // TODO - does this need to be key-aware?</a>
<a name="ln2008">            harmony-&gt;setTrack(track);</a>
<a name="ln2009">            harmony-&gt;setRootTpc(step2tpc(harmonyPtr-&gt;getRoot(), AccidentalVal(harmonyPtr-&gt;getAlterRoot())));</a>
<a name="ln2010">            if(harmonyPtr-&gt;getBass() != OVE::INVALID_NOTE &amp;&amp; (harmonyPtr-&gt;getBass() != harmonyPtr-&gt;getRoot() || (harmonyPtr-&gt;getBass() == harmonyPtr-&gt;getRoot() &amp;&amp; harmonyPtr-&gt;getAlterBass() != harmonyPtr-&gt;getAlterRoot()))){</a>
<a name="ln2011">                  harmony-&gt;setBaseTpc(step2tpc(harmonyPtr-&gt;getBass(), AccidentalVal(harmonyPtr-&gt;getAlterBass())));</a>
<a name="ln2012">                  }</a>
<a name="ln2013">            const ChordDescription* d = harmony-&gt;fromXml(harmonyPtr-&gt;getHarmonyType());</a>
<a name="ln2014">            if(d != 0){</a>
<a name="ln2015">                  harmony-&gt;setId(d-&gt;id);</a>
<a name="ln2016">                  harmony-&gt;setTextName(d-&gt;names.front());</a>
<a name="ln2017">                  }</a>
<a name="ln2018">            else {</a>
<a name="ln2019">                  harmony-&gt;setId(-1);</a>
<a name="ln2020">                  harmony-&gt;setTextName(harmonyPtr-&gt;getHarmonyType());</a>
<a name="ln2021">                  }</a>
<a name="ln2022">            harmony-&gt;render();</a>
<a name="ln2023"> </a>
<a name="ln2024">            Segment* s = measure-&gt;getSegment(SegmentType::ChordRest, Fraction::fromTicks(absTick));</a>
<a name="ln2025">            s-&gt;add(harmony);</a>
<a name="ln2026">            }</a>
<a name="ln2027">      }</a>
<a name="ln2028"> </a>
<a name="ln2029">/*OVE::MusicData* OveToMScore::getMusicDataByUnit(int part, int staff, int measure, int unit, OVE::MusicDataType type){</a>
<a name="ln2030">   OVE::MeasureData* measureData = ove_-&gt;getMeasureData(part, staff, measure);</a>
<a name="ln2031">   if(measureData != 0) {</a>
<a name="ln2032">      const QList&lt;OVE::MusicData*&gt;&amp; datas = measureData-&gt;getMusicDatas(type);</a>
<a name="ln2033">      for(unsigned int i=0; i&lt;datas.size(); ++i){</a>
<a name="ln2034">         if(datas[i]-&gt;getTick() == unit){//different measurement</a>
<a name="ln2035">            return datas[i];</a>
<a name="ln2036">         }</a>
<a name="ln2037">      }</a>
<a name="ln2038">   }</a>
<a name="ln2039"> </a>
<a name="ln2040">   return 0;</a>
<a name="ln2041">}*/</a>
<a name="ln2042"> </a>
<a name="ln2043">OVE::MusicData* OveToMScore::getCrossMeasureElementByPos(int part, int staff, const OVE::MeasurePos&amp; pos, int voice, OVE::MusicDataType type){</a>
<a name="ln2044">      OVE::MeasureData* measureData = ove_-&gt;getMeasureData(part, staff, pos.getMeasure());</a>
<a name="ln2045">      if(measureData != 0) {</a>
<a name="ln2046">            const QList&lt;OVE::MusicData*&gt;&amp; datas = measureData-&gt;getCrossMeasureElements(type, OVE::MeasureData::PairType::All);</a>
<a name="ln2047">            for(int i=0; i&lt;datas.size(); ++i){</a>
<a name="ln2048">                  OVE::MeasurePos dataStart = datas[i]-&gt;start()-&gt;shiftMeasure(0);</a>
<a name="ln2049">                  OVE::MeasurePos dataStop = datas[i]-&gt;stop()-&gt;shiftMeasure(datas[i]-&gt;start()-&gt;getMeasure());</a>
<a name="ln2050"> </a>
<a name="ln2051">                  if(dataStart &lt;= pos &amp;&amp; dataStop &gt;= pos &amp;&amp; (int)datas[i]-&gt;getVoice() == voice){</a>
<a name="ln2052">                        return datas[i];</a>
<a name="ln2053">                        }</a>
<a name="ln2054">                  }</a>
<a name="ln2055">            }</a>
<a name="ln2056"> </a>
<a name="ln2057">      return 0;</a>
<a name="ln2058">      }</a>
<a name="ln2059"> </a>
<a name="ln2060">OVE::NoteContainer* OveToMScore::getContainerByPos(int part, int staff, const OVE::MeasurePos&amp; pos){</a>
<a name="ln2061">      OVE::MeasureData* measureData = ove_-&gt;getMeasureData(part, staff, pos.getMeasure());</a>
<a name="ln2062">      if(measureData != 0) {</a>
<a name="ln2063">            const QList&lt;OVE::NoteContainer*&gt;&amp; containers = measureData-&gt;getNoteContainers();</a>
<a name="ln2064">            for(int i=0; i&lt;containers.size(); ++i){</a>
<a name="ln2065">                  if(pos == containers[i]-&gt;start()-&gt;shiftMeasure(0)){</a>
<a name="ln2066">                        return containers[i];</a>
<a name="ln2067">                        }</a>
<a name="ln2068">                  }</a>
<a name="ln2069">            }</a>
<a name="ln2070"> </a>
<a name="ln2071">      return 0;</a>
<a name="ln2072">      }</a>
<a name="ln2073"> </a>
<a name="ln2074">void OveToMScore::convertRepeats(Measure* measure, int part, int staff, int track){</a>
<a name="ln2075">      OVE::MeasureData* measureData = ove_-&gt;getMeasureData(part, staff, measure-&gt;no());</a>
<a name="ln2076">      if(measureData == 0)</a>
<a name="ln2077">            return;</a>
<a name="ln2078"> </a>
<a name="ln2079">      int i;</a>
<a name="ln2080">      QList&lt;OVE::MusicData*&gt; repeats = measureData-&gt;getMusicDatas(OVE::MusicDataType::Repeat);</a>
<a name="ln2081"> </a>
<a name="ln2082">      for(i=0; i&lt;repeats.size(); ++i){</a>
<a name="ln2083">            OVE::RepeatSymbol* repeatPtr = static_cast&lt;OVE::RepeatSymbol*&gt;(repeats[i]);</a>
<a name="ln2084">            OVE::RepeatType type = repeatPtr-&gt;getRepeatType();</a>
<a name="ln2085">            Element* e = 0;</a>
<a name="ln2086"> </a>
<a name="ln2087">            switch(type) {</a>
<a name="ln2088">                  case OVE::RepeatType::Segno:{</a>
<a name="ln2089">                        Marker* marker = new Marker(score_);</a>
<a name="ln2090">                        marker-&gt;setMarkerType(Marker::Type::SEGNO);</a>
<a name="ln2091">                        e = marker;</a>
<a name="ln2092">                        break;</a>
<a name="ln2093">                        }</a>
<a name="ln2094">                  case OVE::RepeatType::Coda:{</a>
<a name="ln2095">                        Marker* marker = new Marker(score_);</a>
<a name="ln2096">                        marker-&gt;setMarkerType(Marker::Type::CODA);</a>
<a name="ln2097">                        e = marker;</a>
<a name="ln2098">                        break;</a>
<a name="ln2099">                        }</a>
<a name="ln2100">                  case OVE::RepeatType::DSAlCoda:{</a>
<a name="ln2101">                        Jump* jp = new Jump(score_);</a>
<a name="ln2102">                        jp-&gt;setJumpType(Jump::Type::DS_AL_CODA);</a>
<a name="ln2103">                        e = jp;</a>
<a name="ln2104">                        break;</a>
<a name="ln2105">                        }</a>
<a name="ln2106">                  case OVE::RepeatType::DSAlFine:{</a>
<a name="ln2107">                        Jump* jp = new Jump(score_);</a>
<a name="ln2108">                        jp-&gt;setJumpType(Jump::Type::DS_AL_FINE);</a>
<a name="ln2109">                        e = jp;</a>
<a name="ln2110">                        break;</a>
<a name="ln2111">                        }</a>
<a name="ln2112">                  case OVE::RepeatType::DCAlCoda:{</a>
<a name="ln2113">                        Jump* jp = new Jump(score_);</a>
<a name="ln2114">                        jp-&gt;setJumpType(Jump::Type::DC_AL_CODA);</a>
<a name="ln2115">                        e = jp;</a>
<a name="ln2116">                        break;</a>
<a name="ln2117">                        }</a>
<a name="ln2118">                  case OVE::RepeatType::DCAlFine:{</a>
<a name="ln2119">                        Jump* jp = new Jump(score_);</a>
<a name="ln2120">                        jp-&gt;setJumpType(Jump::Type::DC_AL_FINE);</a>
<a name="ln2121">                        e = jp;</a>
<a name="ln2122">                        break;</a>
<a name="ln2123">                        }</a>
<a name="ln2124">                  case OVE::RepeatType::ToCoda:{</a>
<a name="ln2125">                        Marker* m = new Marker(score_);</a>
<a name="ln2126">                        m-&gt;setMarkerType(Marker::Type::TOCODA);</a>
<a name="ln2127">                        e = m;</a>
<a name="ln2128">                        break;</a>
<a name="ln2129">                        }</a>
<a name="ln2130">                  case OVE::RepeatType::Fine:{</a>
<a name="ln2131">                        Marker* m = new Marker(score_);</a>
<a name="ln2132">                        m-&gt;setMarkerType(Marker::Type::FINE);</a>
<a name="ln2133">                        e = m;</a>
<a name="ln2134">                        break;</a>
<a name="ln2135">                        }</a>
<a name="ln2136">                  default:</a>
<a name="ln2137">                        break;</a>
<a name="ln2138">                  }</a>
<a name="ln2139"> </a>
<a name="ln2140">            if(e != 0){</a>
<a name="ln2141">                  e-&gt;setTrack(track);</a>
<a name="ln2142">                  measure-&gt;add(e);</a>
<a name="ln2143">                  }</a>
<a name="ln2144">            }</a>
<a name="ln2145"> </a>
<a name="ln2146">      QList&lt;OVE::MusicData*&gt; endings = measureData-&gt;getCrossMeasureElements(</a>
<a name="ln2147">                        OVE::MusicDataType::Numeric_Ending,</a>
<a name="ln2148">                        OVE::MeasureData::PairType::Start);</a>
<a name="ln2149"> </a>
<a name="ln2150">      for(i=0; i&lt;endings.size(); ++i){</a>
<a name="ln2151">            OVE::NumericEnding* ending = static_cast&lt;OVE::NumericEnding*&gt;(endings[i]);</a>
<a name="ln2152">            int absTick1 = mtt_-&gt;getTick(measure-&gt;no(), 0);</a>
<a name="ln2153">            int absTick2 = mtt_-&gt;getTick(measure-&gt;no() + ending-&gt;stop()-&gt;getMeasure(), 0);</a>
<a name="ln2154"> </a>
<a name="ln2155">            if (absTick1 &lt; absTick2) {</a>
<a name="ln2156">                  Volta* volta = new Volta(score_);</a>
<a name="ln2157">                  volta-&gt;setTrack(track);</a>
<a name="ln2158">                  volta-&gt;setTick(Fraction::fromTicks(absTick1));</a>
<a name="ln2159">                  volta-&gt;setTick2(Fraction::fromTicks(absTick2));</a>
<a name="ln2160">                  score_-&gt;addElement(volta);</a>
<a name="ln2161">                  volta-&gt;setVoltaType(Volta::Type::CLOSED);</a>
<a name="ln2162">                  volta-&gt;setText(ending-&gt;getText());</a>
<a name="ln2163"> </a>
<a name="ln2164">                  volta-&gt;endings().clear();</a>
<a name="ln2165">                  QList&lt;int&gt; numbers = ending-&gt;getNumbers();</a>
<a name="ln2166">                  for (int j = 0; j &lt; numbers.size(); ++j) {</a>
<a name="ln2167">                        volta-&gt;endings().append(numbers[j]);</a>
<a name="ln2168">                        }</a>
<a name="ln2169">                  }</a>
<a name="ln2170">            }</a>
<a name="ln2171">      }</a>
<a name="ln2172"> </a>
<a name="ln2173">void OveToMScore::convertSlurs(Measure* measure, int part, int staff, int track){</a>
<a name="ln2174">      OVE::MeasureData* measureData = ove_-&gt;getMeasureData(part, staff, measure-&gt;no());</a>
<a name="ln2175">      if(measureData == 0)</a>
<a name="ln2176">            return;</a>
<a name="ln2177"> </a>
<a name="ln2178">      QList&lt;OVE::MusicData*&gt; slurs = measureData-&gt;getCrossMeasureElements(OVE::MusicDataType::Slur, OVE::MeasureData::PairType::Start);</a>
<a name="ln2179"> </a>
<a name="ln2180">      for(int i=0; i&lt;slurs.size(); ++i){</a>
<a name="ln2181">            OVE::Slur* slurPtr = static_cast&lt;OVE::Slur*&gt;(slurs[i]);</a>
<a name="ln2182"> </a>
<a name="ln2183">            OVE::NoteContainer* startContainer = getContainerByPos(part, staff, slurPtr-&gt;start()-&gt;shiftMeasure(0));</a>
<a name="ln2184">            OVE::NoteContainer* endContainer = getContainerByPos(</a>
<a name="ln2185">                              part,</a>
<a name="ln2186">                              staff,</a>
<a name="ln2187">                              slurPtr-&gt;stop()-&gt;shiftMeasure(slurPtr-&gt;start()-&gt;getMeasure()));</a>
<a name="ln2188"> </a>
<a name="ln2189">            if(startContainer != 0 &amp;&amp; endContainer != 0){</a>
<a name="ln2190">                  int absStartTick = mtt_-&gt;getTick(slurPtr-&gt;start()-&gt;getMeasure(), startContainer-&gt;getTick());</a>
<a name="ln2191">                  int absEndTick = mtt_-&gt;getTick(slurPtr-&gt;start()-&gt;getMeasure()+slurPtr-&gt;stop()-&gt;getMeasure(), endContainer-&gt;getTick());</a>
<a name="ln2192"> </a>
<a name="ln2193">                  Slur* slur = new Slur(score_);</a>
<a name="ln2194">                  slur-&gt;setSlurDirection(slurPtr-&gt;getShowOnTop()? Direction::UP : Direction::DOWN);</a>
<a name="ln2195">                  slur-&gt;setTick(Fraction::fromTicks(absStartTick));</a>
<a name="ln2196">                  slur-&gt;setTick2(Fraction::fromTicks(absEndTick));</a>
<a name="ln2197">                  slur-&gt;setTrack(track);</a>
<a name="ln2198">                  slur-&gt;setTrack2(track+endContainer-&gt;getOffsetStaff());</a>
<a name="ln2199"> </a>
<a name="ln2200">                  score_-&gt;addSpanner(slur);</a>
<a name="ln2201">                  }</a>
<a name="ln2202">            }</a>
<a name="ln2203">      }</a>
<a name="ln2204"> </a>
<a name="ln2205">QString OveDynamics_To_Dynamics(OVE::DynamicsType type){</a>
<a name="ln2206">      QString dynamic = &quot;other-dynamics&quot;;</a>
<a name="ln2207"> </a>
<a name="ln2208">      switch( type ){</a>
<a name="ln2209">            case OVE::DynamicsType::PPPP:</a>
<a name="ln2210">                  dynamic = &quot;pppp&quot;;</a>
<a name="ln2211">                  break;</a>
<a name="ln2212">            case OVE::DynamicsType::PPP:</a>
<a name="ln2213">                  dynamic = &quot;ppp&quot;;</a>
<a name="ln2214">                  break;</a>
<a name="ln2215">            case OVE::DynamicsType::PP:</a>
<a name="ln2216">                  dynamic = &quot;pp&quot;;</a>
<a name="ln2217">                  break;</a>
<a name="ln2218">            case OVE::DynamicsType::P:</a>
<a name="ln2219">                  dynamic = &quot;p&quot;;</a>
<a name="ln2220">                  break;</a>
<a name="ln2221">            case OVE::DynamicsType::MP:</a>
<a name="ln2222">                  dynamic = &quot;mp&quot;;</a>
<a name="ln2223">                  break;</a>
<a name="ln2224">            case OVE::DynamicsType::MF:</a>
<a name="ln2225">                  dynamic = &quot;mf&quot;;</a>
<a name="ln2226">                  break;</a>
<a name="ln2227">            case OVE::DynamicsType::F:</a>
<a name="ln2228">                  dynamic = &quot;f&quot;;</a>
<a name="ln2229">                  break;</a>
<a name="ln2230">            case OVE::DynamicsType::FF:</a>
<a name="ln2231">                  dynamic = &quot;ff&quot;;</a>
<a name="ln2232">                  break;</a>
<a name="ln2233">            case OVE::DynamicsType::FFF:</a>
<a name="ln2234">                  dynamic = &quot;fff&quot;;</a>
<a name="ln2235">                  break;</a>
<a name="ln2236">            case OVE::DynamicsType::FFFF:</a>
<a name="ln2237">                  dynamic = &quot;ffff&quot;;</a>
<a name="ln2238">                  break;</a>
<a name="ln2239">            case OVE::DynamicsType::SF:</a>
<a name="ln2240">                  dynamic = &quot;sf&quot;;</a>
<a name="ln2241">                  break;</a>
<a name="ln2242">            case OVE::DynamicsType::FZ:</a>
<a name="ln2243">                  dynamic = &quot;fz&quot;;</a>
<a name="ln2244">                  break;</a>
<a name="ln2245">            case OVE::DynamicsType::SFZ:</a>
<a name="ln2246">                  dynamic = &quot;sfz&quot;;</a>
<a name="ln2247">                  break;</a>
<a name="ln2248">            case OVE::DynamicsType::SFFZ:</a>
<a name="ln2249">                  dynamic = &quot;sffz&quot;;</a>
<a name="ln2250">                  break;</a>
<a name="ln2251">            case OVE::DynamicsType::FP:</a>
<a name="ln2252">                  dynamic = &quot;fp&quot;;</a>
<a name="ln2253">                  break;</a>
<a name="ln2254">            case OVE::DynamicsType::SFP:</a>
<a name="ln2255">                  dynamic = &quot;sfp&quot;;</a>
<a name="ln2256">                  break;</a>
<a name="ln2257">            default:</a>
<a name="ln2258">                  break;</a>
<a name="ln2259">            }</a>
<a name="ln2260"> </a>
<a name="ln2261">      return dynamic;</a>
<a name="ln2262">      }</a>
<a name="ln2263"> </a>
<a name="ln2264">void OveToMScore::convertDynamics(Measure* measure, int part, int staff, int track){</a>
<a name="ln2265">      OVE::MeasureData* measureData = ove_-&gt;getMeasureData(part, staff, measure-&gt;no());</a>
<a name="ln2266">      if(measureData == 0)</a>
<a name="ln2267">            return;</a>
<a name="ln2268"> </a>
<a name="ln2269">      QList&lt;OVE::MusicData*&gt; dynamics = measureData-&gt;getMusicDatas(OVE::MusicDataType::Dynamics);</a>
<a name="ln2270"> </a>
<a name="ln2271">      for(int i=0; i&lt;dynamics.size(); ++i){</a>
<a name="ln2272">            OVE::Dynamics* dynamicPtr = static_cast&lt;OVE::Dynamics*&gt;(dynamics[i]);</a>
<a name="ln2273">            int absTick = mtt_-&gt;getTick(measure-&gt;no(), dynamicPtr-&gt;getTick());</a>
<a name="ln2274">            Dynamic* dynamic = new Dynamic(score_);</a>
<a name="ln2275"> </a>
<a name="ln2276">            dynamic-&gt;setDynamicType(OveDynamics_To_Dynamics(dynamicPtr-&gt;getDynamicsType()));</a>
<a name="ln2277">            dynamic-&gt;setTrack(track);</a>
<a name="ln2278"> </a>
<a name="ln2279">            Segment* s = measure-&gt;getSegment(SegmentType::ChordRest, Fraction::fromTicks(absTick));</a>
<a name="ln2280">            s-&gt;add(dynamic);</a>
<a name="ln2281">            }</a>
<a name="ln2282">      }</a>
<a name="ln2283"> </a>
<a name="ln2284">void OveToMScore::convertExpressions(Measure* measure, int part, int staff, int track){</a>
<a name="ln2285">      OVE::MeasureData* measureData = ove_-&gt;getMeasureData(part, staff, measure-&gt;no());</a>
<a name="ln2286">      if(measureData == 0)</a>
<a name="ln2287">            return;</a>
<a name="ln2288"> </a>
<a name="ln2289">      QList&lt;OVE::MusicData*&gt; expressions = measureData-&gt;getMusicDatas(OVE::MusicDataType::Expressions);</a>
<a name="ln2290"> </a>
<a name="ln2291">      for(int i=0; i&lt;expressions.size(); ++i){</a>
<a name="ln2292">            OVE::Expressions* expressionPtr = static_cast&lt;OVE::Expressions*&gt;(expressions[i]);</a>
<a name="ln2293">            int absTick = mtt_-&gt;getTick(measure-&gt;no(), expressionPtr-&gt;getTick());</a>
<a name="ln2294">            Text* t = new Text(score_, Tid::EXPRESSION);</a>
<a name="ln2295"> </a>
<a name="ln2296">            t-&gt;setPlainText(expressionPtr-&gt;getText());</a>
<a name="ln2297">            t-&gt;setTrack(track);</a>
<a name="ln2298"> </a>
<a name="ln2299">            Segment* s = measure-&gt;getSegment(SegmentType::ChordRest, Fraction::fromTicks(absTick));</a>
<a name="ln2300">            s-&gt;add(t);</a>
<a name="ln2301">            }</a>
<a name="ln2302">      }</a>
<a name="ln2303"> </a>
<a name="ln2304">void OveToMScore::convertGlissandos(Measure* measure, int part, int staff, int track){</a>
<a name="ln2305">      OVE::MeasureData* measureData = ove_-&gt;getMeasureData(part, staff, measure-&gt;no());</a>
<a name="ln2306">      if(measureData == 0)</a>
<a name="ln2307">            return;</a>
<a name="ln2308"> </a>
<a name="ln2309">      QList&lt;OVE::MusicData*&gt; glissandos = measureData-&gt;getCrossMeasureElements(OVE::MusicDataType::Glissando, OVE::MeasureData::PairType::All);</a>
<a name="ln2310"> </a>
<a name="ln2311">      for(int i=0; i&lt;glissandos.size(); ++i){</a>
<a name="ln2312">            OVE::Glissando* glissandoPtr = static_cast&lt;OVE::Glissando*&gt;(glissandos[i]);</a>
<a name="ln2313">            OVE::NoteContainer* startContainer = getContainerByPos(part, staff, glissandoPtr-&gt;start()-&gt;shiftMeasure(0));</a>
<a name="ln2314">            OVE::NoteContainer* endContainer = getContainerByPos(</a>
<a name="ln2315">                              part,</a>
<a name="ln2316">                              staff,</a>
<a name="ln2317">                              glissandoPtr-&gt;stop()-&gt;shiftMeasure(glissandoPtr-&gt;start()-&gt;getMeasure()));</a>
<a name="ln2318"> </a>
<a name="ln2319">            if(startContainer != 0 &amp;&amp; endContainer != 0){</a>
<a name="ln2320">                  int absTick = mtt_-&gt;getTick(measure-&gt;no(), glissandoPtr-&gt;getTick());</a>
<a name="ln2321">                  ChordRest* cr = measure-&gt;findChordRest(Fraction::fromTicks(absTick), track);</a>
<a name="ln2322">                  if(cr != 0){</a>
<a name="ln2323">                        Glissando* g = new Glissando(score_);</a>
<a name="ln2324">                        g-&gt;setGlissandoType(GlissandoType::WAVY);</a>
<a name="ln2325">                        cr-&gt;add(g);</a>
<a name="ln2326">                        }</a>
<a name="ln2327">                  }</a>
<a name="ln2328">            }</a>
<a name="ln2329">      }</a>
<a name="ln2330"> </a>
<a name="ln2331">static HairpinType OveWedgeType_To_Type(OVE::WedgeType type) {</a>
<a name="ln2332">      HairpinType subtype = HairpinType::CRESC_HAIRPIN;</a>
<a name="ln2333">      switch(type) {</a>
<a name="ln2334">            case OVE::WedgeType::Cres_Line: {</a>
<a name="ln2335">                  subtype = HairpinType::CRESC_HAIRPIN;</a>
<a name="ln2336">                  break;</a>
<a name="ln2337">                  }</a>
<a name="ln2338">            case OVE::WedgeType::Double_Line: {</a>
<a name="ln2339">                  subtype = HairpinType::CRESC_HAIRPIN;</a>
<a name="ln2340">                  break;</a>
<a name="ln2341">                  }</a>
<a name="ln2342">            case OVE::WedgeType::Decresc_Line: {</a>
<a name="ln2343">                  subtype = HairpinType::DECRESC_HAIRPIN;</a>
<a name="ln2344">                  break;</a>
<a name="ln2345">                  }</a>
<a name="ln2346">            case OVE::WedgeType::Cres: {</a>
<a name="ln2347">                  subtype = HairpinType::CRESC_HAIRPIN;</a>
<a name="ln2348">                  break;</a>
<a name="ln2349">                  }</a>
<a name="ln2350">            case OVE::WedgeType::Decresc: {</a>
<a name="ln2351">                  subtype = HairpinType::DECRESC_HAIRPIN;</a>
<a name="ln2352">                  break;</a>
<a name="ln2353">                  }</a>
<a name="ln2354">            default:</a>
<a name="ln2355">                  break;</a>
<a name="ln2356">            }</a>
<a name="ln2357"> </a>
<a name="ln2358">      return subtype;</a>
<a name="ln2359">      }</a>
<a name="ln2360"> </a>
<a name="ln2361">void OveToMScore::convertWedges(Measure* measure, int part, int staff, int track) {</a>
<a name="ln2362">      OVE::MeasureData* measureData = ove_-&gt;getMeasureData(part, staff, measure-&gt;no());</a>
<a name="ln2363">      if(measureData == 0)</a>
<a name="ln2364">            return;</a>
<a name="ln2365"> </a>
<a name="ln2366">      QList&lt;OVE::MusicData*&gt; wedges = measureData-&gt;getCrossMeasureElements(OVE::MusicDataType::Wedge, OVE::MeasureData::PairType::All);</a>
<a name="ln2367"> </a>
<a name="ln2368">      for(int i=0; i&lt;wedges.size(); ++i){</a>
<a name="ln2369">            OVE::Wedge* wedgePtr = static_cast&lt;OVE::Wedge*&gt;(wedges[i]);</a>
<a name="ln2370">            int absTick = mtt_-&gt;getTick(</a>
<a name="ln2371">                              measure-&gt;no(),</a>
<a name="ln2372">                              MeasureToTick::unitToTick(wedgePtr-&gt;start()-&gt;getOffset(), ove_-&gt;getQuarter()));</a>
<a name="ln2373">            int absTick2 = mtt_-&gt;getTick(</a>
<a name="ln2374">                              measure-&gt;no()+wedgePtr-&gt;stop()-&gt;getMeasure(),</a>
<a name="ln2375">                              MeasureToTick::unitToTick(wedgePtr-&gt;stop()-&gt;getOffset(), ove_-&gt;getQuarter()));</a>
<a name="ln2376"> </a>
<a name="ln2377">            if (absTick2 &gt; absTick) {</a>
<a name="ln2378">                  Hairpin* hp = new Hairpin(score_);</a>
<a name="ln2379"> </a>
<a name="ln2380">                  hp-&gt;setHairpinType(OveWedgeType_To_Type(wedgePtr-&gt;getWedgeType()));</a>
<a name="ln2381">                  //hp-&gt;setYoff(wedgePtr-&gt;getYOffset());</a>
<a name="ln2382">                  hp-&gt;setTrack(track);</a>
<a name="ln2383"> </a>
<a name="ln2384">                  hp-&gt;setTick(Fraction::fromTicks(absTick));</a>
<a name="ln2385">                  hp-&gt;setTick2(Fraction::fromTicks(absTick2));</a>
<a name="ln2386">                  hp-&gt;setAnchor(Spanner::Anchor::SEGMENT);</a>
<a name="ln2387">                  score_-&gt;addSpanner(hp);</a>
<a name="ln2388">                  score_-&gt;updateHairpin(hp);</a>
<a name="ln2389">                  }</a>
<a name="ln2390">            }</a>
<a name="ln2391">      }</a>
<a name="ln2392"> </a>
<a name="ln2393">//////////////////////////////////////////////////////////////////////////</a>
<a name="ln2394"> </a>
<a name="ln2395">Score::FileError importOve(MasterScore* score, const QString&amp; name) {</a>
<a name="ln2396">      OVE::IOVEStreamLoader* oveLoader = OVE::createOveStreamLoader();</a>
<a name="ln2397">      OVE::OveSong oveSong;</a>
<a name="ln2398"> </a>
<a name="ln2399">      QFile oveFile(name);</a>
<a name="ln2400">      if(!oveFile.exists())</a>
<a name="ln2401">            return Score::FileError::FILE_NOT_FOUND;</a>
<a name="ln2402">      if (!oveFile.open(QFile::ReadOnly)) {</a>
<a name="ln2403">            //messageOutString(QString(&quot;can't read file!&quot;));</a>
<a name="ln2404">            return Score::FileError::FILE_OPEN_ERROR;</a>
<a name="ln2405">            }</a>
<a name="ln2406"> </a>
<a name="ln2407">      QByteArray buffer = oveFile.readAll();</a>
<a name="ln2408"> </a>
<a name="ln2409">      oveFile.close();</a>
<a name="ln2410"> </a>
<a name="ln2411">      oveSong.setTextCodecName(preferences.getString(PREF_IMPORT_OVERTURE_CHARSET));</a>
<a name="ln2412">      oveLoader-&gt;setOve(&amp;oveSong);</a>
<a name="ln2413">      oveLoader-&gt;setFileStream((unsigned char*) buffer.data(), buffer.size());</a>
<a name="ln2414">      bool result = oveLoader-&gt;load();</a>
<a name="ln2415">      oveLoader-&gt;release();</a>
<a name="ln2416"> </a>
<a name="ln2417">      if(result){</a>
<a name="ln2418">            OveToMScore otm;</a>
<a name="ln2419">            otm.convert(&amp;oveSong, score);</a>
<a name="ln2420"> </a>
<a name="ln2421">            //		score-&gt;connectSlurs();</a>
<a name="ln2422">            }</a>
<a name="ln2423"> </a>
<a name="ln2424">      return result ? Score::FileError::FILE_NO_ERROR : Score::FileError::FILE_ERROR;</a>
<a name="ln2425">      }</a>
<a name="ln2426"> </a>

</code></pre>
<div class="balloon" rel="564"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 564, 568</p></div>
<div class="balloon" rel="556"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 556, 560</p></div>
<div class="balloon" rel="542"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 542, 546</p></div>
<div class="balloon" rel="534"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 534, 538</p></div>
<div class="balloon" rel="526"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 526, 530</p></div>
<div class="balloon" rel="518"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 518, 522</p></div>
<div class="balloon" rel="494"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 494, 510, 514</p></div>
<div class="balloon" rel="502"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 502, 506</p></div>
<div class="balloon" rel="892"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v560/" target="_blank">V560</a> A part of conditional expression is always true: k > 0.</p></div>
<div class="balloon" rel="1078"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 1078, 1098, 1103</p></div>
<div class="balloon" rel="1224"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 1224, 1236</p></div>
<div class="balloon" rel="1257"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v560/" target="_blank">V560</a> A part of conditional expression is always true: bartype != BarLineType::END_START_REPEAT.</p></div>
<div class="balloon" rel="2010"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v728/" target="_blank">V728</a> An excessive check can be simplified. The '||' operator is surrounded by opposite expressions.</p></div>
<div class="balloon" rel="2343"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 2343, 2351</p></div>
<div class="balloon" rel="2335"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 2335, 2339, 2347</p></div>
<div class="balloon" rel="226"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: score_.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
