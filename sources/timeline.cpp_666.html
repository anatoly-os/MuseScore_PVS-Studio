
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>timeline.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2013 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;timeline.h&quot;</a>
<a name="ln14">#include &quot;navigator.h&quot;</a>
<a name="ln15">#include &quot;musescore.h&quot;</a>
<a name="ln16">#include &quot;libmscore/score.h&quot;</a>
<a name="ln17">#include &quot;libmscore/page.h&quot;</a>
<a name="ln18">#include &quot;preferences.h&quot;</a>
<a name="ln19">#include &quot;libmscore/mscore.h&quot;</a>
<a name="ln20">#include &quot;libmscore/system.h&quot;</a>
<a name="ln21">#include &quot;libmscore/measurebase.h&quot;</a>
<a name="ln22">#include &quot;libmscore/measure.h&quot;</a>
<a name="ln23">#include &quot;libmscore/chord.h&quot;</a>
<a name="ln24">#include &quot;libmscore/staff.h&quot;</a>
<a name="ln25">#include &quot;libmscore/rest.h&quot;</a>
<a name="ln26">#include &quot;libmscore/part.h&quot;</a>
<a name="ln27">#include &quot;libmscore/tempo.h&quot;</a>
<a name="ln28">#include &quot;libmscore/keysig.h&quot;</a>
<a name="ln29">#include &quot;libmscore/timesig.h&quot;</a>
<a name="ln30">#include &quot;libmscore/key.h&quot;</a>
<a name="ln31">#include &quot;libmscore/tempotext.h&quot;</a>
<a name="ln32">#include &quot;libmscore/text.h&quot;</a>
<a name="ln33">#include &quot;libmscore/rehearsalmark.h&quot;</a>
<a name="ln34">#include &quot;libmscore/barline.h&quot;</a>
<a name="ln35">#include &quot;libmscore/jump.h&quot;</a>
<a name="ln36">#include &quot;libmscore/marker.h&quot;</a>
<a name="ln37">#include &quot;texttools.h&quot;</a>
<a name="ln38">#include &quot;mixer.h&quot;</a>
<a name="ln39">#include &quot;tourhandler.h&quot;</a>
<a name="ln40"> </a>
<a name="ln41">namespace Ms {</a>
<a name="ln42"> </a>
<a name="ln43">//---------------------------------------------------------</a>
<a name="ln44">//   showTimeline</a>
<a name="ln45">//---------------------------------------------------------</a>
<a name="ln46"> </a>
<a name="ln47">void MuseScore::showTimeline(bool visible)</a>
<a name="ln48">      {</a>
<a name="ln49">      QSplitter* split = static_cast&lt;QSplitter*&gt;(_timeline-&gt;widget());</a>
<a name="ln50">      Timeline* time = static_cast&lt;Timeline*&gt;(split-&gt;widget(1));</a>
<a name="ln51"> </a>
<a name="ln52">      QAction* act = getAction(&quot;toggle-timeline&quot;);</a>
<a name="ln53">      if (!time) {</a>
<a name="ln54">            time = new Timeline(_timeline);</a>
<a name="ln55">            time-&gt;setScore(0);</a>
<a name="ln56">            time-&gt;setScoreView(cv);</a>
<a name="ln57">            }</a>
<a name="ln58">      connect(_timeline, SIGNAL(visibilityChanged(bool)), act, SLOT(setChecked(bool)));</a>
<a name="ln59">      connect(_timeline, SIGNAL(closed(bool)), act, SLOT(setChecked(bool)));</a>
<a name="ln60">      reDisplayDockWidget(_timeline, visible);</a>
<a name="ln61"> </a>
<a name="ln62">      getAction(&quot;toggle-timeline&quot;)-&gt;setChecked(visible);</a>
<a name="ln63">      if (visible)</a>
<a name="ln64">            TourHandler::startTour(&quot;timeline-tour&quot;);</a>
<a name="ln65">      }</a>
<a name="ln66"> </a>
<a name="ln67">//---------------------------------------------------------</a>
<a name="ln68">//   TDockWidget</a>
<a name="ln69">//---------------------------------------------------------</a>
<a name="ln70"> </a>
<a name="ln71">TDockWidget::TDockWidget(QWidget* w)</a>
<a name="ln72">   : QDockWidget(w)</a>
<a name="ln73">      {</a>
<a name="ln74">      setFocusPolicy(Qt::NoFocus);</a>
<a name="ln75">      _grid = new QSplitter();</a>
<a name="ln76">      setWidget(_grid);</a>
<a name="ln77">      _grid-&gt;setHandleWidth(0);</a>
<a name="ln78">      setAllowedAreas(Qt::DockWidgetAreas(Qt::TopDockWidgetArea | Qt::BottomDockWidgetArea));</a>
<a name="ln79">      setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Expanding);</a>
<a name="ln80"> </a>
<a name="ln81">      setWindowTitle(tr(&quot;Timeline&quot;));</a>
<a name="ln82">      setObjectName(&quot;Timeline&quot;);</a>
<a name="ln83">      }</a>
<a name="ln84"> </a>
<a name="ln85">//---------------------------------------------------------</a>
<a name="ln86">//   closeEvent</a>
<a name="ln87">//---------------------------------------------------------</a>
<a name="ln88"> </a>
<a name="ln89">void TDockWidget::closeEvent(QCloseEvent* event)</a>
<a name="ln90">      {</a>
<a name="ln91">      emit closed(false);</a>
<a name="ln92">      QWidget::closeEvent(event);</a>
<a name="ln93">      }</a>
<a name="ln94"> </a>
<a name="ln95">//---------------------------------------------------------</a>
<a name="ln96">//   TRowLabels</a>
<a name="ln97">//---------------------------------------------------------</a>
<a name="ln98"> </a>
<a name="ln99">TRowLabels::TRowLabels(TDockWidget* dock_widget, Timeline* time, QGraphicsView* w)</a>
<a name="ln100">  : QGraphicsView(w)</a>
<a name="ln101">      {</a>
<a name="ln102">      setFocusPolicy(Qt::NoFocus);</a>
<a name="ln103">      scrollArea = dock_widget;</a>
<a name="ln104">      parent = time;</a>
<a name="ln105">      setScene(new QGraphicsScene);</a>
<a name="ln106">      scene()-&gt;setBackgroundBrush(Qt::lightGray);</a>
<a name="ln107">      setSceneRect(0, 0, 50, time-&gt;height());</a>
<a name="ln108"> </a>
<a name="ln109">      setMinimumWidth(0);</a>
<a name="ln110"> </a>
<a name="ln111">      QSplitter* split = scrollArea-&gt;grid();</a>
<a name="ln112">      QList&lt;int&gt; sizes;</a>
<a name="ln113">      //TODO: Replace 70 with hard coded value</a>
<a name="ln114">      sizes &lt;&lt; 70 &lt;&lt; 10000;</a>
<a name="ln115">      split-&gt;setSizes(sizes);</a>
<a name="ln116"> </a>
<a name="ln117">      setHorizontalScrollBarPolicy(Qt::ScrollBarAlwaysOff);</a>
<a name="ln118">      setVerticalScrollBarPolicy(Qt::ScrollBarAlwaysOff);</a>
<a name="ln119">      setContentsMargins(0, 0, 0, 0);</a>
<a name="ln120">      setAlignment(Qt::Alignment((Qt::AlignLeft | Qt::AlignTop)));</a>
<a name="ln121"> </a>
<a name="ln122">      connect(verticalScrollBar(), SIGNAL(valueChanged(int)), time-&gt;verticalScrollBar(), SLOT(setValue(int)));</a>
<a name="ln123">      connect(verticalScrollBar(), SIGNAL(valueChanged(int)), this, SLOT(restrict_scroll(int)));</a>
<a name="ln124">      connect(this, SIGNAL(moved(QPointF)), time, SLOT(mouseOver(QPointF)));</a>
<a name="ln125"> </a>
<a name="ln126">      static const char* ud_arrow[] = {</a>
<a name="ln127">                  &quot;10 18 2 1&quot;,</a>
<a name="ln128">                  &quot;# c #000000&quot;,</a>
<a name="ln129">                  &quot;. c #d3d3d3&quot;,</a>
<a name="ln130">                  &quot;..........&quot;,</a>
<a name="ln131">                  &quot;..........&quot;,</a>
<a name="ln132">                  &quot;....##....&quot;,</a>
<a name="ln133">                  &quot;...####...&quot;,</a>
<a name="ln134">                  &quot;..##..##..&quot;,</a>
<a name="ln135">                  &quot;..#....#..&quot;,</a>
<a name="ln136">                  &quot;..........&quot;,</a>
<a name="ln137">                  &quot;..........&quot;,</a>
<a name="ln138">                  &quot;..........&quot;,</a>
<a name="ln139">                  &quot;..........&quot;,</a>
<a name="ln140">                  &quot;..........&quot;,</a>
<a name="ln141">                  &quot;..........&quot;,</a>
<a name="ln142">                  &quot;..#....#..&quot;,</a>
<a name="ln143">                  &quot;..##..##..&quot;,</a>
<a name="ln144">                  &quot;...####...&quot;,</a>
<a name="ln145">                  &quot;....##....&quot;,</a>
<a name="ln146">                  &quot;..........&quot;,</a>
<a name="ln147">                  &quot;..........&quot;</a>
<a name="ln148">                  };</a>
<a name="ln149"> </a>
<a name="ln150">      static const char* u_arrow[] = {</a>
<a name="ln151">                  &quot;10 18 2 1&quot;,</a>
<a name="ln152">                  &quot;# c #000000&quot;,</a>
<a name="ln153">                  &quot;. c #d3d3d3&quot;,</a>
<a name="ln154">                  &quot;..........&quot;,</a>
<a name="ln155">                  &quot;..........&quot;,</a>
<a name="ln156">                  &quot;....##....&quot;,</a>
<a name="ln157">                  &quot;...####...&quot;,</a>
<a name="ln158">                  &quot;..##..##..&quot;,</a>
<a name="ln159">                  &quot;..#....#..&quot;,</a>
<a name="ln160">                  &quot;..........&quot;,</a>
<a name="ln161">                  &quot;..........&quot;,</a>
<a name="ln162">                  &quot;..........&quot;,</a>
<a name="ln163">                  &quot;..........&quot;,</a>
<a name="ln164">                  &quot;..........&quot;,</a>
<a name="ln165">                  &quot;..........&quot;,</a>
<a name="ln166">                  &quot;..........&quot;,</a>
<a name="ln167">                  &quot;..........&quot;,</a>
<a name="ln168">                  &quot;..........&quot;,</a>
<a name="ln169">                  &quot;..........&quot;,</a>
<a name="ln170">                  &quot;..........&quot;,</a>
<a name="ln171">                  &quot;..........&quot;</a>
<a name="ln172">                  };</a>
<a name="ln173"> </a>
<a name="ln174">      static const char* d_arrow[] = {</a>
<a name="ln175">                  &quot;10 18 2 1&quot;,</a>
<a name="ln176">                  &quot;# c #000000&quot;,</a>
<a name="ln177">                  &quot;. c #d3d3d3&quot;,</a>
<a name="ln178">                  &quot;..........&quot;,</a>
<a name="ln179">                  &quot;..........&quot;,</a>
<a name="ln180">                  &quot;..........&quot;,</a>
<a name="ln181">                  &quot;..........&quot;,</a>
<a name="ln182">                  &quot;..........&quot;,</a>
<a name="ln183">                  &quot;..........&quot;,</a>
<a name="ln184">                  &quot;..........&quot;,</a>
<a name="ln185">                  &quot;..........&quot;,</a>
<a name="ln186">                  &quot;..........&quot;,</a>
<a name="ln187">                  &quot;..........&quot;,</a>
<a name="ln188">                  &quot;..........&quot;,</a>
<a name="ln189">                  &quot;..........&quot;,</a>
<a name="ln190">                  &quot;..#....#..&quot;,</a>
<a name="ln191">                  &quot;..##..##..&quot;,</a>
<a name="ln192">                  &quot;...####...&quot;,</a>
<a name="ln193">                  &quot;....##....&quot;,</a>
<a name="ln194">                  &quot;..........&quot;,</a>
<a name="ln195">                  &quot;..........&quot;</a>
<a name="ln196">                  };</a>
<a name="ln197"> </a>
<a name="ln198">      static const char* cu_arrow[] = {</a>
<a name="ln199">                  &quot;9 18 2 1&quot;,</a>
<a name="ln200">                  &quot;# c #000000&quot;,</a>
<a name="ln201">                  &quot;. c #d3d3d3&quot;,</a>
<a name="ln202">                  &quot;.........&quot;,</a>
<a name="ln203">                  &quot;.........&quot;,</a>
<a name="ln204">                  &quot;.........&quot;,</a>
<a name="ln205">                  &quot;.........&quot;,</a>
<a name="ln206">                  &quot;....#....&quot;,</a>
<a name="ln207">                  &quot;...###...&quot;,</a>
<a name="ln208">                  &quot;..#.#.#..&quot;,</a>
<a name="ln209">                  &quot;.#..#..#.&quot;,</a>
<a name="ln210">                  &quot;....#....&quot;,</a>
<a name="ln211">                  &quot;....#....&quot;,</a>
<a name="ln212">                  &quot;....#....&quot;,</a>
<a name="ln213">                  &quot;....#....&quot;,</a>
<a name="ln214">                  &quot;.........&quot;,</a>
<a name="ln215">                  &quot;.........&quot;,</a>
<a name="ln216">                  &quot;.........&quot;,</a>
<a name="ln217">                  &quot;.........&quot;,</a>
<a name="ln218">                  &quot;.........&quot;,</a>
<a name="ln219">                  &quot;.........&quot;</a>
<a name="ln220">                  };</a>
<a name="ln221"> </a>
<a name="ln222">      static const char* cd_arrow[] = {</a>
<a name="ln223">                  &quot;9 18 2 1&quot;,</a>
<a name="ln224">                  &quot;# c #000000&quot;,</a>
<a name="ln225">                  &quot;. c #d3d3d3&quot;,</a>
<a name="ln226">                  &quot;.........&quot;,</a>
<a name="ln227">                  &quot;.........&quot;,</a>
<a name="ln228">                  &quot;.........&quot;,</a>
<a name="ln229">                  &quot;.........&quot;,</a>
<a name="ln230">                  &quot;.........&quot;,</a>
<a name="ln231">                  &quot;....#....&quot;,</a>
<a name="ln232">                  &quot;....#....&quot;,</a>
<a name="ln233">                  &quot;....#....&quot;,</a>
<a name="ln234">                  &quot;....#....&quot;,</a>
<a name="ln235">                  &quot;....#....&quot;,</a>
<a name="ln236">                  &quot;.#..#..#.&quot;,</a>
<a name="ln237">                  &quot;..#.#.#..&quot;,</a>
<a name="ln238">                  &quot;...###...&quot;,</a>
<a name="ln239">                  &quot;....#....&quot;,</a>
<a name="ln240">                  &quot;.........&quot;,</a>
<a name="ln241">                  &quot;.........&quot;,</a>
<a name="ln242">                  &quot;.........&quot;,</a>
<a name="ln243">                  &quot;.........&quot;</a>
<a name="ln244">                  };</a>
<a name="ln245"> </a>
<a name="ln246">      static const char* open_eye[] = {</a>
<a name="ln247">                  &quot;11 18 2 1&quot;,</a>
<a name="ln248">                  &quot;# c #000000&quot;,</a>
<a name="ln249">                  &quot;. c #d3d3d3&quot;,</a>
<a name="ln250">                  &quot;...........&quot;,</a>
<a name="ln251">                  &quot;...........&quot;,</a>
<a name="ln252">                  &quot;...........&quot;,</a>
<a name="ln253">                  &quot;...........&quot;,</a>
<a name="ln254">                  &quot;...####....&quot;,</a>
<a name="ln255">                  &quot;.##....##..&quot;,</a>
<a name="ln256">                  &quot;.#......#..&quot;,</a>
<a name="ln257">                  &quot;#........#.&quot;,</a>
<a name="ln258">                  &quot;#...##...#.&quot;,</a>
<a name="ln259">                  &quot;#...##...#.&quot;,</a>
<a name="ln260">                  &quot;#........#.&quot;,</a>
<a name="ln261">                  &quot;.#......#..&quot;,</a>
<a name="ln262">                  &quot;.##....##..&quot;,</a>
<a name="ln263">                  &quot;...####....&quot;,</a>
<a name="ln264">                  &quot;...........&quot;,</a>
<a name="ln265">                  &quot;...........&quot;,</a>
<a name="ln266">                  &quot;...........&quot;,</a>
<a name="ln267">                  &quot;...........&quot;</a>
<a name="ln268">                  };</a>
<a name="ln269"> </a>
<a name="ln270">      static const char* closed_eye[] = {</a>
<a name="ln271">                  &quot;11 18 2 1&quot;,</a>
<a name="ln272">                  &quot;# c #000000&quot;,</a>
<a name="ln273">                  &quot;. c #d3d3d3&quot;,</a>
<a name="ln274">                  &quot;...........&quot;,</a>
<a name="ln275">                  &quot;...........&quot;,</a>
<a name="ln276">                  &quot;...........&quot;,</a>
<a name="ln277">                  &quot;...........&quot;,</a>
<a name="ln278">                  &quot;...........&quot;,</a>
<a name="ln279">                  &quot;...........&quot;,</a>
<a name="ln280">                  &quot;...........&quot;,</a>
<a name="ln281">                  &quot;..######...&quot;,</a>
<a name="ln282">                  &quot;##..##..##.&quot;,</a>
<a name="ln283">                  &quot;##..##..##.&quot;,</a>
<a name="ln284">                  &quot;..######...&quot;,</a>
<a name="ln285">                  &quot;...........&quot;,</a>
<a name="ln286">                  &quot;...........&quot;,</a>
<a name="ln287">                  &quot;...........&quot;,</a>
<a name="ln288">                  &quot;...........&quot;,</a>
<a name="ln289">                  &quot;...........&quot;,</a>
<a name="ln290">                  &quot;...........&quot;,</a>
<a name="ln291">                  &quot;...........&quot;</a>
<a name="ln292">                  };</a>
<a name="ln293"> </a>
<a name="ln294"> </a>
<a name="ln295">      mouseover_map[MouseOverValue::COLLAPSE_DOWN_ARROW] = new QPixmap(cd_arrow);</a>
<a name="ln296">      mouseover_map[MouseOverValue::COLLAPSE_UP_ARROW] = new QPixmap(cu_arrow);</a>
<a name="ln297">      mouseover_map[MouseOverValue::MOVE_DOWN_ARROW] = new QPixmap(d_arrow);</a>
<a name="ln298">      mouseover_map[MouseOverValue::MOVE_UP_DOWN_ARROW] = new QPixmap(ud_arrow);</a>
<a name="ln299">      mouseover_map[MouseOverValue::MOVE_UP_ARROW] = new QPixmap(u_arrow);</a>
<a name="ln300">      mouseover_map[MouseOverValue::OPEN_EYE] = new QPixmap(open_eye);</a>
<a name="ln301">      mouseover_map[MouseOverValue::CLOSED_EYE] = new QPixmap(closed_eye);</a>
<a name="ln302"> </a>
<a name="ln303">      std::tuple&lt;QGraphicsPixmapItem*, MouseOverValue, unsigned int&gt; tmp(nullptr, MouseOverValue::NONE, -1);</a>
<a name="ln304">      old_item_info = tmp;</a>
<a name="ln305"> </a>
<a name="ln306">      connect(this, SIGNAL(requestContextMenu(QContextMenuEvent*)), parent, SLOT(contextMenuEvent(QContextMenuEvent*)));</a>
<a name="ln307">      }</a>
<a name="ln308"> </a>
<a name="ln309">//---------------------------------------------------------</a>
<a name="ln310">//   restrict_scroll</a>
<a name="ln311">//---------------------------------------------------------</a>
<a name="ln312"> </a>
<a name="ln313">void TRowLabels::restrict_scroll(int value)</a>
<a name="ln314">      {</a>
<a name="ln315">      if (value &gt; parent-&gt;verticalScrollBar()-&gt;maximum())</a>
<a name="ln316">            verticalScrollBar()-&gt;setValue(parent-&gt;verticalScrollBar()-&gt;maximum());</a>
<a name="ln317">      for (std::vector&lt;std::pair&lt;QGraphicsItem*, int&gt;&gt;::iterator it = meta_labels.begin();</a>
<a name="ln318">           it != meta_labels.end(); ++it) {</a>
<a name="ln319">            std::pair&lt;QGraphicsItem*, int&gt; pair_graphic_int = *it;</a>
<a name="ln320"> </a>
<a name="ln321">            QGraphicsItem* graphics_item = pair_graphic_int.first;</a>
<a name="ln322"> </a>
<a name="ln323">            QGraphicsRectItem* graphics_rect_item = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(graphics_item);</a>
<a name="ln324">            QGraphicsLineItem* graphics_line_item = qgraphicsitem_cast&lt;QGraphicsLineItem*&gt;(graphics_item);</a>
<a name="ln325">            QGraphicsPixmapItem* graphics_pixmap_item = qgraphicsitem_cast&lt;QGraphicsPixmapItem*&gt;(graphics_item);</a>
<a name="ln326">            int y = pair_graphic_int.second * 20;</a>
<a name="ln327">            int scrollbar_value = verticalScrollBar()-&gt;value();</a>
<a name="ln328"> </a>
<a name="ln329">            if (graphics_rect_item) {</a>
<a name="ln330">                  QRectF rectf = graphics_rect_item-&gt;rect();</a>
<a name="ln331">                  rectf.setY(qreal(scrollbar_value + y));</a>
<a name="ln332">                  rectf.setHeight(20);</a>
<a name="ln333">                  graphics_rect_item-&gt;setRect(rectf);</a>
<a name="ln334">                  }</a>
<a name="ln335">            else if (graphics_line_item) {</a>
<a name="ln336">                  QLineF linef = graphics_line_item-&gt;line();</a>
<a name="ln337">                  linef.setLine(linef.x1(), y + scrollbar_value + 1, linef.x2(), y + scrollbar_value + 1);</a>
<a name="ln338">                  graphics_line_item-&gt;setLine(linef);</a>
<a name="ln339">                  }</a>
<a name="ln340">            else if (graphics_pixmap_item)</a>
<a name="ln341">                  graphics_pixmap_item-&gt;setY(qreal(scrollbar_value + y + 1));</a>
<a name="ln342">            else</a>
<a name="ln343">                  graphics_item-&gt;setY(qreal(scrollbar_value + y));</a>
<a name="ln344">            }</a>
<a name="ln345">      viewport()-&gt;update();</a>
<a name="ln346"> </a>
<a name="ln347">      }</a>
<a name="ln348"> </a>
<a name="ln349">//---------------------------------------------------------</a>
<a name="ln350">//   updateLabels</a>
<a name="ln351">//---------------------------------------------------------</a>
<a name="ln352"> </a>
<a name="ln353">void TRowLabels::updateLabels(std::vector&lt;std::pair&lt;QString, bool&gt;&gt; labels, int height)</a>
<a name="ln354">      {</a>
<a name="ln355"> </a>
<a name="ln356">      scene()-&gt;clear();</a>
<a name="ln357">      meta_labels.clear();</a>
<a name="ln358">      if (labels.empty())</a>
<a name="ln359">            return;</a>
<a name="ln360"> </a>
<a name="ln361">      unsigned int num_metas = parent-&gt;nmetas();</a>
<a name="ln362">      int max_width = -1;</a>
<a name="ln363">      int measure_width = 0;</a>
<a name="ln364">      for (unsigned int row = 0; row &lt; labels.size(); row++) {</a>
<a name="ln365">            //Draw instrument name rectangle</a>
<a name="ln366">            int ypos = (row &lt; num_metas)? row * height + verticalScrollBar()-&gt;value() : row * height + 3;</a>
<a name="ln367">            QGraphicsRectItem* graphics_rect_item = new QGraphicsRectItem(0, ypos, width(), height);</a>
<a name="ln368">            QGraphicsTextItem* graphics_text_item = new QGraphicsTextItem(labels[row].first);</a>
<a name="ln369"> </a>
<a name="ln370">            if (row == num_metas - 1)</a>
<a name="ln371">                  measure_width = graphics_text_item-&gt;boundingRect().width();</a>
<a name="ln372">            max_width = max(max_width, int(graphics_text_item-&gt;boundingRect().width()));</a>
<a name="ln373"> </a>
<a name="ln374">            QFontMetrics f(QApplication::font());</a>
<a name="ln375">            QString part_name = f.elidedText(labels[row].first, Qt::ElideRight, width());</a>
<a name="ln376">            graphics_text_item-&gt;setPlainText(part_name);</a>
<a name="ln377">            graphics_text_item-&gt;setX(0);</a>
<a name="ln378">            graphics_text_item-&gt;setY(ypos);</a>
<a name="ln379">            if (labels[row].second)</a>
<a name="ln380">                  graphics_text_item-&gt;setDefaultTextColor(QColor(Qt::black));</a>
<a name="ln381">            else</a>
<a name="ln382">                  graphics_text_item-&gt;setDefaultTextColor(QColor(150, 150, 150));</a>
<a name="ln383">            graphics_rect_item-&gt;setPen(QPen(QColor(150, 150, 150)));</a>
<a name="ln384">            graphics_rect_item-&gt;setBrush(QBrush(QColor(211, 211, 211)));</a>
<a name="ln385">            graphics_text_item-&gt;setZValue(-1);</a>
<a name="ln386">            graphics_rect_item-&gt;setZValue(-1);</a>
<a name="ln387"> </a>
<a name="ln388">            graphics_rect_item-&gt;setData(0, QVariant::fromValue&lt;bool&gt;(false));</a>
<a name="ln389">            graphics_text_item-&gt;setData(0, QVariant::fromValue&lt;bool&gt;(false));</a>
<a name="ln390"> </a>
<a name="ln391">            MouseOverValue mouse_over_arrow = MouseOverValue::NONE;</a>
<a name="ln392">            if (num_metas - 1 == row &amp;&amp; (num_metas &gt; 2 || parent-&gt;collapsed())) {</a>
<a name="ln393">                  //Measures meta</a>
<a name="ln394">                  if (parent-&gt;collapsed())</a>
<a name="ln395">                        mouse_over_arrow = MouseOverValue::COLLAPSE_DOWN_ARROW;</a>
<a name="ln396">                  else</a>
<a name="ln397">                        mouse_over_arrow = MouseOverValue::COLLAPSE_UP_ARROW;</a>
<a name="ln398">                  }</a>
<a name="ln399">            else if (row &lt; num_metas - 1) {</a>
<a name="ln400">                  if (row != 0 &amp;&amp; row + 1 &lt;= num_metas - 2)</a>
<a name="ln401">                        mouse_over_arrow = MouseOverValue::MOVE_UP_DOWN_ARROW;</a>
<a name="ln402">                  else if (row == 0 &amp;&amp; row + 1 &lt; num_metas - 1)</a>
<a name="ln403">                        mouse_over_arrow = MouseOverValue::MOVE_DOWN_ARROW;</a>
<a name="ln404">                  else if (row == num_metas - 2 &amp;&amp; row != 0)</a>
<a name="ln405">                        mouse_over_arrow = MouseOverValue::MOVE_UP_ARROW;</a>
<a name="ln406">                  }</a>
<a name="ln407">            else if (num_metas &lt;= row) {</a>
<a name="ln408">                  if (parent-&gt;numToStaff(row - num_metas) &amp;&amp;</a>
<a name="ln409">                      parent-&gt;numToStaff(row - num_metas)-&gt;show())</a>
<a name="ln410">                        mouse_over_arrow = MouseOverValue::OPEN_EYE;</a>
<a name="ln411">                  else</a>
<a name="ln412">                        mouse_over_arrow = MouseOverValue::CLOSED_EYE;</a>
<a name="ln413">                  }</a>
<a name="ln414">            graphics_text_item-&gt;setData(1, QVariant::fromValue&lt;MouseOverValue&gt;(mouse_over_arrow));</a>
<a name="ln415">            graphics_rect_item-&gt;setData(1, QVariant::fromValue&lt;MouseOverValue&gt;(mouse_over_arrow));</a>
<a name="ln416"> </a>
<a name="ln417">            graphics_text_item-&gt;setData(2, QVariant::fromValue&lt;unsigned int&gt;(row));</a>
<a name="ln418">            graphics_rect_item-&gt;setData(2, QVariant::fromValue&lt;unsigned int&gt;(row));</a>
<a name="ln419"> </a>
<a name="ln420">            scene()-&gt;addItem(graphics_rect_item);</a>
<a name="ln421">            scene()-&gt;addItem(graphics_text_item);</a>
<a name="ln422">            if (row &lt; num_metas) {</a>
<a name="ln423">                  std::pair&lt;QGraphicsItem*, int&gt; p1(graphics_rect_item, row);</a>
<a name="ln424">                  std::pair&lt;QGraphicsItem*, int&gt; p2(graphics_text_item, row);</a>
<a name="ln425">                  meta_labels.push_back(p1);</a>
<a name="ln426">                  meta_labels.push_back(p2);</a>
<a name="ln427">                  graphics_rect_item-&gt;setZValue(1);</a>
<a name="ln428">                  graphics_text_item-&gt;setZValue(2);</a>
<a name="ln429">                  }</a>
<a name="ln430">            }</a>
<a name="ln431">      QGraphicsLineItem* graphics_line_item = new QGraphicsLineItem(0,</a>
<a name="ln432">                                                    height * num_metas + verticalScrollBar()-&gt;value() + 1,</a>
<a name="ln433">                                                    max(max_width + 20, 70),</a>
<a name="ln434">                                                    height * num_metas + verticalScrollBar()-&gt;value() + 1);</a>
<a name="ln435">      graphics_line_item-&gt;setPen(QPen(QColor(150, 150, 150), 4));</a>
<a name="ln436">      graphics_line_item-&gt;setZValue(0);</a>
<a name="ln437">      graphics_line_item-&gt;setData(0, QVariant::fromValue&lt;bool&gt;(false));</a>
<a name="ln438">      scene()-&gt;addItem(graphics_line_item);</a>
<a name="ln439"> </a>
<a name="ln440">      std::pair&lt;QGraphicsItem*, int&gt; graphics_line_item_pair(graphics_line_item, num_metas);</a>
<a name="ln441">      meta_labels.push_back(graphics_line_item_pair);</a>
<a name="ln442"> </a>
<a name="ln443">      setSceneRect(0, 0, max_width, parent-&gt;getHeight() + parent-&gt;horizontalScrollBar()-&gt;height());</a>
<a name="ln444"> </a>
<a name="ln445">      std::tuple&lt;QGraphicsPixmapItem*, MouseOverValue, unsigned int&gt; tmp(nullptr, MouseOverValue::NONE, -1);</a>
<a name="ln446">      old_item_info = tmp;</a>
<a name="ln447"> </a>
<a name="ln448">      setMinimumWidth(measure_width + 9);</a>
<a name="ln449">      setMaximumWidth(max(max_width + 20, 70));</a>
<a name="ln450">      mouseOver(mapToScene(mapFromGlobal(QCursor::pos())));</a>
<a name="ln451">      }</a>
<a name="ln452"> </a>
<a name="ln453">//---------------------------------------------------------</a>
<a name="ln454">//   resizeEvent</a>
<a name="ln455">//---------------------------------------------------------</a>
<a name="ln456"> </a>
<a name="ln457">void TRowLabels::resizeEvent(QResizeEvent*)</a>
<a name="ln458">      {</a>
<a name="ln459">      std::vector&lt;std::pair&lt;QString, bool&gt;&gt; labels = parent-&gt;getLabels();</a>
<a name="ln460">      updateLabels(labels, 20);</a>
<a name="ln461">      }</a>
<a name="ln462"> </a>
<a name="ln463">//---------------------------------------------------------</a>
<a name="ln464">//   mousePressEvent</a>
<a name="ln465">//---------------------------------------------------------</a>
<a name="ln466"> </a>
<a name="ln467">void TRowLabels::mousePressEvent(QMouseEvent* event)</a>
<a name="ln468">      {</a>
<a name="ln469">      if (event-&gt;button() == Qt::RightButton)</a>
<a name="ln470">            return;</a>
<a name="ln471"> </a>
<a name="ln472">      QPointF scene_pt = mapToScene(event-&gt;pos());</a>
<a name="ln473">      unsigned int num_metas = parent-&gt;nmetas();</a>
<a name="ln474"> </a>
<a name="ln475">      //Check if mouse position in scene is on the last meta</a>
<a name="ln476">      QPointF measure_meta_tl = QPointF(0, (num_metas - 1) * 20 + verticalScrollBar()-&gt;value());</a>
<a name="ln477">      QPointF measure_meta_br = QPointF(width(), num_metas * 20 + verticalScrollBar()-&gt;value());</a>
<a name="ln478">      if (QRectF(measure_meta_tl, measure_meta_br).contains(scene_pt) &amp;&amp; (num_metas &gt; 2 || parent-&gt;collapsed())) {</a>
<a name="ln479">            if (std::get&lt;0&gt;(old_item_info)) {</a>
<a name="ln480">                  std::pair&lt;QGraphicsItem*, int&gt; p(std::get&lt;0&gt;(old_item_info), std::get&lt;2&gt;(old_item_info));</a>
<a name="ln481">                  std::vector&lt;std::pair&lt;QGraphicsItem*, int&gt;&gt;::iterator it = std::find(meta_labels.begin(), meta_labels.end(), p);</a>
<a name="ln482">                  if (it != meta_labels.end())</a>
<a name="ln483">                        meta_labels.erase(it);</a>
<a name="ln484">                  scene()-&gt;removeItem(std::get&lt;0&gt;(old_item_info));</a>
<a name="ln485">                  }</a>
<a name="ln486">            std::tuple&lt;QGraphicsPixmapItem*, MouseOverValue, unsigned int&gt; tmp(nullptr, MouseOverValue::NONE, -1);</a>
<a name="ln487">            old_item_info = tmp;</a>
<a name="ln488">            mouseOver(mapToScene(mapFromGlobal(QCursor::pos())));</a>
<a name="ln489"> </a>
<a name="ln490">            parent-&gt;setCollapsed(!parent-&gt;collapsed());</a>
<a name="ln491">            parent-&gt;updateGrid();</a>
<a name="ln492">            }</a>
<a name="ln493">      else {</a>
<a name="ln494">            //Check if pixmap was selected</a>
<a name="ln495">            if (QGraphicsItem* graphics_item = scene()-&gt;itemAt(scene_pt, transform())) {</a>
<a name="ln496">                  QGraphicsPixmapItem* graphics_pixmap_item = qgraphicsitem_cast&lt;QGraphicsPixmapItem*&gt;(graphics_item);</a>
<a name="ln497">                  if (graphics_pixmap_item) {</a>
<a name="ln498">                        unsigned int row = graphics_pixmap_item-&gt;data(2).value&lt;unsigned int&gt;();</a>
<a name="ln499">                        if (row == num_metas - 1)</a>
<a name="ln500">                              return;</a>
<a name="ln501">                        else if (row &lt; num_metas - 1) {</a>
<a name="ln502">                              //Find mid point between up and down arrow</a>
<a name="ln503">                              qreal mid_point = graphics_pixmap_item-&gt;boundingRect().height() / 2 + graphics_pixmap_item-&gt;scenePos().y();</a>
<a name="ln504">                              if (scene_pt.y() &gt; mid_point)</a>
<a name="ln505">                                    emit swapMeta(row, false);</a>
<a name="ln506">                              else</a>
<a name="ln507">                                    emit swapMeta(row, true);</a>
<a name="ln508">                              }</a>
<a name="ln509">                        else if (row &gt;= num_metas)</a>
<a name="ln510">                              parent-&gt;toggleShow(row - num_metas);</a>
<a name="ln511">                        }</a>
<a name="ln512">                  else {</a>
<a name="ln513">                        dragging = true;</a>
<a name="ln514">                        this-&gt;setCursor(Qt::SizeAllCursor);</a>
<a name="ln515">                        old_loc = QPoint(int(scene_pt.x()), int(scene_pt.y()));</a>
<a name="ln516">                        }</a>
<a name="ln517"> </a>
<a name="ln518">                  }</a>
<a name="ln519">            else {</a>
<a name="ln520">                  dragging = true;</a>
<a name="ln521">                  this-&gt;setCursor(Qt::SizeAllCursor);</a>
<a name="ln522">                  old_loc = QPoint(int(scene_pt.x()), int(scene_pt.y()));</a>
<a name="ln523">                  }</a>
<a name="ln524">            }</a>
<a name="ln525">      }</a>
<a name="ln526"> </a>
<a name="ln527">//---------------------------------------------------------</a>
<a name="ln528">//   mouseMoveEvent</a>
<a name="ln529">//---------------------------------------------------------</a>
<a name="ln530"> </a>
<a name="ln531">void TRowLabels::mouseMoveEvent(QMouseEvent* event)</a>
<a name="ln532">      {</a>
<a name="ln533">      QPointF scene_pt = mapToScene(event-&gt;pos());</a>
<a name="ln534">      if (dragging) {</a>
<a name="ln535">            this-&gt;setCursor(Qt::SizeAllCursor);</a>
<a name="ln536">            int y_offset = int(old_loc.y()) - int(scene_pt.y());</a>
<a name="ln537">            verticalScrollBar()-&gt;setValue(verticalScrollBar()-&gt;value() + y_offset);</a>
<a name="ln538">            }</a>
<a name="ln539">      else</a>
<a name="ln540">            mouseOver(scene_pt);</a>
<a name="ln541">      emit moved(QPointF(-1, -1));</a>
<a name="ln542">      }</a>
<a name="ln543"> </a>
<a name="ln544">//---------------------------------------------------------</a>
<a name="ln545">//   mouseReleaseEvent</a>
<a name="ln546">//---------------------------------------------------------</a>
<a name="ln547"> </a>
<a name="ln548">void TRowLabels::mouseReleaseEvent(QMouseEvent* event)</a>
<a name="ln549">      {</a>
<a name="ln550">      if (QGraphicsItem* graphics_item = scene()-&gt;itemAt(mapToScene(event-&gt;pos()), transform())) {</a>
<a name="ln551">                  QGraphicsPixmapItem* graphics_pixmap_item = qgraphicsitem_cast&lt;QGraphicsPixmapItem*&gt;(graphics_item);</a>
<a name="ln552">                  if (graphics_pixmap_item)</a>
<a name="ln553">                        this-&gt;setCursor(Qt::PointingHandCursor);</a>
<a name="ln554">                  else</a>
<a name="ln555">                        this-&gt;setCursor(Qt::ArrowCursor);</a>
<a name="ln556">            }</a>
<a name="ln557">      else</a>
<a name="ln558">            this-&gt;setCursor(Qt::ArrowCursor);</a>
<a name="ln559">      dragging = false;</a>
<a name="ln560">      }</a>
<a name="ln561"> </a>
<a name="ln562">//---------------------------------------------------------</a>
<a name="ln563">//   leaveEvent</a>
<a name="ln564">//---------------------------------------------------------</a>
<a name="ln565"> </a>
<a name="ln566">void TRowLabels::leaveEvent(QEvent*)</a>
<a name="ln567">      {</a>
<a name="ln568">      if (!rect().contains(mapFromGlobal(QCursor::pos())))</a>
<a name="ln569">            mouseOver(mapToScene(mapFromGlobal(QCursor::pos())));</a>
<a name="ln570">      }</a>
<a name="ln571">//---------------------------------------------------------</a>
<a name="ln572">//   contextMenuEvent</a>
<a name="ln573">//---------------------------------------------------------</a>
<a name="ln574"> </a>
<a name="ln575">void TRowLabels::contextMenuEvent(QContextMenuEvent* event)</a>
<a name="ln576">      {</a>
<a name="ln577">      emit requestContextMenu(event);</a>
<a name="ln578">      }</a>
<a name="ln579"> </a>
<a name="ln580">//---------------------------------------------------------</a>
<a name="ln581">//   mouseOver</a>
<a name="ln582">//---------------------------------------------------------</a>
<a name="ln583"> </a>
<a name="ln584">void TRowLabels::mouseOver(QPointF scene_pt)</a>
<a name="ln585">      {</a>
<a name="ln586">      //Handle drawing of arrows</a>
<a name="ln587">      if (QGraphicsItem* graphics_item = scene()-&gt;itemAt(scene_pt, transform())) {</a>
<a name="ln588">            QGraphicsPixmapItem* graphics_pixmap_item = qgraphicsitem_cast&lt;QGraphicsPixmapItem*&gt;(graphics_item);</a>
<a name="ln589">            if (graphics_pixmap_item) {</a>
<a name="ln590">                  this-&gt;setCursor(Qt::PointingHandCursor);</a>
<a name="ln591">                  return;</a>
<a name="ln592">                  }</a>
<a name="ln593"> </a>
<a name="ln594">            MouseOverValue mouse_over_arrow = graphics_item-&gt;data(1).value&lt;MouseOverValue&gt;();</a>
<a name="ln595">            if (mouse_over_arrow != MouseOverValue::NONE) {</a>
<a name="ln596">                  QPixmap* pixmap_arrow = mouseover_map[mouse_over_arrow];</a>
<a name="ln597">                  QGraphicsPixmapItem* graphics_pixmap_item_arrow = new QGraphicsPixmapItem(*pixmap_arrow);</a>
<a name="ln598">                  unsigned int row = graphics_item-&gt;data(2).value&lt;unsigned int&gt;();</a>
<a name="ln599"> </a>
<a name="ln600">                  QString tooltip;</a>
<a name="ln601">                  switch (mouse_over_arrow) {</a>
<a name="ln602">                        case MouseOverValue::COLLAPSE_DOWN_ARROW:</a>
<a name="ln603">                              tooltip = tr(&quot;Expand meta rows&quot;);</a>
<a name="ln604">                              break;</a>
<a name="ln605">                        case MouseOverValue::COLLAPSE_UP_ARROW:</a>
<a name="ln606">                              tooltip = tr(&quot;Collapse meta rows&quot;);</a>
<a name="ln607">                              break;</a>
<a name="ln608">                        case MouseOverValue::MOVE_DOWN_ARROW:</a>
<a name="ln609">                              tooltip = tr(&quot;Move meta row down one&quot;);</a>
<a name="ln610">                              break;</a>
<a name="ln611">                        case MouseOverValue::MOVE_UP_ARROW:</a>
<a name="ln612">                              tooltip = tr(&quot;Move meta row up one&quot;);</a>
<a name="ln613">                              break;</a>
<a name="ln614">                        case MouseOverValue::MOVE_UP_DOWN_ARROW:</a>
<a name="ln615">                              tooltip = tr(&quot;Move meta row up/down one&quot;);</a>
<a name="ln616">                              break;</a>
<a name="ln617">                        case MouseOverValue::OPEN_EYE:</a>
<a name="ln618">                              tooltip = tr(&quot;Hide instrument in score&quot;);</a>
<a name="ln619">                              break;</a>
<a name="ln620">                        case MouseOverValue::CLOSED_EYE:</a>
<a name="ln621">                              tooltip = tr(&quot;Show instrument in score&quot;);</a>
<a name="ln622">                              break;</a>
<a name="ln623">                        default:</a>
<a name="ln624">                              tooltip = &quot;&quot;;</a>
<a name="ln625">                              break;</a>
<a name="ln626">                        }</a>
<a name="ln627"> </a>
<a name="ln628">                  graphics_pixmap_item_arrow-&gt;setToolTip(tooltip);</a>
<a name="ln629">                  if (mouse_over_arrow == MouseOverValue::OPEN_EYE || mouse_over_arrow == MouseOverValue::CLOSED_EYE)</a>
<a name="ln630">                        graphics_pixmap_item_arrow-&gt;setData(0, QVariant::fromValue&lt;bool&gt;(false));</a>
<a name="ln631">                  else</a>
<a name="ln632">                        graphics_pixmap_item_arrow-&gt;setData(0, QVariant::fromValue&lt;bool&gt;(true));</a>
<a name="ln633">                  graphics_pixmap_item_arrow-&gt;setData(1, QVariant::fromValue&lt;MouseOverValue&gt;(mouse_over_arrow));</a>
<a name="ln634">                  graphics_pixmap_item_arrow-&gt;setData(2, QVariant::fromValue&lt;unsigned int&gt;(row));</a>
<a name="ln635"> </a>
<a name="ln636">                  //Draw arrow at correct location</a>
<a name="ln637">                  if (row &lt; parent-&gt;nmetas()) {</a>
<a name="ln638">                        graphics_pixmap_item_arrow-&gt;setPos(width() - 12, verticalScrollBar()-&gt;value() + 1 + row * 20);</a>
<a name="ln639">                        graphics_pixmap_item_arrow-&gt;setZValue(3);</a>
<a name="ln640">                        }</a>
<a name="ln641">                  else {</a>
<a name="ln642">                        graphics_pixmap_item_arrow-&gt;setPos(width() - 13, row * 20 + 5);</a>
<a name="ln643">                        graphics_pixmap_item_arrow-&gt;setZValue(-1);</a>
<a name="ln644">                        }</a>
<a name="ln645"> </a>
<a name="ln646"> </a>
<a name="ln647">                  if (std::get&lt;2&gt;(old_item_info) == row &amp;&amp; std::get&lt;1&gt;(old_item_info) == mouse_over_arrow) {</a>
<a name="ln648">                        //DO NOTHING</a>
<a name="ln649">                        }</a>
<a name="ln650">                  else {</a>
<a name="ln651">                        if (std::get&lt;0&gt;(old_item_info)) {</a>
<a name="ln652">                              std::pair&lt;QGraphicsItem*, int&gt; p(std::get&lt;0&gt;(old_item_info), std::get&lt;2&gt;(old_item_info));</a>
<a name="ln653">                              std::vector&lt;std::pair&lt;QGraphicsItem*, int&gt;&gt;::iterator it = std::find(meta_labels.begin(), meta_labels.end(), p);</a>
<a name="ln654">                              if (it != meta_labels.end())</a>
<a name="ln655">                                    meta_labels.erase(it);</a>
<a name="ln656">                              scene()-&gt;removeItem(std::get&lt;0&gt;(old_item_info));</a>
<a name="ln657">                              }</a>
<a name="ln658">                        std::tuple&lt;QGraphicsPixmapItem*, MouseOverValue, unsigned int&gt; tmp(graphics_pixmap_item_arrow, mouse_over_arrow, row);</a>
<a name="ln659">                        old_item_info = tmp;</a>
<a name="ln660">                        if (mouse_over_arrow != MouseOverValue::OPEN_EYE &amp;&amp; mouse_over_arrow != MouseOverValue::CLOSED_EYE) {</a>
<a name="ln661">                              std::pair&lt;QGraphicsItem*, int&gt; p(graphics_pixmap_item_arrow, row);</a>
<a name="ln662">                              meta_labels.push_back(p);</a>
<a name="ln663">                              }</a>
<a name="ln664">                        scene()-&gt;addItem(graphics_pixmap_item_arrow);</a>
<a name="ln665">                        }</a>
<a name="ln666"> </a>
<a name="ln667">                  }</a>
<a name="ln668">            else {</a>
<a name="ln669">                  if (std::get&lt;0&gt;(old_item_info))</a>
<a name="ln670">                        scene()-&gt;removeItem(std::get&lt;0&gt;(old_item_info));</a>
<a name="ln671">                  std::tuple&lt;QGraphicsPixmapItem*, MouseOverValue, unsigned int&gt; tmp(nullptr, MouseOverValue::NONE, -1);</a>
<a name="ln672">                  old_item_info = tmp;</a>
<a name="ln673">                  }</a>
<a name="ln674">            }</a>
<a name="ln675">      else {</a>
<a name="ln676">            if (std::get&lt;0&gt;(old_item_info)) {</a>
<a name="ln677">                  std::pair&lt;QGraphicsItem*, int&gt; p(std::get&lt;0&gt;(old_item_info), std::get&lt;2&gt;(old_item_info));</a>
<a name="ln678">                  std::vector&lt;std::pair&lt;QGraphicsItem*, int&gt;&gt;::iterator it = std::find(meta_labels.begin(), meta_labels.end(), p);</a>
<a name="ln679">                  if (it != meta_labels.end())</a>
<a name="ln680">                        meta_labels.erase(it);</a>
<a name="ln681">                  scene()-&gt;removeItem(std::get&lt;0&gt;(old_item_info));</a>
<a name="ln682">                  }</a>
<a name="ln683">            std::tuple&lt;QGraphicsPixmapItem*, MouseOverValue, unsigned int&gt; tmp(nullptr, MouseOverValue::NONE, -1);</a>
<a name="ln684">            old_item_info = tmp;</a>
<a name="ln685">            }</a>
<a name="ln686">      if (QGraphicsItem* graphics_item = scene()-&gt;itemAt(scene_pt, transform())) {</a>
<a name="ln687">            QGraphicsPixmapItem* graphics_pixmap_item = qgraphicsitem_cast&lt;QGraphicsPixmapItem*&gt;(graphics_item);</a>
<a name="ln688">            if (graphics_pixmap_item)</a>
<a name="ln689">                  this-&gt;setCursor(Qt::PointingHandCursor);</a>
<a name="ln690">            else</a>
<a name="ln691">                  this-&gt;setCursor(Qt::ArrowCursor);</a>
<a name="ln692">            }</a>
<a name="ln693">      else</a>
<a name="ln694">            this-&gt;setCursor(Qt::ArrowCursor);</a>
<a name="ln695">      }</a>
<a name="ln696"> </a>
<a name="ln697">//---------------------------------------------------------</a>
<a name="ln698">//   cursorIsOn</a>
<a name="ln699">//---------------------------------------------------------</a>
<a name="ln700"> </a>
<a name="ln701">QString TRowLabels::cursorIsOn()</a>
<a name="ln702">      {</a>
<a name="ln703">      QPointF scene_pos = mapToScene(mapFromGlobal(QCursor::pos()));</a>
<a name="ln704">      QGraphicsItem* graphics_item = scene()-&gt;itemAt(scene_pos, transform());</a>
<a name="ln705">      if (graphics_item) {</a>
<a name="ln706">            auto it = meta_labels.begin();</a>
<a name="ln707">            for (;it != meta_labels.end(); ++it) {</a>
<a name="ln708">                  if ((*it).first == graphics_item)</a>
<a name="ln709">                        break;</a>
<a name="ln710">                  }</a>
<a name="ln711">            if (it != meta_labels.end())</a>
<a name="ln712">                  return &quot;meta&quot;;</a>
<a name="ln713">            else</a>
<a name="ln714">                  return &quot;instrument&quot;;</a>
<a name="ln715">            }</a>
<a name="ln716">      else</a>
<a name="ln717">            return &quot;&quot;;</a>
<a name="ln718">      }</a>
<a name="ln719"> </a>
<a name="ln720">//---------------------------------------------------------</a>
<a name="ln721">//   Timeline</a>
<a name="ln722">//---------------------------------------------------------</a>
<a name="ln723"> </a>
<a name="ln724">Timeline::Timeline(TDockWidget* dock_widget, QWidget* parent)</a>
<a name="ln725">  : QGraphicsView(parent)</a>
<a name="ln726">      {</a>
<a name="ln727">      setFocusPolicy(Qt::NoFocus);</a>
<a name="ln728">      setAlignment(Qt::Alignment((Qt::AlignLeft | Qt::AlignTop)));</a>
<a name="ln729">      setAttribute(Qt::WA_NoBackground);</a>
<a name="ln730"> </a>
<a name="ln731">      scrollArea = dock_widget;</a>
<a name="ln732">      QSplitter* split = static_cast&lt;QSplitter*&gt;(scrollArea-&gt;widget());</a>
<a name="ln733"> </a>
<a name="ln734">      row_names = new TRowLabels(dock_widget, this);</a>
<a name="ln735">      split-&gt;addWidget(row_names);</a>
<a name="ln736">      split-&gt;addWidget(this);</a>
<a name="ln737">      split-&gt;setChildrenCollapsible(false);</a>
<a name="ln738">      split-&gt;setStretchFactor(0, 0);</a>
<a name="ln739">      split-&gt;setStretchFactor(1, 0);</a>
<a name="ln740"> </a>
<a name="ln741">      setSizePolicy(QSizePolicy::Ignored, QSizePolicy::Ignored);</a>
<a name="ln742"> </a>
<a name="ln743">      setScene(new QGraphicsScene);</a>
<a name="ln744">      setSceneRect(0, 0, 100, 100);</a>
<a name="ln745">      scene()-&gt;setBackgroundBrush(Qt::lightGray);</a>
<a name="ln746"> </a>
<a name="ln747">      connect(verticalScrollBar(),SIGNAL(valueChanged(int)),row_names-&gt;verticalScrollBar(),SLOT(setValue(int)));</a>
<a name="ln748">      connect(verticalScrollBar(),SIGNAL(valueChanged(int)),this,SLOT(handle_scroll(int)));</a>
<a name="ln749">      connect(row_names, SIGNAL(swapMeta(uint,bool)), this, SLOT(swapMeta(uint,bool)));</a>
<a name="ln750">      connect(this, SIGNAL(moved(QPointF)), row_names, SLOT(mouseOver(QPointF)));</a>
<a name="ln751"> </a>
<a name="ln752">      std::tuple&lt;QString, void (Timeline::*)(Segment*, int*, int), bool&gt; t1(tr(&quot;Tempo&quot;), &amp;Ms::Timeline::tempo_meta, true);</a>
<a name="ln753">      std::tuple&lt;QString, void (Timeline::*)(Segment*, int*, int), bool&gt; t2(tr(&quot;Time Signature&quot;), &amp;Ms::Timeline::time_meta, true);</a>
<a name="ln754">      std::tuple&lt;QString, void (Timeline::*)(Segment*, int*, int), bool&gt; t3(tr(&quot;Rehearsal Mark&quot;), &amp;Ms::Timeline::rehearsal_meta, true);</a>
<a name="ln755">      std::tuple&lt;QString, void (Timeline::*)(Segment*, int*, int), bool&gt; t4(tr(&quot;Key Signature&quot;), &amp;Ms::Timeline::key_meta, true);</a>
<a name="ln756">      std::tuple&lt;QString, void (Timeline::*)(Segment*, int*, int), bool&gt; t5(tr(&quot;Barlines&quot;), &amp;Ms::Timeline::barline_meta, true);</a>
<a name="ln757">      std::tuple&lt;QString, void (Timeline::*)(Segment*, int*, int), bool&gt; t6(tr(&quot;Jumps and Markers&quot;), &amp;Ms::Timeline::jump_marker_meta, true);</a>
<a name="ln758">      std::tuple&lt;QString, void (Timeline::*)(Segment*, int*, int), bool&gt; t7(tr(&quot;Measures&quot;), &amp;Ms::Timeline::measure_meta, true);</a>
<a name="ln759">      metas.push_back(t1);</a>
<a name="ln760">      metas.push_back(t2);</a>
<a name="ln761">      metas.push_back(t3);</a>
<a name="ln762">      metas.push_back(t4);</a>
<a name="ln763">      metas.push_back(t5);</a>
<a name="ln764">      metas.push_back(t6);</a>
<a name="ln765">      metas.push_back(t7);</a>
<a name="ln766"> </a>
<a name="ln767">      std::tuple&lt;QGraphicsItem*, int, QColor&gt; ohi(nullptr, -1, QColor());</a>
<a name="ln768">      old_hover_info = ohi;</a>
<a name="ln769">      std::tuple&lt;int, qreal, Element*, Element*, bool&gt; ri(0, 0, nullptr, nullptr, false);</a>
<a name="ln770">      repeat_info = ri;</a>
<a name="ln771"> </a>
<a name="ln772">      static const char* left_repeat[] = {</a>
<a name="ln773">                  &quot;7 14 2 1&quot;,</a>
<a name="ln774">                  &quot;# c #000000&quot;,</a>
<a name="ln775">                  &quot;. c None&quot;,</a>
<a name="ln776">                  &quot;##.#...&quot;,</a>
<a name="ln777">                  &quot;##.#...&quot;,</a>
<a name="ln778">                  &quot;##.#...&quot;,</a>
<a name="ln779">                  &quot;##.#...&quot;,</a>
<a name="ln780">                  &quot;##.#.##&quot;,</a>
<a name="ln781">                  &quot;##.#.##&quot;,</a>
<a name="ln782">                  &quot;##.#...&quot;,</a>
<a name="ln783">                  &quot;##.#...&quot;,</a>
<a name="ln784">                  &quot;##.#.##&quot;,</a>
<a name="ln785">                  &quot;##.#.##&quot;,</a>
<a name="ln786">                  &quot;##.#...&quot;,</a>
<a name="ln787">                  &quot;##.#...&quot;,</a>
<a name="ln788">                  &quot;##.#...&quot;,</a>
<a name="ln789">                  &quot;##.#...&quot;</a>
<a name="ln790">                  };</a>
<a name="ln791"> </a>
<a name="ln792">      static const char* right_repeat[] = {</a>
<a name="ln793">                  &quot;7 14 2 1&quot;,</a>
<a name="ln794">                  &quot;# c #000000&quot;,</a>
<a name="ln795">                  &quot;. c None&quot;,</a>
<a name="ln796">                  &quot;...#.##&quot;,</a>
<a name="ln797">                  &quot;...#.##&quot;,</a>
<a name="ln798">                  &quot;...#.##&quot;,</a>
<a name="ln799">                  &quot;...#.##&quot;,</a>
<a name="ln800">                  &quot;##.#.##&quot;,</a>
<a name="ln801">                  &quot;##.#.##&quot;,</a>
<a name="ln802">                  &quot;...#.##&quot;,</a>
<a name="ln803">                  &quot;...#.##&quot;,</a>
<a name="ln804">                  &quot;##.#.##&quot;,</a>
<a name="ln805">                  &quot;##.#.##&quot;,</a>
<a name="ln806">                  &quot;...#.##&quot;,</a>
<a name="ln807">                  &quot;...#.##&quot;,</a>
<a name="ln808">                  &quot;...#.##&quot;,</a>
<a name="ln809">                  &quot;...#.##&quot;</a>
<a name="ln810">                  };</a>
<a name="ln811"> </a>
<a name="ln812">      static const char* final_barline[] = {</a>
<a name="ln813">                  &quot;7 14 2 1&quot;,</a>
<a name="ln814">                  &quot;# c #000000&quot;,</a>
<a name="ln815">                  &quot;. c None&quot;,</a>
<a name="ln816">                  &quot;...#.##&quot;,</a>
<a name="ln817">                  &quot;...#.##&quot;,</a>
<a name="ln818">                  &quot;...#.##&quot;,</a>
<a name="ln819">                  &quot;...#.##&quot;,</a>
<a name="ln820">                  &quot;...#.##&quot;,</a>
<a name="ln821">                  &quot;...#.##&quot;,</a>
<a name="ln822">                  &quot;...#.##&quot;,</a>
<a name="ln823">                  &quot;...#.##&quot;,</a>
<a name="ln824">                  &quot;...#.##&quot;,</a>
<a name="ln825">                  &quot;...#.##&quot;,</a>
<a name="ln826">                  &quot;...#.##&quot;,</a>
<a name="ln827">                  &quot;...#.##&quot;,</a>
<a name="ln828">                  &quot;...#.##&quot;,</a>
<a name="ln829">                  &quot;...#.##&quot;</a>
<a name="ln830">                  };</a>
<a name="ln831"> </a>
<a name="ln832">      static const char* double_barline[] = {</a>
<a name="ln833">                  &quot;7 14 2 1&quot;,</a>
<a name="ln834">                  &quot;# c #000000&quot;,</a>
<a name="ln835">                  &quot;. c None&quot;,</a>
<a name="ln836">                  &quot;..#.#..&quot;,</a>
<a name="ln837">                  &quot;..#.#..&quot;,</a>
<a name="ln838">                  &quot;..#.#..&quot;,</a>
<a name="ln839">                  &quot;..#.#..&quot;,</a>
<a name="ln840">                  &quot;..#.#..&quot;,</a>
<a name="ln841">                  &quot;..#.#..&quot;,</a>
<a name="ln842">                  &quot;..#.#..&quot;,</a>
<a name="ln843">                  &quot;..#.#..&quot;,</a>
<a name="ln844">                  &quot;..#.#..&quot;,</a>
<a name="ln845">                  &quot;..#.#..&quot;,</a>
<a name="ln846">                  &quot;..#.#..&quot;,</a>
<a name="ln847">                  &quot;..#.#..&quot;,</a>
<a name="ln848">                  &quot;..#.#..&quot;,</a>
<a name="ln849">                  &quot;..#.#..&quot;</a>
<a name="ln850">                  };</a>
<a name="ln851"> </a>
<a name="ln852">      QPixmap* left_repeat_pixmap = new QPixmap(left_repeat);</a>
<a name="ln853">      QPixmap* right_repeat_pixmap = new QPixmap(right_repeat);</a>
<a name="ln854">      QPixmap* final_barline_pixmap = new QPixmap(final_barline);</a>
<a name="ln855">      QPixmap* double_barline_pixmap = new QPixmap(double_barline);</a>
<a name="ln856"> </a>
<a name="ln857">      barlines[&quot;Start repeat&quot;] = left_repeat_pixmap;</a>
<a name="ln858">      barlines[&quot;End repeat&quot;] = right_repeat_pixmap;</a>
<a name="ln859">      barlines[&quot;Final barline&quot;] = final_barline_pixmap;</a>
<a name="ln860">      barlines[&quot;Double barline&quot;] = double_barline_pixmap;</a>
<a name="ln861">      }</a>
<a name="ln862"> </a>
<a name="ln863">//---------------------------------------------------------</a>
<a name="ln864">//   drawGrid</a>
<a name="ln865">//---------------------------------------------------------</a>
<a name="ln866"> </a>
<a name="ln867">void Timeline::drawGrid(int global_rows, int global_cols)</a>
<a name="ln868">      {</a>
<a name="ln869">      scene()-&gt;clear();</a>
<a name="ln870">      meta_rows.clear();</a>
<a name="ln871"> </a>
<a name="ln872">      if (global_rows == 0 || global_cols == 0) return;</a>
<a name="ln873">      int stagger = 0;</a>
<a name="ln874">      unsigned int num_metas = nmetas();</a>
<a name="ln875">      setMinimumHeight(grid_height * (num_metas + 1) + 5 + horizontalScrollBar()-&gt;height());</a>
<a name="ln876">      setMinimumWidth(grid_width * 3);</a>
<a name="ln877">      global_z_value = 1;</a>
<a name="ln878"> </a>
<a name="ln879">      //Draw grid</a>
<a name="ln880">      Measure* curr_measure = _score-&gt;firstMeasure();</a>
<a name="ln881">      QList&lt;Part*&gt; part_list = getParts();</a>
<a name="ln882">      for (int col = 0; col &lt; global_cols; col++) {</a>
<a name="ln883">            for (int row = 0; row &lt; global_rows; row++) {</a>
<a name="ln884">                  QGraphicsRectItem* graphics_rect_item = new QGraphicsRectItem(col * grid_width,</a>
<a name="ln885">                                                                                grid_height * (row + num_metas) + 3,</a>
<a name="ln886">                                                                                grid_width,</a>
<a name="ln887">                                                                                grid_height);</a>
<a name="ln888"> </a>
<a name="ln889">                  setMetaData(graphics_rect_item, row, ElementType::INVALID, curr_measure, false, 0);</a>
<a name="ln890"> </a>
<a name="ln891">                  QString translate_measure = tr(&quot;Measure&quot;);</a>
<a name="ln892">                  QChar initial_letter = translate_measure[0];</a>
<a name="ln893">                  QTextDocument doc;</a>
<a name="ln894">                  QString part_name = &quot;&quot;;</a>
<a name="ln895">                  if (part_list.size() &gt; row) {</a>
<a name="ln896">                        doc.setHtml(part_list.at(row)-&gt;longName());</a>
<a name="ln897">                        part_name = doc.toPlainText();</a>
<a name="ln898">                        }</a>
<a name="ln899">                  if (part_name.isEmpty() &amp;&amp; part_list.size() &gt; row)</a>
<a name="ln900">                        part_name = part_list.at(row)-&gt;instrumentName();</a>
<a name="ln901"> </a>
<a name="ln902">                  graphics_rect_item-&gt;setToolTip(initial_letter + QString(&quot; &quot;) + QString::number(curr_measure-&gt;no() + 1) + QString(&quot;, &quot;) + part_name);</a>
<a name="ln903">                  graphics_rect_item-&gt;setPen(QPen(QColor(Qt::lightGray)));</a>
<a name="ln904">                  graphics_rect_item-&gt;setBrush(QBrush(colorBox(graphics_rect_item)));</a>
<a name="ln905">                  graphics_rect_item-&gt;setZValue(-3);</a>
<a name="ln906">                  scene()-&gt;addItem(graphics_rect_item);</a>
<a name="ln907">                  }</a>
<a name="ln908"> </a>
<a name="ln909">            curr_measure = curr_measure-&gt;nextMeasure();</a>
<a name="ln910">            }</a>
<a name="ln911">      setSceneRect(0, 0, getWidth(), getHeight());</a>
<a name="ln912"> </a>
<a name="ln913">      //Draw meta rows and separator</a>
<a name="ln914">      QGraphicsLineItem* graphics_line_item_separator = new QGraphicsLineItem(0,</a>
<a name="ln915">                                                                              grid_height * num_metas + verticalScrollBar()-&gt;value() + 1,</a>
<a name="ln916">                                                                              getWidth() - 1,</a>
<a name="ln917">                                                                              grid_height * num_metas + verticalScrollBar()-&gt;value() + 1);</a>
<a name="ln918">      graphics_line_item_separator-&gt;setPen(QPen(QColor(150, 150, 150), 4));</a>
<a name="ln919">      graphics_line_item_separator-&gt;setZValue(-2);</a>
<a name="ln920">      scene()-&gt;addItem(graphics_line_item_separator);</a>
<a name="ln921">      std::pair&lt;QGraphicsItem*, int&gt; pair_graphics_int_separator(graphics_line_item_separator, num_metas);</a>
<a name="ln922">      meta_rows.push_back(pair_graphics_int_separator);</a>
<a name="ln923"> </a>
<a name="ln924">      for (unsigned int row = 0; row &lt; num_metas; row++) {</a>
<a name="ln925">            QGraphicsRectItem* meta_row = new QGraphicsRectItem(0,</a>
<a name="ln926">                                                                grid_height * row + verticalScrollBar()-&gt;value(),</a>
<a name="ln927">                                                                getWidth(),</a>
<a name="ln928">                                                                grid_height);</a>
<a name="ln929">            meta_row-&gt;setBrush(QBrush(QColor(211,211,211)));</a>
<a name="ln930">            meta_row-&gt;setPen(QPen(QColor(150, 150, 150)));</a>
<a name="ln931">            meta_row-&gt;setData(0, QVariant::fromValue&lt;int&gt;(-1));</a>
<a name="ln932"> </a>
<a name="ln933">            scene()-&gt;addItem(meta_row);</a>
<a name="ln934"> </a>
<a name="ln935">            std::pair&lt;QGraphicsItem*, int&gt; pair_graphics_int_meta(meta_row, row);</a>
<a name="ln936">            meta_rows.push_back(pair_graphics_int_meta);</a>
<a name="ln937">            }</a>
<a name="ln938"> </a>
<a name="ln939">      int x_pos = 0;</a>
<a name="ln940"> </a>
<a name="ln941">      //Create stagger array if collapsed_meta is false</a>
<a name="ln942">#if (!defined (_MSCVER) &amp;&amp; !defined (_MSC_VER))</a>
<a name="ln943">      int stagger_arr[num_metas];</a>
<a name="ln944">      for (unsigned int row = 0; row &lt; num_metas; row++)</a>
<a name="ln945">         stagger_arr[row] = 0;</a>
<a name="ln946">#else</a>
<a name="ln947">      // MSVC does not support VLA. Replace with std::vector. If profiling determines that the</a>
<a name="ln948">      //    heap allocation is slow, an optimization might be used.</a>
<a name="ln949">      std::vector&lt;int&gt; stagger_arr(num_metas, 0);  // Default initialized, loop not required</a>
<a name="ln950">#endif</a>
<a name="ln951"> </a>
<a name="ln952">      bool no_key = true;</a>
<a name="ln953">      std::get&lt;4&gt;(repeat_info) = false;</a>
<a name="ln954"> </a>
<a name="ln955">      for (Measure* cm = _score-&gt;firstMeasure(); cm; cm = cm-&gt;nextMeasure()) {</a>
<a name="ln956">            for (Segment* curr_seg = cm-&gt;first(); curr_seg; curr_seg = curr_seg-&gt;next()) {</a>
<a name="ln957">                  //Toggle no_key if initial key signature is found</a>
<a name="ln958">                  if (curr_seg-&gt;isKeySigType() &amp;&amp; cm == _score-&gt;firstMeasure()) {</a>
<a name="ln959">                        if (no_key &amp;&amp; curr_seg-&gt;tick().isZero())</a>
<a name="ln960">                              no_key = false;</a>
<a name="ln961">                        }</a>
<a name="ln962"> </a>
<a name="ln963">                  //If no initial key signature is found, add key signature</a>
<a name="ln964">                  if (cm == _score-&gt;firstMeasure() &amp;&amp; no_key &amp;&amp;</a>
<a name="ln965">                      (curr_seg-&gt;isTimeSigType() || curr_seg-&gt;isChordRestType())) {</a>
<a name="ln966"> </a>
<a name="ln967">                        if (getMetaRow(tr(&quot;Key Signature&quot;)) != num_metas) {</a>
<a name="ln968">                              if (collapsed_meta)</a>
<a name="ln969">                                    key_meta(0, &amp;stagger, x_pos);</a>
<a name="ln970">                              else</a>
<a name="ln971">                                    key_meta(0, &amp;stagger_arr[getMetaRow(tr(&quot;Key Signature&quot;))], x_pos);</a>
<a name="ln972">                              }</a>
<a name="ln973">                        no_key = false;</a>
<a name="ln974">                        }</a>
<a name="ln975">                  int row = 0;</a>
<a name="ln976">                  for (auto it = metas.begin(); it != metas.end(); ++it) {</a>
<a name="ln977">                        std::tuple&lt;QString, void (Timeline::*)(Segment*, int*, int), bool&gt; meta = *it;</a>
<a name="ln978">                        if (!std::get&lt;2&gt;(meta))</a>
<a name="ln979">                              continue;</a>
<a name="ln980">                        void (Timeline::*func)(Segment*, int*, int) = std::get&lt;1&gt;(meta);</a>
<a name="ln981">                        if (collapsed_meta)</a>
<a name="ln982">                              (this-&gt;*func)(curr_seg, &amp;stagger, x_pos);</a>
<a name="ln983">                        else</a>
<a name="ln984">                              (this-&gt;*func)(curr_seg, &amp;stagger_arr[row], x_pos);</a>
<a name="ln985">                        row++;</a>
<a name="ln986">                        }</a>
<a name="ln987">                  }</a>
<a name="ln988">            //Handle all jumps here</a>
<a name="ln989">            if (getMetaRow(tr(&quot;Jumps and Markers&quot;)) != num_metas) {</a>
<a name="ln990">                  ElementList measure_elements_list = cm-&gt;el();</a>
<a name="ln991">                  for (Element* element : measure_elements_list) {</a>
<a name="ln992">                        std::get&lt;3&gt;(repeat_info) = element;</a>
<a name="ln993">                        if (element-&gt;isMarker())</a>
<a name="ln994">                              jump_marker_meta(0, &amp;stagger, x_pos);</a>
<a name="ln995">                        }</a>
<a name="ln996">                  for (Element* element : measure_elements_list) {</a>
<a name="ln997">                        if (element-&gt;isJump()) {</a>
<a name="ln998">                              std::get&lt;2&gt;(repeat_info) = element;</a>
<a name="ln999">                              if (collapsed_meta)</a>
<a name="ln1000">                                    jump_marker_meta(0, &amp;stagger, x_pos);</a>
<a name="ln1001">                              else</a>
<a name="ln1002">                                    jump_marker_meta(0, &amp;std::get&lt;0&gt;(repeat_info), x_pos);</a>
<a name="ln1003">                              }</a>
<a name="ln1004">                        }</a>
<a name="ln1005">                  }</a>
<a name="ln1006">            stagger = 0;</a>
<a name="ln1007">            std::get&lt;0&gt;(repeat_info) = 0;</a>
<a name="ln1008"> </a>
<a name="ln1009">            for (unsigned int row = 0; row &lt; num_metas; row++) {</a>
<a name="ln1010">                  stagger_arr[row] = 0;</a>
<a name="ln1011">                  }</a>
<a name="ln1012">            x_pos += grid_width;</a>
<a name="ln1013">            std::get&lt;4&gt;(repeat_info) = false;</a>
<a name="ln1014">            }</a>
<a name="ln1015">      drawSelection();</a>
<a name="ln1016">      }</a>
<a name="ln1017"> </a>
<a name="ln1018">//---------------------------------------------------------</a>
<a name="ln1019">//   tempo_meta</a>
<a name="ln1020">//---------------------------------------------------------</a>
<a name="ln1021"> </a>
<a name="ln1022">void Timeline::tempo_meta(Segment* seg, int* stagger, int pos)</a>
<a name="ln1023">      {</a>
<a name="ln1024">      //Find position of tempo_meta in metas</a>
<a name="ln1025">      int row = getMetaRow(tr(&quot;Tempo&quot;));</a>
<a name="ln1026"> </a>
<a name="ln1027">      //Add all tempo texts in this segment</a>
<a name="ln1028">      const std::vector&lt;Element*&gt; annotations = seg-&gt;annotations();</a>
<a name="ln1029">      for (Element* element : annotations) {</a>
<a name="ln1030">            if (element-&gt;isTempoText()) {</a>
<a name="ln1031">                  TempoText* text = toTempoText(element);</a>
<a name="ln1032">                  qreal x = pos + (*stagger) * spacing;</a>
<a name="ln1033">                  if (addMetaValue(x, pos, text-&gt;plainText(), row, ElementType::TEMPO_TEXT, element, 0, seg-&gt;measure())) {</a>
<a name="ln1034">                        (*stagger)++;</a>
<a name="ln1035">                        global_z_value++;</a>
<a name="ln1036">                        }</a>
<a name="ln1037">                  }</a>
<a name="ln1038">            }</a>
<a name="ln1039">      }</a>
<a name="ln1040"> </a>
<a name="ln1041">//---------------------------------------------------------</a>
<a name="ln1042">//   time_meta</a>
<a name="ln1043">//---------------------------------------------------------</a>
<a name="ln1044"> </a>
<a name="ln1045">void Timeline::time_meta(Segment* seg, int* stagger, int pos)</a>
<a name="ln1046">      {</a>
<a name="ln1047">      if (!seg-&gt;isTimeSigType())</a>
<a name="ln1048">            return;</a>
<a name="ln1049"> </a>
<a name="ln1050">      int x = pos + (*stagger) * spacing;</a>
<a name="ln1051"> </a>
<a name="ln1052">      //Find position of time_meta in metas</a>
<a name="ln1053">      int row = getMetaRow(tr(&quot;Time Signature&quot;));</a>
<a name="ln1054"> </a>
<a name="ln1055">      TimeSig* original_time_sig = toTimeSig(seg-&gt;element(0));</a>
<a name="ln1056">      if (!original_time_sig)</a>
<a name="ln1057">            return;</a>
<a name="ln1058"> </a>
<a name="ln1059">      //Check if same across all staves</a>
<a name="ln1060">      const int nrows = _score-&gt;staves().size();</a>
<a name="ln1061">      bool same = true;</a>
<a name="ln1062">      for (int track = 0; track &lt; nrows; track++) {</a>
<a name="ln1063">            const TimeSig* curr_time_sig = toTimeSig(seg-&gt;element(track * VOICES));</a>
<a name="ln1064">            if (!curr_time_sig) {</a>
<a name="ln1065">                  same = false;</a>
<a name="ln1066">                  break;</a>
<a name="ln1067">                  }</a>
<a name="ln1068">            if (*curr_time_sig == *original_time_sig) {</a>
<a name="ln1069">                  continue;</a>
<a name="ln1070">                  }</a>
<a name="ln1071">            same = false;</a>
<a name="ln1072">            break;</a>
<a name="ln1073">            }</a>
<a name="ln1074">      if (!same)</a>
<a name="ln1075">            return;</a>
<a name="ln1076">      QString text = QString::number(original_time_sig-&gt;numerator()) + QString(&quot;/&quot;) + QString::number(original_time_sig-&gt;denominator());</a>
<a name="ln1077"> </a>
<a name="ln1078">      if (addMetaValue(x, pos, text, row, ElementType::TIMESIG, 0, seg, seg-&gt;measure())) {</a>
<a name="ln1079">            (*stagger)++;</a>
<a name="ln1080">            global_z_value++;</a>
<a name="ln1081">            }</a>
<a name="ln1082">      }</a>
<a name="ln1083"> </a>
<a name="ln1084">//---------------------------------------------------------</a>
<a name="ln1085">//   rehearsal_meta</a>
<a name="ln1086">//---------------------------------------------------------</a>
<a name="ln1087"> </a>
<a name="ln1088">void Timeline::rehearsal_meta(Segment* seg, int* stagger, int pos)</a>
<a name="ln1089">      {</a>
<a name="ln1090">      int row = getMetaRow(tr(&quot;Rehearsal Mark&quot;));</a>
<a name="ln1091"> </a>
<a name="ln1092">      for (Element* element : seg-&gt;annotations()) {</a>
<a name="ln1093">            int x = pos + (*stagger) * spacing;</a>
<a name="ln1094">            if (element-&gt;isRehearsalMark()) {</a>
<a name="ln1095"> </a>
<a name="ln1096">                  RehearsalMark* rehersal_mark = toRehearsalMark(element);</a>
<a name="ln1097">                  if (!rehersal_mark)</a>
<a name="ln1098">                        continue;</a>
<a name="ln1099"> </a>
<a name="ln1100">                  if (addMetaValue(x, pos, rehersal_mark-&gt;plainText(), row, ElementType::REHEARSAL_MARK, element, 0, seg-&gt;measure())) {</a>
<a name="ln1101">                        (*stagger)++;</a>
<a name="ln1102">                        global_z_value++;</a>
<a name="ln1103">                        }</a>
<a name="ln1104">                  }</a>
<a name="ln1105">            }</a>
<a name="ln1106">      }</a>
<a name="ln1107"> </a>
<a name="ln1108">//---------------------------------------------------------</a>
<a name="ln1109">//   key_meta</a>
<a name="ln1110">//---------------------------------------------------------</a>
<a name="ln1111"> </a>
<a name="ln1112">void Timeline::key_meta(Segment* seg, int* stagger, int pos)</a>
<a name="ln1113">      {</a>
<a name="ln1114">      //If seg is null, handle initial key signature</a>
<a name="ln1115">      if (seg &amp;&amp; !seg-&gt;isKeySigType())</a>
<a name="ln1116">            return;</a>
<a name="ln1117"> </a>
<a name="ln1118">      int row = getMetaRow(tr(&quot;Key Signature&quot;));</a>
<a name="ln1119">      std::map&lt;Key, int&gt; key_frequencies;</a>
<a name="ln1120">      QList&lt;Staff*&gt; staves = _score-&gt;staves();</a>
<a name="ln1121"> </a>
<a name="ln1122">      int track = 0;</a>
<a name="ln1123">      for (Staff* stave : staves) {</a>
<a name="ln1124">            if (!stave-&gt;show()) {</a>
<a name="ln1125">                  track += VOICES;</a>
<a name="ln1126">                  continue;</a>
<a name="ln1127">                  }</a>
<a name="ln1128"> </a>
<a name="ln1129">            //Ignore unpitched staves</a>
<a name="ln1130">            if ((seg &amp;&amp; !stave-&gt;isPitchedStaff(seg-&gt;tick())) || (!seg &amp;&amp; !stave-&gt;isPitchedStaff(Fraction(0,1)))) {</a>
<a name="ln1131">                  track += VOICES;</a>
<a name="ln1132">                  continue;</a>
<a name="ln1133">                  }</a>
<a name="ln1134"> </a>
<a name="ln1135">            //Add corrected key signature to map</a>
<a name="ln1136">            //Atonal -&gt; Key::INVALID</a>
<a name="ln1137">            //Custom -&gt; Key::NUM_OF</a>
<a name="ln1138">            const KeySig* curr_key_sig = nullptr;</a>
<a name="ln1139">            if (seg)</a>
<a name="ln1140">                  curr_key_sig = toKeySig(seg-&gt;element(track));</a>
<a name="ln1141"> </a>
<a name="ln1142">            Key global_key;</a>
<a name="ln1143">            if (seg)</a>
<a name="ln1144">                  global_key = stave-&gt;key(seg-&gt;tick());</a>
<a name="ln1145">            else</a>
<a name="ln1146">                  global_key = stave-&gt;key(Fraction(0,1));</a>
<a name="ln1147">            if (curr_key_sig) {</a>
<a name="ln1148">                  if (curr_key_sig-&gt;generated())</a>
<a name="ln1149">                        return;</a>
<a name="ln1150">                  global_key = curr_key_sig-&gt;key();</a>
<a name="ln1151">                  }</a>
<a name="ln1152"> </a>
<a name="ln1153">            if (curr_key_sig &amp;&amp; curr_key_sig-&gt;isAtonal())</a>
<a name="ln1154">                  global_key = Key::INVALID;</a>
<a name="ln1155">            else if (curr_key_sig &amp;&amp; curr_key_sig-&gt;isCustom())</a>
<a name="ln1156">                  global_key = Key::NUM_OF;</a>
<a name="ln1157">            else {</a>
<a name="ln1158">                  const Interval curr_interval = stave-&gt;part()-&gt;instrument()-&gt;transpose();</a>
<a name="ln1159">                  global_key = transposeKey(global_key, curr_interval, stave-&gt;part()-&gt;preferSharpFlat());</a>
<a name="ln1160">                  }</a>
<a name="ln1161"> </a>
<a name="ln1162">            std::map&lt;Key, int&gt;::iterator it = key_frequencies.find(global_key);</a>
<a name="ln1163">            if (it != key_frequencies.end())</a>
<a name="ln1164">                  key_frequencies[global_key]++;</a>
<a name="ln1165">            else</a>
<a name="ln1166">                  key_frequencies[global_key] = 1;</a>
<a name="ln1167"> </a>
<a name="ln1168">            track += VOICES;</a>
<a name="ln1169">            }</a>
<a name="ln1170"> </a>
<a name="ln1171">      //Change key into QString</a>
<a name="ln1172">      Key new_key = Key::C;</a>
<a name="ln1173">      int max_key_freq = 0;</a>
<a name="ln1174">      for (std::map&lt;Key, int&gt;::iterator iter = key_frequencies.begin(); iter != key_frequencies.end(); ++iter) {</a>
<a name="ln1175">            if (iter-&gt;second &gt; max_key_freq) {</a>
<a name="ln1176">                  new_key = iter-&gt;first;</a>
<a name="ln1177">                  max_key_freq = iter-&gt;second;</a>
<a name="ln1178">                  }</a>
<a name="ln1179">            }</a>
<a name="ln1180">      QString key_text;</a>
<a name="ln1181">      QString tooltip;</a>
<a name="ln1182">      if (new_key == Key::INVALID) {</a>
<a name="ln1183">            key_text = &quot;X&quot;;</a>
<a name="ln1184">            tooltip = qApp-&gt;translate(&quot;MuseScore&quot;, keyNames[15]);</a>
<a name="ln1185">            }</a>
<a name="ln1186">      else if (new_key == Key::NUM_OF) {</a>
<a name="ln1187">            key_text = &quot;?&quot;;</a>
<a name="ln1188">            tooltip = tr(&quot;Custom Key Signature&quot;);</a>
<a name="ln1189">            }</a>
<a name="ln1190">      else if (int(new_key) == 0) {</a>
<a name="ln1191">            key_text = &quot;\u266E&quot;;</a>
<a name="ln1192">            tooltip = qApp-&gt;translate(&quot;MuseScore&quot;, keyNames[14]);</a>
<a name="ln1193">            }</a>
<a name="ln1194">      else if (int(new_key) &lt; 0) {</a>
<a name="ln1195">            key_text = QString::number(abs(int(new_key))) + &quot;\u266D&quot;;</a>
<a name="ln1196">            tooltip = qApp-&gt;translate(&quot;MuseScore&quot;, keyNames[(7 + int(new_key)) * 2 + 1]);</a>
<a name="ln1197">            }</a>
<a name="ln1198">      else {</a>
<a name="ln1199">            key_text = QString::number(abs(int(new_key))) + &quot;\u266F&quot;;</a>
<a name="ln1200">            tooltip = qApp-&gt;translate(&quot;MuseScore&quot;, keyNames[(int(new_key) - 1) * 2]);</a>
<a name="ln1201">            }</a>
<a name="ln1202"> </a>
<a name="ln1203">      int x = pos + (*stagger) * spacing;</a>
<a name="ln1204">      Measure* measure = (seg)? seg-&gt;measure() : 0;</a>
<a name="ln1205">      if (addMetaValue(x, pos, key_text, row, ElementType::KEYSIG, 0, seg, measure, tooltip)) {</a>
<a name="ln1206">            (*stagger)++;</a>
<a name="ln1207">            global_z_value++;</a>
<a name="ln1208">            }</a>
<a name="ln1209">      }</a>
<a name="ln1210"> </a>
<a name="ln1211">//---------------------------------------------------------</a>
<a name="ln1212">//   repeat_meta</a>
<a name="ln1213">//---------------------------------------------------------</a>
<a name="ln1214"> </a>
<a name="ln1215">void Timeline::barline_meta(Segment* seg, int* stagger, int pos)</a>
<a name="ln1216">      {</a>
<a name="ln1217">      if (!seg-&gt;isBeginBarLineType() &amp;&amp; !seg-&gt;isEndBarLineType() &amp;&amp; !seg-&gt;isBarLine() &amp;&amp; !seg-&gt;isStartRepeatBarLineType())</a>
<a name="ln1218">            return;</a>
<a name="ln1219"> </a>
<a name="ln1220">      //Find position of repeat_meta in metas</a>
<a name="ln1221">      int row = getMetaRow(tr(&quot;Barlines&quot;));</a>
<a name="ln1222"> </a>
<a name="ln1223">      QString repeat_text = &quot;&quot;;</a>
<a name="ln1224">      BarLine* barline = toBarLine(seg-&gt;element(0));</a>
<a name="ln1225"> </a>
<a name="ln1226">      if (barline) {</a>
<a name="ln1227">            switch (barline-&gt;barLineType()) {</a>
<a name="ln1228">                  case BarLineType::START_REPEAT:</a>
<a name="ln1229">                        repeat_text = QString(&quot;Start repeat&quot;);</a>
<a name="ln1230">                        break;</a>
<a name="ln1231">                  case BarLineType::END_REPEAT:</a>
<a name="ln1232">                        repeat_text = QString(&quot;End repeat&quot;);</a>
<a name="ln1233">                        break;</a>
<a name="ln1234">                  case BarLineType::END_START_REPEAT:</a>
<a name="ln1235">                        // actually an end repeat followed by a start repeat, so nothing needs to be done here</a>
<a name="ln1236">                        break;</a>
<a name="ln1237">                  case BarLineType::DOUBLE:</a>
<a name="ln1238">                        repeat_text = QString(&quot;Double barline&quot;);</a>
<a name="ln1239">                        break;</a>
<a name="ln1240">                  case BarLineType::END:</a>
<a name="ln1241">                        repeat_text = QString(&quot;Final barline&quot;);</a>
<a name="ln1242">                        break;</a>
<a name="ln1243">                  default:</a>
<a name="ln1244">                        break;</a>
<a name="ln1245">                  }</a>
<a name="ln1246">            is_barline = true;</a>
<a name="ln1247">            }</a>
<a name="ln1248">      else</a>
<a name="ln1249">            return;</a>
<a name="ln1250"> </a>
<a name="ln1251">      Measure* measure = seg-&gt;measure();</a>
<a name="ln1252">      ElementType element_type = ElementType::BAR_LINE;</a>
<a name="ln1253">      Element* element = nullptr;</a>
<a name="ln1254"> </a>
<a name="ln1255">      if (repeat_text == &quot;&quot;) {</a>
<a name="ln1256">            is_barline = false;</a>
<a name="ln1257">            return;</a>
<a name="ln1258">            }</a>
<a name="ln1259"> </a>
<a name="ln1260">      int x = pos + (*stagger) * spacing;</a>
<a name="ln1261">      if (addMetaValue(x, pos, repeat_text, row, element_type, element, seg, measure)) {</a>
<a name="ln1262">            (*stagger)++;</a>
<a name="ln1263">            global_z_value++;</a>
<a name="ln1264">            }</a>
<a name="ln1265">      is_barline = false;</a>
<a name="ln1266">      }</a>
<a name="ln1267"> </a>
<a name="ln1268">//---------------------------------------------------------</a>
<a name="ln1269">//   jump_marker_meta</a>
<a name="ln1270">//---------------------------------------------------------</a>
<a name="ln1271"> </a>
<a name="ln1272">void Timeline::jump_marker_meta(Segment* seg, int* stagger, int pos)</a>
<a name="ln1273">      {</a>
<a name="ln1274">      if (seg)</a>
<a name="ln1275">            return;</a>
<a name="ln1276"> </a>
<a name="ln1277">      //Find position of repeat_meta in metas</a>
<a name="ln1278">      int row = getMetaRow(tr(&quot;Jumps and Markers&quot;));</a>
<a name="ln1279"> </a>
<a name="ln1280">      QString text = &quot;&quot;;</a>
<a name="ln1281">      Element* element = nullptr;</a>
<a name="ln1282">      if (std::get&lt;2&gt;(repeat_info))</a>
<a name="ln1283">            element = std::get&lt;2&gt;(repeat_info);</a>
<a name="ln1284">      else if (std::get&lt;3&gt;(repeat_info))</a>
<a name="ln1285">            element = std::get&lt;3&gt;(repeat_info);</a>
<a name="ln1286"> </a>
<a name="ln1287">      Measure* measure;</a>
<a name="ln1288">      ElementType element_type;</a>
<a name="ln1289">      if (std::get&lt;2&gt;(repeat_info)) {</a>
<a name="ln1290">            Jump* jump = toJump(std::get&lt;2&gt;(repeat_info));</a>
<a name="ln1291">            text = jump-&gt;plainText();</a>
<a name="ln1292">            measure = jump-&gt;measure();</a>
<a name="ln1293">            element_type = ElementType::JUMP;</a>
<a name="ln1294">            }</a>
<a name="ln1295">      else {</a>
<a name="ln1296">            Marker* marker = toMarker(std::get&lt;3&gt;(repeat_info));</a>
<a name="ln1297">            QList&lt;TextFragment&gt; tf_list = marker-&gt;fragmentList();</a>
<a name="ln1298">            for (TextFragment tf: tf_list)</a>
<a name="ln1299">                  text.push_back(tf.text);</a>
<a name="ln1300">            measure = marker-&gt;measure();</a>
<a name="ln1301">            if (marker-&gt;markerType() == Marker::Type::FINE || marker-&gt;markerType() == Marker::Type::TOCODA) {</a>
<a name="ln1302">                  element_type = ElementType::MARKER;</a>
<a name="ln1303">                  std::get&lt;2&gt;(repeat_info) = std::get&lt;3&gt;(repeat_info);</a>
<a name="ln1304">                  std::get&lt;3&gt;(repeat_info) = nullptr;</a>
<a name="ln1305">                  }</a>
<a name="ln1306">            else</a>
<a name="ln1307">                  element_type = ElementType::MARKER;</a>
<a name="ln1308">            }</a>
<a name="ln1309"> </a>
<a name="ln1310">      if (text == &quot;&quot;) {</a>
<a name="ln1311">            std::get&lt;2&gt;(repeat_info) = nullptr;</a>
<a name="ln1312">            std::get&lt;3&gt;(repeat_info) = nullptr;</a>
<a name="ln1313">            return;</a>
<a name="ln1314">            }</a>
<a name="ln1315"> </a>
<a name="ln1316">      int x = pos + (*stagger) * spacing;</a>
<a name="ln1317">      if (addMetaValue(x, pos, text, row, element_type, element, seg, measure)) {</a>
<a name="ln1318">            (*stagger)++;</a>
<a name="ln1319">            global_z_value++;</a>
<a name="ln1320">            }</a>
<a name="ln1321">      std::get&lt;2&gt;(repeat_info) = nullptr;</a>
<a name="ln1322">      std::get&lt;3&gt;(repeat_info) = nullptr;</a>
<a name="ln1323">      }</a>
<a name="ln1324"> </a>
<a name="ln1325">//---------------------------------------------------------</a>
<a name="ln1326">//   measure_meta</a>
<a name="ln1327">//---------------------------------------------------------</a>
<a name="ln1328"> </a>
<a name="ln1329">void Timeline::measure_meta(Segment* , int* , int pos)</a>
<a name="ln1330">      {</a>
<a name="ln1331">      //Increment decided by zoom level</a>
<a name="ln1332">      int increment_value = 1;</a>
<a name="ln1333">      int halfway = (max_zoom + min_zoom) / 2;</a>
<a name="ln1334">      if (grid_width &lt;= max_zoom &amp;&amp; grid_width &gt; halfway)</a>
<a name="ln1335">            increment_value = 1;</a>
<a name="ln1336">      else if (grid_width &lt;= halfway &amp;&amp; grid_width &gt; min_zoom)</a>
<a name="ln1337">            increment_value = 5;</a>
<a name="ln1338">      else</a>
<a name="ln1339">            increment_value = 10;</a>
<a name="ln1340"> </a>
<a name="ln1341">      int curr_measure_number = pos / grid_width;</a>
<a name="ln1342">      if (curr_measure_number == global_measure_number)</a>
<a name="ln1343">            return;</a>
<a name="ln1344"> </a>
<a name="ln1345">      global_measure_number = curr_measure_number;</a>
<a name="ln1346">      //Check if 1 or 5*n</a>
<a name="ln1347">      if (curr_measure_number + 1 != 1 &amp;&amp; (curr_measure_number + 1) % increment_value != 0)</a>
<a name="ln1348">            return;</a>
<a name="ln1349"> </a>
<a name="ln1350">      //Find position of measure_meta in metas</a>
<a name="ln1351">      int row = getMetaRow(tr(&quot;Measures&quot;));</a>
<a name="ln1352"> </a>
<a name="ln1353">      //Adjust number</a>
<a name="ln1354">      Measure* curr_measure;</a>
<a name="ln1355">      for (curr_measure = _score-&gt;firstMeasure(); curr_measure_number != 0; curr_measure_number--, curr_measure = curr_measure-&gt;nextMeasure()) {</a>
<a name="ln1356"> </a>
<a name="ln1357">            }</a>
<a name="ln1358"> </a>
<a name="ln1359">      //Add measure number</a>
<a name="ln1360">      QString measure_number = (curr_measure-&gt;irregular())? &quot;( )&quot; : QString::number(curr_measure-&gt;no() + 1);</a>
<a name="ln1361">      QGraphicsTextItem* graphics_text_item = new QGraphicsTextItem(measure_number);</a>
<a name="ln1362">      graphics_text_item-&gt;setDefaultTextColor(QColor(0, 0, 0));</a>
<a name="ln1363">      graphics_text_item-&gt;setX(pos);</a>
<a name="ln1364">      graphics_text_item-&gt;setY(grid_height * row + verticalScrollBar()-&gt;value());</a>
<a name="ln1365"> </a>
<a name="ln1366">      QFont f = graphics_text_item-&gt;font();</a>
<a name="ln1367">      f.setPointSizeF(7.0);</a>
<a name="ln1368">      graphics_text_item-&gt;setFont(f);</a>
<a name="ln1369"> </a>
<a name="ln1370">      //Center text</a>
<a name="ln1371">      qreal remaining_width =  grid_width - graphics_text_item-&gt;boundingRect().width();</a>
<a name="ln1372">      qreal remaining_height =  grid_height - graphics_text_item-&gt;boundingRect().height();</a>
<a name="ln1373">      graphics_text_item-&gt;setX(graphics_text_item-&gt;x() + remaining_width / 2);</a>
<a name="ln1374">      graphics_text_item-&gt;setY(graphics_text_item-&gt;y() + remaining_height / 2);</a>
<a name="ln1375"> </a>
<a name="ln1376">      int end_of_text = graphics_text_item-&gt;x() + graphics_text_item-&gt;boundingRect().width();</a>
<a name="ln1377">      int end_of_grid = getWidth();</a>
<a name="ln1378">      if (end_of_text &lt;= end_of_grid) {</a>
<a name="ln1379">            scene()-&gt;addItem(graphics_text_item);</a>
<a name="ln1380"> </a>
<a name="ln1381">            std::pair&lt;QGraphicsItem*, int&gt; pair_measure_text(graphics_text_item, row);</a>
<a name="ln1382">            meta_rows.push_back(pair_measure_text);</a>
<a name="ln1383">            }</a>
<a name="ln1384">      }</a>
<a name="ln1385"> </a>
<a name="ln1386">//---------------------------------------------------------</a>
<a name="ln1387">//   getMetaRow</a>
<a name="ln1388">//---------------------------------------------------------</a>
<a name="ln1389"> </a>
<a name="ln1390">unsigned int Timeline::getMetaRow(QString target_text)</a>
<a name="ln1391">      {</a>
<a name="ln1392">      if (collapsed_meta) {</a>
<a name="ln1393">            if (target_text == tr(&quot;Measures&quot;))</a>
<a name="ln1394">                  return 1;</a>
<a name="ln1395">            else</a>
<a name="ln1396">                  return 0;</a>
<a name="ln1397">            }</a>
<a name="ln1398">      int row = 0;</a>
<a name="ln1399">      for (auto it = metas.begin(); it != metas.end(); ++it) {</a>
<a name="ln1400">            std::tuple&lt;QString, void (Timeline::*)(Segment*, int*, int), bool&gt; meta = *it;</a>
<a name="ln1401">            QString meta_text = std::get&lt;0&gt;(meta);</a>
<a name="ln1402">            bool visible = std::get&lt;2&gt;(meta);</a>
<a name="ln1403">            if (meta_text == target_text &amp;&amp; visible)</a>
<a name="ln1404">                  break;</a>
<a name="ln1405">            else if (!visible)</a>
<a name="ln1406">                  continue;</a>
<a name="ln1407">            row++;</a>
<a name="ln1408">            }</a>
<a name="ln1409">      return row;</a>
<a name="ln1410">      }</a>
<a name="ln1411"> </a>
<a name="ln1412">//---------------------------------------------------------</a>
<a name="ln1413">//   addMetaValue</a>
<a name="ln1414">//---------------------------------------------------------</a>
<a name="ln1415"> </a>
<a name="ln1416">bool Timeline::addMetaValue(int x, int pos, QString meta_text, int row, ElementType element_type, Element* element, Segment* seg, Measure* measure, QString tooltip)</a>
<a name="ln1417">      {</a>
<a name="ln1418">      QGraphicsTextItem* graphics_text_item = new QGraphicsTextItem(meta_text);</a>
<a name="ln1419">      qreal text_width = graphics_text_item-&gt;boundingRect().width();</a>
<a name="ln1420"> </a>
<a name="ln1421">      QGraphicsPixmapItem* graphics_pixmap_item = nullptr;</a>
<a name="ln1422">      if (is_barline)</a>
<a name="ln1423">            graphics_pixmap_item = new QGraphicsPixmapItem(*barlines[meta_text]);</a>
<a name="ln1424"> </a>
<a name="ln1425">      if (graphics_pixmap_item) {</a>
<a name="ln1426">            text_width = 10;</a>
<a name="ln1427">            if (text_width &gt; grid_width) {</a>
<a name="ln1428">                  text_width = grid_width;</a>
<a name="ln1429">                  if (meta_text == QString(&quot;End repeat&quot;) &amp;&amp; std::get&lt;4&gt;(repeat_info))</a>
<a name="ln1430">                        text_width /= 2;</a>
<a name="ln1431">                  }</a>
<a name="ln1432">            }</a>
<a name="ln1433"> </a>
<a name="ln1434">      if (text_width + x &gt; getWidth())</a>
<a name="ln1435">            text_width = getWidth() - x;</a>
<a name="ln1436"> </a>
<a name="ln1437">      //Adjust x for end repeats</a>
<a name="ln1438">      if ((meta_text == QString(&quot;End repeat&quot;) || meta_text == QString(&quot;Final barline&quot;) || meta_text == QString(&quot;Double barline&quot;) || std::get&lt;2&gt;(repeat_info)) &amp;&amp; !collapsed_meta) {</a>
<a name="ln1439">            if (std::get&lt;0&gt;(repeat_info) &gt; 0)</a>
<a name="ln1440">                  x = pos + grid_width - std::get&lt;1&gt;(repeat_info) + std::get&lt;0&gt;(repeat_info) * spacing;</a>
<a name="ln1441">            else {</a>
<a name="ln1442">                  x = pos + grid_width - text_width;</a>
<a name="ln1443">                  std::get&lt;1&gt;(repeat_info) = text_width;</a>
<a name="ln1444">                  }</a>
<a name="ln1445">            //Check if extending past left side</a>
<a name="ln1446">            if (x &lt; 0) {</a>
<a name="ln1447">                  text_width = text_width + x;</a>
<a name="ln1448">                  x = 0;</a>
<a name="ln1449">                  }</a>
<a name="ln1450">            }</a>
<a name="ln1451"> </a>
<a name="ln1452">      //Return if past width</a>
<a name="ln1453">      if (x &gt;= getWidth())</a>
<a name="ln1454">            return false;</a>
<a name="ln1455"> </a>
<a name="ln1456">      QGraphicsItem* item_to_add;</a>
<a name="ln1457">      if (graphics_pixmap_item) {</a>
<a name="ln1458">            //Exact values required for repeat pixmap to work visually</a>
<a name="ln1459">            if (text_width != 10)</a>
<a name="ln1460">                  graphics_pixmap_item = new QGraphicsPixmapItem();</a>
<a name="ln1461">            if (meta_text == QString(&quot;Start repeat&quot;))</a>
<a name="ln1462">                  std::get&lt;4&gt;(repeat_info) = true;</a>
<a name="ln1463">            graphics_pixmap_item-&gt;setX(x + 2);</a>
<a name="ln1464">            graphics_pixmap_item-&gt;setY(grid_height * row + verticalScrollBar()-&gt;value() + 3);</a>
<a name="ln1465">            item_to_add = graphics_pixmap_item;</a>
<a name="ln1466">            }</a>
<a name="ln1467">      else if (meta_text == &quot;\uE047&quot; || meta_text == &quot;\uE048&quot;) {</a>
<a name="ln1468">            graphics_text_item-&gt;setX(x);</a>
<a name="ln1469">            graphics_text_item-&gt;setY(grid_height * row + verticalScrollBar()-&gt;value() - 2);</a>
<a name="ln1470">            item_to_add = graphics_text_item;</a>
<a name="ln1471">            }</a>
<a name="ln1472">      else if (row == 0 ) {</a>
<a name="ln1473">            graphics_text_item-&gt;setX(x);</a>
<a name="ln1474">            graphics_text_item-&gt;setY(grid_height * row + verticalScrollBar()-&gt;value() - 6);</a>
<a name="ln1475">            item_to_add = graphics_text_item;</a>
<a name="ln1476">            }</a>
<a name="ln1477">      else {</a>
<a name="ln1478">            graphics_text_item-&gt;setX(x);</a>
<a name="ln1479">            graphics_text_item-&gt;setY(grid_height * row + verticalScrollBar()-&gt;value() - 1);</a>
<a name="ln1480">            item_to_add = graphics_text_item;</a>
<a name="ln1481">            }</a>
<a name="ln1482"> </a>
<a name="ln1483">      QFontMetrics f(QApplication::font());</a>
<a name="ln1484">      QString part_name = f.elidedText(graphics_text_item-&gt;toPlainText(),</a>
<a name="ln1485">                                       Qt::ElideRight,</a>
<a name="ln1486">                                       text_width);</a>
<a name="ln1487"> </a>
<a name="ln1488">      //Set tool tip if elided</a>
<a name="ln1489">      if (tooltip != &quot;&quot;)</a>
<a name="ln1490">            graphics_text_item-&gt;setToolTip(tooltip);</a>
<a name="ln1491">      else if (part_name != meta_text)</a>
<a name="ln1492">            graphics_text_item-&gt;setToolTip(graphics_text_item-&gt;toPlainText());</a>
<a name="ln1493">      graphics_text_item-&gt;setPlainText(part_name);</a>
<a name="ln1494"> </a>
<a name="ln1495">      //Make text fit within rectangle</a>
<a name="ln1496">      while (graphics_text_item-&gt;boundingRect().width() &gt; text_width &amp;&amp;</a>
<a name="ln1497">             graphics_text_item-&gt;toPlainText() != &quot;&quot;) {</a>
<a name="ln1498">            QString text = graphics_text_item-&gt;toPlainText();</a>
<a name="ln1499">            text.chop(1);</a>
<a name="ln1500">            graphics_text_item-&gt;setPlainText(text);</a>
<a name="ln1501">            }</a>
<a name="ln1502"> </a>
<a name="ln1503">      QGraphicsRectItem* graphics_rect_item = new QGraphicsRectItem(x,</a>
<a name="ln1504">                                                                    grid_height * row + verticalScrollBar()-&gt;value(),</a>
<a name="ln1505">                                                                    text_width,</a>
<a name="ln1506">                                                                    grid_height);</a>
<a name="ln1507">      if (tooltip != &quot;&quot;)</a>
<a name="ln1508">            graphics_rect_item-&gt;setToolTip(tooltip);</a>
<a name="ln1509">      else if (part_name != meta_text)</a>
<a name="ln1510">            graphics_rect_item-&gt;setToolTip(meta_text);</a>
<a name="ln1511">      else if (graphics_pixmap_item)</a>
<a name="ln1512">            graphics_rect_item-&gt;setToolTip(tr(meta_text.toLatin1().constData()));</a>
<a name="ln1513"> </a>
<a name="ln1514">      setMetaData(graphics_rect_item, -1, element_type, measure, true, element, item_to_add, seg);</a>
<a name="ln1515">      setMetaData(item_to_add, -1, element_type, measure, true, element, graphics_rect_item, seg);</a>
<a name="ln1516"> </a>
<a name="ln1517">      graphics_rect_item-&gt;setZValue(global_z_value);</a>
<a name="ln1518">      item_to_add-&gt;setZValue(global_z_value);</a>
<a name="ln1519"> </a>
<a name="ln1520">      graphics_rect_item-&gt;setPen(QPen(Qt::black));</a>
<a name="ln1521">      graphics_rect_item-&gt;setBrush(QBrush(Qt::gray));</a>
<a name="ln1522"> </a>
<a name="ln1523">      scene()-&gt;addItem(graphics_rect_item);</a>
<a name="ln1524">      scene()-&gt;addItem(item_to_add);</a>
<a name="ln1525"> </a>
<a name="ln1526">      std::pair&lt;QGraphicsItem*, int&gt; pair_time_rect(graphics_rect_item, row);</a>
<a name="ln1527">      std::pair&lt;QGraphicsItem*, int&gt; pair_time_text(item_to_add, row);</a>
<a name="ln1528">      meta_rows.push_back(pair_time_rect);</a>
<a name="ln1529">      meta_rows.push_back(pair_time_text);</a>
<a name="ln1530"> </a>
<a name="ln1531">      if (meta_text == QString(&quot;End repeat&quot;))</a>
<a name="ln1532">            std::get&lt;0&gt;(repeat_info)++;</a>
<a name="ln1533"> </a>
<a name="ln1534">      return true;</a>
<a name="ln1535">      }</a>
<a name="ln1536"> </a>
<a name="ln1537">//---------------------------------------------------------</a>
<a name="ln1538">//   setMetaData</a>
<a name="ln1539">//---------------------------------------------------------</a>
<a name="ln1540"> </a>
<a name="ln1541">void Timeline::setMetaData(QGraphicsItem* gi, int staff, ElementType et, Measure* m, bool full_measure, Element* e, QGraphicsItem* pair_item, Segment* seg)</a>
<a name="ln1542">      {</a>
<a name="ln1543">      //full_measure true for meta values</a>
<a name="ln1544">      //pr is null for grid items, set for meta values</a>
<a name="ln1545">      //seg is set if key meta</a>
<a name="ln1546">      gi-&gt;setData(0, QVariant::fromValue&lt;int&gt;(staff));</a>
<a name="ln1547">      gi-&gt;setData(1, QVariant::fromValue&lt;ElementType&gt;(et));</a>
<a name="ln1548">      gi-&gt;setData(2, QVariant::fromValue&lt;void*&gt;(m));</a>
<a name="ln1549">      gi-&gt;setData(3, QVariant::fromValue&lt;bool&gt;(full_measure));</a>
<a name="ln1550">      gi-&gt;setData(4, QVariant::fromValue&lt;void*&gt;(e));</a>
<a name="ln1551">      gi-&gt;setData(5, QVariant::fromValue&lt;void*&gt;(pair_item));</a>
<a name="ln1552">      gi-&gt;setData(6, QVariant::fromValue&lt;void*&gt;(seg));</a>
<a name="ln1553">      }</a>
<a name="ln1554"> </a>
<a name="ln1555">//---------------------------------------------------------</a>
<a name="ln1556">//   getWidth</a>
<a name="ln1557">//---------------------------------------------------------</a>
<a name="ln1558"> </a>
<a name="ln1559">int Timeline::getWidth()</a>
<a name="ln1560">      {</a>
<a name="ln1561">      if (_score)</a>
<a name="ln1562">            return int(_score-&gt;nmeasures() * grid_width);</a>
<a name="ln1563">      else</a>
<a name="ln1564">            return 0;</a>
<a name="ln1565">      }</a>
<a name="ln1566"> </a>
<a name="ln1567">//---------------------------------------------------------</a>
<a name="ln1568">//   getHeight</a>
<a name="ln1569">//---------------------------------------------------------</a>
<a name="ln1570"> </a>
<a name="ln1571">int Timeline::getHeight()</a>
<a name="ln1572">      {</a>
<a name="ln1573">      if (_score)</a>
<a name="ln1574">            return int((nstaves() + nmetas()) * grid_height + 3);</a>
<a name="ln1575">      else</a>
<a name="ln1576">            return 0;</a>
<a name="ln1577">      }</a>
<a name="ln1578"> </a>
<a name="ln1579">//---------------------------------------------------------</a>
<a name="ln1580">//   correctStave</a>
<a name="ln1581">//---------------------------------------------------------</a>
<a name="ln1582"> </a>
<a name="ln1583">int Timeline::correctStave(int stave)</a>
<a name="ln1584">      {</a>
<a name="ln1585">      //Find correct stave (skipping hidden staves)</a>
<a name="ln1586">      QList&lt;Staff*&gt; list = _score-&gt;staves();</a>
<a name="ln1587">      int count = 0;</a>
<a name="ln1588">      while (stave &gt;= count) {</a>
<a name="ln1589">            if (count &gt;= list.size()) {</a>
<a name="ln1590">                  count = list.size() - 1;</a>
<a name="ln1591">                  return count;</a>
<a name="ln1592">                  }</a>
<a name="ln1593">            if (!list.at(count)-&gt;show())</a>
<a name="ln1594">                  stave++;</a>
<a name="ln1595">            count++;</a>
<a name="ln1596">            }</a>
<a name="ln1597">      return stave;</a>
<a name="ln1598">      }</a>
<a name="ln1599"> </a>
<a name="ln1600"> </a>
<a name="ln1601">//---------------------------------------------------------</a>
<a name="ln1602">//   correctPart</a>
<a name="ln1603">//---------------------------------------------------------</a>
<a name="ln1604"> </a>
<a name="ln1605">int Timeline::correctPart(int stave)</a>
<a name="ln1606">      {</a>
<a name="ln1607">      //Find correct stave (skipping hidden staves)</a>
<a name="ln1608">      QList&lt;Staff*&gt; list = _score-&gt;staves();</a>
<a name="ln1609">      int count = correctStave(stave);</a>
<a name="ln1610">      return getParts().indexOf(list.at(count)-&gt;part());</a>
<a name="ln1611">      }</a>
<a name="ln1612"> </a>
<a name="ln1613">//---------------------------------------------------------</a>
<a name="ln1614">//   getParts</a>
<a name="ln1615">//---------------------------------------------------------</a>
<a name="ln1616"> </a>
<a name="ln1617">QList&lt;Part*&gt; Timeline::getParts()</a>
<a name="ln1618">      {</a>
<a name="ln1619">      QList&lt;Part*&gt; realPartList = _score-&gt;parts();</a>
<a name="ln1620">      QList&lt;Part*&gt; partList;</a>
<a name="ln1621">      for (Part* p : realPartList) {</a>
<a name="ln1622">            for (int i = 0; i &lt; p-&gt;nstaves(); i++) {</a>
<a name="ln1623">                  partList.append(p);</a>
<a name="ln1624">                  }</a>
<a name="ln1625">            }</a>
<a name="ln1626"> </a>
<a name="ln1627">      return partList;</a>
<a name="ln1628">      }</a>
<a name="ln1629"> </a>
<a name="ln1630">//---------------------------------------------------------</a>
<a name="ln1631">//   changeSelection</a>
<a name="ln1632">//---------------------------------------------------------</a>
<a name="ln1633"> </a>
<a name="ln1634">void Timeline::changeSelection(SelState)</a>
<a name="ln1635">      {</a>
<a name="ln1636">      scene()-&gt;blockSignals(true);</a>
<a name="ln1637">      scene()-&gt;clearSelection();</a>
<a name="ln1638"> </a>
<a name="ln1639">      QRectF selection_rect = selection_path.boundingRect();</a>
<a name="ln1640">      if (selection_rect == QRectF())</a>
<a name="ln1641">            return;</a>
<a name="ln1642"> </a>
<a name="ln1643">      int nmeta = nmetas();</a>
<a name="ln1644"> </a>
<a name="ln1645">      //Get borders of the current viewport</a>
<a name="ln1646">      int left_border = horizontalScrollBar()-&gt;value();</a>
<a name="ln1647">      int right_border = horizontalScrollBar()-&gt;value() + viewport()-&gt;width();</a>
<a name="ln1648">      int top_border = verticalScrollBar()-&gt;value() + nmeta * grid_height;</a>
<a name="ln1649">      int bottom_border = verticalScrollBar()-&gt;value() + viewport()-&gt;height();</a>
<a name="ln1650"> </a>
<a name="ln1651">      bool selection_extends_up = false, selection_extends_left = false;</a>
<a name="ln1652">      bool selection_extends_right = false, selection_extends_down = false;</a>
<a name="ln1653"> </a>
<a name="ln1654">      //Figure out which directions the selection extends</a>
<a name="ln1655">      if (selection_rect.top() &lt; top_border)</a>
<a name="ln1656">            selection_extends_up = true;</a>
<a name="ln1657">      if (selection_rect.left() &lt; left_border - 1)</a>
<a name="ln1658">            selection_extends_left = true;</a>
<a name="ln1659">      if (selection_rect.right() &gt; right_border)</a>
<a name="ln1660">            selection_extends_right = true;</a>
<a name="ln1661">      if (selection_rect.bottom() &gt; bottom_border)</a>
<a name="ln1662">            selection_extends_down = true;</a>
<a name="ln1663"> </a>
<a name="ln1664">      if (selection_extends_down</a>
<a name="ln1665">          &amp;&amp; old_selection_rect.bottom() != selection_rect.bottom()</a>
<a name="ln1666">          &amp;&amp; !meta_value) {</a>
<a name="ln1667">            int new_scrollbar_value = int(verticalScrollBar()-&gt;value() + selection_rect.bottom() - bottom_border);</a>
<a name="ln1668">            verticalScrollBar()-&gt;setValue(new_scrollbar_value);</a>
<a name="ln1669">            }</a>
<a name="ln1670">      else if (selection_extends_up</a>
<a name="ln1671">               &amp;&amp; !selection_extends_down</a>
<a name="ln1672">               &amp;&amp; old_selection_rect.bottom() != selection_rect.bottom()</a>
<a name="ln1673">               &amp;&amp; !meta_value</a>
<a name="ln1674">               &amp;&amp; old_selection_rect.contains(selection_rect)) {</a>
<a name="ln1675">            int new_scrollbar_value = int(verticalScrollBar()-&gt;value() + selection_rect.bottom() - bottom_border);</a>
<a name="ln1676">            verticalScrollBar()-&gt;setValue(new_scrollbar_value);</a>
<a name="ln1677">            }</a>
<a name="ln1678"> </a>
<a name="ln1679">      if (selection_extends_right</a>
<a name="ln1680">          &amp;&amp; old_selection_rect.right() != selection_rect.right()) {</a>
<a name="ln1681">            int new_scrollbar_value = int(horizontalScrollBar()-&gt;value() + selection_rect.right() - right_border);</a>
<a name="ln1682">            horizontalScrollBar()-&gt;setValue(new_scrollbar_value);</a>
<a name="ln1683">            }</a>
<a name="ln1684">      if (selection_extends_up</a>
<a name="ln1685">          &amp;&amp; old_selection_rect.top() != selection_rect.top()</a>
<a name="ln1686">          &amp;&amp; !meta_value) {</a>
<a name="ln1687">            int new_scrollbar_value = int(selection_rect.top()) - nmeta * grid_height;</a>
<a name="ln1688">            verticalScrollBar()-&gt;setValue(new_scrollbar_value);</a>
<a name="ln1689">            }</a>
<a name="ln1690">      if (selection_extends_left</a>
<a name="ln1691">          &amp;&amp; old_selection_rect.left() != selection_rect.left()) {</a>
<a name="ln1692">            int new_scrollbar_value = int(selection_rect.left());</a>
<a name="ln1693">            horizontalScrollBar()-&gt;setValue(new_scrollbar_value);</a>
<a name="ln1694">            }</a>
<a name="ln1695"> </a>
<a name="ln1696">      if (selection_extends_left</a>
<a name="ln1697">          &amp;&amp; !selection_extends_right</a>
<a name="ln1698">          &amp;&amp; old_selection_rect.right() != selection_rect.right()</a>
<a name="ln1699">          &amp;&amp; old_selection_rect.contains(selection_rect)) {</a>
<a name="ln1700">            int new_scrollbar_value = int(horizontalScrollBar()-&gt;value() + selection_rect.right() - right_border);</a>
<a name="ln1701">            horizontalScrollBar()-&gt;setValue(new_scrollbar_value);</a>
<a name="ln1702">            }</a>
<a name="ln1703">      if (selection_extends_right</a>
<a name="ln1704">          &amp;&amp; !selection_extends_left</a>
<a name="ln1705">          &amp;&amp; old_selection_rect.left() != selection_rect.left()</a>
<a name="ln1706">          &amp;&amp; old_selection_rect.contains(selection_rect)) {</a>
<a name="ln1707">            int new_scrollbar_value = int(selection_rect.left());</a>
<a name="ln1708">            horizontalScrollBar()-&gt;setValue(new_scrollbar_value);</a>
<a name="ln1709">            }</a>
<a name="ln1710"> </a>
<a name="ln1711">      if (selection_extends_down</a>
<a name="ln1712">          &amp;&amp; !selection_extends_up</a>
<a name="ln1713">          &amp;&amp; old_selection_rect.top() != selection_rect.top()</a>
<a name="ln1714">          &amp;&amp; !meta_value</a>
<a name="ln1715">          &amp;&amp; old_selection_rect.contains(selection_rect)) {</a>
<a name="ln1716">            int new_scrollbar_value = int(selection_rect.top()) - nmeta * grid_height;</a>
<a name="ln1717">            verticalScrollBar()-&gt;setValue(new_scrollbar_value);</a>
<a name="ln1718">            }</a>
<a name="ln1719"> </a>
<a name="ln1720">      old_selection_rect = selection_rect;</a>
<a name="ln1721"> </a>
<a name="ln1722">      meta_value = false;</a>
<a name="ln1723">      scene()-&gt;blockSignals(false);</a>
<a name="ln1724">      }</a>
<a name="ln1725"> </a>
<a name="ln1726">//---------------------------------------------------------</a>
<a name="ln1727">//   drawSelection</a>
<a name="ln1728">//---------------------------------------------------------</a>
<a name="ln1729"> </a>
<a name="ln1730">void Timeline::drawSelection()</a>
<a name="ln1731">      {</a>
<a name="ln1732">      selection_path = QPainterPath();</a>
<a name="ln1733">      selection_path.setFillRule(Qt::WindingFill);</a>
<a name="ln1734"> </a>
<a name="ln1735">      std::set&lt;std::tuple&lt;Measure*, int, ElementType&gt;&gt; meta_labels_set;</a>
<a name="ln1736"> </a>
<a name="ln1737">      const Selection&amp; selection = _score-&gt;selection();</a>
<a name="ln1738">      const QList&lt;Element*&gt;&amp; el = selection.elements();</a>
<a name="ln1739">      for (Element* element : el) {</a>
<a name="ln1740">            if (element-&gt;tick() == Fraction(-1,1))</a>
<a name="ln1741">                  continue;</a>
<a name="ln1742">            else {</a>
<a name="ln1743">                  switch (element-&gt;type()) {</a>
<a name="ln1744">                        case ElementType::INSTRUMENT_NAME:</a>
<a name="ln1745">                        case ElementType::VBOX:</a>
<a name="ln1746">                        case ElementType::HBOX:</a>
<a name="ln1747">                        case ElementType::TEXT:</a>
<a name="ln1748">                        case ElementType::TIE_SEGMENT:</a>
<a name="ln1749">                        case ElementType::SLUR_SEGMENT:</a>
<a name="ln1750">                        case ElementType::TIE:</a>
<a name="ln1751">                        case ElementType::SLUR:</a>
<a name="ln1752">                              continue;</a>
<a name="ln1753">                              break;</a>
<a name="ln1754">                        default: break;</a>
<a name="ln1755">                        }</a>
<a name="ln1756">                  }</a>
<a name="ln1757"> </a>
<a name="ln1758">            int staffIdx;</a>
<a name="ln1759">            Fraction tick = element-&gt;tick();</a>
<a name="ln1760">            Measure* measure = _score-&gt;tick2measure(tick);</a>
<a name="ln1761">            staffIdx = element-&gt;staffIdx();</a>
<a name="ln1762">            if (numToStaff(staffIdx) &amp;&amp; !numToStaff(staffIdx)-&gt;show())</a>
<a name="ln1763">                  continue;</a>
<a name="ln1764"> </a>
<a name="ln1765">            if ((element-&gt;isTempoText() ||</a>
<a name="ln1766">                 element-&gt;isKeySig() ||</a>
<a name="ln1767">                 element-&gt;isTimeSig() ||</a>
<a name="ln1768">                 element-&gt;isRehearsalMark() ||</a>
<a name="ln1769">                 element-&gt;isJump() ||</a>
<a name="ln1770">                 element-&gt;isMarker()) &amp;&amp;</a>
<a name="ln1771">                !element-&gt;generated())</a>
<a name="ln1772">                  staffIdx = -1;</a>
<a name="ln1773"> </a>
<a name="ln1774">            if (element-&gt;isBarLine()) {</a>
<a name="ln1775">                  staffIdx = -1;</a>
<a name="ln1776">                  BarLine* barline = toBarLine(element);</a>
<a name="ln1777">                  if (barline &amp;&amp;</a>
<a name="ln1778">                      (barline-&gt;barLineType() == BarLineType::END_REPEAT || barline-&gt;barLineType() == BarLineType::DOUBLE || barline-&gt;barLineType() == BarLineType::END) &amp;&amp;</a>
<a name="ln1779">                      measure != _score-&gt;lastMeasure()) {</a>
<a name="ln1780">                        if (measure-&gt;prevMeasure())</a>
<a name="ln1781">                              measure = measure-&gt;prevMeasure();</a>
<a name="ln1782">                        }</a>
<a name="ln1783">                  }</a>
<a name="ln1784"> </a>
<a name="ln1785">            //element-&gt;type() for meta rows, invalid for everything else</a>
<a name="ln1786">            ElementType element_type = (staffIdx == -1)? element-&gt;type() : ElementType::INVALID;</a>
<a name="ln1787"> </a>
<a name="ln1788">            //If has a multi measure rest, find the count and add each measure to it</a>
<a name="ln1789">            // ws: If style flag Sid::createMultiMeasureRests is not set, then</a>
<a name="ln1790">            // measure-&gt;mmRest() is not valid</a>
<a name="ln1791"> </a>
<a name="ln1792">//            if (measure-&gt;mmRest() ) {</a>
<a name="ln1793">            if (measure-&gt;mmRest() &amp;&amp; measure-&gt;score()-&gt;styleB(Sid::createMultiMeasureRests)) {</a>
<a name="ln1794">                  int mmrest_count = measure-&gt;mmRest()-&gt;mmRestCount();</a>
<a name="ln1795">                  Measure* tmp_measure = measure;</a>
<a name="ln1796">                  for (int mmrest_measure = 0; mmrest_measure &lt; mmrest_count; mmrest_measure++) {</a>
<a name="ln1797">                        std::tuple&lt;Measure*, int, ElementType&gt; tmp(tmp_measure, staffIdx, element_type);</a>
<a name="ln1798">                        meta_labels_set.insert(tmp);</a>
<a name="ln1799">                        tmp_measure = tmp_measure-&gt;nextMeasure();</a>
<a name="ln1800">                        }</a>
<a name="ln1801">                  }</a>
<a name="ln1802">            else {</a>
<a name="ln1803">                  std::tuple&lt;Measure*, int, ElementType&gt; tmp(measure, staffIdx, element_type);</a>
<a name="ln1804">                  meta_labels_set.insert(tmp);</a>
<a name="ln1805">                  }</a>
<a name="ln1806">            }</a>
<a name="ln1807"> </a>
<a name="ln1808">      QList&lt;QGraphicsItem*&gt; graphics_item_list = scene()-&gt;items();</a>
<a name="ln1809">      for (QGraphicsItem* graphics_item : graphics_item_list) {</a>
<a name="ln1810"> </a>
<a name="ln1811">            int stave = graphics_item-&gt;data(0).value&lt;int&gt;();</a>
<a name="ln1812">            ElementType element_type = graphics_item-&gt;data(1).value&lt;ElementType&gt;();</a>
<a name="ln1813">            Measure* measure = static_cast&lt;Measure*&gt;(graphics_item-&gt;data(2).value&lt;void*&gt;());</a>
<a name="ln1814"> </a>
<a name="ln1815">            std::tuple&lt;Measure*, int, ElementType&gt; target_tuple(measure, stave, element_type);</a>
<a name="ln1816">            std::set&lt;std::tuple&lt;Measure*, int, ElementType&gt;&gt;::iterator it;</a>
<a name="ln1817">            it = meta_labels_set.find(target_tuple);</a>
<a name="ln1818"> </a>
<a name="ln1819">            if (stave == -1 &amp;&amp; it != meta_labels_set.end()) {</a>
<a name="ln1820">                  //Make sure the element is correct</a>
<a name="ln1821">                  QList&lt;Element*&gt; element_list = _score-&gt;selection().elements();</a>
<a name="ln1822">                  Element* target_element = static_cast&lt;Element*&gt;(graphics_item-&gt;data(4).value&lt;void*&gt;());</a>
<a name="ln1823">                  Segment* seg = static_cast&lt;Segment*&gt;(graphics_item-&gt;data(6).value&lt;void*&gt;());</a>
<a name="ln1824"> </a>
<a name="ln1825">                  if (target_element) {</a>
<a name="ln1826">                        for (Element* element : element_list) {</a>
<a name="ln1827">                              if (element == target_element) {</a>
<a name="ln1828">                                    QGraphicsRectItem* graphics_rect_item = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(graphics_item);</a>
<a name="ln1829">                                    if (graphics_rect_item)</a>
<a name="ln1830">                                          graphics_rect_item-&gt;setBrush(QBrush(QColor(173,216,230)));</a>
<a name="ln1831">                                    }</a>
<a name="ln1832">                              }</a>
<a name="ln1833">                        }</a>
<a name="ln1834">                  else if (seg) {</a>
<a name="ln1835">                        for (Element* element : element_list) {</a>
<a name="ln1836">                              QGraphicsRectItem* graphics_rect_item = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(graphics_item);</a>
<a name="ln1837">                              if (graphics_rect_item) {</a>
<a name="ln1838">                                    for (int track = 0; track &lt; _score-&gt;nstaves() * VOICES; track++) {</a>
<a name="ln1839">                                          if (element == seg-&gt;element(track))</a>
<a name="ln1840">                                                graphics_rect_item-&gt;setBrush(QBrush(QColor(173,216,230)));</a>
<a name="ln1841">                                          }</a>
<a name="ln1842">                                    }</a>
<a name="ln1843">                              }</a>
<a name="ln1844">                        }</a>
<a name="ln1845">                  else {</a>
<a name="ln1846">                        QGraphicsRectItem* graphics_rect_item = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(graphics_item);</a>
<a name="ln1847">                        if (graphics_rect_item)</a>
<a name="ln1848">                              graphics_rect_item-&gt;setBrush(QBrush(QColor(173,216,230)));</a>
<a name="ln1849">                        }</a>
<a name="ln1850">                  }</a>
<a name="ln1851">            //Change color from gray to only blue</a>
<a name="ln1852">            else if (it != meta_labels_set.end()) {</a>
<a name="ln1853">                  QGraphicsRectItem* graphics_rect_item = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(graphics_item);</a>
<a name="ln1854">                  graphics_rect_item-&gt;setBrush(QBrush(QColor(graphics_rect_item-&gt;brush().color().red(),</a>
<a name="ln1855">                                                             graphics_rect_item-&gt;brush().color().green(),</a>
<a name="ln1856">                                                             255)));</a>
<a name="ln1857">                  selection_path.addRect(graphics_rect_item-&gt;rect());</a>
<a name="ln1858">                  }</a>
<a name="ln1859">            }</a>
<a name="ln1860"> </a>
<a name="ln1861">      QGraphicsPathItem* graphics_path_item = new QGraphicsPathItem(selection_path.simplified());</a>
<a name="ln1862">      if (selection.isRange())</a>
<a name="ln1863">            graphics_path_item-&gt;setPen(QPen(QColor(0, 0, 255), 3));</a>
<a name="ln1864">      else</a>
<a name="ln1865">            graphics_path_item-&gt;setPen(QPen(QColor(0, 0, 0), 1));</a>
<a name="ln1866"> </a>
<a name="ln1867">      graphics_path_item-&gt;setBrush(Qt::NoBrush);</a>
<a name="ln1868">      graphics_path_item-&gt;setZValue(-1);</a>
<a name="ln1869">      scene()-&gt;addItem(graphics_path_item);</a>
<a name="ln1870"> </a>
<a name="ln1871">      if (std::get&lt;0&gt;(old_hover_info)) {</a>
<a name="ln1872">            std::get&lt;0&gt;(old_hover_info) = nullptr;</a>
<a name="ln1873">            std::get&lt;1&gt;(old_hover_info) = -1;</a>
<a name="ln1874">            }</a>
<a name="ln1875">      }</a>
<a name="ln1876"> </a>
<a name="ln1877">//---------------------------------------------------------</a>
<a name="ln1878">//   mousePressEvent</a>
<a name="ln1879">//---------------------------------------------------------</a>
<a name="ln1880"> </a>
<a name="ln1881">void Timeline::mousePressEvent(QMouseEvent* event)</a>
<a name="ln1882">      {</a>
<a name="ln1883">      if (!_score)</a>
<a name="ln1884">            return;</a>
<a name="ln1885"> </a>
<a name="ln1886">      if (event-&gt;button() == Qt::RightButton)</a>
<a name="ln1887">          return;</a>
<a name="ln1888"> </a>
<a name="ln1889">      //Set as clicked</a>
<a name="ln1890">      mouse_pressed = true;</a>
<a name="ln1891">      scene()-&gt;clearSelection();</a>
<a name="ln1892"> </a>
<a name="ln1893">      QPointF scene_pt = mapToScene(event-&gt;pos());</a>
<a name="ln1894">      //Set as old location</a>
<a name="ln1895">      old_loc = QPoint(int(scene_pt.x()), int(scene_pt.y()));</a>
<a name="ln1896">      QList&lt;QGraphicsItem*&gt; graphics_item_list = scene()-&gt;items(scene_pt);</a>
<a name="ln1897">      //Find highest z value for rect</a>
<a name="ln1898">      int max_z_value = -4;</a>
<a name="ln1899">      QGraphicsItem* curr_graphics_item = nullptr;</a>
<a name="ln1900">      for (QGraphicsItem* graphics_item: graphics_item_list) {</a>
<a name="ln1901">            QGraphicsRectItem* graphics_rect_item = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(graphics_item);</a>
<a name="ln1902">            if (graphics_rect_item &amp;&amp; graphics_item-&gt;zValue() &gt; max_z_value) {</a>
<a name="ln1903">                  curr_graphics_item = graphics_item;</a>
<a name="ln1904">                  max_z_value = graphics_item-&gt;zValue();</a>
<a name="ln1905">                  }</a>
<a name="ln1906">            }</a>
<a name="ln1907">      if (curr_graphics_item) {</a>
<a name="ln1908">            int stave = curr_graphics_item-&gt;data(0).value&lt;int&gt;();</a>
<a name="ln1909">            Measure* curr_measure = static_cast&lt;Measure*&gt;(curr_graphics_item-&gt;data(2).value&lt;void*&gt;());</a>
<a name="ln1910">            if (numToStaff(stave) &amp;&amp; !numToStaff(stave)-&gt;show())</a>
<a name="ln1911">                  return;</a>
<a name="ln1912"> </a>
<a name="ln1913">            if (!curr_measure) {</a>
<a name="ln1914">                  int nmeta = nmetas();</a>
<a name="ln1915">                  int bottom_of_meta = nmeta * grid_height + verticalScrollBar()-&gt;value();</a>
<a name="ln1916"> </a>
<a name="ln1917">                  //Handle measure box clicks</a>
<a name="ln1918">                  if (scene_pt.y() &gt; (nmeta - 1) * grid_height + verticalScrollBar()-&gt;value() &amp;&amp;</a>
<a name="ln1919">                      scene_pt.y() &lt; bottom_of_meta) {</a>
<a name="ln1920"> </a>
<a name="ln1921">                        QRectF tmp(scene_pt.x(), 0, 3, nmeta * grid_height + nstaves() * grid_height);</a>
<a name="ln1922">                        QList&lt;QGraphicsItem*&gt; gl = scene()-&gt;items(tmp);</a>
<a name="ln1923">                        Measure* measure = nullptr;</a>
<a name="ln1924"> </a>
<a name="ln1925">                        for (QGraphicsItem* graphics_item : gl) {</a>
<a name="ln1926">                              measure = static_cast&lt;Measure*&gt;(graphics_item-&gt;data(2).value&lt;void*&gt;());</a>
<a name="ln1927">                              //-3 z value is the grid square values</a>
<a name="ln1928">                              if (graphics_item-&gt;zValue() == -3 &amp;&amp; measure)</a>
<a name="ln1929">                                    break;</a>
<a name="ln1930">                              }</a>
<a name="ln1931">                        if (measure)</a>
<a name="ln1932">                              _cv-&gt;adjustCanvasPosition(measure, false);</a>
<a name="ln1933">                        }</a>
<a name="ln1934">                  if (scene_pt.y() &lt; bottom_of_meta)</a>
<a name="ln1935">                        return;</a>
<a name="ln1936"> </a>
<a name="ln1937">                  QList&lt;QGraphicsItem*&gt; gl = items(event-&gt;pos());</a>
<a name="ln1938">                  for (QGraphicsItem* graphics_item : gl) {</a>
<a name="ln1939">                        curr_measure = static_cast&lt;Measure*&gt;(graphics_item-&gt;data(2).value&lt;void*&gt;());</a>
<a name="ln1940">                        stave = graphics_item-&gt;data(0).value&lt;int&gt;();</a>
<a name="ln1941">                        if (curr_measure)</a>
<a name="ln1942">                              break;</a>
<a name="ln1943">                        }</a>
<a name="ln1944">                  if (!curr_measure) {</a>
<a name="ln1945">                        _score-&gt;select(0, SelectType::SINGLE, 0);</a>
<a name="ln1946">                        return;</a>
<a name="ln1947">                        }</a>
<a name="ln1948">                  }</a>
<a name="ln1949"> </a>
<a name="ln1950">            bool meta_value_clicked = curr_graphics_item-&gt;data(3).value&lt;bool&gt;();</a>
<a name="ln1951"> </a>
<a name="ln1952">            scene()-&gt;clearSelection();</a>
<a name="ln1953">            if (meta_value_clicked) {</a>
<a name="ln1954"> </a>
<a name="ln1955">                  meta_value = true;</a>
<a name="ln1956">                  old_selection_rect = QRect();</a>
<a name="ln1957"> </a>
<a name="ln1958">                  _cv-&gt;adjustCanvasPosition(curr_measure, false, 0);</a>
<a name="ln1959">                  verticalScrollBar()-&gt;setValue(0);</a>
<a name="ln1960"> </a>
<a name="ln1961">                  Segment* seg = static_cast&lt;Segment*&gt;(curr_graphics_item-&gt;data(6).value&lt;void*&gt;());</a>
<a name="ln1962"> </a>
<a name="ln1963">                  if (seg) {</a>
<a name="ln1964">                        _score-&gt;deselectAll();</a>
<a name="ln1965">                        for (int track = 0; track &lt; _score-&gt;nstaves() * VOICES; track++) {</a>
<a name="ln1966">                              Element* element = seg-&gt;element(track);</a>
<a name="ln1967">                              if (element)</a>
<a name="ln1968">                                    _score-&gt;select(seg-&gt;element(track), SelectType::ADD);</a>
<a name="ln1969">                              }</a>
<a name="ln1970">                        }</a>
<a name="ln1971">                  else {</a>
<a name="ln1972">                        //Also select the elements that they correspond to</a>
<a name="ln1973">                        ElementType element_type = curr_graphics_item-&gt;data(1).value&lt;ElementType&gt;();</a>
<a name="ln1974">                        SegmentType segment_type = SegmentType::Invalid;</a>
<a name="ln1975">                        if (element_type == ElementType::KEYSIG)</a>
<a name="ln1976">                              segment_type = SegmentType::KeySig;</a>
<a name="ln1977">                        else if (element_type == ElementType::TIMESIG)</a>
<a name="ln1978">                              segment_type = SegmentType::TimeSig;</a>
<a name="ln1979"> </a>
<a name="ln1980">                        if (segment_type != SegmentType::Invalid) {</a>
<a name="ln1981">                              Segment* curr_seg = curr_measure-&gt;first();</a>
<a name="ln1982">                              for (; curr_seg &amp;&amp; curr_seg-&gt;segmentType() != segment_type; curr_seg = curr_seg-&gt;next()) {</a>
<a name="ln1983">                                    }</a>
<a name="ln1984">                              if (curr_seg) {</a>
<a name="ln1985">                                    _score-&gt;deselectAll();</a>
<a name="ln1986">                                    for (int j = 0; j &lt; _score-&gt;nstaves(); j++) {</a>
<a name="ln1987">                                          Element* element = curr_seg-&gt;firstElement(j);</a>
<a name="ln1988">                                          if (element)</a>
<a name="ln1989">                                                _score-&gt;select(element, SelectType::ADD);</a>
<a name="ln1990">                                          }</a>
<a name="ln1991">                                    }</a>
<a name="ln1992">                              }</a>
<a name="ln1993">                        else {</a>
<a name="ln1994">                              _score-&gt;deselectAll();</a>
<a name="ln1995">                              _score-&gt;select(curr_measure, SelectType::ADD, 0);</a>
<a name="ln1996">                              //Select just the element for tempo_text</a>
<a name="ln1997">                              Element* element = static_cast&lt;Element*&gt;(curr_graphics_item-&gt;data(4).value&lt;void*&gt;());</a>
<a name="ln1998">                              _score-&gt;deselectAll();</a>
<a name="ln1999">                              _score-&gt;select(element);</a>
<a name="ln2000">                              }</a>
<a name="ln2001">                        }</a>
<a name="ln2002">                  }</a>
<a name="ln2003">            else {</a>
<a name="ln2004">                  //Handle cell clicks</a>
<a name="ln2005">                  if (event-&gt;modifiers() == Qt::ShiftModifier) {</a>
<a name="ln2006">                        if (curr_measure-&gt;mmRest())</a>
<a name="ln2007">                              curr_measure = curr_measure-&gt;mmRest();</a>
<a name="ln2008">                        else if (curr_measure-&gt;mmRestCount() == -1)</a>
<a name="ln2009">                              curr_measure = curr_measure-&gt;prevMeasureMM();</a>
<a name="ln2010">                        _score-&gt;select(curr_measure, SelectType::RANGE, stave);</a>
<a name="ln2011">                        _score-&gt;setUpdateAll();</a>
<a name="ln2012">                        }</a>
<a name="ln2013">                  else if (event-&gt;modifiers() == Qt::ControlModifier) {</a>
<a name="ln2014"> </a>
<a name="ln2015">                        if (_score-&gt;selection().isNone()) {</a>
<a name="ln2016">                              if (curr_measure-&gt;mmRest())</a>
<a name="ln2017">                                    curr_measure = curr_measure-&gt;mmRest();</a>
<a name="ln2018">                              else if (curr_measure-&gt;mmRestCount() == -1)</a>
<a name="ln2019">                                    curr_measure = curr_measure-&gt;prevMeasureMM();</a>
<a name="ln2020"> </a>
<a name="ln2021">                              _score-&gt;select(curr_measure, SelectType::RANGE, 0);</a>
<a name="ln2022">                              _score-&gt;select(curr_measure, SelectType::RANGE, _score-&gt;nstaves()-1);</a>
<a name="ln2023">                              _score-&gt;setUpdateAll();</a>
<a name="ln2024">                              }</a>
<a name="ln2025">                        else</a>
<a name="ln2026">                              _score-&gt;deselectAll();</a>
<a name="ln2027">                        }</a>
<a name="ln2028">                  else {</a>
<a name="ln2029">                        if (curr_measure-&gt;mmRest())</a>
<a name="ln2030">                              curr_measure = curr_measure-&gt;mmRest();</a>
<a name="ln2031">                        else if (curr_measure-&gt;mmRestCount() == -1)</a>
<a name="ln2032">                              curr_measure = curr_measure-&gt;prevMeasureMM();</a>
<a name="ln2033">                        _score-&gt;select(curr_measure, SelectType::SINGLE, stave);</a>
<a name="ln2034">                        }</a>
<a name="ln2035">                  _cv-&gt;adjustCanvasPosition(curr_measure, false, stave);</a>
<a name="ln2036"> </a>
<a name="ln2037">                  }</a>
<a name="ln2038">            mscore-&gt;endCmd();</a>
<a name="ln2039">            _score-&gt;update();</a>
<a name="ln2040">            }</a>
<a name="ln2041">      else {</a>
<a name="ln2042">            _score-&gt;deselectAll();</a>
<a name="ln2043">            mscore-&gt;endCmd();</a>
<a name="ln2044">            _score-&gt;update();</a>
<a name="ln2045">            }</a>
<a name="ln2046">      _score-&gt;setUpdateAll();</a>
<a name="ln2047">      }</a>
<a name="ln2048"> </a>
<a name="ln2049">//---------------------------------------------------------</a>
<a name="ln2050">//   mouseMoveEvent</a>
<a name="ln2051">//---------------------------------------------------------</a>
<a name="ln2052"> </a>
<a name="ln2053">void Timeline::mouseMoveEvent(QMouseEvent* event)</a>
<a name="ln2054">      {</a>
<a name="ln2055">      QPointF new_loc = mapToScene(event-&gt;pos());</a>
<a name="ln2056">      if (!mouse_pressed) {</a>
<a name="ln2057"> </a>
<a name="ln2058">            if (cursorIsOn() == &quot;meta&quot;) {</a>
<a name="ln2059">                  this-&gt;setCursor(Qt::ArrowCursor);</a>
<a name="ln2060">                  mouseOver(new_loc);</a>
<a name="ln2061">                  }</a>
<a name="ln2062">            else if (cursorIsOn() == &quot;invalid&quot;)</a>
<a name="ln2063">                  this-&gt;setCursor(Qt::ForbiddenCursor);</a>
<a name="ln2064">            else</a>
<a name="ln2065">                  this-&gt;setCursor(Qt::ArrowCursor);</a>
<a name="ln2066"> </a>
<a name="ln2067">            emit moved(QPointF(-1, -1));</a>
<a name="ln2068">            return;</a>
<a name="ln2069">            }</a>
<a name="ln2070"> </a>
<a name="ln2071">      if (state == ViewState::NORMAL) {</a>
<a name="ln2072">            if (event-&gt;modifiers() == Qt::ShiftModifier) {</a>
<a name="ln2073">                  //Slight wiggle room for selection (Same as score)</a>
<a name="ln2074">                  if (abs(new_loc.x() - old_loc.x()) &gt; 2 ||</a>
<a name="ln2075">                      abs(new_loc.y() - old_loc.y()) &gt; 2) {</a>
<a name="ln2076">                        _score-&gt;deselectAll();</a>
<a name="ln2077">                        updateGrid();</a>
<a name="ln2078">                        state = ViewState::LASSO;</a>
<a name="ln2079">                        selection_box = new QGraphicsRectItem();</a>
<a name="ln2080">                        selection_box-&gt;setRect(old_loc.x(), old_loc.y(), 0, 0);</a>
<a name="ln2081">                        selection_box-&gt;setPen(QPen(QColor(0, 0, 255), 2));</a>
<a name="ln2082">                        selection_box-&gt;setBrush(QBrush(QColor(0, 0, 255, 50)));</a>
<a name="ln2083">                        scene()-&gt;addItem(selection_box);</a>
<a name="ln2084">                        }</a>
<a name="ln2085">                  }</a>
<a name="ln2086">            else {</a>
<a name="ln2087">                  state = ViewState::DRAG;</a>
<a name="ln2088">                  this-&gt;setCursor(Qt::SizeAllCursor);</a>
<a name="ln2089">                  }</a>
<a name="ln2090">            }</a>
<a name="ln2091"> </a>
<a name="ln2092">      if (state == ViewState::LASSO) {</a>
<a name="ln2093">            QRect tmp = QRect((old_loc.x() &lt; new_loc.x())? old_loc.x() : new_loc.x(),</a>
<a name="ln2094">                              (old_loc.y() &lt; new_loc.y())? old_loc.y() : new_loc.y(),</a>
<a name="ln2095">                              abs(new_loc.x() - old_loc.x()),</a>
<a name="ln2096">                              abs(new_loc.y() - old_loc.y()));</a>
<a name="ln2097">            selection_box-&gt;setRect(tmp);</a>
<a name="ln2098">            }</a>
<a name="ln2099">      else if (state == ViewState::DRAG) {</a>
<a name="ln2100">            int x_offset = int(old_loc.x()) - int(new_loc.x());</a>
<a name="ln2101">            int y_offset = int(old_loc.y()) - int(new_loc.y());</a>
<a name="ln2102">            horizontalScrollBar()-&gt;setValue(horizontalScrollBar()-&gt;value() + x_offset);</a>
<a name="ln2103">            verticalScrollBar()-&gt;setValue(verticalScrollBar()-&gt;value() + y_offset);</a>
<a name="ln2104">            }</a>
<a name="ln2105">      emit moved(QPointF(-1, -1));</a>
<a name="ln2106">      }</a>
<a name="ln2107"> </a>
<a name="ln2108">//---------------------------------------------------------</a>
<a name="ln2109">//   mouseReleaseEvent</a>
<a name="ln2110">//---------------------------------------------------------</a>
<a name="ln2111"> </a>
<a name="ln2112">void Timeline::mouseReleaseEvent(QMouseEvent*)</a>
<a name="ln2113">      {</a>
<a name="ln2114">      mouse_pressed = false;</a>
<a name="ln2115">      if (state == ViewState::LASSO) {</a>
<a name="ln2116"> </a>
<a name="ln2117">            scene()-&gt;removeItem(selection_box);</a>
<a name="ln2118">            _score-&gt;deselectAll();</a>
<a name="ln2119"> </a>
<a name="ln2120">            int width, height;</a>
<a name="ln2121">            QPoint loc = mapFromScene(selection_box-&gt;rect().topLeft());</a>
<a name="ln2122">            width = int(selection_box-&gt;rect().width());</a>
<a name="ln2123">            height = int(selection_box-&gt;rect().height());</a>
<a name="ln2124"> </a>
<a name="ln2125">            QList&lt;QGraphicsItem*&gt; graphics_item_list = items(QRect(loc.x(), loc.y(), width, height));</a>
<a name="ln2126">            //Find top left and bottom right to create selection</a>
<a name="ln2127">            QGraphicsItem* tl_graphics_item = nullptr;</a>
<a name="ln2128">            QGraphicsItem* br_graphics_item = nullptr;</a>
<a name="ln2129">            for (QGraphicsItem* graphics_item : graphics_item_list) {</a>
<a name="ln2130">                  Measure* curr_measure = static_cast&lt;Measure*&gt;(graphics_item-&gt;data(2).value&lt;void*&gt;());</a>
<a name="ln2131">                  if (!curr_measure) continue;</a>
<a name="ln2132">                  int stave = graphics_item-&gt;data(0).value&lt;int&gt;();</a>
<a name="ln2133">                  if (stave == -1) continue;</a>
<a name="ln2134"> </a>
<a name="ln2135">                  if (!tl_graphics_item &amp;&amp; !br_graphics_item) {</a>
<a name="ln2136">                        tl_graphics_item = graphics_item;</a>
<a name="ln2137">                        br_graphics_item = graphics_item;</a>
<a name="ln2138">                        continue;</a>
<a name="ln2139">                        }</a>
<a name="ln2140"> </a>
<a name="ln2141">                  if (graphics_item-&gt;boundingRect().top() &lt; tl_graphics_item-&gt;boundingRect().top())</a>
<a name="ln2142">                        tl_graphics_item = graphics_item;</a>
<a name="ln2143">                  if (graphics_item-&gt;boundingRect().left() &lt; tl_graphics_item-&gt;boundingRect().left())</a>
<a name="ln2144">                        tl_graphics_item = graphics_item;</a>
<a name="ln2145"> </a>
<a name="ln2146">                  if (graphics_item-&gt;boundingRect().bottom() &gt; br_graphics_item-&gt;boundingRect().bottom())</a>
<a name="ln2147">                        br_graphics_item = graphics_item;</a>
<a name="ln2148">                  if (graphics_item-&gt;boundingRect().right() &gt; br_graphics_item-&gt;boundingRect().right())</a>
<a name="ln2149">                        br_graphics_item = graphics_item;</a>
<a name="ln2150"> </a>
<a name="ln2151">                  }</a>
<a name="ln2152"> </a>
<a name="ln2153">            //Select single tl_graphics_item and then range br_graphics_item</a>
<a name="ln2154">            if (tl_graphics_item &amp;&amp; br_graphics_item) {</a>
<a name="ln2155">                  Measure* tl_measure = static_cast&lt;Measure*&gt;(tl_graphics_item-&gt;data(2).value&lt;void*&gt;());</a>
<a name="ln2156">                  int tl_stave = tl_graphics_item-&gt;data(0).value&lt;int&gt;();</a>
<a name="ln2157">                  Measure* br_measure = static_cast&lt;Measure*&gt;(br_graphics_item-&gt;data(2).value&lt;void*&gt;());</a>
<a name="ln2158">                  int br_stave = br_graphics_item-&gt;data(0).value&lt;int&gt;();</a>
<a name="ln2159">                  if (tl_measure &amp;&amp; br_measure) {</a>
<a name="ln2160">                        //Focus selection of mmRests here</a>
<a name="ln2161">                        if (tl_measure-&gt;mmRest())</a>
<a name="ln2162">                              tl_measure = tl_measure-&gt;mmRest();</a>
<a name="ln2163">                        else if (tl_measure-&gt;mmRestCount() == -1)</a>
<a name="ln2164">                              tl_measure = tl_measure-&gt;prevMeasureMM();</a>
<a name="ln2165">                        if (br_measure-&gt;mmRest())</a>
<a name="ln2166">                              br_measure = br_measure-&gt;mmRest();</a>
<a name="ln2167">                        else if (br_measure-&gt;mmRestCount() == -1)</a>
<a name="ln2168">                              br_measure = br_measure-&gt;prevMeasureMM();</a>
<a name="ln2169"> </a>
<a name="ln2170">                        _score-&gt;select(tl_measure, SelectType::SINGLE, tl_stave);</a>
<a name="ln2171">                        _score-&gt;select(br_measure, SelectType::RANGE, br_stave);</a>
<a name="ln2172">                        }</a>
<a name="ln2173">                  _cv-&gt;adjustCanvasPosition(tl_measure, false, tl_stave);</a>
<a name="ln2174">                  }</a>
<a name="ln2175"> </a>
<a name="ln2176">            _score-&gt;update();</a>
<a name="ln2177">            mscore-&gt;endCmd();</a>
<a name="ln2178">            }</a>
<a name="ln2179">      else if (state == ViewState::DRAG) {</a>
<a name="ln2180">            this-&gt;setCursor(Qt::ArrowCursor);</a>
<a name="ln2181">            mscore-&gt;endCmd();</a>
<a name="ln2182">            }</a>
<a name="ln2183">      state = ViewState::NORMAL;</a>
<a name="ln2184">      }</a>
<a name="ln2185"> </a>
<a name="ln2186">//---------------------------------------------------------</a>
<a name="ln2187">//   leaveEvent</a>
<a name="ln2188">//---------------------------------------------------------</a>
<a name="ln2189"> </a>
<a name="ln2190">void Timeline::leaveEvent(QEvent*)</a>
<a name="ln2191">      {</a>
<a name="ln2192">      if (!rect().contains(mapFromGlobal(QCursor::pos()))) {</a>
<a name="ln2193">            QPointF p = mapToScene(mapFromGlobal(QCursor::pos()));</a>
<a name="ln2194">            mouseOver(p);</a>
<a name="ln2195">            }</a>
<a name="ln2196">      }</a>
<a name="ln2197"> </a>
<a name="ln2198">//---------------------------------------------------------</a>
<a name="ln2199">//   wheelEvent</a>
<a name="ln2200">//---------------------------------------------------------</a>
<a name="ln2201"> </a>
<a name="ln2202">void Timeline::wheelEvent(QWheelEvent* event)</a>
<a name="ln2203">      {</a>
<a name="ln2204">      if (event-&gt;modifiers().testFlag(Qt::ControlModifier)) {</a>
<a name="ln2205">            qreal original_cursor_pos = mapToScene(mapFromGlobal(QCursor::pos())).x();</a>
<a name="ln2206">            int original_scroll_value = horizontalScrollBar()-&gt;value();</a>
<a name="ln2207">            qreal ratio = original_cursor_pos / qreal(getWidth());</a>
<a name="ln2208"> </a>
<a name="ln2209">            if (event-&gt;angleDelta().y() &gt; 0 &amp;&amp; grid_width &lt; max_zoom) {</a>
<a name="ln2210">                  grid_width++;</a>
<a name="ln2211">                  updateGrid();</a>
<a name="ln2212">                  }</a>
<a name="ln2213">            else if (event-&gt;angleDelta().y() &lt; 0 &amp;&amp; grid_width &gt; min_zoom) {</a>
<a name="ln2214">                  grid_width--;</a>
<a name="ln2215">                  updateGrid();</a>
<a name="ln2216">                  }</a>
<a name="ln2217"> </a>
<a name="ln2218">            //Attempt to keep mouse in original spot</a>
<a name="ln2219">            qreal new_pos = qreal(getWidth()) * ratio;</a>
<a name="ln2220">            int offset = new_pos - original_cursor_pos;</a>
<a name="ln2221">            horizontalScrollBar()-&gt;setValue(original_scroll_value + offset);</a>
<a name="ln2222">            }</a>
<a name="ln2223">      else if (event-&gt;modifiers().testFlag(Qt::ShiftModifier)) {</a>
<a name="ln2224">            qreal num_of_steps = qreal(event-&gt;angleDelta().y()) / 2;</a>
<a name="ln2225">            horizontalScrollBar()-&gt;setValue(horizontalScrollBar()-&gt;value() - int(num_of_steps));</a>
<a name="ln2226">            }</a>
<a name="ln2227">      else</a>
<a name="ln2228">            QGraphicsView::wheelEvent(event);</a>
<a name="ln2229">      }</a>
<a name="ln2230"> </a>
<a name="ln2231">//---------------------------------------------------------</a>
<a name="ln2232">//   updateGrid</a>
<a name="ln2233">//---------------------------------------------------------</a>
<a name="ln2234"> </a>
<a name="ln2235">void Timeline::updateGrid()</a>
<a name="ln2236">      {</a>
<a name="ln2237">      if (!isVisible())</a>
<a name="ln2238">            return;</a>
<a name="ln2239"> </a>
<a name="ln2240">      if (_score &amp;&amp; _score-&gt;firstMeasure()) {</a>
<a name="ln2241">            drawGrid(nstaves(), _score-&gt;nmeasures());</a>
<a name="ln2242">            updateView();</a>
<a name="ln2243">            drawSelection();</a>
<a name="ln2244">            mouseOver(mapToScene(mapFromGlobal(QCursor::pos())));</a>
<a name="ln2245">            row_names-&gt;updateLabels(getLabels(), grid_height);</a>
<a name="ln2246">            }</a>
<a name="ln2247">      viewport()-&gt;update();</a>
<a name="ln2248">      }</a>
<a name="ln2249"> </a>
<a name="ln2250">//---------------------------------------------------------</a>
<a name="ln2251">//   setScore</a>
<a name="ln2252">//---------------------------------------------------------</a>
<a name="ln2253"> </a>
<a name="ln2254">void Timeline::setScore(Score* s)</a>
<a name="ln2255">      {</a>
<a name="ln2256">      _score = s;</a>
<a name="ln2257">      scene()-&gt;clear();</a>
<a name="ln2258"> </a>
<a name="ln2259">      if (_score) {</a>
<a name="ln2260">            connect(_score, &amp;QObject::destroyed, this, &amp;Timeline::objectDestroyed, Qt::UniqueConnection);</a>
<a name="ln2261">            drawGrid(nstaves(), _score-&gt;nmeasures());</a>
<a name="ln2262">            changeSelection(SelState::NONE);</a>
<a name="ln2263">            row_names-&gt;updateLabels(getLabels(), grid_height);</a>
<a name="ln2264">            }</a>
<a name="ln2265">      else {</a>
<a name="ln2266">            //Clear timeline if no score is present</a>
<a name="ln2267">            QSplitter* sp = scrollArea-&gt;grid();</a>
<a name="ln2268">            if (sp &amp;&amp; sp-&gt;count() &gt; 0) {</a>
<a name="ln2269">                  TRowLabels* t_row_labels = static_cast&lt;TRowLabels*&gt;(sp-&gt;widget(0));</a>
<a name="ln2270">                  std::vector&lt;std::pair&lt;QString, bool&gt;&gt; no_labels;</a>
<a name="ln2271">                  t_row_labels-&gt;updateLabels(no_labels, 0);</a>
<a name="ln2272">                  }</a>
<a name="ln2273">            meta_rows.clear();</a>
<a name="ln2274">            setSceneRect(0, 0, 0, 0);</a>
<a name="ln2275">            }</a>
<a name="ln2276"> </a>
<a name="ln2277">      viewport()-&gt;update();</a>
<a name="ln2278">      }</a>
<a name="ln2279"> </a>
<a name="ln2280">//---------------------------------------------------------</a>
<a name="ln2281">//   setScoreView</a>
<a name="ln2282">//---------------------------------------------------------</a>
<a name="ln2283"> </a>
<a name="ln2284">void Timeline::setScoreView(ScoreView* v)</a>
<a name="ln2285">      {</a>
<a name="ln2286">      _cv = v;</a>
<a name="ln2287">      if (_cv) {</a>
<a name="ln2288">            connect(_cv, &amp;ScoreView::sizeChanged, this, &amp;Timeline::updateView, Qt::UniqueConnection);</a>
<a name="ln2289">            connect(_cv, &amp;ScoreView::viewRectChanged, this, &amp;Timeline::updateView, Qt::UniqueConnection);</a>
<a name="ln2290">            connect(_cv, &amp;QObject::destroyed, this, &amp;Timeline::objectDestroyed, Qt::UniqueConnection);</a>
<a name="ln2291">            updateView();</a>
<a name="ln2292">            }</a>
<a name="ln2293">      }</a>
<a name="ln2294"> </a>
<a name="ln2295">//---------------------------------------------------------</a>
<a name="ln2296">//   objectDestroyed</a>
<a name="ln2297">//---------------------------------------------------------</a>
<a name="ln2298"> </a>
<a name="ln2299">void Timeline::objectDestroyed(QObject* obj)</a>
<a name="ln2300">      {</a>
<a name="ln2301">      if (_cv == obj)</a>
<a name="ln2302">            setScoreView(nullptr);</a>
<a name="ln2303">      else if (_score == obj)</a>
<a name="ln2304">            setScore(nullptr);</a>
<a name="ln2305">      }</a>
<a name="ln2306"> </a>
<a name="ln2307">//---------------------------------------------------------</a>
<a name="ln2308">//   updateView</a>
<a name="ln2309">//---------------------------------------------------------</a>
<a name="ln2310"> </a>
<a name="ln2311">void Timeline::updateView()</a>
<a name="ln2312">      {</a>
<a name="ln2313">      if (!isVisible())</a>
<a name="ln2314">            return;</a>
<a name="ln2315"> </a>
<a name="ln2316">      if (_cv &amp;&amp; _score) {</a>
<a name="ln2317">            QRectF canvas = QRectF(_cv-&gt;matrix().inverted().mapRect(_cv-&gt;geometry()));</a>
<a name="ln2318"> </a>
<a name="ln2319">            std::set&lt;std::pair&lt;Measure*, int&gt;&gt; visible_items_set;</a>
<a name="ln2320"> </a>
<a name="ln2321">            //Find visible measures of score</a>
<a name="ln2322">            for (Measure* curr_measure = _score-&gt;firstMeasure(); curr_measure; curr_measure = curr_measure-&gt;nextMeasure()) {</a>
<a name="ln2323">                  System* system = curr_measure-&gt;system();</a>
<a name="ln2324"> </a>
<a name="ln2325">                  if (curr_measure-&gt;mmRest() &amp;&amp; _score-&gt;styleB(Sid::createMultiMeasureRests)) {</a>
<a name="ln2326">                        //Handle mmRests</a>
<a name="ln2327">                        Measure* mmrest_measure = curr_measure-&gt;mmRest();</a>
<a name="ln2328">                        system = mmrest_measure-&gt;system();</a>
<a name="ln2329">                        if (!system)</a>
<a name="ln2330">                              continue;</a>
<a name="ln2331"> </a>
<a name="ln2332">                        //Add all measures within mmRest to visible_items_set if mmRest_visible</a>
<a name="ln2333">                        for (; curr_measure != mmrest_measure-&gt;mmRestLast(); curr_measure = curr_measure-&gt;nextMeasure()) {</a>
<a name="ln2334">                              for (int staff = 0; staff &lt; _score-&gt;staves().length(); staff++) {</a>
<a name="ln2335">                                    if (!_score-&gt;staff(staff)-&gt;show())</a>
<a name="ln2336">                                          continue;</a>
<a name="ln2337">                                    QRectF stave_rect = QRectF(system-&gt;canvasBoundingRect().left(),</a>
<a name="ln2338">                                                               system-&gt;staffCanvasYpage(staff),</a>
<a name="ln2339">                                                               system-&gt;width(),</a>
<a name="ln2340">                                                               system-&gt;staff(staff)-&gt;bbox().height());</a>
<a name="ln2341">                                    QRectF show_rect = mmrest_measure-&gt;canvasBoundingRect().intersected(stave_rect);</a>
<a name="ln2342"> </a>
<a name="ln2343">                                    if (canvas.intersects(show_rect)) {</a>
<a name="ln2344">                                          std::pair&lt;Measure*, int&gt; p(curr_measure, staff);</a>
<a name="ln2345">                                          visible_items_set.insert(p);</a>
<a name="ln2346">                                          }</a>
<a name="ln2347">                                    }</a>
<a name="ln2348">                              }</a>
<a name="ln2349"> </a>
<a name="ln2350">                        //Handle last measure in mmRest</a>
<a name="ln2351">                        for (int staff = 0; staff &lt; _score-&gt;staves().length(); staff++) {</a>
<a name="ln2352">                              if (!_score-&gt;staff(staff)-&gt;show())</a>
<a name="ln2353">                                    continue;</a>
<a name="ln2354">                              QRectF stave_rect = QRectF(system-&gt;canvasBoundingRect().left(),</a>
<a name="ln2355">                                                         system-&gt;staffCanvasYpage(staff),</a>
<a name="ln2356">                                                         system-&gt;width(),</a>
<a name="ln2357">                                                         system-&gt;staff(staff)-&gt;bbox().height());</a>
<a name="ln2358">                              QRectF show_rect = mmrest_measure-&gt;canvasBoundingRect().intersected(stave_rect);</a>
<a name="ln2359"> </a>
<a name="ln2360">                              if (canvas.intersects(show_rect)) {</a>
<a name="ln2361">                                    std::pair&lt;Measure*, int&gt; p(curr_measure, staff);</a>
<a name="ln2362">                                    visible_items_set.insert(p);</a>
<a name="ln2363">                                    }</a>
<a name="ln2364">                              }</a>
<a name="ln2365">                        continue;</a>
<a name="ln2366">                        }</a>
<a name="ln2367"> </a>
<a name="ln2368">                  if (!system)</a>
<a name="ln2369">                        continue;</a>
<a name="ln2370"> </a>
<a name="ln2371">                  for (int staff = 0; staff &lt; _score-&gt;staves().length(); staff++) {</a>
<a name="ln2372">                        if (!_score-&gt;staff(staff)-&gt;show())</a>
<a name="ln2373">                              continue;</a>
<a name="ln2374">                        QRectF stave_rect = QRectF(system-&gt;canvasBoundingRect().left(),</a>
<a name="ln2375">                                                   system-&gt;staffCanvasYpage(staff),</a>
<a name="ln2376">                                                   system-&gt;width(),</a>
<a name="ln2377">                                                   system-&gt;staff(staff)-&gt;bbox().height());</a>
<a name="ln2378">                        QRectF show_rect = curr_measure-&gt;canvasBoundingRect().intersected(stave_rect);</a>
<a name="ln2379"> </a>
<a name="ln2380">                        if (canvas.intersects(show_rect)) {</a>
<a name="ln2381">                              std::pair&lt;Measure*, int&gt; p(curr_measure, staff);</a>
<a name="ln2382">                              visible_items_set.insert(p);</a>
<a name="ln2383">                              }</a>
<a name="ln2384">                        }</a>
<a name="ln2385">                  }</a>
<a name="ln2386"> </a>
<a name="ln2387">            //Find respective visible elements in timeline</a>
<a name="ln2388">            QPainterPath visible_painter_path = QPainterPath();</a>
<a name="ln2389">            visible_painter_path.setFillRule(Qt::WindingFill);</a>
<a name="ln2390">            for (QGraphicsItem* graphics_item : scene()-&gt;items()) {</a>
<a name="ln2391">                  int stave = graphics_item-&gt;data(0).value&lt;int&gt;();</a>
<a name="ln2392">                  Measure* measure = static_cast&lt;Measure*&gt;(graphics_item-&gt;data(2).value&lt;void*&gt;());</a>
<a name="ln2393">                  if (numToStaff(stave) &amp;&amp; !numToStaff(stave)-&gt;show())</a>
<a name="ln2394">                        continue;</a>
<a name="ln2395"> </a>
<a name="ln2396">                  std::pair&lt;Measure*, int&gt; tmp(measure, stave);</a>
<a name="ln2397">                  std::set&lt;std::pair&lt;Measure*, int&gt;&gt;::iterator it;</a>
<a name="ln2398">                  it = visible_items_set.find(tmp);</a>
<a name="ln2399">                  if (it != visible_items_set.end())</a>
<a name="ln2400">                        visible_painter_path.addRect(graphics_item-&gt;boundingRect());</a>
<a name="ln2401">                  }</a>
<a name="ln2402"> </a>
<a name="ln2403">            QPainterPath non_visible_painter_path = QPainterPath();</a>
<a name="ln2404">            non_visible_painter_path.setFillRule(Qt::WindingFill);</a>
<a name="ln2405"> </a>
<a name="ln2406">            QRectF timeline_rect = QRectF(0, 0, getWidth(), getHeight());</a>
<a name="ln2407">            non_visible_painter_path.addRect(timeline_rect);</a>
<a name="ln2408"> </a>
<a name="ln2409">            non_visible_painter_path = non_visible_painter_path.subtracted(visible_painter_path);</a>
<a name="ln2410"> </a>
<a name="ln2411">            QGraphicsPathItem* non_visible_path_item = new QGraphicsPathItem(non_visible_painter_path.simplified());</a>
<a name="ln2412"> </a>
<a name="ln2413">            QPen non_visible_pen = QPen(QColor(100, 150, 250));</a>
<a name="ln2414">            QBrush non_visible_brush = QBrush(QColor(192, 192, 192, 180));</a>
<a name="ln2415">            non_visible_path_item-&gt;setPen(QPen(non_visible_brush.color()));</a>
<a name="ln2416">            non_visible_path_item-&gt;setBrush(non_visible_brush);</a>
<a name="ln2417">            non_visible_path_item-&gt;setZValue(-3);</a>
<a name="ln2418"> </a>
<a name="ln2419">            QGraphicsPathItem* visible = new QGraphicsPathItem(visible_painter_path.simplified());</a>
<a name="ln2420">            visible-&gt;setPen(non_visible_pen);</a>
<a name="ln2421">            visible-&gt;setBrush(Qt::NoBrush);</a>
<a name="ln2422">            visible-&gt;setZValue(-2);</a>
<a name="ln2423"> </a>
<a name="ln2424">            //Find old path, remove it</a>
<a name="ln2425">            for (QGraphicsItem* graphics_item : scene()-&gt;items()) {</a>
<a name="ln2426">                  if (graphics_item-&gt;type() == QGraphicsPathItem().type()) {</a>
<a name="ln2427">                        QGraphicsPathItem* old_path_item = static_cast&lt;QGraphicsPathItem*&gt;(graphics_item);</a>
<a name="ln2428">                        QBrush old_brush = old_path_item-&gt;brush();</a>
<a name="ln2429">                        QPen old_pen = old_path_item-&gt;pen();</a>
<a name="ln2430">                        if (old_brush == non_visible_brush || old_pen == non_visible_pen)</a>
<a name="ln2431">                              scene()-&gt;removeItem(old_path_item);</a>
<a name="ln2432">                        }</a>
<a name="ln2433">                  }</a>
<a name="ln2434"> </a>
<a name="ln2435">            scene()-&gt;addItem(non_visible_path_item);</a>
<a name="ln2436">            scene()-&gt;addItem(visible);</a>
<a name="ln2437">            }</a>
<a name="ln2438">      }</a>
<a name="ln2439"> </a>
<a name="ln2440">//---------------------------------------------------------</a>
<a name="ln2441">//   nstaves</a>
<a name="ln2442">//---------------------------------------------------------</a>
<a name="ln2443"> </a>
<a name="ln2444">int Timeline::nstaves()</a>
<a name="ln2445">      {</a>
<a name="ln2446">      return _score-&gt;staves().size();</a>
<a name="ln2447">      }</a>
<a name="ln2448"> </a>
<a name="ln2449">//---------------------------------------------------------</a>
<a name="ln2450">//   colorBox</a>
<a name="ln2451">//---------------------------------------------------------</a>
<a name="ln2452"> </a>
<a name="ln2453">QColor Timeline::colorBox(QGraphicsRectItem* item)</a>
<a name="ln2454">      {</a>
<a name="ln2455">      Measure* measure = static_cast&lt;Measure*&gt;(item-&gt;data(2).value&lt;void*&gt;());</a>
<a name="ln2456">      int stave = item-&gt;data(0).value&lt;int&gt;();</a>
<a name="ln2457">      for (Segment* seg = measure-&gt;first(); seg; seg = seg-&gt;next()) {</a>
<a name="ln2458">            if (!seg-&gt;isChordRestType())</a>
<a name="ln2459">                  continue;</a>
<a name="ln2460">            for (int track = stave * VOICES; track &lt; stave * VOICES + VOICES; track++) {</a>
<a name="ln2461">                  ChordRest* chord_rest = seg-&gt;cr(track);</a>
<a name="ln2462">                  if (chord_rest) {</a>
<a name="ln2463">                        ElementType crt = chord_rest-&gt;type();</a>
<a name="ln2464">                        if (crt == ElementType::CHORD || crt == ElementType::REPEAT_MEASURE)</a>
<a name="ln2465">                              return QColor(Qt::gray);</a>
<a name="ln2466">                        }</a>
<a name="ln2467">                  }</a>
<a name="ln2468">            }</a>
<a name="ln2469">      return QColor(224,224,224);</a>
<a name="ln2470">      }</a>
<a name="ln2471"> </a>
<a name="ln2472">//---------------------------------------------------------</a>
<a name="ln2473">//   getLabels</a>
<a name="ln2474">//---------------------------------------------------------</a>
<a name="ln2475"> </a>
<a name="ln2476">std::vector&lt;std::pair&lt;QString, bool&gt;&gt; Timeline::getLabels()</a>
<a name="ln2477">      {</a>
<a name="ln2478">      if (!_score) {</a>
<a name="ln2479">            std::vector&lt;std::pair&lt;QString, bool&gt;&gt; no_labels;</a>
<a name="ln2480">            return no_labels;</a>
<a name="ln2481">            }</a>
<a name="ln2482">      QList&lt;Part*&gt; part_list = getParts();</a>
<a name="ln2483">      //transfer them into a vector of qstrings and then add the meta row names</a>
<a name="ln2484">      std::vector&lt;std::pair&lt;QString, bool&gt;&gt; row_labels;</a>
<a name="ln2485">      if (collapsed_meta) {</a>
<a name="ln2486">            std::pair&lt;QString, bool&gt; first(&quot;&quot;, true);</a>
<a name="ln2487">            std::pair&lt;QString, bool&gt; second(tr(&quot;Measures&quot;), true);</a>
<a name="ln2488">            row_labels.push_back(first);</a>
<a name="ln2489">            row_labels.push_back(second);</a>
<a name="ln2490">            }</a>
<a name="ln2491">      else {</a>
<a name="ln2492">            for (auto it = metas.begin(); it != metas.end(); ++it) {</a>
<a name="ln2493">                  std::tuple&lt;QString, void (Timeline::*)(Segment*, int*, int), bool&gt; meta = *it;</a>
<a name="ln2494">                  if (!std::get&lt;2&gt;(meta))</a>
<a name="ln2495">                        continue;</a>
<a name="ln2496">                  std::pair&lt;QString, bool&gt; meta_label(std::get&lt;0&gt;(meta), true);</a>
<a name="ln2497">                  row_labels.push_back(meta_label);</a>
<a name="ln2498">                  }</a>
<a name="ln2499">            }</a>
<a name="ln2500"> </a>
<a name="ln2501">      for (int stave = 0; stave &lt; part_list.size(); stave++) {</a>
<a name="ln2502">            QTextDocument doc;</a>
<a name="ln2503">            QString part_name = &quot;&quot;;</a>
<a name="ln2504">            doc.setHtml(part_list.at(stave)-&gt;longName());</a>
<a name="ln2505">            part_name = doc.toPlainText();</a>
<a name="ln2506">            if (part_name.isEmpty())</a>
<a name="ln2507">                  part_name = part_list.at(stave)-&gt;instrumentName();</a>
<a name="ln2508"> </a>
<a name="ln2509">            std::pair&lt;QString, bool&gt; instrument_label(part_name, part_list.at(stave)-&gt;show());</a>
<a name="ln2510">            row_labels.push_back(instrument_label);</a>
<a name="ln2511">            }</a>
<a name="ln2512">      return row_labels;</a>
<a name="ln2513">      }</a>
<a name="ln2514"> </a>
<a name="ln2515">//---------------------------------------------------------</a>
<a name="ln2516">//   handle_scroll</a>
<a name="ln2517">//---------------------------------------------------------</a>
<a name="ln2518"> </a>
<a name="ln2519">void Timeline::handle_scroll(int value)</a>
<a name="ln2520">      {</a>
<a name="ln2521">      if (!_score)</a>
<a name="ln2522">            return;</a>
<a name="ln2523">      for (std::vector&lt;std::pair&lt;QGraphicsItem*, int&gt;&gt;::iterator it = meta_rows.begin();</a>
<a name="ln2524">           it != meta_rows.end(); ++it) {</a>
<a name="ln2525">            std::pair&lt;QGraphicsItem*, int&gt; pair_graphics_int = *it;</a>
<a name="ln2526"> </a>
<a name="ln2527">            QGraphicsItem* graphics_item = pair_graphics_int.first;</a>
<a name="ln2528">            QGraphicsRectItem* graphics_rect_item = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(graphics_item);</a>
<a name="ln2529">            QGraphicsLineItem* graphics_line_item = qgraphicsitem_cast&lt;QGraphicsLineItem*&gt;(graphics_item);</a>
<a name="ln2530">            QGraphicsPixmapItem* graphics_pixmap_item = qgraphicsitem_cast&lt;QGraphicsPixmapItem*&gt;(graphics_item);</a>
<a name="ln2531"> </a>
<a name="ln2532">            int row_y = pair_graphics_int.second * grid_height;</a>
<a name="ln2533">            int scrollbar_value = value;</a>
<a name="ln2534"> </a>
<a name="ln2535">            if (graphics_rect_item) {</a>
<a name="ln2536">                  QRectF rectf = graphics_rect_item-&gt;rect();</a>
<a name="ln2537">                  rectf.setY(qreal(scrollbar_value + row_y));</a>
<a name="ln2538">                  rectf.setHeight(grid_height);</a>
<a name="ln2539">                  graphics_rect_item-&gt;setRect(rectf);</a>
<a name="ln2540">                  }</a>
<a name="ln2541">            else if (graphics_line_item) {</a>
<a name="ln2542">                  QLineF linef = graphics_line_item-&gt;line();</a>
<a name="ln2543">                  linef.setLine(linef.x1(), row_y + scrollbar_value + 1, linef.x2(), row_y + scrollbar_value + 1);</a>
<a name="ln2544">                  graphics_line_item-&gt;setLine(linef);</a>
<a name="ln2545">                  }</a>
<a name="ln2546">            else if (graphics_pixmap_item)</a>
<a name="ln2547">                  graphics_pixmap_item-&gt;setY(qreal(scrollbar_value + row_y + 3));</a>
<a name="ln2548">            else</a>
<a name="ln2549">                  graphics_item-&gt;setY(qreal(scrollbar_value + row_y));</a>
<a name="ln2550">            }</a>
<a name="ln2551">      viewport()-&gt;update();</a>
<a name="ln2552">      }</a>
<a name="ln2553"> </a>
<a name="ln2554">//---------------------------------------------------------</a>
<a name="ln2555">//   mouseOver</a>
<a name="ln2556">//---------------------------------------------------------</a>
<a name="ln2557"> </a>
<a name="ln2558">void Timeline::mouseOver(QPointF pos)</a>
<a name="ln2559">      {</a>
<a name="ln2560">      //Choose item with the largest original Z value...</a>
<a name="ln2561">      QList&lt;QGraphicsItem*&gt; graphics_list = scene()-&gt;items(pos);</a>
<a name="ln2562">      QGraphicsItem* hovered_graphics_item = 0;</a>
<a name="ln2563">      int max_z_value = -1;</a>
<a name="ln2564">      for (QGraphicsItem* curr_graphics_item: graphics_list) {</a>
<a name="ln2565">            if (qgraphicsitem_cast&lt;QGraphicsTextItem*&gt;(curr_graphics_item))</a>
<a name="ln2566">                  continue;</a>
<a name="ln2567">            if (curr_graphics_item-&gt;zValue() &gt;= max_z_value &amp;&amp; curr_graphics_item-&gt;zValue() &lt; global_z_value) {</a>
<a name="ln2568">                  hovered_graphics_item = curr_graphics_item;</a>
<a name="ln2569">                  max_z_value = hovered_graphics_item-&gt;zValue();</a>
<a name="ln2570">                  }</a>
<a name="ln2571">            else if (curr_graphics_item-&gt;zValue() &gt; global_z_value &amp;&amp; std::get&lt;1&gt;(old_hover_info) &gt;= max_z_value){</a>
<a name="ln2572">                  hovered_graphics_item = curr_graphics_item;</a>
<a name="ln2573">                  max_z_value = std::get&lt;1&gt;(old_hover_info);</a>
<a name="ln2574">                  }</a>
<a name="ln2575">            }</a>
<a name="ln2576"> </a>
<a name="ln2577">      if (!hovered_graphics_item) {</a>
<a name="ln2578">            if (std::get&lt;0&gt;(old_hover_info)) {</a>
<a name="ln2579">                  std::get&lt;0&gt;(old_hover_info)-&gt;setZValue(std::get&lt;1&gt;(old_hover_info));</a>
<a name="ln2580">                  static_cast&lt;QGraphicsItem*&gt;(std::get&lt;0&gt;(old_hover_info)-&gt;data(5).value&lt;void*&gt;())-&gt;setZValue(std::get&lt;1&gt;(old_hover_info));</a>
<a name="ln2581">                  QGraphicsRectItem* graphics_rect_item1 = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(std::get&lt;0&gt;(old_hover_info));</a>
<a name="ln2582">                  QGraphicsRectItem* graphics_rect_item2 = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(static_cast&lt;QGraphicsItem*&gt;(std::get&lt;0&gt;(old_hover_info)-&gt;data(5).value&lt;void*&gt;()));</a>
<a name="ln2583">                  if (graphics_rect_item1)</a>
<a name="ln2584">                        graphics_rect_item1-&gt;setBrush(QBrush(std::get&lt;2&gt;(old_hover_info)));</a>
<a name="ln2585">                  if (graphics_rect_item2)</a>
<a name="ln2586">                        graphics_rect_item2-&gt;setBrush(QBrush(std::get&lt;2&gt;(old_hover_info)));</a>
<a name="ln2587">                  std::get&lt;0&gt;(old_hover_info) = nullptr;</a>
<a name="ln2588">                  std::get&lt;1&gt;(old_hover_info) = -1;</a>
<a name="ln2589">                  }</a>
<a name="ln2590">            return;</a>
<a name="ln2591">            }</a>
<a name="ln2592">      QGraphicsItem* pair_item = static_cast&lt;QGraphicsItem*&gt;(hovered_graphics_item-&gt;data(5).value&lt;void*&gt;());</a>
<a name="ln2593">      if (!pair_item) {</a>
<a name="ln2594">            if (std::get&lt;0&gt;(old_hover_info)) {</a>
<a name="ln2595">                  std::get&lt;0&gt;(old_hover_info)-&gt;setZValue(std::get&lt;1&gt;(old_hover_info));</a>
<a name="ln2596">                  static_cast&lt;QGraphicsItem*&gt;(std::get&lt;0&gt;(old_hover_info)-&gt;data(5).value&lt;void*&gt;())-&gt;setZValue(std::get&lt;1&gt;(old_hover_info));</a>
<a name="ln2597">                  QGraphicsRectItem* graphics_rect_item1 = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(std::get&lt;0&gt;(old_hover_info));</a>
<a name="ln2598">                  QGraphicsRectItem* graphics_rect_item2 = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(static_cast&lt;QGraphicsItem*&gt;(std::get&lt;0&gt;(old_hover_info)-&gt;data(5).value&lt;void*&gt;()));</a>
<a name="ln2599">                  if (graphics_rect_item1)</a>
<a name="ln2600">                        graphics_rect_item1-&gt;setBrush(QBrush(std::get&lt;2&gt;(old_hover_info)));</a>
<a name="ln2601">                  if (graphics_rect_item2)</a>
<a name="ln2602">                        graphics_rect_item2-&gt;setBrush(QBrush(std::get&lt;2&gt;(old_hover_info)));</a>
<a name="ln2603">                  std::get&lt;0&gt;(old_hover_info) = nullptr;</a>
<a name="ln2604">                  std::get&lt;1&gt;(old_hover_info) = -1;</a>
<a name="ln2605">                  }</a>
<a name="ln2606">            return;</a>
<a name="ln2607">            }</a>
<a name="ln2608"> </a>
<a name="ln2609">      if (std::get&lt;0&gt;(old_hover_info) == hovered_graphics_item)</a>
<a name="ln2610">            return;</a>
<a name="ln2611"> </a>
<a name="ln2612">      if (std::get&lt;0&gt;(old_hover_info)) {</a>
<a name="ln2613">            std::get&lt;0&gt;(old_hover_info)-&gt;setZValue(std::get&lt;1&gt;(old_hover_info));</a>
<a name="ln2614">            static_cast&lt;QGraphicsItem*&gt;(std::get&lt;0&gt;(old_hover_info)-&gt;data(5).value&lt;void*&gt;())-&gt;setZValue(std::get&lt;1&gt;(old_hover_info));</a>
<a name="ln2615">            QGraphicsRectItem* graphics_rect_item1 = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(std::get&lt;0&gt;(old_hover_info));</a>
<a name="ln2616">            QGraphicsRectItem* graphics_rect_item2 = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(static_cast&lt;QGraphicsItem*&gt;(std::get&lt;0&gt;(old_hover_info)-&gt;data(5).value&lt;void*&gt;()));</a>
<a name="ln2617">            if (graphics_rect_item1)</a>
<a name="ln2618">                  graphics_rect_item1-&gt;setBrush(QBrush(std::get&lt;2&gt;(old_hover_info)));</a>
<a name="ln2619">            if (graphics_rect_item2)</a>
<a name="ln2620">                  graphics_rect_item2-&gt;setBrush(QBrush(std::get&lt;2&gt;(old_hover_info)));</a>
<a name="ln2621"> </a>
<a name="ln2622">            std::get&lt;0&gt;(old_hover_info) = nullptr;</a>
<a name="ln2623">            std::get&lt;1&gt;(old_hover_info) = -1;</a>
<a name="ln2624">            }</a>
<a name="ln2625"> </a>
<a name="ln2626">      std::get&lt;1&gt;(old_hover_info) = hovered_graphics_item-&gt;zValue();</a>
<a name="ln2627">      std::get&lt;0&gt;(old_hover_info) = hovered_graphics_item;</a>
<a name="ln2628"> </a>
<a name="ln2629">      //Give items the top z value</a>
<a name="ln2630">      hovered_graphics_item-&gt;setZValue(global_z_value + 1);</a>
<a name="ln2631">      pair_item-&gt;setZValue(global_z_value + 1);</a>
<a name="ln2632"> </a>
<a name="ln2633">      QGraphicsRectItem* graphics_rect_item1 = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(hovered_graphics_item);</a>
<a name="ln2634">      QGraphicsRectItem* graphics_rect_item2 = qgraphicsitem_cast&lt;QGraphicsRectItem*&gt;(pair_item);</a>
<a name="ln2635">      if (graphics_rect_item1) {</a>
<a name="ln2636">            std::get&lt;2&gt;(old_hover_info) = graphics_rect_item1-&gt;brush().color();</a>
<a name="ln2637">            if (std::get&lt;2&gt;(old_hover_info) != QColor(173,216,230))</a>
<a name="ln2638">                  graphics_rect_item1-&gt;setBrush(QBrush(Qt::lightGray));</a>
<a name="ln2639">            }</a>
<a name="ln2640">      if (graphics_rect_item2) {</a>
<a name="ln2641">            std::get&lt;2&gt;(old_hover_info) = graphics_rect_item2-&gt;brush().color();</a>
<a name="ln2642">            if (std::get&lt;2&gt;(old_hover_info) != QColor(173,216,230))</a>
<a name="ln2643">                  graphics_rect_item2-&gt;setBrush(QBrush(Qt::lightGray));</a>
<a name="ln2644">            }</a>
<a name="ln2645">      }</a>
<a name="ln2646"> </a>
<a name="ln2647">//---------------------------------------------------------</a>
<a name="ln2648">//   swapMeta</a>
<a name="ln2649">//---------------------------------------------------------</a>
<a name="ln2650"> </a>
<a name="ln2651">void Timeline::swapMeta(unsigned int row, bool switch_up)</a>
<a name="ln2652">      {</a>
<a name="ln2653">      //Attempt to switch row up or down, skipping non visible rows</a>
<a name="ln2654">      if (switch_up &amp;&amp; row != 0) {</a>
<a name="ln2655">            //traverse backwards until visible one is found</a>
<a name="ln2656">            auto swap = metas.begin() + correctMetaRow(row) - 1;</a>
<a name="ln2657">            while (!std::get&lt;2&gt;(*swap))</a>
<a name="ln2658">                  swap--;</a>
<a name="ln2659">            iter_swap(metas.begin() + correctMetaRow(row), swap);</a>
<a name="ln2660">            }</a>
<a name="ln2661">      else if (!switch_up &amp;&amp; row != nmetas() - 2) {</a>
<a name="ln2662">            //traverse forwards until visible one is found</a>
<a name="ln2663">            auto swap = metas.begin() + correctMetaRow(row) + 1;</a>
<a name="ln2664">            while (!std::get&lt;2&gt;(*swap))</a>
<a name="ln2665">                  swap++;</a>
<a name="ln2666">            iter_swap(metas.begin() + correctMetaRow(row), swap);</a>
<a name="ln2667">            }</a>
<a name="ln2668"> </a>
<a name="ln2669">      updateGrid();</a>
<a name="ln2670">      }</a>
<a name="ln2671"> </a>
<a name="ln2672">//---------------------------------------------------------</a>
<a name="ln2673">//   numToStaff</a>
<a name="ln2674">//---------------------------------------------------------</a>
<a name="ln2675"> </a>
<a name="ln2676">Staff* Timeline::numToStaff(int staff)</a>
<a name="ln2677">      {</a>
<a name="ln2678">      if (!_score)</a>
<a name="ln2679">            return 0;</a>
<a name="ln2680">      QList&lt;Staff*&gt; staves = _score-&gt;staves();</a>
<a name="ln2681">      if (staves.size() &gt; staff &amp;&amp; staff &gt;= 0)</a>
<a name="ln2682">            return staves.at(staff);</a>
<a name="ln2683">      else</a>
<a name="ln2684">            return 0;</a>
<a name="ln2685">      }</a>
<a name="ln2686"> </a>
<a name="ln2687">//---------------------------------------------------------</a>
<a name="ln2688">//   toggleShow</a>
<a name="ln2689">//---------------------------------------------------------</a>
<a name="ln2690"> </a>
<a name="ln2691">void Timeline::toggleShow(int staff)</a>
<a name="ln2692">      {</a>
<a name="ln2693">      if (!_score)</a>
<a name="ln2694">            return;</a>
<a name="ln2695">      QList&lt;Part*&gt; parts = getParts();</a>
<a name="ln2696">      if (parts.size() &gt; staff &amp;&amp; staff &gt;= 0) {</a>
<a name="ln2697">            parts.at(staff)-&gt;setShow(!parts.at(staff)-&gt;show());</a>
<a name="ln2698">            parts.at(staff)-&gt;undoChangeProperty(Pid::VISIBLE, parts.at(staff)-&gt;show());</a>
<a name="ln2699">            _score-&gt;masterScore()-&gt;setLayoutAll();</a>
<a name="ln2700">            _score-&gt;masterScore()-&gt;update();</a>
<a name="ln2701">            mscore-&gt;endCmd();</a>
<a name="ln2702">            }</a>
<a name="ln2703">      }</a>
<a name="ln2704"> </a>
<a name="ln2705">//---------------------------------------------------------</a>
<a name="ln2706">//   showContextMenu</a>
<a name="ln2707">//---------------------------------------------------------</a>
<a name="ln2708"> </a>
<a name="ln2709">void Timeline::contextMenuEvent(QContextMenuEvent*)</a>
<a name="ln2710">      {</a>
<a name="ln2711">      QMenu* context_menu = new QMenu(tr(&quot;Context menu&quot;), this);</a>
<a name="ln2712">      if (row_names-&gt;cursorIsOn() == &quot;instrument&quot;) {</a>
<a name="ln2713">            QAction* edit_instruments = new QAction(tr(&quot;Edit Instruments&quot;), this);</a>
<a name="ln2714">            connect(edit_instruments, SIGNAL(triggered()), this, SLOT(requestInstrumentDialog()));</a>
<a name="ln2715">            context_menu-&gt;addAction(edit_instruments);</a>
<a name="ln2716">            context_menu-&gt;exec(QCursor::pos());</a>
<a name="ln2717">            }</a>
<a name="ln2718">      else if (row_names-&gt;cursorIsOn() == &quot;meta&quot; || cursorIsOn() == &quot;meta&quot;) {</a>
<a name="ln2719">            for (auto it = metas.begin(); it != metas.end(); ++it) {</a>
<a name="ln2720">                  std::tuple&lt;QString, void (Timeline::*)(Segment*, int*, int), bool&gt; meta = *it;</a>
<a name="ln2721">                  QString row_name = std::get&lt;0&gt;(meta);</a>
<a name="ln2722">                  if (row_name != tr(&quot;Measures&quot;)) {</a>
<a name="ln2723">                        QAction* action = new QAction(row_name, this);</a>
<a name="ln2724">                        action-&gt;setCheckable(true);</a>
<a name="ln2725">                        action-&gt;setChecked(std::get&lt;2&gt;(meta));</a>
<a name="ln2726">                        connect(action, SIGNAL(triggered()), this, SLOT(toggleMetaRow()));</a>
<a name="ln2727">                        context_menu-&gt;addAction(action);</a>
<a name="ln2728">                        }</a>
<a name="ln2729">                  }</a>
<a name="ln2730">            context_menu-&gt;addSeparator();</a>
<a name="ln2731">            QAction* hide_all = new QAction(tr(&quot;Hide all&quot;), this);</a>
<a name="ln2732">            connect(hide_all, SIGNAL(triggered()), this, SLOT(toggleMetaRow()));</a>
<a name="ln2733">            context_menu-&gt;addAction(hide_all);</a>
<a name="ln2734">            QAction* show_all = new QAction(tr(&quot;Show all&quot;), this);</a>
<a name="ln2735">            connect(show_all, SIGNAL(triggered()), this, SLOT(toggleMetaRow()));</a>
<a name="ln2736">            context_menu-&gt;addAction(show_all);</a>
<a name="ln2737">            context_menu-&gt;exec(QCursor::pos());</a>
<a name="ln2738">            }</a>
<a name="ln2739">      }</a>
<a name="ln2740"> </a>
<a name="ln2741">//---------------------------------------------------------</a>
<a name="ln2742">//   toggleMetaRow</a>
<a name="ln2743">//---------------------------------------------------------</a>
<a name="ln2744"> </a>
<a name="ln2745">void Timeline::toggleMetaRow()</a>
<a name="ln2746">      {</a>
<a name="ln2747">      QAction* action = qobject_cast&lt;QAction*&gt;(QObject::sender());</a>
<a name="ln2748">      if (action) {</a>
<a name="ln2749">            QString target_text = action-&gt;text();</a>
<a name="ln2750"> </a>
<a name="ln2751">            if (target_text == tr(&quot;Hide all&quot;)) {</a>
<a name="ln2752">                  for (auto it = metas.begin(); it != metas.end(); ++it) {</a>
<a name="ln2753">                        QString meta_text = std::get&lt;0&gt;(*it);</a>
<a name="ln2754">                        if (meta_text != tr(&quot;Measures&quot;))</a>
<a name="ln2755">                              std::get&lt;2&gt;(*it) = false;</a>
<a name="ln2756">                        }</a>
<a name="ln2757">                  updateGrid();</a>
<a name="ln2758">                  return;</a>
<a name="ln2759">                  }</a>
<a name="ln2760">            else if (target_text == tr(&quot;Show all&quot;)) {</a>
<a name="ln2761">                  for (auto it = metas.begin(); it != metas.end(); ++it)</a>
<a name="ln2762">                        std::get&lt;2&gt;(*it) = true;</a>
<a name="ln2763">                  updateGrid();</a>
<a name="ln2764">                  return;</a>
<a name="ln2765">                  }</a>
<a name="ln2766"> </a>
<a name="ln2767">            bool checked = action-&gt;isChecked();</a>
<a name="ln2768">            //Find target text in metas and toggle visibility to the checked status of action</a>
<a name="ln2769">            for (auto it = metas.begin(); it != metas.end(); ++it) {</a>
<a name="ln2770">                  QString meta_text = std::get&lt;0&gt;(*it);</a>
<a name="ln2771">                  if (meta_text == target_text) {</a>
<a name="ln2772">                        std::get&lt;2&gt;(*it) = checked;</a>
<a name="ln2773">                        updateGrid();</a>
<a name="ln2774">                        break;</a>
<a name="ln2775">                        }</a>
<a name="ln2776">                  }</a>
<a name="ln2777">            }</a>
<a name="ln2778">      }</a>
<a name="ln2779"> </a>
<a name="ln2780">//---------------------------------------------------------</a>
<a name="ln2781">//   nmetas</a>
<a name="ln2782">//---------------------------------------------------------</a>
<a name="ln2783"> </a>
<a name="ln2784">unsigned int Timeline::nmetas()</a>
<a name="ln2785">      {</a>
<a name="ln2786">      unsigned int total = 0;</a>
<a name="ln2787">      if (collapsed_meta)</a>
<a name="ln2788">            return 2;</a>
<a name="ln2789">      for (auto it = metas.begin(); it != metas.end(); ++it) {</a>
<a name="ln2790">            std::tuple&lt;QString, void (Timeline::*)(Segment*, int*, int), bool&gt; meta = *it;</a>
<a name="ln2791">            if (std::get&lt;2&gt;(meta))</a>
<a name="ln2792">                  total++;</a>
<a name="ln2793">            }</a>
<a name="ln2794">      return total;</a>
<a name="ln2795">      }</a>
<a name="ln2796"> </a>
<a name="ln2797">//---------------------------------------------------------</a>
<a name="ln2798">//   correctMetaRow</a>
<a name="ln2799">//---------------------------------------------------------</a>
<a name="ln2800"> </a>
<a name="ln2801">unsigned int Timeline::correctMetaRow(unsigned int row)</a>
<a name="ln2802">      {</a>
<a name="ln2803">      unsigned int count = 0;</a>
<a name="ln2804">      auto it = metas.begin();</a>
<a name="ln2805">      while (row &gt;= count) {</a>
<a name="ln2806">            if (!std::get&lt;2&gt;(*it))</a>
<a name="ln2807">                  row++;</a>
<a name="ln2808">            count++;</a>
<a name="ln2809">            ++it;</a>
<a name="ln2810">            }</a>
<a name="ln2811">      return row;</a>
<a name="ln2812">      }</a>
<a name="ln2813"> </a>
<a name="ln2814">//---------------------------------------------------------</a>
<a name="ln2815">//   correctMetaRow</a>
<a name="ln2816">//---------------------------------------------------------</a>
<a name="ln2817"> </a>
<a name="ln2818">QString Timeline::cursorIsOn()</a>
<a name="ln2819">      {</a>
<a name="ln2820">      QPointF scene_pos = mapToScene(mapFromGlobal(QCursor::pos()));</a>
<a name="ln2821">      QGraphicsItem* graphics_item = scene()-&gt;itemAt(scene_pos, transform());</a>
<a name="ln2822">      if (graphics_item) {</a>
<a name="ln2823">            auto it = meta_rows.begin();</a>
<a name="ln2824">            for (;it != meta_rows.end(); ++it) {</a>
<a name="ln2825">                  if ((*it).first == graphics_item)</a>
<a name="ln2826">                        break;</a>
<a name="ln2827">                  }</a>
<a name="ln2828">            if (it != meta_rows.end())</a>
<a name="ln2829">                  return &quot;meta&quot;;</a>
<a name="ln2830">            else {</a>
<a name="ln2831">                  QList&lt;QGraphicsItem*&gt; graphics_item_list = scene()-&gt;items(scene_pos);</a>
<a name="ln2832">                  for (QGraphicsItem* curr_graphics_item : graphics_item_list) {</a>
<a name="ln2833">                        Measure* curr_measure = static_cast&lt;Measure*&gt;(curr_graphics_item-&gt;data(2).value&lt;void*&gt;());</a>
<a name="ln2834">                        int stave = curr_graphics_item-&gt;data(0).value&lt;int&gt;();</a>
<a name="ln2835">                        if (curr_measure &amp;&amp; !numToStaff(stave)-&gt;show())</a>
<a name="ln2836">                              return &quot;invalid&quot;;</a>
<a name="ln2837">                        }</a>
<a name="ln2838">                  return &quot;instrument&quot;;</a>
<a name="ln2839">                  }</a>
<a name="ln2840">            }</a>
<a name="ln2841">      else</a>
<a name="ln2842">            return &quot;&quot;;</a>
<a name="ln2843">      }</a>
<a name="ln2844"> </a>
<a name="ln2845">//---------------------------------------------------------</a>
<a name="ln2846">//   requestInstrumentDialog</a>
<a name="ln2847">//---------------------------------------------------------</a>
<a name="ln2848"> </a>
<a name="ln2849">void Timeline::requestInstrumentDialog()</a>
<a name="ln2850">      {</a>
<a name="ln2851">      QAction* act = getAction(&quot;instruments&quot;);</a>
<a name="ln2852">      mscore-&gt;cmd(act);</a>
<a name="ln2853">      if (mscore-&gt;getMixer())</a>
<a name="ln2854">            mscore-&gt;getMixer()-&gt;setScore(_score);</a>
<a name="ln2855">      }</a>
<a name="ln2856"> </a>
<a name="ln2857">}</a>

</code></pre>
<div class="balloon" rel="2105"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v640/" target="_blank">V640</a> The code's operational logic does not correspond with its formatting. The statement is indented to the right, but it is always executed. It is possible that curly brackets are missing.</p></div>
<div class="balloon" rel="2755"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The 'false' value is implicitly cast to the pointer.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
