
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>importgtp-gp6.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2014 John Pirie</a>
<a name="ln6">//  Parts of the GPX Import based on code contributed by J.JÃ¸rgen von Bargen</a>
<a name="ln7">//</a>
<a name="ln8">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln9">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln10">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln11">//  the file LICENCE.GPL</a>
<a name="ln12">//=============================================================================</a>
<a name="ln13"> </a>
<a name="ln14">#include &quot;importgtp.h&quot;</a>
<a name="ln15">#include &quot;globals.h&quot;</a>
<a name="ln16">#include &lt;libmscore/score.h&gt;</a>
<a name="ln17">#include &lt;libmscore/measurebase.h&gt;</a>
<a name="ln18">#include &lt;libmscore/text.h&gt;</a>
<a name="ln19">#include &lt;libmscore/stafftext.h&gt;</a>
<a name="ln20">#include &lt;libmscore/box.h&gt;</a>
<a name="ln21">#include &lt;libmscore/staff.h&gt;</a>
<a name="ln22">#include &lt;libmscore/part.h&gt;</a>
<a name="ln23">#include &lt;libmscore/measure.h&gt;</a>
<a name="ln24">#include &lt;libmscore/timesig.h&gt;</a>
<a name="ln25">#include &lt;libmscore/tremolo.h&gt;</a>
<a name="ln26">#include &lt;libmscore/rest.h&gt;</a>
<a name="ln27">#include &lt;libmscore/chord.h&gt;</a>
<a name="ln28">#include &lt;libmscore/note.h&gt;</a>
<a name="ln29">#include &lt;libmscore/stringdata.h&gt;</a>
<a name="ln30">#include &lt;libmscore/clef.h&gt;</a>
<a name="ln31">#include &lt;libmscore/lyrics.h&gt;</a>
<a name="ln32">#include &lt;libmscore/tempotext.h&gt;</a>
<a name="ln33">#include &lt;libmscore/slur.h&gt;</a>
<a name="ln34">#include &lt;libmscore/tie.h&gt;</a>
<a name="ln35">#include &lt;libmscore/tuplet.h&gt;</a>
<a name="ln36">#include &lt;libmscore/barline.h&gt;</a>
<a name="ln37">#include &lt;libmscore/excerpt.h&gt;</a>
<a name="ln38">#include &lt;libmscore/stafftype.h&gt;</a>
<a name="ln39">#include &lt;libmscore/bracket.h&gt;</a>
<a name="ln40">#include &lt;libmscore/articulation.h&gt;</a>
<a name="ln41">#include &lt;libmscore/keysig.h&gt;</a>
<a name="ln42">#include &lt;libmscore/harmony.h&gt;</a>
<a name="ln43">#include &lt;libmscore/bend.h&gt;</a>
<a name="ln44">#include &lt;libmscore/tremolobar.h&gt;</a>
<a name="ln45">#include &lt;libmscore/segment.h&gt;</a>
<a name="ln46">#include &lt;libmscore/rehearsalmark.h&gt;</a>
<a name="ln47">#include &lt;libmscore/repeat.h&gt;</a>
<a name="ln48">#include &lt;libmscore/glissando.h&gt;</a>
<a name="ln49">#include &lt;libmscore/dynamic.h&gt;</a>
<a name="ln50">#include &lt;libmscore/arpeggio.h&gt;</a>
<a name="ln51">#include &lt;libmscore/volta.h&gt;</a>
<a name="ln52">#include &lt;libmscore/instrtemplate.h&gt;</a>
<a name="ln53">#include &lt;libmscore/hairpin.h&gt;</a>
<a name="ln54">#include &lt;libmscore/fingering.h&gt;</a>
<a name="ln55">#include &lt;libmscore/sym.h&gt;</a>
<a name="ln56">#include &lt;libmscore/ottava.h&gt;</a>
<a name="ln57">#include &lt;libmscore/marker.h&gt;</a>
<a name="ln58">#include &lt;libmscore/notedot.h&gt;</a>
<a name="ln59">#include &quot;libmscore/sym.h&quot;</a>
<a name="ln60">#include &quot;libmscore/bracketItem.h&quot;</a>
<a name="ln61">#include &quot;libmscore/textline.h&quot;</a>
<a name="ln62">#include &lt;libmscore/repeat.h&gt;</a>
<a name="ln63">// #include &lt;symtext.h&gt;</a>
<a name="ln64"> </a>
<a name="ln65">namespace Ms {</a>
<a name="ln66"> </a>
<a name="ln67"> </a>
<a name="ln68">const static std::map&lt;QString, QString&gt; instrumentMapping = {</a>
<a name="ln69">            {&quot;2Mrcs&quot;,           &quot;maracas&quot;},</a>
<a name="ln70">            {&quot;a-bass4&quot;,         &quot;acoustic-bass&quot;},</a>
<a name="ln71">            {&quot;a-bass5&quot;,         &quot;acoustic-bass&quot;},</a>
<a name="ln72">            {&quot;a-bass6&quot;,         &quot;acoustic-bass&quot;},</a>
<a name="ln73">            {&quot;alt-c&quot;,           &quot;alto&quot;},</a>
<a name="ln74">            {&quot;alt-s&quot;,           &quot;alto&quot;},</a>
<a name="ln75">            {&quot;a-piano-gs&quot;,      &quot;piano&quot;},</a>
<a name="ln76">            {&quot;a-piano-ss&quot;,      &quot;piano&quot;},</a>
<a name="ln77">            {&quot;bass-c&quot;,          &quot;bass&quot;},</a>
<a name="ln78">            {&quot;bass-flt-c&quot;,      &quot;bass-flute&quot;},</a>
<a name="ln79">            {&quot;bassn&quot;,           &quot;bassoon&quot;},</a>
<a name="ln80">            {&quot;bass-s&quot;,          &quot;bass&quot;},</a>
<a name="ln81">            {&quot;basstuba-eb&quot;,     &quot;bass-eb-tuba&quot;},</a>
<a name="ln82">            {&quot;bnj4&quot;,            &quot;banjo&quot;},</a>
<a name="ln83">            {&quot;bnj5&quot;,            &quot;banjo&quot;},</a>
<a name="ln84">            {&quot;bnj6&quot;,            &quot;banjo&quot;},</a>
<a name="ln85">            {&quot;bongo&quot;,           &quot;bongos&quot;},</a>
<a name="ln86">            {&quot;brthns&quot;,          &quot;baritone-horn&quot;},</a>
<a name="ln87">            {&quot;brtn-c&quot;,          &quot;baritone&quot;},</a>
<a name="ln88">            {&quot;brtn-s&quot;,          &quot;baritone&quot;},</a>
<a name="ln89">            {&quot;cbs&quot;,             &quot;cabasa&quot;},</a>
<a name="ln90">            {&quot;cello&quot;,           &quot;violoncello&quot;},</a>
<a name="ln91">            {&quot;china&quot;,           &quot;chinese-tom-toms&quot;},</a>
<a name="ln92">            {&quot;clrnt-a&quot;,         &quot;a-clarinet&quot;},</a>
<a name="ln93">            {&quot;clrnt-bb-bass&quot;,   &quot;bass-clarinet&quot;},</a>
<a name="ln94">            {&quot;clrnt-bb&quot;,        &quot;bb-clarinet&quot;},</a>
<a name="ln95">            {&quot;clrnt-c&quot;,         &quot;c-clarinet&quot;},</a>
<a name="ln96">            {&quot;clrnt-d&quot;,         &quot;d-clarinet&quot;},</a>
<a name="ln97">            {&quot;clrnt-eb&quot;,        &quot;eb-clarinet&quot;},</a>
<a name="ln98">            {&quot;clrnt&quot;,           &quot;clarinet&quot;},</a>
<a name="ln99">            {&quot;clst-gs&quot;,         &quot;celesta&quot;},</a>
<a name="ln100">            {&quot;clst-ss&quot;,         &quot;celesta&quot;},</a>
<a name="ln101">            {&quot;clvs&quot;,            &quot;claves&quot;},</a>
<a name="ln102">            {&quot;cngKit&quot;,          &quot;congas&quot;},</a>
<a name="ln103">            {&quot;conga&quot;,           &quot;congas&quot;},</a>
<a name="ln104">            {&quot;cowbell&quot;,         &quot;cowbell&quot;},</a>
<a name="ln105">            {&quot;crash&quot;,           &quot;crash-cymbal&quot;},</a>
<a name="ln106">            {&quot;cstnt&quot;,           &quot;castanets&quot;},</a>
<a name="ln107">            {&quot;ctbassn&quot;,         &quot;contrabassoon&quot;},</a>
<a name="ln108">            {&quot;ctbass&quot;,          &quot;contrabass&quot;},</a>
<a name="ln109">            {&quot;cuicaKit&quot;,        &quot;cuica&quot;},</a>
<a name="ln110">            {&quot;cuica&quot;,           &quot;cuica&quot;},</a>
<a name="ln111">            {&quot;drmkt&quot;,           &quot;drumset&quot;},</a>
<a name="ln112">            {&quot;e-bass4&quot;,         &quot;bass-guitar&quot;},</a>
<a name="ln113">            {&quot;e-bass5&quot;,         &quot;bass-guitar&quot;},</a>
<a name="ln114">            {&quot;e-bass6&quot;,         &quot;bass-guitar&quot;},</a>
<a name="ln115">            {&quot;e-gtr12&quot;,         &quot;electric-guitar-treble-clef&quot;},</a>
<a name="ln116">            {&quot;e-gtr6&quot;,          &quot;electric-guitar-treble-clef&quot;},</a>
<a name="ln117">            {&quot;e-gtr7&quot;,          &quot;electric-guitar-treble-clef&quot;},</a>
<a name="ln118">            {&quot;e-gtr8&quot;,          &quot;electric-guitar-treble-clef&quot;},</a>
<a name="ln119">            {&quot;em-organ-gs&quot;,     &quot;organ&quot;},</a>
<a name="ln120">            {&quot;em-organ-ss&quot;,     &quot;organ&quot;},</a>
<a name="ln121">            {&quot;en-horn&quot;,         &quot;english-horn&quot;},</a>
<a name="ln122">            {&quot;e-piano-gs&quot;,      &quot;electric-piano&quot;},</a>
<a name="ln123">            {&quot;e-piano-ss&quot;,      &quot;electric-piano&quot;},</a>
<a name="ln124">            {&quot;flt-c&quot;,           &quot;flute&quot;},</a>
<a name="ln125">            {&quot;flt-g&quot;,           &quot;alto-flute&quot;},</a>
<a name="ln126">            {&quot;flt-whstl&quot;,       &quot;tin-whistle&quot;},</a>
<a name="ln127">            {&quot;fr-horn&quot;,         &quot;horn&quot;},</a>
<a name="ln128">            {&quot;grcss&quot;,           &quot;bass-drum&quot;},   //grancassa is an alterantive name for bass drum</a>
<a name="ln129">            {&quot;guiro&quot;,           &quot;guiro&quot;},</a>
<a name="ln130">            {&quot;harp-gs&quot;,         &quot;harp&quot;},</a>
<a name="ln131">            {&quot;harp-ss&quot;,         &quot;harp&quot;},</a>
<a name="ln132">            {&quot;hclap&quot;,           &quot;hand-clap&quot;},</a>
<a name="ln133">            {&quot;hihat&quot;,           &quot;hi-hat&quot;},</a>
<a name="ln134">            {&quot;hrpch-gs&quot;,        &quot;harpsichord&quot;},</a>
<a name="ln135">            {&quot;hrpch-ss&quot;,        &quot;harpsichord&quot;},</a>
<a name="ln136">            {&quot;jngl-bell&quot;,       &quot;sleigh-bells&quot;},</a>
<a name="ln137">            {&quot;klmb&quot;,            &quot;kalimba&quot;},</a>
<a name="ln138">            {&quot;mrcs&quot;,            &quot;maracas&quot;},</a>
<a name="ln139">            {&quot;n-gtr6&quot;,          &quot;guitar-nylon-treble-clef&quot;},</a>
<a name="ln140">            {&quot;n-gtr7&quot;,          &quot;guitar-nylon-treble-clef&quot;},</a>
<a name="ln141">            {&quot;n-gtr8&quot;,          &quot;guitar-nylon-treble-clef&quot;},</a>
<a name="ln142">            {&quot;oboe&quot;,            &quot;oboe&quot;},</a>
<a name="ln143">            {&quot;ocrn&quot;,            &quot;ocarina&quot;},</a>
<a name="ln144">            {&quot;pccl&quot;,            &quot;piccolo&quot;},</a>
<a name="ln145">            {&quot;pedalhihat&quot;,      &quot;hi-hat&quot;},</a>
<a name="ln146">            {&quot;pnflt&quot;,           &quot;pan-flute&quot;},</a>
<a name="ln147">            {&quot;ptt&quot;,             &quot;cymbal&quot;},  //piatti is cymbal in italian</a>
<a name="ln148">            {&quot;rec&quot;,             &quot;recorder&quot;},</a>
<a name="ln149">            {&quot;ride&quot;,            &quot;ride-cymbal&quot;},</a>
<a name="ln150">            {&quot;rvs-cymb&quot;,        &quot;cymbal&quot;},</a>
<a name="ln151">            {&quot;sax-alt-eb&quot;,      &quot;alto-saxophone&quot;},</a>
<a name="ln152">            {&quot;sax-bar-eb&quot;,      &quot;baritone-saxophone&quot;},</a>
<a name="ln153">            {&quot;sax-bass-eb&quot;,     &quot;bass-saxophone&quot;},</a>
<a name="ln154">            {&quot;sax-ms-f&quot;,        &quot;mezzo-soprano-saxophone&quot;},</a>
<a name="ln155">            {&quot;sax-sop-bb&quot;,      &quot;soprano-saxophone&quot;},</a>
<a name="ln156">            {&quot;sax-ten-bb&quot;,      &quot;tenor-saxophone&quot;},</a>
<a name="ln157">            {&quot;sax-ten-c&quot;,       &quot;melody-saxophone&quot;},</a>
<a name="ln158">            {&quot;s-bass4&quot;,         &quot;electric-bass&quot;},</a>
<a name="ln159">            {&quot;s-bass5&quot;,         &quot;5-string-electric-bass&quot;},</a>
<a name="ln160">            {&quot;s-gtr12&quot;,         &quot;guitar-steel-treble-clef&quot;},</a>
<a name="ln161">            {&quot;s-gtr6&quot;,          &quot;guitar-steel-treble-clef&quot;},</a>
<a name="ln162">            {&quot;s-gtr7&quot;,          &quot;guitar-steel-treble-clef&quot;},</a>
<a name="ln163">            {&quot;s-gtr8&quot;,          &quot;guitar-steel-treble-clef&quot;},</a>
<a name="ln164">            {&quot;shkr&quot;,            &quot;percussion&quot;},</a>
<a name="ln165">            {&quot;shmsn&quot;,           &quot;shamisen&quot;},</a>
<a name="ln166">            {&quot;shn&quot;,             &quot;sheng&quot;},</a>
<a name="ln167">            {&quot;snare&quot;,           &quot;snare-drum&quot;},</a>
<a name="ln168">            {&quot;snr&quot;,             &quot;snare-drum&quot;},</a>
<a name="ln169">            {&quot;snt-brass-gs&quot;,    &quot;brass-synthesizer&quot;},</a>
<a name="ln170">            {&quot;snt-brass-ss&quot;,    &quot;brass-synthesizer&quot;},</a>
<a name="ln171">            //{&quot;snt-key-gs&quot;,    &quot;&quot;},</a>
<a name="ln172">            //{&quot;snt-key-ss&quot;,    &quot;&quot;},</a>
<a name="ln173">            //{&quot;snt-seq-gs&quot;,    &quot;&quot;},</a>
<a name="ln174">            //{&quot;snt-seq-ss&quot;,    &quot;&quot;},</a>
<a name="ln175">            {&quot;snt-lead-gs&quot;,     &quot;poly-synth&quot;},</a>
<a name="ln176">            {&quot;snt-lead-ss&quot;,     &quot;poly-synth&quot;},</a>
<a name="ln177">            {&quot;snt-pad&quot;,         &quot;pad-synth&quot;},</a>
<a name="ln178">            {&quot;snt-pad-gs&quot;,      &quot;pad-synth&quot;},</a>
<a name="ln179">            {&quot;snt-pad-ss&quot;,      &quot;pad-synth&quot;},</a>
<a name="ln180">            {&quot;splash&quot;,          &quot;splash-cymbal&quot;},</a>
<a name="ln181">            {&quot;sprn-c&quot;,          &quot;soprano&quot;},</a>
<a name="ln182">            {&quot;sprn-s&quot;,          &quot;soprano&quot;},</a>
<a name="ln183">            {&quot;tmbrn&quot;,           &quot;tambourine&quot;}, // to be mapped</a>
<a name="ln184">            {&quot;Tambourine-Perc&quot;, &quot;tambourine&quot;},</a>
<a name="ln185">            {&quot;Tambourine&quot;,      &quot;tambourine&quot;},</a>
<a name="ln186">            {&quot;tmblKit&quot;,         &quot;timbales&quot;},</a>
<a name="ln187">            {&quot;tmbl&quot;,            &quot;timbales&quot;},</a>
<a name="ln188">            {&quot;tmpn&quot;,            &quot;timpani&quot;},</a>
<a name="ln189">            {&quot;tnklbll&quot;,         &quot;tubular-bells&quot;}, //The short form does not match but this is very likely due to the description</a>
<a name="ln190">            {&quot;tnr-c&quot;,           &quot;tenor&quot;},</a>
<a name="ln191">            {&quot;tnr-s&quot;,           &quot;tenor&quot;},</a>
<a name="ln192">            {&quot;Triangle-Percu&quot;,  &quot;triangle&quot;},</a>
<a name="ln193">            {&quot;trmbn-bb-bass&quot;,   &quot;bass-trombone&quot;},</a>
<a name="ln194">            {&quot;trmbn-bb&quot;,        &quot;tenor-trombone&quot;},</a>
<a name="ln195">            {&quot;trmbn-bb-treble&quot;, &quot;trombone-treble&quot;},</a>
<a name="ln196">            {&quot;trmbn-eb&quot;,        &quot;alto-trombone&quot;},</a>
<a name="ln197">            {&quot;trmpt-a&quot;,         &quot;a-trumpet&quot;},</a>
<a name="ln198">            {&quot;trmpt-bb&quot;,        &quot;bb-trumpet&quot;},</a>
<a name="ln199">            {&quot;trmpt-c-bass&quot;,    &quot;c-bass-trumpet&quot;},</a>
<a name="ln200">            {&quot;trmpt-c&quot;,         &quot;c-trumpet&quot;},</a>
<a name="ln201">            {&quot;trmpt-d&quot;,         &quot;d-trumpet&quot;},</a>
<a name="ln202">            {&quot;trmpt-eb-bass&quot;,   &quot;eb-bass-trumpet&quot;},</a>
<a name="ln203">            {&quot;trmpt-eb&quot;,        &quot;eb-trumpet&quot;},</a>
<a name="ln204">            {&quot;trmpt-e&quot;,         &quot;e-trumpet&quot;},</a>
<a name="ln205">            {&quot;trmpt-f&quot;,         &quot;f-trumpet&quot;},</a>
<a name="ln206">            {&quot;trmpt-flgh&quot;,      &quot;flugelhorn&quot;},</a>
<a name="ln207">            {&quot;trngl&quot;,           &quot;triangle&quot;},</a>
<a name="ln208">            {&quot;ukll4&quot;,           &quot;ukulele&quot;},</a>
<a name="ln209">            {&quot;vbrphn&quot;,          &quot;vibraphone&quot;},</a>
<a name="ln210">            {&quot;vbrslp&quot;,          &quot;vibraslap&quot;}, // to be mapped</a>
<a name="ln211">            {&quot;vla&quot;,             &quot;viola&quot;},</a>
<a name="ln212">            {&quot;vln&quot;,             &quot;violin&quot;},</a>
<a name="ln213">            {&quot;wdblckKit&quot;,       &quot;wood-blocks&quot;},</a>
<a name="ln214">            {&quot;wdblck&quot;,          &quot;wood-blocks&quot;},</a>
<a name="ln215">            {&quot;whstlKit&quot;,        &quot;slide-whistle&quot;},</a>
<a name="ln216">            {&quot;whstl&quot;,           &quot;tin-whistle&quot;},</a>
<a name="ln217">            {&quot;xlphn&quot;,           &quot;xylophone&quot;}</a>
<a name="ln218">            };</a>
<a name="ln219"> </a>
<a name="ln220">//---------------------------------------------------------</a>
<a name="ln221">//   readBit</a>
<a name="ln222">//---------------------------------------------------------</a>
<a name="ln223"> </a>
<a name="ln224">int GuitarPro6::readBit(QByteArray* buffer)</a>
<a name="ln225">      {</a>
<a name="ln226">      // calculate the byte index by dividing the position in bits by the bits per byte</a>
<a name="ln227">      int byteIndex = position / BITS_IN_BYTE;</a>
<a name="ln228"> </a>
<a name="ln229">      // calculate our offset so we know how much to bit shift</a>
<a name="ln230">      int byteOffset = ((BITS_IN_BYTE - 1) - (position % BITS_IN_BYTE));</a>
<a name="ln231"> </a>
<a name="ln232">      // calculate the bit which we want to read</a>
<a name="ln233">      int bit = ((((*buffer)[byteIndex] &amp; 0xff) &gt;&gt; byteOffset) &amp; 0x01);</a>
<a name="ln234"> </a>
<a name="ln235">      // increment our current position so we know this bit has been read</a>
<a name="ln236">      position++;</a>
<a name="ln237">      return bit;       // return the bit we calculated</a>
<a name="ln238">      }</a>
<a name="ln239"> </a>
<a name="ln240">//---------------------------------------------------------</a>
<a name="ln241">//   readBits</a>
<a name="ln242">//---------------------------------------------------------</a>
<a name="ln243"> </a>
<a name="ln244">int GuitarPro6::readBits(QByteArray* buffer, int bitsToRead)</a>
<a name="ln245">      {</a>
<a name="ln246">      int bits = 0;</a>
<a name="ln247">      for (int i = (bitsToRead - 1); i &gt;= 0; i--)</a>
<a name="ln248">            bits |= (readBit(buffer) &lt;&lt; i);</a>
<a name="ln249">      return bits;</a>
<a name="ln250">      }</a>
<a name="ln251"> </a>
<a name="ln252">//---------------------------------------------------------</a>
<a name="ln253">//   readBitsReversed</a>
<a name="ln254">//---------------------------------------------------------</a>
<a name="ln255"> </a>
<a name="ln256">int GuitarPro6::readBitsReversed(QByteArray* buffer, int bitsToRead)</a>
<a name="ln257">      {</a>
<a name="ln258">      int bits = 0;</a>
<a name="ln259">      for( int i = 0; i &lt; bitsToRead; i++)</a>
<a name="ln260">            bits |= readBit(buffer) &lt;&lt; i;</a>
<a name="ln261">      return bits;</a>
<a name="ln262">      }</a>
<a name="ln263"> </a>
<a name="ln264">//---------------------------------------------------------</a>
<a name="ln265">//   getBytes</a>
<a name="ln266">//---------------------------------------------------------</a>
<a name="ln267"> </a>
<a name="ln268">QByteArray GuitarPro6::getBytes(QByteArray* buffer, int offset, int length)</a>
<a name="ln269">      {</a>
<a name="ln270">      QByteArray newBytes;</a>
<a name="ln271">      // compute new bytes from our buffer and return byte array</a>
<a name="ln272">      for (int i = 0; i &lt; length; i++) {</a>
<a name="ln273">            if (buffer-&gt;length() &gt; offset + i)</a>
<a name="ln274">                  newBytes.insert(i, ((*buffer)[offset + i]));</a>
<a name="ln275">            }</a>
<a name="ln276">      return newBytes;</a>
<a name="ln277">      }</a>
<a name="ln278"> </a>
<a name="ln279">//---------------------------------------------------------</a>
<a name="ln280">//   readInteger</a>
<a name="ln281">//---------------------------------------------------------</a>
<a name="ln282"> </a>
<a name="ln283">int GuitarPro6::readInteger(QByteArray* buffer, int offset)</a>
<a name="ln284">      {</a>
<a name="ln285">      // assign four bytes and take them from the buffer</a>
<a name="ln286">      char bytes[4];</a>
<a name="ln287">      bytes[0] = (*buffer)[offset + 0];</a>
<a name="ln288">      bytes[1] = (*buffer)[offset + 1];</a>
<a name="ln289">      bytes[2] = (*buffer)[offset + 2];</a>
<a name="ln290">      bytes[3] = (*buffer)[offset + 3];</a>
<a name="ln291">      // increment positioning so we keep track of where we are</a>
<a name="ln292">      position += sizeof(int) * BITS_IN_BYTE;</a>
<a name="ln293">      // bit shift in order to compute our integer value and return</a>
<a name="ln294">      return ((bytes[3] &amp; 0xff) &lt;&lt; 24) | ((bytes[2] &amp; 0xff) &lt;&lt; 16) | ((bytes[1] &amp; 0xff) &lt;&lt; 8) | (bytes[0] &amp; 0xff);</a>
<a name="ln295">      }</a>
<a name="ln296"> </a>
<a name="ln297">//---------------------------------------------------------</a>
<a name="ln298">//   readString</a>
<a name="ln299">//---------------------------------------------------------</a>
<a name="ln300"> </a>
<a name="ln301">QByteArray GuitarPro6::readString(QByteArray* buffer, int offset, int length)</a>
<a name="ln302">      {</a>
<a name="ln303">      QByteArray filename;</a>
<a name="ln304">      // compute the string by iterating through the buffer</a>
<a name="ln305">      for (int i = 0; i &lt; length; i++) {</a>
<a name="ln306">            int charValue = (((*buffer)[offset + i]) &amp; 0xff);</a>
<a name="ln307">            if (charValue == 0)</a>
<a name="ln308">                  break;</a>
<a name="ln309">            filename.push_back((char)charValue);</a>
<a name="ln310">            }</a>
<a name="ln311">      return filename;</a>
<a name="ln312">      }</a>
<a name="ln313"> </a>
<a name="ln314"> </a>
<a name="ln315">//---------------------------------------------------------</a>
<a name="ln316">//   unhandledNode</a>
<a name="ln317">//---------------------------------------------------------</a>
<a name="ln318"> </a>
<a name="ln319">void GuitarPro6::unhandledNode(QString nodeName)</a>
<a name="ln320">      {</a>
<a name="ln321">      qDebug() &lt;&lt; &quot;WARNING: Discovered unhandled node name&quot; &lt;&lt; nodeName;</a>
<a name="ln322">      }</a>
<a name="ln323"> </a>
<a name="ln324">//---------------------------------------------------------</a>
<a name="ln325">//   readScore</a>
<a name="ln326">//---------------------------------------------------------</a>
<a name="ln327"> </a>
<a name="ln328">void GuitarPro6::readScore(QDomNode* scoreNode)</a>
<a name="ln329">      {</a>
<a name="ln330">      // loop through the score meta-info, grabbing title, artist, etc</a>
<a name="ln331">      QDomNode currentNode = scoreNode-&gt;firstChild();</a>
<a name="ln332">      while (!currentNode.isNull()) {</a>
<a name="ln333">            QString nodeName = currentNode.nodeName();</a>
<a name="ln334">            if (!nodeName.compare(&quot;Title&quot;))</a>
<a name="ln335">                  title = currentNode.toElement().text();</a>
<a name="ln336">            if (!nodeName.compare(&quot;Copyright&quot;))</a>
<a name="ln337">                  score-&gt;setMetaTag(&quot;copyright&quot;, currentNode.toElement().text());</a>
<a name="ln338">            else if (!nodeName.compare(&quot;SubTitle&quot;))</a>
<a name="ln339">                  subtitle = currentNode.toElement().text();</a>
<a name="ln340">            else if (!nodeName.compare(&quot;Artist&quot;))</a>
<a name="ln341">                  artist = currentNode.toElement().text();</a>
<a name="ln342">            else if (!nodeName.compare(&quot;Album&quot;))</a>
<a name="ln343">                  album = currentNode.toElement().text();</a>
<a name="ln344">            else if (nodeName == &quot;FirstPageHeader&quot;) {}</a>
<a name="ln345">            else if (nodeName == &quot;FirstPageFooter&quot;) {}</a>
<a name="ln346">            else if (nodeName == &quot;PageHeader&quot;) {}</a>
<a name="ln347">            else if (nodeName == &quot;PageFooter&quot;) {}</a>
<a name="ln348">            else if (nodeName == &quot;ScoreSystemsDefaultLayout&quot;) {}</a>
<a name="ln349">            else if (nodeName == &quot;ScoreSystemsLayout&quot;) {}</a>
<a name="ln350">            currentNode = currentNode.nextSibling();</a>
<a name="ln351">            }</a>
<a name="ln352">      }</a>
<a name="ln353"> </a>
<a name="ln354">//---------------------------------------------------------</a>
<a name="ln355">//   readMasterTracks</a>
<a name="ln356">//---------------------------------------------------------</a>
<a name="ln357"> </a>
<a name="ln358">void GuitarPro6::readMasterTracks(QDomNode* masterTrack)</a>
<a name="ln359">      {</a>
<a name="ln360">      // inspects MasterTrack, gives information applying to start of score such as tempo</a>
<a name="ln361">      QDomNode currentNode = masterTrack-&gt;firstChild();</a>
<a name="ln362">      while (!currentNode.isNull()) {</a>
<a name="ln363">            QString nodeName = currentNode.nodeName();</a>
<a name="ln364">            if (!nodeName.compare(&quot;Automations&quot;)) {</a>
<a name="ln365">                  QDomNode currentAutomation = currentNode.firstChild();</a>
<a name="ln366">                  bool linearTemp { false };</a>
<a name="ln367">                  while (!currentAutomation.isNull()) {</a>
<a name="ln368">                        if (!currentAutomation.nodeName().compare(&quot;Automation&quot;)) {</a>
<a name="ln369">                              auto ln = currentAutomation.firstChildElement(&quot;Linear&quot;);</a>
<a name="ln370">                              if (!ln.isNull())</a>
<a name="ln371">                                    linearTemp = ln.text() == &quot;true&quot;;</a>
<a name="ln372">                              auto first_name = currentAutomation.firstChild().nodeName();</a>
<a name="ln373">                              if (first_name == &quot;Type&quot;)</a>
<a name="ln374">                                    first_name = currentAutomation.firstChild().toElement().text();</a>
<a name="ln375">                              if (!first_name.compare(&quot;Tempo&quot;)) {</a>
<a name="ln376">                                    QString t = currentAutomation.lastChild().toElement().text();</a>
<a name="ln377">                                    QStringList sa = t.split(&quot; &quot;);</a>
<a name="ln378">                                    int curtempo = 120;</a>
<a name="ln379">                                    if (sa.length() &gt;= 1)</a>
<a name="ln380">                                          curtempo = sa[0].toInt();</a>
<a name="ln381">                                    auto barnode = currentAutomation.firstChildElement(&quot;Bar&quot;);</a>
<a name="ln382">                                    if (!barnode.isNull()) {</a>
<a name="ln383">                                          tempoMap[barnode.text().toInt()] = make_pair(curtempo, linearTemp);</a>
<a name="ln384">                                          }</a>
<a name="ln385">                                    }</a>
<a name="ln386">                              }</a>
<a name="ln387">                        currentAutomation = currentAutomation.nextSibling();</a>
<a name="ln388">                        }</a>
<a name="ln389">                  }</a>
<a name="ln390">            currentNode = currentNode.nextSibling();</a>
<a name="ln391">            }</a>
<a name="ln392">      }</a>
<a name="ln393"> </a>
<a name="ln394">//---------------------------------------------------------</a>
<a name="ln395">//   readChord</a>
<a name="ln396">//---------------------------------------------------------</a>
<a name="ln397"> </a>
<a name="ln398">void GuitarPro6::readChord(QDomNode* diagram, int track)</a>
<a name="ln399">      {</a>
<a name="ln400">      // initialize a new fret diagram for our current track</a>
<a name="ln401">      FretDiagram* fretDiagram = new FretDiagram(score);</a>
<a name="ln402">      fretDiagram-&gt;setTrack(track);</a>
<a name="ln403"> </a>
<a name="ln404">      // get the identifier to set as the domain in the map</a>
<a name="ln405">      int id    = diagram-&gt;attributes().namedItem(&quot;id&quot;).toAttr().value().toInt();</a>
<a name="ln406">      auto name = diagram-&gt;attributes().namedItem(&quot;name&quot;).toAttr().value();</a>
<a name="ln407"> </a>
<a name="ln408">//TODO-ws      fretDiagram-&gt;setChordName(name);</a>
<a name="ln409">      QDomNode diagramNode = diagram-&gt;firstChild();</a>
<a name="ln410"> </a>
<a name="ln411">      // set the number of strings on this part</a>
<a name="ln412">      int stringCount = diagramNode.attributes().namedItem(&quot;stringCount&quot;).toAttr().value().toInt();</a>
<a name="ln413">      fretDiagram-&gt;setStrings(stringCount);</a>
<a name="ln414"> </a>
<a name="ln415">      // set the fret offset</a>
<a name="ln416">      int baseFret = diagramNode.attributes().namedItem(&quot;baseFret&quot;).toAttr().value().toInt();</a>
<a name="ln417">      fretDiagram-&gt;setFretOffset(baseFret);</a>
<a name="ln418"> </a>
<a name="ln419">      QDomNode diagramEntity = diagramNode.firstChild();</a>
<a name="ln420">      int counter            = 0;</a>
<a name="ln421">      while (!diagramEntity.isNull()) {</a>
<a name="ln422">            QString nodeName = diagramEntity.nodeName();</a>
<a name="ln423">            // new fret</a>
<a name="ln424">            if (!nodeName.compare(&quot;Fret&quot;)) {</a>
<a name="ln425">                  // get the string and fret numbers from the arguments to the node as integers</a>
<a name="ln426">                  int string = diagramEntity.attributes().namedItem(&quot;string&quot;).toAttr().value().toInt();</a>
<a name="ln427">                  int fret   = diagramEntity.attributes().namedItem(&quot;fret&quot;).toAttr().value().toInt();</a>
<a name="ln428"> </a>
<a name="ln429">                  // if there are unspecified string values, add the X marker to that string</a>
<a name="ln430">                  while (counter &lt; string) {</a>
<a name="ln431">                        fretDiagram-&gt;setMarker(counter, FretMarkerType::CROSS);</a>
<a name="ln432">                        counter++;</a>
<a name="ln433">                        }</a>
<a name="ln434"> </a>
<a name="ln435">                  // look at the specified string/fret and add to diagram</a>
<a name="ln436">                  if (fret == 0) {</a>
<a name="ln437">                        fretDiagram-&gt;setMarker(string, FretMarkerType::CIRCLE);</a>
<a name="ln438">                        counter++;</a>
<a name="ln439">                        }</a>
<a name="ln440">                  else {</a>
<a name="ln441">                        fretDiagram-&gt;setDot(string, fret, true);</a>
<a name="ln442">                        counter++;</a>
<a name="ln443">                        }</a>
<a name="ln444">                  }</a>
<a name="ln445">            // move to the next string/fret specification</a>
<a name="ln446">            diagramEntity = diagramEntity.nextSibling();</a>
<a name="ln447">            }</a>
<a name="ln448"> </a>
<a name="ln449">      // mark any missing strings as 'X'</a>
<a name="ln450">      while (counter &lt; stringCount) {</a>
<a name="ln451">            fretDiagram-&gt;setMarker(counter, FretMarkerType::CROSS);</a>
<a name="ln452">            counter++;</a>
<a name="ln453">            }</a>
<a name="ln454"> </a>
<a name="ln455">      // insert the fret diagram into the map of diagrams</a>
<a name="ln456">      fretDiagrams.insert(id, fretDiagram);</a>
<a name="ln457">      }</a>
<a name="ln458"> </a>
<a name="ln459">//---------------------------------------------------------</a>
<a name="ln460">//   readTracks</a>
<a name="ln461">//---------------------------------------------------------</a>
<a name="ln462"> </a>
<a name="ln463">void GuitarPro6::readTracks(QDomNode* track)</a>
<a name="ln464">      {</a>
<a name="ln465">      QDomNode nextTrack = track-&gt;firstChild();</a>
<a name="ln466">      int trackCounter   = 0;</a>
<a name="ln467">      while (!nextTrack.isNull()) {</a>
<a name="ln468">            QDomNode currentNode = nextTrack.firstChild();</a>
<a name="ln469">            Part* part           = new Part(score);</a>
<a name="ln470">            bool hasTuning       = false;</a>
<a name="ln471">            Staff* s             = new Staff(score);</a>
<a name="ln472">            s-&gt;setPart(part);</a>
<a name="ln473">            part-&gt;insertStaff(s, -1);</a>
<a name="ln474">            score-&gt;staves().push_back(s);</a>
<a name="ln475">            while (!currentNode.isNull()) {</a>
<a name="ln476">                  QString nodeName = currentNode.nodeName();</a>
<a name="ln477">                  if (nodeName == &quot;Name&quot;)</a>
<a name="ln478">                        part-&gt;setPlainLongName(currentNode.toElement().text());</a>
<a name="ln479">                  else if (nodeName == &quot;Color&quot;) {}</a>
<a name="ln480">                  // this is a typo is guitar pro - 'defaut' is correct here</a>
<a name="ln481">                  else if (nodeName == &quot;SystemsDefautLayout&quot;) {}</a>
<a name="ln482">                  else if (nodeName == &quot;SystemsLayout&quot;) {}</a>
<a name="ln483">                  else if (nodeName == &quot;RSE&quot;) {}</a>
<a name="ln484">                  else if (nodeName == &quot;GeneralMidi&quot;) {</a>
<a name="ln485">                        if (currentNode.toElement().hasChildNodes()) {</a>
<a name="ln486">                              auto prog = currentNode.firstChildElement(&quot;Program&quot;);</a>
<a name="ln487">                              if (!prog.isNull()) {</a>
<a name="ln488">                                    auto p = prog.text().toInt();</a>
<a name="ln489">                                    part-&gt;instrument(Fraction(0,1))-&gt;channel(0)-&gt;setProgram(p);</a>
<a name="ln490">                                    }</a>
<a name="ln491">                              int midiChannel = currentNode.firstChildElement(&quot;PrimaryChannel&quot;).text().toInt();</a>
<a name="ln492">                              //if (!prog.isNull() &amp;&amp; midiChannel != GP_DEFAULT_PERCUSSION_CHANNEL)</a>
<a name="ln493">                              // midiChannel += prog.text().toInt();</a>
<a name="ln494">                              part-&gt;setMidiChannel(midiChannel);</a>
<a name="ln495">                              if (midiChannel == GP_DEFAULT_PERCUSSION_CHANNEL) {</a>
<a name="ln496">                                    part-&gt;instrument()-&gt;setDrumset(gpDrumset);</a>
<a name="ln497">                                    s-&gt;setStaffType(Fraction(0,1), *StaffType::preset(StaffTypes::PERC_DEFAULT));</a>
<a name="ln498">                                    }</a>
<a name="ln499">                              }</a>
<a name="ln500">                        }</a>
<a name="ln501">                  else if (nodeName == &quot;PlaybackState&quot;) {}</a>
<a name="ln502">                  else if (nodeName == &quot;PlayingStyle&quot;) {}</a>
<a name="ln503">                  else if (nodeName == &quot;PageSetup&quot;) {}</a>
<a name="ln504">                  else if (nodeName == &quot;MultiVoice&quot;) {}</a>
<a name="ln505">                  else if (nodeName == &quot;ShortName&quot;)</a>
<a name="ln506">                        part-&gt;setPartName(currentNode.toElement().text());</a>
<a name="ln507">                  else if (nodeName == &quot;Instrument&quot;) {</a>
<a name="ln508">                        QString ref = currentNode.attributes().namedItem(&quot;ref&quot;).toAttr().value();</a>
<a name="ln509">                        auto it     = instrumentMapping.find(ref);</a>
<a name="ln510">                        if (it != instrumentMapping.end()) {</a>
<a name="ln511">                              part-&gt;setInstrument(Instrument::fromTemplate(Ms::searchTemplate(it-&gt;second)));</a>
<a name="ln512">                              }</a>
<a name="ln513">                        else</a>
<a name="ln514">                              qDebug() &lt;&lt; &quot;Unknown instrument: &quot; &lt;&lt; ref;</a>
<a name="ln515">                        if (ref.endsWith(&quot;-gs&quot;) || ref.startsWith(&quot;2&quot;)) { // grand staff</a>
<a name="ln516">                              Staff* s2 = new Staff(score);</a>
<a name="ln517">                              s2-&gt;setPart(part);</a>
<a name="ln518">                              part-&gt;insertStaff(s2, -1);</a>
<a name="ln519">                              score-&gt;staves().push_back(s2);</a>
<a name="ln520">                              s-&gt;addBracket(new BracketItem(s-&gt;score(), BracketType::BRACE, 2));</a>
<a name="ln521">                              s-&gt;setBarLineSpan(2);</a>
<a name="ln522">                              }</a>
<a name="ln523">                        }</a>
<a name="ln524">                  else if (nodeName == &quot;Properties&quot;) {</a>
<a name="ln525">                        QDomNode currentProperty = currentNode.firstChild();</a>
<a name="ln526">                        while (!currentProperty.isNull()) {</a>
<a name="ln527">                              QString propertyName = currentProperty.attributes().namedItem(&quot;name&quot;).toAttr().value();</a>
<a name="ln528">                              if (!propertyName.compare(&quot;Tuning&quot;)) {</a>
<a name="ln529">                                    // set up the tuning for the part</a>
<a name="ln530">                                    QString tuningString         = currentProperty.firstChild().toElement().text();</a>
<a name="ln531">                                    QStringList tuningStringList = tuningString.split(&quot; &quot;);</a>
<a name="ln532">                                    int strings                  = 0;</a>
<a name="ln533">                                    std::vector&lt;int&gt; tuning(tuningStringList.length());</a>
<a name="ln534">                                    //int tuning[tuningStringList.length()];</a>
<a name="ln535">                                    int frets = 24;</a>
<a name="ln536">                                    for (auto iter = tuningStringList.begin(); iter != tuningStringList.end(); ++iter) {</a>
<a name="ln537">                                          int currentString = (*iter).toInt();</a>
<a name="ln538">                                          tuning[strings] = currentString;</a>
<a name="ln539">                                          strings++;</a>
<a name="ln540">                                          }</a>
<a name="ln541">                                    StringData* stringData = new StringData(frets, strings, &amp;tuning[0]);</a>
<a name="ln542">                                    Instrument* instr      = part-&gt;instrument();</a>
<a name="ln543">                                    instr-&gt;setStringData(*stringData);</a>
<a name="ln544">                                    instr-&gt;setSingleNoteDynamics(false);</a>
<a name="ln545">                                    hasTuning = true;</a>
<a name="ln546">                                    createTuningString(strings, &amp;tuning[0]);</a>
<a name="ln547">                                    }</a>
<a name="ln548">                              else if (!propertyName.compare(&quot;DiagramCollection&quot;)) {</a>
<a name="ln549">                                    QDomNode items       = currentProperty.firstChild();</a>
<a name="ln550">                                    QDomNode currentItem = items.firstChild();</a>
<a name="ln551">                                    while (!currentItem.isNull()) {</a>
<a name="ln552">                                          readChord(&amp;currentItem, trackCounter);</a>
<a name="ln553">                                          currentItem = currentItem.nextSibling();</a>
<a name="ln554">                                          }</a>
<a name="ln555">                                    }</a>
<a name="ln556">                              currentProperty = currentProperty.nextSibling();</a>
<a name="ln557">                              }</a>
<a name="ln558">                        }</a>
<a name="ln559">                  currentNode = currentNode.nextSibling();</a>
<a name="ln560">                  }</a>
<a name="ln561"> </a>
<a name="ln562">            // add in a new part</a>
<a name="ln563">            score-&gt;appendPart(part);</a>
<a name="ln564">            trackCounter++;</a>
<a name="ln565">            nextTrack = nextTrack.nextSibling();</a>
<a name="ln566"> </a>
<a name="ln567">            if (!hasTuning) {</a>
<a name="ln568">                  tunings.push_back(&quot;&quot;);</a>
<a name="ln569">                  }</a>
<a name="ln570">            }</a>
<a name="ln571"> </a>
<a name="ln572">      previousDynamic = new int[score-&gt;staves().length() * VOICES];</a>
<a name="ln573">      // initialise the dynamics to 0</a>
<a name="ln574">      for (int i = 0; i &lt; score-&gt;staves().length() * VOICES; i++)</a>
<a name="ln575">            previousDynamic[i] = 0;</a>
<a name="ln576">      // set the number of staves we need</a>
<a name="ln577">      staves = score-&gt;staves().length();</a>
<a name="ln578">      }</a>
<a name="ln579"> </a>
<a name="ln580">//---------------------------------------------------------</a>
<a name="ln581">//   getNode</a>
<a name="ln582">//---------------------------------------------------------</a>
<a name="ln583"> </a>
<a name="ln584">QDomNode GuitarPro6::getNode(const QString&amp; id, QDomNode currentDomNode)</a>
<a name="ln585">      {</a>
<a name="ln586">      while (!(currentDomNode).isNull()) {</a>
<a name="ln587">            QString currentId = currentDomNode.attributes().namedItem(&quot;id&quot;).toAttr().value();</a>
<a name="ln588">            if (id.compare(currentId) == 0) {</a>
<a name="ln589">                  return currentDomNode;</a>
<a name="ln590">                  }</a>
<a name="ln591">            currentDomNode = currentDomNode.nextSibling();</a>
<a name="ln592">            }</a>
<a name="ln593">      qDebug() &lt;&lt; &quot;WARNING: A null node was returned when search for the identifier&quot; &lt;&lt; id &lt;&lt; &quot;. Your Guitar Pro file may be corrupted.&quot;;</a>
<a name="ln594">      return currentDomNode;</a>
<a name="ln595">      }</a>
<a name="ln596"> </a>
<a name="ln597">//---------------------------------------------------------</a>
<a name="ln598">//   findNumMeasures</a>
<a name="ln599">//---------------------------------------------------------</a>
<a name="ln600"> </a>
<a name="ln601">int GuitarPro6::findNumMeasures(GPPartInfo* partInfo)</a>
<a name="ln602">      {</a>
<a name="ln603">      QDomNode masterBar = partInfo-&gt;masterBars.nextSibling();</a>
<a name="ln604">      QDomNode masterBarElement;</a>
<a name="ln605">      while (!masterBar.isNull()) {</a>
<a name="ln606">            GpBar gpBar;</a>
<a name="ln607">            gpBar.freeTime       = false;</a>
<a name="ln608">            gpBar.direction      = &quot;&quot;;</a>
<a name="ln609">            gpBar.directionStyle = &quot;&quot;;</a>
<a name="ln610">            masterBarElement     = masterBar.firstChild();</a>
<a name="ln611">            while (!masterBarElement.isNull()) {</a>
<a name="ln612">                  if (!masterBarElement.nodeName().compare(&quot;Key&quot;))</a>
<a name="ln613">                        gpBar.keysig = masterBarElement.firstChild().toElement().text().toInt();</a>
<a name="ln614">                  else if (!masterBarElement.nodeName().compare(&quot;Time&quot;)) {</a>
<a name="ln615">                        QString timeSignature            = masterBarElement.toElement().text();</a>
<a name="ln616">                        QList&lt;QString&gt; timeSignatureList = timeSignature.split(&quot;/&quot;);</a>
<a name="ln617">                        gpBar.timesig = Fraction(timeSignatureList.first().toInt(), timeSignatureList.last().toInt());</a>
<a name="ln618">                        }</a>
<a name="ln619">                  else if (!masterBarElement.nodeName().compare(&quot;Directions&quot;)) {</a>
<a name="ln620">                        auto element = masterBarElement.firstChild();</a>
<a name="ln621">                        while (!element.isNull()) {</a>
<a name="ln622">                              gpBar.directions.push_back(element.toElement().text());</a>
<a name="ln623">                              element = element.nextSibling();</a>
<a name="ln624">                              }</a>
<a name="ln625">                        //gpBar.direction = masterBarElement.firstChild().toElement().text();</a>
<a name="ln626">                        gpBar.directionStyle = masterBarElement.firstChild().nodeName();</a>
<a name="ln627">                        }</a>
<a name="ln628">                  else if (!masterBarElement.nodeName().compare(&quot;FreeTime&quot;)) {</a>
<a name="ln629">                        gpBar.freeTime = true;</a>
<a name="ln630">                        gpBar.barLine  = BarLineType::BROKEN;</a>
<a name="ln631">                        }</a>
<a name="ln632">                  else if (!masterBarElement.nodeName().compare(&quot;DoubleBar&quot;))</a>
<a name="ln633">                        gpBar.barLine = BarLineType::DOUBLE;</a>
<a name="ln634">                  else if (!masterBarElement.nodeName().compare(&quot;Section&quot;)) {</a>
<a name="ln635">                        auto section = masterBarElement.firstChild();</a>
<a name="ln636">                        while (!section.isNull())</a>
<a name="ln637">                              {</a>
<a name="ln638">                              if (!section.nodeName().compare(&quot;Letter&quot;))</a>
<a name="ln639">                                    gpBar.section[0] = section.toElement().text();</a>
<a name="ln640">                              else if (!section.nodeName().compare(&quot;Text&quot;))</a>
<a name="ln641">                                    gpBar.section[1] = section.toElement().text();</a>
<a name="ln642">                              section = section.nextSibling();</a>
<a name="ln643">                              }</a>
<a name="ln644">                        }</a>
<a name="ln645">                  masterBarElement = masterBarElement.nextSibling();</a>
<a name="ln646">                  }</a>
<a name="ln647">            bars.append(gpBar);</a>
<a name="ln648">            if (masterBar.nextSibling().isNull())</a>
<a name="ln649">                  break;</a>
<a name="ln650">            masterBar = masterBar.nextSibling();</a>
<a name="ln651">            }</a>
<a name="ln652">      QString b = masterBar.lastChildElement(&quot;Bars&quot;).toElement().text();</a>
<a name="ln653">      //work out the number of measures (add 1 as couning from 0, and divide by number of parts)</a>
<a name="ln654">      int numMeasures = (b.split(&quot; &quot;).last().toInt() + 1) / score-&gt;parts().length();</a>
<a name="ln655"> </a>
<a name="ln656">      if (numMeasures &gt; b.size()) {</a>
<a name="ln657">            qDebug(&quot;GuitarPro6:findNumMeasures: bars %d &lt; numMeasures %d\n&quot;, b.size(), numMeasures);</a>
<a name="ln658">            // HACK (ws)</a>
<a name="ln659">            numMeasures = b.size();</a>
<a name="ln660">            }</a>
<a name="ln661">      return numMeasures;</a>
<a name="ln662">      }</a>
<a name="ln663"> </a>
<a name="ln664">//---------------------------------------------------------</a>
<a name="ln665">//   fermataToFraction</a>
<a name="ln666">//---------------------------------------------------------</a>
<a name="ln667"> </a>
<a name="ln668">Fraction GuitarPro6::fermataToFraction(int numerator, int denominator)</a>
<a name="ln669">      {</a>
<a name="ln670">      numerator++;</a>
<a name="ln671">      // minim through to hemidemisemiquaver</a>
<a name="ln672">      if (denominator == 0)       { denominator = 2; }</a>
<a name="ln673">      else if (denominator == 1) {</a>
<a name="ln674">            denominator = 4;</a>
<a name="ln675">            }</a>
<a name="ln676">      else if (denominator == 2) {</a>
<a name="ln677">            denominator = 8;</a>
<a name="ln678">            }</a>
<a name="ln679">      else if (denominator == 3) {</a>
<a name="ln680">            denominator = 12;</a>
<a name="ln681">            }</a>
<a name="ln682">      else if (denominator == 4) {</a>
<a name="ln683">            denominator = 16;</a>
<a name="ln684">            }</a>
<a name="ln685">      else if (denominator == 5) {</a>
<a name="ln686">            denominator = 32;</a>
<a name="ln687">            }</a>
<a name="ln688"> </a>
<a name="ln689">      return Fraction(numerator, denominator);</a>
<a name="ln690">      }</a>
<a name="ln691"> </a>
<a name="ln692">//---------------------------------------------------------</a>
<a name="ln693">//   rhythmToDuration</a>
<a name="ln694">//---------------------------------------------------------</a>
<a name="ln695"> </a>
<a name="ln696">Fraction GuitarPro6::rhythmToDuration(QString value)</a>
<a name="ln697">      {</a>
<a name="ln698">      Fraction l;</a>
<a name="ln699">      if (value.compare(&quot;Whole&quot;) == 0)</a>
<a name="ln700">            l.set(1, 1);</a>
<a name="ln701">      else if (value.compare(&quot;Half&quot;) == 0)</a>
<a name="ln702">            l.set(1, 2);</a>
<a name="ln703">      else if (value.compare(&quot;Quarter&quot;) == 0)</a>
<a name="ln704">            l.set(1, 4);</a>
<a name="ln705">      else if (value.compare(&quot;Eighth&quot;) == 0)</a>
<a name="ln706">            l.set(1,8);</a>
<a name="ln707">      else if (value.compare(&quot;16th&quot;) == 0)</a>
<a name="ln708">            l.set(1,16);</a>
<a name="ln709">      else if (value.compare(&quot;32nd&quot;) == 0)</a>
<a name="ln710">            l.set(1,32);</a>
<a name="ln711">      else if (value.compare(&quot;64th&quot;) == 0)</a>
<a name="ln712">            l.set(1,64);</a>
<a name="ln713">      else if (value.compare(&quot;128th&quot;) == 0)</a>
<a name="ln714">            l.set(1,128);</a>
<a name="ln715">      else</a>
<a name="ln716">            qFatal( &quot;Error - unknown note length: %s&quot;, qPrintable(value));</a>
<a name="ln717">      return l;</a>
<a name="ln718">      }</a>
<a name="ln719"> </a>
<a name="ln720">//---------------------------------------------------------</a>
<a name="ln721">//   readDrumNote</a>
<a name="ln722">//---------------------------------------------------------</a>
<a name="ln723"> </a>
<a name="ln724">void GuitarPro6::readDrumNote(Note* note, int element, int variation)</a>
<a name="ln725">      {</a>
<a name="ln726">      int pitch = 44;</a>
<a name="ln727">      /* These numbers below were determined by creating all drum</a>
<a name="ln728">       * notes in a GPX format file and then analyzing the score.gpif</a>
<a name="ln729">       * file which specifies the score and then matching as much</a>
<a name="ln730">       * as possible with the gpDrumset...   */</a>
<a name="ln731">      if (element == 11 &amp;&amp; variation == 0)  // pedal hihat</a>
<a name="ln732">            pitch = 44;</a>
<a name="ln733">      else if (element == 0 &amp;&amp; variation == 0) // Kick (hit)</a>
<a name="ln734">            pitch = 36; // or 36</a>
<a name="ln735">      else if (element == 5 &amp;&amp; variation == 0) // Tom very low (hit)</a>
<a name="ln736">            pitch = 41;</a>
<a name="ln737">      else if (element == 6 &amp;&amp; variation == 0) // Tom low (hit)</a>
<a name="ln738">            pitch = 43;</a>
<a name="ln739">      else if (element == 7 &amp;&amp; variation == 0) // Tom medium (hit)</a>
<a name="ln740">            pitch = 45;</a>
<a name="ln741">      else if (element == 1 &amp;&amp; variation == 0) // Snare (hit)</a>
<a name="ln742">            pitch = 40; //or 40</a>
<a name="ln743">      else if (element == 1 &amp;&amp; variation == 1) // Snare (rim shot)</a>
<a name="ln744">            pitch = 91;</a>
<a name="ln745">      else if (element == 1 &amp;&amp; variation == 2) // Snare (side stick)</a>
<a name="ln746">            pitch = 37;</a>
<a name="ln747">      else if (element == 8 &amp;&amp; variation == 0) // Tom high (hit)</a>
<a name="ln748">            pitch = 48;</a>
<a name="ln749">      else if (element == 9 &amp;&amp; variation == 0) // Tom very high (hit)</a>
<a name="ln750">            pitch = 50;</a>
<a name="ln751">      else if (element == 15 &amp;&amp; variation == 0) // Ride (middle)</a>
<a name="ln752">            pitch = 51;</a>
<a name="ln753">      else if (element == 15 &amp;&amp; variation == 1) // Ride (edge)</a>
<a name="ln754">            pitch = 59;</a>
<a name="ln755">      else if (element == 15 &amp;&amp; variation == 2) // Ride (bell)</a>
<a name="ln756">            pitch = 59;</a>
<a name="ln757">      else if (element == 10 &amp;&amp; variation == 0) // Hihat (closed)</a>
<a name="ln758">            pitch = 42;</a>
<a name="ln759">      else if (element == 10 &amp;&amp; variation == 1) // Hihat (half)</a>
<a name="ln760">            pitch = 46;</a>
<a name="ln761">      else if (element == 10 &amp;&amp; variation == 2) // Hihat (open)</a>
<a name="ln762">            pitch = 46;</a>
<a name="ln763">      else if (element == 12 &amp;&amp; variation == 0) // Crash medium (hit)</a>
<a name="ln764">            pitch = 49;</a>
<a name="ln765">      else if (element == 14 &amp;&amp; variation == 0) // Splash (hit)</a>
<a name="ln766">            pitch = 55;</a>
<a name="ln767">      else if (element == 13 &amp;&amp; variation == 0) // Crash high (hit)</a>
<a name="ln768">            pitch = 57;</a>
<a name="ln769">      else if (element == 16 &amp;&amp; variation == 0) // China (hit)</a>
<a name="ln770">            pitch = 52;</a>
<a name="ln771">      else if (element == 4 &amp;&amp; variation == 0) // Cowbell high (hit)</a>
<a name="ln772">            pitch = 102;</a>
<a name="ln773">      else if (element == 3 &amp;&amp; variation == 0) // Cowbell medium (hit)</a>
<a name="ln774">            pitch = 56;</a>
<a name="ln775">      else if (element == 2 &amp;&amp; variation == 0) // Cowbell low (hit)</a>
<a name="ln776">            pitch = 99;</a>
<a name="ln777"> </a>
<a name="ln778">      note-&gt;setPitch(pitch);</a>
<a name="ln779">      }</a>
<a name="ln780"> </a>
<a name="ln781"> </a>
<a name="ln782">//---------------------------------------------------------</a>
<a name="ln783">//   makeTie</a>
<a name="ln784">//---------------------------------------------------------</a>
<a name="ln785"> </a>
<a name="ln786">void GuitarPro6::makeTie(Note* note)</a>
<a name="ln787">      {</a>
<a name="ln788">      bool found       = false;</a>
<a name="ln789">      Chord* chord     = note-&gt;chord();</a>
<a name="ln790">      Segment* segment = chord-&gt;segment();</a>
<a name="ln791">      if (!segment)</a>
<a name="ln792">            return;</a>
<a name="ln793">      segment = segment-&gt;prev1(SegmentType::ChordRest);</a>
<a name="ln794">      int track = note-&gt;track();</a>
<a name="ln795">      while (segment) {</a>
<a name="ln796">            Element* e = segment-&gt;element(track);</a>
<a name="ln797">            if (e) {</a>
<a name="ln798">                  if (e-&gt;type() == ElementType::CHORD) {</a>
<a name="ln799">                        Chord* chord2 = static_cast&lt;Chord*&gt;(e);</a>
<a name="ln800">                        foreach(Note* note2, chord2-&gt;notes()) {</a>
<a name="ln801">                              if (note2-&gt;string() == note-&gt;string()) {</a>
<a name="ln802">                                    Tie* tie = new Tie(score);</a>
<a name="ln803">                                    tie-&gt;setEndNote(note);</a>
<a name="ln804">                                    note2-&gt;add(tie);</a>
<a name="ln805">                                    note-&gt;setFret(note2-&gt;fret());</a>
<a name="ln806">                                    note-&gt;setPitch(note2-&gt;pitch());</a>
<a name="ln807">                                    found = true;</a>
<a name="ln808">                                    break;</a>
<a name="ln809">                                    }</a>
<a name="ln810">                              }</a>
<a name="ln811">                        }</a>
<a name="ln812">                  if (found)</a>
<a name="ln813">                        break;</a>
<a name="ln814">                  }</a>
<a name="ln815">            segment = segment-&gt;prev1(SegmentType::ChordRest);</a>
<a name="ln816">            }</a>
<a name="ln817">      }</a>
<a name="ln818"> </a>
<a name="ln819">//---------------------------------------------------------</a>
<a name="ln820">//   readBeats</a>
<a name="ln821">//---------------------------------------------------------</a>
<a name="ln822"> </a>
<a name="ln823">Fraction GuitarPro6::readBeats(QString beats, GPPartInfo* partInfo, Measure* measure, const Fraction&amp; startTick, int staffIdx, int voiceNum, Tuplet* tuplets[], int measureCounter)</a>
<a name="ln824">      {</a>
<a name="ln825">      bool wrong_pause = false;</a>
<a name="ln826">      Lyrics* lyric    = nullptr;</a>
<a name="ln827">      Fraction beatsTick    = {0,1};</a>
<a name="ln828"> </a>
<a name="ln829">      // we must count from the start of the bar, so declare a fraction to track this</a>
<a name="ln830">      Fraction fermataIndex(0,1);</a>
<a name="ln831">      int track            = staffIdx * VOICES + voiceNum;</a>
<a name="ln832">      auto currentBeatList = beats.split(&quot; &quot;);</a>
<a name="ln833">      bool startSlur = false;</a>
<a name="ln834">      bool endSlur = false;</a>
<a name="ln835">      for (auto currentBeat = currentBeatList.begin(); currentBeat != currentBeatList.end(); currentBeat++) {</a>
<a name="ln836">            int sl = -1;</a>
<a name="ln837">            if (slides-&gt;contains(staffIdx * VOICES + voiceNum))</a>
<a name="ln838">                  sl = slides-&gt;take(staffIdx * VOICES + voiceNum);</a>
<a name="ln839"> </a>
<a name="ln840">            Fraction l;</a>
<a name="ln841">            int dotted           = 0;</a>
<a name="ln842">            QDomNode beat        = getNode(*currentBeat, partInfo-&gt;beats);</a>
<a name="ln843">            Fraction currentTick = startTick + beatsTick;</a>
<a name="ln844">            Segment* segment     = measure-&gt;getSegment(SegmentType::ChordRest, currentTick);</a>
<a name="ln845">            QDomNode currentNode = beat.firstChild();</a>
<a name="ln846">            bool noteSpecified   = false;</a>
<a name="ln847">            ChordRest* cr        = segment-&gt;cr(track);</a>
<a name="ln848">            bool tupletSet       = false;</a>
<a name="ln849">            Tuplet* tuplet       = tuplets[staffIdx * VOICES + voiceNum];</a>
<a name="ln850">            int whammyOrigin     = -1;</a>
<a name="ln851">            int whammyMiddle     = -1;</a>
<a name="ln852">            int whammyEnd        = -1;</a>
<a name="ln853">            bool graceNote       = false;</a>
<a name="ln854">            Note* lyrNote(nullptr);</a>
<a name="ln855">            std::map&lt;int, QString&gt; lyrics;</a>
<a name="ln856">            while (!currentNode.isNull()) {</a>
<a name="ln857">                  if (currentNode.nodeName() == &quot;GraceNotes&quot;) {</a>
<a name="ln858">                        graceNote = true;</a>
<a name="ln859">                        }</a>
<a name="ln860">                  else if (currentNode.nodeName() == &quot;Notes&quot;) {</a>
<a name="ln861">                        noteSpecified = true;</a>
<a name="ln862">                        auto notesList = currentNode.toElement().text().split(&quot; &quot;);</a>
<a name="ln863"> </a>
<a name="ln864">                        // this could be set by rhythm if we dealt with a tuplet</a>
<a name="ln865">                        if (!cr)</a>
<a name="ln866">                              cr = new Chord(score);</a>
<a name="ln867">                        if (lyric) {</a>
<a name="ln868">                              cr-&gt;add(lyric);</a>
<a name="ln869">                              lyric = nullptr;</a>
<a name="ln870">                              }</a>
<a name="ln871">                        cr-&gt;setTrack(track);</a>
<a name="ln872">                        cr-&gt;setTicks(l);</a>
<a name="ln873">                        TDuration d(l);</a>
<a name="ln874">                        d.setDots(dotted);</a>
<a name="ln875"> </a>
<a name="ln876">                        cr-&gt;setDurationType(d);</a>
<a name="ln877"> </a>
<a name="ln878">                        if (cr-&gt;isChord()) {</a>
<a name="ln879">                              auto lyrchord = toChord(cr);</a>
<a name="ln880">                              if (lyrchord &amp;&amp; lyrchord-&gt;notes().size())</a>
<a name="ln881">                                    lyrNote = lyrchord-&gt;notes().front();</a>
<a name="ln882">                              }</a>
<a name="ln883"> </a>
<a name="ln884">                        if (!segment-&gt;cr(track))</a>
<a name="ln885">                              segment-&gt;add(cr);</a>
<a name="ln886"> </a>
<a name="ln887">                        if (startSlur) {</a>
<a name="ln888">                                    Slur* slur = new Slur(score);</a>
<a name="ln889">                                    slur-&gt;setParent(0);</a>
<a name="ln890">                                    slur-&gt;setTrack(track);</a>
<a name="ln891">                                    slur-&gt;setTrack2(track);</a>
<a name="ln892">                                    legatos[track] = slur;</a>
<a name="ln893">                                    slur-&gt;setTick(cr-&gt;tick());</a>
<a name="ln894">                                    slur-&gt;setTick2(cr-&gt;tick());</a>
<a name="ln895">                                    startSlur = false;</a>
<a name="ln896">                                    }</a>
<a name="ln897">                        if (endSlur) {</a>
<a name="ln898">                              Slur* slur = legatos[track];</a>
<a name="ln899">                              if (slur) {</a>
<a name="ln900">                                    slur-&gt;setTrack2(track);</a>
<a name="ln901">                                    slur-&gt;setTick2(cr-&gt;tick());</a>
<a name="ln902">                                    score-&gt;addElement(slur);</a>
<a name="ln903">                                    legatos[track] = 0;</a>
<a name="ln904">                                    }</a>
<a name="ln905">                              endSlur = false;</a>
<a name="ln906">                              }</a>
<a name="ln907"> </a>
<a name="ln908">                        Chord* lastChord { nullptr };</a>
<a name="ln909">                        for (auto iter = notesList.begin(); iter != notesList.end(); ++iter) {</a>
<a name="ln910">                              // we have found a note</a>
<a name="ln911">                              QDomNode dnote = getNode(*iter, partInfo-&gt;notes);</a>
<a name="ln912">                              int id        = -1;</a>
<a name="ln913">                              auto idx      = dnote.attributes().namedItem(&quot;id&quot;);</a>
<a name="ln914">                              if (!idx.isNull())</a>
<a name="ln915">                                    id = idx.nodeValue().toInt() - 1;</a>
<a name="ln916">                              QDomNode currentNote = (dnote).firstChild();</a>
<a name="ln917">                              bool tie             = false;</a>
<a name="ln918">                              bool trill           = false;</a>
<a name="ln919">                              // if a &lt;Notes&gt; tag is used but there is no &lt;Note&gt;, then we add a rest. This flag will allow us to check this.</a>
<a name="ln920">                              while (!currentNote.isNull()) {</a>
<a name="ln921">                                    if (!currentNote.nodeName().compare(&quot;Tie&quot;)) {</a>
<a name="ln922">                                          if (!currentNote.attributes().namedItem(&quot;destination&quot;).toAttr().value().compare(&quot;true&quot;))</a>
<a name="ln923">                                                tie = true;</a>
<a name="ln924">                                          }</a>
<a name="ln925"> </a>
<a name="ln926">                                    if (currentNote.nodeName() == &quot;Properties&quot;) {</a>
<a name="ln927">                                          QDomNode currentProperty = currentNote.firstChild();</a>
<a name="ln928">                                          // these should not be in this scope - they may not even exist.</a>
<a name="ln929">                                          QString stringNum;</a>
<a name="ln930">                                          QString fretNum;</a>
<a name="ln931">                                          QString tone;</a>
<a name="ln932">                                          QString octave;</a>
<a name="ln933">                                          QString midi;</a>
<a name="ln934">                                          QString element;</a>
<a name="ln935">                                          QString variation;</a>
<a name="ln936"> </a>
<a name="ln937">                                          Note* note = new Note(score);</a>
<a name="ln938">                                          if (graceNote)</a>
<a name="ln939">                                                lyrNote = note;</a>
<a name="ln940">                                          if (id != -1) {</a>
<a name="ln941">                                                auto iter1 = lyrics.find(id);</a>
<a name="ln942">                                                if (iter1 != lyrics.end()) {</a>
<a name="ln943">                                                      auto lyr = new Lyrics(score);</a>
<a name="ln944">                                                      lyr-&gt;setPlainText(iter1-&gt;second);</a>
<a name="ln945">                                                      cr-&gt;add(lyr);</a>
<a name="ln946">                                                      }</a>
<a name="ln947">                                                }</a>
<a name="ln948">                                          lyrNote = note;</a>
<a name="ln949">                                          if (dotted) {</a>
<a name="ln950">                                                // there is at most one dotted note in this guitar pro version</a>
<a name="ln951">                                                NoteDot* dot = new NoteDot(score);</a>
<a name="ln952">                                                dot-&gt;setParent(note);</a>
<a name="ln953">                                                dot-&gt;setTrack(track);  // needed to know the staff it belongs to (and detect tablature)</a>
<a name="ln954">                                                dot-&gt;setVisible(true);</a>
<a name="ln955">                                                note-&gt;add(dot);</a>
<a name="ln956">                                                }</a>
<a name="ln957"> </a>
<a name="ln958">                                          Chord* chord = static_cast&lt;Chord*&gt;(cr);</a>
<a name="ln959">                                          chord-&gt;add(note);</a>
<a name="ln960">                                          QString harmonicText = &quot;&quot;;</a>
<a name="ln961">                                          bool use_harmonic    = true;</a>
<a name="ln962">                                          bool hasSlur         = false;</a>
<a name="ln963">                                          bool check_slide_map = true;</a>
<a name="ln964"> </a>
<a name="ln965">                                          while (!currentProperty.isNull()) {</a>
<a name="ln966">                                                QString argument = currentProperty.attributes().namedItem(&quot;name&quot;).toAttr().value();</a>
<a name="ln967">                                                if (argument == &quot;String&quot;) {</a>
<a name="ln968">                                                      stringNum = currentProperty.firstChild().toElement().text();</a>
<a name="ln969">                                                      if (check_slide_map) {</a>
<a name="ln970">                                                            int string = stringNum.toInt();</a>
<a name="ln971">                                                            if (slideMap.find({ string, staffIdx }) != slideMap.end()) {</a>
<a name="ln972">                                                                  Note* start  = slideMap[{ string, staffIdx }];</a>
<a name="ln973">                                                                  Glissando* s = new Glissando(score);</a>
<a name="ln974">                                                                  s-&gt;setGlissandoType(GlissandoType::STRAIGHT);</a>
<a name="ln975">                                                                  note-&gt;chord()-&gt;add(s);</a>
<a name="ln976">                                                                  s-&gt;setAnchor(Spanner::Anchor::NOTE);</a>
<a name="ln977">                                                                  s-&gt;setStartElement(start);</a>
<a name="ln978">                                                                  s-&gt;setTick(start-&gt;chord()-&gt;tick());</a>
<a name="ln979">                                                                  s-&gt;setTrack(staffIdx);</a>
<a name="ln980">                                                                  s-&gt;setParent(start);</a>
<a name="ln981">                                                                  s-&gt;setEndElement(note);</a>
<a name="ln982">                                                                  s-&gt;setTick2(note-&gt;chord()-&gt;tick());</a>
<a name="ln983">                                                                  s-&gt;setTrack2(staffIdx);</a>
<a name="ln984">                                                                  score-&gt;addElement(s);</a>
<a name="ln985">                                                                  slideMap.erase({ string, staffIdx });</a>
<a name="ln986">                                                                  if (slurs[staffIdx])</a>
<a name="ln987">                                                                        createSlur(false, track, note-&gt;chord());</a>
<a name="ln988">                                                                  }</a>
<a name="ln989">                                                            }</a>
<a name="ln990">                                                      }</a>
<a name="ln991">                                                else if (argument == &quot;Element&quot;)</a>
<a name="ln992">                                                      element = currentProperty.firstChild().toElement().text();</a>
<a name="ln993">                                                else if (argument == &quot;Slide&quot;) {</a>
<a name="ln994">                                                      int slideKind = currentProperty.firstChild().toElement().text().toInt();</a>
<a name="ln995">                                                      if (slideKind &amp; (SHIFT_SLIDE | LEGATO_SLIDE)) {</a>
<a name="ln996">                                                            auto string = note-&gt;string();</a>
<a name="ln997">                                                            if (string == -1) {</a>
<a name="ln998">                                                                  for (auto node = currentNote.firstChild(); !node.isNull(); node = node.nextSibling()) {</a>
<a name="ln999">                                                                        auto arg = node.attributes().namedItem(&quot;name&quot;).toAttr().value();</a>
<a name="ln1000">                                                                        if (arg == &quot;String&quot;) {</a>
<a name="ln1001">                                                                              string = node.firstChild().toElement().text().toInt();</a>
<a name="ln1002">                                                                              break;</a>
<a name="ln1003">                                                                              }</a>
<a name="ln1004">                                                                        }</a>
<a name="ln1005">                                                                  }</a>
<a name="ln1006">                                                            if (slideKind &amp; LEGATO_SLIDE)</a>
<a name="ln1007">                                                                  note-&gt;setFlag(ElementFlag::HAS_TAG, true);</a>
<a name="ln1008">                                                            slideMap.insert({ { string, staffIdx }, note });</a>
<a name="ln1009">                                                            slideKind      &amp;= ~(SHIFT_SLIDE | LEGATO_SLIDE);</a>
<a name="ln1010">                                                            check_slide_map = false;</a>
<a name="ln1011">                                                            }</a>
<a name="ln1012">                                                      if (slideKind) {</a>
<a name="ln1013">                                                            createSlide(slideKind, note-&gt;chord(), staffIdx, note);</a>
<a name="ln1014">#if 0</a>
<a name="ln1015">                                                            if (slideKind &gt;= 4)</a>
<a name="ln1016">                                                                  slide = slideKind;</a>
<a name="ln1017">                                                            else</a>
<a name="ln1018">                                                                  slides-&gt;insert(staffIdx * VOICES + voiceNum, slideKind);</a>
<a name="ln1019">#endif</a>
<a name="ln1020">                                                            }</a>
<a name="ln1021">                                                      }</a>
<a name="ln1022">                                                else if (!argument.compare(&quot;HopoOrigin&quot;)) {</a>
<a name="ln1023">                                                      hasSlur = true;</a>
<a name="ln1024">                                                      createSlur(true, track, cr);</a>
<a name="ln1025">                                                      }</a>
<a name="ln1026">                                                else if (!argument.compare(&quot;HopoDestination&quot;) &amp;&amp; !hasSlur) {</a>
<a name="ln1027">                                                      createSlur(false, track, cr);</a>
<a name="ln1028">                                                      }</a>
<a name="ln1029">                                                else if (argument == &quot;Variation&quot;)</a>
<a name="ln1030">                                                      variation = currentProperty.firstChild().toElement().text();</a>
<a name="ln1031">                                                else if (argument == &quot;Fret&quot;)</a>
<a name="ln1032">                                                      fretNum = currentProperty.firstChild().toElement().text();</a>
<a name="ln1033">                                                else if (argument == &quot;Tone&quot;)</a>
<a name="ln1034">                                                      tone = currentProperty.firstChild().toElement().text();</a>
<a name="ln1035">                                                else if (argument == &quot;Octave&quot;)</a>
<a name="ln1036">                                                      octave = currentProperty.firstChild().toElement().text();</a>
<a name="ln1037">                                                else if (argument == &quot;Midi&quot;)</a>
<a name="ln1038">                                                      midi = currentProperty.firstChild().toElement().text();</a>
<a name="ln1039">                                                else if (argument == &quot;Muted&quot;) {</a>
<a name="ln1040">                                                      if (!currentProperty.firstChild().nodeName().compare(&quot;Enable&quot;)) {</a>
<a name="ln1041">                                                            note-&gt;setHeadGroup(NoteHead::Group::HEAD_CROSS);</a>
<a name="ln1042">                                                            note-&gt;setGhost(true);</a>
<a name="ln1043">                                                            }</a>
<a name="ln1044">                                                      }</a>
<a name="ln1045">                                                else if (argument == &quot;Tapped&quot;) {</a>
<a name="ln1046">                                                      if (!currentProperty.firstChild().nodeName().compare(&quot;Enable&quot;))</a>
<a name="ln1047">                                                            addTap(note);</a>
<a name="ln1048">                                                      }</a>
<a name="ln1049">                                                else if (argument == &quot;LeftHandTapped&quot;) {</a>
<a name="ln1050">                                                      if (!currentProperty.firstChild().nodeName().compare(&quot;Enable&quot;)) {</a>
<a name="ln1051">                                                            Symbol* sym = new Symbol(note-&gt;score());</a>
<a name="ln1052">                                                            sym-&gt;setSym(SymId::articLaissezVibrerAbove);</a>
<a name="ln1053">                                                            sym-&gt;setParent(note);</a>
<a name="ln1054">                                                            note-&gt;add(sym);</a>
<a name="ln1055">                                                            //note-&gt;setStemThrough(true);</a>
<a name="ln1056">                                                            //articLaissezVibrerAbove</a>
<a name="ln1057">                                                            /*</a>
<a name="ln1058">                                                            Symbol* leftSym = new Symbol(note-&gt;score());</a>
<a name="ln1059">                                                            Symbol* rightSym = new Symbol(note-&gt;score());</a>
<a name="ln1060">                                                            leftSym-&gt;setSym(SymId::noteheadParenthesisLeft);</a>
<a name="ln1061">                                                            rightSym-&gt;setSym(SymId::noteheadParenthesisRight);</a>
<a name="ln1062">                                                            leftSym-&gt;setParent(note);</a>
<a name="ln1063">                                                            rightSym-&gt;setParent(note);</a>
<a name="ln1064">                                                            note-&gt;add(leftSym);</a>
<a name="ln1065">                                                            note-&gt;add(rightSym);</a>
<a name="ln1066">                                                            */</a>
<a name="ln1067">                                                            }</a>
<a name="ln1068">                                                      }</a>
<a name="ln1069">                                                else if (argument == &quot;Bended&quot;) {</a>
<a name="ln1070">                                                      if (!currentProperty.firstChild().nodeName().compare(&quot;Enable&quot;)) {</a>
<a name="ln1071">                                                            auto props = currentProperty.nextSibling();</a>
<a name="ln1072">                                                            int origin(0);</a>
<a name="ln1073">                                                            int destination(0);</a>
<a name="ln1074">                                                            int off1(15);</a>
<a name="ln1075">                                                            int off2(0);</a>
<a name="ln1076">                                                            int offdest(60);</a>
<a name="ln1077">                                                            int middleval(0);</a>
<a name="ln1078">                                                            bool has_middle = false;</a>
<a name="ln1079">                                                            while (!props.isNull()) {</a>
<a name="ln1080">                                                                  auto name = props.attributes().namedItem(&quot;name&quot;).toAttr().value();</a>
<a name="ln1081">                                                                  if (name == &quot;BendOriginValue&quot;) {</a>
<a name="ln1082">                                                                        origin = props.firstChildElement(&quot;Float&quot;).toElement().text().toInt();</a>
<a name="ln1083">                                                                        }</a>
<a name="ln1084">                                                                  else if (name == &quot;BendDestinationValue&quot;) {</a>
<a name="ln1085">                                                                        destination = props.firstChildElement(&quot;Float&quot;).toElement().text().toInt();</a>
<a name="ln1086">                                                                        }</a>
<a name="ln1087">                                                                  else if (name == &quot;BendMiddleOffset1&quot;) {</a>
<a name="ln1088">                                                                        off1 = props.firstChildElement(&quot;Float&quot;).toElement().text().toInt();</a>
<a name="ln1089">                                                                        }</a>
<a name="ln1090">                                                                  else if (name == &quot;BendMiddleOffset2&quot;) {</a>
<a name="ln1091">                                                                        off2 = props.firstChildElement(&quot;Float&quot;).toElement().text().toInt();</a>
<a name="ln1092">                                                                        }</a>
<a name="ln1093">                                                                  else if (name == &quot;BendDestinationOffset&quot;) {</a>
<a name="ln1094">                                                                        offdest = props.firstChildElement(&quot;Float&quot;).toElement().text().toInt();</a>
<a name="ln1095">                                                                        }</a>
<a name="ln1096">                                                                  else if (name == &quot;BendMiddleValue&quot;) {</a>
<a name="ln1097">                                                                        middleval  = props.firstChildElement(&quot;Float&quot;).toElement().text().toInt();</a>
<a name="ln1098">                                                                        has_middle = true;</a>
<a name="ln1099">                                                                        }</a>
<a name="ln1100">                                                                  props = props.nextSibling();</a>
<a name="ln1101">                                                                  }</a>
<a name="ln1102"> </a>
<a name="ln1103">                                                            Bend* bend = new Bend(note-&gt;score());</a>
<a name="ln1104">                                                            //bend-&gt;setNote(note); //TODO</a>
<a name="ln1105">                                                            bend-&gt;points().append(PitchValue(0, origin));</a>
<a name="ln1106">                                                            bend-&gt;points().append(PitchValue(off1, has_middle ? middleval : destination));</a>
<a name="ln1107">                                                            if (has_middle)</a>
<a name="ln1108">                                                                  bend-&gt;points().append(PitchValue(off2, middleval));</a>
<a name="ln1109">                                                            bend-&gt;points().append(PitchValue(offdest, destination));</a>
<a name="ln1110">                                                            note-&gt;add(bend);</a>
<a name="ln1111">                                                            }</a>
<a name="ln1112">                                                      }</a>
<a name="ln1113">                                                else if (argument == &quot;PalmMuted&quot;) {</a>
<a name="ln1114">                                                      if (!currentProperty.firstChild().nodeName().compare(&quot;Enable&quot;))</a>
<a name="ln1115">                                                            addPalmMute(note);</a>
<a name="ln1116">                                                      }</a>
<a name="ln1117">                                                else if (argument == &quot;Tapped&quot;) {</a>
<a name="ln1118">                                                      if (!currentProperty.firstChild().nodeName().compare(&quot;Enable&quot;))</a>
<a name="ln1119">                                                            addTap(note);</a>
<a name="ln1120">                                                      }</a>
<a name="ln1121">                                                else if (!argument.compare(&quot;HarmonicType&quot;)) {</a>
<a name="ln1122">                                                      QString type;</a>
<a name="ln1123">                                                      auto inner = currentProperty.firstChildElement(&quot;HType&quot;);</a>
<a name="ln1124">                                                      if (inner.isNull())</a>
<a name="ln1125">                                                            type = currentProperty.toElement().text();</a>
<a name="ln1126">                                                      else</a>
<a name="ln1127">                                                            type = inner.toElement().text();</a>
<a name="ln1128">                                                      // add the same text to the note that Guitar Pro does</a>
<a name="ln1129">                                                      if (!type.compare(&quot;Feedback&quot;))</a>
<a name="ln1130">                                                            harmonicText = &quot;Fdbk.&quot;;</a>
<a name="ln1131">                                                      else if (!type.compare(&quot;Semi&quot;))</a>
<a name="ln1132">                                                            harmonicText = &quot;S.H.&quot;;</a>
<a name="ln1133">                                                      else if (!type.compare(&quot;Pinch&quot;))</a>
<a name="ln1134">                                                            harmonicText = &quot;P.H.&quot;;</a>
<a name="ln1135">                                                      else if (!type.compare(&quot;Tap&quot;))</a>
<a name="ln1136">                                                            harmonicText = &quot;T.H.&quot;;</a>
<a name="ln1137">                                                      else if (!type.compare(&quot;Artificial&quot;))</a>
<a name="ln1138">                                                            harmonicText = &quot;A.H.&quot;;</a>
<a name="ln1139">                                                      else {</a>
<a name="ln1140">                                                            harmonicText = type;</a>
<a name="ln1141">                                                            use_harmonic = false;</a>
<a name="ln1142">                                                            }</a>
<a name="ln1143">                                                      }</a>
<a name="ln1144">                                                else if (!argument.compare(&quot;HarmonicFret&quot;)) {</a>
<a name="ln1145">                                                      QString value;</a>
<a name="ln1146">                                                      auto inner = currentProperty.firstChildElement(&quot;HFret&quot;);</a>
<a name="ln1147">                                                      if (inner.isNull())</a>
<a name="ln1148">                                                            value = currentProperty.toElement().text();</a>
<a name="ln1149">                                                      else</a>
<a name="ln1150">                                                            value = inner.toElement().text();</a>
<a name="ln1151">                                                      Note* harmonicNote = nullptr;</a>
<a name="ln1152"> </a>
<a name="ln1153">                                                      // natural harmonic = artificial harmonic?</a>
<a name="ln1154">                                                      if (harmonicText.length()) {</a>
<a name="ln1155">                                                            if (!harmonicText.compare(&quot;Natural&quot;)) {</a>
<a name="ln1156">                                                                  harmonicNote = note;</a>
<a name="ln1157">                                                                  //note-&gt;setHarmonic(true); //TODO</a>
<a name="ln1158">                                                                  }</a>
<a name="ln1159">                                                            else {</a>
<a name="ln1160">                                                                  harmonicNote = new Note(score);</a>
<a name="ln1161">                                                                  // harmonicNote-&gt;setHarmonic(true);</a>
<a name="ln1162">                                                                  //harmonicNote-&gt;setTrillFret(11);</a>
<a name="ln1163">                                                                  chord-&gt;add(harmonicNote);</a>
<a name="ln1164"> </a>
<a name="ln1165">                                                                  //harmonicNote-&gt;setVisible(false);</a>
<a name="ln1166">                                                                  }</a>
<a name="ln1167">                                                            }</a>
<a name="ln1168"> </a>
<a name="ln1169">                                                      if (harmonicNote) {</a>
<a name="ln1170">                                                      #if 0</a>
<a name="ln1171">                                                            if (harmonicNote-&gt;harmonic())</a>
<a name="ln1172">                                                                  value = &quot;&quot;;</a>
<a name="ln1173">                                                            if (harmonicText == &quot;A.H.&quot;)</a>
<a name="ln1174">                                                                  harmonicNote-&gt;setHarmonic(true);</a>
<a name="ln1175">                                                      #endif</a>
<a name="ln1176">                                                            Staff* staff        = note-&gt;staff();</a>
<a name="ln1177">                                                            int harmonicFret    = fretNum.toInt();</a>
<a name="ln1178">                                                            int musescoreString = staff-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;strings() - 1 - stringNum.toInt();</a>
<a name="ln1179">                                                            harmonicNote-&gt;setString(musescoreString);</a>
<a name="ln1180">                                                            harmonicNote-&gt;setFret(harmonicFret);                     // add the octave for the harmonic</a>
<a name="ln1181">                                                            harmonicNote-&gt;setHeadGroup(NoteHead::Group::HEAD_DIAMOND);</a>
<a name="ln1182">                                                            if (!value.compare(&quot;12&quot;))</a>
<a name="ln1183">                                                                  harmonicFret += 12;</a>
<a name="ln1184">                                                            else if (!value.compare(&quot;7&quot;) || !value.compare(&quot;19&quot;))</a>
<a name="ln1185">                                                                  harmonicFret += 19;</a>
<a name="ln1186">                                                            else if (!value.compare(&quot;5&quot;) || !value.compare(&quot;24&quot;))</a>
<a name="ln1187">                                                                  harmonicFret += 24;</a>
<a name="ln1188">                                                            else if (!value.compare(&quot;3.9&quot;) || !value.compare(&quot;4&quot;) || !value.compare(&quot;9&quot;) || !value.compare(&quot;16&quot;))</a>
<a name="ln1189">                                                                  harmonicFret += 28;</a>
<a name="ln1190">                                                            else if (!value.compare(&quot;3.2&quot;))</a>
<a name="ln1191">                                                                  harmonicFret += 31;</a>
<a name="ln1192">                                                            else if (!value.compare(&quot;2.7&quot;))</a>
<a name="ln1193">                                                                  harmonicFret += 34;</a>
<a name="ln1194">                                                            else if (!value.compare(&quot;2.3&quot;) || !value.compare(&quot;2.4&quot;))</a>
<a name="ln1195">                                                                  harmonicFret += 36;</a>
<a name="ln1196">                                                            else if (!value.compare(&quot;2&quot;))</a>
<a name="ln1197">                                                                  harmonicFret += 38;</a>
<a name="ln1198">                                                            else if (!value.compare(&quot;1.8&quot;))</a>
<a name="ln1199">                                                                  harmonicFret += 40;</a>
<a name="ln1200">                                                            //harmonicNote-&gt;setFret(harmonicFret);</a>
<a name="ln1201">                                                            harmonicNote-&gt;setPitch(staff-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;getPitch(musescoreString, harmonicFret, nullptr, Fraction(0,1)));</a>
<a name="ln1202">                                                            harmonicNote-&gt;setTpcFromPitch();</a>
<a name="ln1203">                                                            if (harmonicText.length() &amp;&amp; harmonicText.compare(&quot;Natural&quot;)) {</a>
<a name="ln1204">                                                                  harmonicNote-&gt;setFret(fretNum.toInt());</a>
<a name="ln1205">                                                                  if (use_harmonic)</a>
<a name="ln1206">                                                                        harmonicText += &quot;\\&quot;;</a>
<a name="ln1207">                                                                  addTextToNote(harmonicText, Align::CENTER, harmonicNote);</a>
<a name="ln1208">                                                                  }</a>
<a name="ln1209">                                                            }</a>
<a name="ln1210">                                                      }</a>
<a name="ln1211">                                                currentProperty = currentProperty.nextSibling();</a>
<a name="ln1212">                                                }</a>
<a name="ln1213"> </a>
<a name="ln1214">                                          if (midi != &quot;&quot;)</a>
<a name="ln1215">                                                note-&gt;setPitch(midi.toInt());</a>
<a name="ln1216">                                          else if (element != &quot;&quot;)</a>
<a name="ln1217">                                                readDrumNote(note, element.toInt(), variation.toInt());</a>
<a name="ln1218">                                          else if (stringNum != &quot;&quot; &amp;&amp; stringNum.toInt() &gt;= 0 &amp;&amp; note-&gt;headGroup() != NoteHead::Group::HEAD_DIAMOND) {</a>
<a name="ln1219">                                                Staff* staff        = note-&gt;staff();</a>
<a name="ln1220">                                                int fretNumber      = fretNum.toInt();</a>
<a name="ln1221">                                                int musescoreString = staff-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;strings() - 1 - stringNum.toInt();</a>
<a name="ln1222">                                                auto pitch          = staff-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;getPitch(musescoreString, fretNumber, nullptr, Fraction(0,1));</a>
<a name="ln1223">                                                note-&gt;setFret(fretNumber);</a>
<a name="ln1224">                                                // we need to turn this string number for GP to the correct string number for musescore</a>
<a name="ln1225">                                                note-&gt;setString(musescoreString);</a>
<a name="ln1226">                                                note-&gt;setPitch(pitch);</a>
<a name="ln1227">                                                }</a>
<a name="ln1228">                                          else if (tone != &quot;&quot;)</a>
<a name="ln1229">                                                note-&gt;setPitch((octave.toInt() * 12) + tone.toInt()); // multiply octaves by 12 as 12 semitones in octave</a>
<a name="ln1230">                                          if (tie) {</a>
<a name="ln1231">                                                makeTie(note);</a>
<a name="ln1232">                                                tie = false;</a>
<a name="ln1233">                                                }</a>
<a name="ln1234">                                          if (trill) {</a>
<a name="ln1235">                                                Articulation* art = new Articulation(note-&gt;score());</a>
<a name="ln1236">                                                art-&gt;setSymId(SymId::ornamentTrill);</a>
<a name="ln1237">                                                if (!note-&gt;score()-&gt;addArticulation(note, art))</a>
<a name="ln1238">                                                      delete art;</a>
<a name="ln1239">                                                }</a>
<a name="ln1240">                                          QDomNode tremoloNode = currentNode.parentNode().firstChildElement(&quot;Tremolo&quot;);</a>
<a name="ln1241">                                          if (!tremoloNode.isNull()) {</a>
<a name="ln1242">                                                QString value = tremoloNode.toElement().text();</a>
<a name="ln1243">                                                Tremolo* t    = new Tremolo(chord-&gt;score());</a>
<a name="ln1244">                                                if (!value.compare(&quot;1/2&quot;)) {</a>
<a name="ln1245">                                                      t-&gt;setTremoloType(TremoloType::R8);</a>
<a name="ln1246">                                                      chord-&gt;add(t);</a>
<a name="ln1247">                                                      }</a>
<a name="ln1248">                                                else if (!value.compare(&quot;1/4&quot;)) {</a>
<a name="ln1249">                                                      t-&gt;setTremoloType(TremoloType::R16);</a>
<a name="ln1250">                                                      chord-&gt;add(t);</a>
<a name="ln1251">                                                      }</a>
<a name="ln1252">                                                else if (!value.compare(&quot;1/8&quot;)) {</a>
<a name="ln1253">                                                      t-&gt;setTremoloType(TremoloType::R32);</a>
<a name="ln1254">                                                      chord-&gt;add(t);</a>
<a name="ln1255">                                                      }</a>
<a name="ln1256">                                                }</a>
<a name="ln1257">                                          QDomNode wahNode = currentNode.parentNode().firstChildElement(&quot;Wah&quot;);</a>
<a name="ln1258">                                          if (!wahNode.isNull()) {</a>
<a name="ln1259">                                                QString value = wahNode.toElement().text();</a>
<a name="ln1260">                                                if (!value.compare(&quot;Open&quot;)) {</a>
<a name="ln1261">                                                      Articulation* art = new Articulation(note-&gt;score());</a>
<a name="ln1262">                                                      art-&gt;setSymId(SymId::brassMuteOpen);</a>
<a name="ln1263">                                                      if (!note-&gt;score()-&gt;addArticulation(note, art))</a>
<a name="ln1264">                                                            delete art;</a>
<a name="ln1265">                                                      }</a>
<a name="ln1266">                                                else if (!value.compare(&quot;Closed&quot;)) {</a>
<a name="ln1267">                                                      Articulation* art = new Articulation(note-&gt;score());</a>
<a name="ln1268">                                                      art-&gt;setSymId(SymId::brassMuteClosed);</a>
<a name="ln1269">                                                      if (!note-&gt;score()-&gt;addArticulation(note, art))</a>
<a name="ln1270">                                                            delete art;</a>
<a name="ln1271">                                                      }</a>
<a name="ln1272">                                                }</a>
<a name="ln1273">                                          QDomNode accentNode = currentNote.parentNode().firstChildElement(&quot;Accent&quot;);</a>
<a name="ln1274">                                          if (!accentNode.isNull()) {</a>
<a name="ln1275">                                                int value   = accentNode.toElement().text().toInt();</a>
<a name="ln1276">                                                SymId symId = SymId::articStaccatoAbove;</a>
<a name="ln1277">                                                switch (value) {</a>
<a name="ln1278">                                                      case 1: symId  = SymId::articStaccatoAbove; break;</a>
<a name="ln1279">                                                      case 2: symId  = SymId::articStaccatissimoAbove; break;</a>
<a name="ln1280">                                                      case 4: symId  = SymId::articMarcatoAbove; break;</a>
<a name="ln1281">                                                      case 8: symId  = SymId::articAccentAbove; break;</a>
<a name="ln1282">                                                      case 16: symId = SymId::articTenutoAbove; break;</a>
<a name="ln1283">                                                      }</a>
<a name="ln1284">                                                Articulation* art = new Articulation(note-&gt;score());</a>
<a name="ln1285">                                                art-&gt;setSymId(symId);</a>
<a name="ln1286">                                                if (!note-&gt;score()-&gt;addArticulation(note, art))</a>
<a name="ln1287">                                                      delete art;</a>
<a name="ln1288">                                                }</a>
<a name="ln1289">                                          QDomNode ornamentNode = currentNote.parentNode().firstChildElement(&quot;Ornament&quot;);</a>
<a name="ln1290">                                          if (!ornamentNode.isNull()) {</a>
<a name="ln1291">                                                QString value = ornamentNode.toElement().text();</a>
<a name="ln1292">                                                // guitar pro represents the turns the other way to what we do</a>
<a name="ln1293">                                                if (!value.compare(&quot;InvertedTurn&quot;)) {</a>
<a name="ln1294">                                                      Articulation* art = new Articulation(note-&gt;score());</a>
<a name="ln1295">                                                      art-&gt;setSymId(SymId::ornamentTurn);</a>
<a name="ln1296">                                                      if (!note-&gt;score()-&gt;addArticulation(note, art))</a>
<a name="ln1297">                                                            delete art;</a>
<a name="ln1298">                                                      }</a>
<a name="ln1299">                                                else if (!value.compare(&quot;Turn&quot;)) {</a>
<a name="ln1300">                                                      Articulation* art = new Articulation(note-&gt;score());</a>
<a name="ln1301">                                                      art-&gt;setSymId(SymId::ornamentTurnInverted);</a>
<a name="ln1302">                                                      if (!note-&gt;score()-&gt;addArticulation(note, art))</a>
<a name="ln1303">                                                            delete art;</a>
<a name="ln1304">                                                      }</a>
<a name="ln1305">                                                else if (!value.compare(&quot;LowerMordent&quot;)) {</a>
<a name="ln1306">                                                      Articulation* art = new Articulation(note-&gt;score());</a>
<a name="ln1307">                                                      art-&gt;setSymId(SymId::ornamentMordentInverted);</a>
<a name="ln1308">                                                      if (!note-&gt;score()-&gt;addArticulation(note, art))</a>
<a name="ln1309">                                                            delete art;</a>
<a name="ln1310">                                                      }</a>
<a name="ln1311">                                                else if (!value.compare(&quot;UpperMordent&quot;)) {</a>
<a name="ln1312">                                                      Articulation* art = new Articulation(note-&gt;score());</a>
<a name="ln1313">                                                      art-&gt;setSymId(SymId::ornamentMordent);</a>
<a name="ln1314">                                                      if (!note-&gt;score()-&gt;addArticulation(note, art))</a>
<a name="ln1315">                                                            delete art;</a>
<a name="ln1316">                                                      }</a>
<a name="ln1317">                                                }</a>
<a name="ln1318">                                          QDomNode propertiesNode = currentNode.parentNode().firstChildElement(&quot;Properties&quot;);</a>
<a name="ln1319">                                          if (!propertiesNode.isNull()) {</a>
<a name="ln1320">                                                QDomNode currentProperty1 = propertiesNode.firstChild();</a>
<a name="ln1321">                                                QString barreFret        = &quot;&quot;;</a>
<a name="ln1322">                                                bool halfBarre           = false;</a>
<a name="ln1323">                                                while (!currentProperty1.isNull()) {</a>
<a name="ln1324">                                                      QString argument = currentProperty1.attributes().namedItem(&quot;name&quot;).toAttr().value();</a>
<a name="ln1325">                                                      if (!argument.compare(&quot;PickStroke&quot;)) {</a>
<a name="ln1326">                                                            if (!currentProperty1.firstChild().toElement().text().compare(&quot;Up&quot;)) {</a>
<a name="ln1327">                                                                  Articulation* art = new Articulation(note-&gt;score());</a>
<a name="ln1328">                                                                  art-&gt;setSymId(SymId::stringsUpBow);</a>
<a name="ln1329">                                                                  if (!note-&gt;score()-&gt;addArticulation(note, art))</a>
<a name="ln1330">                                                                        delete art;</a>
<a name="ln1331">                                                                  }</a>
<a name="ln1332">                                                            else if (!currentProperty1.firstChild().toElement().text().compare(&quot;Down&quot;)) {</a>
<a name="ln1333">                                                                  Articulation* art = new Articulation(note-&gt;score());</a>
<a name="ln1334">                                                                  art-&gt;setSymId(SymId::stringsDownBow);</a>
<a name="ln1335">                                                                  if (!note-&gt;score()-&gt;addArticulation(note, art))</a>
<a name="ln1336">                                                                        delete art;</a>
<a name="ln1337">                                                                  }</a>
<a name="ln1338">                                                            }</a>
<a name="ln1339">                                                      else if (!argument.compare(&quot;Brush&quot;)) {</a>
<a name="ln1340">                                                            Arpeggio* a = new Arpeggio(score);</a>
<a name="ln1341">                                                            // directions in arpeggion type are reversed, they are correct below</a>
<a name="ln1342">                                                            if (!currentProperty1.firstChild().toElement().text().compare(&quot;Up&quot;))</a>
<a name="ln1343">                                                                  a-&gt;setArpeggioType(ArpeggioType::DOWN_STRAIGHT);</a>
<a name="ln1344">                                                            else if (!currentProperty1.firstChild().toElement().text().compare(&quot;Down&quot;))</a>
<a name="ln1345">                                                                  a-&gt;setArpeggioType(ArpeggioType::UP_STRAIGHT);</a>
<a name="ln1346">                                                            chord-&gt;add(a);</a>
<a name="ln1347">                                                            }</a>
<a name="ln1348">                                                      else if (!argument.compare(&quot;Slapped&quot;)) {</a>
<a name="ln1349">                                                            if (!currentProperty1.firstChild().nodeName().compare(&quot;Enable&quot;))</a>
<a name="ln1350">                                                                  addSlap(note);</a>
<a name="ln1351">                                                            }</a>
<a name="ln1352">                                                      else if (!argument.compare(&quot;Popped&quot;)) {</a>
<a name="ln1353">                                                            if (!currentProperty1.firstChild().nodeName().compare(&quot;Enable&quot;))</a>
<a name="ln1354">                                                                  addPop(note);</a>
<a name="ln1355">                                                            }</a>
<a name="ln1356">                                                      else if (!argument.compare(&quot;VibratoWTremBar&quot;)) {</a>
<a name="ln1357">                                                            if (!currentProperty1.firstChild().toElement().text().compare(&quot;Slight&quot;))</a>
<a name="ln1358">                                                                  addVibrato(note, Vibrato::Type::VIBRATO_SAWTOOTH);</a>
<a name="ln1359">                                                            else</a>
<a name="ln1360">                                                                  addVibrato(note, Vibrato::Type::VIBRATO_SAWTOOTH_WIDE);</a>
<a name="ln1361">                                                            }</a>
<a name="ln1362">                                                      else if (!argument.compare(&quot;BarreFret&quot;)) {</a>
<a name="ln1363">                                                            // target can be anywhere from 1 to 36</a>
<a name="ln1364">                                                            int target = currentProperty1.firstChild().toElement().text().toInt();</a>
<a name="ln1365">                                                            for (int i = 0; i &lt; (target / 10); i++)</a>
<a name="ln1366">                                                                  barreFret += &quot;X&quot;;</a>
<a name="ln1367">                                                            int targetMod10 = target % 10;</a>
<a name="ln1368">                                                            if (targetMod10 == 9)</a>
<a name="ln1369">                                                                  barreFret += &quot;IX&quot;;</a>
<a name="ln1370">                                                            else if (targetMod10 == 4)</a>
<a name="ln1371">                                                                  barreFret += &quot;IV&quot;;</a>
<a name="ln1372">                                                            else {</a>
<a name="ln1373">                                                                  if (targetMod10 &gt;= 5) {</a>
<a name="ln1374">                                                                        barreFret   += &quot;V&quot;;</a>
<a name="ln1375">                                                                        targetMod10 -= 5;</a>
<a name="ln1376">                                                                        }</a>
<a name="ln1377">                                                                  for (int j = 0; j &lt; targetMod10; j++)</a>
<a name="ln1378">                                                                        barreFret += &quot;I&quot;;</a>
<a name="ln1379">                                                                  }</a>
<a name="ln1380">                                                            }</a>
<a name="ln1381">                                                      else if (!argument.compare(&quot;BarreString&quot;))</a>
<a name="ln1382">                                                            halfBarre = true;</a>
<a name="ln1383">                                                      else if (!argument.compare(&quot;WhammyBarOriginValue&quot;))</a>
<a name="ln1384">                                                            whammyOrigin = currentProperty1.firstChild().toElement().text().toInt();</a>
<a name="ln1385">                                                      else if (!argument.compare(&quot;WhammyBarMiddleValue&quot;))</a>
<a name="ln1386">                                                            whammyMiddle = currentProperty1.firstChild().toElement().text().toInt();</a>
<a name="ln1387">                                                      else if (!argument.compare(&quot;WhammyBarDestinationValue&quot;))</a>
<a name="ln1388">                                                            whammyEnd = currentProperty1.firstChild().toElement().text().toInt();</a>
<a name="ln1389">                                                      currentProperty1 = currentProperty1.nextSibling();</a>
<a name="ln1390">                                                      }</a>
<a name="ln1391"> </a>
<a name="ln1392">                                                if (whammyOrigin != -1) {</a>
<a name="ln1393">                                                      // a whammy bar has been detected</a>
<a name="ln1394">                                                      addTremoloBar(segment, track, whammyOrigin, whammyMiddle, whammyEnd);</a>
<a name="ln1395">                                                      }</a>
<a name="ln1396"> </a>
<a name="ln1397">                                                // if a barre fret has been specified</a>
<a name="ln1398">                                                if (barreFret.compare(&quot;&quot;) &amp;&amp; lastChord != note-&gt;chord()) {</a>
<a name="ln1399">                                                      lastChord = note-&gt;chord();</a>
<a name="ln1400">                                                      if (halfBarre)</a>
<a name="ln1401">                                                            addTextToNote(&quot;1/2B &quot; + barreFret, Align::CENTER, note);</a>
<a name="ln1402">                                                      else</a>
<a name="ln1403">                                                            addTextToNote(&quot;B &quot; + barreFret, Align::CENTER, note);</a>
<a name="ln1404">                                                      }</a>
<a name="ln1405">                                                }</a>
<a name="ln1406">                                          QDomNode dynamicsNode = currentNode.parentNode().firstChildElement(&quot;Dynamic&quot;);</a>
<a name="ln1407">                                          if (!dynamicsNode.isNull()) {</a>
<a name="ln1408">                                                QString dynamicStr = dynamicsNode.toElement().text();</a>
<a name="ln1409">                                                int dynamic        = 0;</a>
<a name="ln1410">                                                if (!dynamicStr.compare(&quot;PPP&quot;))</a>
<a name="ln1411">                                                      dynamic = 1;</a>
<a name="ln1412">                                                else if (!dynamicStr.compare(&quot;PP&quot;))</a>
<a name="ln1413">                                                      dynamic = 2;</a>
<a name="ln1414">                                                else if (!dynamicStr.compare(&quot;P&quot;))</a>
<a name="ln1415">                                                      dynamic = 3;</a>
<a name="ln1416">                                                else if (!dynamicStr.compare(&quot;MP&quot;))</a>
<a name="ln1417">                                                      dynamic = 4;</a>
<a name="ln1418">                                                else if (!dynamicStr.compare(&quot;MF&quot;))</a>
<a name="ln1419">                                                      dynamic = 5;</a>
<a name="ln1420">                                                else if (!dynamicStr.compare(&quot;F&quot;))</a>
<a name="ln1421">                                                      dynamic = 6;</a>
<a name="ln1422">                                                else if (!dynamicStr.compare(&quot;FF&quot;))</a>
<a name="ln1423">                                                      dynamic = 7;</a>
<a name="ln1424">                                                else if (!dynamicStr.compare(&quot;FFF&quot;))</a>
<a name="ln1425">                                                      dynamic = 8;</a>
<a name="ln1426">                                                if (previousDynamic[track] != dynamic) {</a>
<a name="ln1427">                                                      previousDynamic[track] = dynamic;</a>
<a name="ln1428">                                                      addDynamic(note, dynamic);</a>
<a name="ln1429">                                                      }</a>
<a name="ln1430">                                                }</a>
<a name="ln1431">                                          /* while left and right fingering nodes have distinct values, they are represented</a>
<a name="ln1432">                                           * the same way w.r.t. identifying digit/char in the score file. */</a>
<a name="ln1433">                                          QDomNode leftFingeringNode  = currentNote.parentNode().firstChildElement(&quot;LeftFingering&quot;);</a>
<a name="ln1434">                                          QDomNode rightFingeringNode = currentNote.parentNode().firstChildElement(&quot;RightFingering&quot;);</a>
<a name="ln1435">                                          if (!leftFingeringNode.isNull() || !rightFingeringNode.isNull()) {</a>
<a name="ln1436">                                                QDomNode fingeringNode = leftFingeringNode.isNull() ? rightFingeringNode : leftFingeringNode;</a>
<a name="ln1437">                                                QString finger         = fingeringNode.toElement().text();</a>
<a name="ln1438">                                                Fingering* fi          = new Fingering(score);</a>
<a name="ln1439">                                                if (!leftFingeringNode.isNull()) {</a>
<a name="ln1440">                                                      if (!finger.compare(&quot;Open&quot;))</a>
<a name="ln1441">                                                            finger = &quot;O&quot;;</a>
<a name="ln1442">                                                      else if (!finger.compare(&quot;P&quot;))</a>
<a name="ln1443">                                                            finger = &quot;t&quot;;</a>
<a name="ln1444">                                                      else if (!finger.compare(&quot;I&quot;))</a>
<a name="ln1445">                                                            finger = &quot;1&quot;;</a>
<a name="ln1446">                                                      else if (!finger.compare(&quot;M&quot;))</a>
<a name="ln1447">                                                            finger = &quot;2&quot;;</a>
<a name="ln1448">                                                      else if (!finger.compare(&quot;A&quot;))</a>
<a name="ln1449">                                                            finger = &quot;3&quot;;</a>
<a name="ln1450">                                                      else if (!finger.compare(&quot;C&quot;))</a>
<a name="ln1451">                                                            finger = &quot;4&quot;;</a>
<a name="ln1452">                                                      }</a>
<a name="ln1453">                                                fi-&gt;setPlainText(finger);</a>
<a name="ln1454">                                                note-&gt;add(fi);</a>
<a name="ln1455">                                                fi-&gt;reset();</a>
<a name="ln1456">                                                }</a>
<a name="ln1457">                                          QDomNode arpeggioNode = currentNode.parentNode().firstChildElement(&quot;Arpeggio&quot;);</a>
<a name="ln1458">                                          if (!arpeggioNode.isNull()) {</a>
<a name="ln1459">                                                QString arpeggioStr = arpeggioNode.toElement().text();</a>
<a name="ln1460">                                                Arpeggio* a         = new Arpeggio(score);</a>
<a name="ln1461">                                                if (!arpeggioStr.compare(&quot;Up&quot;))</a>
<a name="ln1462">                                                      a-&gt;setArpeggioType(ArpeggioType::DOWN);</a>
<a name="ln1463">                                                else</a>
<a name="ln1464">                                                      a-&gt;setArpeggioType(ArpeggioType::NORMAL);</a>
<a name="ln1465">                                                chord-&gt;add(a);</a>
<a name="ln1466">                                                }</a>
<a name="ln1467">                                          QDomNode letRingNode = currentNote.parentNode().firstChildElement(&quot;LetRing&quot;);</a>
<a name="ln1468">                                          if (!letRingNode.isNull())</a>
<a name="ln1469">                                                addLetRing(note);</a>
<a name="ln1470">#if 0</a>
<a name="ln1471">                                          QDomNode timerNode = currentNode.parentNode().firstChildElement(&quot;Timer&quot;);</a>
<a name="ln1472">                                          if (!timerNode.isNull()) {</a>
<a name="ln1473">                                                int time = timerNode.toElement().text().toInt();</a>
<a name="ln1474">                                                TextStyle textStyle;</a>
<a name="ln1475">                                                textStyle.setAlign(Align::CENTER);</a>
<a name="ln1476">                                                textStyle.setUnderline(true);</a>
<a name="ln1477">                                                int minutes = time / 60;</a>
<a name="ln1478">                                                int seconds = time % 60;</a>
<a name="ln1479">                                                addTextToNote(QString::number(minutes) + &quot;:&quot; + (seconds &lt; 10 ? &quot;0&quot; + QString::number(seconds) : QString::number(seconds)), textStyle, note);</a>
<a name="ln1480">                                                }</a>
<a name="ln1481">#endif</a>
<a name="ln1482">                                          QDomNode textNode = currentNode.parentNode().firstChildElement(&quot;FreeText&quot;);</a>
<a name="ln1483">                                          if (!textNode.isNull()) {</a>
<a name="ln1484">                                                QString text      = textNode.toElement().text();</a>
<a name="ln1485">                                                bool t            = false;</a>
<a name="ln1486">                                                // do not add twice the same text per staff</a>
<a name="ln1487">                                                int strack = staffIdx * VOICES;</a>
<a name="ln1488">                                                int etrack = staffIdx * VOICES + VOICES;</a>
<a name="ln1489">                                                for (const Element* e : segment-&gt;annotations()) {</a>
<a name="ln1490">                                                      if (e-&gt;type() == ElementType::STAFF_TEXT &amp;&amp; e-&gt;track() &gt;= strack &amp;&amp; e-&gt;track() &lt; etrack) {</a>
<a name="ln1491">                                                            const StaffText* st = static_cast&lt;const StaffText*&gt;(e);</a>
<a name="ln1492">                                                            if (!st-&gt;xmlText().compare(text)) {</a>
<a name="ln1493">                                                                  t = true;</a>
<a name="ln1494">                                                                  break;</a>
<a name="ln1495">                                                                  }</a>
<a name="ln1496">                                                            }</a>
<a name="ln1497">                                                      }</a>
<a name="ln1498">                                                if (!t &amp;&amp; !text.isEmpty()) {</a>
<a name="ln1499">                                                      StaffText* s = new StaffText(score);</a>
<a name="ln1500">                                                      s-&gt;setPlainText(text);</a>
<a name="ln1501">                                                      s-&gt;setTrack(track);</a>
<a name="ln1502">                                                      segment-&gt;add(s);</a>
<a name="ln1503">                                                      }</a>
<a name="ln1504">                                                }</a>
<a name="ln1505">                                          QDomNode ghostNode = currentNote.parentNode().firstChildElement(&quot;AntiAccent&quot;);</a>
<a name="ln1506">                                          if (!ghostNode.isNull()) {</a>
<a name="ln1507">                                                note-&gt;setGhost(true);</a>
<a name="ln1508">                                                /*Symbol* leftSym = new Symbol(note-&gt;score());</a>
<a name="ln1509">                                                Symbol* rightSym = new Symbol(note-&gt;score());</a>
<a name="ln1510">                                                leftSym-&gt;setSym(SymId::noteheadParenthesisLeft);</a>
<a name="ln1511">                                                rightSym-&gt;setSym(SymId::noteheadParenthesisRight);</a>
<a name="ln1512">                                                leftSym-&gt;setParent(note);</a>
<a name="ln1513">                                                rightSym-&gt;setParent(note);</a>
<a name="ln1514">                                                note-&gt;add(leftSym);</a>
<a name="ln1515">                                                note-&gt;add(rightSym);*/</a>
<a name="ln1516">                                                }</a>
<a name="ln1517">                                          QDomNode swellNode = currentNode.parentNode().firstChildElement(&quot;Fadding&quot;);</a>
<a name="ln1518">                                          if (!swellNode.isNull()) {</a>
<a name="ln1519">                                                auto str          = swellNode.toElement().text();</a>
<a name="ln1520">                                                Articulation* art = new Articulation(note-&gt;score());</a>
<a name="ln1521">                                                if (str == &quot;FadeIn&quot;)</a>
<a name="ln1522">                                                      art-&gt;setSymId(SymId::guitarFadeIn);</a>
<a name="ln1523">                                                else if (str == &quot;FadeOut&quot;)</a>
<a name="ln1524">                                                      art-&gt;setSymId(SymId::guitarFadeOut);</a>
<a name="ln1525">                                                else if (str == &quot;VolumeSwell&quot;)</a>
<a name="ln1526">                                                      art-&gt;setSymId(SymId::guitarVolumeSwell);</a>
<a name="ln1527">                                                art-&gt;setAnchor(ArticulationAnchor::TOP_STAFF);</a>
<a name="ln1528">                                                art-&gt;setPropertyFlags(Pid::ARTICULATION_ANCHOR, PropertyFlags::UNSTYLED);</a>
<a name="ln1529">                                                if (!note-&gt;score()-&gt;addArticulation(note, art))</a>
<a name="ln1530">                                                      delete art;</a>
<a name="ln1531">                                                }</a>
<a name="ln1532">                                          QDomNode noteVibrato = currentNote.parentNode().firstChildElement(&quot;Vibrato&quot;);</a>
<a name="ln1533">                                          if (!noteVibrato.isNull()) {</a>
<a name="ln1534">                                                if (!noteVibrato.toElement().text().compare(&quot;Slight&quot;))</a>
<a name="ln1535">                                                      addVibrato(note, Vibrato::Type::GUITAR_VIBRATO);</a>
<a name="ln1536">                                                else</a>
<a name="ln1537">                                                      addVibrato(note, Vibrato::Type::GUITAR_VIBRATO_WIDE);</a>
<a name="ln1538">                                                }</a>
<a name="ln1539"> </a>
<a name="ln1540">                                          if (cr &amp;&amp; (cr-&gt;type() == ElementType::CHORD) &amp;&amp; sl &gt; 0)</a>
<a name="ln1541">                                                createSlide(sl, cr, staffIdx);</a>
<a name="ln1542">                                          note-&gt;setTpcFromPitch();</a>
<a name="ln1543"> </a>
<a name="ln1544">                                          /* if the ottava is a continuation (need to end old one), or we don't</a>
<a name="ln1545">                                          * see one in the current note when we are tracking one then end the ottava. */</a>
<a name="ln1546">                                          if (ottavaFound.at(track) == 2 || (ottavaFound.at(track) == 1 &amp;&amp; currentNode.parentNode().firstChildElement(&quot;Ottavia&quot;).isNull())) {</a>
<a name="ln1547">                                                createOttava(false, track, cr, ottavaValue.at(track));</a>
<a name="ln1548">                                                if (ottavaFound.at(track) == 2)</a>
<a name="ln1549">                                                      ottavaFound.at(track) = 1;</a>
<a name="ln1550">                                                else</a>
<a name="ln1551">                                                      ottavaFound.at(track) = 0;</a>
<a name="ln1552">                                                }</a>
<a name="ln1553">                                          if (ottavaFound.at(track)) {</a>
<a name="ln1554">                                                createOttava(true, track, cr, ottavaValue.at(track));</a>
<a name="ln1555">                                                int pitch       = note-&gt;pitch();</a>
<a name="ln1556">                                                OttavaType type = ottava.at(track)-&gt;ottavaType();</a>
<a name="ln1557">                                                if (type == OttavaType::OTTAVA_8VA)</a>
<a name="ln1558">                                                      note-&gt;setPitch( (pitch - 12 &gt; 0) ? pitch - 12 : pitch);</a>
<a name="ln1559">                                                else if (type == OttavaType::OTTAVA_8VB)</a>
<a name="ln1560">                                                      note-&gt;setPitch( (pitch + 12 &lt; 127) ? pitch + 12 : pitch);</a>
<a name="ln1561">                                                else if (type == OttavaType::OTTAVA_15MA)</a>
<a name="ln1562">                                                      note-&gt;setPitch( (pitch - 24 &gt; 0) ? pitch - 24 : (pitch - 12 &gt; 0 ? pitch - 12 : pitch));</a>
<a name="ln1563">                                                else if (type == OttavaType::OTTAVA_15MB)</a>
<a name="ln1564">                                                      note-&gt;setPitch( (pitch + 24 &lt; 127) ? pitch + 24 : ( (pitch + 12 &lt; 127) ? pitch + 12 :  pitch));</a>
<a name="ln1565">                                                }</a>
<a name="ln1566"> </a>
<a name="ln1567">                                          currentNote = currentNote.nextSibling();</a>
<a name="ln1568">                                          }</a>
<a name="ln1569">                                    else if (!currentNote.nodeName().compare(&quot;Trill&quot;)) {</a>
<a name="ln1570">                                          trill = true;</a>
<a name="ln1571">                                          }</a>
<a name="ln1572">                                    currentNote = currentNote.nextSibling();</a>
<a name="ln1573">                                    }</a>
<a name="ln1574"> </a>
<a name="ln1575">                              if (graceNote) {</a>
<a name="ln1576">                                    QDomNode graceNode = currentNode.parentNode().firstChildElement(&quot;GraceNotes&quot;);</a>
<a name="ln1577">                                    if (!graceNode.isNull()) {</a>
<a name="ln1578">                                          lyrNote-&gt;setTpcFromPitch();</a>
<a name="ln1579">                                          auto chord = lyrNote-&gt;chord();</a>
<a name="ln1580">                                          // before beat grace notes have to be handled after the Tpc is set from pitch</a>
<a name="ln1581">                                          if (!graceNode.toElement().text().compare(&quot;OnBeat&quot;)) {</a>
<a name="ln1582">                                                auto gNote = score-&gt;setGraceNote(chord, lyrNote-&gt;pitch(), NoteType::GRACE4, MScore::division / 2);</a>
<a name="ln1583">                                                auto iter1  = slideMap.end();</a>
<a name="ln1584">                                                for (auto beg = slideMap.begin(); beg != slideMap.end(); ++beg) {</a>
<a name="ln1585">                                                      if (beg-&gt;second == lyrNote) {</a>
<a name="ln1586">                                                            iter1 = beg;</a>
<a name="ln1587">                                                            break;</a>
<a name="ln1588">                                                            }</a>
<a name="ln1589">                                                      }</a>
<a name="ln1590">                                                if (iter1 != slideMap.end()) {</a>
<a name="ln1591">                                                      iter1-&gt;second = gNote;</a>
<a name="ln1592">                                                      createSlur(true, staffIdx, gNote-&gt;chord());</a>
<a name="ln1593">                                                      }</a>
<a name="ln1594">                                                if (lyrNote-&gt;chord()-&gt;notes().size() &gt; 1) {</a>
<a name="ln1595">                                                      lyrNote-&gt;chord()-&gt;remove(lyrNote);</a>
<a name="ln1596">                                                      delete lyrNote;</a>
<a name="ln1597">                                                      lyrNote = nullptr;</a>
<a name="ln1598">                                                      }</a>
<a name="ln1599">                                                }</a>
<a name="ln1600">                                          else if (!graceNode.toElement().text().compare(&quot;BeforeBeat&quot;) &amp;&amp; chord-&gt;type() == ElementType::CHORD) {</a>
<a name="ln1601">                                                auto gNote = score-&gt;setGraceNote(chord, lyrNote-&gt;pitch(), NoteType::ACCIACCATURA, MScore::division / 2);</a>
<a name="ln1602">                                                auto iter1  = slideMap.end();</a>
<a name="ln1603">                                                for (auto beg = slideMap.begin(); beg != slideMap.end(); ++beg) {</a>
<a name="ln1604">                                                      if (beg-&gt;second == lyrNote) {</a>
<a name="ln1605">                                                            iter1 = beg;</a>
<a name="ln1606">                                                            break;</a>
<a name="ln1607">                                                            }</a>
<a name="ln1608">                                                      }</a>
<a name="ln1609">                                                if (iter1 != slideMap.end()) {</a>
<a name="ln1610">                                                      iter1-&gt;second = gNote;</a>
<a name="ln1611">                                                      //slideMap.erase(iter);</a>
<a name="ln1612">                                                      //slideMap.insert({ { lyrNote-&gt;string(), lyrNote-&gt;staffIdx() }, gNote });</a>
<a name="ln1613">                                                      }</a>
<a name="ln1614">                                                //lyrNote-&gt;chord()-&gt;remove(lyrNote);</a>
<a name="ln1615">                                                //delete lyrNote;</a>
<a name="ln1616">                                                lyrNote = nullptr;</a>
<a name="ln1617">                                                }</a>
<a name="ln1618">                                          }</a>
<a name="ln1619">                                    }</a>
<a name="ln1620">                              continue;</a>
<a name="ln1621">                              }</a>
<a name="ln1622">                        }</a>
<a name="ln1623">                  else if (currentNode.nodeName() == &quot;Dynamic&quot;) {}</a>
<a name="ln1624">                  else if (!currentNode.nodeName().compare(&quot;Chord&quot;)) {</a>
<a name="ln1625">                        int k = currentNode.toElement().text().toInt();</a>
<a name="ln1626">                        if (fretDiagrams[k]) {</a>
<a name="ln1627">                              // TODO: free fretDiagrams</a>
<a name="ln1628">                              segment-&gt;add(new FretDiagram(*fretDiagrams[k]));</a>
<a name="ln1629">                              }</a>
<a name="ln1630">                        }</a>
<a name="ln1631">                  else if (currentNode.nodeName() == &quot;Timer&quot;) {</a>
<a name="ln1632">                        //int time    = currentNode.toElement().text().toInt();</a>
<a name="ln1633">                        //int minutes = time / 60;</a>
<a name="ln1634">                        //int seconds = time % 60;</a>
<a name="ln1635">                        //addTextToNote(QString::number(minutes) + &quot;:&quot; + (seconds &lt; 10 ? &quot;0&quot; + QString::number(seconds) : QString::number(seconds)), Align::CENTER, note); //TODO</a>
<a name="ln1636">                        }</a>
<a name="ln1637">                  else if (currentNode.nodeName() == &quot;Rhythm&quot;) {</a>
<a name="ln1638">                        // we have found a rhythm</a>
<a name="ln1639">                        QString refString     = currentNode.attributes().namedItem(&quot;ref&quot;).toAttr().value();</a>
<a name="ln1640">                        QDomNode rhythm       = getNode(refString, partInfo-&gt;rhythms);</a>
<a name="ln1641">                        QDomNode currentNode1 = (rhythm).firstChild();</a>
<a name="ln1642">                        while (!currentNode1.isNull()) {</a>
<a name="ln1643">                              if (currentNode1.nodeName() == &quot;NoteValue&quot;) {</a>
<a name="ln1644">                                    l = rhythmToDuration(currentNode1.toElement().text());</a>
<a name="ln1645">                                    }</a>
<a name="ln1646">                              else if (currentNode1.nodeName() == &quot;AugmentationDot&quot;) {</a>
<a name="ln1647">                                    dotted = currentNode1.attributes().namedItem(&quot;count&quot;).toAttr().value().toInt();</a>
<a name="ln1648">                                    Fraction tmp = l;</a>
<a name="ln1649">                                    for (int count = 1; count &lt;= dotted; count++)</a>
<a name="ln1650">                                          l = l + (tmp / Fraction(pow(2, count),1));</a>
<a name="ln1651">                                    }</a>
<a name="ln1652">                              else if (currentNode1.nodeName() == &quot;PrimaryTuplet&quot;) {</a>
<a name="ln1653">                                    tupletSet = true;</a>
<a name="ln1654">                                    cr        = new Chord(score);</a>
<a name="ln1655">                                    cr-&gt;setParent(segment);</a>
<a name="ln1656">                                    cr-&gt;setTrack(track);</a>
<a name="ln1657">                                    if ((tuplet == 0) || (tuplet-&gt;elementsDuration() == tuplet-&gt;baseLen().fraction() * tuplet-&gt;ratio().numerator())) {</a>
<a name="ln1658">                                          tuplet                           = new Tuplet(score);</a>
<a name="ln1659">                                          tuplet-&gt;setTick(currentTick);</a>
<a name="ln1660">                                          tuplets[staffIdx * VOICES + voiceNum] = tuplet;</a>
<a name="ln1661">                                          tuplet-&gt;setParent(measure);</a>
<a name="ln1662">                                          }</a>
<a name="ln1663">                                    tuplet-&gt;setTrack(cr-&gt;track());</a>
<a name="ln1664">                                    tuplet-&gt;setBaseLen(l);</a>
<a name="ln1665">                                    tuplet-&gt;setRatio(Fraction(currentNode1.attributes().namedItem(&quot;num&quot;).toAttr().value().toInt(),currentNode1.attributes().namedItem(&quot;den&quot;).toAttr().value().toInt()));</a>
<a name="ln1666">                                    setupTupletStyle(tuplet);</a>
<a name="ln1667">                                    tuplet-&gt;setTicks(l * tuplet-&gt;ratio().denominator());</a>
<a name="ln1668">                                    tuplet-&gt;add(cr);</a>
<a name="ln1669">                                    }</a>
<a name="ln1670">                              else</a>
<a name="ln1671">                                    qDebug() &lt;&lt; &quot;WARNING: Not handling node: &quot; &lt;&lt; currentNode1.nodeName();</a>
<a name="ln1672">                              currentNode1 = currentNode1.nextSibling();</a>
<a name="ln1673">                              }</a>
<a name="ln1674">                        fermataIndex += l;</a>
<a name="ln1675">                        }</a>
<a name="ln1676">                  else if (currentNode.nodeName() == &quot;Legato&quot;) {</a>
<a name="ln1677">                        QString origin = currentNode.attributes().namedItem(&quot;origin&quot;).toAttr().value();</a>
<a name="ln1678">                        QString destination = currentNode.attributes().namedItem(&quot;destination&quot;).toAttr().value();</a>
<a name="ln1679">                        if (!destination.compare(&quot;false&quot;) &amp;&amp; !origin.compare(&quot;true&quot;)) {</a>
<a name="ln1680">                              qDebug() &lt;&lt; &quot;origin&quot;;</a>
<a name="ln1681">                              startSlur = true;</a>
<a name="ln1682">                              }</a>
<a name="ln1683">                        else if (!destination.compare(&quot;true&quot;) &amp;&amp; !origin.compare(&quot;false&quot;)) {</a>
<a name="ln1684">                              qDebug() &lt;&lt; &quot;destination&quot;;</a>
<a name="ln1685">                              endSlur = true;</a>
<a name="ln1686">                              }</a>
<a name="ln1687">                        }</a>
<a name="ln1688">                  else if (currentNode.nodeName() == &quot;Hairpin&quot;) {</a>
<a name="ln1689">                        Segment* seg = segment-&gt;prev1(SegmentType::ChordRest);</a>
<a name="ln1690">                        bool isCrec  = !currentNode.toElement().text().compare(&quot;Crescendo&quot;);</a>
<a name="ln1691">                        if (seg &amp;&amp; hairpins[staffIdx]) {</a>
<a name="ln1692">                              if (hairpins[staffIdx]-&gt;tick2() == seg-&gt;tick() &amp;&amp;</a>
<a name="ln1693">                                 ((isCrec &amp;&amp; hairpins[staffIdx]-&gt;hairpinType() == HairpinType::CRESC_HAIRPIN) ||</a>
<a name="ln1694">                                 (!isCrec &amp;&amp; hairpins[staffIdx]-&gt;hairpinType() == HairpinType::DECRESC_HAIRPIN)))</a>
<a name="ln1695">                                    hairpins[staffIdx]-&gt;setTick2(currentTick);</a>
<a name="ln1696">                              else</a>
<a name="ln1697">                                    createCrecDim(staffIdx, track, currentTick, isCrec);</a>
<a name="ln1698">                              }</a>
<a name="ln1699">                        else</a>
<a name="ln1700">                              createCrecDim(staffIdx, track, currentTick, isCrec);</a>
<a name="ln1701">                        }</a>
<a name="ln1702">                  else if (!currentNode.nodeName().compare(&quot;Properties&quot;)) {</a>
<a name="ln1703">                        QDomNode currentProperty = currentNode.firstChild();</a>
<a name="ln1704">                        while (!currentProperty.isNull()) {</a>
<a name="ln1705">                              QString argument = currentProperty.attributes().namedItem(&quot;name&quot;).toAttr().value();</a>
<a name="ln1706">                              if (!argument.compare(&quot;Rasgueado&quot;)) {</a>
<a name="ln1707">                                    ChordRest* cr1 = segment-&gt;cr(track);</a>
<a name="ln1708">                                    if (cr1 &amp;&amp; cr1-&gt;isChord()) {</a>
<a name="ln1709">                                          Chord* c = toChord(cr1);</a>
<a name="ln1710">                                          addTextToNote(&quot;rasg.&quot;, Align::LEFT, c-&gt;upNote());</a>
<a name="ln1711">                                          }</a>
<a name="ln1712">#if 0</a>
<a name="ln1713">                                    StaffText* st = new StaffText(score);</a>
<a name="ln1714">                                    st-&gt;setTextStyleType(TextStyleType::STAFF);</a>
<a name="ln1715">                                    st-&gt;setXmlText(&quot;rasg.&quot;);</a>
<a name="ln1716">                                    st-&gt;setParent(segment);</a>
<a name="ln1717">                                    st-&gt;setTrack(track);</a>
<a name="ln1718">                                    score-&gt;addElement(st);</a>
<a name="ln1719">#endif</a>
<a name="ln1720">                                    }</a>
<a name="ln1721">                              currentProperty = currentProperty.nextSibling();</a>
<a name="ln1722">                              }</a>
<a name="ln1723">                        }</a>
<a name="ln1724">                  else if (!currentNode.nodeName().compare(&quot;Ottavia&quot;)) {</a>
<a name="ln1725">                        /* if we saw an ottava and have an updated</a>
<a name="ln1726">                        * information string, set to 2 indicating that. */</a>
<a name="ln1727">                        if (ottavaFound.at(track) == 1 &amp;&amp; ottavaValue.at(track).compare(currentNode.toElement().text()))</a>
<a name="ln1728">                              ottavaFound.at(track) = 2;</a>
<a name="ln1729">                        else</a>
<a name="ln1730">                              ottavaFound.at(track) = 1;</a>
<a name="ln1731">                        ottavaValue.at(track) = currentNode.toElement().text();</a>
<a name="ln1732">                        }</a>
<a name="ln1733">                  else if (currentNode.nodeName() == &quot;Lyrics&quot;) {</a>
<a name="ln1734">                        auto lyrNode = currentNode.firstChildElement(&quot;Line&quot;);</a>
<a name="ln1735">                        auto str     = lyrNode.toElement().text();</a>
<a name="ln1736">                        //if (lyrNote) lyrNote-&gt;setLyric(str);</a>
<a name="ln1737">                        auto lyr = new Lyrics(score);</a>
<a name="ln1738">                        lyr-&gt;setPlainText(str);</a>
<a name="ln1739">                        if (cr)</a>
<a name="ln1740">                              cr-&gt;add(lyr);</a>
<a name="ln1741">                        else</a>
<a name="ln1742">                              lyric = lyr;</a>
<a name="ln1743">                        }</a>
<a name="ln1744">                  else if (currentNode.nodeName() == &quot;FreeText&quot;) {</a>
<a name="ln1745">                        //TODO::</a>
<a name="ln1746">#if 0</a>
<a name="ln1747">                        auto str = currentNode.toElement().text();</a>
<a name="ln1748">                        auto lyr = new Lyrics(score);</a>
<a name="ln1749">                        lyr-&gt;setPlainText(str);</a>
<a name="ln1750">                        cr-&gt;add(lyr);</a>
<a name="ln1751">                        if (lyrNote)</a>
<a name="ln1752">                              lyrNote-&gt;setLyric(str);</a>
<a name="ln1753">                        else {</a>
<a name="ln1754">                              auto nt = beat.firstChildElement(&quot;Notes&quot;);</a>
<a name="ln1755">                              if (!nt.isNull()) {</a>
<a name="ln1756">                                    auto notelist = nt.toElement().text().split(' ');</a>
<a name="ln1757">                                    lyrics[notelist.first().toInt()] = str;</a>
<a name="ln1758">                                    }</a>
<a name="ln1759">                              }</a>
<a name="ln1760">#endif</a>
<a name="ln1761">                        }</a>
<a name="ln1762">                  currentNode = currentNode.nextSibling();</a>
<a name="ln1763">                  }</a>
<a name="ln1764">            dotted = 0;</a>
<a name="ln1765">            if (graceNote)</a>
<a name="ln1766">                  continue;</a>
<a name="ln1767">            // we have handled the beat - was there a note?</a>
<a name="ln1768">            if (!noteSpecified) {</a>
<a name="ln1769">                  // add a rest with length of l</a>
<a name="ln1770">                  // we already have a chord, delete it first</a>
<a name="ln1771">                  ChordRest* prevCr = cr; // added in &quot;Rhythm&quot;</a>
<a name="ln1772">                  cr = new Rest(score);</a>
<a name="ln1773">                  if (track % VOICES != 0)</a>
<a name="ln1774">                        wrong_pause = true;</a>
<a name="ln1775">                  cr-&gt;setTrack(track);</a>
<a name="ln1776">                  if (tupletSet) {</a>
<a name="ln1777">                        tuplet-&gt;remove(prevCr);</a>
<a name="ln1778">                        delete prevCr;</a>
<a name="ln1779">                        tuplet-&gt;add(cr);</a>
<a name="ln1780">                        }</a>
<a name="ln1781">                  cr-&gt;setTicks(l);</a>
<a name="ln1782">                  if (cr-&gt;type() == ElementType::REST &amp;&amp; l &gt;= measure-&gt;ticks()) {</a>
<a name="ln1783">                        cr-&gt;setDurationType(TDuration::DurationType::V_MEASURE);</a>
<a name="ln1784">                        cr-&gt;setTicks(measure-&gt;ticks());</a>
<a name="ln1785">                        }</a>
<a name="ln1786">                  else {</a>
<a name="ln1787">                        TDuration d(l);</a>
<a name="ln1788">                        cr-&gt;setDurationType(d);</a>
<a name="ln1789">                        }</a>
<a name="ln1790">                  if (!segment-&gt;cr(track))</a>
<a name="ln1791">                        segment-&gt;add(cr);</a>
<a name="ln1792">                  }</a>
<a name="ln1793">            auto fermataList = fermatas.find(measureCounter);</a>
<a name="ln1794">            if (fermataList != fermatas.end()) {</a>
<a name="ln1795">                  // iterator is a list of GPFermata values</a>
<a name="ln1796">                  //for (auto fermataIter = (*fermataList)-&gt;begin(); fermataIter != (*fermataList)-&gt;end(); fermataIter++) {</a>
<a name="ln1797"> </a>
<a name="ln1798">                  auto fermataIter     = (*fermataList)-&gt;begin();</a>
<a name="ln1799">                  Fraction targetIndex = fermataToFraction((*fermataIter).index, ((*fermataIter).timeDivision));</a>
<a name="ln1800">                  if (fermataIndex == targetIndex) {</a>
<a name="ln1801">                        Articulation* art = new Articulation(score);</a>
<a name="ln1802">                        art-&gt;setSymId(SymId::fermataAbove);</a>
<a name="ln1803">                        if (fermataIter-&gt;type == &quot;Long&quot;)</a>
<a name="ln1804">                              art-&gt;setSymId(SymId::fermataLongAbove);</a>
<a name="ln1805">                        art-&gt;setUp(true);</a>
<a name="ln1806">                        art-&gt;setAnchor(ArticulationAnchor::TOP_STAFF);</a>
<a name="ln1807">                        art-&gt;setPropertyFlags(Pid::ARTICULATION_ANCHOR, PropertyFlags::UNSTYLED);</a>
<a name="ln1808">                        auto seg = cr-&gt;segment()-&gt;prev1(SegmentType::ChordRest);</a>
<a name="ln1809">                        if (seg &amp;&amp; seg-&gt;cr(track)-&gt;isChord()) {</a>
<a name="ln1810">                              seg-&gt;cr(track)-&gt;add(art);</a>
<a name="ln1811">                              }</a>
<a name="ln1812">                        else</a>
<a name="ln1813">                              cr-&gt;add(art);</a>
<a name="ln1814">                        }</a>
<a name="ln1815">                  //}</a>
<a name="ln1816">                  }</a>
<a name="ln1817">            beatsTick += cr-&gt;actualTicks();</a>
<a name="ln1818">            }</a>
<a name="ln1819"> </a>
<a name="ln1820">      if (wrong_pause) {</a>
<a name="ln1821">            _lastTick = beatsTick;</a>
<a name="ln1822">            return Fraction(-1,1);</a>
<a name="ln1823">            }</a>
<a name="ln1824">      return beatsTick;</a>
<a name="ln1825">      }</a>
<a name="ln1826"> </a>
<a name="ln1827">//---------------------------------------------------------</a>
<a name="ln1828">//   readBars</a>
<a name="ln1829">//---------------------------------------------------------</a>
<a name="ln1830"> </a>
<a name="ln1831">void GuitarPro6::readBars(QDomNode* barList, Measure* measure, ClefType oldClefId[], GPPartInfo* partInfo, int measureCounter)</a>
<a name="ln1832">      {</a>
<a name="ln1833">      // unique bar identifiers are represented as a space separated string of numbers</a>
<a name="ln1834">      QStringList barsString = barList-&gt;toElement().text().split(&quot; &quot;);</a>
<a name="ln1835">      int staffIdx           = 0;</a>
<a name="ln1836"> </a>
<a name="ln1837">      // used to keep track of tuplets</a>
<a name="ln1838">      std::vector&lt;Tuplet*&gt; tuplets(staves * VOICES);</a>
<a name="ln1839">      for (int track = 0; track &lt; staves * VOICES; ++track)</a>
<a name="ln1840">            tuplets[track] = 0;</a>
<a name="ln1841"> </a>
<a name="ln1842">      // iterate through all the bars that have been specified</a>
<a name="ln1843">      for (auto iter = barsString.begin(); iter != barsString.end(); ++iter) {</a>
<a name="ln1844">            Fraction tick = measure-&gt;tick();</a>
<a name="ln1845"> </a>
<a name="ln1846">            QDomNode barNode     = getNode(*iter, partInfo-&gt;bars);</a>
<a name="ln1847">            QDomNode currentNode = (barNode).firstChild();</a>
<a name="ln1848">            QDomNode voice;</a>
<a name="ln1849">            while (!currentNode.isNull()) {</a>
<a name="ln1850">                  voice.clear();</a>
<a name="ln1851">                  // get the clef of the bar and apply</a>
<a name="ln1852">                  if (!currentNode.nodeName().compare(&quot;Clef&quot;)) {</a>
<a name="ln1853">                        QString clefString = currentNode.toElement().text();</a>
<a name="ln1854">                        QDomNode nextNode  = currentNode.nextSibling();</a>
<a name="ln1855">                        QString clefOctave;</a>
<a name="ln1856">                        if (!nextNode.nodeName().compare(&quot;Ottavia&quot;))</a>
<a name="ln1857">                              clefOctave = nextNode.toElement().text();</a>
<a name="ln1858">                        ClefType clefId = ClefType::G;</a>
<a name="ln1859">                        if (!clefString.compare(&quot;F4&quot;)) {</a>
<a name="ln1860">                              clefId = ClefType::F;</a>
<a name="ln1861">                              if (clefOctave == &quot;8va&quot;)</a>
<a name="ln1862">                                    clefId = ClefType::F_8VA;</a>
<a name="ln1863">                              else if (clefOctave == &quot;8vb&quot;)</a>
<a name="ln1864">                                    clefId = ClefType::F8_VB;</a>
<a name="ln1865">                              else if (clefOctave == &quot;15ma&quot;)</a>
<a name="ln1866">                                    clefId = ClefType::F_15MA;</a>
<a name="ln1867">                              else if (clefOctave == &quot;15mb&quot;)</a>
<a name="ln1868">                                    clefId = ClefType::F15_MB;</a>
<a name="ln1869">                              }</a>
<a name="ln1870">                        else if (!clefString.compare(&quot;G2&quot;)) {</a>
<a name="ln1871">                              clefId = ClefType::G;</a>
<a name="ln1872">                              if (clefOctave == &quot;8va&quot;)</a>
<a name="ln1873">                                    clefId = ClefType::G8_VA;</a>
<a name="ln1874">                              else if (clefOctave == &quot;8vb&quot;)</a>
<a name="ln1875">                                    clefId = ClefType::G8_VB;</a>
<a name="ln1876">                              else if (clefOctave == &quot;15ma&quot;)</a>
<a name="ln1877">                                    clefId = ClefType::G15_MA;</a>
<a name="ln1878">                              else if (clefOctave == &quot;15mb&quot;)</a>
<a name="ln1879">                                    clefId = ClefType::G15_MB;</a>
<a name="ln1880">                              }</a>
<a name="ln1881">                        else if (!clefString.compare(&quot;C3&quot;))</a>
<a name="ln1882">                              clefId = ClefType::C3;</a>
<a name="ln1883">                        else if (!clefString.compare(&quot;C4&quot;))</a>
<a name="ln1884">                              clefId = ClefType::C4;</a>
<a name="ln1885">                        else if (!clefString.compare(&quot;Neutral&quot;))</a>
<a name="ln1886">                              clefId = ClefType::PERC;</a>
<a name="ln1887">                        else</a>
<a name="ln1888">                              qDebug() &lt;&lt; &quot;WARNING: unhandled clef type: &quot; &lt;&lt; clefString;</a>
<a name="ln1889">                        Clef* newClef = new Clef(score);</a>
<a name="ln1890">                        newClef-&gt;setClefType(clefId);</a>
<a name="ln1891">                        newClef-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln1892">                        // only add the clef to the bar if it differs from previous measure</a>
<a name="ln1893">                        if (measure-&gt;prevMeasure()) {</a>
<a name="ln1894">                              if (clefId != oldClefId[staffIdx]) {</a>
<a name="ln1895">                                    Segment* segment = measure-&gt;getSegment(SegmentType::Clef, tick);</a>
<a name="ln1896">                                    segment-&gt;add(newClef);</a>
<a name="ln1897">                                    oldClefId[staffIdx] = clefId;</a>
<a name="ln1898">                                    }</a>
<a name="ln1899">                              else</a>
<a name="ln1900">                                    delete newClef;</a>
<a name="ln1901">                              }</a>
<a name="ln1902">                        else {</a>
<a name="ln1903">                              Segment* segment = measure-&gt;getSegment(SegmentType::HeaderClef, Fraction(0,1));</a>
<a name="ln1904">                              segment-&gt;add(newClef);</a>
<a name="ln1905">                              oldClefId[staffIdx] = clefId;</a>
<a name="ln1906">                              }</a>
<a name="ln1907">                        }</a>
<a name="ln1908">                  // a repeated bar (simile marking)</a>
<a name="ln1909">                  else if (!currentNode.nodeName().compare(&quot;SimileMark&quot;)) {</a>
<a name="ln1910">                        if (!currentNode.toElement().text().compare(&quot;Simple&quot;) ||</a>
<a name="ln1911">                           !currentNode.toElement().text().compare(&quot;FirstOfDouble&quot;) ||</a>
<a name="ln1912">                           !currentNode.toElement().text().compare(&quot;SecondOfDouble&quot;)) {</a>
<a name="ln1913">                              RepeatMeasure* rm = new RepeatMeasure(score);</a>
<a name="ln1914">                              rm-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln1915">                              rm-&gt;setTicks(measure-&gt;ticks());</a>
<a name="ln1916">                              rm-&gt;setDurationType(TDuration::DurationType::V_MEASURE);</a>
<a name="ln1917">                              Segment* segment = measure-&gt;getSegment(SegmentType::ChordRest, tick);</a>
<a name="ln1918">                              segment-&gt;add(rm);</a>
<a name="ln1919">                              }</a>
<a name="ln1920">                        else</a>
<a name="ln1921">                              qDebug() &lt;&lt; &quot;WARNING: unhandle similie mark type: &quot; &lt;&lt; currentNode.toElement().text();</a>
<a name="ln1922">                        }</a>
<a name="ln1923">                  // new voice specification</a>
<a name="ln1924">                  else if (!currentNode.nodeName().compare(&quot;Voices&quot;)) {</a>
<a name="ln1925">                        QString voicesString = currentNode.toElement().text();</a>
<a name="ln1926">                        auto voices          = voicesString.split(&quot; &quot;);</a>
<a name="ln1927">                        bool contentAdded    = false;</a>
<a name="ln1928">                        int voiceNum         = -1;</a>
<a name="ln1929">                        for (auto currentVoice : voices) {</a>
<a name="ln1930">                              // if the voice is not -1 then we set voice</a>
<a name="ln1931">                              if (currentVoice.compare(&quot;-1&quot;))</a>
<a name="ln1932">                                    voice = getNode(currentVoice, partInfo-&gt;voices);</a>
<a name="ln1933">                              voiceNum += 1;</a>
<a name="ln1934">                              if (currentVoice.toInt() == -1) {</a>
<a name="ln1935">                                    if (contentAdded) continue;</a>
<a name="ln1936">                                    Fraction l = measure-&gt;ticks();</a>
<a name="ln1937">                                    // add a rest with length of l</a>
<a name="ln1938">                                    ChordRest* cr = new Rest(score);</a>
<a name="ln1939">                                    cr-&gt;setTrack(staffIdx * VOICES + voiceNum);</a>
<a name="ln1940">                                    cr-&gt;setTicks(l);</a>
<a name="ln1941">                                    cr-&gt;setDurationType(TDuration::DurationType::V_MEASURE);</a>
<a name="ln1942">                                    Segment* segment = measure-&gt;getSegment(SegmentType::ChordRest, tick);</a>
<a name="ln1943">                                    if(!segment-&gt;cr(staffIdx * VOICES + voiceNum))</a>
<a name="ln1944">                                          segment-&gt;add(cr);</a>
<a name="ln1945">                                    contentAdded = true;</a>
<a name="ln1946">                                    continue;</a>
<a name="ln1947">                                    }</a>
<a name="ln1948">                              // read the beats that occur in the bar</a>
<a name="ln1949">                              Fraction ticks = readBeats(voice.firstChild().toElement().text(), partInfo, measure, tick, staffIdx, voiceNum, &amp;tuplets[0], measureCounter);</a>
<a name="ln1950">                              if (ticks &gt; Fraction(0,1))</a>
<a name="ln1951">                                    contentAdded = true;</a>
<a name="ln1952">                              // deal with possible anacrusis</a>
<a name="ln1953">                              if (ticks &lt; measure-&gt;ticks() &amp;&amp; voiceNum == 0) {</a>
<a name="ln1954">                                    Fraction mticks = measure-&gt;ticks();</a>
<a name="ln1955">                                    Fraction tickOffSet = mticks - ticks;</a>
<a name="ln1956">                                    int track            = staffIdx * VOICES + voiceNum;</a>
<a name="ln1957">                                    score-&gt;setRest(ticks + measure-&gt;tick(), track, tickOffSet, true, nullptr, true);</a>
<a name="ln1958">                                    }</a>
<a name="ln1959">                              }</a>
<a name="ln1960">                        }</a>
<a name="ln1961">                  else if (!currentNode.nodeName().compare(&quot;XProperties&quot;)) {}</a>
<a name="ln1962">                  // go to the next node in the tree</a>
<a name="ln1963">                  currentNode = currentNode.nextSibling();</a>
<a name="ln1964">                  }</a>
<a name="ln1965">            // increment the counter for parts</a>
<a name="ln1966">            staffIdx++;</a>
<a name="ln1967">            }</a>
<a name="ln1968">      }</a>
<a name="ln1969"> </a>
<a name="ln1970">//---------------------------------------------------------</a>
<a name="ln1971">//   checkForHeld</a>
<a name="ln1972">//---------------------------------------------------------</a>
<a name="ln1973"> </a>
<a name="ln1974">bool checkForHold(Segment* segment, QList&lt;PitchValue&gt; points)</a>
<a name="ln1975">      {</a>
<a name="ln1976">      bool same        = false;</a>
<a name="ln1977">      Segment* prevSeg = segment-&gt;prev1(SegmentType::ChordRest);</a>
<a name="ln1978">      if (!prevSeg)</a>
<a name="ln1979">            return false;</a>
<a name="ln1980">      foreach (Element* e, prevSeg-&gt;annotations()) {</a>
<a name="ln1981">            if (e-&gt;type() == ElementType::TREMOLOBAR) {</a>
<a name="ln1982">                  QList&lt;PitchValue&gt; prevPoints = ((TremoloBar*)e)-&gt;points();</a>
<a name="ln1983">                  if (prevPoints.length() != points.length())</a>
<a name="ln1984">                        break;</a>
<a name="ln1985"> </a>
<a name="ln1986">                  auto iter = points.begin();</a>
<a name="ln1987">                  for (auto prevIter = prevPoints.begin(); prevIter != prevPoints.end(); ++prevIter) {</a>
<a name="ln1988">                        if (*prevIter == *iter)</a>
<a name="ln1989">                              same = true;</a>
<a name="ln1990">                        else {</a>
<a name="ln1991">                              same = false;</a>
<a name="ln1992">                              break;</a>
<a name="ln1993">                              }</a>
<a name="ln1994">                        ++iter;</a>
<a name="ln1995">                        }</a>
<a name="ln1996">                  }</a>
<a name="ln1997">            }</a>
<a name="ln1998">      return same;</a>
<a name="ln1999">      }</a>
<a name="ln2000"> </a>
<a name="ln2001">//---------------------------------------------------------</a>
<a name="ln2002">//   addTremoloBar</a>
<a name="ln2003">//---------------------------------------------------------</a>
<a name="ln2004"> </a>
<a name="ln2005">void GuitarPro6::addTremoloBar(Segment* segment, int track, int whammyOrigin, int whammyMiddle, int whammyEnd)</a>
<a name="ln2006">      {</a>
<a name="ln2007">      if (whammyOrigin == 0 &amp;&amp; whammyMiddle == 0 &amp;&amp; whammyEnd == 0)</a>
<a name="ln2008">            return;</a>
<a name="ln2009">      if ((whammyOrigin == whammyEnd) &amp;&amp; (whammyOrigin != whammyMiddle) &amp;&amp; whammyMiddle != -1) {</a>
<a name="ln2010">            /* we are dealing with a dip. We need the check for whammy middle</a>
<a name="ln2011">             * to be set as a predive has the same characteristics. */</a>
<a name="ln2012">            QList&lt;PitchValue&gt; points;</a>
<a name="ln2013">            points.append(PitchValue(0, whammyOrigin, false));</a>
<a name="ln2014">            points.append(PitchValue(50, whammyMiddle, false));</a>
<a name="ln2015">            points.append(PitchValue(100, whammyEnd, false));</a>
<a name="ln2016">            TremoloBar* b = new TremoloBar(score);</a>
<a name="ln2017">            b-&gt;setPoints(points);</a>
<a name="ln2018">            b-&gt;setTrack(track);</a>
<a name="ln2019">            segment-&gt;add(b);</a>
<a name="ln2020">            }</a>
<a name="ln2021">      else if (whammyOrigin == 0) {</a>
<a name="ln2022">            // we're dealing with a dive that does not continue from a previous marking</a>
<a name="ln2023">            QList&lt;PitchValue&gt; points;</a>
<a name="ln2024">            points.append(PitchValue(0, whammyOrigin, false));</a>
<a name="ln2025">            points.append(PitchValue(50, whammyMiddle, false));</a>
<a name="ln2026">            points.append(PitchValue(100, whammyEnd, false));</a>
<a name="ln2027">            TremoloBar* b = new TremoloBar(score);</a>
<a name="ln2028">            b-&gt;setPoints(points);</a>
<a name="ln2029">            b-&gt;setTrack(track);</a>
<a name="ln2030">            segment-&gt;add(b);</a>
<a name="ln2031">            }</a>
<a name="ln2032">      else if (whammyOrigin == whammyEnd &amp;&amp; whammyMiddle == -1) {</a>
<a name="ln2033">            // this deals with a pre-dive</a>
<a name="ln2034">            QList&lt;PitchValue&gt; points;</a>
<a name="ln2035">            points.append(PitchValue(0, 0, false));</a>
<a name="ln2036">            points.append(PitchValue(50, whammyOrigin, false));</a>
<a name="ln2037">            points.append(PitchValue(100, whammyEnd, false));</a>
<a name="ln2038">            TremoloBar* b = new TremoloBar(score);</a>
<a name="ln2039">            b-&gt;setPoints(points);</a>
<a name="ln2040">            b-&gt;setTrack(track);</a>
<a name="ln2041">            segment-&gt;add(b);</a>
<a name="ln2042">            }</a>
<a name="ln2043">      else if (whammyMiddle != -1) {</a>
<a name="ln2044">            // dive starting from pre-existing point</a>
<a name="ln2045">            Segment* prevSeg = segment-&gt;prev1(SegmentType::ChordRest);</a>
<a name="ln2046">            if (!prevSeg)</a>
<a name="ln2047">                  return;</a>
<a name="ln2048">            foreach (Element* e, prevSeg-&gt;annotations()) {</a>
<a name="ln2049">                  if (e-&gt;type() == ElementType::TREMOLOBAR) {</a>
<a name="ln2050">                        QList&lt;PitchValue&gt; prevPoints = ((TremoloBar*)e)-&gt;points();</a>
<a name="ln2051">                        QList&lt;PitchValue&gt; points;</a>
<a name="ln2052">                        points.append(PitchValue(0, prevPoints[prevPoints.length() - 1].pitch, false));</a>
<a name="ln2053">                        points.append(PitchValue(50, whammyOrigin, false));</a>
<a name="ln2054">                        points.append(PitchValue(100, whammyEnd, false));</a>
<a name="ln2055">                        TremoloBar* b = new TremoloBar(score);</a>
<a name="ln2056">                        b-&gt;setPoints(points);</a>
<a name="ln2057">                        b-&gt;setTrack(track);</a>
<a name="ln2058">                        segment-&gt;add(b);</a>
<a name="ln2059">                        }</a>
<a name="ln2060">                  }</a>
<a name="ln2061">            }</a>
<a name="ln2062">      else {</a>
<a name="ln2063">            // a predive/dive</a>
<a name="ln2064">            QList&lt;PitchValue&gt; points;</a>
<a name="ln2065">            points.append(PitchValue(0, 0, false));</a>
<a name="ln2066">            points.append(PitchValue(50, whammyOrigin, false));</a>
<a name="ln2067">            points.append(PitchValue(100, whammyEnd, false));</a>
<a name="ln2068"> </a>
<a name="ln2069">            if (checkForHold(segment, points)) {</a>
<a name="ln2070">                  points.clear();</a>
<a name="ln2071">                  points.append(PitchValue(0, whammyEnd, false));</a>
<a name="ln2072">                  points.append(PitchValue(100, whammyEnd, false));</a>
<a name="ln2073">                  }</a>
<a name="ln2074"> </a>
<a name="ln2075">            TremoloBar* b = new TremoloBar(score);</a>
<a name="ln2076">            b-&gt;setPoints(points);</a>
<a name="ln2077">            b-&gt;setTrack(track);</a>
<a name="ln2078">            segment-&gt;add(b);</a>
<a name="ln2079">            }</a>
<a name="ln2080">      }</a>
<a name="ln2081"> </a>
<a name="ln2082">//---------------------------------------------------------</a>
<a name="ln2083">//   readMasterBars</a>
<a name="ln2084">//---------------------------------------------------------</a>
<a name="ln2085"> </a>
<a name="ln2086">void GuitarPro6::readMasterBars(GPPartInfo* partInfo)</a>
<a name="ln2087">      {</a>
<a name="ln2088">      Measure* measure       = score-&gt;firstMeasure();</a>
<a name="ln2089">      int bar                = 0;</a>
<a name="ln2090">      QDomNode nextMasterBar = partInfo-&gt;masterBars;</a>
<a name="ln2091">      nextMasterBar = nextMasterBar.nextSibling();</a>
<a name="ln2092">      int measureCounter = 0;</a>
<a name="ln2093">      //int last_counter   = -1, last_counter2 = -1, max_counter = -1;</a>
<a name="ln2094">      std::vector&lt;ClefType&gt; oldClefId(staves);</a>
<a name="ln2095">      //ClefType oldClefId[staves];</a>
<a name="ln2096">      hairpins = new Hairpin*[staves];</a>
<a name="ln2097">      for (int i = 0; i &lt; staves; i++)</a>
<a name="ln2098">            hairpins[i] = 0;</a>
<a name="ln2099">      do    {</a>
<a name="ln2100">            const GpBar&amp; gpbar = bars[bar];</a>
<a name="ln2101"> </a>
<a name="ln2102">            if (!gpbar.marker.isEmpty()) {</a>
<a name="ln2103">                  RehearsalMark* s = new RehearsalMark(score);</a>
<a name="ln2104">                  s-&gt;setPlainText(gpbar.marker.trimmed());</a>
<a name="ln2105">                  s-&gt;setTrack(0);</a>
<a name="ln2106">                  Segment* segment = measure-&gt;getSegment(SegmentType::ChordRest, measure-&gt;tick());</a>
<a name="ln2107">                  segment-&gt;add(s);</a>
<a name="ln2108">                  }</a>
<a name="ln2109"> </a>
<a name="ln2110">            QDomNode masterBarElementTemplate = nextMasterBar.firstChild();</a>
<a name="ln2111">            for (int stave = 0; stave &lt; staves; stave++) {</a>
<a name="ln2112">                  QDomNode masterBarElement = masterBarElementTemplate;</a>
<a name="ln2113">                  bool first                = true;</a>
<a name="ln2114">                  while (!masterBarElement.isNull()) {</a>
<a name="ln2115">                        if (first) {</a>
<a name="ln2116">                              if (bars[measureCounter].freeTime /*&amp;&amp; last_counter != measureCounter*/) {</a>
<a name="ln2117">                                    //last_counter = measureCounter;</a>
<a name="ln2118">                                    bool previousFreeTime = (measureCounter &gt; 0 &amp;&amp; bars[measureCounter - 1].freeTime);</a>
<a name="ln2119">                                    bool sameTimeSig = measureCounter &gt; 0 &amp;&amp; (bars[measureCounter - 1].timesig == bars[measureCounter].timesig);</a>
<a name="ln2120">                                    if (!sameTimeSig) {</a>
<a name="ln2121">                                          TimeSig* ts = new TimeSig(score);</a>
<a name="ln2122">                                          ts-&gt;setSig(bars[measureCounter].timesig);</a>
<a name="ln2123">                                          ts-&gt;setTrack(stave);</a>
<a name="ln2124">                                          Measure* m = score-&gt;getCreateMeasure(measure-&gt;tick());</a>
<a name="ln2125">                                          Segment* s = m-&gt;getSegment(SegmentType::TimeSig, measure-&gt;tick());</a>
<a name="ln2126">                                          ts-&gt;setLargeParentheses(true);</a>
<a name="ln2127">                                          s-&gt;add(ts);</a>
<a name="ln2128">                                          // no text for two consecutive freetime timesig</a>
<a name="ln2129">                                          if (!previousFreeTime) {</a>
<a name="ln2130">                                                StaffText* st = new StaffText(score);</a>
<a name="ln2131">                                                st-&gt;setXmlText(&quot;Free time&quot;);</a>
<a name="ln2132">                                                s = m-&gt;getSegment(SegmentType::ChordRest, measure-&gt;tick());</a>
<a name="ln2133">                                                st-&gt;setParent(s);</a>
<a name="ln2134">                                                st-&gt;setTrack(stave);</a>
<a name="ln2135">                                                score-&gt;addElement(st);</a>
<a name="ln2136">                                                }</a>
<a name="ln2137">                                          }</a>
<a name="ln2138">                                    }</a>
<a name="ln2139">                              else if (measureCounter &gt; 0 &amp;&amp; bars[measureCounter - 1].freeTime) {</a>
<a name="ln2140">                                    TimeSig* ts = new TimeSig(score);</a>
<a name="ln2141">                                    ts-&gt;setSig(bars[measureCounter].timesig);</a>
<a name="ln2142">                                    ts-&gt;setTrack(stave);</a>
<a name="ln2143">                                    Measure* m = score-&gt;getCreateMeasure(measure-&gt;tick());</a>
<a name="ln2144">                                    Segment* s = m-&gt;getSegment(SegmentType::TimeSig, measure-&gt;tick());</a>
<a name="ln2145">                                    ts-&gt;setLargeParentheses(false);</a>
<a name="ln2146">                                    s-&gt;add(ts);</a>
<a name="ln2147">                                    }</a>
<a name="ln2148">                              else</a>
<a name="ln2149">                                    measure-&gt;setTimesig(bars[measureCounter].timesig);</a>
<a name="ln2150">                              measure-&gt;setTicks(bars[measureCounter].timesig);</a>
<a name="ln2151">                              }</a>
<a name="ln2152"> </a>
<a name="ln2153">                        if (!bars[measureCounter].direction.compare(&quot;Fine&quot;) || (bars[measureCounter].direction.compare(&quot;&quot;) &amp;&amp; !bars[measureCounter].directionStyle.compare(&quot;Jump&quot;))) {</a>
<a name="ln2154">                              Segment* s    = measure-&gt;getSegment(SegmentType::KeySig, measure-&gt;tick());</a>
<a name="ln2155">                              StaffText* st = new StaffText(score);</a>
<a name="ln2156">                              if (!bars[measureCounter].direction.compare(&quot;Fine&quot;))</a>
<a name="ln2157">                                    st-&gt;setXmlText(&quot;fine&quot;);</a>
<a name="ln2158">                              else if (!bars[measureCounter].direction.compare(&quot;DaCapo&quot;))</a>
<a name="ln2159">                                    st-&gt;setXmlText(&quot;Da Capo&quot;);</a>
<a name="ln2160">                              else if (!bars[measureCounter].direction.compare(&quot;DaCapoAlCoda&quot;))</a>
<a name="ln2161">                                    st-&gt;setXmlText(&quot;D.C. al Coda&quot;);</a>
<a name="ln2162">                              else if (!bars[measureCounter].direction.compare(&quot;DaCapoAlDoubleCoda&quot;))</a>
<a name="ln2163">                                    st-&gt;setXmlText(&quot;D.C. al Double Coda&quot;);</a>
<a name="ln2164">                              else if (!bars[measureCounter].direction.compare(&quot;DaCapoAlFine&quot;))</a>
<a name="ln2165">                                    st-&gt;setXmlText(&quot;D.C. al Fine&quot;);</a>
<a name="ln2166">                              else if (!bars[measureCounter].direction.compare(&quot;DaSegnoAlCoda&quot;))</a>
<a name="ln2167">                                    st-&gt;setXmlText(&quot;D.S. al Coda&quot;);</a>
<a name="ln2168">                              else if (!bars[measureCounter].direction.compare(&quot;DaSegno&quot;))</a>
<a name="ln2169">                                    st-&gt;setXmlText(&quot;Da Segno&quot;);</a>
<a name="ln2170">                              else if (!bars[measureCounter].direction.compare(&quot;DaSegnoAlDoubleCoda&quot;))</a>
<a name="ln2171">                                    st-&gt;setXmlText(&quot;D.S. al Double Coda&quot;);</a>
<a name="ln2172">                              else if (!bars[measureCounter].direction.compare(&quot;DaSegnoAlFine&quot;))</a>
<a name="ln2173">                                    st-&gt;setXmlText(&quot;D.S. al Fine&quot;);</a>
<a name="ln2174">                              else if (!bars[measureCounter].direction.compare(&quot;DaSegnoSegno&quot;))</a>
<a name="ln2175">                                    st-&gt;setXmlText(&quot;Da Segno Segno&quot;);</a>
<a name="ln2176">                              else if (!bars[measureCounter].direction.compare(&quot;DaSegnoSegnoAlCoda&quot;))</a>
<a name="ln2177">                                    st-&gt;setXmlText(&quot;D.S.S. al Coda&quot;);</a>
<a name="ln2178">                              else if (!bars[measureCounter].direction.compare(&quot;DaSegnoSegnoAlDoubleCoda&quot;))</a>
<a name="ln2179">                                    st-&gt;setXmlText(&quot;D.S.S. al Double Coda&quot;);</a>
<a name="ln2180">                              else if (!bars[measureCounter].direction.compare(&quot;DaSegnoSegnoAlFine&quot;))</a>
<a name="ln2181">                                    st-&gt;setXmlText(&quot;D.S.S. al Fine&quot;);</a>
<a name="ln2182">                              else if (!bars[measureCounter].direction.compare(&quot;DaCoda&quot;))</a>
<a name="ln2183">                                    st-&gt;setXmlText(&quot;Da Coda&quot;);</a>
<a name="ln2184">                              else if (!bars[measureCounter].direction.compare(&quot;DaDoubleCoda&quot;))</a>
<a name="ln2185">                                    st-&gt;setXmlText(&quot;Da Double Coda&quot;);</a>
<a name="ln2186">                              st-&gt;setParent(s);</a>
<a name="ln2187">                              st-&gt;setTrack(stave);</a>
<a name="ln2188">                              score-&gt;addElement(st);</a>
<a name="ln2189">                              bars[measureCounter].direction = &quot;&quot;;</a>
<a name="ln2190">                              }</a>
<a name="ln2191">                        else if (bars[measureCounter].direction.compare(&quot;&quot;) &amp;&amp; !bars[measureCounter].directionStyle.compare(&quot;Target&quot;)) {</a>
<a name="ln2192">                              Segment* s  = measure-&gt;getSegment(SegmentType::BarLine, measure-&gt;tick());</a>
<a name="ln2193">                              Symbol* sym = new Symbol(score);</a>
<a name="ln2194">                              if (!bars[measureCounter].direction.compare(&quot;Segno&quot;))</a>
<a name="ln2195">                                    sym-&gt;setSym(SymId::segno);</a>
<a name="ln2196">                              else if (!bars[measureCounter].direction.compare(&quot;SegnoSegno&quot;)) {</a>
<a name="ln2197">                                    sym-&gt;setSym(SymId::segno);</a>
<a name="ln2198">                                    Segment* s2  = measure-&gt;getSegment(SegmentType::ChordRest, measure-&gt;tick());</a>
<a name="ln2199">                                    Symbol* sym2 = new Symbol(score);</a>
<a name="ln2200">                                    sym2-&gt;setSym(SymId::segno);</a>
<a name="ln2201">                                    sym2-&gt;setParent(measure);</a>
<a name="ln2202">                                    sym2-&gt;setTrack(stave);</a>
<a name="ln2203">                                    s2-&gt;add(sym2);</a>
<a name="ln2204">                                    }</a>
<a name="ln2205">                              else if (!bars[measureCounter].direction.compare(&quot;Coda&quot;))</a>
<a name="ln2206">                                    sym-&gt;setSym(SymId::coda);</a>
<a name="ln2207">                              else if (!bars[measureCounter].direction.compare(&quot;DoubleCoda&quot;)) {</a>
<a name="ln2208">                                    sym-&gt;setSym(SymId::coda);</a>
<a name="ln2209">                                    Segment* s2  = measure-&gt;getSegment(SegmentType::ChordRest, measure-&gt;tick());</a>
<a name="ln2210">                                    Symbol* sym2 = new Symbol(score);</a>
<a name="ln2211">                                    sym2-&gt;setSym(SymId::coda);</a>
<a name="ln2212">                                    sym2-&gt;setParent(measure);</a>
<a name="ln2213">                                    sym2-&gt;setTrack(stave);</a>
<a name="ln2214">                                    s2-&gt;add(sym2);</a>
<a name="ln2215">                                    }</a>
<a name="ln2216">                              sym-&gt;setParent(measure);</a>
<a name="ln2217">                              sym-&gt;setTrack(stave);</a>
<a name="ln2218">                              s-&gt;add(sym);</a>
<a name="ln2219">                              bars[measureCounter].direction = &quot;&quot;;</a>
<a name="ln2220">                              }</a>
<a name="ln2221">#if 0</a>
<a name="ln2222">                        if (first &amp;&amp; measureCounter &gt; max_counter) {</a>
<a name="ln2223">                              max_counter = measureCounter;</a>
<a name="ln2224">                              first       = false;</a>
<a name="ln2225">                              int counter = -1;</a>
<a name="ln2226">                              for (auto&amp; dir : bars[measureCounter].directions) {</a>
<a name="ln2227">                                    ++counter;</a>
<a name="ln2228">                                    if (!dir.compare(&quot;Fine&quot;) || !bars[measureCounter].directionStyle.compare(&quot;Jump&quot;)) {</a>
<a name="ln2229">                                          Segment* s    = measure-&gt;getSegment(SegmentType::KeySig, measure-&gt;tick());</a>
<a name="ln2230">                                          StaffText* st = new StaffText(score);</a>
<a name="ln2231">                                          if (!dir.compare(&quot;Fine&quot;))</a>
<a name="ln2232">                                                st-&gt;setXmlText(&quot;fine&quot;);</a>
<a name="ln2233">                                          else if (!dir.compare(&quot;DaCapo&quot;))</a>
<a name="ln2234">                                                st-&gt;setXmlText(&quot;Da Capo&quot;);</a>
<a name="ln2235">                                          else if (!dir.compare(&quot;DaCapoAlCoda&quot;))</a>
<a name="ln2236">                                                st-&gt;setXmlText(&quot;D.C. al Coda&quot;);</a>
<a name="ln2237">                                          else if (!dir.compare(&quot;DaCapoAlDoubleCoda&quot;))</a>
<a name="ln2238">                                                st-&gt;setXmlText(&quot;D.C. al Double Coda&quot;);</a>
<a name="ln2239">                                          else if (!dir.compare(&quot;DaCapoAlFine&quot;))</a>
<a name="ln2240">                                                st-&gt;setXmlText(&quot;D.C. al Fine&quot;);</a>
<a name="ln2241">                                          else if (!dir.compare(&quot;DaSegnoAlCoda&quot;))</a>
<a name="ln2242">                                                st-&gt;setXmlText(&quot;D.S. al Coda&quot;);</a>
<a name="ln2243">                                          else if (!dir.compare(&quot;DaSegno&quot;))</a>
<a name="ln2244">                                                st-&gt;setXmlText(&quot;Da Segno&quot;);</a>
<a name="ln2245">                                          else if (!dir.compare(&quot;DaSegnoAlDoubleCoda&quot;))</a>
<a name="ln2246">                                                st-&gt;setXmlText(&quot;D.S. al Double Coda&quot;);</a>
<a name="ln2247">                                          else if (!dir.compare(&quot;DaSegnoAlFine&quot;))</a>
<a name="ln2248">                                                st-&gt;setXmlText(&quot;D.S. al Fine&quot;);</a>
<a name="ln2249">                                          else if (!dir.compare(&quot;DaSegnoSegno&quot;))</a>
<a name="ln2250">                                                st-&gt;setXmlText(&quot;Da Segno Segno&quot;);</a>
<a name="ln2251">                                          else if (!dir.compare(&quot;DaSegnoSegnoAlCoda&quot;))</a>
<a name="ln2252">                                                st-&gt;setXmlText(&quot;D.S.S. al Coda&quot;);</a>
<a name="ln2253">                                          else if (!dir.compare(&quot;DaSegnoSegnoAlDoubleCoda&quot;))</a>
<a name="ln2254">                                                st-&gt;setXmlText(&quot;D.S.S. al Double Coda&quot;);</a>
<a name="ln2255">                                          else if (!dir.compare(&quot;DaSegnoSegnoAlFine&quot;))</a>
<a name="ln2256">                                                st-&gt;setXmlText(&quot;D.S.S. al Fine&quot;);</a>
<a name="ln2257">                                          else if (!dir.compare(&quot;DaCoda&quot;))</a>
<a name="ln2258">                                                st-&gt;setXmlText(&quot;Da Coda&quot;);</a>
<a name="ln2259">                                          else if (!dir.compare(&quot;DaDoubleCoda&quot;))</a>
<a name="ln2260">                                                st-&gt;setXmlText(&quot;Da Double Coda&quot;);</a>
<a name="ln2261">                                          st-&gt;setParent(s);</a>
<a name="ln2262">                                          st-&gt;setTrack(stave);</a>
<a name="ln2263">                                          score-&gt;addElement(st);</a>
<a name="ln2264">                                          //bars[measureCounter].direction = &quot;&quot;;</a>
<a name="ln2265">                                          }</a>
<a name="ln2266">                                    else if (!bars[measureCounter].directionStyle.compare(&quot;Target&quot;)) {</a>
<a name="ln2267">                                          Segment* s  = measure-&gt;getSegment(SegmentType::BarLine, measure-&gt;tick());</a>
<a name="ln2268">                                          Symbol* sym = new Symbol(score);</a>
<a name="ln2269">                                          if (!dir.compare(&quot;Segno&quot;))</a>
<a name="ln2270">                                                sym-&gt;setSym(SymId::segno);</a>
<a name="ln2271">                                          else if (!dir.compare(&quot;SegnoSegno&quot;)) {</a>
<a name="ln2272">                                                sym-&gt;setSym(SymId::segnoSerpent2);</a>
<a name="ln2273">                                                /* Segment* s2 = measure-&gt;getSegment(SegmentType::ChordRest, measure-&gt;tick());</a>
<a name="ln2274">                                                 Symbol* sym2 = new Symbol(score);</a>
<a name="ln2275">                                                 sym2-&gt;setSym(SymId::segno);</a>
<a name="ln2276">                                                 sym2-&gt;setParent(measure);</a>
<a name="ln2277">                                                 sym2-&gt;setTrack(stave);</a>
<a name="ln2278">                                                 sym2-&gt;setXoffset(5.5f);</a>
<a name="ln2279">                                                 sym2-&gt;setElYOffset(-7.0f * counter);</a>
<a name="ln2280">                                                 s2-&gt;add(sym2);*/</a>
<a name="ln2281">                                                }</a>
<a name="ln2282">                                          else if (!dir.compare(&quot;Coda&quot;))</a>
<a name="ln2283">                                                sym-&gt;setSym(SymId::coda);</a>
<a name="ln2284">                                          else if (!dir.compare(&quot;DoubleCoda&quot;)) {</a>
<a name="ln2285">                                                sym-&gt;setSym(SymId::codaSquare);</a>
<a name="ln2286">                                                /*  Segment* s2 = measure-&gt;getSegment(SegmentType::ChordRest, measure-&gt;tick());</a>
<a name="ln2287">                                                  Symbol* sym2 = new Symbol(score);</a>
<a name="ln2288">                                                  sym2-&gt;setSym(SymId::coda);</a>
<a name="ln2289">                                                  sym2-&gt;setParent(measure);</a>
<a name="ln2290">                                                  sym2-&gt;setTrack(stave);</a>
<a name="ln2291">                                                  sym2-&gt;setXoffset(8.0f);</a>
<a name="ln2292">                                                  sym2-&gt;setElYOffset(-7.0f * counter);</a>
<a name="ln2293">                                                  s2-&gt;add(sym2);*/</a>
<a name="ln2294">                                                }</a>
<a name="ln2295">                                          sym-&gt;setParent(measure);</a>
<a name="ln2296">                                          sym-&gt;setTrack(stave);</a>
<a name="ln2297">                                          s-&gt;add(sym);</a>
<a name="ln2298">                                          bars[measureCounter].direction = &quot;&quot;;</a>
<a name="ln2299">                                          }</a>
<a name="ln2300">                                    }</a>
<a name="ln2301">                              }</a>
<a name="ln2302">#endif</a>
<a name="ln2303">                        // we no longer set the key here, the gpbar has the information stored in it</a>
<a name="ln2304">                        if (!masterBarElement.nodeName().compare(&quot;Fermatas&quot;)) {</a>
<a name="ln2305">                              QDomNode currentFermata = masterBarElement.firstChild();</a>
<a name="ln2306">                              while (!currentFermata.isNull()) {</a>
<a name="ln2307">                                    QString fermata = currentFermata.lastChildElement(&quot;Offset&quot;).toElement().text();</a>
<a name="ln2308">                                    auto type       = currentFermata.lastChildElement(&quot;Type&quot;);</a>
<a name="ln2309">                                    currentFermata = currentFermata.nextSibling();</a>
<a name="ln2310"> </a>
<a name="ln2311">                                    // get the fermata information and construct a gpFermata from them</a>
<a name="ln2312">                                    QStringList fermataComponents = fermata.split(&quot;/&quot;, QString::SkipEmptyParts);</a>
<a name="ln2313">                                    GPFermata gpFermata;</a>
<a name="ln2314">                                    gpFermata.index        = fermataComponents.at(0).toInt();</a>
<a name="ln2315">                                    gpFermata.timeDivision = fermataComponents.at(1).toInt();</a>
<a name="ln2316"> </a>
<a name="ln2317">                                    if (!type.isNull())</a>
<a name="ln2318">                                          gpFermata.type = type.toElement().text();</a>
<a name="ln2319">                                    else</a>
<a name="ln2320">                                          gpFermata.type = &quot;Medium&quot;;</a>
<a name="ln2321"> </a>
<a name="ln2322">                                    if (fermatas.contains(measureCounter)) {</a>
<a name="ln2323">                                          QList&lt;GPFermata&gt;* fermataList = fermatas.value(measureCounter);</a>
<a name="ln2324">                                          fermataList-&gt;push_back(gpFermata);</a>
<a name="ln2325">                                          }</a>
<a name="ln2326">                                    else {</a>
<a name="ln2327">                                          QList&lt;GPFermata&gt;* fermataList = new QList&lt;GPFermata&gt;;</a>
<a name="ln2328">                                          fermataList-&gt;push_back(gpFermata);</a>
<a name="ln2329">                                          fermatas.insert(measureCounter, fermataList);</a>
<a name="ln2330">                                          }</a>
<a name="ln2331">                                    }</a>
<a name="ln2332">                              }</a>
<a name="ln2333">                        else if (!masterBarElement.nodeName().compare(&quot;Repeat&quot;)) {</a>
<a name="ln2334">                              bool start = !masterBarElement.attributes().namedItem(&quot;start&quot;).toAttr().value().compare(&quot;true&quot;);</a>
<a name="ln2335">                              int count  = masterBarElement.attributes().namedItem(&quot;count&quot;).toAttr().value().toInt();</a>
<a name="ln2336">                              if (start)</a>
<a name="ln2337">                                    measure-&gt;setRepeatStart(true);</a>
<a name="ln2338">                              else</a>
<a name="ln2339">                                    measure-&gt;setRepeatEnd(true);</a>
<a name="ln2340">                              measure-&gt;setRepeatCount(count);</a>
<a name="ln2341">                              }</a>
<a name="ln2342">                        else if (!masterBarElement.nodeName().compare(&quot;AlternateEndings&quot;) /*&amp;&amp; measureCounter != last_counter2*/) {</a>
<a name="ln2343">                              //last_counter2 = measureCounter;</a>
<a name="ln2344">                              QString endNumbers = masterBarElement.toElement().text().replace(&quot; &quot;, &quot;,&quot;);</a>
<a name="ln2345">                              bool create        = true;</a>
<a name="ln2346">                              if (_lastVolta) {</a>
<a name="ln2347">                                    auto prevm = measure-&gt;prevMeasure();</a>
<a name="ln2348">                                    if (prevm-&gt;endBarLineType() != BarLineType::START_REPEAT &amp;&amp; (_lastVolta-&gt;tick2() == prevm-&gt;tick() + prevm-&gt;ticks() )</a>
<a name="ln2349">                                       &amp;&amp;(_lastVolta-&gt;text() == endNumbers) ) {</a>
<a name="ln2350">                                          create = false;</a>
<a name="ln2351">                                          _lastVolta-&gt;setTick2(measure-&gt;tick() + measure-&gt;ticks());</a>
<a name="ln2352">                                          }</a>
<a name="ln2353">                                    }</a>
<a name="ln2354">                              if (create) {</a>
<a name="ln2355">                                    Ms::Volta* volta = new Ms::Volta(score);</a>
<a name="ln2356">                                    volta-&gt;endings().clear();</a>
<a name="ln2357">                                    volta-&gt;setText(endNumbers);</a>
<a name="ln2358">                                    volta-&gt;setTick(measure-&gt;tick());</a>
<a name="ln2359">                                    volta-&gt;setTick2(measure-&gt;tick() + measure-&gt;ticks());</a>
<a name="ln2360"> </a>
<a name="ln2361">                                    QList&lt;int&gt; endings;</a>
<a name="ln2362">                                    const char* c = endNumbers.toUtf8().constData();</a>
<a name="ln2363">                                    while (c &amp;&amp; *c)</a>
<a name="ln2364">                                          {</a>
<a name="ln2365">                                          if (*c &gt;= '0' &amp;&amp; *c &lt;= '9')</a>
<a name="ln2366">                                                volta-&gt;endings().push_back(int(*c - '0'));</a>
<a name="ln2367">                                          ++c;</a>
<a name="ln2368">                                          }</a>
<a name="ln2369"> </a>
<a name="ln2370">                                    _lastVolta = volta;</a>
<a name="ln2371">                                    score-&gt;addElement(volta);</a>
<a name="ln2372">                                    }</a>
<a name="ln2373">                              }</a>
<a name="ln2374">                        else if (!masterBarElement.nodeName().compare(&quot;Bars&quot;) &amp;&amp; stave == staves - 1) {</a>
<a name="ln2375">                              readBars(&amp;masterBarElement, measure, &amp;oldClefId[0], partInfo, measureCounter);</a>
<a name="ln2376">                              for (int i = 0; i &lt; staves * VOICES; ++i) {</a>
<a name="ln2377">                                    Ottava* o = ottava.at(i);</a>
<a name="ln2378">                                    if (o &amp;&amp; o-&gt;ticks().isZero())</a>
<a name="ln2379">                                          o-&gt;setTick2(score-&gt;endTick());</a>
<a name="ln2380">                                    Slur* slur = legatos[i];</a>
<a name="ln2381">                                    if (slur) {</a>
<a name="ln2382">                                          if (measure-&gt;prevMeasure() &amp;&amp; !measure-&gt;hasVoice(i)) {</a>
<a name="ln2383">                                                //find last chord in track</a>
<a name="ln2384">                                                Chord* c = nullptr;</a>
<a name="ln2385">                                                for (const Segment* seg = measure-&gt;prevMeasure()-&gt;last(); seg; seg = seg-&gt;prev1()) {</a>
<a name="ln2386">                                                      Element* el = seg-&gt;element(i);</a>
<a name="ln2387">                                                      if (el &amp;&amp; el-&gt;isChord()) {</a>
<a name="ln2388">                                                            c = static_cast&lt;Chord*&gt;(el);</a>
<a name="ln2389">                                                            break;</a>
<a name="ln2390">                                                            }</a>
<a name="ln2391">                                                      }</a>
<a name="ln2392">                                                if (c) {</a>
<a name="ln2393">                                                      slur-&gt;setTick2(c-&gt;tick());</a>
<a name="ln2394">                                                      score-&gt;addElement(slur);</a>
<a name="ln2395">                                                      legatos[slur-&gt;track()] = 0;</a>
<a name="ln2396">                                                      }</a>
<a name="ln2397">                                                }</a>
<a name="ln2398">                                          }</a>
<a name="ln2399">                                    }</a>
<a name="ln2400">                              }</a>
<a name="ln2401">                        masterBarElement = masterBarElement.nextSibling();</a>
<a name="ln2402">                        first = false;</a>
<a name="ln2403">                        }</a>
<a name="ln2404">                  }</a>
<a name="ln2405">            if (bars[measureCounter].section[0].length() || bars[measureCounter].section[1].length()) {</a>
<a name="ln2406">                  Segment* s = measure-&gt;getSegment(SegmentType::ChordRest, measure-&gt;tick());</a>
<a name="ln2407">                  if (bars[measureCounter].section[0].length()) {</a>
<a name="ln2408">                        RehearsalMark* t = new RehearsalMark(score);</a>
<a name="ln2409">                        t-&gt;setFrameType(FrameType::SQUARE);</a>
<a name="ln2410">                        t-&gt;setPlainText(bars[measureCounter].section[0]);</a>
<a name="ln2411">                        t-&gt;setTrack(0);</a>
<a name="ln2412">                        s-&gt;add(t);</a>
<a name="ln2413">                        }</a>
<a name="ln2414">                  if (bars[measureCounter].section[1].length()) {</a>
<a name="ln2415">                        RehearsalMark* t = new RehearsalMark(score);</a>
<a name="ln2416">                        t-&gt;setFrameType(FrameType::NO_FRAME);</a>
<a name="ln2417">                        t-&gt;setPlainText(bars[measureCounter].section[1]);</a>
<a name="ln2418">                        t-&gt;setTrack(0);</a>
<a name="ln2419">                        s-&gt;add(t);</a>
<a name="ln2420">                        }</a>
<a name="ln2421">                  }</a>
<a name="ln2422">            measureCounter++;</a>
<a name="ln2423">            nextMasterBar = nextMasterBar.nextSibling();</a>
<a name="ln2424">            measure       = measure-&gt;nextMeasure();</a>
<a name="ln2425">            bar++;</a>
<a name="ln2426">            } while (!nextMasterBar.isNull());</a>
<a name="ln2427">      }</a>
<a name="ln2428"> </a>
<a name="ln2429">//---------------------------------------------------------</a>
<a name="ln2430">//   readGpif</a>
<a name="ln2431">//---------------------------------------------------------</a>
<a name="ln2432"> </a>
<a name="ln2433">void GuitarPro6::readGpif(QByteArray* data)</a>
<a name="ln2434">      {</a>
<a name="ln2435">      // qDebug() &lt;&lt; QString(*data);</a>
<a name="ln2436">      QDomDocument qdomDoc;</a>
<a name="ln2437">      qdomDoc.setContent(*data);</a>
<a name="ln2438">      QDomElement qdomElem = qdomDoc.documentElement();</a>
<a name="ln2439">      // GPRevision node</a>
<a name="ln2440">      QDomNode revision = qdomElem.firstChildElement(&quot;GPRevision&quot;);</a>
<a name="ln2441">      // Score node</a>
<a name="ln2442">      QDomNode scoreNode = qdomElem.firstChildElement(&quot;Score&quot;);</a>
<a name="ln2443">      readScore(&amp;scoreNode);</a>
<a name="ln2444">      // MasterTrack node</a>
<a name="ln2445">      QDomNode masterTrack = qdomElem.firstChildElement(&quot;MasterTrack&quot;);</a>
<a name="ln2446">      readMasterTracks(&amp;masterTrack);</a>
<a name="ln2447">      // Tracks node</a>
<a name="ln2448">      QDomNode eachTrack = qdomElem.firstChildElement(&quot;Tracks&quot;);</a>
<a name="ln2449">      readTracks(&amp;eachTrack);</a>
<a name="ln2450"> </a>
<a name="ln2451">      // now we know how many staves there are from readTracks, we can initialise slurs (for hammer/pulloff)</a>
<a name="ln2452">       // and legatos</a>
<a name="ln2453">      slurs = new Slur*[staves * VOICES];</a>
<a name="ln2454">      legatos = new Slur*[staves * VOICES];</a>
<a name="ln2455">      ottava.assign(staves * VOICES, 0);</a>
<a name="ln2456">      ottavaFound.assign(staves * VOICES, 0);</a>
<a name="ln2457">      ottavaValue.assign(staves * VOICES, &quot;&quot;);</a>
<a name="ln2458">      for (int i = 0; i &lt; staves * VOICES; ++i) {</a>
<a name="ln2459">            slurs[i] = 0;</a>
<a name="ln2460">            legatos[i] = 0;</a>
<a name="ln2461">            }</a>
<a name="ln2462"> </a>
<a name="ln2463">      // MasterBars node</a>
<a name="ln2464">      GPPartInfo partInfo;</a>
<a name="ln2465">      QDomNode masterBars = eachTrack.nextSibling();</a>
<a name="ln2466">      QDomNode b          = masterBars.nextSibling();</a>
<a name="ln2467">      QDomNode voices     = b.nextSibling();</a>
<a name="ln2468">      QDomNode beats      = voices.nextSibling();</a>
<a name="ln2469">      QDomNode notes      = beats.nextSibling();</a>
<a name="ln2470">      QDomNode rhythms    = notes.nextSibling();</a>
<a name="ln2471"> </a>
<a name="ln2472">      // set up the partInfo struct to contain information from the file</a>
<a name="ln2473">      partInfo.masterBars = masterBars.firstChild();</a>
<a name="ln2474">      partInfo.bars       = b.firstChild();</a>
<a name="ln2475">      partInfo.voices     = voices.firstChild();</a>
<a name="ln2476">      partInfo.beats      = beats.firstChild();</a>
<a name="ln2477">      partInfo.notes      = notes.firstChild();</a>
<a name="ln2478">      partInfo.rhythms    = rhythms.firstChild();</a>
<a name="ln2479"> </a>
<a name="ln2480">      measures = findNumMeasures(&amp;partInfo);</a>
<a name="ln2481"> </a>
<a name="ln2482">      createMeasures();</a>
<a name="ln2483">      fermatas.clear();</a>
<a name="ln2484">      readMasterBars(&amp;partInfo);</a>
<a name="ln2485">      // complete slurs (GP6 sometimes output destination=true even for last beat)</a>
<a name="ln2486">      for (int i = 0; i &lt; staves * VOICES; ++i) {</a>
<a name="ln2487">            Slur* slur = legatos[i];</a>
<a name="ln2488">            if (slur) {</a>
<a name="ln2489">                  //find last chord in track</a>
<a name="ln2490">                  Chord* c = nullptr;</a>
<a name="ln2491">                  for (const Segment* seg = score-&gt;lastSegment(); seg; seg = seg-&gt;prev1()) {</a>
<a name="ln2492">                        Element* el = seg-&gt;element(i);</a>
<a name="ln2493">                        if (el &amp;&amp; el-&gt;isChord()) {</a>
<a name="ln2494">                              c = static_cast&lt;Chord*&gt;(el);</a>
<a name="ln2495">                              break;</a>
<a name="ln2496">                              }</a>
<a name="ln2497">                        }</a>
<a name="ln2498">                  if (c) {</a>
<a name="ln2499">                        slur-&gt;setTick2(c-&gt;tick());</a>
<a name="ln2500">                        score-&gt;addElement(slur);</a>
<a name="ln2501">                        legatos[slur-&gt;track()] = 0;</a>
<a name="ln2502">                        }</a>
<a name="ln2503">                  else {</a>
<a name="ln2504">                        delete slur;</a>
<a name="ln2505">                        legatos[slur-&gt;track()] = 0;</a>
<a name="ln2506">                        }</a>
<a name="ln2507">                  }</a>
<a name="ln2508">            }</a>
<a name="ln2509">      // change the tuning to deal with transposition</a>
<a name="ln2510">      // It's needed to create correct tabs</a>
<a name="ln2511">      for (Part * p : score-&gt;parts()) {</a>
<a name="ln2512">            Instrument* instr = p-&gt;instrument();</a>
<a name="ln2513">            if (instr-&gt;transpose().chromatic == 0)</a>
<a name="ln2514">                  continue;</a>
<a name="ln2515">            const StringData* sd = instr-&gt;stringData();</a>
<a name="ln2516">            if (sd) {</a>
<a name="ln2517">#if (!defined (_MSCVER) &amp;&amp; !defined (_MSC_VER))</a>
<a name="ln2518">               int tuning[sd-&gt;strings()];</a>
<a name="ln2519">#else</a>
<a name="ln2520">               // MSVC does not support VLA. Replace with std::vector. If profiling determines that the</a>
<a name="ln2521">               //    heap allocation is slow, an optimization might be used.</a>
<a name="ln2522">               std::vector&lt;int&gt; vTuning(sd-&gt;strings());</a>
<a name="ln2523">               int* tuning = vTuning.data();</a>
<a name="ln2524">#endif</a>
<a name="ln2525">                  int frets   = sd-&gt;frets();</a>
<a name="ln2526">                  int strings;</a>
<a name="ln2527">                  for (strings = 0; strings &lt; sd-&gt;strings(); strings++) {</a>
<a name="ln2528">                        tuning[strings] = sd-&gt;stringList()[strings].pitch - instr-&gt;transpose().chromatic;</a>
<a name="ln2529">                        }</a>
<a name="ln2530">                  StringData* stringData = new StringData(frets, strings, tuning);</a>
<a name="ln2531">                  instr-&gt;setStringData(*stringData);</a>
<a name="ln2532">                  }</a>
<a name="ln2533">            }</a>
<a name="ln2534"> </a>
<a name="ln2535">      // set the starting tempo of the score</a>
<a name="ln2536">      bool zero_set = false;</a>
<a name="ln2537">//      int linearTemp = -1;</a>
<a name="ln2538">      for (auto iter = tempoMap.begin(); iter != tempoMap.end(); ++iter) {</a>
<a name="ln2539">            if (iter-&gt;first == 0)</a>
<a name="ln2540">                  zero_set = true;</a>
<a name="ln2541">            Measure* measure = toMeasure(score-&gt;measure(iter-&gt;first));</a>
<a name="ln2542">            if (measure)</a>
<a name="ln2543">                  setTempo(iter-&gt;second.first, measure);</a>
<a name="ln2544">#if 0 // TODO-ws   what's linearTemp ?</a>
<a name="ln2545">            if (linearTemp != -1) {</a>
<a name="ln2546">                  auto siter = iter;</a>
<a name="ln2547">                  siter--;</a>
<a name="ln2548">                  auto val = iter-&gt;second.first - siter-&gt;second.first;</a>
<a name="ln2549">                  if (val != 0) {</a>
<a name="ln2550">                        for (int i = linearTemp; i &lt;= iter-&gt;first; ++i) {</a>
<a name="ln2551">                              Measure* ms = toMeasure(score-&gt;measure(i));</a>
<a name="ln2552">                              if (ms)</a>
<a name="ln2553">                                    ms-&gt;setLinearTemp(val);</a>
<a name="ln2554">                              }</a>
<a name="ln2555">                        }</a>
<a name="ln2556">                  linearTemp = -1;</a>
<a name="ln2557">                  }</a>
<a name="ln2558">            if (iter-&gt;second.second)</a>
<a name="ln2559">                  linearTemp = iter-&gt;first;</a>
<a name="ln2560">#endif</a>
<a name="ln2561">            }</a>
<a name="ln2562">      if (!zero_set)</a>
<a name="ln2563">            setTempo(120, score-&gt;firstMeasure());</a>
<a name="ln2564">      }</a>
<a name="ln2565"> </a>
<a name="ln2566">//---------------------------------------------------------</a>
<a name="ln2567">//   parseFile</a>
<a name="ln2568">//---------------------------------------------------------</a>
<a name="ln2569"> </a>
<a name="ln2570">void GuitarPro6::parseFile(char* filename, QByteArray* data)</a>
<a name="ln2571">      {</a>
<a name="ln2572">      // test to check if we are dealing with the score</a>
<a name="ln2573">      if (!strcmp(filename, &quot;score.gpif&quot;))</a>
<a name="ln2574">            readGpif(data);</a>
<a name="ln2575">      }</a>
<a name="ln2576"> </a>
<a name="ln2577">//---------------------------------------------------------</a>
<a name="ln2578">//   readGPX</a>
<a name="ln2579">//---------------------------------------------------------</a>
<a name="ln2580"> </a>
<a name="ln2581">void GuitarPro6::readGPX(QByteArray* buffer)</a>
<a name="ln2582">      {</a>
<a name="ln2583">      // start by reading the file header. It will tell us if the byte array is compressed.</a>
<a name="ln2584">      int fileHeader = readInteger(buffer, 0);</a>
<a name="ln2585"> </a>
<a name="ln2586">      if (fileHeader == GPX_HEADER_COMPRESSED) {</a>
<a name="ln2587">            // this is  a compressed file.</a>
<a name="ln2588">            int length             = readInteger(buffer, position / BITS_IN_BYTE);</a>
<a name="ln2589">            QByteArray* bcfsBuffer = new QByteArray();</a>
<a name="ln2590">            int positionCounter    = 0;</a>
<a name="ln2591">            while(!f-&gt;error() &amp;&amp; (position / BITS_IN_BYTE) &lt; length) {</a>
<a name="ln2592">                  // read the bit indicating compression information</a>
<a name="ln2593">                  int flag = readBits(buffer, 1);</a>
<a name="ln2594"> </a>
<a name="ln2595">                  if (flag) {</a>
<a name="ln2596">                        int bits = readBits(buffer, 4);</a>
<a name="ln2597">                        int offs = readBitsReversed(buffer, bits);</a>
<a name="ln2598">                        int size = readBitsReversed(buffer, bits);</a>
<a name="ln2599"> </a>
<a name="ln2600">                        QByteArray bcfsBufferCopy = *bcfsBuffer;</a>
<a name="ln2601">                        int pos                   = (bcfsBufferCopy.length() - offs);</a>
<a name="ln2602">                        for( int i = 0; i &lt; (size &gt; offs ? offs : size); i++ ) {</a>
<a name="ln2603">                              bcfsBuffer-&gt;insert(positionCounter, bcfsBufferCopy[pos + i] );</a>
<a name="ln2604">                              positionCounter++;</a>
<a name="ln2605">                              }</a>
<a name="ln2606">                        }</a>
<a name="ln2607">                  else {</a>
<a name="ln2608">                        int size = readBitsReversed(buffer, 2);</a>
<a name="ln2609">                        for(int i = 0; i &lt; size; i++) {</a>
<a name="ln2610">                              bcfsBuffer-&gt;insert(positionCounter, readBits(buffer, 8));</a>
<a name="ln2611">                              positionCounter++;</a>
<a name="ln2612">                              }</a>
<a name="ln2613">                        }</a>
<a name="ln2614">                  }</a>
<a name="ln2615">            // recurse on the decompressed file stored as a byte array</a>
<a name="ln2616">            readGPX(bcfsBuffer);</a>
<a name="ln2617">            delete bcfsBuffer;</a>
<a name="ln2618">            }</a>
<a name="ln2619">      else if (fileHeader == GPX_HEADER_UNCOMPRESSED) {</a>
<a name="ln2620">            // this is an uncompressed file - strip the header off</a>
<a name="ln2621">            *buffer = buffer-&gt;right(buffer-&gt;length() - sizeof(int));</a>
<a name="ln2622">            int sectorSize = 0x1000;</a>
<a name="ln2623">            int offset     = 0;</a>
<a name="ln2624">            while ((offset = (offset + sectorSize)) + 3 &lt; buffer-&gt;length()) {</a>
<a name="ln2625">                  int newInt = readInteger(buffer,offset);</a>
<a name="ln2626">                  if (newInt == 2) {</a>
<a name="ln2627">                        int indexFileName = (offset + 4);</a>
<a name="ln2628">                        int indexFileSize = (offset + 0x8C);</a>
<a name="ln2629">                        int indexOfBlock  = (offset + 0x94);</a>
<a name="ln2630"> </a>
<a name="ln2631">                        // create a byte array and put information about files found in it</a>
<a name="ln2632">                        int block             = 0;</a>
<a name="ln2633">                        int blockCount        = 0;</a>
<a name="ln2634">                        QByteArray* fileBytes = new QByteArray();</a>
<a name="ln2635">                        while((block = (readInteger(buffer, (indexOfBlock + (4 * (blockCount++)))))) != 0 ) {</a>
<a name="ln2636">                              fileBytes-&gt;push_back(getBytes(buffer, (offset = (block * sectorSize)), sectorSize));</a>
<a name="ln2637">                              }</a>
<a name="ln2638">                        // get file information and read the file</a>
<a name="ln2639">                        int fileSize = readInteger(buffer, indexFileSize);</a>
<a name="ln2640">                        if (fileBytes-&gt;length() &gt;= fileSize) {</a>
<a name="ln2641">                              QByteArray filenameBytes = readString(buffer, indexFileName, 127);</a>
<a name="ln2642">                              char* filename           = filenameBytes.data();</a>
<a name="ln2643">                              QByteArray data          = getBytes(fileBytes, 0, fileSize);</a>
<a name="ln2644">                              parseFile(filename, &amp;data);</a>
<a name="ln2645">                              }</a>
<a name="ln2646">                        delete fileBytes;</a>
<a name="ln2647">                        }</a>
<a name="ln2648">                  }</a>
<a name="ln2649">            }</a>
<a name="ln2650">      }</a>
<a name="ln2651"> </a>
<a name="ln2652">//---------------------------------------------------------</a>
<a name="ln2653">//   readBeatEffects</a>
<a name="ln2654">//---------------------------------------------------------</a>
<a name="ln2655"> </a>
<a name="ln2656">int GuitarPro6::readBeatEffects(int, Segment*)</a>
<a name="ln2657">      {</a>
<a name="ln2658">      qDebug(&quot;reading beat effects (.gpx)...\n&quot;);</a>
<a name="ln2659">      return 0;</a>
<a name="ln2660">      }</a>
<a name="ln2661"> </a>
<a name="ln2662">//---------------------------------------------------------</a>
<a name="ln2663">//   read</a>
<a name="ln2664">//---------------------------------------------------------</a>
<a name="ln2665"> </a>
<a name="ln2666">bool GuitarPro6::read(QFile* fp)</a>
<a name="ln2667">      {</a>
<a name="ln2668">      f      = fp;</a>
<a name="ln2669">      slides = new QMap&lt;int,int&gt;();</a>
<a name="ln2670"> </a>
<a name="ln2671">      previousTempo = -1;</a>
<a name="ln2672">      QByteArray buffer = fp-&gt;readAll();</a>
<a name="ln2673"> </a>
<a name="ln2674">      // decompress and read files contained within GPX file</a>
<a name="ln2675">      readGPX(&amp;buffer);</a>
<a name="ln2676">      delete slides;</a>
<a name="ln2677"> </a>
<a name="ln2678">      return true;</a>
<a name="ln2679">      }</a>
<a name="ln2680"> </a>
<a name="ln2681">}</a>

</code></pre>
<div class="balloon" rel="547"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'stringData' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="1045"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v517/" target="_blank">V517</a> The use of 'if (A) {...} else if (A) {...}' pattern was detected. There is a probability of logical error presence. Check lines: 1045, 1117.</p></div>
<div class="balloon" rel="1540"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v668/" target="_blank">V668</a> There is no sense in testing the 'cr' pointer against null, as the memory was allocated using the 'new' operator. The exception will be generated in the case of memory allocation error.</p></div>
<div class="balloon" rel="948"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v519/" target="_blank">V519</a> The 'lyrNote' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 939, 948.</p></div>
<div class="balloon" rel="2362"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v758/" target="_blank">V758</a> The 'c' reference becomes invalid when temporary object returned by a function is destroyed.</p></div>
<div class="balloon" rel="2505"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v774/" target="_blank">V774</a> The 'slur' pointer was used after the memory was released.</p></div>
<div class="balloon" rel="2532"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'stringData' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="2516"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'sd' is always true.</p></div>
<div class="balloon" rel="9"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
