
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>importgtp-gp4.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2011 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;importgtp.h&quot;</a>
<a name="ln14">#include &quot;globals.h&quot;</a>
<a name="ln15">#include &lt;libmscore/score.h&gt;</a>
<a name="ln16">#include &lt;libmscore/measurebase.h&gt;</a>
<a name="ln17">#include &lt;libmscore/text.h&gt;</a>
<a name="ln18">#include &lt;libmscore/box.h&gt;</a>
<a name="ln19">#include &lt;libmscore/staff.h&gt;</a>
<a name="ln20">#include &lt;libmscore/part.h&gt;</a>
<a name="ln21">#include &lt;libmscore/measure.h&gt;</a>
<a name="ln22">#include &lt;libmscore/timesig.h&gt;</a>
<a name="ln23">#include &lt;libmscore/tremolo.h&gt;</a>
<a name="ln24">#include &lt;libmscore/chordline.h&gt;</a>
<a name="ln25">#include &lt;libmscore/glissando.h&gt;</a>
<a name="ln26">#include &lt;libmscore/rest.h&gt;</a>
<a name="ln27">#include &lt;libmscore/chord.h&gt;</a>
<a name="ln28">#include &lt;libmscore/note.h&gt;</a>
<a name="ln29">#include &lt;libmscore/stringdata.h&gt;</a>
<a name="ln30">#include &lt;libmscore/clef.h&gt;</a>
<a name="ln31">#include &lt;libmscore/lyrics.h&gt;</a>
<a name="ln32">#include &lt;libmscore/tempotext.h&gt;</a>
<a name="ln33">#include &lt;libmscore/slur.h&gt;</a>
<a name="ln34">#include &lt;libmscore/tie.h&gt;</a>
<a name="ln35">#include &lt;libmscore/tuplet.h&gt;</a>
<a name="ln36">#include &lt;libmscore/barline.h&gt;</a>
<a name="ln37">#include &lt;libmscore/excerpt.h&gt;</a>
<a name="ln38">#include &lt;libmscore/stafftype.h&gt;</a>
<a name="ln39">#include &lt;libmscore/bracket.h&gt;</a>
<a name="ln40">#include &lt;libmscore/articulation.h&gt;</a>
<a name="ln41">#include &lt;libmscore/keysig.h&gt;</a>
<a name="ln42">#include &lt;libmscore/harmony.h&gt;</a>
<a name="ln43">#include &lt;libmscore/bend.h&gt;</a>
<a name="ln44">#include &lt;libmscore/tremolobar.h&gt;</a>
<a name="ln45">#include &lt;libmscore/segment.h&gt;</a>
<a name="ln46">#include &lt;libmscore/rehearsalmark.h&gt;</a>
<a name="ln47">#include &lt;libmscore/dynamic.h&gt;</a>
<a name="ln48">#include &lt;libmscore/arpeggio.h&gt;</a>
<a name="ln49">#include &lt;libmscore/volta.h&gt;</a>
<a name="ln50">#include &lt;libmscore/instrtemplate.h&gt;</a>
<a name="ln51">#include &lt;libmscore/fingering.h&gt;</a>
<a name="ln52">#include &lt;libmscore/notedot.h&gt;</a>
<a name="ln53">#include &lt;libmscore/stafftext.h&gt;</a>
<a name="ln54">#include &lt;libmscore/sym.h&gt;</a>
<a name="ln55">#include &lt;libmscore/instrtemplate.h&gt;</a>
<a name="ln56"> </a>
<a name="ln57">namespace Ms {</a>
<a name="ln58"> </a>
<a name="ln59">//---------------------------------------------------------</a>
<a name="ln60">//   readMixChange</a>
<a name="ln61">//---------------------------------------------------------</a>
<a name="ln62"> </a>
<a name="ln63">bool GuitarPro4::readMixChange(Measure* measure)</a>
<a name="ln64">      {</a>
<a name="ln65">      /*char patch   =*/ readChar();</a>
<a name="ln66">      signed char volume  = readChar();</a>
<a name="ln67">      signed char pan     = readChar();</a>
<a name="ln68">      signed char chorus  = readChar();</a>
<a name="ln69">      signed char reverb  = readChar();</a>
<a name="ln70">      signed char phase   = readChar();</a>
<a name="ln71">      signed char tremolo = readChar();</a>
<a name="ln72">      int temp    = readInt();</a>
<a name="ln73"> </a>
<a name="ln74">      bool tempoEdited = false;</a>
<a name="ln75"> </a>
<a name="ln76">      if (volume &gt;= 0)</a>
<a name="ln77">            readChar();</a>
<a name="ln78">      if (pan &gt;= 0)</a>
<a name="ln79">            readChar();</a>
<a name="ln80">      if (chorus &gt;= 0)</a>
<a name="ln81">            readChar();</a>
<a name="ln82">      if (reverb &gt;= 0)</a>
<a name="ln83">            readChar();</a>
<a name="ln84">      if (phase &gt;= 0)</a>
<a name="ln85">            readChar();</a>
<a name="ln86">      if (tremolo &gt;= 0)</a>
<a name="ln87">            readChar();</a>
<a name="ln88">      if (temp &gt;= 0) {</a>
<a name="ln89">            if (last_segment) {</a>
<a name="ln90">                  score-&gt;setTempo(last_segment-&gt;tick(), double(temp) / 60.0f);</a>
<a name="ln91">                  last_segment = nullptr;</a>
<a name="ln92">                  }</a>
<a name="ln93">            if (temp != previousTempo) {</a>
<a name="ln94">                  previousTempo = temp;</a>
<a name="ln95">                  setTempo(temp, measure);</a>
<a name="ln96">                  }</a>
<a name="ln97">            readChar();</a>
<a name="ln98">            tempoEdited = true;</a>
<a name="ln99">            }</a>
<a name="ln100"> </a>
<a name="ln101">      readChar();       // bitmask: what should be applied to all tracks</a>
<a name="ln102">      return tempoEdited;</a>
<a name="ln103">      }</a>
<a name="ln104"> </a>
<a name="ln105">//---------------------------------------------------------</a>
<a name="ln106">//   readBeatEffects</a>
<a name="ln107">//---------------------------------------------------------</a>
<a name="ln108"> </a>
<a name="ln109">int GuitarPro4::readBeatEffects(int track, Segment* segment)</a>
<a name="ln110">      {</a>
<a name="ln111">      int effects = 0;</a>
<a name="ln112">      uchar fxBits1 = readUChar();</a>
<a name="ln113">      uchar fxBits2 = readUChar();</a>
<a name="ln114">      if (fxBits1 &amp; BEAT_FADE)</a>
<a name="ln115">            effects = 4; // fade in</a>
<a name="ln116">      if (fxBits1 &amp; BEAT_EFFECT) {</a>
<a name="ln117">            effects = readUChar();      // effect 1-tapping, 2-slapping, 3-popping</a>
<a name="ln118">            }</a>
<a name="ln119">      if (fxBits2 &amp; BEAT_TREMOLO)</a>
<a name="ln120">            readTremoloBar(track,segment);</a>
<a name="ln121">      if (fxBits1 &amp; BEAT_ARPEGGIO) {</a>
<a name="ln122">            int strokeup = readUChar();            // up stroke length</a>
<a name="ln123">            int strokedown = readUChar();            // down stroke length</a>
<a name="ln124"> </a>
<a name="ln125">            Arpeggio* a = new Arpeggio(score);</a>
<a name="ln126">            if( strokeup &gt; 0 ) {</a>
<a name="ln127">                  a-&gt;setArpeggioType(ArpeggioType::UP_STRAIGHT);</a>
<a name="ln128">                  }</a>
<a name="ln129">            else if( strokedown &gt; 0 ) {</a>
<a name="ln130">                  a-&gt;setArpeggioType(ArpeggioType::DOWN_STRAIGHT);</a>
<a name="ln131">                  }</a>
<a name="ln132">            else {</a>
<a name="ln133">                  delete a;</a>
<a name="ln134">                  a = 0;</a>
<a name="ln135">                  }</a>
<a name="ln136"> </a>
<a name="ln137">            if(a) {</a>
<a name="ln138">                  ChordRest* cr = new Chord(score);</a>
<a name="ln139">                  cr-&gt;setTrack(track);</a>
<a name="ln140">                  cr-&gt;add(a);</a>
<a name="ln141">                  segment-&gt;add(cr);</a>
<a name="ln142">                  }</a>
<a name="ln143">            }</a>
<a name="ln144">      if (fxBits2 &amp; BEAT_STROKE_DIR) {</a>
<a name="ln145">            effects = readUChar();            // stroke pick direction</a>
<a name="ln146">            effects += 4;    //1 or 2 for effects becomes 4 or 5</a>
<a name="ln147">            }</a>
<a name="ln148">      if (fxBits1 &amp; 0x01) {         // GP3 column-wide vibrato</a>
<a name="ln149">            }</a>
<a name="ln150">      if (fxBits1 &amp; 0x2) {          // GP3 column-wide wide vibrato (=&quot;tremolo&quot; in GP3)</a>
<a name="ln151">            }</a>
<a name="ln152">      return effects;</a>
<a name="ln153">      }</a>
<a name="ln154"> </a>
<a name="ln155">//---------------------------------------------------------</a>
<a name="ln156">//   readNote</a>
<a name="ln157">//---------------------------------------------------------</a>
<a name="ln158"> </a>
<a name="ln159">bool GuitarPro4::readNote(int string, int staffIdx, Note* note)</a>
<a name="ln160">      {</a>
<a name="ln161">      uchar noteBits = readUChar();</a>
<a name="ln162"> </a>
<a name="ln163">      //</a>
<a name="ln164">      // noteBits:</a>
<a name="ln165">      //   80 - Right hand or left hand fingering;</a>
<a name="ln166">      //   40 - Accentuated note</a>
<a name="ln167">      //   20 - Note type (rest, empty note, normal note);</a>
<a name="ln168">      //   10 - note dynamic;</a>
<a name="ln169">      //    8 - Presence of effects linked to the note;</a>
<a name="ln170">      //    4 - Ghost note;</a>
<a name="ln171">      //    2 - Dotted note;  ?</a>
<a name="ln172">      //    1 - Time-independent duration</a>
<a name="ln173"> </a>
<a name="ln174">      if (noteBits &amp; BEAT_TREMOLO) {</a>
<a name="ln175">            //note-&gt;setHeadGroup(NoteHead::Group::HEAD_CROSS);</a>
<a name="ln176">            note-&gt;setGhost(true);</a>
<a name="ln177">            }</a>
<a name="ln178"> </a>
<a name="ln179">      bool tieNote = false;</a>
<a name="ln180">      uchar variant = 1;</a>
<a name="ln181">      if (noteBits &amp; BEAT_EFFECT) {       // 0x20</a>
<a name="ln182">            variant = readUChar();</a>
<a name="ln183">            if (variant == 1) {     // normal note</a>
<a name="ln184">                  }</a>
<a name="ln185">            else if (variant == 2) {</a>
<a name="ln186">                  /* guitar pro 4 bundles tied notes with slides in the representation</a>
<a name="ln187">                   * we take note when we see ties and do not create slides for these notes. */</a>
<a name="ln188">                  slides[staffIdx * VOICES] = -2;</a>
<a name="ln189">                  tieNote = true;</a>
<a name="ln190">                  }</a>
<a name="ln191">            else if (variant == 3) {                 // dead notes = ghost note</a>
<a name="ln192">                  note-&gt;setHeadGroup(NoteHead::Group::HEAD_CROSS);</a>
<a name="ln193">                  note-&gt;setGhost(true);</a>
<a name="ln194">                  }</a>
<a name="ln195">            else</a>
<a name="ln196">                  qDebug(&quot;unknown note variant: %d&quot;, variant);</a>
<a name="ln197">            }</a>
<a name="ln198"> </a>
<a name="ln199">      if (noteBits &amp; 0x1) {               // note != beat</a>
<a name="ln200">            int a = readUChar();          // length</a>
<a name="ln201">            int b = readUChar();          // t</a>
<a name="ln202">            qDebug(&quot;          Time independent note len, len %d t %d&quot;, a, b);</a>
<a name="ln203">            }</a>
<a name="ln204">      if (noteBits &amp; 0x2) {               // note is dotted</a>
<a name="ln205">            //readUChar();</a>
<a name="ln206">            }</a>
<a name="ln207"> </a>
<a name="ln208">      // set dynamic information on note if different from previous note</a>
<a name="ln209">      if (noteBits &amp; NOTE_DYNAMIC) {            // 0x10</a>
<a name="ln210">            int d = readChar();</a>
<a name="ln211">            if (previousDynamic != d) {</a>
<a name="ln212">                  previousDynamic = d;</a>
<a name="ln213">                  // addDynamic(note, d);    // velocity? TODO-ws ??</a>
<a name="ln214">                  }</a>
<a name="ln215">            }</a>
<a name="ln216">      else if (previousDynamic) {</a>
<a name="ln217">            previousDynamic = 0;</a>
<a name="ln218">            //addDynamic(note, 0);</a>
<a name="ln219">            }</a>
<a name="ln220"> </a>
<a name="ln221">      int fretNumber = -1;</a>
<a name="ln222">      if (noteBits &amp; NOTE_FRET) {                 // 0x20</a>
<a name="ln223">            // TODO: special case if note is tied</a>
<a name="ln224">            fretNumber = readUChar();</a>
<a name="ln225">            }</a>
<a name="ln226"> </a>
<a name="ln227">      // check if a note is supposed to be accented, and give it the sforzato type</a>
<a name="ln228">      if (noteBits &amp; NOTE_SFORZATO) {           // 0x40</a>
<a name="ln229">            Articulation* art = new Articulation(note-&gt;score());</a>
<a name="ln230">            art-&gt;setSymId(SymId::articAccentAbove);</a>
<a name="ln231">            if (!note-&gt;score()-&gt;addArticulation(note, art))</a>
<a name="ln232">                  delete art;</a>
<a name="ln233">            }</a>
<a name="ln234"> </a>
<a name="ln235">      if (noteBits &amp; NOTE_FINGERING) {          // 0x80</a>
<a name="ln236">            int leftFinger  = readUChar();</a>
<a name="ln237">            int rightFinger = readUChar();</a>
<a name="ln238">            Fingering* fi   = new Fingering(score);</a>
<a name="ln239">            QString finger;</a>
<a name="ln240">            // if there is a valid left hand fingering</a>
<a name="ln241">            if (leftFinger &lt; 5) {</a>
<a name="ln242">                  if (leftFinger == 0)</a>
<a name="ln243">                        finger = &quot;T&quot;;</a>
<a name="ln244">                  else if (leftFinger == 1)</a>
<a name="ln245">                        finger = &quot;1&quot;;</a>
<a name="ln246">                  else if (leftFinger == 2)</a>
<a name="ln247">                        finger = &quot;2&quot;;</a>
<a name="ln248">                  else if (leftFinger == 3)</a>
<a name="ln249">                        finger = &quot;3&quot;;</a>
<a name="ln250">                  else if (leftFinger == 4)</a>
<a name="ln251">                        finger = &quot;4&quot;;</a>
<a name="ln252">                  }</a>
<a name="ln253">            else  {</a>
<a name="ln254">                  if (rightFinger == 0)</a>
<a name="ln255">                        finger = &quot;T&quot;;</a>
<a name="ln256">                  else if (rightFinger == 1)</a>
<a name="ln257">                        finger = &quot;I&quot;;</a>
<a name="ln258">                  else if (rightFinger == 2)</a>
<a name="ln259">                        finger = &quot;M&quot;;</a>
<a name="ln260">                  else if (rightFinger == 3)</a>
<a name="ln261">                        finger = &quot;A&quot;;</a>
<a name="ln262">                  else if (rightFinger == 4)</a>
<a name="ln263">                        finger = &quot;O&quot;;</a>
<a name="ln264">                  }</a>
<a name="ln265">            fi-&gt;setPlainText(finger);</a>
<a name="ln266">            note-&gt;add(fi);</a>
<a name="ln267">            fi-&gt;reset();</a>
<a name="ln268">            }</a>
<a name="ln269">      bool slur = false;</a>
<a name="ln270">      uchar modMask2{ 0 };</a>
<a name="ln271">      if (noteBits &amp; BEAT_EFFECTS) {</a>
<a name="ln272">            uchar modMask1 = readUChar();</a>
<a name="ln273">            modMask2 = readUChar();</a>
<a name="ln274">            if (modMask1 &amp; EFFECT_BEND) {</a>
<a name="ln275">                  readBend(note);</a>
<a name="ln276">                  }</a>
<a name="ln277">            if (modMask1 &amp; EFFECT_HAMMER) {</a>
<a name="ln278">                  slur = true;</a>
<a name="ln279">                  }</a>
<a name="ln280">            if (modMask1 &amp; EFFECT_LET_RING) {</a>
<a name="ln281">                  addLetRing(note);</a>
<a name="ln282">                  //note-&gt;setLetRing(true);</a>
<a name="ln283">                  }</a>
<a name="ln284">            if (modMask2 &amp; 0x40)</a>
<a name="ln285">                  addVibrato(note);</a>
<a name="ln286">            if (modMask1 &amp; EFFECT_GRACE) {</a>
<a name="ln287">                  int fret = readUChar();             // grace fret</a>
<a name="ln288">                  int dynamic = readUChar();          // grace dynamic</a>
<a name="ln289">                  int transition = readUChar();       // grace transition</a>
<a name="ln290">                  int duration = readUChar();         // grace duration</a>
<a name="ln291"> </a>
<a name="ln292">                  int grace_len = MScore::division/8;</a>
<a name="ln293">                  if (duration == 1)</a>
<a name="ln294">                        grace_len = MScore::division/8; //32th</a>
<a name="ln295">                  else if (duration == 2)</a>
<a name="ln296">                        grace_len = MScore::division/6; //24th</a>
<a name="ln297">                  else if (duration == 3)</a>
<a name="ln298">                        grace_len = MScore::division/4; //16th</a>
<a name="ln299"> </a>
<a name="ln300">                  Note* gn = new Note(score);</a>
<a name="ln301"> </a>
<a name="ln302">                  if (fret == 255) {</a>
<a name="ln303">                        gn-&gt;setHeadGroup(NoteHead::Group::HEAD_CROSS);</a>
<a name="ln304">                        gn-&gt;setGhost(true);</a>
<a name="ln305">                        }</a>
<a name="ln306">                  if (fret == 255)</a>
<a name="ln307">                        fret = 0;</a>
<a name="ln308">                  gn-&gt;setFret(fret);</a>
<a name="ln309">                  gn-&gt;setString(string);</a>
<a name="ln310">                  int grace_pitch = note-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;getPitch(string, fret, nullptr, Fraction(0,1));</a>
<a name="ln311">                  gn-&gt;setPitch(grace_pitch);</a>
<a name="ln312">                  gn-&gt;setTpcFromPitch();</a>
<a name="ln313"> </a>
<a name="ln314">                  Chord* gc = new Chord(score);</a>
<a name="ln315">                  gc-&gt;setTrack(note-&gt;chord()-&gt;track());</a>
<a name="ln316">                  gc-&gt;add(gn);</a>
<a name="ln317">                  gc-&gt;setParent(note-&gt;chord());</a>
<a name="ln318"> </a>
<a name="ln319">                  TDuration d;</a>
<a name="ln320">                  d.setVal(grace_len);</a>
<a name="ln321">                  if(grace_len == MScore::division/6)</a>
<a name="ln322">                        d.setDots(1);</a>
<a name="ln323">                  gc-&gt;setDurationType(d);</a>
<a name="ln324">                  gc-&gt;setTicks(d.fraction());</a>
<a name="ln325">                  gc-&gt;setNoteType(NoteType::ACCIACCATURA);</a>
<a name="ln326">                  gc-&gt;setMag(note-&gt;chord()-&gt;staff()-&gt;mag(Fraction(0,1)) * score-&gt;styleD(Sid::graceNoteMag));</a>
<a name="ln327">                  note-&gt;chord()-&gt;add(gc);</a>
<a name="ln328">                  addDynamic(gn, dynamic);</a>
<a name="ln329"> </a>
<a name="ln330">                  if (transition == 0) {</a>
<a name="ln331">                        // no transition</a>
<a name="ln332">                        }</a>
<a name="ln333">                  else if(transition == 1) {</a>
<a name="ln334">                        //TODO: Add a 'slide' guitar effect when implemented</a>
<a name="ln335">                        //TODO-ws				note-&gt;setSlideNote(gn);</a>
<a name="ln336">                        }</a>
<a name="ln337">                  else if (transition == 2 &amp;&amp; fretNumber&gt;=0 &amp;&amp; fretNumber&lt;=255 &amp;&amp; fretNumber!=gn-&gt;fret()) {</a>
<a name="ln338">#if 0</a>
<a name="ln339">                        QList&lt;PitchValue&gt; points;</a>
<a name="ln340">                        points.append(PitchValue(0,0, false));</a>
<a name="ln341">                        points.append(PitchValue(60,(fretNumber-gn-&gt;fret())*100, false));</a>
<a name="ln342"> </a>
<a name="ln343">                        Bend* b = new Bend(note-&gt;score());</a>
<a name="ln344">                        b-&gt;setPoints(points);</a>
<a name="ln345">                        b-&gt;setTrack(gn-&gt;track());</a>
<a name="ln346">                        gn-&gt;add(b);</a>
<a name="ln347">#endif</a>
<a name="ln348">                        }</a>
<a name="ln349">                  else if (transition == 3) {</a>
<a name="ln350">                        // TODO:</a>
<a name="ln351">                        //     major: replace with a 'hammer-on' guitar effect when implemented</a>
<a name="ln352">                        //     minor: make slurs for parts</a>
<a name="ln353"> </a>
<a name="ln354">                        ChordRest* cr1 = toChord(gc);</a>
<a name="ln355">                        ChordRest* cr2 = toChord(note-&gt;chord());</a>
<a name="ln356"> </a>
<a name="ln357">                        Slur* slur1 = new Slur(score);</a>
<a name="ln358">                        slur1-&gt;setAnchor(Spanner::Anchor::CHORD);</a>
<a name="ln359">                        slur1-&gt;setStartElement(cr1);</a>
<a name="ln360">                        slur1-&gt;setEndElement(cr2);</a>
<a name="ln361">                        slur1-&gt;setTick(cr1-&gt;tick());</a>
<a name="ln362">                        slur1-&gt;setTick2(cr2-&gt;tick());</a>
<a name="ln363">                        slur1-&gt;setTrack(cr1-&gt;track());</a>
<a name="ln364">                        slur1-&gt;setTrack2(cr2-&gt;track());</a>
<a name="ln365">                        // this case specifies only two-note slurs, don't set a parent</a>
<a name="ln366">                        score-&gt;undoAddElement(slur1);</a>
<a name="ln367">                        }</a>
<a name="ln368">                  }</a>
<a name="ln369">            if (modMask2 &amp; EFFECT_STACATTO) {   // staccato</a>
<a name="ln370">                  Chord* chord = note-&gt;chord();</a>
<a name="ln371">                  Articulation* a = new Articulation(chord-&gt;score());</a>
<a name="ln372">                  a-&gt;setSymId(SymId::articStaccatoAbove);</a>
<a name="ln373">                  chord-&gt;add(a);</a>
<a name="ln374">                  }</a>
<a name="ln375">            if (modMask2 &amp; EFFECT_PALM_MUTE) {</a>
<a name="ln376">                  //note-&gt;setPalmMute(true);</a>
<a name="ln377">                  addPalmMute(note);</a>
<a name="ln378">                  }</a>
<a name="ln379"> </a>
<a name="ln380">            if (modMask2 &amp; EFFECT_TREMOLO) {    // tremolo picking length</a>
<a name="ln381">                  int tremoloDivision = readUChar();</a>
<a name="ln382">                  Chord* chord = note-&gt;chord();</a>
<a name="ln383">                  Tremolo* t = new Tremolo(chord-&gt;score());</a>
<a name="ln384">                  if (tremoloDivision == 1) {</a>
<a name="ln385">                        t-&gt;setTremoloType(TremoloType::R8);</a>
<a name="ln386">                        chord-&gt;add(t);</a>
<a name="ln387">                        }</a>
<a name="ln388">                  else if (tremoloDivision == 2) {</a>
<a name="ln389">                        t-&gt;setTremoloType(TremoloType::R16);</a>
<a name="ln390">                        chord-&gt;add(t);</a>
<a name="ln391">                        }</a>
<a name="ln392">                  else if (tremoloDivision == 3) {</a>
<a name="ln393">                        t-&gt;setTremoloType(TremoloType::R32);</a>
<a name="ln394">                        chord-&gt;add(t);</a>
<a name="ln395">                        }</a>
<a name="ln396">                  else</a>
<a name="ln397">                        qDebug(&quot;Unknown tremolo value&quot;);</a>
<a name="ln398">                  }</a>
<a name="ln399">            if (modMask2 &amp; EFFECT_SLIDE) {</a>
<a name="ln400">                  int slideKind = readUChar();</a>
<a name="ln401">                  // if slide &gt;= 4 then we are not dealing with legato slide nor shift slide</a>
<a name="ln402">                  if (slideKind &gt;= 3 || slideKind == 254 || slideKind == 255) {</a>
<a name="ln403">                        slide = slideKind;</a>
<a name="ln404">                        }</a>
<a name="ln405">                  else</a>
<a name="ln406">                        //slides[note-&gt;chord()-&gt;track()] = slideKind;</a>
<a name="ln407">                        slideList.push_back(note);</a>
<a name="ln408">                  if (slideKind == 2)</a>
<a name="ln409">                        slur = true;</a>
<a name="ln410">                  }</a>
<a name="ln411"> </a>
<a name="ln412">            if (modMask2 &amp; EFFECT_TRILL) {</a>
<a name="ln413">                  /* unsigned char a = */ readUChar();</a>
<a name="ln414">                  //TODO-ws                  note-&gt;setTrillFret(a);      // trill fret</a>
<a name="ln415">                  /*int period =*/ readUChar();      // trill length</a>
<a name="ln416"> </a>
<a name="ln417">                  // add the trill articulation to the note</a>
<a name="ln418">                  Articulation* art = new Articulation(note-&gt;score());</a>
<a name="ln419">                  art-&gt;setSymId(SymId::ornamentTrill);</a>
<a name="ln420">                  if (!note-&gt;score()-&gt;addArticulation(note, art))</a>
<a name="ln421">                        delete art;</a>
<a name="ln422"> </a>
<a name="ln423">                  }</a>
<a name="ln424">            }</a>
<a name="ln425">      if (fretNumber == -1) {</a>
<a name="ln426">            qDebug(&quot;Note: no fret number, tie %d&quot;, tieNote);</a>
<a name="ln427">            }</a>
<a name="ln428">      Staff* staff = note-&gt;staff();</a>
<a name="ln429">      if (fretNumber == 255) {</a>
<a name="ln430">            fretNumber = 0;</a>
<a name="ln431">            note-&gt;setHeadGroup(NoteHead::Group::HEAD_CROSS);</a>
<a name="ln432">            note-&gt;setGhost(true);</a>
<a name="ln433">            }</a>
<a name="ln434">      // dead note represented as high numbers - fix to zero</a>
<a name="ln435">      if (fretNumber &gt; 99 || fretNumber == -1)</a>
<a name="ln436">            fretNumber = 0;</a>
<a name="ln437">      int pitch = staff-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;getPitch(string, fretNumber, nullptr, Fraction(0,1));</a>
<a name="ln438">      note-&gt;setFret(fretNumber);</a>
<a name="ln439">      note-&gt;setString(string);</a>
<a name="ln440">      note-&gt;setPitch(std::min(pitch, 127));</a>
<a name="ln441"> </a>
<a name="ln442">      if (modMask2 &amp; 0x10) {</a>
<a name="ln443">            int type = readUChar();      // harmonic kind</a>
<a name="ln444">            if (type == 1) //Natural</a>
<a name="ln445">                  ; // TODO-ws note-&gt;setHarmonic(false);</a>
<a name="ln446">            else if (type == 3) // Tapped</a>
<a name="ln447">                  addTextToNote(&quot;T.H.&quot;, Align::CENTER, note);</a>
<a name="ln448">            else if (type == 4) //Pinch</a>
<a name="ln449">                  addTextToNote(&quot;P.H.&quot;, Align::CENTER, note);</a>
<a name="ln450">            else if (type == 5) //semi</a>
<a name="ln451">                  addTextToNote(&quot;S.H.&quot;, Align::CENTER, note);</a>
<a name="ln452">            else { //Artificial</a>
<a name="ln453">                  addTextToNote(&quot;A.H.&quot;, Align::CENTER, note);</a>
<a name="ln454">                  int harmonicFret = note-&gt;fret();</a>
<a name="ln455">                  harmonicFret += type - 10;</a>
<a name="ln456">                  Note* harmonicNote = new Note(score);</a>
<a name="ln457">                  note-&gt;chord()-&gt;add(harmonicNote);</a>
<a name="ln458">                  harmonicNote-&gt;setFret(harmonicFret);</a>
<a name="ln459">                  harmonicNote-&gt;setString(note-&gt;string());</a>
<a name="ln460">                  //TODO-ws			harmonicNote-&gt;setHarmonic(true);</a>
<a name="ln461">                  harmonicNote-&gt;setPitch(note-&gt;staff()-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;getPitch(note-&gt;string(), harmonicFret, nullptr, Fraction(0,1)));</a>
<a name="ln462">                  harmonicNote-&gt;setTpcFromPitch();</a>
<a name="ln463">                  }</a>
<a name="ln464">            }</a>
<a name="ln465"> </a>
<a name="ln466">      if (tieNote) {</a>
<a name="ln467">            int si = note-&gt;staffIdx();</a>
<a name="ln468">            if (slurs[si]) {</a>
<a name="ln469">                  score-&gt;removeSpanner(slurs[si]);</a>
<a name="ln470">                  delete slurs[si];</a>
<a name="ln471">                  slurs[si] = 0;</a>
<a name="ln472">                  }</a>
<a name="ln473">            bool found = false;</a>
<a name="ln474">            Chord* chord = note-&gt;chord();</a>
<a name="ln475">            Segment* segment = chord-&gt;segment()-&gt;prev1(SegmentType::ChordRest);</a>
<a name="ln476">            int track = note-&gt;track();</a>
<a name="ln477">            std::vector&lt;ChordRest*&gt; chords;</a>
<a name="ln478">            Note* true_note = 0;</a>
<a name="ln479">            while (segment) {</a>
<a name="ln480">                  Element* e = segment-&gt;element(track);</a>
<a name="ln481">                  if (e) {</a>
<a name="ln482">                        if (e-&gt;isChord()) {</a>
<a name="ln483">                              Chord* chord2 = toChord(e);</a>
<a name="ln484">                              foreach (Note* note2, chord2-&gt;notes()) {</a>
<a name="ln485">                                    if (note2-&gt;string() == string) {</a>
<a name="ln486">                                          if (chords.empty()) {</a>
<a name="ln487">                                                Tie* tie = new Tie(score);</a>
<a name="ln488">                                                tie-&gt;setEndNote(note);</a>
<a name="ln489">                                                note2-&gt;add(tie);</a>
<a name="ln490">                                                }</a>
<a name="ln491">                                          note-&gt;setFret(note2-&gt;fret());</a>
<a name="ln492">                                          note-&gt;setPitch(note2-&gt;pitch());</a>
<a name="ln493">                                          true_note = note2;</a>
<a name="ln494">                                          found = true;</a>
<a name="ln495">                                          break;</a>
<a name="ln496">                                          }</a>
<a name="ln497">                                    }</a>
<a name="ln498">                              }</a>
<a name="ln499">                        if (found)</a>
<a name="ln500">                              break;</a>
<a name="ln501">                        else {</a>
<a name="ln502">                              if (e)</a>
<a name="ln503">                                    chords.push_back(toChordRest(e));</a>
<a name="ln504">                              }</a>
<a name="ln505">                        }</a>
<a name="ln506">                  segment = segment-&gt;prev1(SegmentType::ChordRest);</a>
<a name="ln507">                  }</a>
<a name="ln508">            if (true_note &amp;&amp; chords.size()) {</a>
<a name="ln509">                  Note* end_note = note;</a>
<a name="ln510">                  for (unsigned int i = 0; i &lt; chords.size(); ++i) {</a>
<a name="ln511">                        Chord* chord1 = nullptr;</a>
<a name="ln512">                        auto cr = chords.at(i);</a>
<a name="ln513">                        if (cr-&gt;isChord())</a>
<a name="ln514">                              chord1 = toChord(cr);</a>
<a name="ln515">                        else {</a>
<a name="ln516">                              Rest* rest = toRest(cr);</a>
<a name="ln517">                              auto dur = rest-&gt;ticks();</a>
<a name="ln518">                              auto dut = rest-&gt;durationType();</a>
<a name="ln519">                              auto seg = rest-&gt;segment();</a>
<a name="ln520">                              seg-&gt;remove(rest);</a>
<a name="ln521">                              auto tuplet = rest-&gt;tuplet();</a>
<a name="ln522">                              if (tuplet)</a>
<a name="ln523">                                    tuplet-&gt;remove(rest);</a>
<a name="ln524">                              delete rest;</a>
<a name="ln525">                              chord1 = new Chord(score);</a>
<a name="ln526">                              chord1-&gt;setTrack(note-&gt;track());</a>
<a name="ln527">                              chord1-&gt;setTicks(dur);</a>
<a name="ln528">                              chord1-&gt;setDurationType(dut);</a>
<a name="ln529">                              seg-&gt;add(chord1);</a>
<a name="ln530">                              if (tuplet)</a>
<a name="ln531">                                    tuplet-&gt;add(chord1);</a>
<a name="ln532">                              }</a>
<a name="ln533"> </a>
<a name="ln534">                        Note* note2 = new Note(score);</a>
<a name="ln535">                        note2-&gt;setString(true_note-&gt;string());</a>
<a name="ln536">                        note2-&gt;setFret(true_note-&gt;fret());</a>
<a name="ln537">                        note2-&gt;setPitch(true_note-&gt;pitch());</a>
<a name="ln538">                        note2-&gt;setTpcFromPitch();</a>
<a name="ln539">                        chord1-&gt;setNoteType(true_note-&gt;noteType());</a>
<a name="ln540">                        chord1-&gt;add(note2);</a>
<a name="ln541">                        Tie* tie = new Tie(score);</a>
<a name="ln542">                        tie-&gt;setEndNote(end_note);</a>
<a name="ln543">                        //TODO-ws			end_note-&gt;setHarmonic(true_note-&gt;harmonic());</a>
<a name="ln544">                        end_note = note2;</a>
<a name="ln545">                        note2-&gt;add(tie);</a>
<a name="ln546">                        }</a>
<a name="ln547">                  Tie* tie = new Tie(score);</a>
<a name="ln548">                  tie-&gt;setEndNote(end_note);</a>
<a name="ln549">                  //TODO-ws		end_note-&gt;setHarmonic(true_note-&gt;harmonic());</a>
<a name="ln550">                  true_note-&gt;add(tie);</a>
<a name="ln551">                  }</a>
<a name="ln552">            if (!found) {</a>
<a name="ln553">                  qDebug(&quot;tied note not found, pitch %d fret %d string %d&quot;, note-&gt;pitch(), note-&gt;fret(), note-&gt;string());</a>
<a name="ln554">                  return false;</a>
<a name="ln555">                  }</a>
<a name="ln556">            }</a>
<a name="ln557">      return slur;</a>
<a name="ln558">      }</a>
<a name="ln559"> </a>
<a name="ln560">//---------------------------------------------------------</a>
<a name="ln561">//   readInfo</a>
<a name="ln562">//---------------------------------------------------------</a>
<a name="ln563"> </a>
<a name="ln564">void GuitarPro4::readInfo()</a>
<a name="ln565">      {</a>
<a name="ln566">      title        = readDelphiString();</a>
<a name="ln567">      subtitle     = readDelphiString();</a>
<a name="ln568">      artist       = readDelphiString();</a>
<a name="ln569">      album        = readDelphiString();</a>
<a name="ln570">      composer     = readDelphiString();</a>
<a name="ln571">      QString copyright = readDelphiString();</a>
<a name="ln572">      if (!copyright.isEmpty())</a>
<a name="ln573">            score-&gt;setMetaTag(&quot;copyright&quot;, QString(&quot;%1&quot;).arg(copyright));</a>
<a name="ln574"> </a>
<a name="ln575">      transcriber  = readDelphiString();</a>
<a name="ln576">      instructions = readDelphiString();</a>
<a name="ln577">      int n = readInt();</a>
<a name="ln578">      for (int i = 0; i &lt; n; ++i)</a>
<a name="ln579">            comments.append(readDelphiString());</a>
<a name="ln580">      }</a>
<a name="ln581"> </a>
<a name="ln582">//---------------------------------------------------------</a>
<a name="ln583">//   convertGP4SlideNum</a>
<a name="ln584">//---------------------------------------------------------</a>
<a name="ln585"> </a>
<a name="ln586">int GuitarPro4::convertGP4SlideNum(int sl)</a>
<a name="ln587">      {</a>
<a name="ln588">      switch (sl) {</a>
<a name="ln589">            case 1:</a>
<a name="ln590">                  return SHIFT_SLIDE;</a>
<a name="ln591">            case 2:</a>
<a name="ln592">                  return LEGATO_SLIDE;</a>
<a name="ln593">            case 3:     // slide out downwards</a>
<a name="ln594">                  return SLIDE_OUT_DOWN;</a>
<a name="ln595">            case 4:     // slide out upwards</a>
<a name="ln596">                  return SLIDE_OUT_UP;</a>
<a name="ln597">            case 254:   // slide in from above</a>
<a name="ln598">                  return SLIDE_IN_ABOVE;</a>
<a name="ln599">            case 255:   // slide in from below</a>
<a name="ln600">                  return SLIDE_IN_BELOW;</a>
<a name="ln601">            }</a>
<a name="ln602">      return sl;</a>
<a name="ln603">      }</a>
<a name="ln604"> </a>
<a name="ln605">//---------------------------------------------------------</a>
<a name="ln606">//   read</a>
<a name="ln607">//---------------------------------------------------------</a>
<a name="ln608"> </a>
<a name="ln609">bool GuitarPro4::read(QFile* fp)</a>
<a name="ln610">      {</a>
<a name="ln611">      f      = fp;</a>
<a name="ln612">      curPos = 30;</a>
<a name="ln613"> </a>
<a name="ln614">      readInfo();</a>
<a name="ln615">      readUChar();      // triplet feeling</a>
<a name="ln616">      readLyrics();</a>
<a name="ln617"> </a>
<a name="ln618">      int temp   = readInt();</a>
<a name="ln619">      key        = readInt();</a>
<a name="ln620">      /*int octave =*/ readUChar();    // octave</a>
<a name="ln621"> </a>
<a name="ln622">      //previousDynamic = new int [staves * VOICES];</a>
<a name="ln623">      // initialise the dynamics to 0</a>
<a name="ln624">      //for (int i = 0; i &lt; staves * VOICES; i++)</a>
<a name="ln625">      //      previousDynamic[i] = 0;</a>
<a name="ln626">      previousDynamic = -1;</a>
<a name="ln627">      previousTempo = -1;</a>
<a name="ln628"> </a>
<a name="ln629">      readChannels();</a>
<a name="ln630">      measures = readInt();</a>
<a name="ln631">      staves   = readInt();</a>
<a name="ln632"> </a>
<a name="ln633">      curDynam.resize(staves * VOICES);</a>
<a name="ln634">      for (auto&amp; i : curDynam)</a>
<a name="ln635">            i = -1;</a>
<a name="ln636"> </a>
<a name="ln637">      int tnumerator   = 4;</a>
<a name="ln638">      int tdenominator = 4;</a>
<a name="ln639">      for (int i = 0; i &lt; measures; ++i) {</a>
<a name="ln640">            GpBar bar;</a>
<a name="ln641">            uchar barBits = readUChar();</a>
<a name="ln642">            if (barBits &amp; SCORE_TIMESIG_NUMERATOR)</a>
<a name="ln643">                  tnumerator = readUChar();</a>
<a name="ln644">            if (barBits &amp; SCORE_TIMESIG_DENOMINATOR)</a>
<a name="ln645">                  tdenominator = readUChar();</a>
<a name="ln646">            if (barBits &amp; SCORE_REPEAT_START)</a>
<a name="ln647">                  bar.repeatFlags = bar.repeatFlags | Repeat::START;</a>
<a name="ln648">            if (barBits &amp; SCORE_REPEAT_END) {                // number of repeats</a>
<a name="ln649">                  bar.repeatFlags = bar.repeatFlags | Repeat::END;</a>
<a name="ln650">                  bar.repeats = readUChar() + 1;</a>
<a name="ln651">                  }</a>
<a name="ln652">            if (barBits &amp; SCORE_VOLTA) {                      // a volta</a>
<a name="ln653">                  uchar voltaNumber = readUChar();</a>
<a name="ln654">                  while (voltaNumber &gt; 0) {</a>
<a name="ln655">                        // volta information is represented as a binary number</a>
<a name="ln656">                        bar.volta.voltaType = GP_VOLTA_BINARY;</a>
<a name="ln657">                        bar.volta.voltaInfo.append(voltaNumber &amp; 1);</a>
<a name="ln658">                        voltaNumber &gt;&gt;= 1;</a>
<a name="ln659">                        }</a>
<a name="ln660">                  }</a>
<a name="ln661">            if (barBits &amp; SCORE_MARKER) {</a>
<a name="ln662">                  bar.marker = readDelphiString();     // new section?</a>
<a name="ln663">                  /*int color = */ readInt();    // color?</a>
<a name="ln664">                  }</a>
<a name="ln665">            if (barBits &amp; SCORE_KEYSIG) {</a>
<a name="ln666">                  int currentKey = readUChar();</a>
<a name="ln667">                  /* key signatures are specified as</a>
<a name="ln668">                   * 1# = 1, 2# = 2, ..., 7# = 7</a>
<a name="ln669">                   * 1b = 255, 2b = 254, ... 7b = 249 */</a>
<a name="ln670">                  bar.keysig = currentKey &lt;= 7 ? currentKey : -256+currentKey;</a>
<a name="ln671">                  readUChar();        // specifies major/minor mode</a>
<a name="ln672">                  }</a>
<a name="ln673">            if (barBits &amp; SCORE_DOUBLE_BAR)</a>
<a name="ln674">                  bar.barLine = BarLineType::DOUBLE;</a>
<a name="ln675">            bar.timesig = Fraction(tnumerator, tdenominator);</a>
<a name="ln676">            bars.append(bar);</a>
<a name="ln677">            }</a>
<a name="ln678"> </a>
<a name="ln679">      //</a>
<a name="ln680">      // create a part for every staff</a>
<a name="ln681">      //</a>
<a name="ln682">      for (int staffIdx = 0; staffIdx &lt; staves; ++staffIdx) {</a>
<a name="ln683">            Part* part = new Part(score);</a>
<a name="ln684">            Staff* s = new Staff(score);</a>
<a name="ln685">            s-&gt;setPart(part);</a>
<a name="ln686">            part-&gt;insertStaff(s, 0);</a>
<a name="ln687">            score-&gt;staves().push_back(s);</a>
<a name="ln688">            score-&gt;appendPart(part);</a>
<a name="ln689">            }</a>
<a name="ln690"> </a>
<a name="ln691">      createMeasures();</a>
<a name="ln692"> </a>
<a name="ln693">      setTempo(temp, score-&gt;firstMeasure());</a>
<a name="ln694"> </a>
<a name="ln695">      for (int i = 0; i &lt; staves; ++i) {</a>
<a name="ln696">            int tuning[GP_MAX_STRING_NUMBER];</a>
<a name="ln697"> </a>
<a name="ln698">            uchar c = readUChar();   // simulations bitmask</a>
<a name="ln699">            if (c &amp; 0x2) {                // 12 stringed guitar</a>
<a name="ln700">                  }</a>
<a name="ln701">            if (c &amp; 0x4) {                // banjo track</a>
<a name="ln702">                  }</a>
<a name="ln703">            QString name = readPascalString(40);</a>
<a name="ln704">            int strings  = readInt();</a>
<a name="ln705">            if (strings &lt;= 0 || strings &gt; GP_MAX_STRING_NUMBER)</a>
<a name="ln706">                  return false;</a>
<a name="ln707">            for (int j = 0; j &lt; strings; ++j)</a>
<a name="ln708">                  tuning[j] = readInt();</a>
<a name="ln709">            for (int j = strings; j &lt; GP_MAX_STRING_NUMBER; ++j)</a>
<a name="ln710">                  readInt();</a>
<a name="ln711">            int midiPort     = readInt() - 1;</a>
<a name="ln712">            int midiChannel  = readInt() - 1;</a>
<a name="ln713">            /*int midiChannel2 =*/ readInt(); // - 1;</a>
<a name="ln714">            int frets        = readInt();</a>
<a name="ln715"> </a>
<a name="ln716">            int capo         = readInt();</a>
<a name="ln717">            /*int color        =*/ readInt();</a>
<a name="ln718"> </a>
<a name="ln719">            std::vector&lt;int&gt; tuning2(strings);</a>
<a name="ln720">            //int tuning2[strings];</a>
<a name="ln721">            for (int k = 0; k &lt; strings; ++k)</a>
<a name="ln722">                  tuning2[strings-k-1] = tuning[k];</a>
<a name="ln723">            StringData stringData(frets, strings, &amp;tuning2[0]);</a>
<a name="ln724">            createTuningString(strings, &amp;tuning2[0]);</a>
<a name="ln725">            Part* part = score-&gt;staff(i)-&gt;part();</a>
<a name="ln726">            Instrument* instr = part-&gt;instrument();</a>
<a name="ln727">            instr-&gt;setStringData(stringData);</a>
<a name="ln728">            instr-&gt;setSingleNoteDynamics(false);</a>
<a name="ln729">            part-&gt;setPartName(name);</a>
<a name="ln730">            part-&gt;setPlainLongName(name);</a>
<a name="ln731"> </a>
<a name="ln732">            //</a>
<a name="ln733">            // determine clef</a>
<a name="ln734">            //</a>
<a name="ln735">            Staff* staff = score-&gt;staff(i);</a>
<a name="ln736">            int patch = channelDefaults[midiChannel].patch;</a>
<a name="ln737">            ClefType clefId = ClefType::G;</a>
<a name="ln738">            if (midiChannel == GP_DEFAULT_PERCUSSION_CHANNEL) {</a>
<a name="ln739">                  clefId = ClefType::PERC;</a>
<a name="ln740">                  // instr-&gt;setUseDrumset(DrumsetKind::GUITAR_PRO);</a>
<a name="ln741">                  instr-&gt;setDrumset(gpDrumset);</a>
<a name="ln742">                  staff-&gt;setStaffType(Fraction(0,1), *StaffType::preset(StaffTypes::PERC_DEFAULT));</a>
<a name="ln743">                  }</a>
<a name="ln744">            else</a>
<a name="ln745">                  clefId = defaultClef(patch);</a>
<a name="ln746">            Measure* measure = score-&gt;firstMeasure();</a>
<a name="ln747">            Clef* clef = new Clef(score);</a>
<a name="ln748">            clef-&gt;setClefType(clefId);</a>
<a name="ln749">            clef-&gt;setTrack(i * VOICES);</a>
<a name="ln750">            Segment* segment = measure-&gt;getSegment(SegmentType::HeaderClef, Fraction(0,1));</a>
<a name="ln751">            segment-&gt;add(clef);</a>
<a name="ln752"> </a>
<a name="ln753">            if (capo &gt; 0) {</a>
<a name="ln754">                  Segment* s = measure-&gt;getSegment(SegmentType::ChordRest, measure-&gt;tick());</a>
<a name="ln755">                  StaffText* st = new StaffText(score);</a>
<a name="ln756">                  st-&gt;setPlainText(QString(&quot;Capo. fret &quot;) + QString::number(capo));</a>
<a name="ln757">                  st-&gt;setTrack(i * VOICES);</a>
<a name="ln758">                  s-&gt;add(st);</a>
<a name="ln759">                  }</a>
<a name="ln760"> </a>
<a name="ln761">            Channel* ch = instr-&gt;channel(0);</a>
<a name="ln762">            if (midiChannel == GP_DEFAULT_PERCUSSION_CHANNEL) {</a>
<a name="ln763">                  ch-&gt;setProgram(0);</a>
<a name="ln764">                  ch-&gt;setBank(128);</a>
<a name="ln765">                  }</a>
<a name="ln766">            else {</a>
<a name="ln767">                  ch-&gt;setProgram(patch);</a>
<a name="ln768">                  ch-&gt;setBank(0);</a>
<a name="ln769">                  }</a>
<a name="ln770">            ch-&gt;setVolume(channelDefaults[midiChannel].volume);</a>
<a name="ln771">            ch-&gt;setPan(channelDefaults[midiChannel].pan);</a>
<a name="ln772">            ch-&gt;setChorus(channelDefaults[midiChannel].chorus);</a>
<a name="ln773">            ch-&gt;setReverb(channelDefaults[midiChannel].reverb);</a>
<a name="ln774">            staff-&gt;part()-&gt;setMidiChannel(midiChannel, midiPort);</a>
<a name="ln775">            // missing: phase, tremolo</a>
<a name="ln776">            }</a>
<a name="ln777"> </a>
<a name="ln778">      slurs = new Slur*[staves];</a>
<a name="ln779">      tupleKind.resize(staves);</a>
<a name="ln780">      for (auto&amp; i : tupleKind)</a>
<a name="ln781">            i = 0;</a>
<a name="ln782">      for (int i = 0; i &lt; staves; ++i)</a>
<a name="ln783">            slurs[i] = 0;</a>
<a name="ln784"> </a>
<a name="ln785">      Measure* measure = score-&gt;firstMeasure();</a>
<a name="ln786">      bool mixChange = false;</a>
<a name="ln787">      bool lastSlurAdd = false;</a>
<a name="ln788">      for (int bar = 0; bar &lt; measures; ++bar, measure = measure-&gt;nextMeasure()) {</a>
<a name="ln789">            if (!f-&gt;isReadable())</a>
<a name="ln790">                  break;</a>
<a name="ln791">            const GpBar&amp; gpbar = bars[bar];</a>
<a name="ln792">            if (!gpbar.marker.isEmpty()) {</a>
<a name="ln793">                  RehearsalMark* s = new RehearsalMark(score);</a>
<a name="ln794">                  s-&gt;setPlainText(gpbar.marker.trimmed());</a>
<a name="ln795">                  s-&gt;setTrack(0);</a>
<a name="ln796">                  Segment* segment = measure-&gt;getSegment(SegmentType::ChordRest, measure-&gt;tick());</a>
<a name="ln797">                  segment-&gt;add(s);</a>
<a name="ln798">                  }</a>
<a name="ln799"> </a>
<a name="ln800">            std::vector&lt;Tuplet*&gt; tuplets(staves);</a>
<a name="ln801">            for (int staffIdx = 0; staffIdx &lt; staves; ++staffIdx)</a>
<a name="ln802">                  tuplets[staffIdx] = 0;</a>
<a name="ln803"> </a>
<a name="ln804">            for (int staffIdx = 0; staffIdx &lt; staves; ++staffIdx) {</a>
<a name="ln805">                  Fraction measureLen = {0,1};</a>
<a name="ln806">                  Fraction tick  = measure-&gt;tick();</a>
<a name="ln807">                  int beats = readInt();</a>
<a name="ln808">                  int track = staffIdx * VOICES;</a>
<a name="ln809"> </a>
<a name="ln810">                  if (!f-&gt;isReadable())</a>
<a name="ln811">                        break;</a>
<a name="ln812">                  for (int beat = 0; beat &lt; beats; ++beat) {</a>
<a name="ln813">                        slide = -1;</a>
<a name="ln814">                        if (slides.contains(track))</a>
<a name="ln815">                              slide = slides.take(track);</a>
<a name="ln816"> </a>
<a name="ln817">                        uchar beatBits = readUChar();</a>
<a name="ln818">                        bool dotted = beatBits &amp; 0x1;</a>
<a name="ln819">                        int pause = -1;</a>
<a name="ln820">                        if (beatBits &amp; BEAT_PAUSE)</a>
<a name="ln821">                              pause = readUChar();</a>
<a name="ln822">                        int len = readChar();</a>
<a name="ln823">                        int tuple = 0;</a>
<a name="ln824">                        if (beatBits &amp; BEAT_TUPLET) {</a>
<a name="ln825">                              tuple = readInt();</a>
<a name="ln826">#if 0 // TODO: ws</a>
<a name="ln827">                              if (tupleKind[staffIdx])</a>
<a name="ln828">                                    --tupleKind[staffIdx];</a>
<a name="ln829">                              else {</a>
<a name="ln830">                                    tupleKind[staffIdx] = tuple - 1;</a>
<a name="ln831">                                    curTuple = tuple;</a>
<a name="ln832">                                    }</a>
<a name="ln833">#endif</a>
<a name="ln834">                              }</a>
<a name="ln835">                        else if (tupleKind[staffIdx]) {</a>
<a name="ln836">                              //TODO: ws                              tuple = curTuple;</a>
<a name="ln837">                              //					--tupleKind[staffIdx];</a>
<a name="ln838">                              }</a>
<a name="ln839">                        Segment* segment = measure-&gt;getSegment(SegmentType::ChordRest, tick);</a>
<a name="ln840">                        if (beatBits &amp; BEAT_CHORD) {</a>
<a name="ln841">                              int numStrings = score-&gt;staff(staffIdx)-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;strings();</a>
<a name="ln842">                              int header = readUChar();</a>
<a name="ln843">                              QString name;</a>
<a name="ln844">                              if ((header &amp; 1) == 0) {</a>
<a name="ln845">                                    name = readDelphiString();</a>
<a name="ln846">                                    readChord(segment, staffIdx * VOICES, numStrings, name, false);</a>
<a name="ln847">                                    }</a>
<a name="ln848">                              else  {</a>
<a name="ln849">                                    skip(16);</a>
<a name="ln850">                                    name = readPascalString(21);</a>
<a name="ln851">                                    skip(4);</a>
<a name="ln852">                                    readChord(segment, staffIdx * VOICES, numStrings, name, true);</a>
<a name="ln853">                                    skip(32);</a>
<a name="ln854">                                    }</a>
<a name="ln855">                              }</a>
<a name="ln856"> </a>
<a name="ln857">                        Lyrics* lyrics = 0;</a>
<a name="ln858">                        if (beatBits &amp; BEAT_LYRICS) {</a>
<a name="ln859">                              lyrics = new Lyrics(score);</a>
<a name="ln860">                              auto  str = readDelphiString();</a>
<a name="ln861">                              //TODO-ws					str.erase(std::remove_if(str.begin(), str.end(), [](char c){return c == '_'; }), str.end());</a>
<a name="ln862">                              lyrics-&gt;setPlainText(str);</a>
<a name="ln863">                              }</a>
<a name="ln864">                        gpLyrics.beatCounter++;</a>
<a name="ln865">                        if (gpLyrics.beatCounter &gt;= gpLyrics.fromBeat &amp;&amp; gpLyrics.lyricTrack == staffIdx + 1) {</a>
<a name="ln866">                              int index = gpLyrics.beatCounter - gpLyrics.fromBeat;</a>
<a name="ln867">                              if (index &lt; gpLyrics.lyrics.size()) {</a>
<a name="ln868">                                    lyrics = new Lyrics(score);</a>
<a name="ln869">                                    lyrics-&gt;setPlainText(gpLyrics.lyrics[index]);</a>
<a name="ln870">                                    }</a>
<a name="ln871">                              }</a>
<a name="ln872">                        int beatEffects = 0;</a>
<a name="ln873">                        if (beatBits &amp; BEAT_EFFECTS)</a>
<a name="ln874">                              beatEffects = readBeatEffects(track, segment);</a>
<a name="ln875">                        last_segment = segment;</a>
<a name="ln876">                        if (beatBits &amp; BEAT_MIX_CHANGE) {</a>
<a name="ln877">                              readMixChange(measure);</a>
<a name="ln878">                              mixChange = true;</a>
<a name="ln879">                              }</a>
<a name="ln880">#if 0</a>
<a name="ln881">                        else  {</a>
<a name="ln882">                              if (bar == 0)</a>
<a name="ln883">                                    setTempo(tempo, measure);</a>
<a name="ln884">                              }</a>
<a name="ln885">#endif</a>
<a name="ln886">                        int strings = readUChar();   // used strings mask</a>
<a name="ln887">                        Fraction l  = len2fraction(len);</a>
<a name="ln888"> </a>
<a name="ln889">                        // Some beat effects could add a Chord before this</a>
<a name="ln890">                        ChordRest* cr = segment-&gt;cr(track);</a>
<a name="ln891"> </a>
<a name="ln892">                        if (strings == 0) {</a>
<a name="ln893">                              if(segment-&gt;cr(track)){</a>
<a name="ln894">                                    segment-&gt;remove(segment-&gt;cr(track));</a>
<a name="ln895">                                    delete cr;</a>
<a name="ln896">                                    cr = 0;</a>
<a name="ln897">                                    }</a>
<a name="ln898">                              cr = new Rest(score);</a>
<a name="ln899">                              }</a>
<a name="ln900">                        else {</a>
<a name="ln901">                              if(!segment-&gt;cr(track))</a>
<a name="ln902">                                    cr = new Chord(score);</a>
<a name="ln903">                              }</a>
<a name="ln904">                        cr-&gt;setParent(segment);</a>
<a name="ln905">                        cr-&gt;setTrack(track);</a>
<a name="ln906">                        if (lyrics)</a>
<a name="ln907">                              cr-&gt;add(lyrics);</a>
<a name="ln908"> </a>
<a name="ln909">                        TDuration d(l);</a>
<a name="ln910">                        d.setDots(dotted ? 1 : 0);</a>
<a name="ln911"> </a>
<a name="ln912">                        if (dotted)</a>
<a name="ln913">                              l = l + (l * Fraction(1,2));</a>
<a name="ln914">                        if (tuple) {</a>
<a name="ln915">                              Tuplet* tuplet = tuplets[staffIdx];</a>
<a name="ln916">                              if ((tuplet == 0) || (tuplet-&gt;elementsDuration() == tuplet-&gt;baseLen().fraction() * tuplet-&gt;ratio().numerator())) {</a>
<a name="ln917">                                    tuplet = new Tuplet(score);</a>
<a name="ln918">                                    tuplet-&gt;setTick(tick);</a>
<a name="ln919">                                    tuplet-&gt;setTrack(cr-&gt;track());</a>
<a name="ln920">                                    tuplets[staffIdx] = tuplet;</a>
<a name="ln921">                                    setTuplet(tuplet, tuple);</a>
<a name="ln922">                                    tuplet-&gt;setParent(measure);</a>
<a name="ln923">                                    }</a>
<a name="ln924">                              tuplet-&gt;setTrack(track);</a>
<a name="ln925">                              tuplet-&gt;setBaseLen(l);</a>
<a name="ln926">                              tuplet-&gt;setTicks(l * tuplet-&gt;ratio().denominator());</a>
<a name="ln927">                              cr-&gt;setTuplet(tuplet);</a>
<a name="ln928">                              tuplet-&gt;add(cr);</a>
<a name="ln929">                              }</a>
<a name="ln930">                        else</a>
<a name="ln931">                              tuplets[staffIdx] = 0;  // needed?</a>
<a name="ln932"> </a>
<a name="ln933">                        cr-&gt;setTicks(l);</a>
<a name="ln934">                        if (cr-&gt;isRest() &amp;&amp; (pause == 0 || l &gt;= measure-&gt;ticks())) {</a>
<a name="ln935">                              cr-&gt;setDurationType(TDuration::DurationType::V_MEASURE);</a>
<a name="ln936">                              cr-&gt;setTicks(measure-&gt;ticks());</a>
<a name="ln937">                              }</a>
<a name="ln938">                        else</a>
<a name="ln939">                              cr-&gt;setDurationType(d);</a>
<a name="ln940">                        if (!segment-&gt;cr(track))</a>
<a name="ln941">                              segment-&gt;add(cr);</a>
<a name="ln942">                        Staff* staff   = cr-&gt;staff();</a>
<a name="ln943">                        int numStrings = staff-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;strings();</a>
<a name="ln944">                        bool hasSlur   = false;</a>
<a name="ln945">                        int dynam      = -1;</a>
<a name="ln946">                        if (cr &amp;&amp; cr-&gt;isChord()) {    // TODO::ws  crashes without if</a>
<a name="ln947">                              for (int i = 6; i &gt;= 0; --i) {</a>
<a name="ln948">                                    if (strings &amp; (1 &lt;&lt; i) &amp;&amp; ((6-i) &lt; numStrings)) {</a>
<a name="ln949">                                          Note* note = new Note(score);</a>
<a name="ln950">                                          // apply dotted notes to the note</a>
<a name="ln951">                                          if (dotted) {</a>
<a name="ln952">                                                // there is at most one dotted note in this guitar pro version</a>
<a name="ln953">                                                NoteDot* dot = new NoteDot(score);</a>
<a name="ln954">                                                dot-&gt;setParent(note);</a>
<a name="ln955">                                                dot-&gt;setTrack(track);  // needed to know the staff it belongs to (and detect tablature)</a>
<a name="ln956">                                                dot-&gt;setVisible(true);</a>
<a name="ln957">                                                note-&gt;add(dot);</a>
<a name="ln958">                                                }</a>
<a name="ln959">                                          toChord(cr)-&gt;add(note);</a>
<a name="ln960"> </a>
<a name="ln961">                                          hasSlur = readNote(6-i, staffIdx, note);</a>
<a name="ln962">                                          dynam = std::max(dynam, previousDynamic);</a>
<a name="ln963">                                          note-&gt;setTpcFromPitch();</a>
<a name="ln964">                                          }</a>
<a name="ln965">                                    }</a>
<a name="ln966">                              } //ws</a>
<a name="ln967">                        if (cr &amp;&amp; cr-&gt;isChord()) {</a>
<a name="ln968">                              applyBeatEffects(toChord(cr), beatEffects);</a>
<a name="ln969">                              if (dynam != curDynam[track]) {</a>
<a name="ln970">                                    curDynam[track] = dynam;</a>
<a name="ln971">                                    addDynamic(toChord(cr)-&gt;notes().front(), dynam);</a>
<a name="ln972">                                    }</a>
<a name="ln973">                              }</a>
<a name="ln974"> </a>
<a name="ln975">                        // if we see that a tied note has been constructed do not create the tie</a>
<a name="ln976">                        if (slides[track] == -2) {</a>
<a name="ln977">                              slide = 0;</a>
<a name="ln978">                              slides[track] = -1;</a>
<a name="ln979">                              }</a>
<a name="ln980">                        bool slurSwap = true;</a>
<a name="ln981">                        if (slide != 2) {</a>
<a name="ln982">                              if (hasSlur &amp;&amp; (slurs[staffIdx] == 0)) {</a>
<a name="ln983">                                    Slur* slur = new Slur(score);</a>
<a name="ln984">                                    slur-&gt;setParent(0);</a>
<a name="ln985">                                    slur-&gt;setTrack(track);</a>
<a name="ln986">                                    slur-&gt;setTrack2(track);</a>
<a name="ln987">                                    slur-&gt;setTick(cr-&gt;tick());</a>
<a name="ln988">                                    slur-&gt;setTick2(cr-&gt;tick());</a>
<a name="ln989">                                    slurs[staffIdx] = slur;</a>
<a name="ln990">                                    score-&gt;addElement(slur);</a>
<a name="ln991">                                    }</a>
<a name="ln992">                              else if (slurs[staffIdx] &amp;&amp; !hasSlur) {</a>
<a name="ln993">                                    // TODO: check slur</a>
<a name="ln994">                                    Slur* s = slurs[staffIdx];</a>
<a name="ln995">                                    slurs[staffIdx] = 0;</a>
<a name="ln996">                                    s-&gt;setTick2(cr-&gt;tick());</a>
<a name="ln997">                                    s-&gt;setTrack2(cr-&gt;track());</a>
<a name="ln998">                                    if (cr-&gt;isChord()) {</a>
<a name="ln999">                                          lastSlurAdd = true;</a>
<a name="ln1000">                                          slurSwap = false;</a>
<a name="ln1001">                                          }</a>
<a name="ln1002">                                    //TODO-ws                           cr-&gt;has_slur = true;</a>
<a name="ln1003">                                    }</a>
<a name="ln1004">                              else if (slurs[staffIdx] &amp;&amp; hasSlur) {</a>
<a name="ln1005">                                    }</a>
<a name="ln1006">                              }</a>
<a name="ln1007">                        if (cr &amp;&amp; (cr-&gt;isChord()) &amp;&amp; slide &gt; 0) {</a>
<a name="ln1008">                              auto chord = toChord(cr);</a>
<a name="ln1009">                              auto effect = convertGP4SlideNum(slide);</a>
<a name="ln1010">                              if (slide &gt; 2)</a>
<a name="ln1011">                                    createSlide(convertGP4SlideNum(slide), cr, staffIdx);</a>
<a name="ln1012">                              if (slide &lt; 3 || effect == SLIDE_OUT_UP) {</a>
<a name="ln1013">                                    Note* last = chord-&gt;upNote();</a>
<a name="ln1014">                                    auto seg = chord-&gt;segment();</a>
<a name="ln1015">                                    Measure* mes = seg-&gt;measure();</a>
<a name="ln1016">                                    while ((seg = seg-&gt;prev()) || (mes = mes-&gt;prevMeasure())) {</a>
<a name="ln1017">                                          if (!seg)</a>
<a name="ln1018">                                                break;//seg = mes-&gt;last();</a>
<a name="ln1019">                                          if (seg-&gt;segmentType() == SegmentType::ChordRest) {</a>
<a name="ln1020">                                                bool br = false;</a>
<a name="ln1021">                                                Chord* cr1 = toChord(seg-&gt;cr(chord-&gt;track()));</a>
<a name="ln1022">                                                if (cr1) {</a>
<a name="ln1023">                                                      for (auto n : cr1-&gt;notes()) {</a>
<a name="ln1024">                                                            if (n-&gt;string() == last-&gt;string()) {</a>
<a name="ln1025">                                                                  Glissando* s = new Glissando(score);</a>
<a name="ln1026">                                                                  s-&gt;setAnchor(Spanner::Anchor::NOTE);</a>
<a name="ln1027">                                                                  s-&gt;setStartElement(n);</a>
<a name="ln1028">                                                                  s-&gt;setTick(seg-&gt;tick());</a>
<a name="ln1029">                                                                  s-&gt;setTrack(chord-&gt;track());</a>
<a name="ln1030">                                                                  s-&gt;setParent(n);</a>
<a name="ln1031">                                                                  s-&gt;setGlissandoType(GlissandoType::STRAIGHT);</a>
<a name="ln1032">                                                                  s-&gt;setEndElement(last);</a>
<a name="ln1033">                                                                  s-&gt;setTick2(chord-&gt;segment()-&gt;tick());</a>
<a name="ln1034">                                                                  s-&gt;setTrack2(chord-&gt;track());</a>
<a name="ln1035">                                                                  score-&gt;addElement(s);</a>
<a name="ln1036">                                                                  if (slide == 2 || effect == SLIDE_OUT_UP) {</a>
<a name="ln1037">                                                                        if (!lastSlurAdd) {</a>
<a name="ln1038">                                                                              createSlur(true, chord-&gt;staffIdx(), cr1);</a>
<a name="ln1039">                                                                              createSlur(false, chord-&gt;staffIdx(), chord);</a>
<a name="ln1040">                                                                              }</a>
<a name="ln1041">                                                                        }</a>
<a name="ln1042">                                                                  br = true;</a>
<a name="ln1043">                                                                  break;</a>
<a name="ln1044">                                                                  }</a>
<a name="ln1045">                                                            }</a>
<a name="ln1046">                                                      }</a>
<a name="ln1047">                                                if (br)</a>
<a name="ln1048">                                                      break;</a>
<a name="ln1049">                                                }</a>
<a name="ln1050">                                          }</a>
<a name="ln1051">                                    }</a>
<a name="ln1052">                              }</a>
<a name="ln1053">                        if (slurSwap)</a>
<a name="ln1054">                              lastSlurAdd = false;</a>
<a name="ln1055">                        restsForEmptyBeats(segment, measure, cr, l, track, tick);</a>
<a name="ln1056">                        createSlur(hasSlur, staffIdx, cr);</a>
<a name="ln1057">                        tick += cr-&gt;actualTicks();</a>
<a name="ln1058">                        measureLen += cr-&gt;actualTicks();</a>
<a name="ln1059">                        }</a>
<a name="ln1060">                  if (measureLen &lt; measure-&gt;ticks()) {</a>
<a name="ln1061">                        score-&gt;setRest(tick, track, measure-&gt;ticks() - measureLen, false, nullptr, false);</a>
<a name="ln1062">                        }</a>
<a name="ln1063">                  }</a>
<a name="ln1064"> </a>
<a name="ln1065">            if (bar == 1 &amp;&amp; !mixChange)</a>
<a name="ln1066">                  setTempo(temp, score-&gt;firstMeasure());</a>
<a name="ln1067">            }</a>
<a name="ln1068"> </a>
<a name="ln1069">      for (auto n : slideList) {</a>
<a name="ln1070">            Segment* segment = n-&gt;chord()-&gt;segment();</a>
<a name="ln1071">            Measure* measure1 = segment-&gt;measure();</a>
<a name="ln1072">            int segment_counter = 0;</a>
<a name="ln1073">            while ((segment = segment-&gt;next1(SegmentType::ChordRest)) || ((measure1 = measure1-&gt;nextMeasure()) &amp;&amp; (segment = measure1-&gt;first()))) {</a>
<a name="ln1074">                  if (!segment-&gt;isChordRestType())</a>
<a name="ln1075">                        continue;</a>
<a name="ln1076">                  bool br = false;</a>
<a name="ln1077">                  ChordRest* cr = segment-&gt;cr(n-&gt;track());</a>
<a name="ln1078">                  if (cr &amp;&amp; cr-&gt;isChord()) {</a>
<a name="ln1079">                        Chord* c = toChord(cr);</a>
<a name="ln1080">                        ++segment_counter;</a>
<a name="ln1081">                        if (segment_counter &gt; 2)</a>
<a name="ln1082">                              break;</a>
<a name="ln1083">                        for (Note* nt : c-&gt;notes()) {</a>
<a name="ln1084">                              if (nt-&gt;string() == n-&gt;string()) {</a>
<a name="ln1085">                                    for (auto e : nt-&gt;el()) {</a>
<a name="ln1086">                                          if (e-&gt;isChordLine()) {</a>
<a name="ln1087">                                                auto cl = toChordLine(e);</a>
<a name="ln1088">                                                if (cl-&gt;chordLineType() == ChordLineType::PLOP || cl-&gt;chordLineType() == ChordLineType::SCOOP) {</a>
<a name="ln1089">                                                      br = true;</a>
<a name="ln1090">                                                      break;</a>
<a name="ln1091">                                                      }</a>
<a name="ln1092">                                                }</a>
<a name="ln1093">                                          }</a>
<a name="ln1094">                                    if (br)</a>
<a name="ln1095">                                          break;</a>
<a name="ln1096">#if 1  // TODO-ws: crash</a>
<a name="ln1097">                                    Glissando* s = new Glissando(score);</a>
<a name="ln1098">                                    s-&gt;setAnchor(Spanner::Anchor::NOTE);</a>
<a name="ln1099">                                    s-&gt;setStartElement(n);</a>
<a name="ln1100">                                    s-&gt;setTick(n-&gt;chord()-&gt;segment()-&gt;tick());</a>
<a name="ln1101">                                    s-&gt;setTrack(n-&gt;track());</a>
<a name="ln1102">                                    s-&gt;setParent(n);</a>
<a name="ln1103">                                    s-&gt;setGlissandoType(GlissandoType::STRAIGHT);</a>
<a name="ln1104">                                    s-&gt;setEndElement(nt);</a>
<a name="ln1105">                                    s-&gt;setTick2(nt-&gt;chord()-&gt;segment()-&gt;tick());</a>
<a name="ln1106">                                    s-&gt;setTrack2(n-&gt;track());</a>
<a name="ln1107">                                    score-&gt;addElement(s);</a>
<a name="ln1108">#endif</a>
<a name="ln1109">                                    br = true;</a>
<a name="ln1110">                                    break;</a>
<a name="ln1111">                                    }</a>
<a name="ln1112">                              }</a>
<a name="ln1113">                        if (br)</a>
<a name="ln1114">                              break;</a>
<a name="ln1115">                        }</a>
<a name="ln1116">                  }</a>
<a name="ln1117">            }</a>
<a name="ln1118"> </a>
<a name="ln1119">      return true;</a>
<a name="ln1120">      }</a>
<a name="ln1121"> </a>
<a name="ln1122">}</a>

</code></pre>
<div class="balloon" rel="306"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v581/" target="_blank">V581</a> The conditional expressions of the 'if' statements situated alongside each other are identical. Check lines: 302, 306.</p></div>
<div class="balloon" rel="402"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v560/" target="_blank">V560</a> A part of conditional expression is always false: slideKind == 254.</p></div>
<div class="balloon" rel="402"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v560/" target="_blank">V560</a> A part of conditional expression is always false: slideKind == 255.</p></div>
<div class="balloon" rel="502"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'e' is always true.</p></div>
<div class="balloon" rel="1057"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1004/" target="_blank">V1004</a> The 'cr' pointer was used unsafely after it was verified against nullptr. Check lines: 946, 1057.</p></div>
<div class="balloon" rel="927"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'cr' pointer was utilized before it was verified against nullptr. Check lines: 927, 946.</p></div>
<div class="balloon" rel="868"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The 'lyrics' pointer was assigned values twice without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
