
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>musescore.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2016 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &lt;fenv.h&gt;</a>
<a name="ln14">#include &quot;network/loginmanager.h&quot;</a>
<a name="ln15">#include &quot;uploadscoredialog.h&quot;</a>
<a name="ln16">#include &lt;QStyleFactory&gt;</a>
<a name="ln17">#include &quot;config.h&quot;</a>
<a name="ln18">#include &quot;musescore.h&quot;</a>
<a name="ln19">#include &quot;musescoredialogs.h&quot;</a>
<a name="ln20">#include &quot;scoreview.h&quot;</a>
<a name="ln21">#include &quot;libmscore/style.h&quot;</a>
<a name="ln22">#include &quot;libmscore/score.h&quot;</a>
<a name="ln23">#include &quot;instrdialog.h&quot;</a>
<a name="ln24">#include &quot;preferences.h&quot;</a>
<a name="ln25">#include &quot;prefsdialog.h&quot;</a>
<a name="ln26">#include &quot;icons.h&quot;</a>
<a name="ln27">#include &quot;libmscore/xml.h&quot;</a>
<a name="ln28">#include &quot;seq.h&quot;</a>
<a name="ln29">#include &quot;libmscore/tempo.h&quot;</a>
<a name="ln30">#include &quot;libmscore/sym.h&quot;</a>
<a name="ln31">#include &quot;pagesettings.h&quot;</a>
<a name="ln32">#include &quot;debugger/debugger.h&quot;</a>
<a name="ln33">#include &quot;editstyle.h&quot;</a>
<a name="ln34">#include &quot;playpanel.h&quot;</a>
<a name="ln35">#include &quot;libmscore/page.h&quot;</a>
<a name="ln36">#include &quot;mixer.h&quot;</a>
<a name="ln37">#include &quot;selectionwindow.h&quot;</a>
<a name="ln38">#include &quot;palette.h&quot;</a>
<a name="ln39">#include &quot;palette/palettemodel.h&quot;</a>
<a name="ln40">#include &quot;palette/palettewidget.h&quot;</a>
<a name="ln41">#include &quot;palette/paletteworkspace.h&quot;</a>
<a name="ln42">#include &quot;libmscore/part.h&quot;</a>
<a name="ln43">#include &quot;libmscore/drumset.h&quot;</a>
<a name="ln44">#include &quot;libmscore/instrtemplate.h&quot;</a>
<a name="ln45">#include &quot;libmscore/note.h&quot;</a>
<a name="ln46">#include &quot;libmscore/staff.h&quot;</a>
<a name="ln47">#include &quot;driver.h&quot;</a>
<a name="ln48">#include &quot;libmscore/harmony.h&quot;</a>
<a name="ln49">#include &quot;magbox.h&quot;</a>
<a name="ln50">#include &quot;libmscore/sig.h&quot;</a>
<a name="ln51">#include &quot;libmscore/undo.h&quot;</a>
<a name="ln52">#include &quot;synthcontrol.h&quot;</a>
<a name="ln53">#include &quot;pianoroll.h&quot;</a>
<a name="ln54">#include &quot;drumroll.h&quot;</a>
<a name="ln55">#include &quot;scoretab.h&quot;</a>
<a name="ln56">#include &quot;timedialog.h&quot;</a>
<a name="ln57">#include &quot;keyedit.h&quot;</a>
<a name="ln58">#include &quot;harmonyedit.h&quot;</a>
<a name="ln59">#include &quot;navigator.h&quot;</a>
<a name="ln60">#include &quot;newwizard.h&quot;</a>
<a name="ln61">#include &quot;timeline.h&quot;</a>
<a name="ln62">#include &quot;importmidi/importmidi_panel.h&quot;</a>
<a name="ln63">#include &quot;importmidi/importmidi_instrument.h&quot;</a>
<a name="ln64">#include &quot;importmidi/importmidi_operations.h&quot;</a>
<a name="ln65">#include &quot;scorecmp/scorecmp.h&quot;</a>
<a name="ln66">#include &quot;script/recorderwidget.h&quot;</a>
<a name="ln67">#include &quot;libmscore/scorediff.h&quot;</a>
<a name="ln68">#include &quot;libmscore/chord.h&quot;</a>
<a name="ln69">#include &quot;libmscore/segment.h&quot;</a>
<a name="ln70">#include &quot;editraster.h&quot;</a>
<a name="ln71">#include &quot;pianotools.h&quot;</a>
<a name="ln72">#include &quot;mediadialog.h&quot;</a>
<a name="ln73">#include &quot;workspace.h&quot;</a>
<a name="ln74">#include &quot;workspacecombobox.h&quot;</a>
<a name="ln75">#include &quot;selectdialog.h&quot;</a>
<a name="ln76">#include &quot;selectnotedialog.h&quot;</a>
<a name="ln77">#include &quot;transposedialog.h&quot;</a>
<a name="ln78">#include &quot;metaedit.h&quot;</a>
<a name="ln79">#include &quot;inspector/inspector.h&quot;</a>
<a name="ln80">#ifdef OMR</a>
<a name="ln81">#include &quot;omrpanel.h&quot;</a>
<a name="ln82">#endif</a>
<a name="ln83">#include &quot;shortcut.h&quot;</a>
<a name="ln84">#ifdef SCRIPT_INTERFACE</a>
<a name="ln85">#include &quot;plugin/pluginCreator.h&quot;</a>
<a name="ln86">#include &quot;plugin/pluginManager.h&quot;</a>
<a name="ln87">#include &quot;plugin/qmlpluginengine.h&quot;</a>
<a name="ln88">#endif</a>
<a name="ln89">#include &quot;helpBrowser.h&quot;</a>
<a name="ln90">#include &quot;drumtools.h&quot;</a>
<a name="ln91">#include &quot;editstafftype.h&quot;</a>
<a name="ln92">#include &quot;texttools.h&quot;</a>
<a name="ln93">#include &quot;textpalette.h&quot;</a>
<a name="ln94">#include &quot;resourceManager.h&quot;</a>
<a name="ln95">#include &quot;scoreaccessibility.h&quot;</a>
<a name="ln96">#include &quot;startupWizard.h&quot;</a>
<a name="ln97">#include &quot;tourhandler.h&quot;</a>
<a name="ln98"> </a>
<a name="ln99">#include &quot;libmscore/mscore.h&quot;</a>
<a name="ln100">#include &quot;libmscore/system.h&quot;</a>
<a name="ln101">#include &quot;libmscore/measure.h&quot;</a>
<a name="ln102">#include &quot;libmscore/chordlist.h&quot;</a>
<a name="ln103">#include &quot;libmscore/volta.h&quot;</a>
<a name="ln104">#include &quot;libmscore/lasso.h&quot;</a>
<a name="ln105">#include &quot;libmscore/excerpt.h&quot;</a>
<a name="ln106">#include &quot;libmscore/synthesizerstate.h&quot;</a>
<a name="ln107">#include &quot;libmscore/utils.h&quot;</a>
<a name="ln108">#include &quot;libmscore/icon.h&quot;</a>
<a name="ln109"> </a>
<a name="ln110">#include &quot;driver.h&quot;</a>
<a name="ln111"> </a>
<a name="ln112">#include &quot;effects/zita1/zita.h&quot;</a>
<a name="ln113">#include &quot;effects/compressor/compressor.h&quot;</a>
<a name="ln114">#include &quot;effects/noeffect/noeffect.h&quot;</a>
<a name="ln115">#include &quot;synthesizer/synthesizer.h&quot;</a>
<a name="ln116">#include &quot;synthesizer/synthesizergui.h&quot;</a>
<a name="ln117">#include &quot;synthesizer/msynthesizer.h&quot;</a>
<a name="ln118">#include &quot;synthesizer/event.h&quot;</a>
<a name="ln119">#include &quot;fluid/fluid.h&quot;</a>
<a name="ln120">#include &quot;plugin/qmlplugin.h&quot;</a>
<a name="ln121">#include &quot;accessibletoolbutton.h&quot;</a>
<a name="ln122">#include &quot;toolbuttonmenu.h&quot;</a>
<a name="ln123">#include &quot;searchComboBox.h&quot;</a>
<a name="ln124">#include &quot;startcenter.h&quot;</a>
<a name="ln125">#include &quot;help.h&quot;</a>
<a name="ln126">#include &quot;awl/aslider.h&quot;</a>
<a name="ln127">#include &quot;extension.h&quot;</a>
<a name="ln128">#include &quot;thirdparty/qzip/qzipreader_p.h&quot;</a>
<a name="ln129"> </a>
<a name="ln130">#include &quot;sparkle/autoUpdater.h&quot;</a>
<a name="ln131">#if defined(WIN_SPARKLE_ENABLED)</a>
<a name="ln132">#include &quot;sparkle/winSparkleAutoUpdater.h&quot;</a>
<a name="ln133">#elif defined(MAC_SPARKLE_ENABLED)</a>
<a name="ln134">#include &quot;sparkle/sparkleAutoUpdater.h&quot;</a>
<a name="ln135">#endif</a>
<a name="ln136"> </a>
<a name="ln137">#ifdef USE_LAME</a>
<a name="ln138">#include &quot;exportmp3.h&quot;</a>
<a name="ln139">#endif</a>
<a name="ln140">#ifdef Q_OS_MAC</a>
<a name="ln141">#include &quot;macos/cocoabridge.h&quot;</a>
<a name="ln142">#endif</a>
<a name="ln143"> </a>
<a name="ln144">#ifdef AEOLUS</a>
<a name="ln145">extern Ms::Synthesizer* createAeolus();</a>
<a name="ln146">#endif</a>
<a name="ln147"> </a>
<a name="ln148">#ifdef ZERBERUS</a>
<a name="ln149">extern Ms::Synthesizer* createZerberus();</a>
<a name="ln150">#endif</a>
<a name="ln151"> </a>
<a name="ln152">#ifdef QT_NO_DEBUG</a>
<a name="ln153">      Q_LOGGING_CATEGORY(undoRedo, &quot;undoRedo&quot;, QtCriticalMsg);</a>
<a name="ln154">#else</a>
<a name="ln155">      Q_LOGGING_CATEGORY(undoRedo, &quot;undoRedo&quot;, QtCriticalMsg);</a>
<a name="ln156">//      Q_LOGGING_CATEGORY(undoRedo, &quot;undoRedo&quot;);</a>
<a name="ln157">#endif</a>
<a name="ln158"> </a>
<a name="ln159">#ifdef BUILD_CRASH_REPORTER</a>
<a name="ln160">#include &quot;thirdparty/libcrashreporter-qt/src/libcrashreporter-handler/Handler.h&quot;</a>
<a name="ln161">#endif</a>
<a name="ln162"> </a>
<a name="ln163">#ifndef TELEMETRY_DISABLED</a>
<a name="ln164">#include &quot;actioneventobserver.h&quot;</a>
<a name="ln165">#include &quot;widgets/telemetrypermissiondialog.h&quot;</a>
<a name="ln166">#endif</a>
<a name="ln167">#include &quot;telemetrymanager.h&quot;</a>
<a name="ln168"> </a>
<a name="ln169">namespace Ms {</a>
<a name="ln170"> </a>
<a name="ln171">MuseScore* mscore;</a>
<a name="ln172">MasterSynthesizer* synti;</a>
<a name="ln173"> </a>
<a name="ln174">bool enableExperimental = false;</a>
<a name="ln175"> </a>
<a name="ln176">QString dataPath;</a>
<a name="ln177">QString iconPath;</a>
<a name="ln178"> </a>
<a name="ln179">bool converterMode = false;</a>
<a name="ln180">static bool rawDiffMode = false;</a>
<a name="ln181">static bool diffMode = false;</a>
<a name="ln182">static bool scriptTestMode = false;</a>
<a name="ln183">bool processJob = false;</a>
<a name="ln184">bool externalIcons = false;</a>
<a name="ln185">bool pluginMode = false;</a>
<a name="ln186">static bool startWithNewScore = false;</a>
<a name="ln187">double guiScaling = 0.0;</a>
<a name="ln188">static double userDPI = 0.0;</a>
<a name="ln189">int trimMargin = -1;</a>
<a name="ln190">bool noWebView = false;</a>
<a name="ln191">bool exportScoreParts = false;</a>
<a name="ln192">bool ignoreWarnings = false;</a>
<a name="ln193">bool exportScoreMedia = false;</a>
<a name="ln194">bool exportScoreMeta = false;</a>
<a name="ln195">bool exportScoreMp3 = false;</a>
<a name="ln196">bool exportScorePartsPdf = false;</a>
<a name="ln197">static bool exportTransposedScore = false;</a>
<a name="ln198">static QString transposeExportOptions;</a>
<a name="ln199"> </a>
<a name="ln200">QString mscoreGlobalShare;</a>
<a name="ln201"> </a>
<a name="ln202">static QString outFileName;</a>
<a name="ln203">static QString jsonFileName;</a>
<a name="ln204">static QString audioDriver;</a>
<a name="ln205">static QString pluginName;</a>
<a name="ln206">static QString styleFile;</a>
<a name="ln207">static QString extensionName;</a>
<a name="ln208">static bool scoresOnCommandline { false };</a>
<a name="ln209"> </a>
<a name="ln210">static QList&lt;QTranslator*&gt; translatorList;</a>
<a name="ln211"> </a>
<a name="ln212">QString localeName;</a>
<a name="ln213">bool useFactorySettings = false;</a>
<a name="ln214">bool deletePreferences = false;</a>
<a name="ln215">QString styleName;</a>
<a name="ln216">QString revision;</a>
<a name="ln217">QErrorMessage* errorMessage;</a>
<a name="ln218">const char* voiceActions[] = { &quot;voice-1&quot;, &quot;voice-2&quot;, &quot;voice-3&quot;, &quot;voice-4&quot; };</a>
<a name="ln219"> </a>
<a name="ln220">bool mscoreFirstStart = false;</a>
<a name="ln221"> </a>
<a name="ln222">const std::list&lt;const char*&gt; MuseScore::_allNoteInputMenuEntries {</a>
<a name="ln223">            &quot;note-input&quot;,</a>
<a name="ln224">            &quot;pad-note-128&quot;,</a>
<a name="ln225">            &quot;pad-note-64&quot;,</a>
<a name="ln226">            &quot;pad-note-32&quot;,</a>
<a name="ln227">            &quot;pad-note-16&quot;,</a>
<a name="ln228">            &quot;pad-note-8&quot;,</a>
<a name="ln229">            &quot;pad-note-4&quot;,</a>
<a name="ln230">            &quot;pad-note-2&quot;,</a>
<a name="ln231">            &quot;pad-note-1&quot;,</a>
<a name="ln232">            &quot;note-breve&quot;,</a>
<a name="ln233">            &quot;note-longa&quot;,</a>
<a name="ln234">            &quot;pad-dot&quot;,</a>
<a name="ln235">            &quot;pad-dotdot&quot;,</a>
<a name="ln236">            &quot;pad-dot3&quot;,</a>
<a name="ln237">            &quot;pad-dot4&quot;,</a>
<a name="ln238">            &quot;tie&quot;,</a>
<a name="ln239">            &quot;&quot;,</a>
<a name="ln240">            &quot;pad-rest&quot;,</a>
<a name="ln241">            &quot;&quot;,</a>
<a name="ln242">            &quot;sharp2&quot;,</a>
<a name="ln243">            &quot;sharp&quot;,</a>
<a name="ln244">            &quot;nat&quot;,</a>
<a name="ln245">            &quot;flat&quot;,</a>
<a name="ln246">            &quot;flat2&quot;,</a>
<a name="ln247">            &quot;flip&quot;,</a>
<a name="ln248">            &quot;&quot;,</a>
<a name="ln249">            &quot;voice-1&quot;,</a>
<a name="ln250">            &quot;voice-2&quot;,</a>
<a name="ln251">            &quot;voice-3&quot;,</a>
<a name="ln252">            &quot;voice-4&quot;</a>
<a name="ln253">            };</a>
<a name="ln254"> </a>
<a name="ln255">const std::list&lt;const char*&gt; MuseScore::_allFileOperationEntries {</a>
<a name="ln256">            &quot;file-new&quot;,</a>
<a name="ln257">            &quot;file-open&quot;,</a>
<a name="ln258">            &quot;file-save&quot;,</a>
<a name="ln259">            &quot;file-save-online&quot;,</a>
<a name="ln260">            &quot;print&quot;,</a>
<a name="ln261">            &quot;undo&quot;,</a>
<a name="ln262">            &quot;redo&quot;</a>
<a name="ln263">            };</a>
<a name="ln264"> </a>
<a name="ln265">const std::list&lt;const char*&gt; MuseScore::_allPlaybackControlEntries {</a>
<a name="ln266">#ifdef HAS_MIDI</a>
<a name="ln267">            &quot;midi-on&quot;,</a>
<a name="ln268">            &quot;&quot;,</a>
<a name="ln269">#endif</a>
<a name="ln270">            &quot;rewind&quot;,</a>
<a name="ln271">            &quot;play&quot;,</a>
<a name="ln272">            &quot;loop&quot;,</a>
<a name="ln273">            &quot;&quot;,</a>
<a name="ln274">            &quot;repeat&quot;,</a>
<a name="ln275">            &quot;pan&quot;,</a>
<a name="ln276">            &quot;metronome&quot;,</a>
<a name="ln277">            &quot;countin&quot;</a>
<a name="ln278">            };</a>
<a name="ln279"> </a>
<a name="ln280">extern TextPalette* textPalette;</a>
<a name="ln281"> </a>
<a name="ln282">static constexpr double SCALE_MAX  = 16.0;</a>
<a name="ln283">static constexpr double SCALE_MIN  = 0.05;</a>
<a name="ln284">static constexpr double SCALE_STEP = 1.7;</a>
<a name="ln285"> </a>
<a name="ln286">static const char* saveOnlineMenuItem = &quot;file-save-online&quot;;</a>
<a name="ln287"> </a>
<a name="ln288">#ifdef BUILD_TELEMETRY_MODULE</a>
<a name="ln289">std::unique_ptr&lt;TelemetryManager&gt; TelemetryManager::mgr;</a>
<a name="ln290">#endif</a>
<a name="ln291"> </a>
<a name="ln292">//---------------------------------------------------------</a>
<a name="ln293">// cmdInsertMeasure</a>
<a name="ln294">//---------------------------------------------------------</a>
<a name="ln295"> </a>
<a name="ln296">void MuseScore::cmdInsertMeasures()</a>
<a name="ln297">      {</a>
<a name="ln298">      if (cs) {</a>
<a name="ln299">            if (cs-&gt;selection().isNone() &amp;&amp; !cs-&gt;selection().findMeasure()) {</a>
<a name="ln300">                  QMessageBox::warning(0, &quot;MuseScore&quot;,</a>
<a name="ln301">                        tr(&quot;No measure selected:\n&quot; &quot;Please select a measure and try again&quot;));</a>
<a name="ln302">                  }</a>
<a name="ln303">            else {</a>
<a name="ln304">                  insertMeasuresDialog = new InsertMeasuresDialog;</a>
<a name="ln305">                  insertMeasuresDialog-&gt;show();</a>
<a name="ln306">                  }</a>
<a name="ln307">            }</a>
<a name="ln308">      }</a>
<a name="ln309"> </a>
<a name="ln310">//---------------------------------------------------------</a>
<a name="ln311">//   getSharePath</a>
<a name="ln312">//---------------------------------------------------------</a>
<a name="ln313"> </a>
<a name="ln314">QString getSharePath()</a>
<a name="ln315">      {</a>
<a name="ln316">#ifdef Q_OS_WIN</a>
<a name="ln317">      QDir dir(QCoreApplication::applicationDirPath() + QString(&quot;/../&quot; INSTALL_NAME));</a>
<a name="ln318">      return dir.absolutePath() + &quot;/&quot;;</a>
<a name="ln319">#else</a>
<a name="ln320">#ifdef Q_OS_MAC</a>
<a name="ln321">      QDir dir(QCoreApplication::applicationDirPath() + QString(&quot;/../Resources&quot;));</a>
<a name="ln322">      return dir.absolutePath() + &quot;/&quot;;</a>
<a name="ln323">#else</a>
<a name="ln324">      // Try relative path (needed for portable AppImage and non-standard installations)</a>
<a name="ln325">      QDir dir(QCoreApplication::applicationDirPath() + QString(&quot;/../share/&quot; INSTALL_NAME));</a>
<a name="ln326">      if (dir.exists())</a>
<a name="ln327">            return dir.absolutePath() + &quot;/&quot;;</a>
<a name="ln328">      // Otherwise fall back to default location (e.g. if binary has moved relative to share)</a>
<a name="ln329">      return QString( INSTPREFIX &quot;/share/&quot; INSTALL_NAME);</a>
<a name="ln330">#endif</a>
<a name="ln331">#endif</a>
<a name="ln332">      }</a>
<a name="ln333"> </a>
<a name="ln334">//---------------------------------------------------------</a>
<a name="ln335">//   printVersion</a>
<a name="ln336">//---------------------------------------------------------</a>
<a name="ln337"> </a>
<a name="ln338">static void printVersion(const char* prog)</a>
<a name="ln339">      {</a>
<a name="ln340">      if (MuseScore::unstable())</a>
<a name="ln341">            fprintf(stderr, &quot;%s: Music Score Editor\nUnstable Prerelease for Version %s; Build %s\n&quot;,</a>
<a name="ln342">         prog, VERSION, qPrintable(revision));</a>
<a name="ln343">      else</a>
<a name="ln344">            fprintf(stderr, &quot;%s: Music Score Editor; Version %s; Build %s\n&quot;, prog, VERSION, qPrintable(revision));</a>
<a name="ln345">      }</a>
<a name="ln346"> </a>
<a name="ln347">static const int RECENT_LIST_SIZE = 20;</a>
<a name="ln348"> </a>
<a name="ln349">//---------------------------------------------------------</a>
<a name="ln350">//   closeEvent</a>
<a name="ln351">//---------------------------------------------------------</a>
<a name="ln352"> </a>
<a name="ln353">void MuseScore::closeEvent(QCloseEvent* ev)</a>
<a name="ln354">      {</a>
<a name="ln355">      unloadPlugins();</a>
<a name="ln356">      QList&lt;MasterScore*&gt; removeList;</a>
<a name="ln357">      for (MasterScore* score : scoreList) {</a>
<a name="ln358">            if (score-&gt;created() &amp;&amp; !score-&gt;dirty())</a>
<a name="ln359">                  removeList.append(score);</a>
<a name="ln360">            else {</a>
<a name="ln361">                  if (checkDirty(score)) {      // ask user if file is dirty</a>
<a name="ln362">                        ev-&gt;ignore();</a>
<a name="ln363">                        return;</a>
<a name="ln364">                        }</a>
<a name="ln365">                  //</a>
<a name="ln366">                  // if score is still dirty, then the user has discarded the</a>
<a name="ln367">                  // score and we can remove it from the list</a>
<a name="ln368">                  //</a>
<a name="ln369">                  if (score-&gt;created() &amp;&amp; score-&gt;dirty())</a>
<a name="ln370">                        removeList.append(score);</a>
<a name="ln371">                  }</a>
<a name="ln372">            }</a>
<a name="ln373"> </a>
<a name="ln374">      // remove all new created/not save score so they are</a>
<a name="ln375">      // note saved as session data</a>
<a name="ln376">      for (MasterScore* score : removeList) {</a>
<a name="ln377">            scoreList.removeAll(score);</a>
<a name="ln378">            scoreWasShown.remove(score);</a>
<a name="ln379">            }</a>
<a name="ln380"> </a>
<a name="ln381">      writeSessionFile(true);</a>
<a name="ln382">      for (MasterScore* score : scoreList) {</a>
<a name="ln383">            if (!score-&gt;tmpName().isEmpty()) {</a>
<a name="ln384">                  QFile f(score-&gt;tmpName());</a>
<a name="ln385">                  f.remove();</a>
<a name="ln386">                  }</a>
<a name="ln387">            }</a>
<a name="ln388"> </a>
<a name="ln389">      writeSettings();</a>
<a name="ln390"> </a>
<a name="ln391">      ev-&gt;accept();</a>
<a name="ln392"> </a>
<a name="ln393">      if (Shortcut::dirty)</a>
<a name="ln394">            Shortcut::save();</a>
<a name="ln395"> </a>
<a name="ln396">      this-&gt;deleteLater();     //this is necessary on windows http://musescore.org/node/16713</a>
<a name="ln397">      qApp-&gt;quit();</a>
<a name="ln398">      }</a>
<a name="ln399"> </a>
<a name="ln400">void updateExternalValuesFromPreferences() {</a>
<a name="ln401">      // set values in libmscore</a>
<a name="ln402">      MScore::bgColor = preferences.getColor(PREF_UI_CANVAS_BG_COLOR);</a>
<a name="ln403">      MScore::dropColor = preferences.getColor(PREF_UI_SCORE_NOTE_DROPCOLOR);</a>
<a name="ln404">      MScore::defaultColor = preferences.getColor(PREF_UI_SCORE_DEFAULTCOLOR);</a>
<a name="ln405">      MScore::defaultPlayDuration = preferences.getInt(PREF_SCORE_NOTE_DEFAULTPLAYDURATION);</a>
<a name="ln406">      MScore::panPlayback = preferences.getBool(PREF_APP_PLAYBACK_PANPLAYBACK);</a>
<a name="ln407">      MScore::playRepeats = preferences.getBool(PREF_APP_PLAYBACK_PLAYREPEATS);</a>
<a name="ln408">      MScore::warnPitchRange = preferences.getBool(PREF_SCORE_NOTE_WARNPITCHRANGE);</a>
<a name="ln409">      MScore::layoutBreakColor = preferences.getColor(PREF_UI_SCORE_LAYOUTBREAKCOLOR);</a>
<a name="ln410">      MScore::frameMarginColor = preferences.getColor(PREF_UI_SCORE_FRAMEMARGINCOLOR);</a>
<a name="ln411">      MScore::setVerticalOrientation(preferences.getBool(PREF_UI_CANVAS_SCROLL_VERTICALORIENTATION));</a>
<a name="ln412"> </a>
<a name="ln413">      MScore::selectColor[0] = preferences.getColor(PREF_UI_SCORE_VOICE1_COLOR);</a>
<a name="ln414">      MScore::selectColor[1] = preferences.getColor(PREF_UI_SCORE_VOICE2_COLOR);</a>
<a name="ln415">      MScore::selectColor[2] = preferences.getColor(PREF_UI_SCORE_VOICE3_COLOR);</a>
<a name="ln416">      MScore::selectColor[3] = preferences.getColor(PREF_UI_SCORE_VOICE4_COLOR);</a>
<a name="ln417"> </a>
<a name="ln418">      MScore::setHRaster(preferences.getInt(PREF_UI_APP_RASTER_HORIZONTAL));</a>
<a name="ln419">      MScore::setVRaster(preferences.getInt(PREF_UI_APP_RASTER_VERTICAL));</a>
<a name="ln420"> </a>
<a name="ln421">      MScore::setNudgeStep(.1);         // cursor key (default 0.1)</a>
<a name="ln422">      MScore::setNudgeStep10(1.0);      // Ctrl + cursor key (default 1.0)</a>
<a name="ln423">      MScore::setNudgeStep50(0.01);     // Alt  + cursor key (default 0.01)</a>
<a name="ln424"> </a>
<a name="ln425">      if (!preferences.getBool(PREF_APP_STARTUP_FIRSTSTART)) {</a>
<a name="ln426">            //Create directories if they are missing</a>
<a name="ln427">            QDir dir;</a>
<a name="ln428">            dir.mkpath(preferences.getString(PREF_APP_PATHS_MYSCORES));</a>
<a name="ln429">            dir.mkpath(preferences.getString(PREF_APP_PATHS_MYSTYLES));</a>
<a name="ln430">            dir.mkpath(preferences.getString(PREF_APP_PATHS_MYIMAGES));</a>
<a name="ln431">            dir.mkpath(preferences.getString(PREF_APP_PATHS_MYTEMPLATES));</a>
<a name="ln432">            dir.mkpath(preferences.getString(PREF_APP_PATHS_MYEXTENSIONS));</a>
<a name="ln433">            dir.mkpath(preferences.getString(PREF_APP_PATHS_MYPLUGINS));</a>
<a name="ln434">            foreach (QString path, preferences.getString(PREF_APP_PATHS_MYSOUNDFONTS).split(&quot;;&quot;))</a>
<a name="ln435">                  dir.mkpath(path);</a>
<a name="ln436">                  }</a>
<a name="ln437">            }</a>
<a name="ln438"> </a>
<a name="ln439">//---------------------------------------------------------</a>
<a name="ln440">//   preferencesChanged</a>
<a name="ln441">//---------------------------------------------------------</a>
<a name="ln442"> </a>
<a name="ln443">void MuseScore::preferencesChanged(bool fromWorkspace)</a>
<a name="ln444">      {</a>
<a name="ln445">      updateExternalValuesFromPreferences();</a>
<a name="ln446"> </a>
<a name="ln447">      setPlayRepeats(MScore::playRepeats);</a>
<a name="ln448">      getAction(&quot;pan&quot;)-&gt;setChecked(MScore::panPlayback);</a>
<a name="ln449">      getAction(&quot;follow&quot;)-&gt;setChecked(preferences.getBool(PREF_APP_PLAYBACK_FOLLOWSONG));</a>
<a name="ln450">      getAction(&quot;midi-on&quot;)-&gt;setChecked(preferences.getBool(PREF_IO_MIDI_ENABLEINPUT));</a>
<a name="ln451">      getAction(&quot;toggle-statusbar&quot;)-&gt;setChecked(preferences.getBool(PREF_UI_APP_SHOWSTATUSBAR));</a>
<a name="ln452">      getAction(&quot;show-tours&quot;)-&gt;setChecked(preferences.getBool(PREF_UI_APP_STARTUP_SHOWTOURS));</a>
<a name="ln453">      _statusBar-&gt;setVisible(preferences.getBool(PREF_UI_APP_SHOWSTATUSBAR));</a>
<a name="ln454"> </a>
<a name="ln455">      MuseScore::updateUiStyleAndTheme();</a>
<a name="ln456">      updateIcons();</a>
<a name="ln457"> </a>
<a name="ln458">      QString fgWallpaper = preferences.getString(PREF_UI_CANVAS_FG_WALLPAPER);</a>
<a name="ln459">      for (int i = 0; i &lt; tab1-&gt;count(); ++i) {</a>
<a name="ln460">            ScoreView* canvas = tab1-&gt;view(i);</a>
<a name="ln461">            if (canvas == 0)</a>
<a name="ln462">                  continue;</a>
<a name="ln463">            if (preferences.getBool(PREF_UI_CANVAS_BG_USECOLOR))</a>
<a name="ln464">                  canvas-&gt;setBackground(preferences.getColor(PREF_UI_CANVAS_BG_COLOR));</a>
<a name="ln465">            else {</a>
<a name="ln466">                  QPixmap* pm = new QPixmap(preferences.getString(PREF_UI_CANVAS_BG_WALLPAPER));</a>
<a name="ln467">                  canvas-&gt;setBackground(pm);</a>
<a name="ln468">                  }</a>
<a name="ln469">            if (preferences.getBool(PREF_UI_CANVAS_FG_USECOLOR))</a>
<a name="ln470">                  canvas-&gt;setForeground(preferences.getColor(PREF_UI_CANVAS_FG_COLOR));</a>
<a name="ln471">            else {</a>
<a name="ln472">                  QPixmap* pm = new QPixmap(fgWallpaper);</a>
<a name="ln473">                  if (pm == 0 || pm-&gt;isNull())</a>
<a name="ln474">                        qDebug(&quot;no valid pixmap %s&quot;, fgWallpaper.toLatin1().data());</a>
<a name="ln475">                  canvas-&gt;setForeground(pm);</a>
<a name="ln476">                  }</a>
<a name="ln477">            }</a>
<a name="ln478">      if (tab2) {</a>
<a name="ln479">            for (int i = 0; i &lt; tab2-&gt;count(); ++i) {</a>
<a name="ln480">                  ScoreView* canvas = tab2-&gt;view(i);</a>
<a name="ln481">                  if (canvas == 0)</a>
<a name="ln482">                        continue;</a>
<a name="ln483">                  if (preferences.getBool(PREF_UI_CANVAS_BG_USECOLOR))</a>
<a name="ln484">                        canvas-&gt;setBackground(preferences.getColor(PREF_UI_CANVAS_BG_COLOR));</a>
<a name="ln485">                  else {</a>
<a name="ln486">                        QPixmap* pm = new QPixmap(preferences.getString(PREF_UI_CANVAS_BG_WALLPAPER));</a>
<a name="ln487">                        canvas-&gt;setBackground(pm);</a>
<a name="ln488">                        }</a>
<a name="ln489">                  if (preferences.getBool(PREF_UI_CANVAS_FG_USECOLOR))</a>
<a name="ln490">                        canvas-&gt;setForeground(preferences.getColor(PREF_UI_CANVAS_FG_COLOR));</a>
<a name="ln491">                  else {</a>
<a name="ln492">                        QPixmap* pm = new QPixmap(fgWallpaper);</a>
<a name="ln493">                        if (pm == 0 || pm-&gt;isNull())</a>
<a name="ln494">                              qDebug(&quot;no valid pixmap %s&quot;, fgWallpaper.toLatin1().data());</a>
<a name="ln495">                        canvas-&gt;setForeground(pm);</a>
<a name="ln496">                        }</a>
<a name="ln497">                  }</a>
<a name="ln498">            }</a>
<a name="ln499"> </a>
<a name="ln500">      transportTools-&gt;setEnabled(!noSeq &amp;&amp; seq &amp;&amp; seq-&gt;isRunning());</a>
<a name="ln501">      playId-&gt;setEnabled(!noSeq &amp;&amp; seq &amp;&amp; seq-&gt;isRunning());</a>
<a name="ln502"> </a>
<a name="ln503">      // change workspace</a>
<a name="ln504">      if (!fromWorkspace &amp;&amp; preferences.getString(PREF_APP_WORKSPACE) != WorkspacesManager::currentWorkspace()-&gt;name()) {</a>
<a name="ln505">            Workspace* workspace = WorkspacesManager::findByName(preferences.getString(PREF_APP_WORKSPACE));</a>
<a name="ln506">            </a>
<a name="ln507">            if (workspace)</a>
<a name="ln508">                  mscore-&gt;changeWorkspace(workspace);</a>
<a name="ln509">            }</a>
<a name="ln510"> </a>
<a name="ln511">      delete newWizard;</a>
<a name="ln512">      newWizard = 0;</a>
<a name="ln513">      reloadInstrumentTemplates();</a>
<a name="ln514">      updateInstrumentDialog();</a>
<a name="ln515"> </a>
<a name="ln516">      if (seq)</a>
<a name="ln517">            seq-&gt;preferencesChanged();</a>
<a name="ln518">      }</a>
<a name="ln519"> </a>
<a name="ln520">//---------------------------------------------------------</a>
<a name="ln521">//   populateNoteInputMenu</a>
<a name="ln522">//---------------------------------------------------------</a>
<a name="ln523"> </a>
<a name="ln524">void MuseScore::populateNoteInputMenu()</a>
<a name="ln525">      {</a>
<a name="ln526">      entryTools-&gt;clear();</a>
<a name="ln527"> </a>
<a name="ln528">      for (const auto s : _noteInputMenuEntries) {</a>
<a name="ln529">            if (!*s)</a>
<a name="ln530">                  entryTools-&gt;addSeparator();</a>
<a name="ln531">            else {</a>
<a name="ln532">                  QAction* a = getAction(s);</a>
<a name="ln533">                  QWidget* w;</a>
<a name="ln534">                  if (strcmp(s, &quot;note-input&quot;) == 0) {</a>
<a name="ln535">                        //-----------------------------------------------------------------</a>
<a name="ln536">                        // Note Entry Modes menu</a>
<a name="ln537">                        // ToolButtonMenu to swap between Note Entry Methods</a>
<a name="ln538">                        //-----------------------------------------------------------------</a>
<a name="ln539">                        QActionGroup* noteEntryMethods = new QActionGroup(entryTools);</a>
<a name="ln540"> </a>
<a name="ln541">                        noteEntryMethods-&gt;addAction(getAction(&quot;note-input-steptime&quot;));</a>
<a name="ln542">                        noteEntryMethods-&gt;addAction(getAction(&quot;note-input-repitch&quot;));</a>
<a name="ln543">                        noteEntryMethods-&gt;addAction(getAction(&quot;note-input-rhythm&quot;));</a>
<a name="ln544">                        noteEntryMethods-&gt;addAction(getAction(&quot;note-input-realtime-auto&quot;));</a>
<a name="ln545">                        noteEntryMethods-&gt;addAction(getAction(&quot;note-input-realtime-manual&quot;));</a>
<a name="ln546">                        noteEntryMethods-&gt;addAction(getAction(&quot;note-input-timewise&quot;));</a>
<a name="ln547"> </a>
<a name="ln548">                        connect(noteEntryMethods, SIGNAL(triggered(QAction*)), this, SLOT(cmd(QAction*)));</a>
<a name="ln549"> </a>
<a name="ln550">                        w = new ToolButtonMenu(tr(&quot;Note Entry Methods&quot;),</a>
<a name="ln551">                           getAction(&quot;note-input&quot;),</a>
<a name="ln552">                           noteEntryMethods,</a>
<a name="ln553">                           this,</a>
<a name="ln554">                           false);</a>
<a name="ln555">                        w-&gt;setObjectName(&quot;note-entry-methods&quot;);</a>
<a name="ln556">                        }</a>
<a name="ln557">                  else if (strncmp(s, &quot;voice-&quot;, 6) == 0) {</a>
<a name="ln558">                        AccessibleToolButton* tb = new AccessibleToolButton(this, a);</a>
<a name="ln559">                        tb-&gt;setObjectName(&quot;voice&quot;);</a>
<a name="ln560">                        tb-&gt;setFocusPolicy(Qt::ClickFocus);</a>
<a name="ln561">                        tb-&gt;setToolButtonStyle(Qt::ToolButtonTextOnly);</a>
<a name="ln562">                        tb-&gt;setProperty((QString(&quot;voice%1&quot;).arg(atoi(s+6))).toUtf8().data(), true);</a>
<a name="ln563">                        QPalette p(tb-&gt;palette());</a>
<a name="ln564">                        int i = atoi(s+6) - 1;</a>
<a name="ln565">                        p.setColor(QPalette::Base, MScore::selectColor[i]);</a>
<a name="ln566">                        tb-&gt;setPalette(p);</a>
<a name="ln567">                        a-&gt;setCheckable(true);</a>
<a name="ln568">                        // tb-&gt;setDefaultAction(a);</a>
<a name="ln569">                        w = tb;</a>
<a name="ln570">                        }</a>
<a name="ln571">                  else {</a>
<a name="ln572">                        w = new AccessibleToolButton(entryTools, a);</a>
<a name="ln573">                        w-&gt;setObjectName(s);</a>
<a name="ln574">                        }</a>
<a name="ln575">                  entryTools-&gt;addWidget(w);</a>
<a name="ln576">                  }</a>
<a name="ln577">            }</a>
<a name="ln578">      }</a>
<a name="ln579"> </a>
<a name="ln580">//---------------------------------------------------------</a>
<a name="ln581">//   notifyElementDraggedToScoreView</a>
<a name="ln582">//---------------------------------------------------------</a>
<a name="ln583"> </a>
<a name="ln584">void MuseScore::notifyElementDraggedToScoreView()</a>
<a name="ln585">      {</a>
<a name="ln586">      if (paletteWidget)</a>
<a name="ln587">            paletteWidget-&gt;notifyElementDraggedToScoreView();</a>
<a name="ln588">      }</a>
<a name="ln589"> </a>
<a name="ln590">//---------------------------------------------------------</a>
<a name="ln591">//   onLongOperationFinished</a>
<a name="ln592">//---------------------------------------------------------</a>
<a name="ln593"> </a>
<a name="ln594">void MuseScore::onLongOperationFinished()</a>
<a name="ln595">      {</a>
<a name="ln596">      infoMsgBox-&gt;accept();</a>
<a name="ln597">      }</a>
<a name="ln598"> </a>
<a name="ln599">//---------------------------------------------------------</a>
<a name="ln600">//   importExtension</a>
<a name="ln601">//---------------------------------------------------------</a>
<a name="ln602"> </a>
<a name="ln603">bool MuseScore::importExtension(QString path)</a>
<a name="ln604">      {</a>
<a name="ln605">      MQZipReader zipFile(path);</a>
<a name="ln606">      // compute total unzipped size</a>
<a name="ln607">      qint64 totalZipSize = 0;</a>
<a name="ln608">      for (auto fi : zipFile.fileInfoList())</a>
<a name="ln609">            totalZipSize += fi.size;</a>
<a name="ln610"> </a>
<a name="ln611">      // check if extension path is writable and has enough space</a>
<a name="ln612">      const QString extensionsPath = preferences.getString(PREF_APP_PATHS_MYEXTENSIONS);</a>
<a name="ln613">      const QFileInfo extensionsDirInfo(extensionsPath);</a>
<a name="ln614">      if (!extensionsDirInfo.isWritable()) {</a>
<a name="ln615">            if (!MScore::noGui)</a>
<a name="ln616">                  QMessageBox::critical(mscore, QWidget::tr(&quot;Import Extension File&quot;), QWidget::tr(&quot;Cannot import extension on read-only storage: %1&quot;).arg(extensionsPath)); // TODO: on read-only *directory*</a>
<a name="ln617">            return false;</a>
<a name="ln618">            }</a>
<a name="ln619">      QStorageInfo storage = QStorageInfo(extensionsPath);</a>
<a name="ln620">      if (totalZipSize &gt;= storage.bytesAvailable()) {</a>
<a name="ln621">            if (!MScore::noGui)</a>
<a name="ln622">                  QMessageBox::critical(mscore, QWidget::tr(&quot;Import Extension File&quot;), QWidget::tr(&quot;Cannot import extension: storage %1 is full&quot;).arg(storage.displayName()));</a>
<a name="ln623">            return false;</a>
<a name="ln624">            }</a>
<a name="ln625">      // Check structure of the extension</a>
<a name="ln626">      bool hasMetadata = false;</a>
<a name="ln627">      bool hasAlienDirectory = false;</a>
<a name="ln628">      bool hasAlienFiles = false;</a>
<a name="ln629">      QSet&lt;QString&gt; acceptableFolders = { Extension::sfzsDir, Extension::soundfontsDir, Extension::templatesDir, Extension::instrumentsDir, Extension::workspacesDir };</a>
<a name="ln630">      for (auto fi : zipFile.fileInfoList()) {</a>
<a name="ln631">            if (fi.filePath == &quot;metadata.json&quot;)</a>
<a name="ln632">                  hasMetadata = true;</a>
<a name="ln633">            else {</a>
<a name="ln634">                  // get folders</a>
<a name="ln635">                  auto fpath = QDir::cleanPath(fi.filePath);</a>
<a name="ln636">                  QStringList folders(fpath);</a>
<a name="ln637">                  while ((fpath = QFileInfo(fpath).path()).length() &lt; folders.last().length())</a>
<a name="ln638">                        folders &lt;&lt; fpath;</a>
<a name="ln639">                  if (folders.size() &lt; 2) {</a>
<a name="ln640">                        hasAlienFiles = true; // in root dir</a>
<a name="ln641">                        break;</a>
<a name="ln642">                        }</a>
<a name="ln643">                  QString rootDir = folders.at(folders.size() - 2);</a>
<a name="ln644">                  if (!acceptableFolders.contains(rootDir)) {</a>
<a name="ln645">                        hasAlienDirectory = true; // in root dir</a>
<a name="ln646">                        break;</a>
<a name="ln647">                        }</a>
<a name="ln648">                  }</a>
<a name="ln649">            }</a>
<a name="ln650">      if (!hasMetadata) {</a>
<a name="ln651">            if (!MScore::noGui)</a>
<a name="ln652">                  QMessageBox::critical(mscore, QWidget::tr(&quot;Import Extension File&quot;), QWidget::tr(&quot;Corrupted extension: no metadata.json&quot;));</a>
<a name="ln653">            return false;</a>
<a name="ln654">            }</a>
<a name="ln655">      if (hasAlienDirectory) {</a>
<a name="ln656">            if (!MScore::noGui)</a>
<a name="ln657">                  QMessageBox::critical(mscore, QWidget::tr(&quot;Import Extension File&quot;), QWidget::tr(&quot;Corrupted extension: unsupported directories in root directory&quot;));</a>
<a name="ln658">            return false;</a>
<a name="ln659">            }</a>
<a name="ln660">      if (hasAlienFiles) {</a>
<a name="ln661">            if (!MScore::noGui)</a>
<a name="ln662">                  QMessageBox::critical(mscore, QWidget::tr(&quot;Import Extension File&quot;), QWidget::tr(&quot;Corrupted extension: unsupported files in root directory&quot;));</a>
<a name="ln663">            return false;</a>
<a name="ln664">            }</a>
<a name="ln665">      zipFile.close();</a>
<a name="ln666"> </a>
<a name="ln667">      MQZipReader zipFile2(path);</a>
<a name="ln668">      // get extension id from metadata.json</a>
<a name="ln669">      QByteArray mdba = zipFile2.fileData(&quot;metadata.json&quot;);</a>
<a name="ln670">      zipFile2.close();</a>
<a name="ln671">      QJsonDocument loadDoc = QJsonDocument::fromJson(mdba);</a>
<a name="ln672">      QJsonObject mdObject = loadDoc.object();</a>
<a name="ln673">      QString extensionId = mdObject[&quot;id&quot;].toString();</a>
<a name="ln674">      QString version = mdObject[&quot;version&quot;].toString();</a>
<a name="ln675">      if (extensionId.isEmpty() || version.isEmpty()) {</a>
<a name="ln676">            if (!MScore::noGui)</a>
<a name="ln677">                  QMessageBox::critical(mscore, QWidget::tr(&quot;Import Extension File&quot;), QWidget::tr(&quot;Corrupted extension: corrupted metadata.json&quot;));</a>
<a name="ln678">            return false;</a>
<a name="ln679">            }</a>
<a name="ln680"> </a>
<a name="ln681">      // Check if extension is already installed, ask for uninstall</a>
<a name="ln682">      QDir dir(preferences.getString(PREF_APP_PATHS_MYEXTENSIONS));</a>
<a name="ln683">      auto dirList = dir.entryList(QStringList(extensionId), QDir::Dirs | QDir::NoDotAndDotDot);</a>
<a name="ln684">      bool newerVersion = false;</a>
<a name="ln685">      if (dirList.contains(extensionId)) {</a>
<a name="ln686">            QString extDirName = QString(&quot;%1/%2&quot;).arg(preferences.getString(PREF_APP_PATHS_MYEXTENSIONS)).arg(extensionId);</a>
<a name="ln687">            QDir extDir(extDirName);</a>
<a name="ln688">            auto versionDirList = extDir.entryList(QDir::Dirs | QDir::NoDotAndDotDot);</a>
<a name="ln689">            if (versionDirList.size() &gt; 0) {</a>
<a name="ln690">                  // potentially other versions</a>
<a name="ln691">                  // is there a more recent version?</a>
<a name="ln692">                  for (auto versionDir : versionDirList) {</a>
<a name="ln693">                        if (compareVersion(version, versionDir)) {</a>
<a name="ln694">                              qDebug() &lt;&lt; &quot;There is a newer version. We don't install&quot;;</a>
<a name="ln695">                              if (!MScore::noGui)</a>
<a name="ln696">                                    QMessageBox::critical(mscore, QWidget::tr(&quot;Import Extension File&quot;), QWidget::tr(&quot;A newer version is already installed&quot;));</a>
<a name="ln697">                              newerVersion = true;</a>
<a name="ln698">                              return false;</a>
<a name="ln699">                              }</a>
<a name="ln700">                        }</a>
<a name="ln701">                  }</a>
<a name="ln702">            if (!newerVersion) {</a>
<a name="ln703">                  qDebug() &lt;&lt; &quot;found already install extension without newer version: deleting it&quot;;</a>
<a name="ln704">                  QDir d(QString(&quot;%1/%2&quot;).arg(preferences.getString(PREF_APP_PATHS_MYEXTENSIONS)).arg(extensionId));</a>
<a name="ln705">                  if (!d.removeRecursively()) {</a>
<a name="ln706">                        if (!MScore::noGui)</a>
<a name="ln707">                              QMessageBox::critical(mscore, QWidget::tr(&quot;Import Extension File&quot;), QWidget::tr(&quot;Error while deleting previous version of the extension: %1&quot;).arg(extensionId));</a>
<a name="ln708">                        return false;</a>
<a name="ln709">                        }</a>
<a name="ln710">                  }</a>
<a name="ln711">            }</a>
<a name="ln712"> </a>
<a name="ln713">      //setup the message box</a>
<a name="ln714">      infoMsgBox = new QMessageBox();</a>
<a name="ln715">      infoMsgBox-&gt;setWindowModality(Qt::ApplicationModal);</a>
<a name="ln716">      infoMsgBox-&gt;setWindowFlags(Qt::WindowFlags(Qt::Dialog | Qt::FramelessWindowHint | Qt::WindowTitleHint));</a>
<a name="ln717">      infoMsgBox-&gt;setTextFormat(Qt::RichText);</a>
<a name="ln718">      infoMsgBox-&gt;setMinimumSize(300, 100);</a>
<a name="ln719">      infoMsgBox-&gt;setMaximumSize(300, 100);</a>
<a name="ln720">      infoMsgBox-&gt;setStandardButtons(0);</a>
<a name="ln721">      infoMsgBox-&gt;setText(QString(&quot;&lt;p align='center'&gt;&quot;) + tr(&quot;Please wait, unpacking extension…&quot;) + QString(&quot;&lt;/p&gt;&quot;));</a>
<a name="ln722"> </a>
<a name="ln723">      //setup async run of long operations</a>
<a name="ln724">      QFutureWatcher&lt;bool&gt; futureWatcherUnzip;</a>
<a name="ln725">      connect(&amp;futureWatcherUnzip, SIGNAL(finished()), this, SLOT(onLongOperationFinished()));</a>
<a name="ln726"> </a>
<a name="ln727">      MQZipReader* zipFile3 = new MQZipReader(path);</a>
<a name="ln728">      // Unzip the extension asynchronously</a>
<a name="ln729">      QFuture&lt;bool&gt; futureUnzip = QtConcurrent::run(zipFile3, &amp;MQZipReader::extractAll, QString(&quot;%1/%2/%3&quot;).arg(preferences.getString(PREF_APP_PATHS_MYEXTENSIONS)).arg(extensionId).arg(version));</a>
<a name="ln730">      futureWatcherUnzip.setFuture(futureUnzip);</a>
<a name="ln731">      if (!MScore::noGui)</a>
<a name="ln732">            infoMsgBox-&gt;exec();</a>
<a name="ln733">      bool unzipResult = futureUnzip.result();</a>
<a name="ln734">      zipFile3-&gt;close();</a>
<a name="ln735">      delete zipFile3;</a>
<a name="ln736">      zipFile3 = nullptr;</a>
<a name="ln737"> </a>
<a name="ln738">      if (!unzipResult) {</a>
<a name="ln739">            if (!MScore::noGui)</a>
<a name="ln740">                  QMessageBox::critical(mscore, QWidget::tr(&quot;Import Extension File&quot;), QWidget::tr(&quot;Unable to extract files from the extension&quot;));</a>
<a name="ln741">            return false;</a>
<a name="ln742">            }</a>
<a name="ln743"> </a>
<a name="ln744">      delete newWizard;</a>
<a name="ln745">      newWizard = 0;</a>
<a name="ln746">      mscore-&gt;reloadInstrumentTemplates();</a>
<a name="ln747">      mscore-&gt;updateInstrumentDialog();</a>
<a name="ln748"> </a>
<a name="ln749">      auto loadSoundFontAsync = [&amp;]() {</a>
<a name="ln750">            // After install: add sfz to zerberus</a>
<a name="ln751">            QDir sfzDir(QString(&quot;%1/%2/%3/%4&quot;).arg(preferences.getString(PREF_APP_PATHS_MYEXTENSIONS)).arg(extensionId).arg(version).arg(Extension::sfzsDir));</a>
<a name="ln752">            if (sfzDir.exists()) {</a>
<a name="ln753">                  // get all sfz files</a>
<a name="ln754">                  QDirIterator it(sfzDir.absolutePath(), QStringList(&quot;*.sfz&quot;), QDir::Files, QDirIterator::Subdirectories);</a>
<a name="ln755">                  Synthesizer* s = synti-&gt;synthesizer(&quot;Zerberus&quot;);</a>
<a name="ln756">                  QStringList sfzs;</a>
<a name="ln757">                  while (it.hasNext()) {</a>
<a name="ln758">                        it.next();</a>
<a name="ln759">                        sfzs.append(it.fileName());</a>
<a name="ln760">                        }</a>
<a name="ln761">                  sfzs.sort();</a>
<a name="ln762">                  for (int sfzNum = 0; sfzNum &lt; sfzs.size(); ++sfzNum)</a>
<a name="ln763">                        s-&gt;addSoundFont(sfzs[sfzNum]);</a>
<a name="ln764"> </a>
<a name="ln765">                  if (!sfzs.isEmpty())</a>
<a name="ln766">                        synti-&gt;storeState();</a>
<a name="ln767">                  </a>
<a name="ln768">                  s-&gt;gui()-&gt;synthesizerChanged();</a>
<a name="ln769">                  }</a>
<a name="ln770"> </a>
<a name="ln771">            // After install: add soundfont to fluid</a>
<a name="ln772">            QDir sfDir(QString(&quot;%1/%2/%3/%4&quot;).arg(preferences.getString(PREF_APP_PATHS_MYEXTENSIONS)).arg(extensionId).arg(version).arg(Extension::soundfontsDir));</a>
<a name="ln773">            if (sfDir.exists()) {</a>
<a name="ln774">                  // get all soundfont files</a>
<a name="ln775">                  QStringList filters(&quot;*.sf2&quot;);</a>
<a name="ln776">                  filters.append(&quot;*.sf3&quot;);</a>
<a name="ln777">                  QDirIterator it(sfDir.absolutePath(), filters, QDir::Files, QDirIterator::Subdirectories);</a>
<a name="ln778">                  QStringList sfs;</a>
<a name="ln779">                  while (it.hasNext()) {</a>
<a name="ln780">                        it.next();</a>
<a name="ln781">                        sfs.append(it.fileInfo().absoluteFilePath());</a>
<a name="ln782">                        }</a>
<a name="ln783">                  sfs.sort();</a>
<a name="ln784">                  Synthesizer* s = synti-&gt;synthesizer(&quot;Fluid&quot;);</a>
<a name="ln785">                  for (auto sf : sfs) {</a>
<a name="ln786">                        s-&gt;addSoundFont(sf);</a>
<a name="ln787">                        }</a>
<a name="ln788">                  if (!sfs.isEmpty())</a>
<a name="ln789">                        synti-&gt;storeState();</a>
<a name="ln790">                  </a>
<a name="ln791">                  s-&gt;gui()-&gt;synthesizerChanged();</a>
<a name="ln792">                  }</a>
<a name="ln793">            };</a>
<a name="ln794">      if (!enableExperimental) {</a>
<a name="ln795">            //load soundfonts async</a>
<a name="ln796">            QFuture&lt;void&gt; futureLoadSFs = QtConcurrent::run(loadSoundFontAsync);</a>
<a name="ln797">            QFutureWatcher&lt;void&gt; futureWatcherLoadSFs;</a>
<a name="ln798">            futureWatcherLoadSFs.setFuture(futureLoadSFs);</a>
<a name="ln799">            connect(&amp;futureWatcherLoadSFs, SIGNAL(finished()), this, SLOT(onLongOperationFinished()));</a>
<a name="ln800">            infoMsgBox-&gt;setText(QString(&quot;&lt;p align='center'&gt;&quot;) + tr(&quot;Please wait, loading soundfonts…&quot;) + QString(&quot;&lt;/p&gt;&quot;));</a>
<a name="ln801">            if (!MScore::noGui)</a>
<a name="ln802">                  infoMsgBox-&gt;exec();</a>
<a name="ln803">            else</a>
<a name="ln804">                  futureLoadSFs.waitForFinished();</a>
<a name="ln805">            }</a>
<a name="ln806"> </a>
<a name="ln807">      // after install: refresh workspaces if needed</a>
<a name="ln808">      QDir workspacesDir(QString(&quot;%1/%2/%3/%4&quot;).arg(preferences.getString(PREF_APP_PATHS_MYEXTENSIONS)).arg(extensionId).arg(version).arg(Extension::workspacesDir));</a>
<a name="ln809">      if (workspacesDir.exists() &amp;&amp; !MScore::noGui) {</a>
<a name="ln810">            auto wsList = workspacesDir.entryInfoList(QStringList(&quot;*.workspace&quot;), QDir::Files);</a>
<a name="ln811">            if (!wsList.isEmpty()) {</a>
<a name="ln812">                  WorkspacesManager::refreshWorkspaces();</a>
<a name="ln813">                  emit workspacesChanged();</a>
<a name="ln814">                  changeWorkspace(WorkspacesManager::workspaces().last());</a>
<a name="ln815">                  }</a>
<a name="ln816">            }</a>
<a name="ln817">      return true;</a>
<a name="ln818">      }</a>
<a name="ln819"> </a>
<a name="ln820">//---------------------------------------------------------</a>
<a name="ln821">//   uninstallExtension</a>
<a name="ln822">//---------------------------------------------------------</a>
<a name="ln823"> </a>
<a name="ln824">bool MuseScore::uninstallExtension(QString extensionId)</a>
<a name="ln825">      {</a>
<a name="ln826">      QString version = Extension::getLatestVersion(extensionId);</a>
<a name="ln827">      // Before install: remove sfz from zerberus</a>
<a name="ln828">      QDir sfzDir(QString(&quot;%1/%2/%3/%4&quot;).arg(preferences.getString(PREF_APP_PATHS_MYEXTENSIONS)).arg(extensionId).arg(version).arg(Extension::sfzsDir));</a>
<a name="ln829">      if (sfzDir.exists()) {</a>
<a name="ln830">            // get all sfz files</a>
<a name="ln831">            QDirIterator it(sfzDir.absolutePath(), QStringList(&quot;*.sfz&quot;), QDir::Files, QDirIterator::Subdirectories);</a>
<a name="ln832">            Synthesizer* s = synti-&gt;synthesizer(&quot;Zerberus&quot;);</a>
<a name="ln833">            bool found = it.hasNext();</a>
<a name="ln834">            while (it.hasNext()) {</a>
<a name="ln835">                  it.next();</a>
<a name="ln836">                  s-&gt;removeSoundFont(it.fileInfo().absoluteFilePath());</a>
<a name="ln837">                  }</a>
<a name="ln838">            if (found)</a>
<a name="ln839">                  synti-&gt;storeState();</a>
<a name="ln840">            s-&gt;gui()-&gt;synthesizerChanged();</a>
<a name="ln841">            }</a>
<a name="ln842">      // Before install: remove soundfont from fluid</a>
<a name="ln843">      QDir sfDir(QString(&quot;%1/%2/%3/%4&quot;).arg(preferences.getString(PREF_APP_PATHS_MYEXTENSIONS)).arg(extensionId).arg(version).arg(Extension::soundfontsDir));</a>
<a name="ln844">      if (sfDir.exists()) {</a>
<a name="ln845">            // get all soundfont files</a>
<a name="ln846">            QStringList filters(&quot;*.sf2&quot;);</a>
<a name="ln847">            filters.append(&quot;*.sf3&quot;);</a>
<a name="ln848">            QDirIterator it(sfDir.absolutePath(), filters, QDir::Files, QDirIterator::Subdirectories);</a>
<a name="ln849">            Synthesizer* s = synti-&gt;synthesizer(&quot;Fluid&quot;);</a>
<a name="ln850">            bool found = it.hasNext();</a>
<a name="ln851">            while (it.hasNext()) {</a>
<a name="ln852">                  it.next();</a>
<a name="ln853">                  s-&gt;removeSoundFont(it.fileName());</a>
<a name="ln854">                  }</a>
<a name="ln855">            if (found)</a>
<a name="ln856">                  synti-&gt;storeState();</a>
<a name="ln857">            </a>
<a name="ln858">            s-&gt;gui()-&gt;synthesizerChanged();</a>
<a name="ln859">            }</a>
<a name="ln860">      bool refreshWorkspaces = false;</a>
<a name="ln861">      QDir workspacesDir(QString(&quot;%1/%2/%3/%4&quot;).arg(preferences.getString(PREF_APP_PATHS_MYEXTENSIONS)).arg(extensionId).arg(version).arg(Extension::workspacesDir));</a>
<a name="ln862">      if (workspacesDir.exists()) {</a>
<a name="ln863">            auto wsList = workspacesDir.entryInfoList(QStringList(&quot;*.workspace&quot;), QDir::Files);</a>
<a name="ln864">            if (!wsList.isEmpty())</a>
<a name="ln865">                  refreshWorkspaces = true;</a>
<a name="ln866">            }</a>
<a name="ln867"> </a>
<a name="ln868">      // delete directories</a>
<a name="ln869">      QDir extensionDir(QString(&quot;%1/%2&quot;).arg(preferences.getString(PREF_APP_PATHS_MYEXTENSIONS)).arg(extensionId));</a>
<a name="ln870">      extensionDir.removeRecursively();</a>
<a name="ln871"> </a>
<a name="ln872">      // update UI</a>
<a name="ln873">      delete newWizard;</a>
<a name="ln874">      newWizard = 0;</a>
<a name="ln875">      mscore-&gt;reloadInstrumentTemplates();</a>
<a name="ln876">      mscore-&gt;updateInstrumentDialog();</a>
<a name="ln877">      if (refreshWorkspaces) {</a>
<a name="ln878">            const auto curWorkspaceName = WorkspacesManager::currentWorkspace()-&gt;name();</a>
<a name="ln879">            WorkspacesManager::refreshWorkspaces();</a>
<a name="ln880">            emit workspacesChanged();</a>
<a name="ln881">            auto ws = WorkspacesManager::workspaces();</a>
<a name="ln882">            //If current worksapce is alive, do nothing</a>
<a name="ln883">            //Select first available workspace in the list otherwise</a>
<a name="ln884">            bool curWorkspaceDisappeared = false;</a>
<a name="ln885">            if (WorkspacesManager::findByName(curWorkspaceName))</a>
<a name="ln886">                  curWorkspaceDisappeared = true;</a>
<a name="ln887">            </a>
<a name="ln888">            if (curWorkspaceDisappeared)</a>
<a name="ln889">                  changeWorkspace(WorkspacesManager::workspaces().last());</a>
<a name="ln890">            }</a>
<a name="ln891">      return true;</a>
<a name="ln892">      }</a>
<a name="ln893"> </a>
<a name="ln894">//---------------------------------------------------------</a>
<a name="ln895">//   isInstalled</a>
<a name="ln896">///  used from javascript in start center webview</a>
<a name="ln897">//---------------------------------------------------------</a>
<a name="ln898"> </a>
<a name="ln899">bool MuseScore::isInstalledExtension(QString extensionId)</a>
<a name="ln900">      {</a>
<a name="ln901">      return Extension::isInstalled(extensionId);</a>
<a name="ln902">      }</a>
<a name="ln903"> </a>
<a name="ln904">//---------------------------------------------------------</a>
<a name="ln905">//   populateFileOperations</a>
<a name="ln906">//---------------------------------------------------------</a>
<a name="ln907"> </a>
<a name="ln908">void MuseScore::populateFileOperations()</a>
<a name="ln909">      {</a>
<a name="ln910">      fileTools-&gt;clear();</a>
<a name="ln911"> </a>
<a name="ln912">      if (qApp-&gt;layoutDirection() == Qt::LayoutDirection::LeftToRight) {</a>
<a name="ln913">            for (auto s : _fileOperationEntries) {</a>
<a name="ln914">                  if (!*s)</a>
<a name="ln915">                        fileTools-&gt;addSeparator();</a>
<a name="ln916">                  else</a>
<a name="ln917">                        fileTools-&gt;addWidget(new AccessibleToolButton(fileTools, getAction(s)));</a>
<a name="ln918">                  }</a>
<a name="ln919">            }</a>
<a name="ln920">      else {</a>
<a name="ln921">            _fileOperationEntries.reverse();</a>
<a name="ln922">            for (auto s : _fileOperationEntries) {</a>
<a name="ln923">                  if (!*s)</a>
<a name="ln924">                        fileTools-&gt;addSeparator();</a>
<a name="ln925">                  else</a>
<a name="ln926">                        fileTools-&gt;addWidget(new AccessibleToolButton(fileTools, getAction(s)));</a>
<a name="ln927">                  }</a>
<a name="ln928">            _fileOperationEntries.reverse();</a>
<a name="ln929">            }</a>
<a name="ln930"> </a>
<a name="ln931">      // Currently not customizable in ToolbarEditor</a>
<a name="ln932">      fileTools-&gt;addSeparator();</a>
<a name="ln933">      mag = new MagBox;</a>
<a name="ln934">      connect(mag, SIGNAL(magChanged(MagIdx)), SLOT(magChanged(MagIdx)));</a>
<a name="ln935">      fileTools-&gt;addWidget(mag);</a>
<a name="ln936"> </a>
<a name="ln937">      viewModeCombo = new QComboBox(this);</a>
<a name="ln938">#if defined(Q_OS_MAC)</a>
<a name="ln939">      viewModeCombo-&gt;setFocusPolicy(Qt::StrongFocus);</a>
<a name="ln940">#else</a>
<a name="ln941">      viewModeCombo-&gt;setFocusPolicy(Qt::TabFocus);</a>
<a name="ln942">#endif</a>
<a name="ln943">      viewModeCombo-&gt;setFixedHeight(preferences.getInt(PREF_UI_THEME_ICONHEIGHT) + 8);  // hack</a>
<a name="ln944"> </a>
<a name="ln945">      viewModeCombo-&gt;setAccessibleName(tr(&quot;View Mode&quot;));</a>
<a name="ln946">      viewModeCombo-&gt;addItem(tr(&quot;Page View&quot;), int(LayoutMode::PAGE));</a>
<a name="ln947">      viewModeCombo-&gt;addItem(tr(&quot;Continuous View&quot;), int(LayoutMode::LINE));</a>
<a name="ln948">      viewModeCombo-&gt;addItem(tr(&quot;Single Page&quot;), int(LayoutMode::SYSTEM));</a>
<a name="ln949"> </a>
<a name="ln950">      connect(viewModeCombo, SIGNAL(activated(int)), SLOT(switchLayoutMode(int)));</a>
<a name="ln951">      fileTools-&gt;addWidget(viewModeCombo);</a>
<a name="ln952">      }</a>
<a name="ln953"> </a>
<a name="ln954">//---------------------------------------------------------</a>
<a name="ln955">//   populatePlaybackControls</a>
<a name="ln956">//---------------------------------------------------------</a>
<a name="ln957"> </a>
<a name="ln958">void MuseScore::populatePlaybackControls()</a>
<a name="ln959">      {</a>
<a name="ln960">      transportTools-&gt;clear();</a>
<a name="ln961"> </a>
<a name="ln962">      for (const auto s : _playbackControlEntries) {</a>
<a name="ln963">            if (!*s)</a>
<a name="ln964">                  transportTools-&gt;addSeparator();</a>
<a name="ln965">            else {</a>
<a name="ln966">                  if (QString(s) == &quot;repeat&quot;) {</a>
<a name="ln967">                              QAction* repeatAction = getAction(&quot;repeat&quot;);</a>
<a name="ln968">                              repeatAction-&gt;setChecked(preferences.getBool(PREF_APP_PLAYBACK_PLAYREPEATS));</a>
<a name="ln969">                              QWidget* w = new AccessibleToolButton(transportTools, repeatAction);</a>
<a name="ln970">                              transportTools-&gt;addWidget(w);</a>
<a name="ln971">                        }</a>
<a name="ln972">                  else if (QString(s) == &quot;play&quot;) {</a>
<a name="ln973">                        _playButton = new AccessibleToolButton(transportTools, getAction(&quot;play&quot;));</a>
<a name="ln974">                        transportTools-&gt;addWidget(_playButton);</a>
<a name="ln975">                        }</a>
<a name="ln976">                  else {</a>
<a name="ln977">                        QWidget* w = new AccessibleToolButton(transportTools, getAction(s));</a>
<a name="ln978">                        transportTools-&gt;addWidget(w);</a>
<a name="ln979">                        }</a>
<a name="ln980">                  }</a>
<a name="ln981">            }</a>
<a name="ln982">      }</a>
<a name="ln983"> </a>
<a name="ln984">//---------------------------------------------------------</a>
<a name="ln985">//   MuseScore</a>
<a name="ln986">//---------------------------------------------------------</a>
<a name="ln987"> </a>
<a name="ln988">MuseScore::MuseScore()</a>
<a name="ln989">   : QMainWindow()</a>
<a name="ln990">      {</a>
<a name="ln991">      _tourHandler = new TourHandler(this);</a>
<a name="ln992">      qApp-&gt;installEventFilter(_tourHandler);</a>
<a name="ln993">      _tourHandler-&gt;loadTours();</a>
<a name="ln994"> </a>
<a name="ln995">      QScreen* screen = QGuiApplication::primaryScreen();</a>
<a name="ln996">      if (userDPI == 0.0) {</a>
<a name="ln997">#if defined(Q_OS_WIN)</a>
<a name="ln998">      if (QSysInfo::WindowsVersion &lt;= QSysInfo::WV_WINDOWS7)</a>
<a name="ln999">            _physicalDotsPerInch = screen-&gt;logicalDotsPerInch() * screen-&gt;devicePixelRatio();</a>
<a name="ln1000">      else</a>
<a name="ln1001">            _physicalDotsPerInch = screen-&gt;physicalDotsPerInch();  // physical resolution</a>
<a name="ln1002">#else</a>
<a name="ln1003">      _physicalDotsPerInch = screen-&gt;physicalDotsPerInch();        // physical resolution</a>
<a name="ln1004">#endif</a>
<a name="ln1005">            }</a>
<a name="ln1006">      else {</a>
<a name="ln1007">            _physicalDotsPerInch = userDPI;</a>
<a name="ln1008">            }</a>
<a name="ln1009">      if (guiScaling == 0.0) {</a>
<a name="ln1010">            // set scale for icons, palette elements, window sizes, etc</a>
<a name="ln1011">            // the default values are hard coded in pixel sizes and assume ~96 DPI</a>
<a name="ln1012">            if (qAbs(_physicalDotsPerInch - DPI_DISPLAY) &gt; 6.0)</a>
<a name="ln1013">                  guiScaling = _physicalDotsPerInch / DPI_DISPLAY;</a>
<a name="ln1014">            else</a>
<a name="ln1015">                  guiScaling = 1.0;</a>
<a name="ln1016">            }</a>
<a name="ln1017"> </a>
<a name="ln1018">      MScore::pixelRatio = DPI / screen-&gt;logicalDotsPerInch();</a>
<a name="ln1019"> </a>
<a name="ln1020">      setObjectName(&quot;MuseScore&quot;);</a>
<a name="ln1021">      _sstate = STATE_INIT;</a>
<a name="ln1022">      setWindowTitle(QString(MUSESCORE_NAME_VERSION));</a>
<a name="ln1023">      setIconSize(QSize(preferences.getInt(PREF_UI_THEME_ICONWIDTH) * guiScaling, preferences.getInt(PREF_UI_THEME_ICONHEIGHT) * guiScaling));</a>
<a name="ln1024"> </a>
<a name="ln1025">      ucheck = new UpdateChecker(this);</a>
<a name="ln1026">      packUChecker = new ExtensionsUpdateChecker(this);</a>
<a name="ln1027"> </a>
<a name="ln1028">      setAcceptDrops(true);</a>
<a name="ln1029">      setFocusPolicy(Qt::NoFocus);</a>
<a name="ln1030"> </a>
<a name="ln1031">#ifdef SCRIPT_INTERFACE</a>
<a name="ln1032">      pluginManager = new PluginManager(0);</a>
<a name="ln1033">#endif</a>
<a name="ln1034"> </a>
<a name="ln1035">      _positionLabel = new QLabel;</a>
<a name="ln1036">      _positionLabel-&gt;setObjectName(&quot;decoration widget&quot;);  // this prevents animations</a>
<a name="ln1037"> </a>
<a name="ln1038">      _modeText = new QLabel;</a>
<a name="ln1039">      _modeText-&gt;setAutoFillBackground(false);</a>
<a name="ln1040">      _modeText-&gt;setObjectName(&quot;modeLabel&quot;);</a>
<a name="ln1041"> </a>
<a name="ln1042">      hRasterAction   = getAction(&quot;hraster&quot;);</a>
<a name="ln1043">      vRasterAction   = getAction(&quot;vraster&quot;);</a>
<a name="ln1044">      loopAction      = getAction(&quot;loop&quot;);</a>
<a name="ln1045">      loopInAction    = getAction(&quot;loop-in&quot;);</a>
<a name="ln1046">      loopOutAction   = getAction(&quot;loop-out&quot;);</a>
<a name="ln1047">      metronomeAction = getAction(&quot;metronome&quot;);</a>
<a name="ln1048">      countInAction   = getAction(&quot;countin&quot;);</a>
<a name="ln1049">      panAction       = getAction(&quot;pan&quot;);</a>
<a name="ln1050"> </a>
<a name="ln1051">      _statusBar = new QStatusBar;</a>
<a name="ln1052">      _statusBar-&gt;addPermanentWidget(new QWidget(this), 2);</a>
<a name="ln1053">      _statusBar-&gt;addPermanentWidget(new QWidget(this), 100);</a>
<a name="ln1054">      _statusBar-&gt;addPermanentWidget(_modeText, 0);</a>
<a name="ln1055"> </a>
<a name="ln1056">      if (enableExperimental) {</a>
<a name="ln1057">            layerSwitch = new QComboBox(this);</a>
<a name="ln1058">            layerSwitch-&gt;setToolTip(tr(&quot;Switch layer&quot;));</a>
<a name="ln1059">            connect(layerSwitch, SIGNAL(activated(const QString&amp;)), SLOT(switchLayer(const QString&amp;)));</a>
<a name="ln1060">            playMode = new QComboBox(this);</a>
<a name="ln1061">            playMode-&gt;addItem(tr(&quot;Synthesizer&quot;));</a>
<a name="ln1062">            playMode-&gt;addItem(tr(&quot;Audio track&quot;));</a>
<a name="ln1063">            playMode-&gt;setToolTip(tr(&quot;Switch play mode&quot;));</a>
<a name="ln1064">            connect(playMode, SIGNAL(activated(int)), SLOT(switchPlayMode(int)));</a>
<a name="ln1065"> </a>
<a name="ln1066">            _statusBar-&gt;addPermanentWidget(playMode);</a>
<a name="ln1067">            _statusBar-&gt;addPermanentWidget(layerSwitch);</a>
<a name="ln1068">            }</a>
<a name="ln1069"> </a>
<a name="ln1070">      _statusBar-&gt;addPermanentWidget(_positionLabel, 0);</a>
<a name="ln1071"> </a>
<a name="ln1072">      setStatusBar(_statusBar);</a>
<a name="ln1073">      ScoreAccessibility::createInstance(this);</a>
<a name="ln1074"> </a>
<a name="ln1075">      // otherwise unused actions:</a>
<a name="ln1076">      //   must be added somewhere to work</a>
<a name="ln1077">      QActionGroup* ag = Shortcut::getActionGroupForWidget(MsWidget::MAIN_WINDOW);</a>
<a name="ln1078">      ag-&gt;setParent(this);</a>
<a name="ln1079">      addActions(ag-&gt;actions());</a>
<a name="ln1080">      connect(ag, SIGNAL(triggered(QAction*)), SLOT(cmd(QAction*)));</a>
<a name="ln1081"> </a>
<a name="ln1082">      mainWindow = new QSplitter;</a>
<a name="ln1083">      mainWindow-&gt;setObjectName(&quot;mainwindow&quot;);</a>
<a name="ln1084">      mainWindow-&gt;setAccessibleName(&quot;&quot;);</a>
<a name="ln1085">      mainWindow-&gt;setChildrenCollapsible(false);</a>
<a name="ln1086"> </a>
<a name="ln1087">      QWidget* mainScore = new QWidget;</a>
<a name="ln1088">      mainScore-&gt;setObjectName(&quot;mainscore&quot;);</a>
<a name="ln1089">      mainScore-&gt;setAccessibleName(&quot;&quot;);</a>
<a name="ln1090">      mainScore-&gt;setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Expanding);</a>
<a name="ln1091">      mainWindow-&gt;addWidget(mainScore);</a>
<a name="ln1092"> </a>
<a name="ln1093">      layout = new QVBoxLayout;</a>
<a name="ln1094">      layout-&gt;setObjectName(&quot;layout&quot;);</a>
<a name="ln1095">      layout-&gt;setMargin(0);</a>
<a name="ln1096">      layout-&gt;setSpacing(0);</a>
<a name="ln1097">      mainScore-&gt;setLayout(layout);</a>
<a name="ln1098"> </a>
<a name="ln1099">      _navigator = new NScrollArea;</a>
<a name="ln1100">      _navigator-&gt;setFocusPolicy(Qt::NoFocus);</a>
<a name="ln1101">      mainWindow-&gt;addWidget(_navigator);</a>
<a name="ln1102">      scorePageLayoutChanged();</a>
<a name="ln1103">      showNavigator(preferences.getBool(PREF_UI_APP_STARTUP_SHOWNAVIGATOR));</a>
<a name="ln1104"> </a>
<a name="ln1105">      _timeline = new TDockWidget;</a>
<a name="ln1106">      _timeline-&gt;setFocusPolicy(Qt::NoFocus);</a>
<a name="ln1107">      addDockWidget(Qt::BottomDockWidgetArea, _timeline);</a>
<a name="ln1108">      scorePageLayoutChanged();</a>
<a name="ln1109">      showTimeline(false);</a>
<a name="ln1110"> </a>
<a name="ln1111">      scoreCmpTool = new ScoreComparisonTool;</a>
<a name="ln1112">      scoreCmpTool-&gt;setVisible(false);</a>
<a name="ln1113">      {</a>
<a name="ln1114">      QAction* a = getAction(&quot;toggle-scorecmp-tool&quot;);</a>
<a name="ln1115">      connect(</a>
<a name="ln1116">         scoreCmpTool, &amp;ScoreComparisonTool::visibilityChanged,</a>
<a name="ln1117">         a,            &amp;QAction::setChecked</a>
<a name="ln1118">         );</a>
<a name="ln1119">      }</a>
<a name="ln1120">      addDockWidget(Qt::BottomDockWidgetArea, scoreCmpTool);</a>
<a name="ln1121"> </a>
<a name="ln1122">      if (MuseScore::unstable()) {</a>
<a name="ln1123">            scriptRecorder = new ScriptRecorderWidget(this, this);</a>
<a name="ln1124">            scriptRecorder-&gt;setVisible(false);</a>
<a name="ln1125">            QAction* a = getAction(&quot;toggle-script-recorder&quot;);</a>
<a name="ln1126">            connect(</a>
<a name="ln1127">               scriptRecorder, &amp;ScriptRecorderWidget::visibilityChanged,</a>
<a name="ln1128">               a,              &amp;QAction::setChecked</a>
<a name="ln1129">               );</a>
<a name="ln1130">            addDockWidget(Qt::RightDockWidgetArea, scriptRecorder);</a>
<a name="ln1131">            }</a>
<a name="ln1132"> </a>
<a name="ln1133">      mainWindow-&gt;setStretchFactor(0, 1);</a>
<a name="ln1134">      mainWindow-&gt;setStretchFactor(1, 0);</a>
<a name="ln1135">      mainWindow-&gt;setSizes(QList&lt;int&gt;({500, 50}));</a>
<a name="ln1136"> </a>
<a name="ln1137">      QSplitter* envelope = new QSplitter;</a>
<a name="ln1138">      envelope-&gt;setObjectName(&quot;pane&quot;);</a>
<a name="ln1139">      envelope-&gt;setAccessibleName(&quot;&quot;);</a>
<a name="ln1140">      envelope-&gt;setChildrenCollapsible(false);</a>
<a name="ln1141">      envelope-&gt;setOrientation(Qt::Vertical);</a>
<a name="ln1142">      envelope-&gt;addWidget(mainWindow);</a>
<a name="ln1143"> </a>
<a name="ln1144">      importmidiPanel = new ImportMidiPanel(this);</a>
<a name="ln1145">      importmidiPanel-&gt;setVisible(false);</a>
<a name="ln1146">      envelope-&gt;addWidget(importmidiPanel);</a>
<a name="ln1147"> </a>
<a name="ln1148">      {</a>
<a name="ln1149">      importmidiShowPanel = new QFrame;</a>
<a name="ln1150">      QHBoxLayout *hl = new QHBoxLayout;</a>
<a name="ln1151">      hl-&gt;setMargin(0);</a>
<a name="ln1152">      hl-&gt;setSpacing(0);</a>
<a name="ln1153">      importmidiShowPanel-&gt;setLayout(hl);</a>
<a name="ln1154">      showMidiImportButton = new QPushButton();</a>
<a name="ln1155">      showMidiImportButton-&gt;setFocusPolicy(Qt::ClickFocus);</a>
<a name="ln1156">      importmidiShowPanel-&gt;setVisible(false);</a>
<a name="ln1157">      connect(showMidiImportButton, SIGNAL(clicked()), SLOT(showMidiImportPanel()));</a>
<a name="ln1158">      connect(importmidiPanel, SIGNAL(closeClicked()), importmidiShowPanel, SLOT(show()));</a>
<a name="ln1159">      hl-&gt;addWidget(showMidiImportButton);</a>
<a name="ln1160">      QSpacerItem *item = new QSpacerItem(1, 1, QSizePolicy::Expanding, QSizePolicy::Fixed);</a>
<a name="ln1161">      hl-&gt;addSpacerItem(item);</a>
<a name="ln1162">      envelope-&gt;addWidget(importmidiShowPanel);</a>
<a name="ln1163">      }</a>
<a name="ln1164"> </a>
<a name="ln1165">      envelope-&gt;setSizes(QList&lt;int&gt;({550, 180}));</a>
<a name="ln1166"> </a>
<a name="ln1167">      splitter = new QSplitter;</a>
<a name="ln1168">      splitter-&gt;setObjectName(&quot;splitter&quot;);</a>
<a name="ln1169">      splitter-&gt;setAccessibleName(&quot;&quot;);</a>
<a name="ln1170">      tab1 = createScoreTab();</a>
<a name="ln1171">      splitter-&gt;addWidget(tab1);</a>
<a name="ln1172">      ctab = tab1; // make tab1 active by default.</a>
<a name="ln1173"> </a>
<a name="ln1174">      if (splitScreen()) {</a>
<a name="ln1175">            tab2 = createScoreTab();</a>
<a name="ln1176">            splitter-&gt;addWidget(tab2);</a>
<a name="ln1177">            tab2-&gt;setVisible(false);</a>
<a name="ln1178">            }</a>
<a name="ln1179">      else</a>
<a name="ln1180">            tab2 = 0;</a>
<a name="ln1181">      layout-&gt;addWidget(splitter);</a>
<a name="ln1182"> </a>
<a name="ln1183"> </a>
<a name="ln1184">      //---------------------------------------------------</a>
<a name="ln1185">      //    Transport Action</a>
<a name="ln1186">      //---------------------------------------------------</a>
<a name="ln1187"> </a>
<a name="ln1188">      QAction* a;</a>
<a name="ln1189">#ifdef HAS_MIDI</a>
<a name="ln1190">      a  = getAction(&quot;midi-on&quot;);</a>
<a name="ln1191">      a-&gt;setEnabled(preferences.getBool(PREF_IO_MIDI_ENABLEINPUT));</a>
<a name="ln1192">      a-&gt;setChecked(_midiinEnabled);</a>
<a name="ln1193">#endif</a>
<a name="ln1194"> </a>
<a name="ln1195">      getAction(&quot;undo&quot;)-&gt;setEnabled(false);</a>
<a name="ln1196">      getAction(&quot;redo&quot;)-&gt;setEnabled(false);</a>
<a name="ln1197">      getAction(&quot;paste&quot;)-&gt;setEnabled(false);</a>
<a name="ln1198">      getAction(&quot;swap&quot;)-&gt;setEnabled(false);</a>
<a name="ln1199">      selectionChanged(SelState::NONE);</a>
<a name="ln1200"> </a>
<a name="ln1201">      //---------------------------------------------------</a>
<a name="ln1202">      //    File Tool Bar</a>
<a name="ln1203">      //---------------------------------------------------</a>
<a name="ln1204"> </a>
<a name="ln1205">      fileTools = addToolBar(&quot;&quot;);</a>
<a name="ln1206">      fileTools-&gt;setObjectName(&quot;file-operations&quot;);</a>
<a name="ln1207">      populateFileOperations();</a>
<a name="ln1208"> </a>
<a name="ln1209">      //---------------------</a>
<a name="ln1210">      //    Transport Tool Bar</a>
<a name="ln1211">      //---------------------</a>
<a name="ln1212"> </a>
<a name="ln1213">      transportTools = addToolBar(&quot;&quot;);</a>
<a name="ln1214">      transportTools-&gt;setObjectName(&quot;transport-tools&quot;);</a>
<a name="ln1215">      populatePlaybackControls();</a>
<a name="ln1216"> </a>
<a name="ln1217">      //-------------------------------</a>
<a name="ln1218">      //    Concert Pitch Tool Bar</a>
<a name="ln1219">      //-------------------------------</a>
<a name="ln1220"> </a>
<a name="ln1221">      cpitchTools = addToolBar(&quot;&quot;);</a>
<a name="ln1222">      cpitchTools-&gt;setObjectName(&quot;pitch-tools&quot;);</a>
<a name="ln1223">      a = getAction(&quot;concert-pitch&quot;);</a>
<a name="ln1224">      a-&gt;setCheckable(true);</a>
<a name="ln1225">      AccessibleToolButton* concertPitchButton = new AccessibleToolButton(cpitchTools, a);</a>
<a name="ln1226">      concertPitchButton-&gt;setProperty(&quot;iconic-text&quot;, true);</a>
<a name="ln1227">      cpitchTools-&gt;addWidget(concertPitchButton);</a>
<a name="ln1228"> </a>
<a name="ln1229">      //-------------------------------</a>
<a name="ln1230">      //    Image Capture Tool Bar</a>
<a name="ln1231">      //-------------------------------</a>
<a name="ln1232"> </a>
<a name="ln1233">      fotoTools = addToolBar(&quot;&quot;);</a>
<a name="ln1234">      fotoTools-&gt;setObjectName(&quot;foto-tools&quot;);</a>
<a name="ln1235">      fotoTools-&gt;addWidget(new AccessibleToolButton(fotoTools, getAction(&quot;fotomode&quot;)));</a>
<a name="ln1236"> </a>
<a name="ln1237">      //-------------------------------</a>
<a name="ln1238">      //    Feedback Tool Bar</a>
<a name="ln1239">      //-------------------------------</a>
<a name="ln1240"> </a>
<a name="ln1241">      {</a>
<a name="ln1242">      feedbackTools = addToolBar(&quot;&quot;);</a>
<a name="ln1243">      feedbackTools-&gt;setObjectName(&quot;feedback-tools&quot;);</a>
<a name="ln1244">	  // Forbid to move or undock the toolbar...</a>
<a name="ln1245">      feedbackTools-&gt;setMovable(false);</a>
<a name="ln1246">      feedbackTools-&gt;setFloatable(false);</a>
<a name="ln1247">      // Add a spacer to align the buttons to the right side.</a>
<a name="ln1248">      QWidget* spacer = new QWidget(feedbackTools);</a>
<a name="ln1249">      spacer-&gt;setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Preferred);</a>
<a name="ln1250">      feedbackTools-&gt;addWidget(spacer);</a>
<a name="ln1251">      // And, finally, add the buttons themselves.</a>
<a name="ln1252">      AccessibleToolButton* feedbackButton = new AccessibleToolButton(feedbackTools, getAction(&quot;leave-feedback&quot;));</a>
<a name="ln1253">      feedbackButton-&gt;setToolButtonStyle(Qt::ToolButtonTextBesideIcon);</a>
<a name="ln1254">      feedbackTools-&gt;addWidget(feedbackButton);</a>
<a name="ln1255">      }</a>
<a name="ln1256"> </a>
<a name="ln1257">      addToolBarBreak();</a>
<a name="ln1258"> </a>
<a name="ln1259">      //-------------------------------</a>
<a name="ln1260">      //    Note Input Tool Bar</a>
<a name="ln1261">      //-------------------------------</a>
<a name="ln1262"> </a>
<a name="ln1263">      entryTools = addToolBar(&quot;&quot;);</a>
<a name="ln1264">      entryTools-&gt;setObjectName(&quot;entry-tools&quot;);</a>
<a name="ln1265"> </a>
<a name="ln1266">      populateNoteInputMenu();</a>
<a name="ln1267"> </a>
<a name="ln1268">      //-------------------------------</a>
<a name="ln1269">      //    Workspaces Tool Bar</a>
<a name="ln1270">      //-------------------------------</a>
<a name="ln1271"> </a>
<a name="ln1272">      {</a>
<a name="ln1273">      workspacesTools = addToolBar(&quot;&quot;);</a>
<a name="ln1274">      workspacesTools-&gt;setObjectName(&quot;workspaces-tools&quot;);</a>
<a name="ln1275"> </a>
<a name="ln1276">      // Add a spacer to align the buttons to the right side.</a>
<a name="ln1277">      QWidget* spacer = new QWidget(workspacesTools);</a>
<a name="ln1278">      spacer-&gt;setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Preferred);</a>
<a name="ln1279">      workspacesTools-&gt;addWidget(spacer);</a>
<a name="ln1280"> </a>
<a name="ln1281">      WorkspaceComboBox* box = new WorkspaceComboBox(this);</a>
<a name="ln1282">      workspacesTools-&gt;addWidget(box);</a>
<a name="ln1283"> </a>
<a name="ln1284">      AccessibleToolButton* addWorkspaceButton = new AccessibleToolButton(workspacesTools, getAction(&quot;create-new-workspace&quot;));</a>
<a name="ln1285">      addWorkspaceButton-&gt;setMinimumHeight(24);</a>
<a name="ln1286">      workspacesTools-&gt;addWidget(addWorkspaceButton);</a>
<a name="ln1287">      }</a>
<a name="ln1288"> </a>
<a name="ln1289">      addToolBarBreak();</a>
<a name="ln1290"> </a>
<a name="ln1291">      //---------------------</a>
<a name="ln1292">      //    Menus</a>
<a name="ln1293">      //---------------------</a>
<a name="ln1294"> </a>
<a name="ln1295">      QMenuBar* mb = menuBar();</a>
<a name="ln1296"> </a>
<a name="ln1297">      //---------------------</a>
<a name="ln1298">      //    Menu File</a>
<a name="ln1299">      //---------------------</a>
<a name="ln1300"> </a>
<a name="ln1301">      menuFile = mb-&gt;addMenu(&quot;&quot;);</a>
<a name="ln1302">      menuFile-&gt;setObjectName(&quot;File&quot;);</a>
<a name="ln1303"> </a>
<a name="ln1304">      a = getAction(&quot;startcenter&quot;);</a>
<a name="ln1305">      a-&gt;setCheckable(true);</a>
<a name="ln1306">      menuFile-&gt;addAction(a);</a>
<a name="ln1307">      menuFile-&gt;addAction(getAction(&quot;file-new&quot;));</a>
<a name="ln1308">      menuFile-&gt;addAction(getAction(&quot;file-open&quot;));</a>
<a name="ln1309"> </a>
<a name="ln1310">      openRecent = menuFile-&gt;addMenu(&quot;&quot;);</a>
<a name="ln1311"> </a>
<a name="ln1312">      connect(openRecent, SIGNAL(aboutToShow()), SLOT(openRecentMenu()));</a>
<a name="ln1313">      connect(openRecent, SIGNAL(triggered(QAction*)), SLOT(selectScore(QAction*)));</a>
<a name="ln1314"> </a>
<a name="ln1315">      for (auto i : {</a>
<a name="ln1316">            &quot;&quot;,</a>
<a name="ln1317">            &quot;file-save&quot;,</a>
<a name="ln1318">            &quot;file-save-as&quot;,</a>
<a name="ln1319">            &quot;file-save-a-copy&quot;,</a>
<a name="ln1320">            &quot;file-save-selection&quot;,</a>
<a name="ln1321">            saveOnlineMenuItem,</a>
<a name="ln1322">            &quot;file-export&quot;,</a>
<a name="ln1323">            &quot;file-part-export&quot;,</a>
<a name="ln1324">            &quot;file-import-pdf&quot;,</a>
<a name="ln1325">            &quot;&quot;,</a>
<a name="ln1326">            &quot;file-close&quot;,</a>
<a name="ln1327">            &quot;&quot;,</a>
<a name="ln1328">            &quot;parts&quot;,</a>
<a name="ln1329">            &quot;album&quot;}) {</a>
<a name="ln1330">            if (!*i) {</a>
<a name="ln1331">                  menuFile-&gt;addSeparator();</a>
<a name="ln1332">                  continue;</a>
<a name="ln1333">                  }</a>
<a name="ln1334"> </a>
<a name="ln1335">            if (strcmp(i, &quot;album&quot;) == 0) { //enable Album feature in experimental mode</a>
<a name="ln1336">                  if (enableExperimental)</a>
<a name="ln1337">                        menuFile-&gt;addAction(getAction(&quot;album&quot;));</a>
<a name="ln1338">                  continue;</a>
<a name="ln1339">                  }</a>
<a name="ln1340">            else</a>
<a name="ln1341">                  menuFile-&gt;addAction(getAction(i));</a>
<a name="ln1342">            }</a>
<a name="ln1343">      if (enableExperimental)</a>
<a name="ln1344">            menuFile-&gt;addAction(getAction(&quot;layer&quot;));</a>
<a name="ln1345">      menuFile-&gt;addSeparator();</a>
<a name="ln1346">      menuFile-&gt;addAction(getAction(&quot;edit-info&quot;));</a>
<a name="ln1347">      if (enableExperimental)</a>
<a name="ln1348">            menuFile-&gt;addAction(getAction(&quot;media&quot;));</a>
<a name="ln1349">      menuFile-&gt;addSeparator();</a>
<a name="ln1350">      menuFile-&gt;addAction(getAction(&quot;print&quot;));</a>
<a name="ln1351">#ifndef Q_OS_MAC</a>
<a name="ln1352">      menuFile-&gt;addSeparator();</a>
<a name="ln1353">      menuFile-&gt;addAction(getAction(&quot;quit&quot;));</a>
<a name="ln1354">#endif</a>
<a name="ln1355"> </a>
<a name="ln1356">      //---------------------</a>
<a name="ln1357">      //    Menu Edit</a>
<a name="ln1358">      //---------------------</a>
<a name="ln1359"> </a>
<a name="ln1360">      menuEdit = mb-&gt;addMenu(&quot;&quot;);</a>
<a name="ln1361">      menuEdit-&gt;setObjectName(&quot;Edit&quot;);</a>
<a name="ln1362">      menuEdit-&gt;addAction(getAction(&quot;undo&quot;));</a>
<a name="ln1363">      menuEdit-&gt;addAction(getAction(&quot;redo&quot;));</a>
<a name="ln1364"> </a>
<a name="ln1365">      menuEdit-&gt;addSeparator();</a>
<a name="ln1366">      menuEdit-&gt;addAction(getAction(&quot;cut&quot;));</a>
<a name="ln1367">      menuEdit-&gt;addAction(getAction(&quot;copy&quot;));</a>
<a name="ln1368">      menuEdit-&gt;addAction(getAction(&quot;paste&quot;));</a>
<a name="ln1369">      menuEdit-&gt;addAction(getAction(&quot;paste-half&quot;));</a>
<a name="ln1370">      menuEdit-&gt;addAction(getAction(&quot;paste-double&quot;));</a>
<a name="ln1371">      menuEdit-&gt;addAction(getAction(&quot;swap&quot;));</a>
<a name="ln1372">      menuEdit-&gt;addAction(getAction(&quot;delete&quot;));</a>
<a name="ln1373"> </a>
<a name="ln1374">      menuEdit-&gt;addSeparator();</a>
<a name="ln1375">      menuEdit-&gt;addAction(getAction(&quot;select-all&quot;));</a>
<a name="ln1376">      menuEdit-&gt;addAction(getAction(&quot;select-section&quot;));</a>
<a name="ln1377">      menuEdit-&gt;addAction(getAction(&quot;find&quot;));</a>
<a name="ln1378"> </a>
<a name="ln1379">      menuEdit-&gt;addSeparator();</a>
<a name="ln1380"> </a>
<a name="ln1381">      menuEdit-&gt;addAction(getAction(&quot;instruments&quot;));</a>
<a name="ln1382"> </a>
<a name="ln1383">#ifdef NDEBUG</a>
<a name="ln1384">      if (enableExperimental) {</a>
<a name="ln1385">#endif</a>
<a name="ln1386">            menuEdit-&gt;addSeparator();</a>
<a name="ln1387">            menuEdit-&gt;addAction(getAction(&quot;debugger&quot;));</a>
<a name="ln1388">#ifdef NDEBUG</a>
<a name="ln1389">            }</a>
<a name="ln1390">#endif</a>
<a name="ln1391"> </a>
<a name="ln1392">      menuEdit-&gt;addSeparator();</a>
<a name="ln1393">      pref = new QAction(&quot;&quot;, 0);</a>
<a name="ln1394">      connect(pref, SIGNAL(triggered()), this, SLOT(startPreferenceDialog()));</a>
<a name="ln1395">      menuEdit-&gt;addAction(pref);</a>
<a name="ln1396">      pref-&gt;setMenuRole(QAction::PreferencesRole);</a>
<a name="ln1397">      Workspace::addActionAndString(pref, &quot;preference-dialog&quot;);</a>
<a name="ln1398"> </a>
<a name="ln1399">      //---------------------</a>
<a name="ln1400">      //    Menu View</a>
<a name="ln1401">      //---------------------</a>
<a name="ln1402"> </a>
<a name="ln1403">      menuView = mb-&gt;addMenu(&quot;&quot;);</a>
<a name="ln1404">      menuView-&gt;setObjectName(&quot;View&quot;);</a>
<a name="ln1405"> </a>
<a name="ln1406">      a = getAction(&quot;toggle-palette&quot;);</a>
<a name="ln1407">      a-&gt;setCheckable(true);</a>
<a name="ln1408">      menuView-&gt;addAction(a);</a>
<a name="ln1409"> </a>
<a name="ln1410">      a = getAction(&quot;masterpalette&quot;);</a>
<a name="ln1411">      a-&gt;setCheckable(true);</a>
<a name="ln1412">      menuView-&gt;addAction(a);</a>
<a name="ln1413"> </a>
<a name="ln1414">      a = getAction(&quot;inspector&quot;);</a>
<a name="ln1415">      a-&gt;setCheckable(true);</a>
<a name="ln1416">      menuView-&gt;addAction(a);</a>
<a name="ln1417">#ifdef OMR</a>
<a name="ln1418">      a = getAction(&quot;omr&quot;);</a>
<a name="ln1419">      a-&gt;setCheckable(true);</a>
<a name="ln1420">      menuView-&gt;addAction(a);</a>
<a name="ln1421">#endif</a>
<a name="ln1422">      playId = getAction(&quot;toggle-playpanel&quot;);</a>
<a name="ln1423">      playId-&gt;setCheckable(true);</a>
<a name="ln1424">      menuView-&gt;addAction(playId);</a>
<a name="ln1425"> </a>
<a name="ln1426">      a = getAction(&quot;toggle-navigator&quot;);</a>
<a name="ln1427">      a-&gt;setCheckable(true);</a>
<a name="ln1428">      a-&gt;setChecked(preferences.getBool(PREF_UI_APP_STARTUP_SHOWNAVIGATOR));</a>
<a name="ln1429">      menuView-&gt;addAction(a);</a>
<a name="ln1430"> </a>
<a name="ln1431">      a = getAction(&quot;toggle-timeline&quot;);</a>
<a name="ln1432">      a-&gt;setCheckable(true);</a>
<a name="ln1433">      menuView-&gt;addAction(a);</a>
<a name="ln1434"> </a>
<a name="ln1435">      a = getAction(&quot;toggle-mixer&quot;);</a>
<a name="ln1436">      a-&gt;setCheckable(true);</a>
<a name="ln1437">      menuView-&gt;addAction(a);</a>
<a name="ln1438"> </a>
<a name="ln1439">      a = getAction(&quot;synth-control&quot;);</a>
<a name="ln1440">      a-&gt;setCheckable(true);</a>
<a name="ln1441">      menuView-&gt;addAction(a);</a>
<a name="ln1442"> </a>
<a name="ln1443">      a = getAction(&quot;toggle-selection-window&quot;);</a>
<a name="ln1444">      a-&gt;setCheckable(true);</a>
<a name="ln1445">      menuView-&gt;addAction(a);</a>
<a name="ln1446"> </a>
<a name="ln1447">      a = getAction(&quot;toggle-piano&quot;);</a>
<a name="ln1448">      a-&gt;setCheckable(true);</a>
<a name="ln1449">      menuView-&gt;addAction(a);</a>
<a name="ln1450"> </a>
<a name="ln1451">      a = getAction(&quot;toggle-scorecmp-tool&quot;);</a>
<a name="ln1452">      a-&gt;setCheckable(true);</a>
<a name="ln1453">      menuView-&gt;addAction(a);</a>
<a name="ln1454"> </a>
<a name="ln1455">      menuView-&gt;addSeparator();</a>
<a name="ln1456">      menuView-&gt;addAction(getAction(&quot;zoomin&quot;));</a>
<a name="ln1457">      menuView-&gt;addAction(getAction(&quot;zoomout&quot;));</a>
<a name="ln1458">      menuView-&gt;addSeparator();</a>
<a name="ln1459"> </a>
<a name="ln1460">      menuToolbars = new QMenu();</a>
<a name="ln1461"> </a>
<a name="ln1462">      a = getAction(&quot;toggle-fileoperations&quot;);</a>
<a name="ln1463">      a-&gt;setCheckable(true);</a>
<a name="ln1464">      a-&gt;setChecked(fileTools-&gt;isVisible());</a>
<a name="ln1465">      connect(fileTools, SIGNAL(visibilityChanged(bool)), a, SLOT(setChecked(bool)));</a>
<a name="ln1466">      menuToolbars-&gt;addAction(a);</a>
<a name="ln1467"> </a>
<a name="ln1468">      a = getAction(&quot;toggle-transport&quot;);</a>
<a name="ln1469">      a-&gt;setCheckable(true);</a>
<a name="ln1470">      a-&gt;setChecked(transportTools-&gt;isVisible());</a>
<a name="ln1471">      connect(transportTools, SIGNAL(visibilityChanged(bool)), a, SLOT(setChecked(bool)));</a>
<a name="ln1472">      menuToolbars-&gt;addAction(a);</a>
<a name="ln1473"> </a>
<a name="ln1474">      a = getAction(&quot;toggle-concertpitch&quot;);</a>
<a name="ln1475">      a-&gt;setCheckable(true);</a>
<a name="ln1476">      a-&gt;setChecked(cpitchTools-&gt;isVisible());</a>
<a name="ln1477">      connect(cpitchTools, SIGNAL(visibilityChanged(bool)), a, SLOT(setChecked(bool)));</a>
<a name="ln1478">      menuToolbars-&gt;addAction(a);</a>
<a name="ln1479"> </a>
<a name="ln1480">      a = getAction(&quot;toggle-imagecapture&quot;);</a>
<a name="ln1481">      a-&gt;setCheckable(true);</a>
<a name="ln1482">      a-&gt;setChecked(fotoTools-&gt;isVisible());</a>
<a name="ln1483">      connect(fotoTools, SIGNAL(visibilityChanged(bool)), a, SLOT(setChecked(bool)));</a>
<a name="ln1484">      menuToolbars-&gt;addAction(a);</a>
<a name="ln1485"> </a>
<a name="ln1486">      a = getAction(&quot;toggle-noteinput&quot;);</a>
<a name="ln1487">      a-&gt;setCheckable(true);</a>
<a name="ln1488">      a-&gt;setChecked(entryTools-&gt;isVisible());</a>
<a name="ln1489">      connect(entryTools, SIGNAL(visibilityChanged(bool)), a, SLOT(setChecked(bool)));</a>
<a name="ln1490">      menuToolbars-&gt;addAction(a);</a>
<a name="ln1491"> </a>
<a name="ln1492">      a = getAction(&quot;toggle-feedback&quot;);</a>
<a name="ln1493">      a-&gt;setCheckable(true);</a>
<a name="ln1494">      a-&gt;setChecked(feedbackTools-&gt;isVisible());</a>
<a name="ln1495">      connect(feedbackTools, SIGNAL(visibilityChanged(bool)), a, SLOT(setChecked(bool)));</a>
<a name="ln1496">      menuToolbars-&gt;addAction(a);</a>
<a name="ln1497"> </a>
<a name="ln1498">      a = getAction(&quot;toggle-workspaces-toolbar&quot;);</a>
<a name="ln1499">      a-&gt;setCheckable(true);</a>
<a name="ln1500">      a-&gt;setChecked(workspacesTools-&gt;isVisible());</a>
<a name="ln1501">      connect(workspacesTools, SIGNAL(visibilityChanged(bool)), a, SLOT(setChecked(bool)));</a>
<a name="ln1502">      menuToolbars-&gt;addAction(a);</a>
<a name="ln1503"> </a>
<a name="ln1504">      menuToolbars-&gt;addSeparator();</a>
<a name="ln1505"> </a>
<a name="ln1506">      menuToolbars-&gt;addAction(getAction(&quot;edit-toolbars&quot;));</a>
<a name="ln1507"> </a>
<a name="ln1508">      menuView-&gt;addMenu(menuToolbars);</a>
<a name="ln1509"> </a>
<a name="ln1510">      menuWorkspaces = new QMenu();</a>
<a name="ln1511">      connect(menuWorkspaces, SIGNAL(aboutToShow()), SLOT(showWorkspaceMenu()));</a>
<a name="ln1512">      menuView-&gt;addMenu(menuWorkspaces);</a>
<a name="ln1513"> </a>
<a name="ln1514">      a = getAction(&quot;toggle-statusbar&quot;);</a>
<a name="ln1515">      a-&gt;setCheckable(true);</a>
<a name="ln1516">      a-&gt;setChecked(preferences.getBool(PREF_UI_APP_SHOWSTATUSBAR));</a>
<a name="ln1517">      menuView-&gt;addAction(a);</a>
<a name="ln1518"> </a>
<a name="ln1519">      menuView-&gt;addSeparator();</a>
<a name="ln1520">      a = getAction(&quot;split-h&quot;);</a>
<a name="ln1521">      a-&gt;setCheckable(true);</a>
<a name="ln1522">      menuView-&gt;addAction(a);</a>
<a name="ln1523">      a = getAction(&quot;split-v&quot;);</a>
<a name="ln1524">      a-&gt;setCheckable(true);</a>
<a name="ln1525">      menuView-&gt;addAction(a);</a>
<a name="ln1526"> </a>
<a name="ln1527">      menuView-&gt;addSeparator();</a>
<a name="ln1528">      menuView-&gt;addAction(getAction(&quot;show-invisible&quot;));</a>
<a name="ln1529">      menuView-&gt;addAction(getAction(&quot;show-unprintable&quot;));</a>
<a name="ln1530">      menuView-&gt;addAction(getAction(&quot;show-frames&quot;));</a>
<a name="ln1531">      menuView-&gt;addAction(getAction(&quot;show-pageborders&quot;));</a>
<a name="ln1532">      menuView-&gt;addAction(getAction(&quot;mark-irregular&quot;));</a>
<a name="ln1533">      menuView-&gt;addSeparator();</a>
<a name="ln1534"> </a>
<a name="ln1535">      a = getAction(&quot;fullscreen&quot;);</a>
<a name="ln1536">      a-&gt;setCheckable(true);</a>
<a name="ln1537">      a-&gt;setChecked(false);</a>
<a name="ln1538">#ifndef Q_OS_MAC</a>
<a name="ln1539">      menuView-&gt;addAction(a);</a>
<a name="ln1540">#endif</a>
<a name="ln1541"> </a>
<a name="ln1542">      //---------------------</a>
<a name="ln1543">      //    Menu Add</a>
<a name="ln1544">      //---------------------</a>
<a name="ln1545"> </a>
<a name="ln1546">      menuAdd = mb-&gt;addMenu(&quot;&quot;);</a>
<a name="ln1547">      menuAdd-&gt;setObjectName(&quot;Add&quot;);</a>
<a name="ln1548"> </a>
<a name="ln1549">      menuAddPitch = new QMenu();</a>
<a name="ln1550">      menuAddPitch-&gt;addAction(getAction(&quot;note-input&quot;));</a>
<a name="ln1551">      menuAddPitch-&gt;addSeparator();</a>
<a name="ln1552"> </a>
<a name="ln1553">      for (int i = 0; i &lt; 7; ++i) {</a>
<a name="ln1554">            char buffer[8];</a>
<a name="ln1555">            sprintf(buffer, &quot;note-%c&quot;, &quot;cdefgab&quot;[i]);</a>
<a name="ln1556">            a = getAction(buffer);</a>
<a name="ln1557">            menuAddPitch-&gt;addAction(a);</a>
<a name="ln1558">            }</a>
<a name="ln1559">      menuAddPitch-&gt;addSeparator();</a>
<a name="ln1560">      for (int i = 0; i &lt; 7; ++i) {</a>
<a name="ln1561">            char buffer[8];</a>
<a name="ln1562">            sprintf(buffer, &quot;chord-%c&quot;, &quot;cdefgab&quot;[i]);</a>
<a name="ln1563">            a = getAction(buffer);</a>
<a name="ln1564">            menuAddPitch-&gt;addAction(a);</a>
<a name="ln1565">            }</a>
<a name="ln1566">      menuAdd-&gt;addMenu(menuAddPitch);</a>
<a name="ln1567"> </a>
<a name="ln1568">      menuAddInterval = new QMenu();</a>
<a name="ln1569">      for (int i = 1; i &lt; 10; ++i) {</a>
<a name="ln1570">            char buffer[16];</a>
<a name="ln1571">            sprintf(buffer, &quot;interval%d&quot;, i);</a>
<a name="ln1572">            a = getAction(buffer);</a>
<a name="ln1573">            menuAddInterval-&gt;addAction(a);</a>
<a name="ln1574">            }</a>
<a name="ln1575">      menuAddInterval-&gt;addSeparator();</a>
<a name="ln1576">      for (int i = 2; i &lt; 10; ++i) {</a>
<a name="ln1577">            char buffer[16];</a>
<a name="ln1578">            sprintf(buffer, &quot;interval-%d&quot;, i);</a>
<a name="ln1579">            a = getAction(buffer);</a>
<a name="ln1580">            menuAddInterval-&gt;addAction(a);</a>
<a name="ln1581">            }</a>
<a name="ln1582">      menuAdd-&gt;addMenu(menuAddInterval);</a>
<a name="ln1583"> </a>
<a name="ln1584">      menuTuplet = new QMenu();</a>
<a name="ln1585">      for (auto i : { &quot;duplet&quot;, &quot;triplet&quot;, &quot;quadruplet&quot;, &quot;quintuplet&quot;, &quot;sextuplet&quot;,</a>
<a name="ln1586">            &quot;septuplet&quot;, &quot;octuplet&quot;, &quot;nonuplet&quot;, &quot;tuplet-dialog&quot; })</a>
<a name="ln1587">            menuTuplet-&gt;addAction(getAction(i));</a>
<a name="ln1588">      menuAdd-&gt;addMenu(menuTuplet);</a>
<a name="ln1589"> </a>
<a name="ln1590">      menuAdd-&gt;addSeparator();</a>
<a name="ln1591"> </a>
<a name="ln1592">      menuAddMeasures = new QMenu(&quot;&quot;);</a>
<a name="ln1593">      menuAddMeasures-&gt;addAction(getAction(&quot;insert-measure&quot;));</a>
<a name="ln1594">      menuAddMeasures-&gt;addAction(getAction(&quot;insert-measures&quot;));</a>
<a name="ln1595">      menuAddMeasures-&gt;addSeparator();</a>
<a name="ln1596">      menuAddMeasures-&gt;addAction(getAction(&quot;append-measure&quot;));</a>
<a name="ln1597">      menuAddMeasures-&gt;addAction(getAction(&quot;append-measures&quot;));</a>
<a name="ln1598">      menuAdd-&gt;addMenu(menuAddMeasures);</a>
<a name="ln1599"> </a>
<a name="ln1600">      menuAddFrames = new QMenu();</a>
<a name="ln1601">      menuAddFrames-&gt;addAction(getAction(&quot;insert-hbox&quot;));</a>
<a name="ln1602">      menuAddFrames-&gt;addAction(getAction(&quot;insert-vbox&quot;));</a>
<a name="ln1603">      menuAddFrames-&gt;addAction(getAction(&quot;insert-textframe&quot;));</a>
<a name="ln1604">      if (enableExperimental)</a>
<a name="ln1605">            menuAddFrames-&gt;addAction(getAction(&quot;insert-fretframe&quot;));</a>
<a name="ln1606">      menuAddFrames-&gt;addSeparator();</a>
<a name="ln1607">      menuAddFrames-&gt;addAction(getAction(&quot;append-hbox&quot;));</a>
<a name="ln1608">      menuAddFrames-&gt;addAction(getAction(&quot;append-vbox&quot;));</a>
<a name="ln1609">      menuAddFrames-&gt;addAction(getAction(&quot;append-textframe&quot;));</a>
<a name="ln1610">      menuAdd-&gt;addMenu(menuAddFrames);</a>
<a name="ln1611"> </a>
<a name="ln1612">      menuAddText = new QMenu();</a>
<a name="ln1613">      menuAddText-&gt;addAction(getAction(&quot;title-text&quot;));</a>
<a name="ln1614">      menuAddText-&gt;addAction(getAction(&quot;subtitle-text&quot;));</a>
<a name="ln1615">      menuAddText-&gt;addAction(getAction(&quot;composer-text&quot;));</a>
<a name="ln1616">      menuAddText-&gt;addAction(getAction(&quot;poet-text&quot;));</a>
<a name="ln1617">      menuAddText-&gt;addAction(getAction(&quot;part-text&quot;));</a>
<a name="ln1618">      menuAddText-&gt;addSeparator();</a>
<a name="ln1619">      menuAddText-&gt;addAction(getAction(&quot;system-text&quot;));</a>
<a name="ln1620">      menuAddText-&gt;addAction(getAction(&quot;staff-text&quot;));</a>
<a name="ln1621">      menuAddText-&gt;addAction(getAction(&quot;expression-text&quot;));</a>
<a name="ln1622">      menuAddText-&gt;addAction(getAction(&quot;chord-text&quot;));</a>
<a name="ln1623">      menuAddText-&gt;addAction(getAction(&quot;rehearsalmark-text&quot;));</a>
<a name="ln1624">      menuAddText-&gt;addAction(getAction(&quot;instrument-change-text&quot;));</a>
<a name="ln1625">      menuAddText-&gt;addAction(getAction(&quot;fingering-text&quot;));</a>
<a name="ln1626">      menuAddText-&gt;addSeparator();</a>
<a name="ln1627">      menuAddText-&gt;addAction(getAction(&quot;lyrics&quot;));</a>
<a name="ln1628">      menuAddText-&gt;addAction(getAction(&quot;sticking-text&quot;));</a>
<a name="ln1629">      menuAddText-&gt;addAction(getAction(&quot;roman-numeral-text&quot;));</a>
<a name="ln1630">      menuAddText-&gt;addAction(getAction(&quot;nashville-number-text&quot;));</a>
<a name="ln1631">      menuAddText-&gt;addAction(getAction(&quot;figured-bass&quot;));</a>
<a name="ln1632">      menuAddText-&gt;addAction(getAction(&quot;tempo&quot;));</a>
<a name="ln1633">      menuAdd-&gt;addMenu(menuAddText);</a>
<a name="ln1634"> </a>
<a name="ln1635">      menuAddLines = new QMenu();</a>
<a name="ln1636">      menuAddLines-&gt;addAction(getAction(&quot;add-slur&quot;));</a>
<a name="ln1637">      menuAddLines-&gt;addAction(getAction(&quot;add-hairpin&quot;));</a>
<a name="ln1638">      menuAddLines-&gt;addAction(getAction(&quot;add-hairpin-reverse&quot;));</a>
<a name="ln1639">      menuAddLines-&gt;addAction(getAction(&quot;add-8va&quot;));</a>
<a name="ln1640">      menuAddLines-&gt;addAction(getAction(&quot;add-8vb&quot;));</a>
<a name="ln1641">      menuAddLines-&gt;addAction(getAction(&quot;add-noteline&quot;));</a>
<a name="ln1642">      menuAdd-&gt;addMenu(menuAddLines);</a>
<a name="ln1643"> </a>
<a name="ln1644">      //---------------------</a>
<a name="ln1645">      //    Menu Format</a>
<a name="ln1646">      //---------------------</a>
<a name="ln1647"> </a>
<a name="ln1648">      menuFormat = mb-&gt;addMenu(&quot;&quot;);</a>
<a name="ln1649">      menuFormat-&gt;setObjectName(&quot;Format&quot;);</a>
<a name="ln1650"> </a>
<a name="ln1651">      menuFormat-&gt;addAction(getAction(&quot;edit-style&quot;));</a>
<a name="ln1652">      QAction* pageSettingsAction = getAction(&quot;page-settings&quot;);</a>
<a name="ln1653">      // in some locale (fr), page settings ends up in Application menu on mac</a>
<a name="ln1654">      // this line prevents it.</a>
<a name="ln1655">      pageSettingsAction-&gt;setMenuRole(QAction::NoRole);</a>
<a name="ln1656">      menuFormat-&gt;addAction(pageSettingsAction);</a>
<a name="ln1657">      menuFormat-&gt;addSeparator();</a>
<a name="ln1658"> </a>
<a name="ln1659">      menuFormat-&gt;addAction(getAction(&quot;add-remove-breaks&quot;));</a>
<a name="ln1660"> </a>
<a name="ln1661">      menuStretch = new QMenu(tr(&quot;&amp;Stretch&quot;));</a>
<a name="ln1662">      for (auto i : { &quot;stretch+&quot;, &quot;stretch-&quot;, &quot;reset-stretch&quot; })</a>
<a name="ln1663">            menuStretch-&gt;addAction(getAction(i));</a>
<a name="ln1664">      Workspace::addMenuAndString(menuStretch, &quot;menu-stretch&quot;);</a>
<a name="ln1665">      menuFormat-&gt;addMenu(menuStretch);</a>
<a name="ln1666">      menuFormat-&gt;addSeparator();</a>
<a name="ln1667"> </a>
<a name="ln1668">      menuFormat-&gt;addAction(getAction(&quot;reset-style&quot;));</a>
<a name="ln1669">      menuFormat-&gt;addAction(getAction(&quot;reset-beammode&quot;));</a>
<a name="ln1670">      menuFormat-&gt;addAction(getAction(&quot;reset&quot;));</a>
<a name="ln1671">      menuFormat-&gt;addSeparator();</a>
<a name="ln1672"> </a>
<a name="ln1673">      if (enableExperimental)</a>
<a name="ln1674">            menuFormat-&gt;addAction(getAction(&quot;edit-harmony&quot;));</a>
<a name="ln1675"> </a>
<a name="ln1676">      menuFormat-&gt;addSeparator();</a>
<a name="ln1677">      menuFormat-&gt;addAction(getAction(&quot;load-style&quot;));</a>
<a name="ln1678">      menuFormat-&gt;addAction(getAction(&quot;save-style&quot;));</a>
<a name="ln1679"> </a>
<a name="ln1680">      //---------------------</a>
<a name="ln1681">      //    Menu Tools</a>
<a name="ln1682">      //---------------------</a>
<a name="ln1683"> </a>
<a name="ln1684">      menuTools = mb-&gt;addMenu(&quot;&quot;);</a>
<a name="ln1685">      menuTools-&gt;setObjectName(&quot;Tools&quot;);</a>
<a name="ln1686"> </a>
<a name="ln1687">      menuTools-&gt;addAction(getAction(&quot;transpose&quot;));</a>
<a name="ln1688">      menuTools-&gt;addSeparator();</a>
<a name="ln1689">      menuTools-&gt;addAction(getAction(&quot;explode&quot;));</a>
<a name="ln1690">      menuTools-&gt;addAction(getAction(&quot;implode&quot;));</a>
<a name="ln1691"> </a>
<a name="ln1692">      menuVoices = new QMenu(&quot;&quot;);</a>
<a name="ln1693">      for (auto i : { &quot;voice-x12&quot;, &quot;voice-x13&quot;, &quot;voice-x14&quot;, &quot;voice-x23&quot;, &quot;voice-x24&quot;, &quot;voice-x34&quot; })</a>
<a name="ln1694">            menuVoices-&gt;addAction(getAction(i));</a>
<a name="ln1695">      menuTools-&gt;addMenu(menuVoices);</a>
<a name="ln1696"> </a>
<a name="ln1697">      menuMeasure = new QMenu(&quot;&quot;);</a>
<a name="ln1698">      for (auto i : { &quot;split-measure&quot;, &quot;join-measures&quot; })</a>
<a name="ln1699">            menuMeasure-&gt;addAction(getAction(i));</a>
<a name="ln1700">      menuTools-&gt;addMenu(menuMeasure);</a>
<a name="ln1701">      menuTools-&gt;addAction(getAction(&quot;time-delete&quot;));</a>
<a name="ln1702"> </a>
<a name="ln1703">      menuTools-&gt;addSeparator();</a>
<a name="ln1704"> </a>
<a name="ln1705">      menuTools-&gt;addAction(getAction(&quot;slash-fill&quot;));</a>
<a name="ln1706">      menuTools-&gt;addAction(getAction(&quot;slash-rhythm&quot;));</a>
<a name="ln1707">      menuTools-&gt;addSeparator();</a>
<a name="ln1708"> </a>
<a name="ln1709">      menuTools-&gt;addAction(getAction(&quot;pitch-spell&quot;));</a>
<a name="ln1710">      menuTools-&gt;addAction(getAction(&quot;reset-groupings&quot;));</a>
<a name="ln1711">      menuTools-&gt;addAction(getAction(&quot;resequence-rehearsal-marks&quot;));</a>
<a name="ln1712">      menuTools-&gt;addAction(getAction(&quot;unroll-repeats&quot;));</a>
<a name="ln1713">      menuTools-&gt;addSeparator();</a>
<a name="ln1714"> </a>
<a name="ln1715">      menuTools-&gt;addAction(getAction(&quot;copy-lyrics-to-clipboard&quot;));</a>
<a name="ln1716">      menuTools-&gt;addAction(getAction(&quot;fotomode&quot;));</a>
<a name="ln1717"> </a>
<a name="ln1718">      menuTools-&gt;addAction(getAction(&quot;del-empty-measures&quot;));</a>
<a name="ln1719"> </a>
<a name="ln1720">      if (MuseScore::unstable()) {</a>
<a name="ln1721">            menuTools-&gt;addSeparator();</a>
<a name="ln1722">            a = getAction(&quot;toggle-script-recorder&quot;);</a>
<a name="ln1723">            a-&gt;setCheckable(true);</a>
<a name="ln1724">            menuTools-&gt;addAction(a);</a>
<a name="ln1725">            }</a>
<a name="ln1726"> </a>
<a name="ln1727">      //---------------------</a>
<a name="ln1728">      //    Menu Plugins</a>
<a name="ln1729">      //---------------------</a>
<a name="ln1730"> </a>
<a name="ln1731">#ifdef SCRIPT_INTERFACE</a>
<a name="ln1732">      menuPlugins = mb-&gt;addMenu(&quot;&quot;);</a>
<a name="ln1733">      menuPlugins-&gt;setObjectName(&quot;Plugins&quot;);</a>
<a name="ln1734"> </a>
<a name="ln1735">      menuPlugins-&gt;addAction(getAction(&quot;plugin-manager&quot;));</a>
<a name="ln1736"> </a>
<a name="ln1737">      a = getAction(&quot;plugin-creator&quot;);</a>
<a name="ln1738">      a-&gt;setCheckable(true);</a>
<a name="ln1739">      menuPlugins-&gt;addAction(a);</a>
<a name="ln1740"> </a>
<a name="ln1741">      menuPlugins-&gt;addSeparator();</a>
<a name="ln1742">#endif</a>
<a name="ln1743"> </a>
<a name="ln1744">      //---------------------</a>
<a name="ln1745">      //    Menu Debug</a>
<a name="ln1746">      //---------------------</a>
<a name="ln1747"> </a>
<a name="ln1748">#ifndef NDEBUG</a>
<a name="ln1749">      menuDebug = mb-&gt;addMenu(&quot;Debug&quot;);</a>
<a name="ln1750">      menuDebug-&gt;setObjectName(&quot;Debug&quot;);</a>
<a name="ln1751">      a = getAction(&quot;no-horizontal-stretch&quot;);</a>
<a name="ln1752">      a-&gt;setCheckable(true);</a>
<a name="ln1753">      menuDebug-&gt;addAction(a);</a>
<a name="ln1754">      a = getAction(&quot;no-vertical-stretch&quot;);</a>
<a name="ln1755">      a-&gt;setCheckable(true);</a>
<a name="ln1756">      menuDebug-&gt;addAction(a);</a>
<a name="ln1757">      menuDebug-&gt;addSeparator();</a>
<a name="ln1758">      a = getAction(&quot;show-segment-shapes&quot;);</a>
<a name="ln1759">      a-&gt;setCheckable(true);</a>
<a name="ln1760">      menuDebug-&gt;addAction(a);</a>
<a name="ln1761">      a = getAction(&quot;show-skylines&quot;);</a>
<a name="ln1762">      a-&gt;setCheckable(true);</a>
<a name="ln1763">      a-&gt;setChecked(MScore::showSkylines);</a>
<a name="ln1764">      menuDebug-&gt;addAction(a);</a>
<a name="ln1765">      a = getAction(&quot;show-bounding-rect&quot;);</a>
<a name="ln1766">      a-&gt;setCheckable(true);</a>
<a name="ln1767">      menuDebug-&gt;addAction(a);</a>
<a name="ln1768">      a = getAction(&quot;show-system-bounding-rect&quot;);</a>
<a name="ln1769">      a-&gt;setCheckable(true);</a>
<a name="ln1770">      menuDebug-&gt;addAction(a);</a>
<a name="ln1771">      a = getAction(&quot;show-corrupted-measures&quot;);</a>
<a name="ln1772">      a-&gt;setCheckable(true);</a>
<a name="ln1773">      a-&gt;setChecked(true);</a>
<a name="ln1774">      menuDebug-&gt;addAction(a);</a>
<a name="ln1775">      a = getAction(&quot;relayout&quot;);</a>
<a name="ln1776">      menuDebug-&gt;addAction(a);</a>
<a name="ln1777">      a = getAction(&quot;qml-reload-source&quot;);</a>
<a name="ln1778">      menuDebug-&gt;addAction(a);</a>
<a name="ln1779">      Workspace::addMenuAndString(menuDebug, &quot;menu-debug&quot;);</a>
<a name="ln1780">#endif</a>
<a name="ln1781"> </a>
<a name="ln1782">      //---------------------</a>
<a name="ln1783">      //    Menu Help</a>
<a name="ln1784">      //---------------------</a>
<a name="ln1785"> </a>
<a name="ln1786">      mb-&gt;addSeparator();</a>
<a name="ln1787">      menuHelp = mb-&gt;addMenu(&quot;&quot;);</a>
<a name="ln1788">      menuHelp-&gt;setObjectName(&quot;Help&quot;);</a>
<a name="ln1789"> </a>
<a name="ln1790">#if 0</a>
<a name="ln1791">      if (_helpEngine) {</a>
<a name="ln1792">            HelpQuery* hw = new HelpQuery(menuHelp);</a>
<a name="ln1793">            menuHelp-&gt;addAction(hw);</a>
<a name="ln1794">            connect(menuHelp, SIGNAL(aboutToShow()), hw, SLOT(setFocus()));</a>
<a name="ln1795">            }</a>
<a name="ln1796">#endif</a>
<a name="ln1797">      //menuHelp-&gt;addAction(getAction(&quot;help&quot;));</a>
<a name="ln1798">      onlineHandbookAction = new QAction(&quot;&quot;, 0);</a>
<a name="ln1799">      connect(onlineHandbookAction, SIGNAL(triggered()), this, SLOT(helpBrowser1()));</a>
<a name="ln1800">      onlineHandbookAction-&gt;setMenuRole(QAction::NoRole);</a>
<a name="ln1801">      menuHelp-&gt;addAction(onlineHandbookAction);</a>
<a name="ln1802">      Workspace::addActionAndString(onlineHandbookAction, &quot;online-handbook&quot;);</a>
<a name="ln1803"> </a>
<a name="ln1804">      menuTours = new QMenu();</a>
<a name="ln1805">      a = getAction(&quot;show-tours&quot;);</a>
<a name="ln1806">      a-&gt;setChecked(preferences.getBool(PREF_UI_APP_STARTUP_SHOWTOURS));</a>
<a name="ln1807">      menuTours-&gt;addAction(a);</a>
<a name="ln1808">      menuTours-&gt;addAction(getAction(&quot;reset-tours&quot;));</a>
<a name="ln1809">      menuHelp-&gt;addMenu(menuTours);</a>
<a name="ln1810"> </a>
<a name="ln1811">      menuHelp-&gt;addSeparator();</a>
<a name="ln1812"> </a>
<a name="ln1813">      aboutAction = new QAction(&quot;&quot;, 0);</a>
<a name="ln1814"> </a>
<a name="ln1815">      aboutAction-&gt;setMenuRole(QAction::AboutRole);</a>
<a name="ln1816">      connect(aboutAction, SIGNAL(triggered()), this, SLOT(about()));</a>
<a name="ln1817">      menuHelp-&gt;addAction(aboutAction);</a>
<a name="ln1818">      Workspace::addActionAndString(aboutAction, &quot;about&quot;);</a>
<a name="ln1819"> </a>
<a name="ln1820">      aboutQtAction = new QAction(&quot;&quot;, 0);</a>
<a name="ln1821">      aboutQtAction-&gt;setMenuRole(QAction::AboutQtRole);</a>
<a name="ln1822">      connect(aboutQtAction, SIGNAL(triggered()), this, SLOT(aboutQt()));</a>
<a name="ln1823">      menuHelp-&gt;addAction(aboutQtAction);</a>
<a name="ln1824">      Workspace::addActionAndString(aboutQtAction, &quot;about-qt&quot;);</a>
<a name="ln1825"> </a>
<a name="ln1826">      aboutMusicXMLAction = new QAction(&quot;&quot;, 0);</a>
<a name="ln1827">      //aboutMusicXMLAction-&gt;setMenuRole(QAction::ApplicationSpecificRole);</a>
<a name="ln1828">      aboutMusicXMLAction-&gt;setMenuRole(QAction::NoRole);</a>
<a name="ln1829">      connect(aboutMusicXMLAction, SIGNAL(triggered()), this, SLOT(aboutMusicXML()));</a>
<a name="ln1830">      menuHelp-&gt;addAction(aboutMusicXMLAction);</a>
<a name="ln1831">      Workspace::addActionAndString(aboutMusicXMLAction, &quot;about-musicxml&quot;);</a>
<a name="ln1832"> </a>
<a name="ln1833">#if defined(Q_OS_MAC) || defined(Q_OS_WIN)</a>
<a name="ln1834">#if !defined(FOR_WINSTORE)</a>
<a name="ln1835">      checkForUpdateAction = new QAction(&quot;&quot;, 0);</a>
<a name="ln1836">      connect(checkForUpdateAction, SIGNAL(triggered()), this, SLOT(checkForUpdatesUI()));</a>
<a name="ln1837">      checkForUpdateAction-&gt;setMenuRole(QAction::NoRole);</a>
<a name="ln1838">      menuHelp-&gt;addAction(checkForUpdateAction);</a>
<a name="ln1839">      Workspace::addActionAndString(checkForUpdateAction, &quot;check-update&quot;);</a>
<a name="ln1840">#endif</a>
<a name="ln1841">#endif</a>
<a name="ln1842">      menuHelp-&gt;addSeparator();</a>
<a name="ln1843"> </a>
<a name="ln1844">      askForHelpAction = new QAction(&quot;&quot;, 0);</a>
<a name="ln1845">      connect(askForHelpAction, SIGNAL(triggered()), this, SLOT(askForHelp()));</a>
<a name="ln1846">      askForHelpAction-&gt;setMenuRole(QAction::NoRole);</a>
<a name="ln1847">      menuHelp-&gt;addAction(askForHelpAction);</a>
<a name="ln1848">      Workspace::addActionAndString(askForHelpAction, &quot;ask-help&quot;);</a>
<a name="ln1849"> </a>
<a name="ln1850">      reportBugAction = new QAction(&quot;&quot;, 0);</a>
<a name="ln1851">      connect(reportBugAction, &amp;QAction::triggered, this, [this]{ reportBug(&quot;menu&quot;); });</a>
<a name="ln1852">      reportBugAction-&gt;setMenuRole(QAction::NoRole);</a>
<a name="ln1853">      menuHelp-&gt;addAction(reportBugAction);</a>
<a name="ln1854">      Workspace::addActionAndString(reportBugAction, &quot;report-bug&quot;);</a>
<a name="ln1855"> </a>
<a name="ln1856">      leaveFeedbackAction = new QAction(&quot;&quot;, 0);</a>
<a name="ln1857">      connect(leaveFeedbackAction, &amp;QAction::triggered, this, [this]{ leaveFeedback(&quot;menu&quot;); });</a>
<a name="ln1858">      leaveFeedbackAction-&gt;setMenuRole(QAction::NoRole);</a>
<a name="ln1859">      menuHelp-&gt;addAction(leaveFeedbackAction);</a>
<a name="ln1860">      Workspace::addActionAndString(leaveFeedbackAction, &quot;leave-feedback&quot;);</a>
<a name="ln1861"> </a>
<a name="ln1862">      menuHelp-&gt;addSeparator();</a>
<a name="ln1863">      menuHelp-&gt;addAction(getAction(&quot;resource-manager&quot;));</a>
<a name="ln1864">      menuHelp-&gt;addSeparator();</a>
<a name="ln1865"> </a>
<a name="ln1866">      revertToFactoryAction = new QAction(&quot;&quot;, 0);</a>
<a name="ln1867">      connect(revertToFactoryAction, SIGNAL(triggered()), this, SLOT(resetAndRestart()));</a>
<a name="ln1868">      revertToFactoryAction-&gt;setMenuRole(QAction::NoRole);</a>
<a name="ln1869">      menuHelp-&gt;addAction(revertToFactoryAction);</a>
<a name="ln1870">      Workspace::addActionAndString(revertToFactoryAction, &quot;revert-factory&quot;);</a>
<a name="ln1871"> </a>
<a name="ln1872">      Workspace::addRemainingFromMenuBar(mb);</a>
<a name="ln1873"> </a>
<a name="ln1874">      // Add all menus to workspace for loading</a>
<a name="ln1875">      Workspace::addMenuAndString(menuFile, &quot;menu-file&quot;);</a>
<a name="ln1876">      Workspace::addMenuAndString(openRecent, &quot;menu-open-recent&quot;);</a>
<a name="ln1877">      Workspace::addMenuAndString(menuEdit, &quot;menu-edit&quot;);</a>
<a name="ln1878">      Workspace::addMenuAndString(menuView, &quot;menu-view&quot;);</a>
<a name="ln1879">      Workspace::addMenuAndString(menuToolbars, &quot;menu-toolbars&quot;);</a>
<a name="ln1880">      Workspace::addMenuAndString(menuWorkspaces, &quot;menu-workspaces&quot;);</a>
<a name="ln1881">      Workspace::addMenuAndString(menuAdd, &quot;menu-add&quot;);</a>
<a name="ln1882">      Workspace::addMenuAndString(menuAddMeasures, &quot;menu-add-measures&quot;);</a>
<a name="ln1883">      Workspace::addMenuAndString(menuAddFrames, &quot;menu-add-frames&quot;);</a>
<a name="ln1884">      Workspace::addMenuAndString(menuAddText, &quot;menu-add-text&quot;);</a>
<a name="ln1885">      Workspace::addMenuAndString(menuAddLines, &quot;menu-add-lines&quot;);</a>
<a name="ln1886">      Workspace::addMenuAndString(menuAddPitch, &quot;menu-add-pitch&quot;);</a>
<a name="ln1887">      Workspace::addMenuAndString(menuAddInterval, &quot;menu-add-interval&quot;);</a>
<a name="ln1888">      Workspace::addMenuAndString(menuTuplet, &quot;menu-tuplet&quot;);</a>
<a name="ln1889">      Workspace::addMenuAndString(menuFormat, &quot;menu-format&quot;);</a>
<a name="ln1890">      Workspace::addMenuAndString(menuTools, &quot;menu-tools&quot;);</a>
<a name="ln1891">      Workspace::addMenuAndString(menuVoices, &quot;menu-voices&quot;);</a>
<a name="ln1892">      Workspace::addMenuAndString(menuMeasure, &quot;menu-measure&quot;);</a>
<a name="ln1893">#ifdef SCRIPT_INTERFACE</a>
<a name="ln1894">      Workspace::addMenuAndString(menuPlugins, &quot;menu-plugins&quot;);</a>
<a name="ln1895">#endif</a>
<a name="ln1896">      Workspace::addMenuAndString(menuHelp, &quot;menu-help&quot;);</a>
<a name="ln1897">      Workspace::addMenuAndString(menuTours, &quot;menu-tours&quot;);</a>
<a name="ln1898"> </a>
<a name="ln1899">      Workspace::writeGlobalMenuBar(mb);</a>
<a name="ln1900"> </a>
<a name="ln1901">      if (!MScore::noGui) {</a>
<a name="ln1902">            retranslate();</a>
<a name="ln1903">            //accessibility for menus</a>
<a name="ln1904">            for (QMenu* menu : mb-&gt;findChildren&lt;QMenu*&gt;()) {</a>
<a name="ln1905">                  menu-&gt;setAccessibleName(menu-&gt;objectName());</a>
<a name="ln1906">                  menu-&gt;setAccessibleDescription(Shortcut::getMenuShortcutString(menu));</a>
<a name="ln1907">                  }</a>
<a name="ln1908">            }</a>
<a name="ln1909"> </a>
<a name="ln1910">      setCentralWidget(envelope);</a>
<a name="ln1911"> </a>
<a name="ln1912">      if (!MScore::noGui)</a>
<a name="ln1913">            preferencesChanged();</a>
<a name="ln1914"> </a>
<a name="ln1915">      if (seq) {</a>
<a name="ln1916">            connect(seq, SIGNAL(started()), SLOT(seqStarted()));</a>
<a name="ln1917">            connect(seq, SIGNAL(stopped()), SLOT(seqStopped()));</a>
<a name="ln1918">            }</a>
<a name="ln1919">      loadScoreList();</a>
<a name="ln1920"> </a>
<a name="ln1921">      QClipboard* cb = QApplication::clipboard();</a>
<a name="ln1922">      connect(cb, SIGNAL(dataChanged()), SLOT(clipboardChanged()));</a>
<a name="ln1923">      connect(cb, SIGNAL(selectionChanged()), SLOT(clipboardChanged()));</a>
<a name="ln1924"> </a>
<a name="ln1925">      autoSaveTimer = new QTimer(this);</a>
<a name="ln1926">      autoSaveTimer-&gt;setSingleShot(true);</a>
<a name="ln1927">      connect(autoSaveTimer, SIGNAL(timeout()), this, SLOT(autoSaveTimerTimeout()));</a>
<a name="ln1928">      initOsc();</a>
<a name="ln1929">      startAutoSave();</a>
<a name="ln1930"> </a>
<a name="ln1931">#ifndef NDEBUG</a>
<a name="ln1932">      // for debugging, but possible may need</a>
<a name="ln1933">      QInputMethod* im = QGuiApplication::inputMethod();</a>
<a name="ln1934">      connect(im, SIGNAL(anchorRectangleChanged()), SLOT(inputMethodAnchorRectangleChanged()));</a>
<a name="ln1935">      connect(im, SIGNAL(animatingChanged()), SLOT(inputMethodAnimatingChanged()));</a>
<a name="ln1936">      connect(im, SIGNAL(cursorRectangleChanged()), SLOT(inputMethodCursorRectangleChanged()));</a>
<a name="ln1937">//signal does not exist:</a>
<a name="ln1938">//      connect(im, SIGNAL(inputDirectionChanged(Qt::LayoutDirection newDirection)), SLOT(inputMethodInputDirectionChanged(Qt::LayoutDirection newDirection)));</a>
<a name="ln1939">      connect(im, SIGNAL(inputItemClipRectangleChanged()), SLOT(inputMethodInputItemClipRectangleChanged()));</a>
<a name="ln1940">      connect(im, SIGNAL(keyboardRectangleChanged()), SLOT(inputMethodKeyboardRectangleChanged()));</a>
<a name="ln1941">      connect(im, SIGNAL(localeChanged()), SLOT(inputMethodLocaleChanged()));</a>
<a name="ln1942">      connect(im, SIGNAL(visibleChanged()), SLOT(inputMethodVisibleChanged()));</a>
<a name="ln1943">#endif</a>
<a name="ln1944"> </a>
<a name="ln1945">      if (enableExperimental) {</a>
<a name="ln1946">            cornerLabel = new QLabel(this);</a>
<a name="ln1947">            cornerLabel-&gt;setScaledContents(true);</a>
<a name="ln1948">            cornerLabel-&gt;setPixmap(QPixmap(&quot;:/data/mscore.png&quot;));</a>
<a name="ln1949">            cornerLabel-&gt;setGeometry(width() - 48, 0, 48, 48);</a>
<a name="ln1950">            }</a>
<a name="ln1951">#if defined(WIN_SPARKLE_ENABLED)</a>
<a name="ln1952">      autoUpdater.reset(new WinSparkleAutoUpdater);</a>
<a name="ln1953">#elif defined(MAC_SPARKLE_ENABLED)</a>
<a name="ln1954">      autoUpdater.reset(new SparkleAutoUpdater);</a>
<a name="ln1955">#endif</a>
<a name="ln1956">      connect(this, SIGNAL(musescoreWindowWasShown()), this, SLOT(checkForUpdates()),</a>
<a name="ln1957">            Qt::ConnectionType(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln1958"> </a>
<a name="ln1959">      if (!converterMode &amp;&amp; !pluginMode)</a>
<a name="ln1960">            _loginManager = new LoginManager(getAction(saveOnlineMenuItem), this);</a>
<a name="ln1961"> </a>
<a name="ln1962">      connect(qApp, &amp;QGuiApplication::focusWindowChanged, this, &amp;MuseScore::onFocusWindowChanged);</a>
<a name="ln1963">      }</a>
<a name="ln1964"> </a>
<a name="ln1965">MuseScore::~MuseScore()</a>
<a name="ln1966">      {</a>
<a name="ln1967">      if (autoUpdater)</a>
<a name="ln1968">            autoUpdater-&gt;cleanup();</a>
<a name="ln1969"> </a>
<a name="ln1970">      delete synti;</a>
<a name="ln1971">      synti = nullptr;</a>
<a name="ln1972"> </a>
<a name="ln1973">      // A crash is possible if paletteWorkspace gets</a>
<a name="ln1974">      // deleted before paletteWidget, so force the widget</a>
<a name="ln1975">      // be deleted before paletteWorkspace.</a>
<a name="ln1976">      delete paletteWidget;</a>
<a name="ln1977">      paletteWidget = nullptr;</a>
<a name="ln1978">      }</a>
<a name="ln1979"> </a>
<a name="ln1980">//---------------------------------------------------------</a>
<a name="ln1981">//   onFocusWindowChanged</a>
<a name="ln1982">//---------------------------------------------------------</a>
<a name="ln1983"> </a>
<a name="ln1984">void MuseScore::onFocusWindowChanged(QWindow* w)</a>
<a name="ln1985">      {</a>
<a name="ln1986">      const QWindow* mscoreWindow = windowHandle();</a>
<a name="ln1987"> </a>
<a name="ln1988">      if (!QApplication::focusWidget() &amp;&amp; _lastFocusWindow</a>
<a name="ln1989">         &amp;&amp; ((!w &amp;&amp; _lastFocusWindow != mscoreWindow) || (w == mscoreWindow &amp;&amp; _lastFocusWindowIsQQuickView))) {</a>
<a name="ln1990">            // Switch to temporary window to work around inability to return focus to QML-based windows</a>
<a name="ln1991">            QWidget* tmpContainer = createWindowContainer(new QWindow, this);</a>
<a name="ln1992">            tmpContainer-&gt;show();</a>
<a name="ln1993">            tmpContainer-&gt;setFocus();</a>
<a name="ln1994"> </a>
<a name="ln1995">            QTimer::singleShot(0, [this, tmpContainer]() {</a>
<a name="ln1996">                  focusScoreView();</a>
<a name="ln1997">                  tmpContainer-&gt;deleteLater();</a>
<a name="ln1998">                  });</a>
<a name="ln1999">            }</a>
<a name="ln2000"> </a>
<a name="ln2001">      _lastFocusWindow = w;</a>
<a name="ln2002">      _lastFocusWindowIsQQuickView = qobject_cast&lt;QQuickView*&gt;(_lastFocusWindow);</a>
<a name="ln2003">      }</a>
<a name="ln2004"> </a>
<a name="ln2005">//---------------------------------------------------------</a>
<a name="ln2006">//   showError</a>
<a name="ln2007">//---------------------------------------------------------</a>
<a name="ln2008"> </a>
<a name="ln2009">void MuseScore::showError()</a>
<a name="ln2010">      {</a>
<a name="ln2011">      static QErrorMessage* msg = 0;</a>
<a name="ln2012">      if (msg == 0)</a>
<a name="ln2013">            msg = new QErrorMessage(this);</a>
<a name="ln2014">      msg-&gt;showMessage(qApp-&gt;translate(&quot;error&quot;, MScore::errorMessage()), MScore::errorGroup());</a>
<a name="ln2015">      MScore::setError(MS_NO_ERROR);</a>
<a name="ln2016">      }</a>
<a name="ln2017"> </a>
<a name="ln2018">//---------------------------------------------------------</a>
<a name="ln2019">//   retranslate</a>
<a name="ln2020">//---------------------------------------------------------</a>
<a name="ln2021"> </a>
<a name="ln2022">void MuseScore::retranslate()</a>
<a name="ln2023">      {</a>
<a name="ln2024">      setMenuTitles();</a>
<a name="ln2025">      _positionLabel-&gt;setToolTip(tr(&quot;Measure:Beat:Tick&quot;));</a>
<a name="ln2026">      pref-&gt;setText(tr(&quot;&amp;Preferences…&quot;));</a>
<a name="ln2027">      aboutAction-&gt;setText(tr(&quot;&amp;About…&quot;));</a>
<a name="ln2028">      aboutQtAction-&gt;setText(tr(&quot;About &amp;Qt…&quot;));</a>
<a name="ln2029">      aboutMusicXMLAction-&gt;setText(tr(&quot;About &amp;MusicXML…&quot;));</a>
<a name="ln2030">      onlineHandbookAction-&gt;setText(tr(&quot;&amp;Online Handbook&quot;));</a>
<a name="ln2031">      if (checkForUpdateAction)</a>
<a name="ln2032">            checkForUpdateAction-&gt;setText(tr(&quot;Check for &amp;Update&quot;));</a>
<a name="ln2033">      askForHelpAction-&gt;setText(tr(&quot;Ask for Help&quot;));</a>
<a name="ln2034">      reportBugAction-&gt;setText(tr(&quot;Report a Bug&quot;));</a>
<a name="ln2035">      leaveFeedbackAction-&gt;setText(tr(&quot;Feedback&quot;));</a>
<a name="ln2036">      revertToFactoryAction-&gt;setText(tr(&quot;Revert to Factory Settings&quot;));</a>
<a name="ln2037"> </a>
<a name="ln2038">      fileTools-&gt;setWindowTitle(tr(&quot;File Operations&quot;));</a>
<a name="ln2039">      transportTools-&gt;setWindowTitle(tr(&quot;Playback Controls&quot;));</a>
<a name="ln2040">      cpitchTools-&gt;setWindowTitle(tr(&quot;Concert Pitch&quot;));</a>
<a name="ln2041">      fotoTools-&gt;setWindowTitle(tr(&quot;Image Capture&quot;));</a>
<a name="ln2042">      entryTools-&gt;setWindowTitle(tr(&quot;Note Input&quot;));</a>
<a name="ln2043">      feedbackTools-&gt;setWindowTitle(tr(&quot;Feedback&quot;));</a>
<a name="ln2044">      workspacesTools-&gt;setWindowTitle(tr(&quot;Workspaces&quot;));</a>
<a name="ln2045"> </a>
<a name="ln2046">      viewModeCombo-&gt;setAccessibleName(tr(&quot;View Mode&quot;));</a>
<a name="ln2047">      viewModeCombo-&gt;setItemText(viewModeCombo-&gt;findData(int(LayoutMode::PAGE)), tr(&quot;Page View&quot;));</a>
<a name="ln2048">      viewModeCombo-&gt;setItemText(viewModeCombo-&gt;findData(int(LayoutMode::LINE)), tr(&quot;Continuous View&quot;));</a>
<a name="ln2049">      viewModeCombo-&gt;setItemText(viewModeCombo-&gt;findData(int(LayoutMode::SYSTEM)), tr(&quot;Single Page&quot;));</a>
<a name="ln2050"> </a>
<a name="ln2051">      showMidiImportButton-&gt;setText(tr(&quot;Show MIDI import panel&quot;));</a>
<a name="ln2052"> </a>
<a name="ln2053">      Shortcut::retranslate();</a>
<a name="ln2054">      WorkspacesManager::retranslateAll();</a>
<a name="ln2055"> </a>
<a name="ln2056">      if (paletteWorkspace)</a>
<a name="ln2057">          paletteWorkspace-&gt;retranslate();</a>
<a name="ln2058">      }</a>
<a name="ln2059">      </a>
<a name="ln2060">//---------------------------------------------------------</a>
<a name="ln2061">//   setMenuTitles</a>
<a name="ln2062">//---------------------------------------------------------</a>
<a name="ln2063"> </a>
<a name="ln2064">void MuseScore::setMenuTitles()</a>
<a name="ln2065">      {</a>
<a name="ln2066">      // The list below is not static, both strings</a>
<a name="ln2067">      // and menu pointers need refreshing.</a>
<a name="ln2068">      const std::initializer_list&lt;std::pair&lt;QMenu*, QString&gt;&gt; titles {</a>
<a name="ln2069">            { menuFile,             tr(&quot;&amp;File&quot;)             },</a>
<a name="ln2070">            { openRecent,           tr(&quot;Open &amp;Recent&quot;)      },</a>
<a name="ln2071">            { menuEdit,             tr(&quot;&amp;Edit&quot;)             },</a>
<a name="ln2072">            { menuView,             tr(&quot;&amp;View&quot;)             },</a>
<a name="ln2073">            { menuToolbars,         tr(&quot;&amp;Toolbars&quot;)         },</a>
<a name="ln2074">            { menuWorkspaces,       tr(&quot;W&amp;orkspaces&quot;)       },</a>
<a name="ln2075">            { menuAdd,              tr(&quot;&amp;Add&quot;)              },</a>
<a name="ln2076">            { menuAddMeasures,      tr(&quot;&amp;Measures&quot;)         },</a>
<a name="ln2077">            { menuAddFrames,        tr(&quot;&amp;Frames&quot;)           },</a>
<a name="ln2078">            { menuAddText,          tr(&quot;&amp;Text&quot;)             },</a>
<a name="ln2079">            { menuAddLines,         tr(&quot;&amp;Lines&quot;)            },</a>
<a name="ln2080">            { menuAddPitch,         tr(&quot;N&amp;otes&quot;)            },</a>
<a name="ln2081">            { menuAddInterval,      tr(&quot;&amp;Intervals&quot;)        },</a>
<a name="ln2082">            { menuTuplet,           tr(&quot;T&amp;uplets&quot;)          },</a>
<a name="ln2083">            { menuFormat,           tr(&quot;F&amp;ormat&quot;)           },</a>
<a name="ln2084">            { menuStretch,          tr(&quot;&amp;Stretch&quot;)          },</a>
<a name="ln2085">            { menuTools,            tr(&quot;&amp;Tools&quot;)            },</a>
<a name="ln2086">            { menuVoices,           tr(&quot;&amp;Voices&quot;)           },</a>
<a name="ln2087">            { menuMeasure,          tr(&quot;&amp;Measure&quot;)          },</a>
<a name="ln2088">#ifdef SCRIPT_INTERFACE</a>
<a name="ln2089">            { menuPlugins,          tr(&quot;&amp;Plugins&quot;)          },</a>
<a name="ln2090">#endif</a>
<a name="ln2091">#ifndef NDEBUG</a>
<a name="ln2092">            { menuDebug,            &quot;Debug&quot;                 }, // not translated</a>
<a name="ln2093">#endif</a>
<a name="ln2094">            { menuHelp,             tr(&quot;&amp;Help&quot;)             },</a>
<a name="ln2095">            { menuTours,            tr(&quot;&amp;Tours&quot;)            }</a>
<a name="ln2096">            };</a>
<a name="ln2097"> </a>
<a name="ln2098">      for (const auto&amp; t : titles) {</a>
<a name="ln2099">            QMenu* m = t.first;</a>
<a name="ln2100">            if (m)</a>
<a name="ln2101">                  m-&gt;setTitle(t.second);</a>
<a name="ln2102">            }</a>
<a name="ln2103">      }</a>
<a name="ln2104"> </a>
<a name="ln2105">//---------------------------------------------------------</a>
<a name="ln2106">//   updateMenu</a>
<a name="ln2107">//---------------------------------------------------------</a>
<a name="ln2108"> </a>
<a name="ln2109">void MuseScore::updateMenu(QMenu*&amp; menu, QString menu_id, QString name)</a>
<a name="ln2110">      {</a>
<a name="ln2111">      menu = Workspace::findMenuFromString(menu_id);</a>
<a name="ln2112">      if (menu) {</a>
<a name="ln2113">            if (name != &quot;&quot;)</a>
<a name="ln2114">                  menu-&gt;setObjectName(name);</a>
<a name="ln2115">            }</a>
<a name="ln2116">      }</a>
<a name="ln2117"> </a>
<a name="ln2118">//---------------------------------------------------------</a>
<a name="ln2119">//   updateMenus</a>
<a name="ln2120">//---------------------------------------------------------</a>
<a name="ln2121"> </a>
<a name="ln2122">void MuseScore::updateMenus()</a>
<a name="ln2123">      {</a>
<a name="ln2124">      updateMenu(menuFile,        &quot;menu-file&quot;,         &quot;File&quot;);</a>
<a name="ln2125">      updateMenu(openRecent,      &quot;menu-open-recent&quot;,  &quot;&quot;);</a>
<a name="ln2126">      updateMenu(menuEdit,        &quot;menu-edit&quot;,         &quot;Edit&quot;);</a>
<a name="ln2127">      updateMenu(menuView,        &quot;menu-view&quot;,         &quot;View&quot;);</a>
<a name="ln2128">      updateMenu(menuToolbars,    &quot;menu-toolbars&quot;,     &quot;&quot;);</a>
<a name="ln2129">      updateMenu(menuWorkspaces,  &quot;menu-workspaces&quot;,   &quot;&quot;);</a>
<a name="ln2130">      updateMenu(menuAdd,         &quot;menu-add&quot;,          &quot;Add&quot;);</a>
<a name="ln2131">      updateMenu(menuAddMeasures, &quot;menu-add-measures&quot;, &quot;&quot;);</a>
<a name="ln2132">      updateMenu(menuAddFrames,   &quot;menu-add-frames&quot;,   &quot;&quot;);</a>
<a name="ln2133">      updateMenu(menuAddText,     &quot;menu-add-text&quot;,     &quot;&quot;);</a>
<a name="ln2134">      updateMenu(menuAddLines,    &quot;menu-add-lines&quot;,    &quot;&quot;);</a>
<a name="ln2135">      updateMenu(menuAddPitch,    &quot;menu-add-pitch&quot;,    &quot;&quot;);</a>
<a name="ln2136">      updateMenu(menuAddInterval, &quot;menu-add-interval&quot;, &quot;&quot;);</a>
<a name="ln2137">      updateMenu(menuTuplet,      &quot;menu-tuplet&quot;,       &quot;&quot;);</a>
<a name="ln2138">      updateMenu(menuFormat,      &quot;menu-format&quot;,       &quot;Format&quot;);</a>
<a name="ln2139">      updateMenu(menuStretch,     &quot;menu-stretch&quot;,      &quot;&quot;);</a>
<a name="ln2140">      updateMenu(menuTools,       &quot;menu-tools&quot;,        &quot;Tools&quot;);</a>
<a name="ln2141">      updateMenu(menuVoices,      &quot;menu-voices&quot;,       &quot;&quot;);</a>
<a name="ln2142">      updateMenu(menuMeasure,     &quot;menu-measure&quot;,      &quot;&quot;);</a>
<a name="ln2143">#ifdef SCRIPT_INTERFACE</a>
<a name="ln2144">      updateMenu(menuPlugins,     &quot;menu-plugins&quot;,      &quot;Plugins&quot;);</a>
<a name="ln2145">#endif</a>
<a name="ln2146">      updateMenu(menuHelp,        &quot;menu-help&quot;,         &quot;Help&quot;);</a>
<a name="ln2147">      updateMenu(menuTours,       &quot;menu-tours&quot;,        &quot;&quot;);</a>
<a name="ln2148">#ifndef NDEBUG</a>
<a name="ln2149">      updateMenu(menuDebug,       &quot;menu-debug&quot;,        &quot;Debug&quot;);</a>
<a name="ln2150">#endif</a>
<a name="ln2151">      connect(openRecent,     SIGNAL(aboutToShow()),       SLOT(openRecentMenu()));</a>
<a name="ln2152">      connect(openRecent,     SIGNAL(triggered(QAction*)), SLOT(selectScore(QAction*)));</a>
<a name="ln2153">      connect(menuWorkspaces, SIGNAL(aboutToShow()),       SLOT(showWorkspaceMenu()));</a>
<a name="ln2154">      setMenuTitles();</a>
<a name="ln2155">#ifdef SCRIPT_INTERFACE</a>
<a name="ln2156">      addPluginMenuEntries();</a>
<a name="ln2157">#endif</a>
<a name="ln2158">      }</a>
<a name="ln2159">      </a>
<a name="ln2160">//---------------------------------------------------------</a>
<a name="ln2161">//   resizeEvent</a>
<a name="ln2162">//---------------------------------------------------------</a>
<a name="ln2163"> </a>
<a name="ln2164">void MuseScore::resizeEvent(QResizeEvent*)</a>
<a name="ln2165">      {</a>
<a name="ln2166">      if (enableExperimental) {</a>
<a name="ln2167">            cornerLabel-&gt;setGeometry(width() - 48, 0, 48, 48);</a>
<a name="ln2168">            }</a>
<a name="ln2169">      }</a>
<a name="ln2170"> </a>
<a name="ln2171">//---------------------------------------------------------</a>
<a name="ln2172">//   startAutoSave</a>
<a name="ln2173">//---------------------------------------------------------</a>
<a name="ln2174"> </a>
<a name="ln2175">void MuseScore::startAutoSave()</a>
<a name="ln2176">      {</a>
<a name="ln2177">      if (preferences.getBool(PREF_APP_AUTOSAVE_USEAUTOSAVE)) {</a>
<a name="ln2178">            int t = preferences.getInt(PREF_APP_AUTOSAVE_AUTOSAVETIME) * 60 * 1000;</a>
<a name="ln2179">            autoSaveTimer-&gt;start(t);</a>
<a name="ln2180">            }</a>
<a name="ln2181">      else</a>
<a name="ln2182">            autoSaveTimer-&gt;stop();</a>
<a name="ln2183">      }</a>
<a name="ln2184"> </a>
<a name="ln2185">//---------------------------------------------------------</a>
<a name="ln2186">//   getLocaleISOCode</a>
<a name="ln2187">//---------------------------------------------------------</a>
<a name="ln2188"> </a>
<a name="ln2189">QString MuseScore::getLocaleISOCode() const</a>
<a name="ln2190">      {</a>
<a name="ln2191">      QString lang;</a>
<a name="ln2192">      if (localeName.toLower() == &quot;system&quot;)</a>
<a name="ln2193">            lang = QLocale::system().name();</a>
<a name="ln2194">      else</a>
<a name="ln2195">            lang = localeName;</a>
<a name="ln2196">      return lang;</a>
<a name="ln2197">      }</a>
<a name="ln2198"> </a>
<a name="ln2199">//---------------------------------------------------------</a>
<a name="ln2200">//   helpBrowser1</a>
<a name="ln2201">//    show online help</a>
<a name="ln2202">//---------------------------------------------------------</a>
<a name="ln2203"> </a>
<a name="ln2204">void MuseScore::helpBrowser1() const</a>
<a name="ln2205">      {</a>
<a name="ln2206">      QString lang = getLocaleISOCode();</a>
<a name="ln2207"> </a>
<a name="ln2208">      if (MScore::debugMode)</a>
<a name="ln2209">            qDebug(&quot;open online handbook for language &lt;%s&gt;&quot;, qPrintable(lang));</a>
<a name="ln2210">      QString help = QString(&quot;https://musescore.org/redirect/help?tag=handbook&amp;locale=%1&quot;).arg(getLocaleISOCode());</a>
<a name="ln2211">      //try to find an exact match</a>
<a name="ln2212">      bool found = false;</a>
<a name="ln2213">      foreach (LanguageItem item, _languages) {</a>
<a name="ln2214">            if (item.key == lang) {</a>
<a name="ln2215">                  QString handbook = item.handbook;</a>
<a name="ln2216">                  if (!handbook.isNull()) {</a>
<a name="ln2217">                      help = item.handbook;</a>
<a name="ln2218">                      found = true;</a>
<a name="ln2219">                      }</a>
<a name="ln2220">                  break;</a>
<a name="ln2221">                  }</a>
<a name="ln2222">            }</a>
<a name="ln2223">      //try a to find a match on first two letters</a>
<a name="ln2224">      if (!found &amp;&amp; lang.size() &gt; 2) {</a>
<a name="ln2225">            lang = lang.left(2);</a>
<a name="ln2226">            foreach (LanguageItem item, _languages) {</a>
<a name="ln2227">                  if (item.key == lang){</a>
<a name="ln2228">                      QString handbook = item.handbook;</a>
<a name="ln2229">                      if (!handbook.isNull())</a>
<a name="ln2230">                          help = item.handbook;</a>
<a name="ln2231">                      break;</a>
<a name="ln2232">                      }</a>
<a name="ln2233">                  }</a>
<a name="ln2234">            }</a>
<a name="ln2235"> </a>
<a name="ln2236">      //track visits. see: http://www.google.com/support/googleanalytics/bin/answer.py?answer=55578</a>
<a name="ln2237">      help += '&amp;';</a>
<a name="ln2238">      help += getUtmParameters(&quot;menu&quot;);</a>
<a name="ln2239">      QDesktopServices::openUrl(QUrl(help));</a>
<a name="ln2240">      }</a>
<a name="ln2241"> </a>
<a name="ln2242">//---------------------------------------------------------</a>
<a name="ln2243">//   resetAndRestart</a>
<a name="ln2244">//---------------------------------------------------------</a>
<a name="ln2245"> </a>
<a name="ln2246">void MuseScore::resetAndRestart()</a>
<a name="ln2247">      {</a>
<a name="ln2248">      int ret = QMessageBox::question(0, tr(&quot;Are you sure?&quot;),</a>
<a name="ln2249">                  tr(&quot;This will reset all your preferences.\n&quot;</a>
<a name="ln2250">                   &quot;Custom palettes, custom shortcuts, and the list of recent scores will be deleted. &quot;</a>
<a name="ln2251">                   &quot;MuseScore will restart with its default settings.\n&quot;</a>
<a name="ln2252">                   &quot;Reverting will not remove any scores from your computer.\n&quot;</a>
<a name="ln2253">                   &quot;Are you sure you want to proceed?&quot;),</a>
<a name="ln2254">                   QMessageBox::Yes|QMessageBox::No, QMessageBox::No);</a>
<a name="ln2255">      if (ret == QMessageBox::Yes ) {</a>
<a name="ln2256">             close();</a>
<a name="ln2257">             QStringList args(&quot;-F&quot;);</a>
<a name="ln2258">             QProcess::startDetached(qApp-&gt;arguments()[0], args);</a>
<a name="ln2259">             }</a>
<a name="ln2260">      }</a>
<a name="ln2261"> </a>
<a name="ln2262">//---------------------------------------------------------</a>
<a name="ln2263">//   aboutQt</a>
<a name="ln2264">//---------------------------------------------------------</a>
<a name="ln2265"> </a>
<a name="ln2266">void MuseScore::aboutQt()</a>
<a name="ln2267">      {</a>
<a name="ln2268">      QMessageBox::aboutQt(this, QString(&quot;About Qt&quot;));</a>
<a name="ln2269">      }</a>
<a name="ln2270"> </a>
<a name="ln2271">//---------------------------------------------------------</a>
<a name="ln2272">//   aboutMusicXML</a>
<a name="ln2273">//---------------------------------------------------------</a>
<a name="ln2274"> </a>
<a name="ln2275">void MuseScore::aboutMusicXML()</a>
<a name="ln2276">      {</a>
<a name="ln2277">      AboutMusicXMLBoxDialog ab;</a>
<a name="ln2278">      ab.show();</a>
<a name="ln2279">      ab.exec();</a>
<a name="ln2280">      }</a>
<a name="ln2281"> </a>
<a name="ln2282">//---------------------------------------------------------</a>
<a name="ln2283">//   selectScore</a>
<a name="ln2284">//    &quot;open recent&quot;</a>
<a name="ln2285">//---------------------------------------------------------</a>
<a name="ln2286"> </a>
<a name="ln2287">void MuseScore::selectScore(QAction* action)</a>
<a name="ln2288">      {</a>
<a name="ln2289">      QVariant actionData = action-&gt;data();</a>
<a name="ln2290"> </a>
<a name="ln2291">      if (!actionData.isValid())</a>
<a name="ln2292">            return;</a>
<a name="ln2293"> </a>
<a name="ln2294">      switch (actionData.type()) {</a>
<a name="ln2295">            case QVariant::String: {</a>
<a name="ln2296">                  if (actionData.toString() == &quot;clear-recent&quot;) {</a>
<a name="ln2297">                        _recentScores.clear();</a>
<a name="ln2298"> </a>
<a name="ln2299">                        if (startcenter)</a>
<a name="ln2300">                              startcenter-&gt;updateRecentScores();</a>
<a name="ln2301">                        }</a>
<a name="ln2302">                  break;</a>
<a name="ln2303">                  }</a>
<a name="ln2304">            case QVariant::Map: {</a>
<a name="ln2305">                  QVariantMap pathMap = actionData.toMap();</a>
<a name="ln2306"> </a>
<a name="ln2307">                  MasterScore* score = readScore(pathMap.value(&quot;filePath&quot;).toString());</a>
<a name="ln2308">                  if (score) {</a>
<a name="ln2309">                        setCurrentScoreView(appendScore(score));</a>
<a name="ln2310">                        addRecentScore(score);</a>
<a name="ln2311">                        writeSessionFile(false);</a>
<a name="ln2312">                        }</a>
<a name="ln2313">                  break;</a>
<a name="ln2314">                  }</a>
<a name="ln2315">            default:</a>
<a name="ln2316">                  return;</a>
<a name="ln2317">            }</a>
<a name="ln2318">      }</a>
<a name="ln2319"> </a>
<a name="ln2320">//---------------------------------------------------------</a>
<a name="ln2321">//   selectionChanged</a>
<a name="ln2322">//---------------------------------------------------------</a>
<a name="ln2323"> </a>
<a name="ln2324">void MuseScore::selectionChanged(SelState selectionState)</a>
<a name="ln2325">      {</a>
<a name="ln2326">      bool enable = selectionState != SelState::NONE;</a>
<a name="ln2327">      getAction(&quot;cut&quot;)-&gt;setEnabled(enable);</a>
<a name="ln2328">      getAction(&quot;copy&quot;)-&gt;setEnabled(enable);</a>
<a name="ln2329">      getAction(&quot;select-similar-range&quot;)-&gt;setEnabled(selectionState == SelState::RANGE);</a>
<a name="ln2330">      if (pianorollEditor)</a>
<a name="ln2331">            pianorollEditor-&gt;changeSelection(selectionState);</a>
<a name="ln2332">      if (drumrollEditor)</a>
<a name="ln2333">            drumrollEditor-&gt;changeSelection(selectionState);</a>
<a name="ln2334">      if (timeline())</a>
<a name="ln2335">            timeline()-&gt;changeSelection(selectionState);</a>
<a name="ln2336">      if (_pianoTools &amp;&amp; _pianoTools-&gt;isVisible()) {</a>
<a name="ln2337">            if (cs)</a>
<a name="ln2338">                  _pianoTools-&gt;changeSelection(cs-&gt;selection());</a>
<a name="ln2339">            else</a>
<a name="ln2340">                  _pianoTools-&gt;clearSelection();</a>
<a name="ln2341">            }</a>
<a name="ln2342">      if (_inspector)</a>
<a name="ln2343">            updateInspector();</a>
<a name="ln2344">      }</a>
<a name="ln2345"> </a>
<a name="ln2346">//---------------------------------------------------------</a>
<a name="ln2347">//   updatePaletteBeamMode</a>
<a name="ln2348">//</a>
<a name="ln2349">//   Updates the selected index of the Beam Properties</a>
<a name="ln2350">//   palette to reflect the beam mode of the selected</a>
<a name="ln2351">//   chord rest</a>
<a name="ln2352">//---------------------------------------------------------</a>
<a name="ln2353"> </a>
<a name="ln2354">void MuseScore::updatePaletteBeamMode()</a>
<a name="ln2355">      {</a>
<a name="ln2356">      if (paletteWorkspace &amp;&amp; cs)</a>
<a name="ln2357">            paletteWorkspace-&gt;updateCellsState(cs-&gt;selection());</a>
<a name="ln2358">      }</a>
<a name="ln2359"> </a>
<a name="ln2360">//---------------------------------------------------------</a>
<a name="ln2361">//   updateInspector</a>
<a name="ln2362">//---------------------------------------------------------</a>
<a name="ln2363"> </a>
<a name="ln2364">void MuseScore::updateInspector()</a>
<a name="ln2365">      {</a>
<a name="ln2366">      // skip update if no inspector, or if inspector is hidden and there is a GUI</a>
<a name="ln2367">      // (important not to skip when running test scripts)</a>
<a name="ln2368">      if (_inspector &amp;&amp; (_inspector-&gt;isVisible() || MScore::testMode || scriptTestMode))</a>
<a name="ln2369">            _inspector-&gt;update(cs);</a>
<a name="ln2370">      }</a>
<a name="ln2371"> </a>
<a name="ln2372">//---------------------------------------------------------</a>
<a name="ln2373">//   updateShadowNote</a>
<a name="ln2374">//   update the shadow note in the current ScoreView</a>
<a name="ln2375">//---------------------------------------------------------</a>
<a name="ln2376"> </a>
<a name="ln2377">void MuseScore::updateShadowNote()</a>
<a name="ln2378">      {</a>
<a name="ln2379">      currentScoreView()-&gt;updateShadowNotes();</a>
<a name="ln2380">      }</a>
<a name="ln2381"> </a>
<a name="ln2382">//---------------------------------------------------------</a>
<a name="ln2383">//   appendScore</a>
<a name="ln2384">//    append score to project list</a>
<a name="ln2385">//---------------------------------------------------------</a>
<a name="ln2386"> </a>
<a name="ln2387">int MuseScore::appendScore(MasterScore* score)</a>
<a name="ln2388">      {</a>
<a name="ln2389">      int index = scoreList.size();</a>
<a name="ln2390">      for (int i = 0; i &lt; scoreList.size(); ++i) {</a>
<a name="ln2391">            if ((!score-&gt;importedFilePath().isEmpty()</a>
<a name="ln2392">                 &amp;&amp; scoreList[i]-&gt;importedFilePath() == score-&gt;importedFilePath())</a>
<a name="ln2393">                    || (scoreList[i]-&gt;fileInfo()-&gt;canonicalFilePath() == score-&gt;fileInfo()-&gt;canonicalFilePath() &amp;&amp; score-&gt;fileInfo()-&gt;exists())) {</a>
<a name="ln2394">                  removeTab(i);</a>
<a name="ln2395">                  index = i;</a>
<a name="ln2396">                  break;</a>
<a name="ln2397">                  }</a>
<a name="ln2398">            }</a>
<a name="ln2399">      scoreList.insert(index, score);</a>
<a name="ln2400">      scoreWasShown[score] = false;</a>
<a name="ln2401">      tab1-&gt;insertTab(score);</a>
<a name="ln2402">      if (tab2)</a>
<a name="ln2403">            tab2-&gt;insertTab(score);</a>
<a name="ln2404">      return index;</a>
<a name="ln2405">      }</a>
<a name="ln2406"> </a>
<a name="ln2407">//---------------------------------------------------------</a>
<a name="ln2408">//   addRecentScore</a>
<a name="ln2409">//---------------------------------------------------------</a>
<a name="ln2410"> </a>
<a name="ln2411">void MuseScore::addRecentScore(Score* score)</a>
<a name="ln2412">      {</a>
<a name="ln2413">      QString path = score-&gt;importedFilePath(); // defined for scores imported from e.g. MIDI files</a>
<a name="ln2414">      addRecentScore(path);</a>
<a name="ln2415">      path = score-&gt;masterScore()-&gt;fileInfo()-&gt;absoluteFilePath();</a>
<a name="ln2416">      addRecentScore(path);</a>
<a name="ln2417">      if (startcenter)</a>
<a name="ln2418">            startcenter-&gt;updateRecentScores();</a>
<a name="ln2419">      }</a>
<a name="ln2420"> </a>
<a name="ln2421">void MuseScore::addRecentScore(const QString&amp; scorePath)</a>
<a name="ln2422">      {</a>
<a name="ln2423">      if (scorePath.isEmpty())</a>
<a name="ln2424">            return;</a>
<a name="ln2425">      QFileInfo fi(scorePath);</a>
<a name="ln2426">      QString absoluteFilePath = fi.absoluteFilePath();</a>
<a name="ln2427">      _recentScores.removeAll(absoluteFilePath);</a>
<a name="ln2428">      _recentScores.prepend(absoluteFilePath);</a>
<a name="ln2429">      if (_recentScores.size() &gt; RECENT_LIST_SIZE)</a>
<a name="ln2430">            _recentScores.removeLast();</a>
<a name="ln2431">      }</a>
<a name="ln2432"> </a>
<a name="ln2433">#if 0</a>
<a name="ln2434">//---------------------------------------------------------</a>
<a name="ln2435">//   updateTabNames</a>
<a name="ln2436">//---------------------------------------------------------</a>
<a name="ln2437"> </a>
<a name="ln2438">void MuseScore::updateTabNames()</a>
<a name="ln2439">      {</a>
<a name="ln2440">      for (int i = 0; i &lt; tab1-&gt;count(); ++i) {</a>
<a name="ln2441">            ScoreView* view = tab1-&gt;view(i);</a>
<a name="ln2442">            if (view)</a>
<a name="ln2443">                  tab1-&gt;setTabText(i, view-&gt;score()-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName());</a>
<a name="ln2444">            }</a>
<a name="ln2445">      if (tab2) {</a>
<a name="ln2446">            for (int i = 0; i &lt; tab2-&gt;count(); ++i) {</a>
<a name="ln2447">                  ScoreView* view = tab2-&gt;view(i);</a>
<a name="ln2448">                  if (view)</a>
<a name="ln2449">                        tab2-&gt;setTabText(i, view-&gt;score()-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName());</a>
<a name="ln2450">                  }</a>
<a name="ln2451">            }</a>
<a name="ln2452">      }</a>
<a name="ln2453">#endif</a>
<a name="ln2454"> </a>
<a name="ln2455">//---------------------------------------------------------</a>
<a name="ln2456">//   loadScoreList</a>
<a name="ln2457">//    read list of &quot;Recent Scores&quot;</a>
<a name="ln2458">//---------------------------------------------------------</a>
<a name="ln2459"> </a>
<a name="ln2460">void MuseScore::loadScoreList()</a>
<a name="ln2461">      {</a>
<a name="ln2462">      if (useFactorySettings)</a>
<a name="ln2463">            return;</a>
<a name="ln2464">      QSettings s;</a>
<a name="ln2465">      for (int i = RECENT_LIST_SIZE-1; i &gt;= 0; --i) {</a>
<a name="ln2466">            QString path = s.value(QString(&quot;recent-%1&quot;).arg(i),&quot;&quot;).toString();</a>
<a name="ln2467">            if (!path.isEmpty() &amp;&amp; QFileInfo(path).exists()) {</a>
<a name="ln2468">                  _recentScores.removeAll(path);</a>
<a name="ln2469">                  _recentScores.prepend(path);</a>
<a name="ln2470">                  }</a>
<a name="ln2471">            }</a>
<a name="ln2472">      }</a>
<a name="ln2473"> </a>
<a name="ln2474">//---------------------------------------------------------</a>
<a name="ln2475">//   openRecentMenu</a>
<a name="ln2476">//---------------------------------------------------------</a>
<a name="ln2477"> </a>
<a name="ln2478">void MuseScore::openRecentMenu()</a>
<a name="ln2479">      {</a>
<a name="ln2480">      openRecent-&gt;clear();</a>
<a name="ln2481">      bool one = false;</a>
<a name="ln2482">      for (const QFileInfo&amp; fi : recentScores()) {</a>
<a name="ln2483">            QAction* action = openRecent-&gt;addAction(fi.fileName().replace(&quot;&amp;&quot;, &quot;&amp;&amp;&quot;));  // show filename only</a>
<a name="ln2484"> </a>
<a name="ln2485">            QString filePath = fi.canonicalFilePath();</a>
<a name="ln2486"> </a>
<a name="ln2487">            QVariantMap actionData;</a>
<a name="ln2488">            actionData.insert(&quot;actionName&quot;, &quot;open-recent&quot;);</a>
<a name="ln2489">            actionData.insert(&quot;filePath&quot;, filePath);</a>
<a name="ln2490"> </a>
<a name="ln2491">            action-&gt;setData(actionData);</a>
<a name="ln2492">            action-&gt;setToolTip(filePath);</a>
<a name="ln2493">            one = true;</a>
<a name="ln2494">            }</a>
<a name="ln2495">      if (one) {</a>
<a name="ln2496">            openRecent-&gt;addSeparator();</a>
<a name="ln2497">            QAction* action = openRecent-&gt;addAction(tr(&quot;Clear Recent Files&quot;));</a>
<a name="ln2498">            action-&gt;setData(&quot;clear-recent&quot;);</a>
<a name="ln2499">            }</a>
<a name="ln2500">      }</a>
<a name="ln2501"> </a>
<a name="ln2502">//---------------------------------------------------------</a>
<a name="ln2503">//   reloadInstrumentTemplates</a>
<a name="ln2504">//---------------------------------------------------------</a>
<a name="ln2505"> </a>
<a name="ln2506">void MuseScore::reloadInstrumentTemplates()</a>
<a name="ln2507">      {</a>
<a name="ln2508">      clearInstrumentTemplates();</a>
<a name="ln2509">      // load cascading instrument templates</a>
<a name="ln2510">      loadInstrumentTemplates(preferences.getString(PREF_APP_PATHS_INSTRUMENTLIST1));</a>
<a name="ln2511">      QString list2 = preferences.getString(PREF_APP_PATHS_INSTRUMENTLIST2);</a>
<a name="ln2512">      if (!list2.isEmpty())</a>
<a name="ln2513">            loadInstrumentTemplates(list2);</a>
<a name="ln2514"> </a>
<a name="ln2515">      // load instrument templates from extension</a>
<a name="ln2516">      QStringList extensionDir = Extension::getDirectoriesByType(Extension::instrumentsDir);</a>
<a name="ln2517">      QStringList filter(&quot;*.xml&quot;);</a>
<a name="ln2518">      for (QString s : extensionDir) {</a>
<a name="ln2519">            QDir extDir(s);</a>
<a name="ln2520">            extDir.setNameFilters(filter);</a>
<a name="ln2521">            auto instFiles = extDir.entryInfoList(QDir::Files | QDir::NoSymLinks | QDir::Readable);</a>
<a name="ln2522">            for (auto instFile : instFiles)</a>
<a name="ln2523">                  loadInstrumentTemplates(instFile.absoluteFilePath());</a>
<a name="ln2524">            }</a>
<a name="ln2525"> </a>
<a name="ln2526">      MidiInstr::instrumentTemplatesChanged();</a>
<a name="ln2527">      if (importmidiPanel)</a>
<a name="ln2528">            importmidiPanel-&gt;instrumentTemplatesChanged();</a>
<a name="ln2529">      }</a>
<a name="ln2530"> </a>
<a name="ln2531">//---------------------------------------------------------</a>
<a name="ln2532">//   askResetOldScorePositions</a>
<a name="ln2533">//---------------------------------------------------------</a>
<a name="ln2534"> </a>
<a name="ln2535">void MuseScore::askResetOldScorePositions(Score* score)</a>
<a name="ln2536">      {</a>
<a name="ln2537">      if (score-&gt;mscVersion() &lt; 300) {</a>
<a name="ln2538">            QString resPref = preferences.getString(PREF_IMPORT_COMPATIBILITY_RESET_ELEMENT_POSITIONS);</a>
<a name="ln2539">            if (resPref == &quot;No&quot;)</a>
<a name="ln2540">                  return;</a>
<a name="ln2541">            else if (resPref == &quot;Yes&quot;)</a>
<a name="ln2542">                  score-&gt;cmdResetAllPositions();</a>
<a name="ln2543">            else { // either set to &quot;Ask&quot; or not at all</a>
<a name="ln2544">                  QMessageBox msgBox;</a>
<a name="ln2545">                  QCheckBox ask;</a>
<a name="ln2546">                  ask.setText(tr(&quot;Don't ask me again.&quot;));</a>
<a name="ln2547">                  ask.setToolTip(tr(&quot;You can change this behaviour any time in 'Preferences… &gt; Import &gt; Reset Element Positions'&quot;));</a>
<a name="ln2548">                  msgBox.setCheckBox(&amp;ask);</a>
<a name="ln2549">                  QString question = tr(&quot;Reset the positions of all elements?&quot;);</a>
<a name="ln2550">                  msgBox.setWindowTitle(question);</a>
<a name="ln2551">                  msgBox.setText(tr(&quot;To best take advantage of automatic placement in MuseScore 3 when importing '%1' from MuseScore %2, it is recommended to reset the positions of all elements.&quot;)</a>
<a name="ln2552">                                 .arg(score-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName(), score-&gt;mscoreVersion()) + &quot;\n\n&quot; + question);</a>
<a name="ln2553">                  msgBox.setIcon(QMessageBox::Question);</a>
<a name="ln2554">                  msgBox.setStandardButtons(</a>
<a name="ln2555">                                    QMessageBox::Yes | QMessageBox::No</a>
<a name="ln2556">                                    );</a>
<a name="ln2557"> </a>
<a name="ln2558">                  int res = msgBox.exec();</a>
<a name="ln2559">                  if (res == QMessageBox::Yes)</a>
<a name="ln2560">                        score-&gt;cmdResetAllPositions();</a>
<a name="ln2561">                  if (ask.checkState() == Qt::Checked)</a>
<a name="ln2562">                        preferences.setPreference(PREF_IMPORT_COMPATIBILITY_RESET_ELEMENT_POSITIONS, res == QMessageBox::No? &quot;Yes&quot; : &quot;No&quot;);</a>
<a name="ln2563">                  }</a>
<a name="ln2564">            }</a>
<a name="ln2565">      }</a>
<a name="ln2566"> </a>
<a name="ln2567">//---------------------------------------------------------</a>
<a name="ln2568">//   setCurrentView</a>
<a name="ln2569">//---------------------------------------------------------</a>
<a name="ln2570"> </a>
<a name="ln2571">void MuseScore::setCurrentScoreView(int idx)</a>
<a name="ln2572">      {</a>
<a name="ln2573">      tab1-&gt;blockSignals(ctab != tab1);</a>
<a name="ln2574">      setCurrentView(0, idx);</a>
<a name="ln2575">      tab1-&gt;blockSignals(false);</a>
<a name="ln2576"> </a>
<a name="ln2577">      if (tab2) {</a>
<a name="ln2578">            tab2-&gt;blockSignals(ctab != tab2);</a>
<a name="ln2579">            setCurrentView(1, idx);</a>
<a name="ln2580">            tab2-&gt;blockSignals(false);</a>
<a name="ln2581">            }</a>
<a name="ln2582">      }</a>
<a name="ln2583"> </a>
<a name="ln2584">void MuseScore::setCurrentView(int tabIdx, int idx)</a>
<a name="ln2585">      {</a>
<a name="ln2586">      if (idx == -1)</a>
<a name="ln2587">            setCurrentScoreView(nullptr);</a>
<a name="ln2588">      else {</a>
<a name="ln2589">            ScoreTab* tab = tabIdx ? tab2 : tab1;</a>
<a name="ln2590">            if (tab)</a>
<a name="ln2591">                  tab-&gt;setCurrentIndex(idx);</a>
<a name="ln2592">            }</a>
<a name="ln2593">      }</a>
<a name="ln2594"> </a>
<a name="ln2595">//---------------------------------------------------------</a>
<a name="ln2596">//   setCurrentScoreView</a>
<a name="ln2597">//---------------------------------------------------------</a>
<a name="ln2598"> </a>
<a name="ln2599">void MuseScore::setCurrentScoreView(ScoreView* view)</a>
<a name="ln2600">      {</a>
<a name="ln2601">      cv = view;</a>
<a name="ln2602">      if (cv) {</a>
<a name="ln2603">            ctab = (tab2 &amp;&amp; tab2-&gt;view() == view) ? tab2 : tab1;</a>
<a name="ln2604">            if (timeline())</a>
<a name="ln2605">                  timeline()-&gt;setScoreView(cv);</a>
<a name="ln2606">            if (cv-&gt;score() &amp;&amp; (cs != cv-&gt;score())) {</a>
<a name="ln2607">                  // exit note entry mode</a>
<a name="ln2608">                  if (cv-&gt;noteEntryMode()) {</a>
<a name="ln2609">                        cv-&gt;cmd(getAction(&quot;escape&quot;));</a>
<a name="ln2610">                        qApp-&gt;processEvents();</a>
<a name="ln2611">                        }</a>
<a name="ln2612">                  updateInputState(cv-&gt;score());</a>
<a name="ln2613">                  }</a>
<a name="ln2614">            cs = cv-&gt;score();</a>
<a name="ln2615">            cv-&gt;setFocusRect();</a>
<a name="ln2616">            }</a>
<a name="ln2617">      else</a>
<a name="ln2618">            cs = 0;</a>
<a name="ln2619"> </a>
<a name="ln2620">      if (ScriptRecorder* rec = getScriptRecorder())</a>
<a name="ln2621">            rec-&gt;recordCurrentScoreChange();</a>
<a name="ln2622"> </a>
<a name="ln2623">      if (cs)</a>
<a name="ln2624">            cs-&gt;masterScore()-&gt;setPlaybackScore(_playPartOnly ? cs : cs-&gt;masterScore());</a>
<a name="ln2625"> </a>
<a name="ln2626">                  // set midi import panel</a>
<a name="ln2627">      QString fileName = cs ? cs-&gt;importedFilePath() : &quot;&quot;;</a>
<a name="ln2628">      midiPanelOnSwitchToFile(fileName);</a>
<a name="ln2629"> </a>
<a name="ln2630">      if (enableExperimental) {</a>
<a name="ln2631">            updateLayer();</a>
<a name="ln2632">            updatePlayMode();</a>
<a name="ln2633">            }</a>
<a name="ln2634"> </a>
<a name="ln2635">      if (seq)</a>
<a name="ln2636">            seq-&gt;setScoreView(cv);</a>
<a name="ln2637">      if (playPanel)</a>
<a name="ln2638">            playPanel-&gt;setScore(cs);</a>
<a name="ln2639">      if (synthControl)</a>
<a name="ln2640">            synthControl-&gt;setScore(cs);</a>
<a name="ln2641">      if (selectionWindow)</a>
<a name="ln2642">            selectionWindow-&gt;setScore(cs);</a>
<a name="ln2643">      if (mixer)</a>
<a name="ln2644">            mixer-&gt;setScore(cs);</a>
<a name="ln2645">#ifdef OMR</a>
<a name="ln2646">      if (omrPanel) {</a>
<a name="ln2647">            if (cv &amp;&amp; cv-&gt;omrView())</a>
<a name="ln2648">                  omrPanel-&gt;setOmrView(cv-&gt;omrView());</a>
<a name="ln2649">            else</a>
<a name="ln2650">                  omrPanel-&gt;setOmrView(0);</a>
<a name="ln2651">            }</a>
<a name="ln2652">#endif</a>
<a name="ln2653">      if (!cs) {</a>
<a name="ln2654">            setWindowTitle(MUSESCORE_NAME_VERSION);</a>
<a name="ln2655">            if (_navigator &amp;&amp; _navigator-&gt;widget()) {</a>
<a name="ln2656">                  navigator()-&gt;setScoreView(cv);</a>
<a name="ln2657">                  }</a>
<a name="ln2658">            if (timeline()) {</a>
<a name="ln2659">                  timeline()-&gt;setScoreView(cv);</a>
<a name="ln2660">                  timeline()-&gt;setScore(0);</a>
<a name="ln2661">                  }</a>
<a name="ln2662">            if (_inspector)</a>
<a name="ln2663">                  _inspector-&gt;update(0);</a>
<a name="ln2664">            viewModeCombo-&gt;setEnabled(false);</a>
<a name="ln2665">            if (_textTools) {</a>
<a name="ln2666">                  _textTools-&gt;hide();</a>
<a name="ln2667">                  if (textPalette)</a>
<a name="ln2668">                        textPalette-&gt;hide();</a>
<a name="ln2669">                  }</a>
<a name="ln2670">            if (_pianoTools)</a>
<a name="ln2671">                  _pianoTools-&gt;hide();</a>
<a name="ln2672">            if (_drumTools)</a>
<a name="ln2673">                  _drumTools-&gt;hide();</a>
<a name="ln2674">            changeState(STATE_DISABLED);</a>
<a name="ln2675">            ScoreAccessibility::instance()-&gt;clearAccessibilityInfo();</a>
<a name="ln2676">            return;</a>
<a name="ln2677">            }</a>
<a name="ln2678"> </a>
<a name="ln2679">      viewModeCombo-&gt;setEnabled(true);</a>
<a name="ln2680">      updateViewModeCombo();</a>
<a name="ln2681"> </a>
<a name="ln2682">      selectionChanged(cs-&gt;selection().state());</a>
<a name="ln2683"> </a>
<a name="ln2684">      _sstate = STATE_DISABLED; // defeat optimization</a>
<a name="ln2685">      changeState(cv-&gt;mscoreState());</a>
<a name="ln2686"> </a>
<a name="ln2687">      cv-&gt;setFocus(Qt::OtherFocusReason);</a>
<a name="ln2688">      setFocusProxy(cv);</a>
<a name="ln2689"> </a>
<a name="ln2690">      getAction(&quot;file-save&quot;)-&gt;setEnabled(cs-&gt;masterScore()-&gt;isSavable());</a>
<a name="ln2691">      getAction(&quot;file-part-export&quot;)-&gt;setEnabled(cs-&gt;masterScore()-&gt;excerpts().size() &gt; 0);</a>
<a name="ln2692">      getAction(&quot;show-invisible&quot;)-&gt;setChecked(cs-&gt;showInvisible());</a>
<a name="ln2693">      getAction(&quot;show-unprintable&quot;)-&gt;setChecked(cs-&gt;showUnprintable());</a>
<a name="ln2694">      getAction(&quot;show-frames&quot;)-&gt;setChecked(cs-&gt;showFrames());</a>
<a name="ln2695">      getAction(&quot;show-pageborders&quot;)-&gt;setChecked(cs-&gt;showPageborders());</a>
<a name="ln2696">      getAction(&quot;mark-irregular&quot;)-&gt;setChecked(cs-&gt;markIrregularMeasures());</a>
<a name="ln2697">      getAction(&quot;fotomode&quot;)-&gt;setChecked(cv-&gt;fotoMode());</a>
<a name="ln2698">      getAction(&quot;join-measures&quot;)-&gt;setEnabled(cs-&gt;masterScore()-&gt;excerpts().size() == 0);</a>
<a name="ln2699">      getAction(&quot;split-measure&quot;)-&gt;setEnabled(cs-&gt;masterScore()-&gt;excerpts().size() == 0);</a>
<a name="ln2700">      updateUndoRedo();</a>
<a name="ln2701"> </a>
<a name="ln2702">      MagIdx midx = cv-&gt;magIdx();</a>
<a name="ln2703">      if (midx == MagIdx::MAG_FREE)</a>
<a name="ln2704">            mag-&gt;setMag(view-&gt;lmag());</a>
<a name="ln2705">      else {</a>
<a name="ln2706">            mag-&gt;setMagIdx(midx);</a>
<a name="ln2707">            magChanged(midx);</a>
<a name="ln2708">            }</a>
<a name="ln2709"> </a>
<a name="ln2710">      updateWindowTitle(cs);</a>
<a name="ln2711">      setWindowModified(cs-&gt;dirty());</a>
<a name="ln2712"> </a>
<a name="ln2713">      QAction* a = getAction(&quot;concert-pitch&quot;);</a>
<a name="ln2714">      a-&gt;setChecked(cs-&gt;styleB(Sid::concertPitch));</a>
<a name="ln2715"> </a>
<a name="ln2716">      setPos(cs-&gt;inputPos());</a>
<a name="ln2717">      //showMessage(cs-&gt;filePath(), 2000);</a>
<a name="ln2718">      if (_navigator &amp;&amp; _navigator-&gt;widget()) {</a>
<a name="ln2719">            navigator()-&gt;setScoreView(view);</a>
<a name="ln2720">            }</a>
<a name="ln2721">      if (timeline()) {</a>
<a name="ln2722">            timeline()-&gt;setScore(cs);</a>
<a name="ln2723">            timeline()-&gt;setScoreView(view);</a>
<a name="ln2724">            }</a>
<a name="ln2725">      ScoreAccessibility::instance()-&gt;updateAccessibilityInfo();</a>
<a name="ln2726"> </a>
<a name="ln2727">      MasterScore* master = cs-&gt;masterScore();</a>
<a name="ln2728">      if (!scoreWasShown[master]) {</a>
<a name="ln2729">            scoreWasShown[master] = true;</a>
<a name="ln2730">            askResetOldScorePositions(master);</a>
<a name="ln2731">            }</a>
<a name="ln2732">      }</a>
<a name="ln2733"> </a>
<a name="ln2734">//---------------------------------------------------------</a>
<a name="ln2735">//   setCurrentScores</a>
<a name="ln2736">//---------------------------------------------------------</a>
<a name="ln2737"> </a>
<a name="ln2738">void MuseScore::setCurrentScores(Score* s1, Score* s2)</a>
<a name="ln2739">      {</a>
<a name="ln2740">      if (s1)</a>
<a name="ln2741">            tab1-&gt;setCurrentScore(s1);</a>
<a name="ln2742">      if (s2) {</a>
<a name="ln2743">            setSplitScreen(true);</a>
<a name="ln2744">            tab2-&gt;setCurrentScore(s2);</a>
<a name="ln2745">            }</a>
<a name="ln2746">      }</a>
<a name="ln2747"> </a>
<a name="ln2748">//---------------------------------------------------------</a>
<a name="ln2749">//   setSplitScreen</a>
<a name="ln2750">//---------------------------------------------------------</a>
<a name="ln2751"> </a>
<a name="ln2752">void MuseScore::setSplitScreen(bool val)</a>
<a name="ln2753">      {</a>
<a name="ln2754">      if (splitScreen() != val)</a>
<a name="ln2755">            splitWindow(_horizontalSplit);</a>
<a name="ln2756">      }</a>
<a name="ln2757"> </a>
<a name="ln2758">//---------------------------------------------------------</a>
<a name="ln2759">//   updateViewModeCombo</a>
<a name="ln2760">//---------------------------------------------------------</a>
<a name="ln2761"> </a>
<a name="ln2762">void MuseScore::updateViewModeCombo()</a>
<a name="ln2763">      {</a>
<a name="ln2764">      int idx;</a>
<a name="ln2765">      switch (cs-&gt;layoutMode()) {</a>
<a name="ln2766">            case LayoutMode::PAGE:</a>
<a name="ln2767">            case LayoutMode::FLOAT:</a>
<a name="ln2768">                  idx = 0;</a>
<a name="ln2769">                  break;</a>
<a name="ln2770">            case LayoutMode::LINE:</a>
<a name="ln2771">                  idx = 1;</a>
<a name="ln2772">                  break;</a>
<a name="ln2773">            case LayoutMode::SYSTEM:</a>
<a name="ln2774">                  idx = 2;</a>
<a name="ln2775">                  break;</a>
<a name="ln2776">            default:</a>
<a name="ln2777">                  idx = 0;</a>
<a name="ln2778">                  break;</a>
<a name="ln2779">            }</a>
<a name="ln2780">      viewModeCombo-&gt;setCurrentIndex(idx);</a>
<a name="ln2781">      }</a>
<a name="ln2782"> </a>
<a name="ln2783">//---------------------------------------------------------</a>
<a name="ln2784">//   showMessage</a>
<a name="ln2785">//---------------------------------------------------------</a>
<a name="ln2786"> </a>
<a name="ln2787">void MuseScore::showMessage(const QString&amp; s, int timeout)</a>
<a name="ln2788">      {</a>
<a name="ln2789">      _statusBar-&gt;showMessage(s, timeout);</a>
<a name="ln2790">      }</a>
<a name="ln2791"> </a>
<a name="ln2792">//---------------------------------------------------------</a>
<a name="ln2793">//   midiPanel</a>
<a name="ln2794">//---------------------------------------------------------</a>
<a name="ln2795"> </a>
<a name="ln2796">void MuseScore::midiPanelOnSwitchToFile(const QString &amp;file)</a>
<a name="ln2797">      {</a>
<a name="ln2798">      bool isMidiFile = ImportMidiPanel::isMidiFile(file);</a>
<a name="ln2799">      if (isMidiFile) {</a>
<a name="ln2800">            importmidiPanel-&gt;setMidiFile(file);</a>
<a name="ln2801">            if (importmidiPanel-&gt;isPreferredVisible())</a>
<a name="ln2802">                  importmidiPanel-&gt;setVisible(true);</a>
<a name="ln2803">            }</a>
<a name="ln2804">      else</a>
<a name="ln2805">            importmidiPanel-&gt;setVisible(false);</a>
<a name="ln2806">      importmidiShowPanel-&gt;setVisible(!importmidiPanel-&gt;isPreferredVisible() &amp;&amp; isMidiFile);</a>
<a name="ln2807">      }</a>
<a name="ln2808"> </a>
<a name="ln2809">//---------------------------------------------------------</a>
<a name="ln2810">//   midiPanelOnCloseFile</a>
<a name="ln2811">//---------------------------------------------------------</a>
<a name="ln2812"> </a>
<a name="ln2813">void MuseScore::midiPanelOnCloseFile(const QString &amp;file)</a>
<a name="ln2814">      {</a>
<a name="ln2815">      if (ImportMidiPanel::isMidiFile(file))</a>
<a name="ln2816">            importmidiPanel-&gt;excludeMidiFile(file);</a>
<a name="ln2817">      }</a>
<a name="ln2818"> </a>
<a name="ln2819">//---------------------------------------------------------</a>
<a name="ln2820">//   allowShowMidiPanel</a>
<a name="ln2821">//---------------------------------------------------------</a>
<a name="ln2822"> </a>
<a name="ln2823">void MuseScore::allowShowMidiPanel(const QString &amp;file)</a>
<a name="ln2824">      {</a>
<a name="ln2825">      if (ImportMidiPanel::isMidiFile(file))</a>
<a name="ln2826">            importmidiPanel-&gt;setPreferredVisible(true);</a>
<a name="ln2827">      }</a>
<a name="ln2828"> </a>
<a name="ln2829">//---------------------------------------------------------</a>
<a name="ln2830">//   setMidiReopenInProgress</a>
<a name="ln2831">//---------------------------------------------------------</a>
<a name="ln2832"> </a>
<a name="ln2833">void MuseScore::setMidiReopenInProgress(const QString &amp;file)</a>
<a name="ln2834">      {</a>
<a name="ln2835">      if (ImportMidiPanel::isMidiFile(file))</a>
<a name="ln2836">            importmidiPanel-&gt;setReopenInProgress();</a>
<a name="ln2837">      }</a>
<a name="ln2838"> </a>
<a name="ln2839">//---------------------------------------------------------</a>
<a name="ln2840">//   showMidiImportPanel</a>
<a name="ln2841">//---------------------------------------------------------</a>
<a name="ln2842"> </a>
<a name="ln2843">void MuseScore::showMidiImportPanel()</a>
<a name="ln2844">      {</a>
<a name="ln2845">      importmidiPanel-&gt;setPreferredVisible(true);</a>
<a name="ln2846">      QString fileName = cs ? cs-&gt;importedFilePath() : &quot;&quot;;</a>
<a name="ln2847">      if (ImportMidiPanel::isMidiFile(fileName))</a>
<a name="ln2848">            importmidiPanel-&gt;setVisible(true);</a>
<a name="ln2849">      importmidiShowPanel-&gt;hide();</a>
<a name="ln2850">      }</a>
<a name="ln2851"> </a>
<a name="ln2852">//---------------------------------------------------------</a>
<a name="ln2853">//   dragEnterEvent</a>
<a name="ln2854">//---------------------------------------------------------</a>
<a name="ln2855"> </a>
<a name="ln2856">void MuseScore::dragEnterEvent(QDragEnterEvent* event)</a>
<a name="ln2857">      {</a>
<a name="ln2858">      const QMimeData* dta = event-&gt;mimeData();</a>
<a name="ln2859">      if (dta-&gt;hasUrls()) {</a>
<a name="ln2860">            QList&lt;QUrl&gt;ul = event-&gt;mimeData()-&gt;urls();</a>
<a name="ln2861">            for (const QUrl&amp; u : ul) {</a>
<a name="ln2862">                  if (MScore::debugMode)</a>
<a name="ln2863">                        qDebug(&quot;drag Url: %s scheme &lt;%s&gt;&quot;, qPrintable(u.toString()), qPrintable(u.scheme()));</a>
<a name="ln2864">                  if (u.scheme() == &quot;file&quot;) {</a>
<a name="ln2865">                        // QFileInfo fi(u.toLocalFile());</a>
<a name="ln2866">                        event-&gt;acceptProposedAction();</a>
<a name="ln2867">                        break;</a>
<a name="ln2868">                        }</a>
<a name="ln2869">                  }</a>
<a name="ln2870">            }</a>
<a name="ln2871">      }</a>
<a name="ln2872"> </a>
<a name="ln2873">//---------------------------------------------------------</a>
<a name="ln2874">//   dropEvent</a>
<a name="ln2875">//---------------------------------------------------------</a>
<a name="ln2876"> </a>
<a name="ln2877">void MuseScore::dropEvent(QDropEvent* event)</a>
<a name="ln2878">      {</a>
<a name="ln2879">      const QMimeData* dta = event-&gt;mimeData();</a>
<a name="ln2880">      if (dta-&gt;hasUrls()) {</a>
<a name="ln2881">            int view = -1;</a>
<a name="ln2882">            foreach(const QUrl&amp; u, event-&gt;mimeData()-&gt;urls()) {</a>
<a name="ln2883">                  if (u.scheme() == &quot;file&quot;) {</a>
<a name="ln2884">                        QString file = u.toLocalFile();</a>
<a name="ln2885">                        MasterScore* score = readScore(file);</a>
<a name="ln2886">                        if (score) {</a>
<a name="ln2887">                              view = appendScore(score);</a>
<a name="ln2888">                              addRecentScore(score);</a>
<a name="ln2889">                              }</a>
<a name="ln2890">                        }</a>
<a name="ln2891">                  }</a>
<a name="ln2892">            if (view != -1) {</a>
<a name="ln2893">                  setCurrentScoreView(view);</a>
<a name="ln2894">                  writeSessionFile(false);</a>
<a name="ln2895">                  }</a>
<a name="ln2896">            event-&gt;acceptProposedAction();</a>
<a name="ln2897">            }</a>
<a name="ln2898">      }</a>
<a name="ln2899"> </a>
<a name="ln2900">//---------------------------------------------------------</a>
<a name="ln2901">//   changeEvent</a>
<a name="ln2902">//---------------------------------------------------------</a>
<a name="ln2903"> </a>
<a name="ln2904">void MuseScore::changeEvent(QEvent *e)</a>
<a name="ln2905">      {</a>
<a name="ln2906">      QMainWindow::changeEvent(e);</a>
<a name="ln2907">      switch (e-&gt;type()) {</a>
<a name="ln2908">            case QEvent::LanguageChange:</a>
<a name="ln2909">                  retranslate();</a>
<a name="ln2910">                  break;</a>
<a name="ln2911">            default:</a>
<a name="ln2912">                  break;</a>
<a name="ln2913">            }</a>
<a name="ln2914">      }</a>
<a name="ln2915"> </a>
<a name="ln2916">//---------------------------------------------------------</a>
<a name="ln2917">//   showEvent</a>
<a name="ln2918">//---------------------------------------------------------</a>
<a name="ln2919"> </a>
<a name="ln2920">void MuseScore::showEvent(QShowEvent* showEvent)</a>
<a name="ln2921">{</a>
<a name="ln2922">      QMainWindow::showEvent(showEvent);</a>
<a name="ln2923">      emit musescoreWindowWasShown();</a>
<a name="ln2924">}</a>
<a name="ln2925"> </a>
<a name="ln2926"> </a>
<a name="ln2927">//---------------------------------------------------------</a>
<a name="ln2928">//   showPageSettings</a>
<a name="ln2929">//---------------------------------------------------------</a>
<a name="ln2930"> </a>
<a name="ln2931">void MuseScore::showPageSettings()</a>
<a name="ln2932">      {</a>
<a name="ln2933">      if (pageSettings == 0)</a>
<a name="ln2934">            pageSettings = new PageSettings();</a>
<a name="ln2935">      pageSettings-&gt;setScore(cs);</a>
<a name="ln2936">      pageSettings-&gt;show();</a>
<a name="ln2937">      pageSettings-&gt;raise();</a>
<a name="ln2938">      }</a>
<a name="ln2939"> </a>
<a name="ln2940">//---------------------------------------------------------</a>
<a name="ln2941">//   startDebugger</a>
<a name="ln2942">//---------------------------------------------------------</a>
<a name="ln2943"> </a>
<a name="ln2944">void MuseScore::startDebugger()</a>
<a name="ln2945">      {</a>
<a name="ln2946">      if (!cs)</a>
<a name="ln2947">            return;</a>
<a name="ln2948">      if (debugger == 0)</a>
<a name="ln2949">            debugger = new Debugger(this);</a>
<a name="ln2950">      debugger-&gt;updateList(cs);</a>
<a name="ln2951">      debugger-&gt;show();</a>
<a name="ln2952">      }</a>
<a name="ln2953"> </a>
<a name="ln2954">//---------------------------------------------------------</a>
<a name="ln2955">//   showElementContext</a>
<a name="ln2956">//---------------------------------------------------------</a>
<a name="ln2957"> </a>
<a name="ln2958">void MuseScore::showElementContext(Element* el)</a>
<a name="ln2959">      {</a>
<a name="ln2960">      if (el == 0)</a>
<a name="ln2961">            return;</a>
<a name="ln2962">      startDebugger();</a>
<a name="ln2963">      debugger-&gt;setElement(el);</a>
<a name="ln2964">      }</a>
<a name="ln2965"> </a>
<a name="ln2966">//---------------------------------------------------------</a>
<a name="ln2967">//   reDisplayDockWidget</a>
<a name="ln2968">//</a>
<a name="ln2969">//   Helper function to ensure when un-docked widgets are</a>
<a name="ln2970">//   re-displayed, they are also re-dockable</a>
<a name="ln2971">//---------------------------------------------------------</a>
<a name="ln2972"> </a>
<a name="ln2973">void MuseScore::reDisplayDockWidget(QDockWidget* widget, bool visible)</a>
<a name="ln2974">      {</a>
<a name="ln2975">      if (widget-&gt;isFloating() &amp;&amp; !widget-&gt;isVisible()) {</a>
<a name="ln2976">            // Ensure the widget is re-dockable if it has been closed and re-opened when un-docked. This is a workaround for a known QT bug. See QTBUG-69922.</a>
<a name="ln2977">            widget-&gt;setFloating(false);</a>
<a name="ln2978">            widget-&gt;setFloating(true);</a>
<a name="ln2979">            }</a>
<a name="ln2980">      widget-&gt;setVisible(visible);</a>
<a name="ln2981">      }</a>
<a name="ln2982"> </a>
<a name="ln2983">//---------------------------------------------------------</a>
<a name="ln2984">//   showPlayPanel</a>
<a name="ln2985">//---------------------------------------------------------</a>
<a name="ln2986"> </a>
<a name="ln2987">void MuseScore::showPlayPanel(bool visible)</a>
<a name="ln2988">      {</a>
<a name="ln2989">      if (noSeq || !(seq &amp;&amp; seq-&gt;isRunning()))</a>
<a name="ln2990">            return;</a>
<a name="ln2991">      if (playPanel == 0) {</a>
<a name="ln2992">            if (!visible)</a>
<a name="ln2993">                  return;</a>
<a name="ln2994">            playPanel = new PlayPanel(this);</a>
<a name="ln2995">            connect(playPanel, SIGNAL(metronomeGainChanged(float)), seq, SLOT(setMetronomeGain(float)));</a>
<a name="ln2996">            connect(playPanel, SIGNAL(relTempoChanged(double)),seq, SLOT(setRelTempo(double)));</a>
<a name="ln2997">            connect(playPanel, SIGNAL(posChange(int)),         seq, SLOT(seek(int)));</a>
<a name="ln2998">            connect(playPanel, SIGNAL(closed(bool)),          playId,   SLOT(setChecked(bool)));</a>
<a name="ln2999">            connect(synti,     SIGNAL(gainChanged(float)), playPanel, SLOT(setGain(float)));</a>
<a name="ln3000">            playPanel-&gt;setGain(synti-&gt;gain());</a>
<a name="ln3001">            playPanel-&gt;setScore(cs);</a>
<a name="ln3002">            addDockWidget(Qt::RightDockWidgetArea, playPanel);</a>
<a name="ln3003"> </a>
<a name="ln3004">            // The play panel must be set visible before being set floating for positioning</a>
<a name="ln3005">            // and window geometry reasons.</a>
<a name="ln3006">            playPanel-&gt;setVisible(visible);</a>
<a name="ln3007">            playPanel-&gt;setFloating(false);</a>
<a name="ln3008">            }</a>
<a name="ln3009">      else</a>
<a name="ln3010">            reDisplayDockWidget(playPanel, visible);</a>
<a name="ln3011">      playId-&gt;setChecked(visible);</a>
<a name="ln3012">      }</a>
<a name="ln3013"> </a>
<a name="ln3014">//---------------------------------------------------------</a>
<a name="ln3015">//   cmdAppendMeasures</a>
<a name="ln3016">//---------------------------------------------------------</a>
<a name="ln3017"> </a>
<a name="ln3018">void MuseScore::cmdAppendMeasures()</a>
<a name="ln3019">      {</a>
<a name="ln3020">      if (cs) {</a>
<a name="ln3021">            if (measuresDialog == 0)</a>
<a name="ln3022">                  measuresDialog = new MeasuresDialog;</a>
<a name="ln3023">            measuresDialog-&gt;show();</a>
<a name="ln3024">            }</a>
<a name="ln3025">      }</a>
<a name="ln3026"> </a>
<a name="ln3027">//---------------------------------------------------------</a>
<a name="ln3028">//   rebuildAudioDrivers</a>
<a name="ln3029">//---------------------------------------------------------</a>
<a name="ln3030"> </a>
<a name="ln3031">void MuseScore::restartAudioEngine()</a>
<a name="ln3032">      {</a>
<a name="ln3033">      if (seq)</a>
<a name="ln3034">            seq-&gt;exit();</a>
<a name="ln3035"> </a>
<a name="ln3036">      if (seq) {</a>
<a name="ln3037">            Driver* driver = driverFactory(seq, &quot;&quot;);</a>
<a name="ln3038">            if (driver) {</a>
<a name="ln3039">                  // Updating synthesizer's sample rate</a>
<a name="ln3040">                  if (seq-&gt;synti()) {</a>
<a name="ln3041">                        seq-&gt;synti()-&gt;setSampleRate(driver-&gt;sampleRate());</a>
<a name="ln3042">                        seq-&gt;synti()-&gt;init();</a>
<a name="ln3043">                        }</a>
<a name="ln3044">                  seq-&gt;setDriver(driver);</a>
<a name="ln3045">                  }</a>
<a name="ln3046">            if (!seq-&gt;init())</a>
<a name="ln3047">                  qDebug(&quot;sequencer init failed&quot;);</a>
<a name="ln3048">            }</a>
<a name="ln3049">      }</a>
<a name="ln3050"> </a>
<a name="ln3051">//---------------------------------------------------------</a>
<a name="ln3052">//   midiinToggled</a>
<a name="ln3053">//---------------------------------------------------------</a>
<a name="ln3054"> </a>
<a name="ln3055">void MuseScore::midiinToggled(bool val)</a>
<a name="ln3056">      {</a>
<a name="ln3057">      _midiinEnabled = val;</a>
<a name="ln3058"> </a>
<a name="ln3059">      if (_midiinEnabled)</a>
<a name="ln3060">            restartAudioEngine();</a>
<a name="ln3061">      }</a>
<a name="ln3062"> </a>
<a name="ln3063">//---------------------------------------------------------</a>
<a name="ln3064">//   midiinEnabled</a>
<a name="ln3065">//---------------------------------------------------------</a>
<a name="ln3066"> </a>
<a name="ln3067">bool MuseScore::midiinEnabled() const</a>
<a name="ln3068">      {</a>
<a name="ln3069">      return preferences.getBool(PREF_IO_MIDI_ENABLEINPUT) &amp;&amp; _midiinEnabled;</a>
<a name="ln3070">      }</a>
<a name="ln3071"> </a>
<a name="ln3072">//---------------------------------------------------------</a>
<a name="ln3073">//   processMidiRemote</a>
<a name="ln3074">//    return if midi remote command detected</a>
<a name="ln3075">//---------------------------------------------------------</a>
<a name="ln3076"> </a>
<a name="ln3077">bool MuseScore::processMidiRemote(MidiRemoteType type, int dta, int value)</a>
<a name="ln3078">      {</a>
<a name="ln3079">      if (!preferences.getBool(PREF_IO_MIDI_USEREMOTECONTROL))</a>
<a name="ln3080">            return false;</a>
<a name="ln3081">      if (!value) {</a>
<a name="ln3082">            // This was a &quot;NoteOff&quot; or &quot;CtrlOff&quot; event. Most MidiRemote actions should only</a>
<a name="ln3083">            // be triggered by an &quot;On&quot; event, so we need to check if this is one of those.</a>
<a name="ln3084">            if (!preferences.getBool(PREF_IO_MIDI_ADVANCEONRELEASE)</a>
<a name="ln3085">                    || type != preferences.midiRemote(RMIDI_REALTIME_ADVANCE).type</a>
<a name="ln3086">                    || dta != preferences.midiRemote(RMIDI_REALTIME_ADVANCE).data)</a>
<a name="ln3087">                  return false;</a>
<a name="ln3088">            }</a>
<a name="ln3089">      for (int i = 0; i &lt; MIDI_REMOTES; ++i) {</a>
<a name="ln3090">            if (preferences.midiRemote(i).type == type &amp;&amp; preferences.midiRemote(i).data == dta) {</a>
<a name="ln3091">                  if (cv == 0)</a>
<a name="ln3092">                        return false;</a>
<a name="ln3093">                  QAction* a = 0;</a>
<a name="ln3094">                  switch (i) {</a>
<a name="ln3095">                        case RMIDI_REWIND:      a = getAction(&quot;rewind&quot;); break;</a>
<a name="ln3096">                        case RMIDI_TOGGLE_PLAY: a = getAction(&quot;play&quot;);  break;</a>
<a name="ln3097">                        case RMIDI_PLAY:</a>
<a name="ln3098">                              a = getAction(&quot;play&quot;);</a>
<a name="ln3099">                              if (a-&gt;isChecked())</a>
<a name="ln3100">                                    return true;</a>
<a name="ln3101">                              break;</a>
<a name="ln3102">                        case RMIDI_STOP:</a>
<a name="ln3103">                              a = getAction(&quot;play&quot;);</a>
<a name="ln3104">                              if (!a-&gt;isChecked())</a>
<a name="ln3105">                                    return true;</a>
<a name="ln3106">                              break;</a>
<a name="ln3107">                        case RMIDI_NOTE1:   a = getAction(&quot;pad-note-1&quot;);  break;</a>
<a name="ln3108">                        case RMIDI_NOTE2:   a = getAction(&quot;pad-note-2&quot;);  break;</a>
<a name="ln3109">                        case RMIDI_NOTE4:   a = getAction(&quot;pad-note-4&quot;);  break;</a>
<a name="ln3110">                        case RMIDI_NOTE8:   a = getAction(&quot;pad-note-8&quot;);  break;</a>
<a name="ln3111">                        case RMIDI_NOTE16:  a = getAction(&quot;pad-note-16&quot;);  break;</a>
<a name="ln3112">                        case RMIDI_NOTE32:  a = getAction(&quot;pad-note-32&quot;);  break;</a>
<a name="ln3113">                        case RMIDI_NOTE64:  a = getAction(&quot;pad-note-64&quot;);  break;</a>
<a name="ln3114">                        case RMIDI_REST:    a = getAction(&quot;rest&quot;);  break;</a>
<a name="ln3115">                        case RMIDI_DOT:     a = getAction(&quot;pad-dot&quot;);  break;</a>
<a name="ln3116">                        case RMIDI_DOTDOT:  a = getAction(&quot;pad-dotdot&quot;);  break;</a>
<a name="ln3117">                        case RMIDI_TIE:     a = getAction(&quot;tie&quot;);  break;</a>
<a name="ln3118">                        case RMIDI_UNDO:    a = getAction(&quot;undo&quot;); break;</a>
<a name="ln3119">                        case RMIDI_NOTE_EDIT_MODE: a = getAction(&quot;note-input&quot;);  break;</a>
<a name="ln3120">                        case RMIDI_REALTIME_ADVANCE: a = getAction(&quot;realtime-advance&quot;);  break;</a>
<a name="ln3121">                        }</a>
<a name="ln3122">                  if (a)</a>
<a name="ln3123">                        a-&gt;trigger();</a>
<a name="ln3124">                  return true;</a>
<a name="ln3125">                  }</a>
<a name="ln3126">            }</a>
<a name="ln3127">      return false;</a>
<a name="ln3128">      }</a>
<a name="ln3129"> </a>
<a name="ln3130">//---------------------------------------------------------</a>
<a name="ln3131">//   midiNoteReceived</a>
<a name="ln3132">//---------------------------------------------------------</a>
<a name="ln3133"> </a>
<a name="ln3134">void MuseScore::midiNoteReceived(int channel, int pitch, int velo)</a>
<a name="ln3135">      {</a>
<a name="ln3136">      static const int THRESHOLD_DRUMS = 5; // iterations required before consecutive drum notes</a>
<a name="ln3137">                                     // are not considered part of a chord</a>
<a name="ln3138">      static int active = 0;</a>
<a name="ln3139">      static int iterDrums = 0;</a>
<a name="ln3140">      static int activeDrums = 0;</a>
<a name="ln3141"> </a>
<a name="ln3142">      if (!midiinEnabled())</a>
<a name="ln3143">            return;</a>
<a name="ln3144"> </a>
<a name="ln3145">// qDebug(&quot;midiNoteReceived %d %d %d&quot;, channel, pitch, velo);</a>
<a name="ln3146"> </a>
<a name="ln3147">      if (_midiRecordId != -1) {</a>
<a name="ln3148">            preferences.updateMidiRemote(_midiRecordId, MIDI_REMOTE_TYPE_NOTEON, pitch);</a>
<a name="ln3149">            _midiRecordId = -1;</a>
<a name="ln3150">            if (preferenceDialog)</a>
<a name="ln3151">                  preferenceDialog-&gt;updateRemote();</a>
<a name="ln3152">            return;</a>
<a name="ln3153">            }</a>
<a name="ln3154"> </a>
<a name="ln3155">      if (processMidiRemote(MIDI_REMOTE_TYPE_NOTEON, pitch, velo)) {</a>
<a name="ln3156">            active = 0;</a>
<a name="ln3157">            return;</a>
<a name="ln3158">            }</a>
<a name="ln3159"> </a>
<a name="ln3160">      QWidget* w = QApplication::activeModalWidget();</a>
<a name="ln3161">      if (!cv || w) {</a>
<a name="ln3162">            active = 0;</a>
<a name="ln3163">            return;</a>
<a name="ln3164">            }</a>
<a name="ln3165">      if (velo) {</a>
<a name="ln3166">             /*</a>
<a name="ln3167">             * Since some drum modules do not overlap note on / off messages</a>
<a name="ln3168">             * we need to take a bit of a different tactic to allow chords</a>
<a name="ln3169">             * to be entered.</a>
<a name="ln3170">             *</a>
<a name="ln3171">             * Rather than decrement active for drums (midi on ch10),</a>
<a name="ln3172">             * we'll just assume that if read() has been called a couple</a>
<a name="ln3173">             * times in a row without a drum note, that this note is not</a>
<a name="ln3174">             * part of a cord.</a>
<a name="ln3175">             */</a>
<a name="ln3176">            if (channel == 0x09) {</a>
<a name="ln3177">                  if (iterDrums &gt;= THRESHOLD_DRUMS)</a>
<a name="ln3178">                        activeDrums = 0;</a>
<a name="ln3179">                  iterDrums = 0;</a>
<a name="ln3180">                  cv-&gt;midiNoteReceived(pitch, activeDrums &gt; 0, velo);</a>
<a name="ln3181">                  }</a>
<a name="ln3182">            else {</a>
<a name="ln3183">                  //qDebug(&quot;    midiNoteReceived %d active %d&quot;, pitch, active);</a>
<a name="ln3184">                  cv-&gt;midiNoteReceived(pitch, active &gt; 0, velo);</a>
<a name="ln3185">                  ++active;</a>
<a name="ln3186">                  }</a>
<a name="ln3187">            }</a>
<a name="ln3188">      else {</a>
<a name="ln3189">            /*</a>
<a name="ln3190">            * Since a note may be assigned to a midi_remote,</a>
<a name="ln3191">            * don't decrease active below zero on noteoff.</a>
<a name="ln3192">            */</a>
<a name="ln3193">            if ((channel != 0x09) &amp;&amp; (active &gt; 0))</a>
<a name="ln3194">                  --active;</a>
<a name="ln3195">            if ((channel == 0x09) &amp;&amp; (activeDrums &gt; 0))</a>
<a name="ln3196">                  --activeDrums;</a>
<a name="ln3197">            cv-&gt;midiNoteReceived(pitch, false, velo);</a>
<a name="ln3198">            }</a>
<a name="ln3199"> </a>
<a name="ln3200">      if (_pianoTools &amp;&amp; _pianoTools-&gt;isVisible()) {</a>
<a name="ln3201">            if (velo)</a>
<a name="ln3202">                  _pianoTools-&gt;pressPitch(pitch);</a>
<a name="ln3203">            else</a>
<a name="ln3204">                  _pianoTools-&gt;releasePitch(pitch);</a>
<a name="ln3205">            }</a>
<a name="ln3206">      }</a>
<a name="ln3207"> </a>
<a name="ln3208">//---------------------------------------------------------</a>
<a name="ln3209">//   midiCtrlReceived</a>
<a name="ln3210">//---------------------------------------------------------</a>
<a name="ln3211"> </a>
<a name="ln3212">void MuseScore::midiCtrlReceived(int controller, int value)</a>
<a name="ln3213">      {</a>
<a name="ln3214">      if (!midiinEnabled())</a>
<a name="ln3215">            return;</a>
<a name="ln3216">      if (_midiRecordId != -1) {</a>
<a name="ln3217">            preferences.updateMidiRemote(_midiRecordId, MIDI_REMOTE_TYPE_CTRL, controller);</a>
<a name="ln3218">            _midiRecordId = -1;</a>
<a name="ln3219">            if (preferenceDialog)</a>
<a name="ln3220">                  preferenceDialog-&gt;updateRemote();</a>
<a name="ln3221">            return;</a>
<a name="ln3222">            }</a>
<a name="ln3223">      // when value is 0 (usually when a key is released ) nothing happens</a>
<a name="ln3224">      if (processMidiRemote(MIDI_REMOTE_TYPE_CTRL, controller, value))</a>
<a name="ln3225">            return;</a>
<a name="ln3226">      }</a>
<a name="ln3227"> </a>
<a name="ln3228">//---------------------------------------------------------</a>
<a name="ln3229">//   removeTab</a>
<a name="ln3230">//---------------------------------------------------------</a>
<a name="ln3231"> </a>
<a name="ln3232">void MuseScore::removeTab()</a>
<a name="ln3233">      {</a>
<a name="ln3234">      int n = scoreList.indexOf(cs-&gt;masterScore());</a>
<a name="ln3235">      if (n == -1) {</a>
<a name="ln3236">            qDebug(&quot;removeTab: %p not found&quot;, cs);</a>
<a name="ln3237">            return;</a>
<a name="ln3238">            }</a>
<a name="ln3239">      removeTab(n);</a>
<a name="ln3240">      }</a>
<a name="ln3241"> </a>
<a name="ln3242">void MuseScore::removeTab(int i)</a>
<a name="ln3243">      {</a>
<a name="ln3244">      MasterScore* score = scoreList.value(i);</a>
<a name="ln3245"> </a>
<a name="ln3246">      if (score == 0)</a>
<a name="ln3247">            return;</a>
<a name="ln3248"> </a>
<a name="ln3249">      QString tmpName = score-&gt;tmpName();</a>
<a name="ln3250"> </a>
<a name="ln3251">      if (!scriptTestMode &amp;&amp; !converterMode &amp;&amp; checkDirty(score))</a>
<a name="ln3252">            return;</a>
<a name="ln3253">      if (seq &amp;&amp; seq-&gt;score() == score) {</a>
<a name="ln3254">            seq-&gt;stopWait();</a>
<a name="ln3255">            seq-&gt;setScoreView(0);</a>
<a name="ln3256">            }</a>
<a name="ln3257"> </a>
<a name="ln3258">      int idx1      = tab1-&gt;currentIndex();</a>
<a name="ln3259">      bool firstTab = tab1-&gt;view(idx1) == cv;</a>
<a name="ln3260"> </a>
<a name="ln3261">      midiPanelOnCloseFile(score-&gt;importedFilePath());</a>
<a name="ln3262">      scoreList.removeAt(i);</a>
<a name="ln3263">      scoreWasShown.remove(score);</a>
<a name="ln3264"> </a>
<a name="ln3265">      tab1-&gt;removeTab(i, /* noCurrentChangedSignals */ true);</a>
<a name="ln3266">      if (tab2)</a>
<a name="ln3267">            tab2-&gt;removeTab(i, /* noCurrentChangedSignals */ true);</a>
<a name="ln3268"> </a>
<a name="ln3269">      cs = 0;</a>
<a name="ln3270">      cv = 0;</a>
<a name="ln3271">      int n = scoreList.size();</a>
<a name="ln3272">      if (n == 0)</a>
<a name="ln3273">            setCurrentScoreView(nullptr);</a>
<a name="ln3274">      else</a>
<a name="ln3275">            setCurrentScoreView((firstTab ? tab1 : tab2)-&gt;view());</a>
<a name="ln3276">      writeSessionFile(false);</a>
<a name="ln3277">      if (!tmpName.isEmpty()) {</a>
<a name="ln3278">            QFile f(tmpName);</a>
<a name="ln3279">            f.remove();</a>
<a name="ln3280">            }</a>
<a name="ln3281">      delete score;</a>
<a name="ln3282">      // Shouldn't be necessary... but fix #21841</a>
<a name="ln3283">      update();</a>
<a name="ln3284">      }</a>
<a name="ln3285"> </a>
<a name="ln3286">//---------------------------------------------------------</a>
<a name="ln3287">//   runTestScripts</a>
<a name="ln3288">//---------------------------------------------------------</a>
<a name="ln3289"> </a>
<a name="ln3290">bool MuseScore::runTestScripts(const QStringList&amp; scriptFiles)</a>
<a name="ln3291">      {</a>
<a name="ln3292">      setDefaultPalette();</a>
<a name="ln3293">      showInspector(true);</a>
<a name="ln3294"> </a>
<a name="ln3295">      ScriptContext ctx(this);</a>
<a name="ln3296">      bool allPassed = true;</a>
<a name="ln3297">      int passed = 0;</a>
<a name="ln3298">      int total = 0;</a>
<a name="ln3299">      for (const QString&amp; scriptFile : scriptFiles) {</a>
<a name="ln3300">            // ensure no scores are open not to interfere with</a>
<a name="ln3301">            // the next script initialization process.</a>
<a name="ln3302">            while (!scores().empty()) {</a>
<a name="ln3303">                  closeScore(scores().back());</a>
<a name="ln3304">                  }</a>
<a name="ln3305">            QTextStream(stdout) &lt;&lt; &quot;Start test: &quot; &lt;&lt; scriptFile &lt;&lt; endl;</a>
<a name="ln3306">            std::unique_ptr&lt;Script&gt; script = Script::fromFile(scriptFile);</a>
<a name="ln3307">            const bool pass = script-&gt;execute(ctx);</a>
<a name="ln3308">            QTextStream(stdout) &lt;&lt; &quot;Test &quot; &lt;&lt; scriptFile &lt;&lt; (pass ? &quot; PASS&quot; : &quot; FAIL&quot;) &lt;&lt; endl;</a>
<a name="ln3309">            ++total;</a>
<a name="ln3310">            if (pass)</a>
<a name="ln3311">                  ++passed;</a>
<a name="ln3312">            else</a>
<a name="ln3313">                  allPassed = false;</a>
<a name="ln3314">            }</a>
<a name="ln3315">      QTextStream(stdout) &lt;&lt; &quot;Test scripts: total: &quot; &lt;&lt; total &lt;&lt; &quot;, passed: &quot; &lt;&lt; passed &lt;&lt; endl;</a>
<a name="ln3316">      return allPassed;</a>
<a name="ln3317">      }</a>
<a name="ln3318"> </a>
<a name="ln3319">//---------------------------------------------------------</a>
<a name="ln3320">//   loadTranslation</a>
<a name="ln3321">//---------------------------------------------------------</a>
<a name="ln3322"> </a>
<a name="ln3323">void loadTranslation(QString filename, QString _localeName)</a>
<a name="ln3324">      {</a>
<a name="ln3325">      QString userPrefix    = dataPath + &quot;/locale/&quot;+ filename +&quot;_&quot;;</a>
<a name="ln3326">      QString defaultPrefix = mscoreGlobalShare + &quot;locale/&quot;+ filename +&quot;_&quot;;</a>
<a name="ln3327">      QString userlp        = userPrefix + _localeName;</a>
<a name="ln3328">      QString defaultlp     = defaultPrefix + _localeName;</a>
<a name="ln3329">      QString lp            = defaultlp;</a>
<a name="ln3330"> </a>
<a name="ln3331">      QFileInfo userFi(userlp + &quot;.qm&quot;);</a>
<a name="ln3332">      QFileInfo defaultFi(defaultlp + &quot;.qm&quot;);</a>
<a name="ln3333"> </a>
<a name="ln3334">      if (!defaultFi.exists()) {     // try with a shorter locale name</a>
<a name="ln3335">            QString shortLocaleName = _localeName.left(_localeName.lastIndexOf(&quot;_&quot;));</a>
<a name="ln3336">            QString shortDefaultlp = defaultPrefix + shortLocaleName;</a>
<a name="ln3337">            QFileInfo shortDefaultFi(shortDefaultlp + &quot;.qm&quot;);</a>
<a name="ln3338">            if (shortDefaultFi.exists()) {</a>
<a name="ln3339">                  userlp    = userPrefix + shortLocaleName;</a>
<a name="ln3340">                  userFi    = QFileInfo(userlp + &quot;.qm&quot;);</a>
<a name="ln3341">                  defaultFi = shortDefaultFi;</a>
<a name="ln3342">                  defaultlp = shortDefaultlp;</a>
<a name="ln3343">                  }</a>
<a name="ln3344">            }</a>
<a name="ln3345"> </a>
<a name="ln3346">      if (userFi.exists()) {</a>
<a name="ln3347">            if (userFi.lastModified() &gt; defaultFi.lastModified())</a>
<a name="ln3348">                  lp = userlp;</a>
<a name="ln3349">//            else</a>
<a name="ln3350">//REVIEW                  QFile::remove(userlp + &quot;.qm&quot;);</a>
<a name="ln3351">            }</a>
<a name="ln3352"> </a>
<a name="ln3353">      if (MScore::debugMode)</a>
<a name="ln3354">            qDebug(&quot;load translator &lt;%s&gt;&quot;, qPrintable(lp));</a>
<a name="ln3355"> </a>
<a name="ln3356">      QTranslator* translator = new QTranslator;</a>
<a name="ln3357">      bool success = translator-&gt;load(lp);</a>
<a name="ln3358">      if (success) {</a>
<a name="ln3359">            qApp-&gt;installTranslator(translator);</a>
<a name="ln3360">            translatorList.append(translator);</a>
<a name="ln3361">            }</a>
<a name="ln3362">      else {</a>
<a name="ln3363">            if (MScore::debugMode)</a>
<a name="ln3364">                  qDebug(&quot;load translator &lt;%s&gt; failed&quot;, qPrintable(lp));</a>
<a name="ln3365">            delete translator;</a>
<a name="ln3366">            }</a>
<a name="ln3367">      }</a>
<a name="ln3368"> </a>
<a name="ln3369">//---------------------------------------------------------</a>
<a name="ln3370">//   setLocale</a>
<a name="ln3371">//---------------------------------------------------------</a>
<a name="ln3372"> </a>
<a name="ln3373">void setMscoreLocale(QString _localeName)</a>
<a name="ln3374">      {</a>
<a name="ln3375">      for (QTranslator* t : translatorList) {</a>
<a name="ln3376">            qApp-&gt;removeTranslator(t);</a>
<a name="ln3377">            delete t;</a>
<a name="ln3378">            }</a>
<a name="ln3379">      translatorList.clear();</a>
<a name="ln3380"> </a>
<a name="ln3381">      if (MScore::debugMode)</a>
<a name="ln3382">            qDebug(&quot;configured localeName &lt;%s&gt;&quot;, qPrintable(_localeName));</a>
<a name="ln3383">      if (_localeName.toLower() == &quot;system&quot;) {</a>
<a name="ln3384">            _localeName = QLocale::system().name();</a>
<a name="ln3385">            if (MScore::debugMode)</a>
<a name="ln3386">                  qDebug(&quot;real localeName &lt;%s&gt;&quot;, qPrintable(_localeName));</a>
<a name="ln3387">            if (_localeName == &quot;en_AU&quot;) {</a>
<a name="ln3388">                  _localeName = &quot;en_GB&quot;; // otherwise Australia would fall back to US English</a>
<a name="ln3389">                  if (MScore::debugMode)</a>
<a name="ln3390">                        qDebug(&quot;modified localeName &lt;%s&gt;&quot;, qPrintable(_localeName));</a>
<a name="ln3391">                  }</a>
<a name="ln3392">            }</a>
<a name="ln3393"> </a>
<a name="ln3394">      // find the most recent translation file</a>
<a name="ln3395">      // try to replicate QTranslator.load algorithm in our particular case</a>
<a name="ln3396">      loadTranslation(&quot;mscore&quot;, _localeName);</a>
<a name="ln3397">      loadTranslation(&quot;instruments&quot;, _localeName);</a>
<a name="ln3398">      loadTranslation(&quot;tours&quot;, _localeName);</a>
<a name="ln3399"> </a>
<a name="ln3400">      QString resourceDir;</a>
<a name="ln3401">#if defined(Q_OS_MAC) || defined(Q_OS_WIN)</a>
<a name="ln3402">      resourceDir = mscoreGlobalShare + &quot;locale/&quot;;</a>
<a name="ln3403">#else</a>
<a name="ln3404">      resourceDir = QLibraryInfo::location(QLibraryInfo::TranslationsPath);</a>
<a name="ln3405">#endif</a>
<a name="ln3406">      QTranslator* qtTranslator = new QTranslator;</a>
<a name="ln3407">      if (MScore::debugMode)</a>
<a name="ln3408">            qDebug(&quot;load translator &lt;qt_%s&gt; from &lt;%s&gt;&quot;,</a>
<a name="ln3409">               qPrintable(_localeName), qPrintable(resourceDir));</a>
<a name="ln3410"> </a>
<a name="ln3411">      if (!qtTranslator-&gt;load(QLatin1String(&quot;qt_&quot;) + _localeName, resourceDir) &amp;&amp; MScore::debugMode)</a>
<a name="ln3412">            qDebug(&quot;load translator &lt;qt_%s&gt; failed&quot;, qPrintable(_localeName));</a>
<a name="ln3413">      else {</a>
<a name="ln3414">            qApp-&gt;installTranslator(qtTranslator);</a>
<a name="ln3415">            translatorList.append(qtTranslator);</a>
<a name="ln3416">            }</a>
<a name="ln3417">      QLocale locale(_localeName);</a>
<a name="ln3418">      QLocale::setDefault(locale);</a>
<a name="ln3419">      qApp-&gt;setLayoutDirection(locale.textDirection());</a>
<a name="ln3420">      // initShortcuts();</a>
<a name="ln3421">      }</a>
<a name="ln3422"> </a>
<a name="ln3423">//---------------------------------------------------------</a>
<a name="ln3424">//   loadScores</a>
<a name="ln3425">//    load scores for a new session</a>
<a name="ln3426">//---------------------------------------------------------</a>
<a name="ln3427"> </a>
<a name="ln3428">static void loadScores(const QStringList&amp; argv)</a>
<a name="ln3429">      {</a>
<a name="ln3430">      int currentScoreView = 0;</a>
<a name="ln3431">      if (argv.isEmpty()) {</a>
<a name="ln3432">            if (startWithNewScore)</a>
<a name="ln3433">                  mscore-&gt;newFile();</a>
<a name="ln3434">            else {</a>
<a name="ln3435">                  switch (preferences.sessionStart()) {</a>
<a name="ln3436">                        case SessionStart::LAST:</a>
<a name="ln3437">                              {</a>
<a name="ln3438">                              QSettings settings;</a>
<a name="ln3439">                              int n = settings.value(&quot;scores&quot;, 0).toInt();</a>
<a name="ln3440">                              int c = settings.value(&quot;currentScore&quot;, 0).toInt();</a>
<a name="ln3441">                              for (int i = 0; i &lt; n; ++i) {</a>
<a name="ln3442">                                    QString s = settings.value(QString(&quot;score-%1&quot;).arg(i),&quot;&quot;).toString();</a>
<a name="ln3443">                                    MasterScore* score = mscore-&gt;readScore(s);</a>
<a name="ln3444">                                    if (score) {</a>
<a name="ln3445">                                          int view = mscore-&gt;appendScore(score);</a>
<a name="ln3446">                                          if (i == c)</a>
<a name="ln3447">                                                currentScoreView = view;</a>
<a name="ln3448">                                          }</a>
<a name="ln3449">                                    }</a>
<a name="ln3450">                              }</a>
<a name="ln3451">                              break;</a>
<a name="ln3452">                        case SessionStart::EMPTY:</a>
<a name="ln3453">                              break;</a>
<a name="ln3454">                        case SessionStart::NEW:</a>
<a name="ln3455">                              mscore-&gt;newFile();</a>
<a name="ln3456">                              break;</a>
<a name="ln3457">                        case SessionStart::SCORE:</a>
<a name="ln3458">                              {</a>
<a name="ln3459">                              QString startScore = preferences.getString(PREF_APP_STARTUP_STARTSCORE);</a>
<a name="ln3460">                              if (startScore == &quot;:/data/My_First_Score.mscz&quot;) {</a>
<a name="ln3461">                                    startScore = &quot;:/data/My_First_Score.mscx&quot;;</a>
<a name="ln3462">                                    preferences.setPreference(PREF_APP_STARTUP_STARTSCORE, startScore);</a>
<a name="ln3463">                                    }</a>
<a name="ln3464"> </a>
<a name="ln3465">                              MasterScore* score = mscore-&gt;readScore(startScore);</a>
<a name="ln3466">                              if (startScore.startsWith(&quot;:/&quot;) &amp;&amp; score) {</a>
<a name="ln3467">                                    score-&gt;setStyle(MScore::defaultStyle());</a>
<a name="ln3468">                                    score-&gt;style().checkChordList();</a>
<a name="ln3469">                                    score-&gt;styleChanged();</a>
<a name="ln3470">                                    score-&gt;setName(mscore-&gt;createDefaultName());</a>
<a name="ln3471">                                    // TODO score-&gt;setPageFormat(*MScore::defaultStyle().pageFormat());</a>
<a name="ln3472">                                    score-&gt;doLayout();</a>
<a name="ln3473">                                    score-&gt;setCreated(true);</a>
<a name="ln3474">                                    }</a>
<a name="ln3475">                              if (score == 0) {</a>
<a name="ln3476">                                    score = mscore-&gt;readScore(&quot;:/data/My_First_Score.mscx&quot;);</a>
<a name="ln3477">                                    if (score) {</a>
<a name="ln3478">                                          score-&gt;setStyle(MScore::defaultStyle());</a>
<a name="ln3479">                                          score-&gt;style().checkChordList();</a>
<a name="ln3480">                                          score-&gt;styleChanged();</a>
<a name="ln3481">                                          score-&gt;setName(mscore-&gt;createDefaultName());</a>
<a name="ln3482">                                          // TODO score-&gt;setPageFormat(*MScore::defaultStyle().pageFormat());</a>
<a name="ln3483">                                          score-&gt;doLayout();</a>
<a name="ln3484">                                          score-&gt;setCreated(true);</a>
<a name="ln3485">                                          }</a>
<a name="ln3486">                                    }</a>
<a name="ln3487">                              if (score)</a>
<a name="ln3488">                                    currentScoreView = mscore-&gt;appendScore(score);</a>
<a name="ln3489">                              }</a>
<a name="ln3490">                              break;</a>
<a name="ln3491">                        }</a>
<a name="ln3492">                  }</a>
<a name="ln3493">            }</a>
<a name="ln3494">      else {</a>
<a name="ln3495">            foreach(const QString&amp; name, argv) {</a>
<a name="ln3496">                  if (name.isEmpty())</a>
<a name="ln3497">                        continue;</a>
<a name="ln3498">                  MasterScore* score = mscore-&gt;readScore(name);</a>
<a name="ln3499">                  if (score) {</a>
<a name="ln3500">                        mscore-&gt;appendScore(score);</a>
<a name="ln3501">                        scoresOnCommandline = true;</a>
<a name="ln3502">                        if(!MScore::noGui) {</a>
<a name="ln3503">                              mscore-&gt;addRecentScore(score);</a>
<a name="ln3504">                              mscore-&gt;writeSessionFile(false);</a>
<a name="ln3505">                              }</a>
<a name="ln3506">                        }</a>
<a name="ln3507">                  }</a>
<a name="ln3508">            }</a>
<a name="ln3509"> </a>
<a name="ln3510">      if (mscore-&gt;noScore())</a>
<a name="ln3511">            currentScoreView = -1;</a>
<a name="ln3512">      mscore-&gt;setCurrentView(0, currentScoreView);</a>
<a name="ln3513">      mscore-&gt;setCurrentView(1, currentScoreView);</a>
<a name="ln3514">      }</a>
<a name="ln3515"> </a>
<a name="ln3516">//---------------------------------------------------------</a>
<a name="ln3517">//   doConvert</a>
<a name="ln3518">//---------------------------------------------------------</a>
<a name="ln3519"> </a>
<a name="ln3520">static bool doConvert(Score *cs, const QString&amp; fn);</a>
<a name="ln3521"> </a>
<a name="ln3522">static bool doConvert(Score* cs, const QJsonArray&amp; outFiles, QString plugin)</a>
<a name="ln3523">      {</a>
<a name="ln3524">      LayoutMode layoutMode = cs-&gt;layoutMode();</a>
<a name="ln3525">      cs-&gt;setLayoutMode(LayoutMode::PAGE);</a>
<a name="ln3526">      if (cs-&gt;layoutMode() != layoutMode)</a>
<a name="ln3527">            cs-&gt;doLayout();</a>
<a name="ln3528"> </a>
<a name="ln3529">      if (!styleFile.isEmpty()) {</a>
<a name="ln3530">            QFile f(styleFile);</a>
<a name="ln3531">            if (f.open(QIODevice::ReadOnly)) {</a>
<a name="ln3532">                  fprintf(stderr, &quot;\tusing style &lt;%s&gt;\n&quot;, qPrintable(styleFile));</a>
<a name="ln3533">                  cs-&gt;style().load(&amp;f);</a>
<a name="ln3534">                  }</a>
<a name="ln3535">            }</a>
<a name="ln3536">      if (!plugin.isEmpty()) {</a>
<a name="ln3537">            if (mscore-&gt;loadPlugin(plugin)) {</a>
<a name="ln3538">                  fprintf(stderr, &quot;\tusing plugin &lt;%s&gt;\n&quot;, qPrintable(plugin));</a>
<a name="ln3539">                  mscore-&gt;pluginTriggered(0);</a>
<a name="ln3540">                  }</a>
<a name="ln3541">            mscore-&gt;unloadPlugins();</a>
<a name="ln3542">            }</a>
<a name="ln3543">      for (const QJsonValue&amp; outFile : outFiles) {</a>
<a name="ln3544">            if (outFile.isArray()) {</a>
<a name="ln3545">                  QJsonArray fns = outFile.toArray();</a>
<a name="ln3546">                  if (fns.size() != 2 || !fns[0].isString() || !fns[1].isString()) {</a>
<a name="ln3547">                        fprintf(stderr, &quot;out element array length or type mismatch: %s\n&quot;,</a>
<a name="ln3548">                                QJsonDocument(QJsonArray{outFile}).toJson().constData());</a>
<a name="ln3549">                        return false;</a>
<a name="ln3550">                        }</a>
<a name="ln3551">                  if (cs-&gt;excerpts().size() == 0)</a>
<a name="ln3552">                        // no parts, silently ignore</a>
<a name="ln3553">                        continue;</a>
<a name="ln3554">                  // convert parts</a>
<a name="ln3555">                  QString fnbeg = fns[0].toString();</a>
<a name="ln3556">                  QString fnend = fns[1].toString();</a>
<a name="ln3557">                  for (Excerpt* e : cs-&gt;excerpts()) {</a>
<a name="ln3558">                        Score* pScore = e-&gt;partScore();</a>
<a name="ln3559">                        QString partfn = fnbeg + mscore-&gt;saveFilename(pScore-&gt;title()) + fnend;</a>
<a name="ln3560">                        fprintf(stderr, &quot;\tpart &lt;%s&gt;\n&quot;, qPrintable(partfn));</a>
<a name="ln3561">                        QFileInfo fi(partfn);</a>
<a name="ln3562">                        if (!mscore-&gt;saveAs(pScore, true, partfn, fi.suffix()))</a>
<a name="ln3563">                              return false;</a>
<a name="ln3564">                        }</a>
<a name="ln3565">                  }</a>
<a name="ln3566">            else if (!outFile.isString()) {</a>
<a name="ln3567">                  fprintf(stderr, &quot;out element type mismatch: %s\n&quot;,</a>
<a name="ln3568">                          QJsonDocument(QJsonArray{outFile}).toJson().constData());</a>
<a name="ln3569">                  return false;</a>
<a name="ln3570">                  }</a>
<a name="ln3571">            else {</a>
<a name="ln3572">                  QString fn = outFile.toString();</a>
<a name="ln3573">                  fprintf(stderr, &quot;\tto &lt;%s&gt;\n&quot;, qPrintable(fn));</a>
<a name="ln3574">                  if (!doConvert(cs, fn))</a>
<a name="ln3575">                        return false;</a>
<a name="ln3576">                  }</a>
<a name="ln3577">            }</a>
<a name="ln3578">      // don’t bother cleaning up layoutMode:</a>
<a name="ln3579">      // cs is destroyed immediately after return anyway</a>
<a name="ln3580">      return true;</a>
<a name="ln3581">      }</a>
<a name="ln3582"> </a>
<a name="ln3583">static bool doConvert(Score *cs, const QString&amp; fn)</a>
<a name="ln3584">      {</a>
<a name="ln3585">      if (fn.endsWith(&quot;.mscx&quot;)) {</a>
<a name="ln3586">            QFileInfo fi(fn);</a>
<a name="ln3587">            return cs-&gt;saveFile(fi);</a>
<a name="ln3588">            }</a>
<a name="ln3589">      else if (fn.endsWith(&quot;.mscz&quot;)) {</a>
<a name="ln3590">            QFileInfo fi(fn);</a>
<a name="ln3591">            return cs-&gt;saveCompressedFile(fi, false);</a>
<a name="ln3592">            }</a>
<a name="ln3593">      else if (fn.endsWith(&quot;.xml&quot;) || fn.endsWith(&quot;.musicxml&quot;))</a>
<a name="ln3594">            return saveXml(cs, fn);</a>
<a name="ln3595">      else if (fn.endsWith(&quot;.mxl&quot;))</a>
<a name="ln3596">            return saveMxl(cs, fn);</a>
<a name="ln3597">      else if (fn.endsWith(&quot;.mid&quot;))</a>
<a name="ln3598">            return mscore-&gt;saveMidi(cs, fn);</a>
<a name="ln3599">      else if (fn.endsWith(&quot;.pdf&quot;)) {</a>
<a name="ln3600">            if (!exportScoreParts)</a>
<a name="ln3601">                  return mscore-&gt;savePdf(cs, fn);</a>
<a name="ln3602">            if (cs-&gt;excerpts().size() == 0) {</a>
<a name="ln3603">                  auto excerpts = Excerpt::createAllExcerpt(cs-&gt;masterScore());</a>
<a name="ln3604"> </a>
<a name="ln3605">                  for (Excerpt* e : excerpts) {</a>
<a name="ln3606">                        Score* nscore = new Score(e-&gt;oscore());</a>
<a name="ln3607">                        e-&gt;setPartScore(nscore);</a>
<a name="ln3608">                        nscore-&gt;style().set(Sid::createMultiMeasureRests, true);</a>
<a name="ln3609">                        cs-&gt;startCmd();</a>
<a name="ln3610">                        cs-&gt;undo(new AddExcerpt(e));</a>
<a name="ln3611">                        Excerpt::createExcerpt(e);</a>
<a name="ln3612">                        cs-&gt;endCmd();</a>
<a name="ln3613">                        }</a>
<a name="ln3614">                  }</a>
<a name="ln3615">            QList&lt;Score*&gt; scores;</a>
<a name="ln3616">            scores.append(cs);</a>
<a name="ln3617">            for (Excerpt* e : cs-&gt;excerpts())</a>
<a name="ln3618">                  scores.append(e-&gt;partScore());</a>
<a name="ln3619">            return mscore-&gt;savePdf(scores, fn);</a>
<a name="ln3620">            }</a>
<a name="ln3621">      else if (fn.endsWith(&quot;.png&quot;)) {</a>
<a name="ln3622">            if (!exportScoreParts)</a>
<a name="ln3623">                  return mscore-&gt;savePng(cs, fn);</a>
<a name="ln3624">            if (cs-&gt;excerpts().size() == 0) {</a>
<a name="ln3625">                  auto excerpts = Excerpt::createAllExcerpt(cs-&gt;masterScore());</a>
<a name="ln3626"> </a>
<a name="ln3627">                  for (Excerpt* e: excerpts) {</a>
<a name="ln3628">                        Score* nscore = new Score(e-&gt;oscore());</a>
<a name="ln3629">                        e-&gt;setPartScore(nscore);</a>
<a name="ln3630">                        nscore-&gt;setExcerpt(e);</a>
<a name="ln3631">                        // nscore-&gt;setName(e-&gt;title()); // needed before AddExcerpt</a>
<a name="ln3632">                        nscore-&gt;style().set(Sid::createMultiMeasureRests, true);</a>
<a name="ln3633">                        cs-&gt;startCmd();</a>
<a name="ln3634">                        cs-&gt;undo(new AddExcerpt(e));</a>
<a name="ln3635">                        Excerpt::createExcerpt(e);</a>
<a name="ln3636">                        cs-&gt;endCmd();</a>
<a name="ln3637">                        }</a>
<a name="ln3638">                  }</a>
<a name="ln3639">            if (!mscore-&gt;savePng(cs, fn))</a>
<a name="ln3640">                  return false;</a>
<a name="ln3641">            int idx = 0;</a>
<a name="ln3642">            int padding = QString(&quot;%1&quot;).arg(cs-&gt;excerpts().size()).size();</a>
<a name="ln3643">            for (Excerpt* e: cs-&gt;excerpts()) {</a>
<a name="ln3644">                  QString suffix = QString(&quot;__excerpt__%1.png&quot;).arg(idx, padding, 10, QLatin1Char('0'));</a>
<a name="ln3645">                  QString excerptFn = fn.left(fn.size() - 4) + suffix;</a>
<a name="ln3646">                  if (!mscore-&gt;savePng(e-&gt;partScore(), excerptFn))</a>
<a name="ln3647">                        return false;</a>
<a name="ln3648">                  idx++;</a>
<a name="ln3649">                  }</a>
<a name="ln3650">            return true;</a>
<a name="ln3651">            }</a>
<a name="ln3652">      else if (fn.endsWith(&quot;.svg&quot;))</a>
<a name="ln3653">            return mscore-&gt;saveSvg(cs, fn);</a>
<a name="ln3654">#ifdef HAS_AUDIOFILE</a>
<a name="ln3655">      else if (fn.endsWith(&quot;.wav&quot;) || fn.endsWith(&quot;.ogg&quot;) || fn.endsWith(&quot;.flac&quot;))</a>
<a name="ln3656">            return mscore-&gt;saveAudio(cs, fn);</a>
<a name="ln3657">#endif</a>
<a name="ln3658">#ifdef USE_LAME</a>
<a name="ln3659">      else if (fn.endsWith(&quot;.mp3&quot;))</a>
<a name="ln3660">            return mscore-&gt;saveMp3(cs, fn);</a>
<a name="ln3661">#endif</a>
<a name="ln3662">      else if (fn.endsWith(&quot;.spos&quot;))</a>
<a name="ln3663">            return mscore-&gt;savePositions(cs, fn, true);</a>
<a name="ln3664">      else if (fn.endsWith(&quot;.mpos&quot;))</a>
<a name="ln3665">            return mscore-&gt;savePositions(cs, fn, false);</a>
<a name="ln3666">      else if (fn.endsWith(&quot;.mlog&quot;))</a>
<a name="ln3667">            return cs-&gt;sanityCheck(fn);</a>
<a name="ln3668">      else if (fn.endsWith(&quot;.metajson&quot;))</a>
<a name="ln3669">            return mscore-&gt;saveMetadataJSON(cs, fn);</a>
<a name="ln3670">      // unknown file type</a>
<a name="ln3671">      return false;</a>
<a name="ln3672">      }</a>
<a name="ln3673"> </a>
<a name="ln3674">//---------------------------------------------------------</a>
<a name="ln3675">//   convert</a>
<a name="ln3676">//---------------------------------------------------------</a>
<a name="ln3677"> </a>
<a name="ln3678">static bool convert(const QString&amp; inFile, const QJsonArray&amp; outFiles, const QString&amp; plugin = &quot;&quot;)</a>
<a name="ln3679">      {</a>
<a name="ln3680">      if (inFile.isEmpty() || (outFiles.isEmpty() &amp;&amp; plugin.isEmpty())) {</a>
<a name="ln3681">            fprintf(stderr, &quot;cannot convert &lt;%s&gt;: neither out nor plugin given\n&quot;, qPrintable(inFile));</a>
<a name="ln3682">            return false;</a>
<a name="ln3683">            }</a>
<a name="ln3684">      fprintf(stderr, &quot;convert &lt;%s&gt;...\n&quot;, qPrintable(inFile));</a>
<a name="ln3685">      MasterScore* score = mscore-&gt;readScore(inFile);</a>
<a name="ln3686">      if (!score)</a>
<a name="ln3687">            return false;</a>
<a name="ln3688">      mscore-&gt;setCurrentScore(score);</a>
<a name="ln3689">      if (!plugin.isEmpty()) {</a>
<a name="ln3690">            int index = mscore-&gt;appendScore(score);</a>
<a name="ln3691">            mscore-&gt;setCurrentView(index, 0);</a>
<a name="ln3692">            }</a>
<a name="ln3693">      bool success = doConvert(score, outFiles, plugin);</a>
<a name="ln3694">      fprintf(stderr, success ? &quot;... success!\n&quot; : &quot;... failed!\n&quot;);</a>
<a name="ln3695">      if (plugin.isEmpty())</a>
<a name="ln3696">            delete score;</a>
<a name="ln3697">      else</a>
<a name="ln3698">            mscore-&gt;closeScore(score);</a>
<a name="ln3699">      mscore-&gt;setCurrentScore(nullptr);</a>
<a name="ln3700">      return success;</a>
<a name="ln3701">      }</a>
<a name="ln3702"> </a>
<a name="ln3703">static bool convert(const QString&amp; inFile, const QString&amp; outFile)</a>
<a name="ln3704">      {</a>
<a name="ln3705">      if (pluginMode)</a>
<a name="ln3706">            return convert(inFile, QJsonArray{ outFile }, pluginName);</a>
<a name="ln3707">      else</a>
<a name="ln3708">            return convert(inFile, QJsonArray{ outFile });</a>
<a name="ln3709">      }</a>
<a name="ln3710"> </a>
<a name="ln3711">//---------------------------------------------------------</a>
<a name="ln3712">//   doProcessJob</a>
<a name="ln3713">//---------------------------------------------------------</a>
<a name="ln3714"> </a>
<a name="ln3715">static bool doProcessJob(QString jsonFile)</a>
<a name="ln3716">      {</a>
<a name="ln3717">      QFile f(jsonFile);</a>
<a name="ln3718">      if (!f.open(QIODevice::ReadOnly)) {</a>
<a name="ln3719">            fprintf(stderr, &quot;cannon open json file &lt;%s&gt;\n&quot;, qPrintable(jsonFile));</a>
<a name="ln3720">            return false;</a>
<a name="ln3721">            }</a>
<a name="ln3722">      QJsonParseError pe;</a>
<a name="ln3723">      QJsonDocument doc = QJsonDocument::fromJson(f.readAll(), &amp;pe);</a>
<a name="ln3724">      if (pe.error != QJsonParseError::NoError) {</a>
<a name="ln3725">            fprintf(stderr, &quot;error reading json file &lt;%s&gt; at %d: %s\n&quot;,</a>
<a name="ln3726">               qPrintable(jsonFile), pe.offset, qPrintable(pe.errorString()));</a>
<a name="ln3727">            return false;</a>
<a name="ln3728">            }</a>
<a name="ln3729">      if (!doc.isArray()) {</a>
<a name="ln3730">            fprintf(stderr, &quot;json file &lt;%s&gt; is not an array\n&quot;, qPrintable(jsonFile));</a>
<a name="ln3731">            return false;</a>
<a name="ln3732">            }</a>
<a name="ln3733">      QJsonArray a = doc.array();</a>
<a name="ln3734">      for (const auto i : a) {</a>
<a name="ln3735">            QString inFile;</a>
<a name="ln3736">            QJsonArray outFiles;</a>
<a name="ln3737">            QString plugin;</a>
<a name="ln3738">            if (!i.isObject()) {</a>
<a name="ln3739">                  fprintf(stderr, &quot;array value is not an object\n&quot;);</a>
<a name="ln3740">                  return false;</a>
<a name="ln3741">                  }</a>
<a name="ln3742">            QJsonObject obj = i.toObject();</a>
<a name="ln3743">            for (const auto&amp; key : obj.keys()) {</a>
<a name="ln3744">                  if (key == &quot;in&quot;)</a>
<a name="ln3745">                        inFile = obj.value(key).toString();</a>
<a name="ln3746">                  else if (key == &quot;out&quot;) {</a>
<a name="ln3747">                        if (obj.value(key).isArray())</a>
<a name="ln3748">                              outFiles = obj.value(key).toArray();</a>
<a name="ln3749">                        else</a>
<a name="ln3750">                              outFiles.push_back(obj.value(key));</a>
<a name="ln3751">                        }</a>
<a name="ln3752">                  else if (key == &quot;plugin&quot;)</a>
<a name="ln3753">                        plugin = obj.value(key).toString();</a>
<a name="ln3754">                  else {</a>
<a name="ln3755">                        fprintf(stderr, &quot;unknown key &lt;%s&gt;\n&quot;, qPrintable(key));</a>
<a name="ln3756">                        return false;</a>
<a name="ln3757">                        }</a>
<a name="ln3758">                  }</a>
<a name="ln3759">            if (!convert(inFile, outFiles, plugin))</a>
<a name="ln3760">                  return false;</a>
<a name="ln3761">            }</a>
<a name="ln3762">      return true;</a>
<a name="ln3763">      }</a>
<a name="ln3764"> </a>
<a name="ln3765">//---------------------------------------------------------</a>
<a name="ln3766">//   processNonGui</a>
<a name="ln3767">//---------------------------------------------------------</a>
<a name="ln3768"> </a>
<a name="ln3769">static bool processNonGui(const QStringList&amp; argv)</a>
<a name="ln3770">      {</a>
<a name="ln3771">      if (exportScoreMedia)</a>
<a name="ln3772">            return mscore-&gt;exportAllMediaFiles(argv[0]);</a>
<a name="ln3773">      if (exportScoreMeta)</a>
<a name="ln3774">            return mscore-&gt;exportScoreMetadata(argv[0]);</a>
<a name="ln3775">      else if (exportScoreMp3)</a>
<a name="ln3776">            return mscore-&gt;exportMp3AsJSON(argv[0]);</a>
<a name="ln3777">      else if (exportScorePartsPdf)</a>
<a name="ln3778">            return mscore-&gt;exportPartsPdfsToJSON(argv[0]);</a>
<a name="ln3779">      else if (exportTransposedScore)</a>
<a name="ln3780">            return mscore-&gt;exportTransposedScoreToJSON(argv[0], transposeExportOptions);</a>
<a name="ln3781"> </a>
<a name="ln3782">      if (pluginMode &amp;&amp; !converterMode) {</a>
<a name="ln3783">            loadScores(argv);</a>
<a name="ln3784">            QString pn(pluginName);</a>
<a name="ln3785">            bool res = false;</a>
<a name="ln3786">            if (mscore-&gt;loadPlugin(pn)){</a>
<a name="ln3787">                  Score* cs = mscore-&gt;currentScore();</a>
<a name="ln3788">                  if (!styleFile.isEmpty()) {</a>
<a name="ln3789">                        QFile f(styleFile);</a>
<a name="ln3790">                        if (f.open(QIODevice::ReadOnly))</a>
<a name="ln3791">                              cs-&gt;style().load(&amp;f);</a>
<a name="ln3792">                        }</a>
<a name="ln3793">                  LayoutMode layoutMode = cs-&gt;layoutMode();</a>
<a name="ln3794">                  if (layoutMode != LayoutMode::PAGE) {</a>
<a name="ln3795">                        cs-&gt;setLayoutMode(LayoutMode::PAGE);</a>
<a name="ln3796">                        cs-&gt;doLayout();</a>
<a name="ln3797">                        }</a>
<a name="ln3798">                  mscore-&gt;pluginTriggered(0);</a>
<a name="ln3799">                  if (layoutMode != cs-&gt;layoutMode()) {</a>
<a name="ln3800">                        cs-&gt;setLayoutMode(layoutMode);</a>
<a name="ln3801">                        cs-&gt;doLayout();</a>
<a name="ln3802">                        }</a>
<a name="ln3803">                  res = true;</a>
<a name="ln3804">                  }</a>
<a name="ln3805">            return res;</a>
<a name="ln3806">            }</a>
<a name="ln3807"> </a>
<a name="ln3808">      if (converterMode) {</a>
<a name="ln3809">            if (processJob)</a>
<a name="ln3810">                  return doProcessJob(jsonFileName);</a>
<a name="ln3811">            else</a>
<a name="ln3812">                  return convert(argv[0], outFileName);</a>
<a name="ln3813">            }</a>
<a name="ln3814"> </a>
<a name="ln3815">      if (!extensionName.isEmpty()) {</a>
<a name="ln3816">            QFileInfo fi(extensionName);</a>
<a name="ln3817">            QString suffix = fi.suffix().toLower();</a>
<a name="ln3818">            if (suffix == &quot;muxt&quot;)</a>
<a name="ln3819">                  return mscore-&gt;importExtension(extensionName);</a>
<a name="ln3820">            else {</a>
<a name="ln3821">                  fprintf(stderr, &quot;cannot install extension: &lt;%s&gt;\n&quot;, qPrintable(extensionName));</a>
<a name="ln3822">                  return false;</a>
<a name="ln3823">                  }</a>
<a name="ln3824">            }</a>
<a name="ln3825"> </a>
<a name="ln3826">      if (rawDiffMode || diffMode) {</a>
<a name="ln3827">            if (argv.size() != 2)</a>
<a name="ln3828">                  return false;</a>
<a name="ln3829">            MasterScore* s1 = mscore-&gt;readScore(argv[0]);</a>
<a name="ln3830">            MasterScore* s2 = mscore-&gt;readScore(argv[1]);</a>
<a name="ln3831">            if (!s1 || !s2)</a>
<a name="ln3832">                  return false;</a>
<a name="ln3833">            ScoreDiff diff(s1, s2, /* textDiffOnly */ !diffMode);</a>
<a name="ln3834"> </a>
<a name="ln3835">            if (rawDiffMode)</a>
<a name="ln3836">                  QTextStream(stdout) &lt;&lt; diff.rawDiff() &lt;&lt; endl;</a>
<a name="ln3837">            if (diffMode)</a>
<a name="ln3838">                  QTextStream(stdout) &lt;&lt; diff.userDiff() &lt;&lt; endl;</a>
<a name="ln3839"> </a>
<a name="ln3840">            delete s1;</a>
<a name="ln3841">            delete s2;</a>
<a name="ln3842">            }</a>
<a name="ln3843"> </a>
<a name="ln3844">      if (scriptTestMode)</a>
<a name="ln3845">            return mscore-&gt;runTestScripts(argv);</a>
<a name="ln3846"> </a>
<a name="ln3847">      return true;</a>
<a name="ln3848">      }</a>
<a name="ln3849"> </a>
<a name="ln3850">//---------------------------------------------------------</a>
<a name="ln3851">//   Message handler</a>
<a name="ln3852">//---------------------------------------------------------</a>
<a name="ln3853"> </a>
<a name="ln3854">#if defined(QT_DEBUG) &amp;&amp; defined(Q_OS_WIN)</a>
<a name="ln3855">static void mscoreMessageHandler(QtMsgType type, const QMessageLogContext &amp;context,const QString &amp;msg)</a>
<a name="ln3856">     {</a>
<a name="ln3857">     QTextStream err(stderr);</a>
<a name="ln3858">     QByteArray localMsg = msg.toLocal8Bit();</a>
<a name="ln3859"> </a>
<a name="ln3860">     switch (type) {</a>
<a name="ln3861">     case QtInfoMsg:</a>
<a name="ln3862">         err &lt;&lt; &quot;Info: &quot;     &lt;&lt; localMsg.constData() &lt;&lt; &quot; (&quot;  &lt;&lt; context.file &lt;&lt; &quot;:&quot; &lt;&lt; context.line &lt;&lt; &quot;, &quot; &lt;&lt; context.function &lt;&lt; &quot;)&quot; &lt;&lt; endl;</a>
<a name="ln3863">         break;</a>
<a name="ln3864">     case QtDebugMsg:</a>
<a name="ln3865">         err &lt;&lt; &quot;Debug: &quot;    &lt;&lt; localMsg.constData() &lt;&lt; &quot; (&quot;  &lt;&lt; context.file &lt;&lt; &quot;:&quot; &lt;&lt; context.line &lt;&lt; &quot;, &quot; &lt;&lt; context.function &lt;&lt; &quot;)&quot; &lt;&lt; endl;</a>
<a name="ln3866">         break;</a>
<a name="ln3867">     case QtWarningMsg:</a>
<a name="ln3868">         err &lt;&lt; &quot;Warning: &quot;  &lt;&lt; localMsg.constData() &lt;&lt; &quot; (&quot;  &lt;&lt; context.file &lt;&lt; &quot;:&quot; &lt;&lt; context.line &lt;&lt; &quot;, &quot; &lt;&lt; context.function &lt;&lt; &quot;)&quot; &lt;&lt; endl;</a>
<a name="ln3869">         break;</a>
<a name="ln3870">     case QtCriticalMsg: // same as QtSystemMsg</a>
<a name="ln3871">         err &lt;&lt; &quot;Critical: &quot; &lt;&lt; localMsg.constData() &lt;&lt; &quot; (&quot;  &lt;&lt; context.file &lt;&lt; &quot;:&quot; &lt;&lt; context.line &lt;&lt; &quot;, &quot; &lt;&lt; context.function &lt;&lt; &quot;)&quot; &lt;&lt; endl;</a>
<a name="ln3872">         break;</a>
<a name="ln3873">     case QtFatalMsg: // set your breakpoint here, if you want to catch the abort</a>
<a name="ln3874">         err &lt;&lt; &quot;Fatal: &quot;    &lt;&lt; localMsg.constData() &lt;&lt; &quot; (&quot;  &lt;&lt; context.file &lt;&lt; &quot;:&quot; &lt;&lt; context.line &lt;&lt; &quot;, &quot; &lt;&lt; context.function &lt;&lt; &quot;)&quot; &lt;&lt; endl;</a>
<a name="ln3875">         abort();</a>
<a name="ln3876">         }</a>
<a name="ln3877">     }</a>
<a name="ln3878">#endif</a>
<a name="ln3879"> </a>
<a name="ln3880">//---------------------------------------------------------</a>
<a name="ln3881">//   synthesizerFactory</a>
<a name="ln3882">//    create and initialize the master synthesizer</a>
<a name="ln3883">//---------------------------------------------------------</a>
<a name="ln3884"> </a>
<a name="ln3885">MasterSynthesizer* synthesizerFactory()</a>
<a name="ln3886">      {</a>
<a name="ln3887">      MasterSynthesizer* ms = new MasterSynthesizer();</a>
<a name="ln3888"> </a>
<a name="ln3889">      FluidS::Fluid* fluid = new FluidS::Fluid();</a>
<a name="ln3890">      ms-&gt;registerSynthesizer(fluid);</a>
<a name="ln3891"> </a>
<a name="ln3892">#ifdef AEOLUS</a>
<a name="ln3893">      ms-&gt;registerSynthesizer(::createAeolus());</a>
<a name="ln3894">#endif</a>
<a name="ln3895">#ifdef ZERBERUS</a>
<a name="ln3896">      ms-&gt;registerSynthesizer(createZerberus());</a>
<a name="ln3897">#endif</a>
<a name="ln3898">      ms-&gt;registerEffect(0, new NoEffect);</a>
<a name="ln3899">      ms-&gt;registerEffect(0, new ZitaReverb);</a>
<a name="ln3900">      ms-&gt;registerEffect(0, new Compressor);</a>
<a name="ln3901">      // ms-&gt;registerEffect(0, new Freeverb);</a>
<a name="ln3902">      ms-&gt;registerEffect(1, new NoEffect);</a>
<a name="ln3903">      ms-&gt;registerEffect(1, new ZitaReverb);</a>
<a name="ln3904">      ms-&gt;registerEffect(1, new Compressor);</a>
<a name="ln3905">      // ms-&gt;registerEffect(1, new Freeverb);</a>
<a name="ln3906">      ms-&gt;setEffect(0, 1);</a>
<a name="ln3907">      ms-&gt;setEffect(1, 0);</a>
<a name="ln3908">      return ms;</a>
<a name="ln3909">      }</a>
<a name="ln3910"> </a>
<a name="ln3911">//---------------------------------------------------------</a>
<a name="ln3912">//   unstable</a>
<a name="ln3913">//---------------------------------------------------------</a>
<a name="ln3914"> </a>
<a name="ln3915">bool MuseScore::unstable()</a>
<a name="ln3916">      {</a>
<a name="ln3917">#ifdef MSCORE_UNSTABLE</a>
<a name="ln3918">      return true;</a>
<a name="ln3919">#else</a>
<a name="ln3920">      return false;</a>
<a name="ln3921">#endif</a>
<a name="ln3922">      }</a>
<a name="ln3923"> </a>
<a name="ln3924">//---------------------------------------------------------</a>
<a name="ln3925">//   MuseScoreApplication::event (mac only)</a>
<a name="ln3926">//---------------------------------------------------------</a>
<a name="ln3927"> </a>
<a name="ln3928">bool MuseScoreApplication::event(QEvent* event)</a>
<a name="ln3929">      {</a>
<a name="ln3930">      switch(event-&gt;type()) {</a>
<a name="ln3931">            case QEvent::FileOpen:</a>
<a name="ln3932">                  // store names of files requested to be loaded by OS X to be handled later</a>
<a name="ln3933">                  // this event is generated when a file is dragged onto the MuseScore icon</a>
<a name="ln3934">                  // in the dock and MuseScore is not running yet</a>
<a name="ln3935">                  paths.append(static_cast&lt;QFileOpenEvent *&gt;(event)-&gt;file());</a>
<a name="ln3936">                  return true;</a>
<a name="ln3937">            default:</a>
<a name="ln3938">                  return QtSingleApplication::event(event);</a>
<a name="ln3939">            }</a>
<a name="ln3940">      }</a>
<a name="ln3941"> </a>
<a name="ln3942">//---------------------------------------------------------</a>
<a name="ln3943">//   focusScoreView</a>
<a name="ln3944">//---------------------------------------------------------</a>
<a name="ln3945"> </a>
<a name="ln3946">void MuseScore::focusScoreView()</a>
<a name="ln3947">      {</a>
<a name="ln3948">      if (currentScoreView())</a>
<a name="ln3949">            currentScoreView()-&gt;setFocus();</a>
<a name="ln3950">      else</a>
<a name="ln3951">            mscore-&gt;setFocus();</a>
<a name="ln3952">      }</a>
<a name="ln3953"> </a>
<a name="ln3954">//---------------------------------------------------------</a>
<a name="ln3955">//   eventFilter</a>
<a name="ln3956">//---------------------------------------------------------</a>
<a name="ln3957"> </a>
<a name="ln3958">bool MuseScore::eventFilter(QObject *obj, QEvent *event)</a>
<a name="ln3959">      {</a>
<a name="ln3960">      switch(event-&gt;type()) {</a>
<a name="ln3961">#ifdef Q_OS_MAC</a>
<a name="ln3962">            case QEvent::FileOpen:</a>
<a name="ln3963">                  // open files requested to be loaded by OS X</a>
<a name="ln3964">                  // this event is generated when a file is dragged onto the MuseScore icon</a>
<a name="ln3965">                  // in the dock when MuseScore is already running</a>
<a name="ln3966">                  scoresOnCommandline = true;</a>
<a name="ln3967">                  handleMessage(static_cast&lt;QFileOpenEvent *&gt;(event)-&gt;file());</a>
<a name="ln3968">                  return true;</a>
<a name="ln3969">#endif</a>
<a name="ln3970">            case QEvent::MouseMove: {</a>
<a name="ln3971">                  QMouseEvent* me = static_cast&lt;QMouseEvent*&gt;(event);</a>
<a name="ln3972">                  globalX = me-&gt;globalX();</a>
<a name="ln3973">                  globalY = me-&gt;globalY();</a>
<a name="ln3974">                  return QMainWindow::eventFilter(obj, event);</a>
<a name="ln3975">                  }</a>
<a name="ln3976">            case QEvent::StatusTip:</a>
<a name="ln3977">                  return true; // prevent updates to the status bar</a>
<a name="ln3978">            case QEvent::KeyPress:</a>
<a name="ln3979">                  {</a>
<a name="ln3980">                  QKeyEvent* e = static_cast&lt;QKeyEvent*&gt;(event);</a>
<a name="ln3981">                  if(obj-&gt;isWidgetType() &amp;&amp; e-&gt;key() == Qt::Key_Escape &amp;&amp; e-&gt;modifiers() == Qt::NoModifier) {</a>
<a name="ln3982">                        // Close the search dialog when Escape is pressed:</a>
<a name="ln3983">                        if(_searchDialog != 0)</a>
<a name="ln3984">                              endSearch();</a>
<a name="ln3985">                        if (isActiveWindow()) {</a>
<a name="ln3986">                              obj-&gt;event(e);</a>
<a name="ln3987">                              focusScoreView();</a>
<a name="ln3988">                              return true;</a>
<a name="ln3989">                              }</a>
<a name="ln3990"> </a>
<a name="ln3991">                        QWidget* w = static_cast&lt;QWidget*&gt;(obj);</a>
<a name="ln3992">                        if (inspector()-&gt;isAncestorOf(w) ||</a>
<a name="ln3993">                           (selectionWindow &amp;&amp; selectionWindow-&gt;isAncestorOf(w))) {</a>
<a name="ln3994">                              activateWindow();</a>
<a name="ln3995">                              focusScoreView();</a>
<a name="ln3996">                              return true;</a>
<a name="ln3997">                              }</a>
<a name="ln3998">                        }</a>
<a name="ln3999">                  break;</a>
<a name="ln4000">                  }</a>
<a name="ln4001">            default:</a>
<a name="ln4002">                  return QMainWindow::eventFilter(obj, event);</a>
<a name="ln4003">            }</a>
<a name="ln4004">      return QMainWindow::eventFilter(obj, event);</a>
<a name="ln4005">      }</a>
<a name="ln4006"> </a>
<a name="ln4007">//---------------------------------------------------------</a>
<a name="ln4008">//   hasToCheckForUpdate</a>
<a name="ln4009">//---------------------------------------------------------</a>
<a name="ln4010"> </a>
<a name="ln4011">bool MuseScore::hasToCheckForUpdate()</a>
<a name="ln4012">      {</a>
<a name="ln4013">      if (ucheck)</a>
<a name="ln4014">            return ucheck-&gt;hasToCheck();</a>
<a name="ln4015">      else</a>
<a name="ln4016">            return false;</a>
<a name="ln4017">      }</a>
<a name="ln4018"> </a>
<a name="ln4019">//---------------------------------------------------------</a>
<a name="ln4020">//   hasToCheckForExtensionsUpdate</a>
<a name="ln4021">//---------------------------------------------------------</a>
<a name="ln4022"> </a>
<a name="ln4023">bool MuseScore::hasToCheckForExtensionsUpdate()</a>
<a name="ln4024">      {</a>
<a name="ln4025">      return packUChecker ? packUChecker-&gt;hasToCheck() : false;</a>
<a name="ln4026">      }</a>
<a name="ln4027"> </a>
<a name="ln4028">//---------------------------------------------------------</a>
<a name="ln4029">//   checkForUpdatesNoUI</a>
<a name="ln4030">//         Doesn't show any messages if software is up to date</a>
<a name="ln4031">//---------------------------------------------------------</a>
<a name="ln4032"> </a>
<a name="ln4033">void MuseScore::checkForUpdatesNoUI()</a>
<a name="ln4034">      {</a>
<a name="ln4035">      if (autoUpdater)</a>
<a name="ln4036">            autoUpdater-&gt;checkUpdates();</a>
<a name="ln4037">      else if (ucheck)</a>
<a name="ln4038">            ucheck-&gt;check(version(), false);</a>
<a name="ln4039">      }</a>
<a name="ln4040"> </a>
<a name="ln4041">//---------------------------------------------------------</a>
<a name="ln4042">//   checkForUpdatesUI</a>
<a name="ln4043">//          Show message like &quot;Software is up to date&quot; if software is up to date</a>
<a name="ln4044">//---------------------------------------------------------</a>
<a name="ln4045">void MuseScore::checkForUpdatesUI()</a>
<a name="ln4046">      {</a>
<a name="ln4047">      if (autoUpdater)</a>
<a name="ln4048">            autoUpdater-&gt;checkForUpdatesNow();</a>
<a name="ln4049">      else if (ucheck)</a>
<a name="ln4050">            ucheck-&gt;check(version(), true);</a>
<a name="ln4051">      }</a>
<a name="ln4052"> </a>
<a name="ln4053">//---------------------------------------------------------</a>
<a name="ln4054">//   checkForExtensionsUpdate</a>
<a name="ln4055">//---------------------------------------------------------</a>
<a name="ln4056"> </a>
<a name="ln4057">void MuseScore::checkForExtensionsUpdate()</a>
<a name="ln4058">      {</a>
<a name="ln4059">      if (packUChecker)</a>
<a name="ln4060">            packUChecker-&gt;check();</a>
<a name="ln4061">      }</a>
<a name="ln4062"> </a>
<a name="ln4063">//---------------------------------------------------------</a>
<a name="ln4064">//   readLanguages</a>
<a name="ln4065">//---------------------------------------------------------</a>
<a name="ln4066"> </a>
<a name="ln4067">bool MuseScore::readLanguages(const QString&amp; path)</a>
<a name="ln4068">      {</a>
<a name="ln4069">      //: The default language of the operating system. NOT a music system.</a>
<a name="ln4070">      _languages.append(LanguageItem(&quot;system&quot;, tr(&quot;System&quot;)));</a>
<a name="ln4071">      QFile qf(path);</a>
<a name="ln4072">      if (qf.exists()){</a>
<a name="ln4073">          QDomDocument doc;</a>
<a name="ln4074">          int line, column;</a>
<a name="ln4075">          QString err;</a>
<a name="ln4076">          if (!doc.setContent(&amp;qf, false, &amp;err, &amp;line, &amp;column)) {</a>
<a name="ln4077">                QString error;</a>
<a name="ln4078">                error.sprintf(qPrintable(tr(&quot;Error reading language file %s at line %d column %d: %s\n&quot;)),</a>
<a name="ln4079">                   qPrintable(qf.fileName()), line, column, qPrintable(err));</a>
<a name="ln4080">                QMessageBox::warning(0,</a>
<a name="ln4081">                   QWidget::tr(&quot;Load Languages Failed:&quot;),</a>
<a name="ln4082">                   error,</a>
<a name="ln4083">                   QString(), QWidget::tr(&quot;Quit&quot;), QString(), 0, 1);</a>
<a name="ln4084">                return false;</a>
<a name="ln4085">                }</a>
<a name="ln4086"> </a>
<a name="ln4087">          for (QDomElement e = doc.documentElement(); !e.isNull(); e = e.nextSiblingElement()) {</a>
<a name="ln4088">                if(e.tagName() == &quot;languages&quot;) {</a>
<a name="ln4089">                      for (e = e.firstChildElement(); !e.isNull(); e = e.nextSiblingElement()) {</a>
<a name="ln4090">                        if (e.tagName() == &quot;language&quot;) {</a>
<a name="ln4091">                              QString code = e.attribute(QString(&quot;code&quot;));</a>
<a name="ln4092">                              QString name = e.attribute(QString(&quot;name&quot;));</a>
<a name="ln4093">                              QString handbook = e.attribute(QString(&quot;handbook&quot;));</a>
<a name="ln4094">                              _languages.append(LanguageItem(code, name, handbook));</a>
<a name="ln4095">                              }</a>
<a name="ln4096">                          }</a>
<a name="ln4097">                      }</a>
<a name="ln4098">                }</a>
<a name="ln4099">            return true;</a>
<a name="ln4100">            }</a>
<a name="ln4101">      return false;</a>
<a name="ln4102">      }</a>
<a name="ln4103"> </a>
<a name="ln4104">//---------------------------------------------------------</a>
<a name="ln4105">//   clipboardChanged</a>
<a name="ln4106">//---------------------------------------------------------</a>
<a name="ln4107"> </a>
<a name="ln4108">void MuseScore::clipboardChanged()</a>
<a name="ln4109">      {</a>
<a name="ln4110">#if 0</a>
<a name="ln4111">      const QMimeData* ms = QApplication::clipboard()-&gt;mimeData();</a>
<a name="ln4112">      QStringList formats = ms-&gt;formats();</a>
<a name="ln4113"> </a>
<a name="ln4114">      bool flag = ms-&gt;hasFormat(mimeSymbolFormat)</a>
<a name="ln4115">            ||    ms-&gt;hasFormat(mimeStaffListFormat)</a>
<a name="ln4116">            ||    ms-&gt;hasFormat(mimeSymbolListFormat)</a>
<a name="ln4117">            ||    ms-&gt;hasText();</a>
<a name="ln4118">      // TODO: depends on selection state</a>
<a name="ln4119">#endif</a>
<a name="ln4120"> </a>
<a name="ln4121">      bool flag = true;</a>
<a name="ln4122">      getAction(&quot;paste&quot;)-&gt;setEnabled(flag);</a>
<a name="ln4123">      getAction(&quot;swap&quot;)-&gt;setEnabled(flag);</a>
<a name="ln4124">      }</a>
<a name="ln4125"> </a>
<a name="ln4126">//---------------------------------------------------------</a>
<a name="ln4127">//   inputMethodAnchorRectangleChanged</a>
<a name="ln4128">//---------------------------------------------------------</a>
<a name="ln4129"> </a>
<a name="ln4130">void MuseScore::inputMethodAnchorRectangleChanged()</a>
<a name="ln4131">      {</a>
<a name="ln4132">//      QRectF r =  QGuiApplication::inputMethod()-&gt;anchorRectangle();</a>
<a name="ln4133">//      qDebug(&quot;inputMethod AnchorRectangle Changed: (%f, %f) + (%f, %f)&quot;, r.x(), r.y(), r.width(), r.height());</a>
<a name="ln4134">      }</a>
<a name="ln4135"> </a>
<a name="ln4136">//---------------------------------------------------------</a>
<a name="ln4137">//   inputMethodAnimatingChanged</a>
<a name="ln4138">//---------------------------------------------------------</a>
<a name="ln4139"> </a>
<a name="ln4140">void MuseScore::inputMethodAnimatingChanged()</a>
<a name="ln4141">      {</a>
<a name="ln4142">//      qDebug(&quot;inputMethod Animating Changed: %d&quot;, QGuiApplication::inputMethod()-&gt;isAnimating());</a>
<a name="ln4143">      }</a>
<a name="ln4144"> </a>
<a name="ln4145">//---------------------------------------------------------</a>
<a name="ln4146">//   inputMethodCursorRectangleChanged</a>
<a name="ln4147">//---------------------------------------------------------</a>
<a name="ln4148"> </a>
<a name="ln4149">void MuseScore::inputMethodCursorRectangleChanged()</a>
<a name="ln4150">      {</a>
<a name="ln4151">//      QRectF r =  QGuiApplication::inputMethod()-&gt;cursorRectangle();</a>
<a name="ln4152">//      qDebug(&quot;inputMethod CursorRectangle Changed: (%f, %f) + (%f, %f)&quot;, r.x(), r.y(), r.width(), r.height());</a>
<a name="ln4153">      }</a>
<a name="ln4154"> </a>
<a name="ln4155">//---------------------------------------------------------</a>
<a name="ln4156">//   inputMethodInputDirectionChanged</a>
<a name="ln4157">//---------------------------------------------------------</a>
<a name="ln4158"> </a>
<a name="ln4159">void MuseScore::inputMethodInputDirectionChanged(Qt::LayoutDirection /*newDirection*/)</a>
<a name="ln4160">      {</a>
<a name="ln4161">//      qDebug(&quot;inputMethod InputDirection Changed: (QLocale::LayoutDirection enum) #%d&quot;, newDirection);</a>
<a name="ln4162">      }</a>
<a name="ln4163"> </a>
<a name="ln4164">//---------------------------------------------------------</a>
<a name="ln4165">//   inputMethodInputItemClipRectangleChanged</a>
<a name="ln4166">//---------------------------------------------------------</a>
<a name="ln4167"> </a>
<a name="ln4168">void MuseScore::inputMethodInputItemClipRectangleChanged()</a>
<a name="ln4169">      {</a>
<a name="ln4170">//      QRectF r =  QGuiApplication::inputMethod()-&gt;inputItemClipRectangle();</a>
<a name="ln4171">//      qDebug(&quot;inputMethod InputItemClipRectangle Changed: (%f, %f) + (%f, %f)&quot;, r.x(), r.y(), r.width(), r.height());</a>
<a name="ln4172">      }</a>
<a name="ln4173"> </a>
<a name="ln4174">//---------------------------------------------------------</a>
<a name="ln4175">//   inputMethodKeyboardRectangleChanged</a>
<a name="ln4176">//---------------------------------------------------------</a>
<a name="ln4177"> </a>
<a name="ln4178">void MuseScore::inputMethodKeyboardRectangleChanged()</a>
<a name="ln4179">      {</a>
<a name="ln4180">//      QRectF r =  QGuiApplication::inputMethod()-&gt;keyboardRectangle();</a>
<a name="ln4181">//      qDebug(&quot;inputMethod KeyboardRectangle Changed: (%f, %f) + (%f, %f)&quot;, r.x(), r.y(), r.width(), r.height());</a>
<a name="ln4182">      }</a>
<a name="ln4183"> </a>
<a name="ln4184">//---------------------------------------------------------</a>
<a name="ln4185">//   inputMethodLocaleChanged</a>
<a name="ln4186">//---------------------------------------------------------</a>
<a name="ln4187"> </a>
<a name="ln4188">void MuseScore::inputMethodLocaleChanged()</a>
<a name="ln4189">      {</a>
<a name="ln4190">//      qDebug(&quot;inputMethod Locale Changed: (QLocale::Script enum) #%d.&quot;, QGuiApplication::inputMethod()-&gt;locale().script());</a>
<a name="ln4191">      }</a>
<a name="ln4192"> </a>
<a name="ln4193">//---------------------------------------------------------</a>
<a name="ln4194">//   inputMethodVisibleChanged</a>
<a name="ln4195">//---------------------------------------------------------</a>
<a name="ln4196"> </a>
<a name="ln4197">void MuseScore::inputMethodVisibleChanged()</a>
<a name="ln4198">      {</a>
<a name="ln4199">//      qDebug(&quot;inputMethodVisibleChanged: %d&quot;, QGuiApplication::inputMethod()-&gt;isVisible());</a>
<a name="ln4200">      }</a>
<a name="ln4201"> </a>
<a name="ln4202">//---------------------------------------------------------</a>
<a name="ln4203">//   showModeText</a>
<a name="ln4204">//---------------------------------------------------------</a>
<a name="ln4205"> </a>
<a name="ln4206">void MuseScore::showModeText(const QString&amp; s)</a>
<a name="ln4207">      {</a>
<a name="ln4208">      _modeText-&gt;setText(s);</a>
<a name="ln4209">      _modeText-&gt;show();</a>
<a name="ln4210">      }</a>
<a name="ln4211"> </a>
<a name="ln4212">//---------------------------------------------------------</a>
<a name="ln4213">//   changeState</a>
<a name="ln4214">//---------------------------------------------------------</a>
<a name="ln4215"> </a>
<a name="ln4216">void MuseScore::changeState(ScoreState val)</a>
<a name="ln4217">      {</a>
<a name="ln4218">      if (MScore::debugMode)</a>
<a name="ln4219">            qDebug(&quot;MuseScore::changeState: %s&quot;, stateName(val));</a>
<a name="ln4220"> </a>
<a name="ln4221">      // disallow change to edit modes if currently in play mode</a>
<a name="ln4222">      if (_sstate == STATE_PLAY &amp;&amp; (val == STATE_EDIT || val &amp; STATE_ALLTEXTUAL_EDIT || val &amp; STATE_NOTE_ENTRY))</a>
<a name="ln4223">            return;</a>
<a name="ln4224"> </a>
<a name="ln4225">      static const char* stdNames[] = {</a>
<a name="ln4226">            &quot;note-longa&quot;, &quot;note-breve&quot;, &quot;pad-note-1&quot;, &quot;pad-note-2&quot;, &quot;pad-note-4&quot;,</a>
<a name="ln4227">      &quot;pad-note-8&quot;, &quot;pad-note-16&quot;, &quot;pad-note-32&quot;, &quot;pad-note-64&quot;, &quot;pad-note-128&quot;, &quot;pad-rest&quot;, &quot;rest&quot;};</a>
<a name="ln4228">      static const char* tabNames[] = {</a>
<a name="ln4229">            &quot;note-longa-TAB&quot;, &quot;note-breve-TAB&quot;, &quot;pad-note-1-TAB&quot;, &quot;pad-note-2-TAB&quot;, &quot;pad-note-4-TAB&quot;,</a>
<a name="ln4230">      &quot;pad-note-8-TAB&quot;, &quot;pad-note-16-TAB&quot;, &quot;pad-note-32-TAB&quot;, &quot;pad-note-64-TAB&quot;, &quot;pad-note-128-TAB&quot;, &quot;pad-rest-TAB&quot;, &quot;rest-TAB&quot;};</a>
<a name="ln4231">      bool intoTAB = (_sstate != STATE_NOTE_ENTRY_STAFF_TAB) &amp;&amp; (val == STATE_NOTE_ENTRY_STAFF_TAB);</a>
<a name="ln4232">      bool fromTAB = (_sstate == STATE_NOTE_ENTRY_STAFF_TAB) &amp;&amp; (val != STATE_NOTE_ENTRY_STAFF_TAB);</a>
<a name="ln4233">      // if activating TAB note entry, swap &quot;pad-note-...-TAB&quot; shorctuts into &quot;pad-note-...&quot; actions</a>
<a name="ln4234">      if (intoTAB) {</a>
<a name="ln4235">            for (unsigned i = 0; i &lt; sizeof(stdNames)/sizeof(char*); ++i) {</a>
<a name="ln4236">                  QAction* act = getAction(stdNames[i]);</a>
<a name="ln4237">                  const Shortcut* srt = Shortcut::getShortcut(tabNames[i]);</a>
<a name="ln4238">                  act-&gt;setShortcuts(srt-&gt;keys());</a>
<a name="ln4239">                  }</a>
<a name="ln4240">            }</a>
<a name="ln4241">      // if de-ativating TAB note entry, restore shortcuts for &quot;pad-note-...&quot; actions</a>
<a name="ln4242">      else if (fromTAB) {</a>
<a name="ln4243">            for (unsigned i = 0; i &lt; sizeof(stdNames)/sizeof(char*); ++i) {</a>
<a name="ln4244">                  QAction* act = getAction(stdNames[i]);</a>
<a name="ln4245">                  const Shortcut* srt = Shortcut::getShortcut(stdNames[i]);</a>
<a name="ln4246">                  act-&gt;setShortcuts(srt-&gt;keys());</a>
<a name="ln4247">                  }</a>
<a name="ln4248">            }</a>
<a name="ln4249"> </a>
<a name="ln4250">      bool enable = (val != STATE_DISABLED) &amp;&amp; (val != STATE_LOCK);</a>
<a name="ln4251"> </a>
<a name="ln4252">      for (const Shortcut* s : Shortcut::shortcuts()) {</a>
<a name="ln4253">            QAction* a = s-&gt;action();</a>
<a name="ln4254">            if (!a)</a>
<a name="ln4255">                  continue;</a>
<a name="ln4256">            if (enable &amp;&amp; (s-&gt;key() == &quot;undo&quot;))</a>
<a name="ln4257">                  a-&gt;setEnabled((s-&gt;state() &amp; val) &amp;&amp; (cs ? cs-&gt;undoStack()-&gt;canUndo() : false));</a>
<a name="ln4258">            else if (enable &amp;&amp; (s-&gt;key() == &quot;redo&quot;))</a>
<a name="ln4259">                  a-&gt;setEnabled((s-&gt;state() &amp; val) &amp;&amp; (cs ? cs-&gt;undoStack()-&gt;canRedo() : false));</a>
<a name="ln4260">            else if (enable &amp;&amp; (s-&gt;key() == &quot;cut&quot;))</a>
<a name="ln4261">                  a-&gt;setEnabled(cs &amp;&amp; cs-&gt;selection().state() != SelState::NONE);</a>
<a name="ln4262">            else if (enable &amp;&amp; (s-&gt;key() == &quot;copy&quot;))</a>
<a name="ln4263">                  a-&gt;setEnabled(cs &amp;&amp; (cs-&gt;selection().state() != SelState::NONE || val == STATE_FOTO));</a>
<a name="ln4264">            else if (enable &amp;&amp; (s-&gt;key() == &quot;select-similar-range&quot;))</a>
<a name="ln4265">                  a-&gt;setEnabled(cs &amp;&amp; cs-&gt;selection().state() == SelState::RANGE);</a>
<a name="ln4266">            else if (enable &amp;&amp; (s-&gt;key() == &quot;synth-control&quot; || s-&gt;key() == &quot;toggle-mixer&quot;)) {</a>
<a name="ln4267">                  Driver* driver = seq ? seq-&gt;driver() : 0;</a>
<a name="ln4268">                  // a-&gt;setEnabled(driver &amp;&amp; driver-&gt;getSynth());</a>
<a name="ln4269">                  if (MScore::debugMode)</a>
<a name="ln4270">                        qDebug(&quot;disable synth control&quot;);</a>
<a name="ln4271">                  a-&gt;setEnabled(driver);</a>
<a name="ln4272">                  }</a>
<a name="ln4273">            else {</a>
<a name="ln4274">                  a-&gt;setEnabled(s-&gt;state() &amp; val);</a>
<a name="ln4275">                  }</a>
<a name="ln4276">            }</a>
<a name="ln4277"> </a>
<a name="ln4278">      if (getAction(&quot;file-part-export&quot;)-&gt;isEnabled())</a>
<a name="ln4279">            getAction(&quot;file-part-export&quot;)-&gt;setEnabled(cs &amp;&amp; cs-&gt;masterScore()-&gt;excerpts().size() &gt; 0);</a>
<a name="ln4280">      if (getAction(&quot;join-measures&quot;)-&gt;isEnabled())</a>
<a name="ln4281">            getAction(&quot;join-measures&quot;)-&gt;setEnabled(cs &amp;&amp; cs-&gt;masterScore()-&gt;excerpts().size() == 0);</a>
<a name="ln4282">      if (getAction(&quot;split-measure&quot;)-&gt;isEnabled())</a>
<a name="ln4283">            getAction(&quot;split-measure&quot;)-&gt;setEnabled(cs &amp;&amp; cs-&gt;masterScore()-&gt;excerpts().size() == 0);</a>
<a name="ln4284"> </a>
<a name="ln4285">      // disabling top level menu entries does not</a>
<a name="ln4286">      // work for MAC</a>
<a name="ln4287"> </a>
<a name="ln4288">      QList&lt;QObject*&gt; ol = menuBar()-&gt;children();</a>
<a name="ln4289">      foreach(QObject* o, ol) {</a>
<a name="ln4290">            QMenu* menu = qobject_cast&lt;QMenu*&gt;(o);</a>
<a name="ln4291">            if (!menu)</a>
<a name="ln4292">                  continue;</a>
<a name="ln4293">            QString s(menu-&gt;objectName());</a>
<a name="ln4294">            if (s == &quot;File&quot; || s == &quot;Help&quot; || s == &quot;Edit&quot; || s == &quot;Plugins&quot; || s == &quot;View&quot;)</a>
<a name="ln4295">                  continue;</a>
<a name="ln4296">            menu-&gt;setEnabled(enable);</a>
<a name="ln4297">            }</a>
<a name="ln4298"> </a>
<a name="ln4299">      menuWorkspaces-&gt;setEnabled(enable);</a>
<a name="ln4300"> </a>
<a name="ln4301">      transportTools-&gt;setEnabled(enable &amp;&amp; !noSeq &amp;&amp; seq &amp;&amp; seq-&gt;isRunning());</a>
<a name="ln4302">      cpitchTools-&gt;setEnabled(enable);</a>
<a name="ln4303">      mag-&gt;setEnabled(enable);</a>
<a name="ln4304">      entryTools-&gt;setEnabled(enable);</a>
<a name="ln4305"> </a>
<a name="ln4306">      if (_sstate == STATE_FOTO)</a>
<a name="ln4307">            updateInspector();</a>
<a name="ln4308"> </a>
<a name="ln4309">      //always hide drumtools to support hiding on switching docs, switching node entry mode off, etc.</a>
<a name="ln4310">      //it will be shown later if (_sstate == STATE_NOTE_ENTRY_STAFF_DRUM)</a>
<a name="ln4311">      showDrumTools(0, 0);</a>
<a name="ln4312"> </a>
<a name="ln4313">      switch (val) {</a>
<a name="ln4314">            case STATE_DISABLED:</a>
<a name="ln4315">                  showModeText(tr(&quot;No score&quot;));</a>
<a name="ln4316">                  if (debugger)</a>
<a name="ln4317">                        debugger-&gt;hide();</a>
<a name="ln4318">                  showPianoKeyboard(false);</a>
<a name="ln4319">                  break;</a>
<a name="ln4320">            case STATE_NORMAL:</a>
<a name="ln4321">                  _modeText-&gt;hide();</a>
<a name="ln4322">                  break;</a>
<a name="ln4323">            case STATE_NOTE_ENTRY:</a>
<a name="ln4324">                  if (cv &amp;&amp; !cv-&gt;noteEntryMode())</a>
<a name="ln4325">                        cv-&gt;cmd(&quot;note-input&quot;);</a>
<a name="ln4326">                  // fall through</a>
<a name="ln4327">            case STATE_NOTE_ENTRY_STAFF_PITCHED:</a>
<a name="ln4328">                  if (getAction(&quot;note-input-repitch&quot;)-&gt;isChecked()) {</a>
<a name="ln4329">                        showModeText(tr(&quot;Repitch input mode&quot;));</a>
<a name="ln4330">                        cs-&gt;setNoteEntryMethod(NoteEntryMethod::REPITCH);</a>
<a name="ln4331">                        val = STATE_NOTE_ENTRY_METHOD_REPITCH;</a>
<a name="ln4332">                        }</a>
<a name="ln4333">                  else if (getAction(&quot;note-input-rhythm&quot;)-&gt;isChecked()) {</a>
<a name="ln4334">                        showModeText(tr(&quot;Rhythm input mode&quot;));</a>
<a name="ln4335">                        cs-&gt;setNoteEntryMethod(NoteEntryMethod::RHYTHM);</a>
<a name="ln4336">                        val = STATE_NOTE_ENTRY_METHOD_RHYTHM;</a>
<a name="ln4337">                        }</a>
<a name="ln4338">                  else if (getAction(&quot;note-input-realtime-auto&quot;)-&gt;isChecked()) {</a>
<a name="ln4339">                        showModeText(tr(&quot;Realtime (automatic) note input mode&quot;));</a>
<a name="ln4340">                        cs-&gt;setNoteEntryMethod(NoteEntryMethod::REALTIME_AUTO);</a>
<a name="ln4341">                        val = STATE_NOTE_ENTRY_METHOD_REALTIME_AUTO;</a>
<a name="ln4342">                        }</a>
<a name="ln4343">                  else if (getAction(&quot;note-input-realtime-manual&quot;)-&gt;isChecked()) {</a>
<a name="ln4344">                        showModeText(tr(&quot;Realtime (manual) note input mode&quot;));</a>
<a name="ln4345">                        cs-&gt;setNoteEntryMethod(NoteEntryMethod::REALTIME_MANUAL);</a>
<a name="ln4346">                        val = STATE_NOTE_ENTRY_METHOD_REALTIME_MANUAL;</a>
<a name="ln4347">                        }</a>
<a name="ln4348">                  else if (getAction(&quot;note-input-timewise&quot;)-&gt;isChecked()) {</a>
<a name="ln4349">                        showModeText(tr(&quot;Insert mode&quot;));</a>
<a name="ln4350">                        cs-&gt;setNoteEntryMethod(NoteEntryMethod::TIMEWISE);</a>
<a name="ln4351">                        val = STATE_NOTE_ENTRY_METHOD_TIMEWISE;</a>
<a name="ln4352">                        }</a>
<a name="ln4353">                  else {</a>
<a name="ln4354">                        showModeText(tr(&quot;Steptime note input mode&quot;));</a>
<a name="ln4355">                        cs-&gt;setNoteEntryMethod(NoteEntryMethod::STEPTIME);</a>
<a name="ln4356">                        val = STATE_NOTE_ENTRY_METHOD_STEPTIME;</a>
<a name="ln4357">                        }</a>
<a name="ln4358">                  break;</a>
<a name="ln4359">            case STATE_NOTE_ENTRY_STAFF_DRUM:</a>
<a name="ln4360">                  {</a>
<a name="ln4361">                  if (getAction(&quot;note-input-repitch&quot;)-&gt;isChecked())</a>
<a name="ln4362">                        cs-&gt;setNoteEntryMethod(NoteEntryMethod::REPITCH);</a>
<a name="ln4363">                  showModeText(tr(&quot;Drumset input mode&quot;));</a>
<a name="ln4364">                  InputState&amp; is = cs-&gt;inputState();</a>
<a name="ln4365">                  showDrumTools(is.drumset(), cs-&gt;staff(is.track() / VOICES));</a>
<a name="ln4366">                  if (_drumTools)</a>
<a name="ln4367">                        is.setDrumNote(_drumTools-&gt;selectedDrumNote());</a>
<a name="ln4368">                  }</a>
<a name="ln4369">                  break;</a>
<a name="ln4370">            case STATE_NOTE_ENTRY_STAFF_TAB:</a>
<a name="ln4371">                  showModeText(tr(&quot;TAB input mode&quot;));</a>
<a name="ln4372">                  break;</a>
<a name="ln4373">            case STATE_EDIT:</a>
<a name="ln4374">                  showModeText(tr(&quot;Edit mode&quot;));</a>
<a name="ln4375">                  break;</a>
<a name="ln4376">            case STATE_TEXT_EDIT:</a>
<a name="ln4377">                  showModeText(tr(&quot;Text edit mode&quot;));</a>
<a name="ln4378">                  break;</a>
<a name="ln4379">            case STATE_LYRICS_EDIT:</a>
<a name="ln4380">                  showModeText(tr(&quot;Lyrics edit mode&quot;));</a>
<a name="ln4381">                  break;</a>
<a name="ln4382">            case STATE_HARMONY_FIGBASS_EDIT:</a>
<a name="ln4383">                  showModeText(tr(&quot;Chord symbol/figured bass edit mode&quot;));</a>
<a name="ln4384">                  break;</a>
<a name="ln4385">            case STATE_PLAY:</a>
<a name="ln4386">                  showModeText(tr(&quot;Play&quot;));</a>
<a name="ln4387">                  break;</a>
<a name="ln4388">            case STATE_FOTO:</a>
<a name="ln4389">                  showModeText(tr(&quot;Image capture mode&quot;));</a>
<a name="ln4390">                  updateInspector();</a>
<a name="ln4391">                  break;</a>
<a name="ln4392">            case STATE_LOCK:</a>
<a name="ln4393">                  showModeText(tr(&quot;Score locked&quot;));</a>
<a name="ln4394">                  break;</a>
<a name="ln4395">            default:</a>
<a name="ln4396">                  qFatal(&quot;MuseScore::changeState: illegal state %d&quot;, val);</a>
<a name="ln4397">                  break;</a>
<a name="ln4398">            }</a>
<a name="ln4399">      if (paletteWidget)</a>
<a name="ln4400">            paletteWidget-&gt;setDisabled(val == STATE_PLAY || val == STATE_DISABLED);</a>
<a name="ln4401">      if (selectionWindow)</a>
<a name="ln4402">            selectionWindow-&gt;setDisabled(val == STATE_PLAY || val == STATE_DISABLED);</a>
<a name="ln4403">      QAction* a = getAction(&quot;note-input&quot;);</a>
<a name="ln4404">      bool noteEntry = val &amp; STATE_NOTE_ENTRY;</a>
<a name="ln4405">      a-&gt;setChecked(noteEntry);</a>
<a name="ln4406">      _sstate = val;</a>
<a name="ln4407"> </a>
<a name="ln4408">      emit scoreStateChanged(_sstate);</a>
<a name="ln4409"> </a>
<a name="ln4410">      Element* e = cv &amp;&amp; (_sstate &amp; STATE_ALLTEXTUAL_EDIT || _sstate == STATE_EDIT) ? cv-&gt;getEditElement() : 0;</a>
<a name="ln4411">      if (!e) {</a>
<a name="ln4412">            textTools()-&gt;hide();</a>
<a name="ln4413">            if (textTools()-&gt;kbAction()-&gt;isChecked())</a>
<a name="ln4414">                  textTools()-&gt;kbAction()-&gt;setChecked(false);</a>
<a name="ln4415">            }</a>
<a name="ln4416">      else {</a>
<a name="ln4417">            if (e-&gt;isTextBase()) {</a>
<a name="ln4418">                  textTools()-&gt;updateTools(cv-&gt;getEditData());</a>
<a name="ln4419">                  if (!(e-&gt;isFiguredBass() || e-&gt;isHarmony())) {  // do not show text tools for f.b.</a>
<a name="ln4420">                        if (timelineScrollArea() &amp;&amp; timelineScrollArea()-&gt;isVisible()) {</a>
<a name="ln4421">                              if (dockWidgetArea(timelineScrollArea()) != dockWidgetArea(textTools()) || timelineScrollArea()-&gt;isFloating()) {</a>
<a name="ln4422">                                    QSizePolicy policy(QSizePolicy::Maximum, QSizePolicy::Maximum);</a>
<a name="ln4423">                                    textTools()-&gt;widget()-&gt;setSizePolicy(policy);</a>
<a name="ln4424">                                    }</a>
<a name="ln4425">                              else {</a>
<a name="ln4426">                                    QSizePolicy policy(QSizePolicy::Expanding, QSizePolicy::Expanding);</a>
<a name="ln4427">                                    textTools()-&gt;widget()-&gt;setSizePolicy(policy);</a>
<a name="ln4428">                                    }</a>
<a name="ln4429">                              }</a>
<a name="ln4430">                        else {</a>
<a name="ln4431">                              QSizePolicy policy(QSizePolicy::Maximum, QSizePolicy::Maximum);</a>
<a name="ln4432">                              textTools()-&gt;widget()-&gt;setSizePolicy(policy);</a>
<a name="ln4433">                              }</a>
<a name="ln4434">                        if (timelineScrollArea())</a>
<a name="ln4435">                              splitDockWidget(textTools(), timelineScrollArea(), Qt::Vertical);</a>
<a name="ln4436">                        textTools()-&gt;show();</a>
<a name="ln4437">                        }</a>
<a name="ln4438">                  }</a>
<a name="ln4439">            if (_inspector)</a>
<a name="ln4440">                  _inspector-&gt;update(e-&gt;score());</a>
<a name="ln4441">            }</a>
<a name="ln4442">      }</a>
<a name="ln4443"> </a>
<a name="ln4444">//---------------------------------------------------------</a>
<a name="ln4445">//   saveDialogState</a>
<a name="ln4446">//---------------------------------------------------------</a>
<a name="ln4447"> </a>
<a name="ln4448">void MuseScore::saveDialogState(const char* name, QFileDialog* d)</a>
<a name="ln4449">      {</a>
<a name="ln4450">      if (d) {</a>
<a name="ln4451">            settings.beginGroup(name);</a>
<a name="ln4452">            settings.setValue(&quot;geometry&quot;, d-&gt;saveGeometry());</a>
<a name="ln4453">            settings.setValue(&quot;state&quot;, d-&gt;saveState());</a>
<a name="ln4454">            settings.endGroup();</a>
<a name="ln4455">            }</a>
<a name="ln4456">      }</a>
<a name="ln4457"> </a>
<a name="ln4458">//---------------------------------------------------------</a>
<a name="ln4459">//   restoreDialogState</a>
<a name="ln4460">//---------------------------------------------------------</a>
<a name="ln4461"> </a>
<a name="ln4462">void MuseScore::restoreDialogState(const char* name, QFileDialog* d)</a>
<a name="ln4463">      {</a>
<a name="ln4464">      settings.beginGroup(name);</a>
<a name="ln4465">      d-&gt;restoreGeometry(settings.value(&quot;geometry&quot;).toByteArray());</a>
<a name="ln4466">      d-&gt;restoreState(settings.value(&quot;state&quot;).toByteArray());</a>
<a name="ln4467">      settings.endGroup();</a>
<a name="ln4468">      }</a>
<a name="ln4469"> </a>
<a name="ln4470">//---------------------------------------------------------</a>
<a name="ln4471">//   writeSettings</a>
<a name="ln4472">//---------------------------------------------------------</a>
<a name="ln4473"> </a>
<a name="ln4474">void MuseScore::writeSettings()</a>
<a name="ln4475">      {</a>
<a name="ln4476">      // save score list</a>
<a name="ln4477">      for (int i = 0; i &lt; RECENT_LIST_SIZE; ++i)</a>
<a name="ln4478">            settings.setValue(QString(&quot;recent-%1&quot;).arg(i), _recentScores.value(i));</a>
<a name="ln4479"> </a>
<a name="ln4480">      settings.setValue(&quot;scores&quot;, scoreList.size());</a>
<a name="ln4481">      if (cs) {</a>
<a name="ln4482">            int curScore = scoreList.indexOf(cs-&gt;masterScore());</a>
<a name="ln4483">            if (curScore == -1)  // cs removed if new created and not modified</a>
<a name="ln4484">                  curScore = 0;</a>
<a name="ln4485">            settings.setValue(&quot;currentScore&quot;, curScore);</a>
<a name="ln4486"> </a>
<a name="ln4487">            for (int idx = 0; idx &lt; scoreList.size(); ++idx)</a>
<a name="ln4488">                  settings.setValue(QString(&quot;score-%1&quot;).arg(idx), scoreList[idx]-&gt;masterScore()-&gt;fileInfo()-&gt;absoluteFilePath());</a>
<a name="ln4489">            }</a>
<a name="ln4490"> </a>
<a name="ln4491">      settings.setValue(&quot;lastSaveCopyDirectory&quot;, lastSaveCopyDirectory);</a>
<a name="ln4492">      settings.setValue(&quot;lastSaveCopyFormat&quot;, lastSaveCopyFormat);</a>
<a name="ln4493">      settings.setValue(&quot;lastSaveDirectory&quot;, lastSaveDirectory);</a>
<a name="ln4494"> </a>
<a name="ln4495">      MuseScore::saveGeometry(this);</a>
<a name="ln4496"> </a>
<a name="ln4497">      settings.beginGroup(&quot;MainWindow&quot;);</a>
<a name="ln4498">      settings.setValue(&quot;showPanel&quot;, paletteWidget &amp;&amp; paletteWidget-&gt;isVisible());</a>
<a name="ln4499">      settings.setValue(&quot;showInspector&quot;, _inspector &amp;&amp; _inspector-&gt;isVisible());</a>
<a name="ln4500">      settings.setValue(&quot;showPianoKeyboard&quot;, _pianoTools &amp;&amp; _pianoTools-&gt;isVisible());</a>
<a name="ln4501">      settings.setValue(&quot;showSelectionWindow&quot;, selectionWindow &amp;&amp; selectionWindow-&gt;isVisible());</a>
<a name="ln4502">      settings.setValue(&quot;state&quot;, saveState());</a>
<a name="ln4503">      settings.setValue(&quot;splitScreen&quot;, _splitScreen);</a>
<a name="ln4504">      settings.setValue(&quot;debuggerSplitter&quot;, mainWindow-&gt;saveState());</a>
<a name="ln4505">      settings.setValue(&quot;split&quot;, _horizontalSplit);</a>
<a name="ln4506">      settings.setValue(&quot;splitter&quot;, splitter-&gt;saveState());</a>
<a name="ln4507">      settings.endGroup();</a>
<a name="ln4508"> </a>
<a name="ln4509">      WorkspacesManager::currentWorkspace()-&gt;save();</a>
<a name="ln4510">      if (keyEditor &amp;&amp; keyEditor-&gt;dirty())</a>
<a name="ln4511">            keyEditor-&gt;save();</a>
<a name="ln4512">      if (chordStyleEditor)</a>
<a name="ln4513">            chordStyleEditor-&gt;save();</a>
<a name="ln4514"> </a>
<a name="ln4515">      saveDialogState(&quot;loadScoreDialog&quot;,      loadScoreDialog);</a>
<a name="ln4516">      saveDialogState(&quot;saveScoreDialog&quot;,      saveScoreDialog);</a>
<a name="ln4517">      saveDialogState(&quot;loadStyleDialog&quot;,      loadStyleDialog);</a>
<a name="ln4518">      saveDialogState(&quot;saveStyleDialog&quot;,      saveStyleDialog);</a>
<a name="ln4519">      saveDialogState(&quot;saveImageDialog&quot;,      saveImageDialog);</a>
<a name="ln4520">      saveDialogState(&quot;loadChordStyleDialog&quot;, loadChordStyleDialog);</a>
<a name="ln4521">      saveDialogState(&quot;saveChordStyleDialog&quot;, saveChordStyleDialog);</a>
<a name="ln4522">      saveDialogState(&quot;loadScanDialog&quot;,       loadScanDialog);</a>
<a name="ln4523">      saveDialogState(&quot;loadAudioDialog&quot;,      loadAudioDialog);</a>
<a name="ln4524">      saveDialogState(&quot;loadDrumsetDialog&quot;,    loadDrumsetDialog);</a>
<a name="ln4525">      saveDialogState(&quot;saveDrumsetDialog&quot;,    saveDrumsetDialog);</a>
<a name="ln4526">      saveDialogState(&quot;loadPaletteDialog&quot;,    loadPaletteDialog);</a>
<a name="ln4527">      saveDialogState(&quot;savePaletteDialog&quot;,    savePaletteDialog);</a>
<a name="ln4528"> </a>
<a name="ln4529">      if (debugger)</a>
<a name="ln4530">            debugger-&gt;writeSettings();</a>
<a name="ln4531"> </a>
<a name="ln4532">#ifdef SCRIPT_INTERFACE</a>
<a name="ln4533">      if (_pluginCreator)</a>
<a name="ln4534">            _pluginCreator-&gt;writeSettings();</a>
<a name="ln4535">#endif</a>
<a name="ln4536">      if (synthControl)</a>
<a name="ln4537">            synthControl-&gt;writeSettings();</a>
<a name="ln4538">      settings.setValue(&quot;synthControlVisible&quot;, synthControl &amp;&amp; synthControl-&gt;isVisible());</a>
<a name="ln4539">      settings.setValue(&quot;mixerVisible&quot;, mixer &amp;&amp; mixer-&gt;isVisible());</a>
<a name="ln4540">      if (seq) {</a>
<a name="ln4541">            seq-&gt;exit();</a>
<a name="ln4542">            }</a>
<a name="ln4543">      if (instrList)</a>
<a name="ln4544">            instrList-&gt;writeSettings();</a>
<a name="ln4545">      if (pianorollEditor)</a>
<a name="ln4546">            pianorollEditor-&gt;writeSettings();</a>
<a name="ln4547">      if (drumrollEditor)</a>
<a name="ln4548">            drumrollEditor-&gt;writeSettings();</a>
<a name="ln4549">      if (startcenter)</a>
<a name="ln4550">            startcenter-&gt;writeSettings();</a>
<a name="ln4551"> </a>
<a name="ln4552">      _tourHandler-&gt;writeCompletedTours();</a>
<a name="ln4553">      }</a>
<a name="ln4554"> </a>
<a name="ln4555">//---------------------------------------------------------</a>
<a name="ln4556">//   readSettings</a>
<a name="ln4557">//---------------------------------------------------------</a>
<a name="ln4558"> </a>
<a name="ln4559">void MuseScore::readSettings()</a>
<a name="ln4560">      {</a>
<a name="ln4561">      int margin = 100;</a>
<a name="ln4562">      int offset = margin / 2;</a>
<a name="ln4563">      int w = 1024;</a>
<a name="ln4564">      int h = 768;</a>
<a name="ln4565">      QScreen* screen      = QGuiApplication::primaryScreen();</a>
<a name="ln4566">      const QSize screenSize = screen-&gt;availableSize();</a>
<a name="ln4567">      if (screenSize.width() - margin &gt; w)</a>
<a name="ln4568">            w = screenSize.width() - margin;</a>
<a name="ln4569">      else</a>
<a name="ln4570">            offset = 0;</a>
<a name="ln4571">      if (screenSize.height() - margin &gt; h)</a>
<a name="ln4572">            h = screenSize.height() - margin;</a>
<a name="ln4573"> </a>
<a name="ln4574">      resize(QSize(w, h)); //ensure default size if no geometry in settings</a>
<a name="ln4575">      move(offset, 0);</a>
<a name="ln4576">      if (useFactorySettings) {</a>
<a name="ln4577">            QList&lt;int&gt; sizes;</a>
<a name="ln4578">            sizes &lt;&lt; 500 &lt;&lt; 100;</a>
<a name="ln4579">            mainWindow-&gt;setSizes(sizes);</a>
<a name="ln4580">            mscore-&gt;showPalette(true);</a>
<a name="ln4581">            mscore-&gt;showInspector(true);</a>
<a name="ln4582">            return;</a>
<a name="ln4583">            }</a>
<a name="ln4584"> </a>
<a name="ln4585">      MuseScore::restoreGeometry(this);</a>
<a name="ln4586"> </a>
<a name="ln4587">      // Grab the mixer visible state before the beginGroup.</a>
<a name="ln4588">      // Previously the showMixer() call was made at the end of</a>
<a name="ln4589">      // main(). Now it's made inside this beginGroup / endGroup.</a>
<a name="ln4590">      // This code ensures user previous setting is respected when</a>
<a name="ln4591">      // updating their version of MuseScore.</a>
<a name="ln4592">      bool mixerVisible = settings.value(&quot;mixerVisible&quot;, &quot;0&quot;).toBool();</a>
<a name="ln4593">      settings.beginGroup(&quot;MainWindow&quot;);</a>
<a name="ln4594">      mainWindow-&gt;restoreState(settings.value(&quot;debuggerSplitter&quot;).toByteArray());</a>
<a name="ln4595">      mainWindow-&gt;setOpaqueResize(false);</a>
<a name="ln4596">      scorePageLayoutChanged();</a>
<a name="ln4597"> </a>
<a name="ln4598">      //for some reason when MuseScore starts maximized the screen-reader</a>
<a name="ln4599">      //doesn't respond to QAccessibleEvents --&gt; so force normal mode</a>
<a name="ln4600">      if (isMaximized() &amp;&amp; QAccessible::isActive()) {</a>
<a name="ln4601">            showNormal();</a>
<a name="ln4602">            }</a>
<a name="ln4603">      mscore-&gt;showPalette(settings.value(&quot;showPanel&quot;, &quot;1&quot;).toBool());</a>
<a name="ln4604">      mscore-&gt;showInspector(settings.value(&quot;showInspector&quot;, &quot;1&quot;).toBool());</a>
<a name="ln4605">      mscore-&gt;showPianoKeyboard(settings.value(&quot;showPianoKeyboard&quot;, &quot;0&quot;).toBool());</a>
<a name="ln4606">      mscore-&gt;showSelectionWindow(settings.value(&quot;showSelectionWindow&quot;, &quot;0&quot;).toBool());</a>
<a name="ln4607">      mscore-&gt;showMixer(mixerVisible);</a>
<a name="ln4608"> </a>
<a name="ln4609">      restoreState(settings.value(&quot;state&quot;).toByteArray());</a>
<a name="ln4610">      //if we were in full screen mode, go to maximized mode</a>
<a name="ln4611">      if (isFullScreen()) {</a>
<a name="ln4612">            showMaximized();</a>
<a name="ln4613">            }</a>
<a name="ln4614"> </a>
<a name="ln4615">      _horizontalSplit = settings.value(&quot;split&quot;, true).toBool();</a>
<a name="ln4616">      bool splitScreen = settings.value(&quot;splitScreen&quot;, false).toBool();</a>
<a name="ln4617">      if (splitScreen) {</a>
<a name="ln4618">            splitWindow(_horizontalSplit);</a>
<a name="ln4619">            QAction* a = getAction(_horizontalSplit ? &quot;split-h&quot; : &quot;split-v&quot;);</a>
<a name="ln4620">            a-&gt;setChecked(true);</a>
<a name="ln4621">            }</a>
<a name="ln4622">      splitter-&gt;restoreState(settings.value(&quot;splitter&quot;).toByteArray());</a>
<a name="ln4623">      settings.endGroup();</a>
<a name="ln4624"> </a>
<a name="ln4625">      QAction* a = getAction(&quot;toggle-fileoperations&quot;);</a>
<a name="ln4626">      a-&gt;setChecked(!fileTools-&gt;isHidden());</a>
<a name="ln4627"> </a>
<a name="ln4628">      a = getAction(&quot;toggle-transport&quot;);</a>
<a name="ln4629">      a-&gt;setChecked(!transportTools-&gt;isHidden());</a>
<a name="ln4630"> </a>
<a name="ln4631">      a = getAction(&quot;toggle-concertpitch&quot;);</a>
<a name="ln4632">      a-&gt;setChecked(!cpitchTools-&gt;isHidden());</a>
<a name="ln4633"> </a>
<a name="ln4634">      a = getAction(&quot;toggle-imagecapture&quot;);</a>
<a name="ln4635">      a-&gt;setChecked(!fotoTools-&gt;isHidden());</a>
<a name="ln4636"> </a>
<a name="ln4637">      a = getAction(&quot;toggle-noteinput&quot;);</a>
<a name="ln4638">      a-&gt;setChecked(!entryTools-&gt;isHidden());</a>
<a name="ln4639">      }</a>
<a name="ln4640"> </a>
<a name="ln4641">//---------------------------------------------------------</a>
<a name="ln4642">//   play</a>
<a name="ln4643">//    play note for preferences.defaultPlayDuration</a>
<a name="ln4644">//---------------------------------------------------------</a>
<a name="ln4645"> </a>
<a name="ln4646">void MuseScore::play(Element* e) const</a>
<a name="ln4647">      {</a>
<a name="ln4648">      if (noSeq || !(seq &amp;&amp; seq-&gt;isRunning()) || !preferences.getBool(PREF_SCORE_NOTE_PLAYONCLICK))</a>
<a name="ln4649">            return;</a>
<a name="ln4650"> </a>
<a name="ln4651">      if (e-&gt;isNote()) {</a>
<a name="ln4652">            Note* note = toNote(e);</a>
<a name="ln4653">            play(e, note-&gt;ppitch());</a>
<a name="ln4654">            }</a>
<a name="ln4655">      else if (e-&gt;isChord()) {</a>
<a name="ln4656">            seq-&gt;stopNotes();</a>
<a name="ln4657">            Chord* c   = toChord(e);</a>
<a name="ln4658">            Part* part = c-&gt;staff()-&gt;part();</a>
<a name="ln4659">            Fraction tick   = c-&gt;segment() ? c-&gt;segment()-&gt;tick() : Fraction(0,1);</a>
<a name="ln4660">            Instrument* instr = part-&gt;instrument(tick);</a>
<a name="ln4661">            for (Note* n : c-&gt;notes()) {</a>
<a name="ln4662">                  const int channel = instr-&gt;channel(n-&gt;subchannel())-&gt;channel();</a>
<a name="ln4663">                  seq-&gt;startNote(channel, n-&gt;ppitch(), 80, n-&gt;tuning());</a>
<a name="ln4664">                  }</a>
<a name="ln4665">            seq-&gt;startNoteTimer(MScore::defaultPlayDuration);</a>
<a name="ln4666">            }</a>
<a name="ln4667">      }</a>
<a name="ln4668"> </a>
<a name="ln4669">void MuseScore::play(Element* e, int pitch) const</a>
<a name="ln4670">      {</a>
<a name="ln4671">      if (noSeq || !(seq &amp;&amp; seq-&gt;isRunning()))</a>
<a name="ln4672">            return;</a>
<a name="ln4673">      if (preferences.getBool(PREF_SCORE_NOTE_PLAYONCLICK) &amp;&amp; e-&gt;isNote()) {</a>
<a name="ln4674">            Note* note = static_cast&lt;Note*&gt;(e);</a>
<a name="ln4675"> </a>
<a name="ln4676">            Note* masterNote = note;</a>
<a name="ln4677">            if (note-&gt;linkList().size() &gt; 1) {</a>
<a name="ln4678">                  for (ScoreElement* se_ : note-&gt;linkList()) {</a>
<a name="ln4679">                        if (se_-&gt;score() == note-&gt;masterScore() &amp;&amp; se_-&gt;isNote()) {</a>
<a name="ln4680">                              masterNote = toNote(se_);</a>
<a name="ln4681">                              break;</a>
<a name="ln4682">                              }</a>
<a name="ln4683">                        }</a>
<a name="ln4684">                  }</a>
<a name="ln4685"> </a>
<a name="ln4686">            Fraction tick = masterNote-&gt;chord()-&gt;tick();</a>
<a name="ln4687">            if (tick &lt; Fraction(0,1))</a>
<a name="ln4688">                  tick = Fraction(0,1);</a>
<a name="ln4689">            Instrument* instr = masterNote-&gt;part()-&gt;instrument(tick);</a>
<a name="ln4690">            const int channel = instr-&gt;channel(masterNote-&gt;subchannel())-&gt;channel();</a>
<a name="ln4691"> </a>
<a name="ln4692">            // reset the cc that is used for single note dynamics, if any</a>
<a name="ln4693">            int cc = synthesizerState().ccToUse();</a>
<a name="ln4694">            if (cc != -1)</a>
<a name="ln4695">                  seq-&gt;sendEvent(NPlayEvent(ME_CONTROLLER, channel, cc, 80));</a>
<a name="ln4696"> </a>
<a name="ln4697">            seq-&gt;startNote(channel, pitch, 80, MScore::defaultPlayDuration, masterNote-&gt;tuning());</a>
<a name="ln4698">            }</a>
<a name="ln4699">      }</a>
<a name="ln4700"> </a>
<a name="ln4701">//---------------------------------------------------------</a>
<a name="ln4702">//   reportBug</a>
<a name="ln4703">//---------------------------------------------------------</a>
<a name="ln4704"> </a>
<a name="ln4705">void MuseScore::reportBug(QString medium)</a>
<a name="ln4706">      {</a>
<a name="ln4707">      QString url = QString(&quot;https://musescore.org/redirect/post/bug-report?sha=%1&amp;locale=%2&amp;%3&quot;)</a>
<a name="ln4708">         .arg(revision())</a>
<a name="ln4709">         .arg(getLocaleISOCode())</a>
<a name="ln4710">         .arg(getUtmParameters(medium));</a>
<a name="ln4711">      QDesktopServices::openUrl(QUrl(url.trimmed()));</a>
<a name="ln4712">      }</a>
<a name="ln4713"> </a>
<a name="ln4714">//---------------------------------------------------------</a>
<a name="ln4715">//   askForHelp</a>
<a name="ln4716">//---------------------------------------------------------</a>
<a name="ln4717"> </a>
<a name="ln4718">void MuseScore::askForHelp()</a>
<a name="ln4719">      {</a>
<a name="ln4720">      QString url = QString(&quot;https://musescore.org/redirect/post/question?locale=%1&quot;).arg(getLocaleISOCode());</a>
<a name="ln4721">      QDesktopServices::openUrl(QUrl(url.trimmed()));</a>
<a name="ln4722">      }</a>
<a name="ln4723"> </a>
<a name="ln4724">//---------------------------------------------------------</a>
<a name="ln4725">//   leaveFeedback</a>
<a name="ln4726">//---------------------------------------------------------</a>
<a name="ln4727"> </a>
<a name="ln4728">void MuseScore::leaveFeedback(QString medium)</a>
<a name="ln4729">      {</a>
<a name="ln4730">      QString url = QString(&quot;https://musescore.com/content/editor-feedback?%1&quot;)</a>
<a name="ln4731">         .arg(getUtmParameters(medium));</a>
<a name="ln4732">      QDesktopServices::openUrl(QUrl(url.trimmed()));</a>
<a name="ln4733">      }</a>
<a name="ln4734"> </a>
<a name="ln4735">//---------------------------------------------------------</a>
<a name="ln4736">//   getUtmParameters</a>
<a name="ln4737">//    Get UTM labels to track visits.</a>
<a name="ln4738">//    See: https://www.google.com/support/googleanalytics/bin/answer.py?answer=55578</a>
<a name="ln4739">//---------------------------------------------------------</a>
<a name="ln4740"> </a>
<a name="ln4741">QString MuseScore::getUtmParameters(QString medium) const</a>
<a name="ln4742">      {</a>
<a name="ln4743">      return QString(&quot;utm_source=desktop&amp;utm_medium=%1&amp;utm_content=%2&amp;utm_campaign=MuseScore%3&quot;)</a>
<a name="ln4744">         .arg(medium)</a>
<a name="ln4745">         .arg(rev.trimmed())</a>
<a name="ln4746">         .arg(QString(VERSION));</a>
<a name="ln4747">      }</a>
<a name="ln4748"> </a>
<a name="ln4749">//---------------------------------------------------------</a>
<a name="ln4750">//   about</a>
<a name="ln4751">//---------------------------------------------------------</a>
<a name="ln4752"> </a>
<a name="ln4753">void MuseScore::about()</a>
<a name="ln4754">      {</a>
<a name="ln4755">      AboutBoxDialog ab;</a>
<a name="ln4756">      ab.show();</a>
<a name="ln4757">      ab.exec();</a>
<a name="ln4758">      }</a>
<a name="ln4759"> </a>
<a name="ln4760">//---------------------------------------------------------</a>
<a name="ln4761">//   dirtyChanged</a>
<a name="ln4762">//---------------------------------------------------------</a>
<a name="ln4763"> </a>
<a name="ln4764">void MuseScore::dirtyChanged(Score* s)</a>
<a name="ln4765">      {</a>
<a name="ln4766">      MasterScore* score = s-&gt;masterScore();</a>
<a name="ln4767"> </a>
<a name="ln4768">      int idx = scoreList.indexOf(score);</a>
<a name="ln4769">      if (idx == -1) {</a>
<a name="ln4770">            qDebug(&quot;score not in list&quot;);</a>
<a name="ln4771">            return;</a>
<a name="ln4772">            }</a>
<a name="ln4773">      QString label(score-&gt;fileInfo()-&gt;completeBaseName());</a>
<a name="ln4774">      if (score-&gt;dirty())</a>
<a name="ln4775">            label += &quot;*&quot;;</a>
<a name="ln4776">      tab1-&gt;setTabText(idx, label);</a>
<a name="ln4777">      if (tab2)</a>
<a name="ln4778">            tab2-&gt;setTabText(idx, label);</a>
<a name="ln4779">      setWindowModified(score-&gt;dirty());</a>
<a name="ln4780">      }</a>
<a name="ln4781"> </a>
<a name="ln4782">//---------------------------------------------------------</a>
<a name="ln4783">//   magChanged</a>
<a name="ln4784">//---------------------------------------------------------</a>
<a name="ln4785"> </a>
<a name="ln4786">void MuseScore::magChanged(MagIdx idx)</a>
<a name="ln4787">      {</a>
<a name="ln4788">      if (cv)</a>
<a name="ln4789">            cv-&gt;setMag(idx, mag-&gt;getLMag(cv));</a>
<a name="ln4790">      }</a>
<a name="ln4791"> </a>
<a name="ln4792">//---------------------------------------------------------</a>
<a name="ln4793">//   incMag</a>
<a name="ln4794">//---------------------------------------------------------</a>
<a name="ln4795"> </a>
<a name="ln4796">void MuseScore::incMag()</a>
<a name="ln4797">      {</a>
<a name="ln4798">      if (cv) {</a>
<a name="ln4799">            qreal _mag = cv-&gt;lmag() * SCALE_STEP;</a>
<a name="ln4800">            if (_mag &gt; SCALE_MAX)</a>
<a name="ln4801">                  _mag = SCALE_MAX;</a>
<a name="ln4802">            cv-&gt;setMag(MagIdx::MAG_FREE, _mag);</a>
<a name="ln4803">            setMag(_mag);</a>
<a name="ln4804">            }</a>
<a name="ln4805">      }</a>
<a name="ln4806"> </a>
<a name="ln4807">//---------------------------------------------------------</a>
<a name="ln4808">//   decMag</a>
<a name="ln4809">//---------------------------------------------------------</a>
<a name="ln4810"> </a>
<a name="ln4811">void MuseScore::decMag()</a>
<a name="ln4812">      {</a>
<a name="ln4813">      if (cv) {</a>
<a name="ln4814">            qreal _mag = cv-&gt;lmag() / SCALE_STEP;</a>
<a name="ln4815">            if (_mag &lt; SCALE_MIN)</a>
<a name="ln4816">                  _mag = SCALE_MIN;</a>
<a name="ln4817">            cv-&gt;setMag(MagIdx::MAG_FREE, _mag);</a>
<a name="ln4818">            setMag(_mag);</a>
<a name="ln4819">            }</a>
<a name="ln4820">      }</a>
<a name="ln4821"> </a>
<a name="ln4822">//---------------------------------------------------------</a>
<a name="ln4823">//   getMag</a>
<a name="ln4824">//    return physical scale</a>
<a name="ln4825">//---------------------------------------------------------</a>
<a name="ln4826"> </a>
<a name="ln4827">double MuseScore::getMag(ScoreView* canvas) const</a>
<a name="ln4828">      {</a>
<a name="ln4829">      return mag-&gt;getMag(canvas);</a>
<a name="ln4830">      }</a>
<a name="ln4831"> </a>
<a name="ln4832">//---------------------------------------------------------</a>
<a name="ln4833">//   setMag</a>
<a name="ln4834">//    set logical scale</a>
<a name="ln4835">//---------------------------------------------------------</a>
<a name="ln4836"> </a>
<a name="ln4837">void MuseScore::setMag(double d)</a>
<a name="ln4838">      {</a>
<a name="ln4839">      mag-&gt;setMag(d);</a>
<a name="ln4840">      mag-&gt;setMagIdx(MagIdx::MAG_FREE);</a>
<a name="ln4841">      }</a>
<a name="ln4842"> </a>
<a name="ln4843">//---------------------------------------------------------</a>
<a name="ln4844">//   setPos</a>
<a name="ln4845">//    set position label</a>
<a name="ln4846">//---------------------------------------------------------</a>
<a name="ln4847"> </a>
<a name="ln4848">void MuseScore::setPos(const Fraction&amp; t)</a>
<a name="ln4849">      {</a>
<a name="ln4850">      if (cs == 0 || t &lt; Fraction(0,1))</a>
<a name="ln4851">            return;</a>
<a name="ln4852"> </a>
<a name="ln4853">      TimeSigMap* s = cs-&gt;sigmap();</a>
<a name="ln4854">      int bar, beat, tick;</a>
<a name="ln4855">      s-&gt;tickValues(t.ticks(), &amp;bar, &amp;beat, &amp;tick);</a>
<a name="ln4856">      _positionLabel-&gt;setText(QString(&quot;%1:%2:%3&quot;)</a>
<a name="ln4857">         .arg(bar + 1,  3, 10, QLatin1Char(' '))</a>
<a name="ln4858">         .arg(beat + 1, 2, 10, QLatin1Char('0'))</a>
<a name="ln4859">         .arg(tick,     3, 10, QLatin1Char('0'))</a>
<a name="ln4860">         );</a>
<a name="ln4861">      }</a>
<a name="ln4862"> </a>
<a name="ln4863">//---------------------------------------------------------</a>
<a name="ln4864">//   undoRedo</a>
<a name="ln4865">//---------------------------------------------------------</a>
<a name="ln4866"> </a>
<a name="ln4867">void MuseScore::undoRedo(bool undo)</a>
<a name="ln4868">      {</a>
<a name="ln4869">      Q_ASSERT(cv);</a>
<a name="ln4870">      Q_ASSERT(cs);</a>
<a name="ln4871">      if (_sstate &amp; (STATE_EDIT | STATE_HARMONY_FIGBASS_EDIT | STATE_LYRICS_EDIT))</a>
<a name="ln4872">            cv-&gt;changeState(ViewState::NORMAL);</a>
<a name="ln4873">      cv-&gt;startUndoRedo(undo);</a>
<a name="ln4874">      updateInputState(cs);</a>
<a name="ln4875">      endCmd(/* undoRedo */ true);</a>
<a name="ln4876">      if (pianorollEditor)</a>
<a name="ln4877">            pianorollEditor-&gt;update();</a>
<a name="ln4878">      }</a>
<a name="ln4879"> </a>
<a name="ln4880">//---------------------------------------------------------</a>
<a name="ln4881">//   showProgressBar</a>
<a name="ln4882">//---------------------------------------------------------</a>
<a name="ln4883"> </a>
<a name="ln4884">QProgressBar* MuseScore::showProgressBar()</a>
<a name="ln4885">      {</a>
<a name="ln4886">      if (_progressBar == 0)</a>
<a name="ln4887">            _progressBar = new QProgressBar(this);</a>
<a name="ln4888">      _statusBar-&gt;addWidget(_progressBar);</a>
<a name="ln4889">      _progressBar-&gt;show();</a>
<a name="ln4890">      return _progressBar;</a>
<a name="ln4891">      }</a>
<a name="ln4892"> </a>
<a name="ln4893">//---------------------------------------------------------</a>
<a name="ln4894">//   hideProgressBar</a>
<a name="ln4895">//---------------------------------------------------------</a>
<a name="ln4896"> </a>
<a name="ln4897">void MuseScore::hideProgressBar()</a>
<a name="ln4898">      {</a>
<a name="ln4899">      if (_progressBar)</a>
<a name="ln4900">            _statusBar-&gt;removeWidget(_progressBar);</a>
<a name="ln4901">      }</a>
<a name="ln4902"> </a>
<a name="ln4903">//---------------------------------------------------------</a>
<a name="ln4904">//   handleMessage</a>
<a name="ln4905">//---------------------------------------------------------</a>
<a name="ln4906"> </a>
<a name="ln4907">void MuseScore::handleMessage(const QString&amp; message)</a>
<a name="ln4908">      {</a>
<a name="ln4909">      if (message.isEmpty())</a>
<a name="ln4910">            return;</a>
<a name="ln4911">      if (startcenter)</a>
<a name="ln4912">            showStartcenter(false);</a>
<a name="ln4913">      ((QtSingleApplication*)(qApp))-&gt;activateWindow();</a>
<a name="ln4914">      MasterScore* score = readScore(message);</a>
<a name="ln4915">      if (score) {</a>
<a name="ln4916">            setCurrentScoreView(appendScore(score));</a>
<a name="ln4917">            addRecentScore(score);</a>
<a name="ln4918">            writeSessionFile(false);</a>
<a name="ln4919">            }</a>
<a name="ln4920">      }</a>
<a name="ln4921"> </a>
<a name="ln4922">//---------------------------------------------------------</a>
<a name="ln4923">//   editInPianoroll</a>
<a name="ln4924">//---------------------------------------------------------</a>
<a name="ln4925"> </a>
<a name="ln4926">void MuseScore::editInPianoroll(Staff* staff, Position* p)</a>
<a name="ln4927">      {</a>
<a name="ln4928">      if (pianorollEditor == 0)</a>
<a name="ln4929">            pianorollEditor = new PianorollEditor;</a>
<a name="ln4930">      pianorollEditor-&gt;setScore(staff-&gt;score());</a>
<a name="ln4931">      pianorollEditor-&gt;setStaff(staff);</a>
<a name="ln4932">      pianorollEditor-&gt;show();</a>
<a name="ln4933">      pianorollEditor-&gt;focusOnPosition(p);</a>
<a name="ln4934">      }</a>
<a name="ln4935"> </a>
<a name="ln4936">//---------------------------------------------------------</a>
<a name="ln4937">//   editInDrumroll</a>
<a name="ln4938">//---------------------------------------------------------</a>
<a name="ln4939"> </a>
<a name="ln4940">void MuseScore::editInDrumroll(Staff* staff)</a>
<a name="ln4941">      {</a>
<a name="ln4942">      if (drumrollEditor == 0)</a>
<a name="ln4943">            drumrollEditor = new DrumrollEditor;</a>
<a name="ln4944">      drumrollEditor-&gt;setStaff(staff);</a>
<a name="ln4945">      drumrollEditor-&gt;show();</a>
<a name="ln4946">      }</a>
<a name="ln4947"> </a>
<a name="ln4948">//---------------------------------------------------------</a>
<a name="ln4949">//   writeSessionFile</a>
<a name="ln4950">//---------------------------------------------------------</a>
<a name="ln4951"> </a>
<a name="ln4952">void MuseScore::writeSessionFile(bool cleanExit)</a>
<a name="ln4953">      {</a>
<a name="ln4954">// qDebug(&quot;write session file&quot;);</a>
<a name="ln4955"> </a>
<a name="ln4956">      QDir dir;</a>
<a name="ln4957">      dir.mkpath(dataPath);</a>
<a name="ln4958">      QFile f(dataPath + &quot;/session&quot;);</a>
<a name="ln4959">      if (!f.open(QIODevice::WriteOnly)) {</a>
<a name="ln4960">            qDebug(&quot;cannot create session file &lt;%s&gt;&quot;, qPrintable(f.fileName()));</a>
<a name="ln4961">            return;</a>
<a name="ln4962">            }</a>
<a name="ln4963">      XmlWriter xml(0, &amp;f);</a>
<a name="ln4964">      xml.header();</a>
<a name="ln4965">      xml.stag(QStringLiteral(&quot;museScore version=\&quot;&quot; MSC_VERSION &quot;\&quot; full-version=\&quot;%1\&quot;&quot;).arg(fullVersion()));</a>
<a name="ln4966">      xml.tagE(cleanExit ? &quot;clean&quot; : &quot;dirty&quot;);</a>
<a name="ln4967"> </a>
<a name="ln4968">      foreach(MasterScore* score, scoreList) {</a>
<a name="ln4969">            xml.stag(&quot;Score&quot;);</a>
<a name="ln4970">            xml.tag(&quot;created&quot;, score-&gt;created());</a>
<a name="ln4971">            xml.tag(&quot;dirty&quot;, score-&gt;dirty());</a>
<a name="ln4972"> </a>
<a name="ln4973">            QString path;</a>
<a name="ln4974">            if (score-&gt;importedFilePath().isEmpty()) {</a>
<a name="ln4975">                              // score was not imported from another format, e.g. MIDI file</a>
<a name="ln4976">                  path = score-&gt;masterScore()-&gt;fileInfo()-&gt;absoluteFilePath();</a>
<a name="ln4977">                  }</a>
<a name="ln4978">            else if (score-&gt;masterScore()-&gt;fileInfo()-&gt;exists()) {   // score was saved</a>
<a name="ln4979">                  path = score-&gt;masterScore()-&gt;fileInfo()-&gt;absoluteFilePath();</a>
<a name="ln4980">                  }</a>
<a name="ln4981">            else {      // score was imported but not saved - store original file (e.g. MIDI) path</a>
<a name="ln4982">                  path = score-&gt;importedFilePath();</a>
<a name="ln4983">                  }</a>
<a name="ln4984"> </a>
<a name="ln4985">            if (cleanExit || score-&gt;tmpName().isEmpty()) {</a>
<a name="ln4986">                  xml.tag(&quot;path&quot;, path);</a>
<a name="ln4987">                  }</a>
<a name="ln4988">            else {</a>
<a name="ln4989">                  xml.tag(&quot;name&quot;, path);</a>
<a name="ln4990">                  xml.tag(&quot;path&quot;, score-&gt;tmpName());</a>
<a name="ln4991">                  }</a>
<a name="ln4992">            xml.etag();</a>
<a name="ln4993">            }</a>
<a name="ln4994">      int tab = 0;</a>
<a name="ln4995">      int idx = 0;</a>
<a name="ln4996">      for (int i = 0; i &lt; tab1-&gt;count(); ++i) {</a>
<a name="ln4997">            ScoreView* v = tab1-&gt;view(i);</a>
<a name="ln4998">            if (v) {</a>
<a name="ln4999">                  if (v == cv) {</a>
<a name="ln5000">                        tab = 0;</a>
<a name="ln5001">                        idx = i;</a>
<a name="ln5002">                        }</a>
<a name="ln5003">                  xml.stag(&quot;ScoreView&quot;);</a>
<a name="ln5004">                  xml.tag(&quot;tab&quot;, tab);    // 0 instead of &quot;tab&quot; does not work</a>
<a name="ln5005">                  xml.tag(&quot;idx&quot;, i);</a>
<a name="ln5006">                  if (v-&gt;magIdx() == MagIdx::MAG_FREE)</a>
<a name="ln5007">                        xml.tag(&quot;mag&quot;, v-&gt;lmag());</a>
<a name="ln5008">                  else</a>
<a name="ln5009">                        xml.tag(&quot;magIdx&quot;, int(v-&gt;magIdx()));</a>
<a name="ln5010">                  xml.tag(&quot;x&quot;,   v-&gt;xoffset() / DPMM);</a>
<a name="ln5011">                  xml.tag(&quot;y&quot;,   v-&gt;yoffset() / DPMM);</a>
<a name="ln5012">                  xml.etag();</a>
<a name="ln5013">                  }</a>
<a name="ln5014">            }</a>
<a name="ln5015">      if (splitScreen()) {</a>
<a name="ln5016">            for (int i = 0; i &lt; tab2-&gt;count(); ++i) {</a>
<a name="ln5017">                  ScoreView* v = tab2-&gt;view(i);</a>
<a name="ln5018">                  if (v) {</a>
<a name="ln5019">                        if (v == cv) {</a>
<a name="ln5020">                              tab = 1;</a>
<a name="ln5021">                              idx = i;</a>
<a name="ln5022">                              }</a>
<a name="ln5023">                        xml.stag(&quot;ScoreView&quot;);</a>
<a name="ln5024">                        xml.tag(&quot;tab&quot;, 1);</a>
<a name="ln5025">                        xml.tag(&quot;idx&quot;, i);</a>
<a name="ln5026">                        if (v-&gt;magIdx() == MagIdx::MAG_FREE)</a>
<a name="ln5027">                              xml.tag(&quot;mag&quot;, v-&gt;lmag());</a>
<a name="ln5028">                        else</a>
<a name="ln5029">                              xml.tag(&quot;magIdx&quot;, int(v-&gt;magIdx()));</a>
<a name="ln5030">                        xml.tag(&quot;x&quot;,   v-&gt;xoffset() / DPMM);</a>
<a name="ln5031">                        xml.tag(&quot;y&quot;,   v-&gt;yoffset() / DPMM);</a>
<a name="ln5032">                        xml.etag();</a>
<a name="ln5033">                        }</a>
<a name="ln5034">                  }</a>
<a name="ln5035">            }</a>
<a name="ln5036">      xml.tag(&quot;tab&quot;, tab);</a>
<a name="ln5037">      xml.tag(&quot;idx&quot;, idx);</a>
<a name="ln5038">      xml.etag();</a>
<a name="ln5039">      f.close();</a>
<a name="ln5040">      if (cleanExit) {</a>
<a name="ln5041">            // TODO: remove all temporary session backup files</a>
<a name="ln5042">            }</a>
<a name="ln5043">      }</a>
<a name="ln5044"> </a>
<a name="ln5045">//---------------------------------------------------------</a>
<a name="ln5046">//   removeSessionFile</a>
<a name="ln5047">//    remove temp files and session file</a>
<a name="ln5048">//---------------------------------------------------------</a>
<a name="ln5049"> </a>
<a name="ln5050">void MuseScore::removeSessionFile()</a>
<a name="ln5051">      {</a>
<a name="ln5052">      QFile f(dataPath + &quot;/session&quot;);</a>
<a name="ln5053">      if (!f.exists())</a>
<a name="ln5054">            return;</a>
<a name="ln5055">      if (!f.remove()) {</a>
<a name="ln5056">            qDebug(&quot;cannot remove session file &lt;%s&gt;&quot;, qPrintable(f.fileName()));</a>
<a name="ln5057">            }</a>
<a name="ln5058">      }</a>
<a name="ln5059"> </a>
<a name="ln5060">//---------------------------------------------------------</a>
<a name="ln5061">//   autoSaveTimerTimeout</a>
<a name="ln5062">//---------------------------------------------------------</a>
<a name="ln5063"> </a>
<a name="ln5064">void MuseScore::autoSaveTimerTimeout()</a>
<a name="ln5065">      {</a>
<a name="ln5066">      bool sessionChanged = false;</a>
<a name="ln5067"> </a>
<a name="ln5068">      ScoreLoad sl;           //disable debug message &quot;no active command&quot;</a>
<a name="ln5069"> </a>
<a name="ln5070">      for (MasterScore* s : scoreList) {</a>
<a name="ln5071">            if (s-&gt;autosaveDirty()) {</a>
<a name="ln5072">                  qDebug(&quot;&lt;%s&gt;&quot;, qPrintable(s-&gt;fileInfo()-&gt;completeBaseName()));</a>
<a name="ln5073">                  QString tmp = s-&gt;tmpName();</a>
<a name="ln5074">                  if (!tmp.isEmpty()) {</a>
<a name="ln5075">                        QFileInfo fi(tmp);</a>
<a name="ln5076">                        // TODO: cannot catch exception here:</a>
<a name="ln5077">                        s-&gt;saveCompressedFile(fi, false, false); // no thumbnail</a>
<a name="ln5078">                        }</a>
<a name="ln5079">                  else {</a>
<a name="ln5080">                        QDir dir;</a>
<a name="ln5081">                        dir.mkpath(dataPath);</a>
<a name="ln5082">                        QTemporaryFile tf(dataPath + &quot;/scXXXXXX.mscz&quot;);</a>
<a name="ln5083">                        tf.setAutoRemove(false);</a>
<a name="ln5084">                        if (!tf.open()) {</a>
<a name="ln5085">                              qDebug(&quot;autoSaveTimerTimeout(): create temporary file failed&quot;);</a>
<a name="ln5086">                              return;</a>
<a name="ln5087">                              }</a>
<a name="ln5088">                        s-&gt;setTmpName(tf.fileName());</a>
<a name="ln5089">                        QFileInfo info(tf.fileName());</a>
<a name="ln5090">                        s-&gt;saveCompressedFile(&amp;tf, info, false, false);  // no thumbnail</a>
<a name="ln5091">                        tf.close();</a>
<a name="ln5092">                        sessionChanged = true;</a>
<a name="ln5093">                        }</a>
<a name="ln5094">                  s-&gt;setAutosaveDirty(false);</a>
<a name="ln5095">                  }</a>
<a name="ln5096">            }</a>
<a name="ln5097">      if (sessionChanged)</a>
<a name="ln5098">            writeSessionFile(false);</a>
<a name="ln5099">      if (preferences.getBool(PREF_APP_AUTOSAVE_USEAUTOSAVE)) {</a>
<a name="ln5100">            int t = preferences.getInt(PREF_APP_AUTOSAVE_AUTOSAVETIME) * 60 * 1000;</a>
<a name="ln5101">            autoSaveTimer-&gt;start(t);</a>
<a name="ln5102">            }</a>
<a name="ln5103">      }</a>
<a name="ln5104"> </a>
<a name="ln5105">class CallOnReturn {</a>
<a name="ln5106">      std::function&lt;void()&gt; f;</a>
<a name="ln5107">   public:</a>
<a name="ln5108">      CallOnReturn(std::function&lt;void()&gt; func) : f(std::move(func)) {}</a>
<a name="ln5109">      CallOnReturn(const CallOnReturn&amp;) = delete;</a>
<a name="ln5110">      CallOnReturn&amp; operator=(const CallOnReturn&amp;) = delete;</a>
<a name="ln5111">      ~CallOnReturn() { f(); }</a>
<a name="ln5112">      };</a>
<a name="ln5113"> </a>
<a name="ln5114">//---------------------------------------------------------</a>
<a name="ln5115">//   restoreSession</a>
<a name="ln5116">//    Restore last session. If &quot;always&quot; is true, then restore</a>
<a name="ln5117">//    last session even on a clean exit else only if last</a>
<a name="ln5118">//    session ended abnormal.</a>
<a name="ln5119">//    Return true if a session was found and restored.</a>
<a name="ln5120">//---------------------------------------------------------</a>
<a name="ln5121"> </a>
<a name="ln5122">bool MuseScore::restoreSession(bool always)</a>
<a name="ln5123">      {</a>
<a name="ln5124">      bool sessionFileFound = false;</a>
<a name="ln5125">      bool cleanExit = false;</a>
<a name="ln5126">      QString sessionFullVersion;</a>
<a name="ln5127"> </a>
<a name="ln5128">      CallOnReturn onReturn([this, &amp;sessionFileFound, &amp;sessionFullVersion, &amp;cleanExit]() {</a>
<a name="ln5129">            sessionStatusObserver.prevSessionStatus(sessionFileFound, sessionFullVersion, cleanExit);</a>
<a name="ln5130">            });</a>
<a name="ln5131"> </a>
<a name="ln5132">      QFile f(dataPath + &quot;/session&quot;);</a>
<a name="ln5133">      if (!f.exists())</a>
<a name="ln5134">            return false;</a>
<a name="ln5135">      if (!f.open(QIODevice::ReadOnly)) {</a>
<a name="ln5136">            qDebug(&quot;Cannot open session file &lt;%s&gt;&quot;, qPrintable(f.fileName()));</a>
<a name="ln5137">            return false;</a>
<a name="ln5138">            }</a>
<a name="ln5139">      sessionFileFound = true;</a>
<a name="ln5140"> </a>
<a name="ln5141">      XmlReader e(&amp;f);</a>
<a name="ln5142">      int tab = 0;</a>
<a name="ln5143">      int idx = -1;</a>
<a name="ln5144">      while (e.readNextStartElement()) {</a>
<a name="ln5145">            if (e.name() == &quot;museScore&quot;) {</a>
<a name="ln5146">                  /* QString version = e.attribute(QString(&quot;version&quot;));</a>
<a name="ln5147">                  QStringList sl  = version.split('.');</a>
<a name="ln5148">                  int v           = sl[0].toInt() * 100 + sl[1].toInt();</a>
<a name="ln5149">                  */</a>
<a name="ln5150">                  sessionFullVersion = e.attribute(&quot;full-version&quot;);</a>
<a name="ln5151">                  while (e.readNextStartElement()) {</a>
<a name="ln5152">                        const QStringRef&amp; tag(e.name());</a>
<a name="ln5153">                        if (tag == &quot;clean&quot;) {</a>
<a name="ln5154">                              cleanExit = true;</a>
<a name="ln5155">                              if (!always)</a>
<a name="ln5156">                                    return false;</a>
<a name="ln5157">                              e.readNext();</a>
<a name="ln5158">                              }</a>
<a name="ln5159">                        else if (tag == &quot;dirty&quot;) {</a>
<a name="ln5160">                              QMessageBox::StandardButton b = QMessageBox::question(0,</a>
<a name="ln5161">                                 tr(&quot;MuseScore&quot;),</a>
<a name="ln5162">                                 tr(&quot;The previous session quit unexpectedly.\n\nRestore session?&quot;),</a>
<a name="ln5163">                                 QMessageBox::Yes | QMessageBox::No,</a>
<a name="ln5164">                                 QMessageBox::Yes</a>
<a name="ln5165">                                 );</a>
<a name="ln5166">                              if (b != QMessageBox::Yes)</a>
<a name="ln5167">                                    return false;</a>
<a name="ln5168">                              e.readNext();</a>
<a name="ln5169">                              }</a>
<a name="ln5170">                        else if (tag == &quot;Score&quot;) {</a>
<a name="ln5171">                              QString name;</a>
<a name="ln5172">                              bool created = false;</a>
<a name="ln5173">                              while (e.readNextStartElement()) {</a>
<a name="ln5174">                                    const QStringRef&amp; t(e.name());</a>
<a name="ln5175">                                    if (t == &quot;name&quot;)</a>
<a name="ln5176">                                          name = e.readElementText();</a>
<a name="ln5177">                                    else if (t == &quot;created&quot;)</a>
<a name="ln5178">                                          created = e.readInt();</a>
<a name="ln5179">                                    else if (t == &quot;dirty&quot;)</a>
<a name="ln5180">                                          /*int dirty =*/ e.readInt();</a>
<a name="ln5181">                                    else if (t == &quot;path&quot;) {</a>
<a name="ln5182">                                          MasterScore* score = readScore(e.readElementText());</a>
<a name="ln5183">                                          if (score) {</a>
<a name="ln5184">                                                if (!name.isEmpty()) {</a>
<a name="ln5185">                                                      QFileInfo* fi = score-&gt;masterScore()-&gt;fileInfo();</a>
<a name="ln5186">                                                      fi-&gt;setFile(name);</a>
<a name="ln5187">                                                      // TODO: what if that path is no longer valid?</a>
<a name="ln5188">                                                      }</a>
<a name="ln5189">                                                if (cleanExit) {</a>
<a name="ln5190">                                                      // override if last session did a clean exit</a>
<a name="ln5191">                                                      created = false;</a>
<a name="ln5192">                                                      }</a>
<a name="ln5193">                                                appendScore(score);</a>
<a name="ln5194">                                                score-&gt;setCreated(created);</a>
<a name="ln5195">                                                }</a>
<a name="ln5196">                                          }</a>
<a name="ln5197">                                    else {</a>
<a name="ln5198">                                          e.unknown();</a>
<a name="ln5199">                                          return false;</a>
<a name="ln5200">                                          }</a>
<a name="ln5201">                                    }</a>
<a name="ln5202">                              }</a>
<a name="ln5203">                        else if (tag == &quot;ScoreView&quot;) {</a>
<a name="ln5204">                              qreal x       = .0;</a>
<a name="ln5205">                              qreal y       = .0;</a>
<a name="ln5206">                              qreal vmag    = 1.0;</a>
<a name="ln5207">                              MagIdx magIdx = MagIdx::MAG_FREE;</a>
<a name="ln5208">                              int tab3      = 0;</a>
<a name="ln5209">                              int idx1      = 0;</a>
<a name="ln5210">                              while (e.readNextStartElement()) {</a>
<a name="ln5211">                                    const QStringRef&amp; t(e.name());</a>
<a name="ln5212">                                    if (t == &quot;tab&quot;)</a>
<a name="ln5213">                                          tab3 = e.readInt();</a>
<a name="ln5214">                                    else if (t == &quot;idx&quot;)</a>
<a name="ln5215">                                          idx1 = e.readInt();</a>
<a name="ln5216">                                    else if (t == &quot;mag&quot;)</a>
<a name="ln5217">                                          vmag = e.readDouble();</a>
<a name="ln5218">                                    else if (t == &quot;magIdx&quot;)</a>
<a name="ln5219">                                          magIdx = MagIdx(e.readInt());</a>
<a name="ln5220">                                    else if (t == &quot;x&quot;)</a>
<a name="ln5221">                                          x = e.readDouble() * DPMM;</a>
<a name="ln5222">                                    else if (t == &quot;y&quot;)</a>
<a name="ln5223">                                          y = e.readDouble() * DPMM;</a>
<a name="ln5224">                                    else {</a>
<a name="ln5225">                                          e.unknown();</a>
<a name="ln5226">                                          return false;</a>
<a name="ln5227">                                          }</a>
<a name="ln5228">                                    }</a>
<a name="ln5229">                              (tab3 == 0 ? tab1 : tab2)-&gt;initScoreView(idx1, vmag, magIdx, x, y);</a>
<a name="ln5230">                              }</a>
<a name="ln5231">                        else if (tag == &quot;tab&quot;)</a>
<a name="ln5232">                              tab = e.readInt();</a>
<a name="ln5233">                        else if (tag == &quot;idx&quot;)</a>
<a name="ln5234">                              idx = e.readInt();</a>
<a name="ln5235">                        else {</a>
<a name="ln5236">                              e.unknown();</a>
<a name="ln5237">                              return false;</a>
<a name="ln5238">                              }</a>
<a name="ln5239">                        }</a>
<a name="ln5240">                  }</a>
<a name="ln5241">            else {</a>
<a name="ln5242">                  e.unknown();</a>
<a name="ln5243">                  return false;</a>
<a name="ln5244">                  }</a>
<a name="ln5245">            }</a>
<a name="ln5246">      setCurrentView(tab, idx);</a>
<a name="ln5247">      return true;</a>
<a name="ln5248">      }</a>
<a name="ln5249"> </a>
<a name="ln5250">//---------------------------------------------------------</a>
<a name="ln5251">//   splitWindow</a>
<a name="ln5252">//---------------------------------------------------------</a>
<a name="ln5253"> </a>
<a name="ln5254">void MuseScore::splitWindow(bool horizontal)</a>
<a name="ln5255">      {</a>
<a name="ln5256">      if (!_splitScreen) {</a>
<a name="ln5257">            if (tab2 == 0) {</a>
<a name="ln5258">                  tab2 = createScoreTab();</a>
<a name="ln5259">                  splitter-&gt;addWidget(tab2);</a>
<a name="ln5260">                  }</a>
<a name="ln5261">            tab2-&gt;setVisible(true);</a>
<a name="ln5262">            _splitScreen = true;</a>
<a name="ln5263">            _horizontalSplit = horizontal;</a>
<a name="ln5264">            splitter-&gt;setOrientation(_horizontalSplit ? Qt::Horizontal : Qt::Vertical);</a>
<a name="ln5265">            if (!scoreList.isEmpty()) {</a>
<a name="ln5266">                  tab2-&gt;setCurrentIndex(0);</a>
<a name="ln5267">                  MasterScore* s = scoreList[0];</a>
<a name="ln5268">                  s-&gt;setLayoutAll();</a>
<a name="ln5269">                  s-&gt;update();</a>
<a name="ln5270">                  setCurrentView(1, 0);</a>
<a name="ln5271">                  }</a>
<a name="ln5272">            emit windowSplit(true);</a>
<a name="ln5273">            }</a>
<a name="ln5274">      else {</a>
<a name="ln5275">            if (_horizontalSplit == horizontal) {</a>
<a name="ln5276">                  _splitScreen = false;</a>
<a name="ln5277">                  tab2-&gt;setVisible(false);</a>
<a name="ln5278">                  setCurrentView(0, tab1-&gt;currentIndex());</a>
<a name="ln5279">                  emit windowSplit(false);</a>
<a name="ln5280">                  }</a>
<a name="ln5281">            else {</a>
<a name="ln5282">                  _horizontalSplit = horizontal;</a>
<a name="ln5283">                  splitter-&gt;setOrientation(_horizontalSplit ? Qt::Horizontal : Qt::Vertical);</a>
<a name="ln5284">                  }</a>
<a name="ln5285">            }</a>
<a name="ln5286">      getAction(&quot;split-h&quot;)-&gt;setChecked(_splitScreen &amp;&amp; _horizontalSplit);</a>
<a name="ln5287">      getAction(&quot;split-v&quot;)-&gt;setChecked(_splitScreen &amp;&amp; !_horizontalSplit);</a>
<a name="ln5288">      }</a>
<a name="ln5289"> </a>
<a name="ln5290">//---------------------------------------------------------</a>
<a name="ln5291">//   stateName</a>
<a name="ln5292">//---------------------------------------------------------</a>
<a name="ln5293"> </a>
<a name="ln5294">const char* stateName(ScoreState s)</a>
<a name="ln5295">      {</a>
<a name="ln5296">      switch(s) {</a>
<a name="ln5297">            case STATE_DISABLED:           return &quot;STATE_DISABLED&quot;;</a>
<a name="ln5298">            case STATE_NORMAL:             return &quot;STATE_NORMAL&quot;;</a>
<a name="ln5299">            case STATE_NOTE_ENTRY_STAFF_PITCHED: return &quot;STATE_NOTE_ENTRY_STAFF_PITCHED&quot;;</a>
<a name="ln5300">            case STATE_NOTE_ENTRY_STAFF_DRUM:    return &quot;STATE_NOTE_ENTRY_STAFF_DRUM&quot;;</a>
<a name="ln5301">            case STATE_NOTE_ENTRY_STAFF_TAB:     return &quot;STATE_NOTE_ENTRY_STAFF_TAB&quot;;</a>
<a name="ln5302">            case STATE_NOTE_ENTRY:         return &quot;STATE_NOTE_ENTRY&quot;;</a>
<a name="ln5303">            case STATE_NOTE_ENTRY_METHOD_STEPTIME:          return &quot;STATE_NOTE_ENTRY_METHOD_STEPTIME&quot;;</a>
<a name="ln5304">            case STATE_NOTE_ENTRY_METHOD_REPITCH:           return &quot;STATE_NOTE_ENTRY_METHOD_REPITCH&quot;;</a>
<a name="ln5305">            case STATE_NOTE_ENTRY_METHOD_RHYTHM:            return &quot;STATE_NOTE_ENTRY_METHOD_RHYTHM&quot;;</a>
<a name="ln5306">            case STATE_NOTE_ENTRY_METHOD_REALTIME_AUTO:     return &quot;STATE_NOTE_ENTRY_METHOD_REALTIME_AUTO&quot;;</a>
<a name="ln5307">            case STATE_NOTE_ENTRY_METHOD_REALTIME_MANUAL:   return &quot;STATE_NOTE_ENTRY_METHOD_REALTIME_MANUAL&quot;;</a>
<a name="ln5308">            case STATE_EDIT:               return &quot;STATE_EDIT&quot;;</a>
<a name="ln5309">            case STATE_TEXT_EDIT:          return &quot;STATE_TEXT_EDIT&quot;;</a>
<a name="ln5310">            case STATE_LYRICS_EDIT:        return &quot;STATE_LYRICS_EDIT&quot;;</a>
<a name="ln5311">            case STATE_HARMONY_FIGBASS_EDIT: return &quot;STATE_HARMONY_FIGBASS_EDIT&quot;;</a>
<a name="ln5312">            case STATE_PLAY:               return &quot;STATE_PLAY&quot;;</a>
<a name="ln5313">            case STATE_FOTO:               return &quot;STATE_FOTO&quot;;</a>
<a name="ln5314">            default:                       return &quot;??&quot;;</a>
<a name="ln5315">            }</a>
<a name="ln5316">      }</a>
<a name="ln5317"> </a>
<a name="ln5318">//---------------------------------------------------------</a>
<a name="ln5319">//   scorePageLayoutChanged</a>
<a name="ln5320">//---------------------------------------------------------</a>
<a name="ln5321"> </a>
<a name="ln5322">void MuseScore::scorePageLayoutChanged()</a>
<a name="ln5323">      {</a>
<a name="ln5324">      if (mainWindow) {</a>
<a name="ln5325">            mainWindow-&gt;setOrientation(MScore::verticalOrientation() ? Qt::Horizontal : Qt::Vertical);</a>
<a name="ln5326">            if (navigatorScrollArea())</a>
<a name="ln5327">                  navigatorScrollArea()-&gt;orientationChanged();</a>
<a name="ln5328">            }</a>
<a name="ln5329">      }</a>
<a name="ln5330"> </a>
<a name="ln5331">//---------------------------------------------------------</a>
<a name="ln5332">//   editRaster</a>
<a name="ln5333">//---------------------------------------------------------</a>
<a name="ln5334"> </a>
<a name="ln5335">void MuseScore::editRaster()</a>
<a name="ln5336">      {</a>
<a name="ln5337">      if (editRasterDialog == 0) {</a>
<a name="ln5338">            editRasterDialog = new EditRaster(this);</a>
<a name="ln5339">            }</a>
<a name="ln5340">      if (editRasterDialog-&gt;exec()) {</a>
<a name="ln5341">            qDebug(&quot;=====accept config raster&quot;);</a>
<a name="ln5342">            }</a>
<a name="ln5343">      }</a>
<a name="ln5344"> </a>
<a name="ln5345">//---------------------------------------------------------</a>
<a name="ln5346">//   showPianoKeyboard</a>
<a name="ln5347">//---------------------------------------------------------</a>
<a name="ln5348"> </a>
<a name="ln5349">void MuseScore::showPianoKeyboard(bool visible)</a>
<a name="ln5350">      {</a>
<a name="ln5351">      if (_pianoTools == 0) {</a>
<a name="ln5352">            QAction* a = getAction(&quot;toggle-piano&quot;);</a>
<a name="ln5353">            _pianoTools = new PianoTools(this);</a>
<a name="ln5354">            addDockWidget(Qt::BottomDockWidgetArea, _pianoTools);</a>
<a name="ln5355">            connect(_pianoTools, SIGNAL(keyPressed(int, bool, int)), SLOT(midiNoteReceived(int, bool, int)));</a>
<a name="ln5356">            connect(_pianoTools, SIGNAL(keyReleased(int, bool, int)), SLOT(midiNoteReceived(int, bool, int)));</a>
<a name="ln5357">            connect(_pianoTools, SIGNAL(visibilityChanged(bool)), a, SLOT(setChecked(bool)));</a>
<a name="ln5358">            }</a>
<a name="ln5359">      if (visible) {</a>
<a name="ln5360">            reDisplayDockWidget(_pianoTools, visible);</a>
<a name="ln5361">            if (currentScore())</a>
<a name="ln5362">                  _pianoTools-&gt;changeSelection(currentScore()-&gt;selection());</a>
<a name="ln5363">            else</a>
<a name="ln5364">                  _pianoTools-&gt;clearSelection();</a>
<a name="ln5365">            }</a>
<a name="ln5366">      else {</a>
<a name="ln5367">            if (_pianoTools)</a>
<a name="ln5368">                  _pianoTools-&gt;hide();</a>
<a name="ln5369">            }</a>
<a name="ln5370">      }</a>
<a name="ln5371"> </a>
<a name="ln5372">//---------------------------------------------------------</a>
<a name="ln5373">//   showPluginCreator</a>
<a name="ln5374">//---------------------------------------------------------</a>
<a name="ln5375"> </a>
<a name="ln5376">void MuseScore::showPluginCreator(QAction* a)</a>
<a name="ln5377">      {</a>
<a name="ln5378">#ifdef SCRIPT_INTERFACE</a>
<a name="ln5379">      bool on = a-&gt;isChecked();</a>
<a name="ln5380">      if (on) {</a>
<a name="ln5381">            if (_pluginCreator == 0) {</a>
<a name="ln5382">                  _pluginCreator = new PluginCreator(0);</a>
<a name="ln5383">                  connect(_pluginCreator, SIGNAL(closed(bool)), a, SLOT(setChecked(bool)));</a>
<a name="ln5384">                  }</a>
<a name="ln5385">            _pluginCreator-&gt;show();</a>
<a name="ln5386">            }</a>
<a name="ln5387">      else {</a>
<a name="ln5388">            if (_pluginCreator)</a>
<a name="ln5389">                  _pluginCreator-&gt;hide();</a>
<a name="ln5390">            }</a>
<a name="ln5391">#endif</a>
<a name="ln5392">      }</a>
<a name="ln5393"> </a>
<a name="ln5394">//---------------------------------------------------------</a>
<a name="ln5395">//   showPluginManager</a>
<a name="ln5396">//---------------------------------------------------------</a>
<a name="ln5397"> </a>
<a name="ln5398">void MuseScore::showPluginManager()</a>
<a name="ln5399">      {</a>
<a name="ln5400">#ifdef SCRIPT_INTERFACE</a>
<a name="ln5401">      pluginManager-&gt;init();</a>
<a name="ln5402">      pluginManager-&gt;show();</a>
<a name="ln5403">#endif</a>
<a name="ln5404">      }</a>
<a name="ln5405"> </a>
<a name="ln5406">//---------------------------------------------------------</a>
<a name="ln5407">//   showMediaDialog</a>
<a name="ln5408">//---------------------------------------------------------</a>
<a name="ln5409"> </a>
<a name="ln5410">void MuseScore::showMediaDialog()</a>
<a name="ln5411">      {</a>
<a name="ln5412">      if (_mediaDialog == 0)</a>
<a name="ln5413">            _mediaDialog = new MediaDialog(this);</a>
<a name="ln5414">      _mediaDialog-&gt;setScore(cs);</a>
<a name="ln5415">      _mediaDialog-&gt;exec();</a>
<a name="ln5416">      }</a>
<a name="ln5417"> </a>
<a name="ln5418">//---------------------------------------------------------</a>
<a name="ln5419">//   getPaletteWorkspace</a>
<a name="ln5420">//---------------------------------------------------------</a>
<a name="ln5421"> </a>
<a name="ln5422">PaletteWorkspace* MuseScore::getPaletteWorkspace()</a>
<a name="ln5423">      {</a>
<a name="ln5424">      if (!paletteWorkspace) {</a>
<a name="ln5425">            PaletteTreeModel* emptyModel = new PaletteTreeModel(new PaletteTree);</a>
<a name="ln5426">            PaletteTreeModel* masterPaletteModel = new PaletteTreeModel(MuseScore::newMasterPaletteTree());</a>
<a name="ln5427"> </a>
<a name="ln5428">            paletteWorkspace = new PaletteWorkspace(emptyModel, masterPaletteModel, /* parent */ this);</a>
<a name="ln5429">            emptyModel-&gt;setParent(paletteWorkspace);</a>
<a name="ln5430">            masterPaletteModel-&gt;setParent(paletteWorkspace);</a>
<a name="ln5431"> </a>
<a name="ln5432">            if (WorkspacesManager::currentWorkspace())</a>
<a name="ln5433">                  connect(paletteWorkspace, &amp;PaletteWorkspace::userPaletteChanged, WorkspacesManager::currentWorkspace(), QOverload&lt;&gt;::of(&amp;Workspace::setDirty), Qt::UniqueConnection);</a>
<a name="ln5434">            }</a>
<a name="ln5435"> </a>
<a name="ln5436">      return paletteWorkspace;</a>
<a name="ln5437">      }</a>
<a name="ln5438"> </a>
<a name="ln5439">//---------------------------------------------------------</a>
<a name="ln5440">//   qmlDockWidgets</a>
<a name="ln5441">//---------------------------------------------------------</a>
<a name="ln5442"> </a>
<a name="ln5443">std::vector&lt;QmlDockWidget*&gt; MuseScore::qmlDockWidgets()</a>
<a name="ln5444">      {</a>
<a name="ln5445">      return { paletteWidget };</a>
<a name="ln5446">      }</a>
<a name="ln5447"> </a>
<a name="ln5448">//---------------------------------------------------------</a>
<a name="ln5449">//   midiNoteReceived</a>
<a name="ln5450">//---------------------------------------------------------</a>
<a name="ln5451"> </a>
<a name="ln5452">void MuseScore::midiNoteReceived(int pitch, bool ctrl, int vel)</a>
<a name="ln5453">      {</a>
<a name="ln5454">      if (cv)</a>
<a name="ln5455">            cv-&gt;midiNoteReceived(pitch, ctrl, vel);</a>
<a name="ln5456">      }</a>
<a name="ln5457"> </a>
<a name="ln5458">//---------------------------------------------------------</a>
<a name="ln5459">//   switchLayer</a>
<a name="ln5460">//---------------------------------------------------------</a>
<a name="ln5461"> </a>
<a name="ln5462">void MuseScore::switchLayer(const QString&amp; s)</a>
<a name="ln5463">      {</a>
<a name="ln5464">      if (cs-&gt;switchLayer(s)) {</a>
<a name="ln5465">            cs-&gt;setLayoutAll();</a>
<a name="ln5466">            cs-&gt;update();</a>
<a name="ln5467">            }</a>
<a name="ln5468">      }</a>
<a name="ln5469"> </a>
<a name="ln5470">//---------------------------------------------------------</a>
<a name="ln5471">//   switchPlayMode</a>
<a name="ln5472">//---------------------------------------------------------</a>
<a name="ln5473"> </a>
<a name="ln5474">void MuseScore::switchPlayMode(int mode)</a>
<a name="ln5475">      {</a>
<a name="ln5476">      if (cs)</a>
<a name="ln5477">            cs-&gt;setPlayMode(PlayMode(mode));</a>
<a name="ln5478">      }</a>
<a name="ln5479"> </a>
<a name="ln5480">//---------------------------------------------------------</a>
<a name="ln5481">//   networkFinished</a>
<a name="ln5482">//---------------------------------------------------------</a>
<a name="ln5483"> </a>
<a name="ln5484">void MuseScore::networkFinished()</a>
<a name="ln5485">      {</a>
<a name="ln5486">      QNetworkReply* reply = qobject_cast&lt;QNetworkReply*&gt;(QObject::sender());</a>
<a name="ln5487">      if (reply-&gt;error() != QNetworkReply::NoError) {</a>
<a name="ln5488">            qDebug(&quot;Error while checking update [%s]&quot;, qPrintable(reply-&gt;errorString()));</a>
<a name="ln5489">            return;</a>
<a name="ln5490">            }</a>
<a name="ln5491">      QByteArray ha = reply-&gt;rawHeader(&quot;Content-Disposition&quot;);</a>
<a name="ln5492">      QString s(ha);</a>
<a name="ln5493">      QString name;</a>
<a name="ln5494">      QRegExp re(&quot;.*filename=\&quot;(.*)\&quot;&quot;);</a>
<a name="ln5495"> </a>
<a name="ln5496">      if (!s.isEmpty() &amp;&amp; re.indexIn(s) != -1) {</a>
<a name="ln5497">            name = re.cap(1);</a>
<a name="ln5498">             }</a>
<a name="ln5499">      else {</a>
<a name="ln5500">            QUrl url = reply-&gt;url();</a>
<a name="ln5501">            QString path = url.path();</a>
<a name="ln5502">            qDebug(&quot;Path &lt;%s&gt;&quot;, qPrintable(path));</a>
<a name="ln5503">            QFileInfo fi(path);</a>
<a name="ln5504">            name = fi.fileName();</a>
<a name="ln5505">            }</a>
<a name="ln5506"> </a>
<a name="ln5507">      qDebug(&quot;header &lt;%s&gt;&quot;, qPrintable(s));</a>
<a name="ln5508">      qDebug(&quot;name &lt;%s&gt;&quot;, qPrintable(name));</a>
<a name="ln5509"> </a>
<a name="ln5510">      QByteArray dta = reply-&gt;readAll();</a>
<a name="ln5511">      QString tmpName = QDir::tempPath () + &quot;/&quot;+ name;</a>
<a name="ln5512">      QFile f(tmpName);</a>
<a name="ln5513">      f.open(QIODevice::WriteOnly);</a>
<a name="ln5514">      f.write(dta);</a>
<a name="ln5515">      f.close();</a>
<a name="ln5516"> </a>
<a name="ln5517">      reply-&gt;deleteLater();</a>
<a name="ln5518"> </a>
<a name="ln5519">      MasterScore* score = readScore(tmpName);</a>
<a name="ln5520">      if (!score) {</a>
<a name="ln5521">            qDebug(&quot;readScore failed&quot;);</a>
<a name="ln5522">            return;</a>
<a name="ln5523">            }</a>
<a name="ln5524">      score-&gt;setCreated(true);</a>
<a name="ln5525">      setCurrentScoreView(appendScore(score));</a>
<a name="ln5526">      }</a>
<a name="ln5527"> </a>
<a name="ln5528">//---------------------------------------------------------</a>
<a name="ln5529">//   loadFile</a>
<a name="ln5530">//    load file from url</a>
<a name="ln5531">//---------------------------------------------------------</a>
<a name="ln5532"> </a>
<a name="ln5533">void MuseScore::loadFile(const QString&amp; s)</a>
<a name="ln5534">      {</a>
<a name="ln5535">      loadFile(QUrl(s));</a>
<a name="ln5536">      }</a>
<a name="ln5537"> </a>
<a name="ln5538">void MuseScore::loadFile(const QUrl&amp; url)</a>
<a name="ln5539">      {</a>
<a name="ln5540">      QEventLoop loop;</a>
<a name="ln5541">      QNetworkReply* nr = mscore-&gt;networkManager()-&gt;get(QNetworkRequest(url));</a>
<a name="ln5542">      connect(nr, SIGNAL(finished()), this,</a>
<a name="ln5543">               SLOT(networkFinished()));</a>
<a name="ln5544">      connect(nr, SIGNAL(finished()), &amp;loop, SLOT(quit()));</a>
<a name="ln5545">      loop.exec();</a>
<a name="ln5546">      }</a>
<a name="ln5547"> </a>
<a name="ln5548">//---------------------------------------------------------</a>
<a name="ln5549">//   networkManager</a>
<a name="ln5550">//---------------------------------------------------------</a>
<a name="ln5551"> </a>
<a name="ln5552">QNetworkAccessManager* MuseScore::networkManager()</a>
<a name="ln5553">      {</a>
<a name="ln5554">      if (!_networkManager)</a>
<a name="ln5555">            _networkManager = new QNetworkAccessManager(this);</a>
<a name="ln5556">      return _networkManager;</a>
<a name="ln5557">      }</a>
<a name="ln5558"> </a>
<a name="ln5559">//---------------------------------------------------------</a>
<a name="ln5560">//   selectSimilar</a>
<a name="ln5561">//---------------------------------------------------------</a>
<a name="ln5562"> </a>
<a name="ln5563">void MuseScore::selectSimilar(Element* e, bool sameStaff)</a>
<a name="ln5564">      {</a>
<a name="ln5565">      Score* score = e-&gt;score();</a>
<a name="ln5566">      score-&gt;selectSimilar(e, sameStaff);</a>
<a name="ln5567"> </a>
<a name="ln5568">      if (score-&gt;selectionChanged()) {</a>
<a name="ln5569">            score-&gt;setSelectionChanged(false);</a>
<a name="ln5570">            SelState ss = score-&gt;selection().state();</a>
<a name="ln5571">            selectionChanged(ss);</a>
<a name="ln5572">            }</a>
<a name="ln5573">      }</a>
<a name="ln5574"> </a>
<a name="ln5575">void MuseScore::selectSimilarInRange(Element* e)</a>
<a name="ln5576">      {</a>
<a name="ln5577">      Score* score = e-&gt;score();</a>
<a name="ln5578">      score-&gt;selectSimilarInRange(e);</a>
<a name="ln5579"> </a>
<a name="ln5580">      if (score-&gt;selectionChanged()) {</a>
<a name="ln5581">            score-&gt;setSelectionChanged(false);</a>
<a name="ln5582">            SelState ss = score-&gt;selection().state();</a>
<a name="ln5583">            selectionChanged(ss);</a>
<a name="ln5584">            }</a>
<a name="ln5585">      }</a>
<a name="ln5586"> </a>
<a name="ln5587">//---------------------------------------------------------</a>
<a name="ln5588">//   selectElementDialog</a>
<a name="ln5589">//---------------------------------------------------------</a>
<a name="ln5590"> </a>
<a name="ln5591">void MuseScore::selectElementDialog(Element* e)</a>
<a name="ln5592">      {</a>
<a name="ln5593">      Score* score = e-&gt;score();</a>
<a name="ln5594">      if (e-&gt;isNote()) {</a>
<a name="ln5595">            Note* n = toNote(e);</a>
<a name="ln5596">            SelectNoteDialog sd(n, 0);</a>
<a name="ln5597">            // hide same string option if it doesn't make sense for the instrument</a>
<a name="ln5598">            if (n-&gt;staff()-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;strings() == 0)</a>
<a name="ln5599">                  sd.setSameStringVisible(false);</a>
<a name="ln5600">            if (sd.exec()) {</a>
<a name="ln5601">                  NotePattern pattern;</a>
<a name="ln5602">                  sd.setPattern(&amp;pattern);</a>
<a name="ln5603"> </a>
<a name="ln5604">                  if (sd.isInSelection())</a>
<a name="ln5605">                        score-&gt;scanElementsInRange(&amp;pattern, Score::collectNoteMatch);</a>
<a name="ln5606">                  else</a>
<a name="ln5607">                        score-&gt;scanElements(&amp;pattern, Score::collectNoteMatch);</a>
<a name="ln5608"> </a>
<a name="ln5609">                  if (sd.doReplace()) {</a>
<a name="ln5610">                        score-&gt;select(0, SelectType::SINGLE, 0);</a>
<a name="ln5611">                        for (Note* ee : pattern.el)</a>
<a name="ln5612">                              score-&gt;select(ee, SelectType::ADD, 0);</a>
<a name="ln5613">                        }</a>
<a name="ln5614">                  else if (sd.doSubtract()) {</a>
<a name="ln5615">                        QList&lt;Element*&gt; sl(score-&gt;selection().elements());</a>
<a name="ln5616">                        for (Note* ee : pattern.el)</a>
<a name="ln5617">                              sl.removeOne(ee);</a>
<a name="ln5618">                        score-&gt;select(0, SelectType::SINGLE, 0);</a>
<a name="ln5619">                        for (Element* ee : sl)</a>
<a name="ln5620">                              score-&gt;select(ee, SelectType::ADD, 0);</a>
<a name="ln5621">                        }</a>
<a name="ln5622">                  else if (sd.doAdd()) {</a>
<a name="ln5623">                        QList&lt;Element*&gt; sl(score-&gt;selection().elements());</a>
<a name="ln5624">                        for (Note* ee : pattern.el) {</a>
<a name="ln5625">                              if(!sl.contains(ee))</a>
<a name="ln5626">                                    score-&gt;select(ee, SelectType::ADD, 0);</a>
<a name="ln5627">                              }</a>
<a name="ln5628">                        }</a>
<a name="ln5629">                  }</a>
<a name="ln5630">            }</a>
<a name="ln5631">      else {</a>
<a name="ln5632">            SelectDialog sd(e, 0);</a>
<a name="ln5633">            if (sd.exec()) {</a>
<a name="ln5634">                  ElementPattern pattern;</a>
<a name="ln5635">                  sd.setPattern(&amp;pattern);</a>
<a name="ln5636"> </a>
<a name="ln5637">                  if (sd.isInSelection())</a>
<a name="ln5638">                        score-&gt;scanElementsInRange(&amp;pattern, Score::collectMatch);</a>
<a name="ln5639">                  else</a>
<a name="ln5640">                        score-&gt;scanElements(&amp;pattern, Score::collectMatch);</a>
<a name="ln5641"> </a>
<a name="ln5642">                  if (sd.doReplace()) {</a>
<a name="ln5643">                        score-&gt;select(0, SelectType::SINGLE, 0);</a>
<a name="ln5644">                        for (Element* ee : pattern.el)</a>
<a name="ln5645">                              score-&gt;select(ee, SelectType::ADD, 0);</a>
<a name="ln5646">                        }</a>
<a name="ln5647">                  else if (sd.doSubtract()) {</a>
<a name="ln5648">                        QList&lt;Element*&gt; sl(score-&gt;selection().elements());</a>
<a name="ln5649">                        for (Element* ee : pattern.el)</a>
<a name="ln5650">                              sl.removeOne(ee);</a>
<a name="ln5651">                        score-&gt;select(0, SelectType::SINGLE, 0);</a>
<a name="ln5652">                        for (Element* ee : sl)</a>
<a name="ln5653">                              score-&gt;select(ee, SelectType::ADD, 0);</a>
<a name="ln5654">                        }</a>
<a name="ln5655">                  else if (sd.doAdd()) {</a>
<a name="ln5656">                        QList&lt;Element*&gt; sl(score-&gt;selection().elements());</a>
<a name="ln5657">                        for (Element* ee : pattern.el) {</a>
<a name="ln5658">                              if(!sl.contains(ee))</a>
<a name="ln5659">                                    score-&gt;select(ee, SelectType::ADD, 0);</a>
<a name="ln5660">                              }</a>
<a name="ln5661">                        }</a>
<a name="ln5662">                  }</a>
<a name="ln5663">            }</a>
<a name="ln5664">      if (score-&gt;selectionChanged()) {</a>
<a name="ln5665">            score-&gt;setSelectionChanged(false);</a>
<a name="ln5666">            SelState ss = score-&gt;selection().state();</a>
<a name="ln5667">            selectionChanged(ss);</a>
<a name="ln5668">            }</a>
<a name="ln5669">      }</a>
<a name="ln5670"> </a>
<a name="ln5671">//---------------------------------------------------------</a>
<a name="ln5672">//   RecordButton</a>
<a name="ln5673">//---------------------------------------------------------</a>
<a name="ln5674"> </a>
<a name="ln5675">RecordButton::RecordButton(QWidget* parent)</a>
<a name="ln5676">   : SimpleButton(&quot;:/data/recordOn.svg&quot;, &quot;:/data/recordOff.svg&quot;, parent)</a>
<a name="ln5677">      {</a>
<a name="ln5678">      setCheckable(true);</a>
<a name="ln5679">      defaultAction()-&gt;setCheckable(true);</a>
<a name="ln5680">      setToolTip(qApp-&gt;translate(&quot;RecordButton&quot;, &quot;Record&quot;));</a>
<a name="ln5681">      }</a>
<a name="ln5682"> </a>
<a name="ln5683">//---------------------------------------------------------</a>
<a name="ln5684">//   GreendotButton</a>
<a name="ln5685">//---------------------------------------------------------</a>
<a name="ln5686"> </a>
<a name="ln5687">GreendotButton::GreendotButton(QWidget* parent)</a>
<a name="ln5688">   : SimpleButton(&quot;:/data/greendot.svg&quot;, &quot;:/data/darkgreendot.svg&quot;, parent)</a>
<a name="ln5689">      {</a>
<a name="ln5690">      setCheckable(true);</a>
<a name="ln5691">      setToolTip(qApp-&gt;translate(&quot;GreendotButton&quot;, &quot;Record&quot;));</a>
<a name="ln5692">      }</a>
<a name="ln5693"> </a>
<a name="ln5694">//---------------------------------------------------------</a>
<a name="ln5695">//   drawHandle</a>
<a name="ln5696">//---------------------------------------------------------</a>
<a name="ln5697"> </a>
<a name="ln5698">QRectF drawHandle(QPainter&amp; p, const QPointF&amp; pos, bool active)</a>
<a name="ln5699">      {</a>
<a name="ln5700">      p.save();</a>
<a name="ln5701">      p.setPen(QPen(QColor(MScore::selectColor[0]), 2.0/p.matrix().m11()));</a>
<a name="ln5702">      if (active)</a>
<a name="ln5703">            p.setBrush(MScore::selectColor[0]);</a>
<a name="ln5704">      else</a>
<a name="ln5705">            p.setBrush(Qt::NoBrush);</a>
<a name="ln5706">      qreal w = 8.0 / p.matrix().m11();</a>
<a name="ln5707">      qreal h = 8.0 / p.matrix().m22();</a>
<a name="ln5708"> </a>
<a name="ln5709">      QRectF r(-w/2, -h/2, w, h);</a>
<a name="ln5710">      r.translate(pos);</a>
<a name="ln5711">      p.drawRect(r);</a>
<a name="ln5712">      p.restore();</a>
<a name="ln5713">      return r;</a>
<a name="ln5714">      }</a>
<a name="ln5715"> </a>
<a name="ln5716">//---------------------------------------------------------</a>
<a name="ln5717">//   transpose</a>
<a name="ln5718">//---------------------------------------------------------</a>
<a name="ln5719"> </a>
<a name="ln5720">void MuseScore::transpose()</a>
<a name="ln5721">      {</a>
<a name="ln5722">      if (cs-&gt;last() == 0)     // empty score?</a>
<a name="ln5723">            return;</a>
<a name="ln5724"> </a>
<a name="ln5725">      bool noSelection = cs-&gt;selection().isNone();</a>
<a name="ln5726">      if (noSelection)</a>
<a name="ln5727">            cs-&gt;cmdSelectAll();</a>
<a name="ln5728">      bool rangeSelection = cs-&gt;selection().isRange();</a>
<a name="ln5729">      TransposeDialog td;</a>
<a name="ln5730"> </a>
<a name="ln5731">      // TRANSPOSE_BY_KEY and &quot;transpose keys&quot; is only possible if selection state is SelState::RANGE</a>
<a name="ln5732">      td.enableTransposeKeys(rangeSelection);</a>
<a name="ln5733">      td.enableTransposeByKey(rangeSelection);</a>
<a name="ln5734">      td.enableTransposeChordNames(rangeSelection);</a>
<a name="ln5735"> </a>
<a name="ln5736">      int startStaffIdx = 0;</a>
<a name="ln5737">      int endStaffIdx   = 0;</a>
<a name="ln5738">      Fraction startTick = Fraction(0,1);</a>
<a name="ln5739">      if (rangeSelection) {</a>
<a name="ln5740">            startStaffIdx = cs-&gt;selection().staffStart();</a>
<a name="ln5741">            endStaffIdx   = cs-&gt;selection().staffEnd();</a>
<a name="ln5742">            startTick     = cs-&gt;selection().tickStart();</a>
<a name="ln5743">            }</a>
<a name="ln5744"> </a>
<a name="ln5745">      // find the key of the first pitched staff</a>
<a name="ln5746">      Key key = Key::C;</a>
<a name="ln5747">      for (int i = startStaffIdx; i &lt; endStaffIdx; ++i) {</a>
<a name="ln5748">            Staff* staff = cs-&gt;staff(i);</a>
<a name="ln5749">            if (staff-&gt;isPitchedStaff(startTick)) {</a>
<a name="ln5750">                  key = staff-&gt;key(startTick);</a>
<a name="ln5751">                  if (!cs-&gt;styleB(Sid::concertPitch)) {</a>
<a name="ln5752">                        int diff = staff-&gt;part()-&gt;instrument(startTick)-&gt;transpose().chromatic;</a>
<a name="ln5753">                        if (diff)</a>
<a name="ln5754">                              key = transposeKey(key, diff, staff-&gt;part()-&gt;preferSharpFlat());</a>
<a name="ln5755">                        }</a>
<a name="ln5756">                  break;</a>
<a name="ln5757">                  }</a>
<a name="ln5758">            }</a>
<a name="ln5759"> </a>
<a name="ln5760">      td.setKey(key);</a>
<a name="ln5761">      if (!td.exec())</a>
<a name="ln5762">            return;</a>
<a name="ln5763"> </a>
<a name="ln5764">      cs-&gt;transpose(td.mode(), td.direction(), td.transposeKey(), td.transposeInterval(),</a>
<a name="ln5765">         td.getTransposeKeys(), td.getTransposeChordNames(), td.useDoubleSharpsFlats());</a>
<a name="ln5766"> </a>
<a name="ln5767">      if (noSelection)</a>
<a name="ln5768">            cs-&gt;deselectAll();</a>
<a name="ln5769">      }</a>
<a name="ln5770"> </a>
<a name="ln5771">//---------------------------------------------------------</a>
<a name="ln5772">//   cmd</a>
<a name="ln5773">//---------------------------------------------------------</a>
<a name="ln5774"> </a>
<a name="ln5775">void MuseScore::cmd(QAction* a)</a>
<a name="ln5776">      {</a>
<a name="ln5777">      if (inChordEditor)      // HACK</a>
<a name="ln5778">            return;</a>
<a name="ln5779"> </a>
<a name="ln5780">      MScore::setError(MS_NO_ERROR);</a>
<a name="ln5781"> </a>
<a name="ln5782">      QString cmdn(a-&gt;data().toString());</a>
<a name="ln5783"> </a>
<a name="ln5784">      if (MScore::debugMode)</a>
<a name="ln5785">            qDebug(&quot;MuseScore::cmd &lt;%s&gt;&quot;, qPrintable(cmdn));</a>
<a name="ln5786"> </a>
<a name="ln5787">      const Shortcut* sc = Shortcut::getShortcut(cmdn.toLatin1().data());</a>
<a name="ln5788">      if (sc == 0) {</a>
<a name="ln5789">            qDebug(&quot;MuseScore::cmd(): unknown action &lt;%s&gt;&quot;, qPrintable(cmdn));</a>
<a name="ln5790">            return;</a>
<a name="ln5791">            }</a>
<a name="ln5792">      if (cs &amp;&amp; (sc-&gt;state() &amp; _sstate) == 0) {</a>
<a name="ln5793">            qDebug(&quot;invalid state %04x %04x&quot;, sc-&gt;state(), _sstate);</a>
<a name="ln5794">            QMessageBox::warning(0,</a>
<a name="ln5795">               tr(&quot;Invalid Command&quot;),</a>
<a name="ln5796">               tr(&quot;Command %1 not valid in current state&quot;).arg(cmdn));</a>
<a name="ln5797">            return;</a>
<a name="ln5798">            }</a>
<a name="ln5799">      if (cmdn == &quot;toggle-palette&quot;) {</a>
<a name="ln5800">            showPalette(a-&gt;isChecked());</a>
<a name="ln5801">            if (a-&gt;isChecked()) {</a>
<a name="ln5802">                  lastFocusWidget = QApplication::focusWidget();</a>
<a name="ln5803">                  paletteWidget-&gt;activateSearchBox();</a>
<a name="ln5804">                  }</a>
<a name="ln5805">            else {</a>
<a name="ln5806">                  if (lastFocusWidget)</a>
<a name="ln5807">                        lastFocusWidget-&gt;setFocus();</a>
<a name="ln5808">                  }</a>
<a name="ln5809">            return;</a>
<a name="ln5810">            }</a>
<a name="ln5811">      if (cmdn == &quot;palette-search&quot;) {</a>
<a name="ln5812">            showPalette(true);</a>
<a name="ln5813">            if (paletteWidget)</a>
<a name="ln5814">                  paletteWidget-&gt;activateSearchBox();</a>
<a name="ln5815">            return;</a>
<a name="ln5816">            }</a>
<a name="ln5817">      if (cmdn == &quot;apply-current-palette-element&quot;) {</a>
<a name="ln5818">            if (paletteWidget)</a>
<a name="ln5819">                  paletteWidget-&gt;applyCurrentPaletteElement();</a>
<a name="ln5820">            return;</a>
<a name="ln5821">            }</a>
<a name="ln5822">      if (cmdn == &quot;repeat-cmd&quot;) {</a>
<a name="ln5823">            a  = lastCmd;</a>
<a name="ln5824">            sc = lastShortcut;</a>
<a name="ln5825">            if (a == 0)</a>
<a name="ln5826">                  return;</a>
<a name="ln5827">            cmdn = a-&gt;data().toString();</a>
<a name="ln5828">            }</a>
<a name="ln5829">      else {</a>
<a name="ln5830">            lastCmd = a;</a>
<a name="ln5831">            lastShortcut = sc;</a>
<a name="ln5832">            }</a>
<a name="ln5833"> </a>
<a name="ln5834">      if (sc-&gt;needsScore() &amp;&amp; ! cs) {</a>
<a name="ln5835">            qDebug(&quot;no score&quot;);</a>
<a name="ln5836">            return;</a>
<a name="ln5837">            }</a>
<a name="ln5838">      if (sc-&gt;isCmd()) {</a>
<a name="ln5839">            if (!cv-&gt;editMode())</a>
<a name="ln5840">                  cs-&gt;startCmd();</a>
<a name="ln5841">            }</a>
<a name="ln5842">      cmd(a, cmdn);</a>
<a name="ln5843">      if (lastShortcut-&gt;isCmd())</a>
<a name="ln5844">            cs-&gt;endCmd();</a>
<a name="ln5845">      else</a>
<a name="ln5846">            endCmd();</a>
<a name="ln5847">      TourHandler::startTour(cmdn);</a>
<a name="ln5848">      }</a>
<a name="ln5849"> </a>
<a name="ln5850">//---------------------------------------------------------</a>
<a name="ln5851">//   endCmd</a>
<a name="ln5852">//    Called after every command action (including every</a>
<a name="ln5853">//    mouse action).</a>
<a name="ln5854">//    Updates the UI after a possible score change.</a>
<a name="ln5855">//---------------------------------------------------------</a>
<a name="ln5856"> </a>
<a name="ln5857">void MuseScore::endCmd(bool undoRedo)</a>
<a name="ln5858">      {</a>
<a name="ln5859">#ifdef SCRIPT_INTERFACE</a>
<a name="ln5860">      getPluginEngine()-&gt;beginEndCmd(this, undoRedo);</a>
<a name="ln5861">#endif</a>
<a name="ln5862">      if (timeline())</a>
<a name="ln5863">            timeline()-&gt;updateGrid();</a>
<a name="ln5864">      if (MScore::_error != MS_NO_ERROR)</a>
<a name="ln5865">            showError();</a>
<a name="ln5866">      if (cs) {</a>
<a name="ln5867">            setPos(cs-&gt;inputState().tick());</a>
<a name="ln5868">            updateInputState(cs);</a>
<a name="ln5869">            updateUndoRedo();</a>
<a name="ln5870">            dirtyChanged(cs);</a>
<a name="ln5871">            scoreCmpTool-&gt;updateDiff();</a>
<a name="ln5872">            Element* e = cs-&gt;selection().element();</a>
<a name="ln5873"> </a>
<a name="ln5874">            // For multiple notes selected check if they all have same pitch and tuning</a>
<a name="ln5875">            bool samePitch = true;</a>
<a name="ln5876">            int pitch    = -1;</a>
<a name="ln5877">            float tuning = 0;</a>
<a name="ln5878">            for (Element* ee : cs-&gt;selection().elements()) {</a>
<a name="ln5879">                  if (!ee-&gt;isNote()) {</a>
<a name="ln5880">                        samePitch = false;</a>
<a name="ln5881">                        break;</a>
<a name="ln5882">                        }</a>
<a name="ln5883">                  Note* note = toNote(ee);</a>
<a name="ln5884">                  if (pitch == -1) {</a>
<a name="ln5885">                        pitch = note-&gt;ppitch();</a>
<a name="ln5886">                        tuning = note-&gt;tuning();</a>
<a name="ln5887">                        }</a>
<a name="ln5888">                  else if (note-&gt;ppitch() != pitch || fabs(tuning - note-&gt;tuning()) &gt; 0.01) {</a>
<a name="ln5889">                        samePitch = false;</a>
<a name="ln5890">                        break;</a>
<a name="ln5891">                        }</a>
<a name="ln5892">                  }</a>
<a name="ln5893">            if (samePitch &amp;&amp; pitch &gt;= 0)</a>
<a name="ln5894">                  e = cs-&gt;selection().elements()[0];</a>
<a name="ln5895"> </a>
<a name="ln5896">            NoteEntryMethod entryMethod = cs-&gt;noteEntryMethod();</a>
<a name="ln5897">            if (e &amp;&amp; (cs-&gt;playNote() || cs-&gt;playChord())</a>
<a name="ln5898">                        &amp;&amp; entryMethod != NoteEntryMethod::REALTIME_AUTO</a>
<a name="ln5899">                        &amp;&amp; entryMethod != NoteEntryMethod::REALTIME_MANUAL) {</a>
<a name="ln5900">                  if (cs-&gt;playChord() &amp;&amp; preferences.getBool(PREF_SCORE_CHORD_PLAYONADDNOTE) &amp;&amp;  e-&gt;type() == ElementType::NOTE)</a>
<a name="ln5901">                        play(static_cast&lt;Note*&gt;(e)-&gt;chord());</a>
<a name="ln5902">                  else</a>
<a name="ln5903">                        play(e);</a>
<a name="ln5904">                  cs-&gt;setPlayNote(false);</a>
<a name="ln5905">                  cs-&gt;setPlayChord(false);</a>
<a name="ln5906">                  }</a>
<a name="ln5907">            MasterScore* ms = cs-&gt;masterScore();</a>
<a name="ln5908">            if (ms-&gt;excerptsChanged()) {</a>
<a name="ln5909">                  if (tab1) {</a>
<a name="ln5910">                        tab1-&gt;blockSignals(ctab != tab1);</a>
<a name="ln5911">                        tab1-&gt;updateExcerpts();</a>
<a name="ln5912">                        tab1-&gt;blockSignals(false);</a>
<a name="ln5913">                        }</a>
<a name="ln5914">                  if (tab2) {</a>
<a name="ln5915">                        tab2-&gt;blockSignals(ctab != tab2);</a>
<a name="ln5916">                        tab2-&gt;updateExcerpts();</a>
<a name="ln5917">                        tab2-&gt;blockSignals(false);</a>
<a name="ln5918">                        }</a>
<a name="ln5919">                  ms-&gt;setExcerptsChanged(false);</a>
<a name="ln5920">                  }</a>
<a name="ln5921">            if (ms-&gt;instrumentsChanged()) {</a>
<a name="ln5922">                  if (!noSeq &amp;&amp; (seq &amp;&amp; seq-&gt;isRunning()))</a>
<a name="ln5923">                        seq-&gt;initInstruments();</a>
<a name="ln5924">                  instrumentChanged();                // update mixer</a>
<a name="ln5925">                  ms-&gt;setInstrumentsChanged(false);</a>
<a name="ln5926">                  }</a>
<a name="ln5927">            if (cs-&gt;selectionChanged()) {</a>
<a name="ln5928">                  cs-&gt;setSelectionChanged(false);</a>
<a name="ln5929">                  SelState ss = cs-&gt;selection().state();</a>
<a name="ln5930">                  selectionChanged(ss);</a>
<a name="ln5931">                  }</a>
<a name="ln5932"> </a>
<a name="ln5933">            if (cv)</a>
<a name="ln5934">                  cv-&gt;moveViewportToLastEdit();</a>
<a name="ln5935"> </a>
<a name="ln5936">            getAction(&quot;concert-pitch&quot;)-&gt;setChecked(cs-&gt;styleB(Sid::concertPitch));</a>
<a name="ln5937"> </a>
<a name="ln5938">            if (e == 0 &amp;&amp; cs-&gt;noteEntryMode())</a>
<a name="ln5939">                  e = cs-&gt;inputState().cr();</a>
<a name="ln5940">            updateViewModeCombo();</a>
<a name="ln5941">            ScoreAccessibility::instance()-&gt;updateAccessibilityInfo();</a>
<a name="ln5942">            }</a>
<a name="ln5943">      else {</a>
<a name="ln5944">            selectionChanged(SelState::NONE);</a>
<a name="ln5945">            }</a>
<a name="ln5946">      updateInspector();</a>
<a name="ln5947">      updatePaletteBeamMode();</a>
<a name="ln5948">#ifdef SCRIPT_INTERFACE</a>
<a name="ln5949">      getPluginEngine()-&gt;endEndCmd(this);</a>
<a name="ln5950">#endif</a>
<a name="ln5951">      }</a>
<a name="ln5952"> </a>
<a name="ln5953">//---------------------------------------------------------</a>
<a name="ln5954">//   updateUndoRedo</a>
<a name="ln5955">//---------------------------------------------------------</a>
<a name="ln5956"> </a>
<a name="ln5957">void MuseScore::updateUndoRedo()</a>
<a name="ln5958">      {</a>
<a name="ln5959">      QAction* a = getAction(&quot;undo&quot;);</a>
<a name="ln5960">      a-&gt;setEnabled(cs ? cs-&gt;undoStack()-&gt;canUndo() : false);</a>
<a name="ln5961">      a = getAction(&quot;redo&quot;);</a>
<a name="ln5962">      a-&gt;setEnabled(cs ? cs-&gt;undoStack()-&gt;canRedo() : false);</a>
<a name="ln5963">      }</a>
<a name="ln5964"> </a>
<a name="ln5965"> </a>
<a name="ln5966">void MuseScore::setPlayRepeats(bool repeat)</a>
<a name="ln5967">      {</a>
<a name="ln5968">      getAction(&quot;repeat&quot;)-&gt;setChecked(repeat);</a>
<a name="ln5969">      preferences.setPreference(PREF_APP_PLAYBACK_PLAYREPEATS, repeat);</a>
<a name="ln5970">      MScore::playRepeats = repeat;</a>
<a name="ln5971">      if (cs) {</a>
<a name="ln5972">            cs-&gt;masterScore()-&gt;setExpandRepeats(repeat);</a>
<a name="ln5973">            emit cs-&gt;playlistChanged();</a>
<a name="ln5974">            }</a>
<a name="ln5975">      }</a>
<a name="ln5976"> </a>
<a name="ln5977">//---------------------------------------------------------</a>
<a name="ln5978">//   setPlayPartOnly</a>
<a name="ln5979">//---------------------------------------------------------</a>
<a name="ln5980"> </a>
<a name="ln5981">void MuseScore::setPlayPartOnly(bool val)</a>
<a name="ln5982">      {</a>
<a name="ln5983">      _playPartOnly = val;</a>
<a name="ln5984">      if (cs)</a>
<a name="ln5985">            cs-&gt;masterScore()-&gt;setPlaybackScore(_playPartOnly ? cs : cs-&gt;masterScore());</a>
<a name="ln5986">      }</a>
<a name="ln5987"> </a>
<a name="ln5988">//---------------------------------------------------------</a>
<a name="ln5989">//   createScoreTab</a>
<a name="ln5990">//---------------------------------------------------------</a>
<a name="ln5991"> </a>
<a name="ln5992">ScoreTab* MuseScore::createScoreTab()</a>
<a name="ln5993">      {</a>
<a name="ln5994">      ScoreTab* tab = new ScoreTab(&amp;scoreList, this);</a>
<a name="ln5995">      tab-&gt;setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Expanding);</a>
<a name="ln5996">      connect(tab, SIGNAL(currentScoreViewChanged(ScoreView*)), SLOT(setCurrentScoreView(ScoreView*)));</a>
<a name="ln5997">      connect(tab, SIGNAL(tabCloseRequested(int)), SLOT(removeTab(int)));</a>
<a name="ln5998">      connect(tab, SIGNAL(actionTriggered(QAction*)), SLOT(cmd(QAction*)));</a>
<a name="ln5999">      return tab;</a>
<a name="ln6000">      }</a>
<a name="ln6001"> </a>
<a name="ln6002">//---------------------------------------------------------</a>
<a name="ln6003">//   cmd</a>
<a name="ln6004">//---------------------------------------------------------</a>
<a name="ln6005"> </a>
<a name="ln6006">void MuseScore::cmd(QAction* a, const QString&amp; cmd)</a>
<a name="ln6007">      {</a>
<a name="ln6008">      if (ScriptRecorder* rec = getScriptRecorder())</a>
<a name="ln6009">            rec-&gt;recordCommand(cmd);</a>
<a name="ln6010"> </a>
<a name="ln6011">      if (cmd == &quot;instruments&quot;) {</a>
<a name="ln6012">            editInstrList();</a>
<a name="ln6013">            if (mixer)</a>
<a name="ln6014">                  mixer-&gt;setScore(cs);</a>
<a name="ln6015">            }</a>
<a name="ln6016">      else if (cmd == &quot;rewind&quot;) {</a>
<a name="ln6017">            if (cs) {</a>
<a name="ln6018">                  Fraction tick = loop() ? cs-&gt;loopInTick() : Fraction(0,1);</a>
<a name="ln6019">                  seq-&gt;seek(tick.ticks());</a>
<a name="ln6020">                  if (cv) {</a>
<a name="ln6021">                        Measure* m = cs-&gt;tick2measureMM(tick);</a>
<a name="ln6022">                        if (m)</a>
<a name="ln6023">                              cv-&gt;gotoMeasure(m);</a>
<a name="ln6024">                        }</a>
<a name="ln6025">                  if (playPanel)</a>
<a name="ln6026">                        playPanel-&gt;heartBeat(0, 0, 0);</a>
<a name="ln6027">                  }</a>
<a name="ln6028">            }</a>
<a name="ln6029">      else if (cmd == &quot;play-next-measure&quot;)</a>
<a name="ln6030">            seq-&gt;nextMeasure();</a>
<a name="ln6031">      else if (cmd == &quot;play-next-chord&quot;)</a>
<a name="ln6032">            seq-&gt;nextChord();</a>
<a name="ln6033">      else if (cmd == &quot;play-prev-measure&quot;)</a>
<a name="ln6034">            seq-&gt;prevMeasure();</a>
<a name="ln6035">      else if (cmd == &quot;play-prev-chord&quot;)</a>
<a name="ln6036">            seq-&gt;prevChord();</a>
<a name="ln6037">      else if (cmd == &quot;seek-begin&quot;)</a>
<a name="ln6038">            seq-&gt;rewindStart();</a>
<a name="ln6039">      else if (cmd == &quot;seek-end&quot;)</a>
<a name="ln6040">            seq-&gt;seekEnd();</a>
<a name="ln6041">      else if (cmd == &quot;keys&quot;)</a>
<a name="ln6042">            showKeyEditor();</a>
<a name="ln6043">      else if (cmd == &quot;file-open&quot;)</a>
<a name="ln6044">            loadFiles();</a>
<a name="ln6045">      else if (cmd == &quot;file-save&quot;)</a>
<a name="ln6046">            saveFile();</a>
<a name="ln6047">      else if (cmd == saveOnlineMenuItem)</a>
<a name="ln6048">            showUploadScoreDialog();</a>
<a name="ln6049">      else if (cmd == &quot;file-export&quot;)</a>
<a name="ln6050">            exportFile();</a>
<a name="ln6051">      else if (cmd == &quot;file-part-export&quot;)</a>
<a name="ln6052">            exportParts();</a>
<a name="ln6053">      else if (cmd == &quot;file-import-pdf&quot;)</a>
<a name="ln6054">            openExternalLink(&quot;https://musescore.com/import&quot;);</a>
<a name="ln6055">      else if (cmd == &quot;file-close&quot;)</a>
<a name="ln6056">            closeScore(cs);</a>
<a name="ln6057">      else if (cmd == &quot;file-save-as&quot;)</a>
<a name="ln6058">            saveAs(cs, false);</a>
<a name="ln6059">      else if (cmd == &quot;file-save-selection&quot;)</a>
<a name="ln6060">            saveSelection(cs);</a>
<a name="ln6061">      else if (cmd == &quot;file-save-a-copy&quot;)</a>
<a name="ln6062">            saveAs(cs, true);</a>
<a name="ln6063">      else if (cmd == &quot;file-new&quot;)</a>
<a name="ln6064">            newFile();</a>
<a name="ln6065">      else if (cmd == &quot;unroll-repeats&quot;)</a>
<a name="ln6066">            scoreUnrolled(cs-&gt;masterScore());</a>
<a name="ln6067">      else if (cmd == &quot;quit&quot;)</a>
<a name="ln6068">            close();</a>
<a name="ln6069">      else if (cmd == &quot;masterpalette&quot;)</a>
<a name="ln6070">            showMasterPalette();</a>
<a name="ln6071">      else if (cmd == &quot;key-signatures&quot;)</a>
<a name="ln6072">            showMasterPalette(qApp-&gt;translate(&quot;Palette&quot;, &quot;Key Signatures&quot;));</a>
<a name="ln6073">      else if (cmd == &quot;time-signatures&quot;)</a>
<a name="ln6074">            showMasterPalette(qApp-&gt;translate(&quot;Palette&quot;, &quot;Time Signatures&quot;));</a>
<a name="ln6075">      else if (cmd == &quot;symbols&quot;)</a>
<a name="ln6076">            showMasterPalette(qApp-&gt;translate(&quot;MasterPalette&quot;, &quot;Symbols&quot;));</a>
<a name="ln6077">      else if (cmd == &quot;toggle-statusbar&quot;) {</a>
<a name="ln6078">            preferences.setPreference(PREF_UI_APP_SHOWSTATUSBAR, a-&gt;isChecked());</a>
<a name="ln6079">            _statusBar-&gt;setVisible(a-&gt;isChecked());</a>
<a name="ln6080">            }</a>
<a name="ln6081">      else if (cmd == &quot;append-measures&quot;)</a>
<a name="ln6082">            cmdAppendMeasures();</a>
<a name="ln6083">      else if (cmd == &quot;insert-measures&quot;)</a>
<a name="ln6084">            cmdInsertMeasures();</a>
<a name="ln6085">      else if (cmd == &quot;debugger&quot;)</a>
<a name="ln6086">            startDebugger();</a>
<a name="ln6087">      else if (cmd == &quot;album&quot;)</a>
<a name="ln6088">            showAlbumManager();</a>
<a name="ln6089">      else if (cmd == &quot;layer&quot; &amp;&amp; enableExperimental)</a>
<a name="ln6090">            showLayerManager();</a>
<a name="ln6091">      else if (cmd == &quot;backspace&quot;) {</a>
<a name="ln6092">            if (_sstate != STATE_NORMAL )</a>
<a name="ln6093">                  undoRedo(true);</a>
<a name="ln6094">#ifdef Q_OS_MAC</a>
<a name="ln6095">            else if (cv) {</a>
<a name="ln6096">                  cv-&gt;cmd(getAction(&quot;delete&quot;));</a>
<a name="ln6097">                  return;</a>
<a name="ln6098">                  }</a>
<a name="ln6099">#endif</a>
<a name="ln6100">            }</a>
<a name="ln6101">      else if (cmd == &quot;zoomin&quot;)</a>
<a name="ln6102">            incMag();</a>
<a name="ln6103">      else if (cmd == &quot;zoomout&quot;)</a>
<a name="ln6104">            decMag();</a>
<a name="ln6105">      else if (cmd == &quot;zoom100&quot;) {</a>
<a name="ln6106">            if (cv)</a>
<a name="ln6107">                  cv-&gt;setMag(MagIdx::MAG_100, 1.0);</a>
<a name="ln6108">            setMag(1.0);</a>
<a name="ln6109">            }</a>
<a name="ln6110">      else if (cmd == &quot;midi-on&quot;)</a>
<a name="ln6111">            midiinToggled(a-&gt;isChecked());</a>
<a name="ln6112">      else if (cmd == &quot;undo&quot;)</a>
<a name="ln6113">            undoRedo(true);</a>
<a name="ln6114">      else if (cmd == &quot;redo&quot;)</a>
<a name="ln6115">            undoRedo(false);</a>
<a name="ln6116">      else if (cmd == &quot;startcenter&quot;)</a>
<a name="ln6117">            showStartcenter(a-&gt;isChecked());</a>
<a name="ln6118">      else if (cmd == &quot;inspector&quot;)</a>
<a name="ln6119">            showInspector(a-&gt;isChecked());</a>
<a name="ln6120">#ifdef OMR</a>
<a name="ln6121">      else if (cmd == &quot;omr&quot;)</a>
<a name="ln6122">            showOmrPanel(a-&gt;isChecked());</a>
<a name="ln6123">#endif</a>
<a name="ln6124">      else if (cmd == &quot;toggle-playpanel&quot;)</a>
<a name="ln6125">            showPlayPanel(a-&gt;isChecked());</a>
<a name="ln6126">      else if (cmd == &quot;toggle-navigator&quot;)</a>
<a name="ln6127">            showNavigator(a-&gt;isChecked());</a>
<a name="ln6128">      else if (cmd == &quot;toggle-timeline&quot;)</a>
<a name="ln6129">            showTimeline(a-&gt;isChecked());</a>
<a name="ln6130">      else if (cmd == &quot;toggle-midiimportpanel&quot;)</a>
<a name="ln6131">            importmidiPanel-&gt;setVisible(a-&gt;isChecked());</a>
<a name="ln6132">      else if (cmd == &quot;toggle-mixer&quot;)</a>
<a name="ln6133">            showMixer(a-&gt;isChecked());</a>
<a name="ln6134">      else if (cmd == &quot;synth-control&quot;)</a>
<a name="ln6135">            showSynthControl(a-&gt;isChecked());</a>
<a name="ln6136">      else if (cmd == &quot;toggle-selection-window&quot;)</a>
<a name="ln6137">            showSelectionWindow(a-&gt;isChecked());</a>
<a name="ln6138">      else if (cmd == &quot;show-keys&quot;)</a>
<a name="ln6139">            ;</a>
<a name="ln6140">      else if (cmd == &quot;toggle-fileoperations&quot;)</a>
<a name="ln6141">            fileTools-&gt;setVisible(!fileTools-&gt;isVisible());</a>
<a name="ln6142">      else if (cmd == &quot;toggle-transport&quot;)</a>
<a name="ln6143">            transportTools-&gt;setVisible(!transportTools-&gt;isVisible());</a>
<a name="ln6144">      else if (cmd == &quot;toggle-concertpitch&quot;)</a>
<a name="ln6145">            cpitchTools-&gt;setVisible(!cpitchTools-&gt;isVisible());</a>
<a name="ln6146">      else if (cmd == &quot;toggle-imagecapture&quot;)</a>
<a name="ln6147">            fotoTools-&gt;setVisible(!fotoTools-&gt;isVisible());</a>
<a name="ln6148">      else if (cmd == &quot;toggle-noteinput&quot;)</a>
<a name="ln6149">            entryTools-&gt;setVisible(!entryTools-&gt;isVisible());</a>
<a name="ln6150">      else if (cmd == &quot;toggle-feedback&quot;)</a>
<a name="ln6151">            feedbackTools-&gt;setVisible(!feedbackTools-&gt;isVisible());</a>
<a name="ln6152">      else if (cmd == &quot;toggle-workspaces-toolbar&quot;)</a>
<a name="ln6153">            workspacesTools-&gt;setVisible(!workspacesTools-&gt;isVisible());</a>
<a name="ln6154">      else if (cmd == &quot;create-new-workspace&quot;) {</a>
<a name="ln6155">            mscore-&gt;createNewWorkspace();</a>
<a name="ln6156">            emit mscore-&gt;workspacesChanged();</a>
<a name="ln6157">            }</a>
<a name="ln6158">      else if (cmd == &quot;help&quot;)</a>
<a name="ln6159">            showContextHelp();</a>
<a name="ln6160">      else if (cmd == &quot;follow&quot;)</a>
<a name="ln6161">            preferences.setPreference(PREF_APP_PLAYBACK_FOLLOWSONG, a-&gt;isChecked());</a>
<a name="ln6162">      else if (cmd == &quot;split-h&quot;)</a>
<a name="ln6163">            splitWindow(true);</a>
<a name="ln6164">      else if (cmd == &quot;split-v&quot;)</a>
<a name="ln6165">            splitWindow(false);</a>
<a name="ln6166">      else if (cmd == &quot;edit-harmony&quot; &amp;&amp; enableExperimental)</a>
<a name="ln6167">            editChordStyle();</a>
<a name="ln6168">      else if (cmd == &quot;parts&quot;)</a>
<a name="ln6169">            startExcerptsDialog();</a>
<a name="ln6170">      else if (cmd == &quot;fullscreen&quot;) {</a>
<a name="ln6171">            _fullscreen = a-&gt;isChecked();</a>
<a name="ln6172">            if (_fullscreen)</a>
<a name="ln6173">                  showFullScreen();</a>
<a name="ln6174">            else</a>
<a name="ln6175">                  showNormal();</a>
<a name="ln6176"> </a>
<a name="ln6177">#ifdef Q_OS_MAC</a>
<a name="ln6178">            // Qt Bug: Toolbar goes into unified mode</a>
<a name="ln6179">            // after switching back from fullscreen</a>
<a name="ln6180">            setUnifiedTitleAndToolBarOnMac(false);</a>
<a name="ln6181">#endif</a>
<a name="ln6182">            }</a>
<a name="ln6183">      else if (cmd == &quot;config-raster&quot;)</a>
<a name="ln6184">            editRaster();</a>
<a name="ln6185">      else if (cmd == &quot;hraster&quot; || cmd == &quot;vraster&quot;)  // value in [hv]RasterAction already set</a>
<a name="ln6186">            ;</a>
<a name="ln6187">      else if (cmd == &quot;toggle-piano&quot;)</a>
<a name="ln6188">            showPianoKeyboard(a-&gt;isChecked());</a>
<a name="ln6189">      else if (cmd == &quot;toggle-scorecmp-tool&quot;)</a>
<a name="ln6190">            reDisplayDockWidget(scoreCmpTool, a-&gt;isChecked());</a>
<a name="ln6191">#ifdef MSCORE_UNSTABLE</a>
<a name="ln6192">      else if (cmd == &quot;toggle-script-recorder&quot;)</a>
<a name="ln6193">            scriptRecorder-&gt;setVisible(a-&gt;isChecked());</a>
<a name="ln6194">#endif</a>
<a name="ln6195">      else if (cmd == &quot;plugin-creator&quot;)</a>
<a name="ln6196">            showPluginCreator(a);</a>
<a name="ln6197">      else if (cmd == &quot;plugin-manager&quot;)</a>
<a name="ln6198">            showPluginManager();</a>
<a name="ln6199">      else if(cmd == &quot;resource-manager&quot;){</a>
<a name="ln6200">            ResourceManager r(0);</a>
<a name="ln6201">            r.exec();</a>
<a name="ln6202">            }</a>
<a name="ln6203">      else if (cmd == &quot;media&quot; &amp;&amp; enableExperimental)</a>
<a name="ln6204">            showMediaDialog();</a>
<a name="ln6205">      else if (cmd == &quot;page-settings&quot;)</a>
<a name="ln6206">            showPageSettings();</a>
<a name="ln6207">      else if (cmd == &quot;next-score&quot;)</a>
<a name="ln6208">            changeScore(1);</a>
<a name="ln6209">      else if (cmd == &quot;previous-score&quot;)</a>
<a name="ln6210">            changeScore(-1);</a>
<a name="ln6211">      else if (cmd == &quot;transpose&quot;)</a>
<a name="ln6212">            transpose();</a>
<a name="ln6213">      else if (cmd == &quot;save-style&quot;) {</a>
<a name="ln6214">            QString name = getStyleFilename(false);</a>
<a name="ln6215">            if (!name.isEmpty()) {</a>
<a name="ln6216">                  if (!cs-&gt;saveStyle(name)) {</a>
<a name="ln6217">                        QMessageBox::critical(this,</a>
<a name="ln6218">                           tr(&quot;Save Style&quot;), MScore::lastError);</a>
<a name="ln6219">                        }</a>
<a name="ln6220">                  }</a>
<a name="ln6221">            }</a>
<a name="ln6222">      else if (cmd == &quot;load-style&quot;) {</a>
<a name="ln6223">            QString name = mscore-&gt;getStyleFilename(true);</a>
<a name="ln6224">            if (!name.isEmpty()) {</a>
<a name="ln6225">                  cs-&gt;startCmd();</a>
<a name="ln6226">                  if (!cs-&gt;loadStyle(name)) {</a>
<a name="ln6227">                        QMessageBox::StandardButton b = QMessageBox::warning(this, tr(&quot;Load Style&quot;),</a>
<a name="ln6228">                           tr(&quot;MuseScore may not be able to load this style file: %1&quot;).arg(MScore::lastError),</a>
<a name="ln6229">                           QMessageBox::Cancel|QMessageBox::Ignore, QMessageBox::Cancel);</a>
<a name="ln6230">                        if (b == QMessageBox::Ignore)</a>
<a name="ln6231">                              cs-&gt;loadStyle(name, true);</a>
<a name="ln6232">                        }</a>
<a name="ln6233">                  cs-&gt;endCmd();</a>
<a name="ln6234">                  }</a>
<a name="ln6235">            }</a>
<a name="ln6236">      else if (cmd == &quot;edit-style&quot;) {</a>
<a name="ln6237">            if (!_styleDlg)</a>
<a name="ln6238">                  _styleDlg = new EditStyle { cs, this };</a>
<a name="ln6239">            else</a>
<a name="ln6240">                  _styleDlg-&gt;setScore(cs);</a>
<a name="ln6241">            _styleDlg-&gt;exec();</a>
<a name="ln6242">            }</a>
<a name="ln6243">      else if (cmd == &quot;edit-info&quot;) {</a>
<a name="ln6244">            MetaEditDialog med(cs, 0);</a>
<a name="ln6245">            med.exec();</a>
<a name="ln6246">            }</a>
<a name="ln6247">      else if (cmd == &quot;print&quot;)</a>
<a name="ln6248">            printFile();</a>
<a name="ln6249">      else if (cmd == &quot;repeat&quot;)</a>
<a name="ln6250">            setPlayRepeats(a-&gt;isChecked());</a>
<a name="ln6251">      else if (cmd == &quot;pan&quot;)</a>
<a name="ln6252">            MScore::panPlayback = !MScore::panPlayback;</a>
<a name="ln6253">      else if (cmd == &quot;show-invisible&quot;) {</a>
<a name="ln6254">            cs-&gt;setShowInvisible(a-&gt;isChecked());</a>
<a name="ln6255">            cs-&gt;update();</a>
<a name="ln6256">            }</a>
<a name="ln6257">      else if (cmd == &quot;show-unprintable&quot;) {</a>
<a name="ln6258">            cs-&gt;setShowUnprintable(a-&gt;isChecked());</a>
<a name="ln6259">            cs-&gt;update();</a>
<a name="ln6260">            }</a>
<a name="ln6261">      else if (cmd == &quot;show-frames&quot;) {</a>
<a name="ln6262">            cs-&gt;setShowFrames(a-&gt;isChecked());</a>
<a name="ln6263">            cs-&gt;update();</a>
<a name="ln6264">            }</a>
<a name="ln6265">      else if (cmd == &quot;show-pageborders&quot;) {</a>
<a name="ln6266">            cs-&gt;setShowPageborders(a-&gt;isChecked());</a>
<a name="ln6267">            cs-&gt;update();</a>
<a name="ln6268">            }</a>
<a name="ln6269">      else if (cmd == &quot;mark-irregular&quot;) {</a>
<a name="ln6270">            cs-&gt;setMarkIrregularMeasures(a-&gt;isChecked());</a>
<a name="ln6271">            cs-&gt;update();</a>
<a name="ln6272">            }</a>
<a name="ln6273">      else if (cmd == &quot;tempo&quot;)</a>
<a name="ln6274">            addTempo();</a>
<a name="ln6275">      else if (cmd == &quot;loop&quot;) {</a>
<a name="ln6276">            if (loop()) {</a>
<a name="ln6277">                  seq-&gt;setLoopSelection();</a>
<a name="ln6278">                  }</a>
<a name="ln6279">            }</a>
<a name="ln6280">      else if (cmd == &quot;loop-in&quot;) {</a>
<a name="ln6281">            seq-&gt;setLoopIn();</a>
<a name="ln6282">            loopAction-&gt;setChecked(true);</a>
<a name="ln6283">            }</a>
<a name="ln6284">      else if (cmd == &quot;loop-out&quot;) {</a>
<a name="ln6285">            seq-&gt;setLoopOut();</a>
<a name="ln6286">            loopAction-&gt;setChecked(true);</a>
<a name="ln6287">            }</a>
<a name="ln6288">      else if (cmd == &quot;metronome&quot;)  // no action</a>
<a name="ln6289">            ;</a>
<a name="ln6290">      else if (cmd == &quot;countin&quot;)    // no action</a>
<a name="ln6291">            ;</a>
<a name="ln6292">      else if (cmd == &quot;lock&quot;) {</a>
<a name="ln6293">            if (_sstate == STATE_LOCK)</a>
<a name="ln6294">                  changeState(STATE_NORMAL);</a>
<a name="ln6295">            else</a>
<a name="ln6296">                  changeState(STATE_LOCK);</a>
<a name="ln6297">            }</a>
<a name="ln6298">      else if (cmd == &quot;find&quot;)</a>
<a name="ln6299">            showSearchDialog();</a>
<a name="ln6300">      else if (cmd == &quot;text-b&quot;) {</a>
<a name="ln6301">            if (_textTools)</a>
<a name="ln6302">                  _textTools-&gt;toggleBold();</a>
<a name="ln6303">            }</a>
<a name="ln6304">      else if (cmd == &quot;text-i&quot;) {</a>
<a name="ln6305">            if (_textTools)</a>
<a name="ln6306">                  _textTools-&gt;toggleItalic();</a>
<a name="ln6307">            }</a>
<a name="ln6308">      else if (cmd == &quot;text-u&quot;) {</a>
<a name="ln6309">            if (_textTools)</a>
<a name="ln6310">                  _textTools-&gt;toggleUnderline();</a>
<a name="ln6311">            }</a>
<a name="ln6312">      else if (cmd == &quot;edit-toolbars&quot;)</a>
<a name="ln6313">            showToolbarEditor();</a>
<a name="ln6314">      else if (cmd == &quot;viewmode&quot;) {</a>
<a name="ln6315">            if (cs) {</a>
<a name="ln6316">                  if (cs-&gt;layoutMode() == LayoutMode::PAGE)</a>
<a name="ln6317">                        switchLayoutMode(LayoutMode::LINE);</a>
<a name="ln6318">                  else</a>
<a name="ln6319">                        switchLayoutMode(LayoutMode::PAGE);</a>
<a name="ln6320">                  }</a>
<a name="ln6321">            }</a>
<a name="ln6322">      else if (cmd == &quot;show-tours&quot;)</a>
<a name="ln6323">            preferences.setPreference(PREF_UI_APP_STARTUP_SHOWTOURS, a-&gt;isChecked());</a>
<a name="ln6324">      else if (cmd == &quot;reset-tours&quot;)</a>
<a name="ln6325">            tourHandler()-&gt;resetCompletedTours();</a>
<a name="ln6326">      else if (cmd == &quot;report-bug&quot;)</a>
<a name="ln6327">            reportBug(&quot;panel&quot;);</a>
<a name="ln6328">      else if (cmd == &quot;leave-feedback&quot;)</a>
<a name="ln6329">            leaveFeedback(&quot;panel&quot;);</a>
<a name="ln6330">#ifndef NDEBUG</a>
<a name="ln6331">      else if (cmd == &quot;no-horizontal-stretch&quot;) {</a>
<a name="ln6332">            MScore::noHorizontalStretch = a-&gt;isChecked();</a>
<a name="ln6333">            if (cs) {</a>
<a name="ln6334">                  cs-&gt;setLayoutAll();</a>
<a name="ln6335">                  cs-&gt;update();</a>
<a name="ln6336">                  }</a>
<a name="ln6337">            }</a>
<a name="ln6338">      else if (cmd == &quot;no-vertical-stretch&quot;) {</a>
<a name="ln6339">            MScore::noVerticalStretch = a-&gt;isChecked();</a>
<a name="ln6340">            if (cs) {</a>
<a name="ln6341">                  cs-&gt;setLayoutAll();</a>
<a name="ln6342">                  cs-&gt;update();</a>
<a name="ln6343">                  }</a>
<a name="ln6344">            }</a>
<a name="ln6345">      else if (cmd == &quot;show-segment-shapes&quot;) {</a>
<a name="ln6346">            MScore::showSegmentShapes = a-&gt;isChecked();</a>
<a name="ln6347">            if (cs) {</a>
<a name="ln6348">                  cs-&gt;setLayoutAll();</a>
<a name="ln6349">                  cs-&gt;update();</a>
<a name="ln6350">                  }</a>
<a name="ln6351">            }</a>
<a name="ln6352">      else if (cmd == &quot;show-skylines&quot;) {</a>
<a name="ln6353">            MScore::showSkylines = a-&gt;isChecked();</a>
<a name="ln6354">            if (cs) {</a>
<a name="ln6355">                  cs-&gt;setLayoutAll();</a>
<a name="ln6356">                  cs-&gt;update();</a>
<a name="ln6357">                  }</a>
<a name="ln6358">            }</a>
<a name="ln6359">      else if (cmd == &quot;show-bounding-rect&quot;) {</a>
<a name="ln6360">            MScore::showBoundingRect = a-&gt;isChecked();</a>
<a name="ln6361">            if (cs) {</a>
<a name="ln6362">                  cs-&gt;setLayoutAll();</a>
<a name="ln6363">                  cs-&gt;update();</a>
<a name="ln6364">                  }</a>
<a name="ln6365">            }</a>
<a name="ln6366">      else if (cmd == &quot;show-system-bounding-rect&quot;) {</a>
<a name="ln6367">            MScore::showSystemBoundingRect = a-&gt;isChecked();</a>
<a name="ln6368">            if (cs) {</a>
<a name="ln6369">                  cs-&gt;setLayoutAll();</a>
<a name="ln6370">                  cs-&gt;update();</a>
<a name="ln6371">                  }</a>
<a name="ln6372">            }</a>
<a name="ln6373">      else if (cmd == &quot;show-corrupted-measures&quot;) {</a>
<a name="ln6374">            MScore::showCorruptedMeasures = a-&gt;isChecked();</a>
<a name="ln6375">            if (cs) {</a>
<a name="ln6376">                  cs-&gt;setLayoutAll();</a>
<a name="ln6377">                  cs-&gt;update();</a>
<a name="ln6378">                  }</a>
<a name="ln6379">            }</a>
<a name="ln6380">      else if (cmd == &quot;qml-reload-source&quot;) {</a>
<a name="ln6381">            const QList&lt;QmlDockWidget*&gt; qmlWidgets = findChildren&lt;QmlDockWidget*&gt;();</a>
<a name="ln6382"> </a>
<a name="ln6383">            const QString oldPrefix = QmlDockWidget::qmlSourcePrefix();</a>
<a name="ln6384">            useSourceQmlFiles = true;</a>
<a name="ln6385">            const QString newPrefix = QmlDockWidget::qmlSourcePrefix();</a>
<a name="ln6386"> </a>
<a name="ln6387">            getQmlUiEngine()-&gt;clearComponentCache();</a>
<a name="ln6388"> </a>
<a name="ln6389">            for (QmlDockWidget* w : qmlWidgets) {</a>
<a name="ln6390">                  const QString urlString = w-&gt;source().toString().replace(oldPrefix, newPrefix);</a>
<a name="ln6391">                  w-&gt;setSource(QUrl(urlString));</a>
<a name="ln6392">                  }</a>
<a name="ln6393">            }</a>
<a name="ln6394">#endif</a>
<a name="ln6395">      else {</a>
<a name="ln6396">            if (cv) {</a>
<a name="ln6397">                  //isAncestorOf is called to see if a widget from inspector has focus</a>
<a name="ln6398">                  //if so, the focus doesn't get shifted to the score, unless escape is</a>
<a name="ln6399">                  //pressed, or the user clicks in the score</a>
<a name="ln6400">                  if (!inspector()-&gt;isAncestorOf(qApp-&gt;focusWidget()) || cmd == &quot;escape&quot;)</a>
<a name="ln6401">                        cv-&gt;setFocus();</a>
<a name="ln6402">                  cv-&gt;cmd(a);</a>
<a name="ln6403">                  }</a>
<a name="ln6404">            else</a>
<a name="ln6405">                  qDebug(&quot;2:unknown cmd &lt;%s&gt;&quot;, qPrintable(cmd));</a>
<a name="ln6406">            }</a>
<a name="ln6407">      if (debugger)</a>
<a name="ln6408">            debugger-&gt;reloadClicked();</a>
<a name="ln6409">      }</a>
<a name="ln6410"> </a>
<a name="ln6411">//---------------------------------------------------------</a>
<a name="ln6412">//   openExternalLink</a>
<a name="ln6413">//---------------------------------------------------------</a>
<a name="ln6414"> </a>
<a name="ln6415">void MuseScore::openExternalLink(const QString&amp; url)</a>
<a name="ln6416">      {</a>
<a name="ln6417">      QDesktopServices::openUrl(url);</a>
<a name="ln6418">      }</a>
<a name="ln6419"> </a>
<a name="ln6420">//---------------------------------------------------------</a>
<a name="ln6421">//   navigator</a>
<a name="ln6422">//---------------------------------------------------------</a>
<a name="ln6423"> </a>
<a name="ln6424">Navigator* MuseScore::navigator() const</a>
<a name="ln6425">      {</a>
<a name="ln6426">      return _navigator ? static_cast&lt;Navigator*&gt;(_navigator-&gt;widget()) : 0;</a>
<a name="ln6427">      }</a>
<a name="ln6428"> </a>
<a name="ln6429">//---------------------------------------------------------</a>
<a name="ln6430">//   timeline</a>
<a name="ln6431">//---------------------------------------------------------</a>
<a name="ln6432"> </a>
<a name="ln6433">Timeline* MuseScore::timeline() const</a>
<a name="ln6434">      {</a>
<a name="ln6435">      if (_timeline) {</a>
<a name="ln6436">            QSplitter* s = static_cast&lt;QSplitter *&gt;(_timeline-&gt;widget());</a>
<a name="ln6437">            if (s &amp;&amp; s-&gt;count() &gt; 0)</a>
<a name="ln6438">                  return _timeline ? static_cast&lt;Timeline*&gt;(s-&gt;widget(1)) : 0;</a>
<a name="ln6439">            return 0;</a>
<a name="ln6440">            }</a>
<a name="ln6441">      return 0;</a>
<a name="ln6442">      }</a>
<a name="ln6443"> </a>
<a name="ln6444">//---------------------------------------------------------</a>
<a name="ln6445">//   getScriptRecorder</a>
<a name="ln6446">//---------------------------------------------------------</a>
<a name="ln6447"> </a>
<a name="ln6448">ScriptRecorder* MuseScore::getScriptRecorder()</a>
<a name="ln6449">      {</a>
<a name="ln6450">#ifdef MSCORE_UNSTABLE</a>
<a name="ln6451">      if (scriptRecorder)</a>
<a name="ln6452">            return &amp;scriptRecorder-&gt;scriptRecorder();</a>
<a name="ln6453">#endif</a>
<a name="ln6454">      return nullptr;</a>
<a name="ln6455">      }</a>
<a name="ln6456"> </a>
<a name="ln6457">//---------------------------------------------------------</a>
<a name="ln6458">//   getSearchDialog</a>
<a name="ln6459">//---------------------------------------------------------</a>
<a name="ln6460"> </a>
<a name="ln6461">QWidget* MuseScore::searchDialog() const</a>
<a name="ln6462">      {</a>
<a name="ln6463">      return _searchDialog;</a>
<a name="ln6464">      }</a>
<a name="ln6465"> </a>
<a name="ln6466">//---------------------------------------------------------</a>
<a name="ln6467">//   updateLayer</a>
<a name="ln6468">//---------------------------------------------------------</a>
<a name="ln6469"> </a>
<a name="ln6470">void MuseScore::updateLayer()</a>
<a name="ln6471">      {</a>
<a name="ln6472">      layerSwitch-&gt;clear();</a>
<a name="ln6473">      bool enable;</a>
<a name="ln6474">      if (cs) {</a>
<a name="ln6475">            enable = cs-&gt;layer().size() &gt; 1;</a>
<a name="ln6476">            if (enable) {</a>
<a name="ln6477">                  foreach(const Layer&amp; l, cs-&gt;layer())</a>
<a name="ln6478">                        layerSwitch-&gt;addItem(l.name);</a>
<a name="ln6479">                  layerSwitch-&gt;setCurrentIndex(cs-&gt;currentLayer());</a>
<a name="ln6480">                  }</a>
<a name="ln6481">            }</a>
<a name="ln6482">      else</a>
<a name="ln6483">           enable = false;</a>
<a name="ln6484">      layerSwitch-&gt;setVisible(enable);</a>
<a name="ln6485">      }</a>
<a name="ln6486"> </a>
<a name="ln6487">//---------------------------------------------------------</a>
<a name="ln6488">//   updatePlayMode</a>
<a name="ln6489">//---------------------------------------------------------</a>
<a name="ln6490"> </a>
<a name="ln6491">void MuseScore::updatePlayMode()</a>
<a name="ln6492">      {</a>
<a name="ln6493">      bool enable = false;</a>
<a name="ln6494">      if (cs) {</a>
<a name="ln6495">            enable = cs-&gt;audio() != 0;</a>
<a name="ln6496">            playMode-&gt;setCurrentIndex(int(cs-&gt;playMode()));</a>
<a name="ln6497">            }</a>
<a name="ln6498">      playMode-&gt;setVisible(enable);</a>
<a name="ln6499">      }</a>
<a name="ln6500"> </a>
<a name="ln6501">//---------------------------------------------------------</a>
<a name="ln6502">//   closeScore</a>
<a name="ln6503">//---------------------------------------------------------</a>
<a name="ln6504"> </a>
<a name="ln6505">void MuseScore::closeScore(Score* score)</a>
<a name="ln6506">      {</a>
<a name="ln6507">      // Let's compute maximum count of ports in remaining scores</a>
<a name="ln6508">      if (seq)</a>
<a name="ln6509">            seq-&gt;recomputeMaxMidiOutPort();</a>
<a name="ln6510">      removeTab(scoreList.indexOf(score-&gt;masterScore()));</a>
<a name="ln6511">      }</a>
<a name="ln6512"> </a>
<a name="ln6513">//---------------------------------------------------------</a>
<a name="ln6514">//   noteTooShortForTupletDialog</a>
<a name="ln6515">//---------------------------------------------------------</a>
<a name="ln6516"> </a>
<a name="ln6517">void MuseScore::noteTooShortForTupletDialog()</a>
<a name="ln6518">      {</a>
<a name="ln6519">      QMessageBox::warning(this, tr(&quot;Warning&quot;),</a>
<a name="ln6520">        tr(&quot;Cannot create tuplet: Note value is too short&quot;)</a>
<a name="ln6521">        );</a>
<a name="ln6522">      }</a>
<a name="ln6523"> </a>
<a name="ln6524">//---------------------------------------------------------</a>
<a name="ln6525">//   instrumentChanged</a>
<a name="ln6526">//---------------------------------------------------------</a>
<a name="ln6527"> </a>
<a name="ln6528">void MuseScore::instrumentChanged()</a>
<a name="ln6529">      {</a>
<a name="ln6530">      if (mixer)</a>
<a name="ln6531">            mixer-&gt;setScore(cs);</a>
<a name="ln6532">      }</a>
<a name="ln6533"> </a>
<a name="ln6534">//---------------------------------------------------------</a>
<a name="ln6535">//   mixerPreferencesChanged</a>
<a name="ln6536">//---------------------------------------------------------</a>
<a name="ln6537"> </a>
<a name="ln6538">void MuseScore::mixerPreferencesChanged(bool showMidiControls)</a>
<a name="ln6539">      {</a>
<a name="ln6540">      if (mixer)</a>
<a name="ln6541">            mixer-&gt;midiPrefsChanged(showMidiControls);</a>
<a name="ln6542">      }</a>
<a name="ln6543"> </a>
<a name="ln6544">//---------------------------------------------------------</a>
<a name="ln6545">//   checkForUpdates</a>
<a name="ln6546">//---------------------------------------------------------</a>
<a name="ln6547"> </a>
<a name="ln6548">void MuseScore::checkForUpdates()</a>
<a name="ln6549">      {</a>
<a name="ln6550">#ifndef MSCORE_NO_UPDATE_CHECKER</a>
<a name="ln6551">      if (hasToCheckForUpdate())</a>
<a name="ln6552">            checkForUpdatesNoUI();</a>
<a name="ln6553">#endif</a>
<a name="ln6554">      }</a>
<a name="ln6555"> </a>
<a name="ln6556">//---------------------------------------------------------</a>
<a name="ln6557">//   changeScore</a>
<a name="ln6558">//    switch current score</a>
<a name="ln6559">//    step = 1    switch to next score</a>
<a name="ln6560">//    step = -1   switch to previous score</a>
<a name="ln6561">//---------------------------------------------------------</a>
<a name="ln6562"> </a>
<a name="ln6563">void MuseScore::changeScore(int step)</a>
<a name="ln6564">      {</a>
<a name="ln6565">      int index = tab1-&gt;currentIndex();</a>
<a name="ln6566">      int n     = tab1-&gt;count();</a>
<a name="ln6567">      if (n == 1)</a>
<a name="ln6568">            return;</a>
<a name="ln6569">      index += step;</a>
<a name="ln6570">      if (index &gt;= n)</a>
<a name="ln6571">            index = 0;</a>
<a name="ln6572">      if (index &lt; 0)</a>
<a name="ln6573">            index = n - 1;</a>
<a name="ln6574">      setCurrentScoreView(index);</a>
<a name="ln6575">      }</a>
<a name="ln6576"> </a>
<a name="ln6577">//---------------------------------------------------------</a>
<a name="ln6578">//   switchLayoutMode</a>
<a name="ln6579">//    val is index in QComboBox viewModeCombo</a>
<a name="ln6580">//---------------------------------------------------------</a>
<a name="ln6581"> </a>
<a name="ln6582">void MuseScore::switchLayoutMode(int val)</a>
<a name="ln6583">      {</a>
<a name="ln6584">      if (!cs)</a>
<a name="ln6585">            return;</a>
<a name="ln6586">      switchLayoutMode(static_cast&lt;LayoutMode&gt;(viewModeCombo-&gt;itemData(val).toInt()));</a>
<a name="ln6587">      }</a>
<a name="ln6588"> </a>
<a name="ln6589">void MuseScore::switchLayoutMode(LayoutMode mode)</a>
<a name="ln6590">      {</a>
<a name="ln6591">      // find a measure to use as reference, if possible</a>
<a name="ln6592">      QRectF view = cv-&gt;toLogical(QRect(0.0, 0.0, width(), height()));</a>
<a name="ln6593">      Measure* m = cs-&gt;firstMeasureMM();</a>
<a name="ln6594">      while (m &amp;&amp; !view.intersects(m-&gt;canvasBoundingRect()))</a>
<a name="ln6595">            m = m-&gt;nextMeasureMM();</a>
<a name="ln6596"> </a>
<a name="ln6597">      cv-&gt;loopUpdate(getAction(&quot;loop&quot;)-&gt;isChecked());</a>
<a name="ln6598"> </a>
<a name="ln6599">      if (mode != cs-&gt;layoutMode()) {</a>
<a name="ln6600">            cs-&gt;setLayoutMode(mode);</a>
<a name="ln6601">            cs-&gt;doLayout();</a>
<a name="ln6602">            }</a>
<a name="ln6603"> </a>
<a name="ln6604">      // adjustCanvasPosition often tries to preserve Y position</a>
<a name="ln6605">      // but this doesn't make sense when switching modes</a>
<a name="ln6606">      // also, better positioning is usually achieved if you start from the top</a>
<a name="ln6607">      // and there is really no better place to position canvas if we were all the way off page previously</a>
<a name="ln6608">      cv-&gt;pageTop();</a>
<a name="ln6609">      if (m &amp;&amp; m != cs-&gt;firstMeasureMM())</a>
<a name="ln6610">            cv-&gt;adjustCanvasPosition(m, false);</a>
<a name="ln6611">      if (cv-&gt;noteEntryMode())</a>
<a name="ln6612">            cv-&gt;moveCursor();</a>
<a name="ln6613">      }</a>
<a name="ln6614"> </a>
<a name="ln6615">//---------------------------------------------------------</a>
<a name="ln6616">//   showDrumTools</a>
<a name="ln6617">//---------------------------------------------------------</a>
<a name="ln6618"> </a>
<a name="ln6619">void MuseScore::showDrumTools(const Drumset* drumset, Staff* staff)</a>
<a name="ln6620">      {</a>
<a name="ln6621">      if (drumset) {</a>
<a name="ln6622">            if (!_drumTools) {</a>
<a name="ln6623">                  _drumTools = new DrumTools(this);</a>
<a name="ln6624">                  addDockWidget(Qt::BottomDockWidgetArea, _drumTools);</a>
<a name="ln6625">                  }</a>
<a name="ln6626">            if (timelineScrollArea())</a>
<a name="ln6627">                  splitDockWidget(_drumTools, timelineScrollArea(), Qt::Vertical);</a>
<a name="ln6628">            _drumTools-&gt;setDrumset(cs, staff, drumset);</a>
<a name="ln6629">            _drumTools-&gt;show();</a>
<a name="ln6630">            }</a>
<a name="ln6631">      else {</a>
<a name="ln6632">            if (_drumTools)</a>
<a name="ln6633">                  _drumTools-&gt;hide();</a>
<a name="ln6634">            }</a>
<a name="ln6635">      }</a>
<a name="ln6636"> </a>
<a name="ln6637">//---------------------------------------------------------</a>
<a name="ln6638">//   updateDrumTools</a>
<a name="ln6639">//---------------------------------------------------------</a>
<a name="ln6640"> </a>
<a name="ln6641">void MuseScore::updateDrumTools(const Drumset* ds)</a>
<a name="ln6642">      {</a>
<a name="ln6643">      if (_drumTools)</a>
<a name="ln6644">            _drumTools-&gt;updateDrumset(ds);</a>
<a name="ln6645">      }</a>
<a name="ln6646"> </a>
<a name="ln6647">//---------------------------------------------------------</a>
<a name="ln6648">//   endSearch</a>
<a name="ln6649">//---------------------------------------------------------</a>
<a name="ln6650"> </a>
<a name="ln6651">void MuseScore::endSearch()</a>
<a name="ln6652">      {</a>
<a name="ln6653">      _searchDialog-&gt;hide();</a>
<a name="ln6654">      if (cv)</a>
<a name="ln6655">            cv-&gt;setFocus();</a>
<a name="ln6656">      }</a>
<a name="ln6657"> </a>
<a name="ln6658">//---------------------------------------------------------</a>
<a name="ln6659">//   showSearchDialog</a>
<a name="ln6660">//---------------------------------------------------------</a>
<a name="ln6661"> </a>
<a name="ln6662">void MuseScore::showSearchDialog()</a>
<a name="ln6663">      {</a>
<a name="ln6664">      if (_searchDialog == 0) {</a>
<a name="ln6665">            _searchDialog = new QWidget;</a>
<a name="ln6666">            _searchDialog-&gt;setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Maximum);</a>
<a name="ln6667">            QHBoxLayout* searchDialogLayout = new QHBoxLayout;</a>
<a name="ln6668">            _searchDialog-&gt;setLayout(searchDialogLayout);</a>
<a name="ln6669">            layout-&gt;insertWidget(2, _searchDialog);</a>
<a name="ln6670"> </a>
<a name="ln6671">            QToolButton* searchExit = new QToolButton;</a>
<a name="ln6672">            searchExit-&gt;setAutoRaise(true);</a>
<a name="ln6673">            searchExit-&gt;setIcon(*icons[int(Icons::close_ICON)]);</a>
<a name="ln6674">            connect(searchExit, SIGNAL(clicked()), SLOT(endSearch()));</a>
<a name="ln6675">            searchDialogLayout-&gt;addWidget(searchExit);</a>
<a name="ln6676">            searchDialogLayout-&gt;addSpacing(10);</a>
<a name="ln6677"> </a>
<a name="ln6678">            searchDialogLayout-&gt;addWidget(new QLabel(tr(&quot;Go To: &quot;)));</a>
<a name="ln6679"> </a>
<a name="ln6680">            searchCombo = new SearchComboBox;</a>
<a name="ln6681">            searchDialogLayout-&gt;addWidget(searchCombo);</a>
<a name="ln6682"> </a>
<a name="ln6683">            searchDialogLayout-&gt;addStretch(10);</a>
<a name="ln6684">            _searchDialog-&gt;hide();</a>
<a name="ln6685"> </a>
<a name="ln6686">            qDebug(&quot;Line edit %p&quot;, searchCombo-&gt;lineEdit());</a>
<a name="ln6687"> </a>
<a name="ln6688">            connect(searchCombo-&gt;lineEdit(), SIGNAL(returnPressed()), SLOT(endSearch()));</a>
<a name="ln6689">            }</a>
<a name="ln6690"> </a>
<a name="ln6691">      searchCombo-&gt;clearEditText();</a>
<a name="ln6692">      searchCombo-&gt;setFocus();</a>
<a name="ln6693">      _searchDialog-&gt;show();</a>
<a name="ln6694">      }</a>
<a name="ln6695"> </a>
<a name="ln6696"> </a>
<a name="ln6697"> </a>
<a name="ln6698">#ifndef SCRIPT_INTERFACE</a>
<a name="ln6699">void MuseScore::pluginTriggered(int) {}</a>
<a name="ln6700">void MuseScore::pluginTriggered(QString path) {}</a>
<a name="ln6701">void MuseScore::loadPlugins() {}</a>
<a name="ln6702">bool MuseScore::loadPlugin(const QString&amp;) { return false;}</a>
<a name="ln6703">void MuseScore::unloadPlugins() {}</a>
<a name="ln6704">#endif</a>
<a name="ln6705"> </a>
<a name="ln6706"> </a>
<a name="ln6707">void MuseScore::saveGeometry(QWidget const*const qw)</a>
<a name="ln6708">      {</a>
<a name="ln6709">      QSettings settings;</a>
<a name="ln6710">      QString objectName = qw-&gt;objectName();</a>
<a name="ln6711">      Q_ASSERT(!objectName.isEmpty());</a>
<a name="ln6712">      settings.beginGroup(&quot;Geometries&quot;);</a>
<a name="ln6713">      settings.setValue(objectName, qw-&gt;saveGeometry());</a>
<a name="ln6714">      settings.endGroup();</a>
<a name="ln6715">      }</a>
<a name="ln6716"> </a>
<a name="ln6717">void MuseScore::restoreGeometry(QWidget *const qw)</a>
<a name="ln6718">      {</a>
<a name="ln6719">      if (!useFactorySettings) {</a>
<a name="ln6720">            QSettings settings;</a>
<a name="ln6721">            QString objectName = qw-&gt;objectName();</a>
<a name="ln6722">            Q_ASSERT(!objectName.isEmpty());</a>
<a name="ln6723">            settings.beginGroup(&quot;Geometries&quot;);</a>
<a name="ln6724">            qw-&gt;restoreGeometry(settings.value(objectName).toByteArray());</a>
<a name="ln6725">            settings.endGroup();</a>
<a name="ln6726">            }</a>
<a name="ln6727">      }</a>
<a name="ln6728"> </a>
<a name="ln6729">void MuseScore::updateWindowTitle(Score* score)</a>
<a name="ln6730">      {</a>
<a name="ln6731">#ifdef Q_OS_MAC</a>
<a name="ln6732">      if (!cs-&gt;isMaster())</a>
<a name="ln6733">            setWindowTitle(cs-&gt;masterScore()-&gt;title() + &quot;-&quot; + cs-&gt;title());</a>
<a name="ln6734">      else</a>
<a name="ln6735">            setWindowTitle(cs-&gt;title());</a>
<a name="ln6736">      if (score-&gt;masterScore()-&gt;created())</a>
<a name="ln6737">            setWindowFilePath(QString());</a>
<a name="ln6738">      else</a>
<a name="ln6739">            setWindowFilePath(score-&gt;masterScore()-&gt;fileInfo()-&gt;absoluteFilePath());</a>
<a name="ln6740">#else</a>
<a name="ln6741">      if (!cs-&gt;isMaster())</a>
<a name="ln6742">            setWindowTitle(MUSESCORE_NAME_VERSION &quot;: &quot; + cs-&gt;masterScore()-&gt;title() + &quot;-&quot; + cs-&gt;title() + &quot;[*]&quot;);</a>
<a name="ln6743">      else</a>
<a name="ln6744">            setWindowTitle(MUSESCORE_NAME_VERSION &quot;: &quot; + score-&gt;title() + &quot;[*]&quot;);</a>
<a name="ln6745">#endif</a>
<a name="ln6746">      }</a>
<a name="ln6747"> </a>
<a name="ln6748">//---------------------------------------------------------</a>
<a name="ln6749">//   recentScores</a>
<a name="ln6750">//    return a list of recent scores</a>
<a name="ln6751">//    omit loaded scores</a>
<a name="ln6752">//---------------------------------------------------------</a>
<a name="ln6753"> </a>
<a name="ln6754">QFileInfoList MuseScore::recentScores() const</a>
<a name="ln6755">      {</a>
<a name="ln6756">      QFileInfoList fil;</a>
<a name="ln6757">      for (const QString&amp; s : _recentScores) {</a>
<a name="ln6758">            if (s.isEmpty())</a>
<a name="ln6759">                  continue;</a>
<a name="ln6760">            QFileInfo fi(s);</a>
<a name="ln6761">            bool alreadyLoaded = false;</a>
<a name="ln6762">            QString fp = fi.canonicalFilePath();</a>
<a name="ln6763">            for (Score* sc : mscore-&gt;scores()) {</a>
<a name="ln6764">                  if ((sc-&gt;masterScore()-&gt;fileInfo()-&gt;canonicalFilePath() == fp) || (sc-&gt;importedFilePath() == fp)) {</a>
<a name="ln6765">                        alreadyLoaded = true;</a>
<a name="ln6766">                        break;</a>
<a name="ln6767">                        }</a>
<a name="ln6768">                  }</a>
<a name="ln6769">            if (!alreadyLoaded &amp;&amp; fi.exists())</a>
<a name="ln6770">                  fil.append(fi);</a>
<a name="ln6771">            }</a>
<a name="ln6772">      return fil;</a>
<a name="ln6773">      }</a>
<a name="ln6774"> </a>
<a name="ln6775">//---------------------------------------------------------</a>
<a name="ln6776">//   createPopupMenu</a>
<a name="ln6777">//---------------------------------------------------------</a>
<a name="ln6778"> </a>
<a name="ln6779">QMenu* MuseScore::createPopupMenu()</a>
<a name="ln6780">      {</a>
<a name="ln6781">      QMenu* m = QMainWindow::createPopupMenu();</a>
<a name="ln6782">      QList&lt;QAction*&gt; al = m-&gt;actions();</a>
<a name="ln6783">      for (QAction* a : al) {</a>
<a name="ln6784">            // textTool visibility is handled differentlyr</a>
<a name="ln6785">            if (_textTools &amp;&amp; a-&gt;text() == _textTools-&gt;windowTitle())</a>
<a name="ln6786">                  m-&gt;removeAction(a);</a>
<a name="ln6787">            }</a>
<a name="ln6788">      return m;</a>
<a name="ln6789">      }</a>
<a name="ln6790"> </a>
<a name="ln6791">//---------------------------------------------------------</a>
<a name="ln6792">//   synthesizerState</a>
<a name="ln6793">//---------------------------------------------------------</a>
<a name="ln6794"> </a>
<a name="ln6795">SynthesizerState MuseScore::synthesizerState() const</a>
<a name="ln6796">      {</a>
<a name="ln6797">      SynthesizerState state;</a>
<a name="ln6798">      return synti ? synti-&gt;state() : state;</a>
<a name="ln6799">      }</a>
<a name="ln6800"> </a>
<a name="ln6801">//---------------------------------------------------------</a>
<a name="ln6802">//   synthesizer</a>
<a name="ln6803">//---------------------------------------------------------</a>
<a name="ln6804"> </a>
<a name="ln6805">Synthesizer* MuseScore::synthesizer(const QString&amp; name)</a>
<a name="ln6806">      {</a>
<a name="ln6807">      return synti ? synti-&gt;synthesizer(name) : nullptr;</a>
<a name="ln6808">      }</a>
<a name="ln6809"> </a>
<a name="ln6810">//---------------------------------------------------------</a>
<a name="ln6811">//   canSaveMp3</a>
<a name="ln6812">//---------------------------------------------------------</a>
<a name="ln6813"> </a>
<a name="ln6814">bool MuseScore::canSaveMp3()</a>
<a name="ln6815">      {</a>
<a name="ln6816">#ifndef USE_LAME</a>
<a name="ln6817">      return false;</a>
<a name="ln6818">#else</a>
<a name="ln6819">      MP3Exporter exporter;</a>
<a name="ln6820">      if (!exporter.loadLibrary(MP3Exporter::AskUser::NO)) {</a>
<a name="ln6821">            qDebug(&quot;Could not open MP3 encoding library!&quot;);</a>
<a name="ln6822">            return false;</a>
<a name="ln6823">            }</a>
<a name="ln6824"> </a>
<a name="ln6825">      if (!exporter.validLibraryLoaded()) {</a>
<a name="ln6826">            qDebug(&quot;Not a valid or supported MP3 encoding library!&quot;);</a>
<a name="ln6827">            return false;</a>
<a name="ln6828">            }</a>
<a name="ln6829">      return true;</a>
<a name="ln6830">#endif</a>
<a name="ln6831">      }</a>
<a name="ln6832"> </a>
<a name="ln6833">//---------------------------------------------------------</a>
<a name="ln6834">//   saveMp3</a>
<a name="ln6835">//---------------------------------------------------------</a>
<a name="ln6836"> </a>
<a name="ln6837">bool MuseScore::saveMp3(Score* score, const QString&amp; name)</a>
<a name="ln6838">      {</a>
<a name="ln6839">      QFile file(name);</a>
<a name="ln6840">      if (!file.open(QIODevice::WriteOnly)) {</a>
<a name="ln6841">            if (!MScore::noGui) {</a>
<a name="ln6842">                  QMessageBox::warning(0,</a>
<a name="ln6843">                                       tr(&quot;Encoding Error&quot;),</a>
<a name="ln6844">                                       tr(&quot;Unable to open target file for writing&quot;),</a>
<a name="ln6845">                                       QString(), QString());</a>
<a name="ln6846">                  }</a>
<a name="ln6847">            return false;</a>
<a name="ln6848">            }</a>
<a name="ln6849">      bool wasCanceled = false;</a>
<a name="ln6850">      bool res = saveMp3(score, &amp;file, wasCanceled);</a>
<a name="ln6851">      file.close();</a>
<a name="ln6852">      if (wasCanceled || !res)</a>
<a name="ln6853">            file.remove();</a>
<a name="ln6854">      return res;</a>
<a name="ln6855">      }</a>
<a name="ln6856"> </a>
<a name="ln6857">bool MuseScore::saveMp3(Score* score, QIODevice* device, bool&amp; wasCanceled)</a>
<a name="ln6858">      {</a>
<a name="ln6859">#ifndef USE_LAME</a>
<a name="ln6860">      Q_UNUSED(score);</a>
<a name="ln6861">      Q_UNUSED(device);</a>
<a name="ln6862">      Q_UNUSED(wasCanceled);</a>
<a name="ln6863">      return false;</a>
<a name="ln6864">#else</a>
<a name="ln6865">      EventMap events;</a>
<a name="ln6866">      // In non-GUI mode current synthesizer settings won't</a>
<a name="ln6867">      // allow single note dynamics. See issue #289947.</a>
<a name="ln6868">      const bool useCurrentSynthesizerState = !MScore::noGui;</a>
<a name="ln6869"> </a>
<a name="ln6870">      if (useCurrentSynthesizerState) {</a>
<a name="ln6871">            score-&gt;renderMidi(&amp;events, synthesizerState());</a>
<a name="ln6872">            if (events.empty())</a>
<a name="ln6873">                  return false;</a>
<a name="ln6874">            }</a>
<a name="ln6875"> </a>
<a name="ln6876">      MP3Exporter exporter;</a>
<a name="ln6877">      if (!exporter.loadLibrary(MP3Exporter::AskUser::MAYBE)) {</a>
<a name="ln6878">            QSettings set;</a>
<a name="ln6879">            set.setValue(&quot;/Export/lameMP3LibPath&quot;, &quot;&quot;);</a>
<a name="ln6880">            if(!MScore::noGui)</a>
<a name="ln6881">                  QMessageBox::warning(0,</a>
<a name="ln6882">                               tr(&quot;Error Opening LAME library&quot;),</a>
<a name="ln6883">                               tr(&quot;Could not open MP3 encoding library!&quot;),</a>
<a name="ln6884">                               QString(), QString());</a>
<a name="ln6885">            qDebug(&quot;Could not open MP3 encoding library!&quot;);</a>
<a name="ln6886">            return false;</a>
<a name="ln6887">            }</a>
<a name="ln6888"> </a>
<a name="ln6889">      if (!exporter.validLibraryLoaded()) {</a>
<a name="ln6890">            QSettings set;</a>
<a name="ln6891">            set.setValue(&quot;/Export/lameMP3LibPath&quot;, &quot;&quot;);</a>
<a name="ln6892">            if(!MScore::noGui)</a>
<a name="ln6893">                  QMessageBox::warning(0,</a>
<a name="ln6894">                               tr(&quot;Error Opening LAME library&quot;),</a>
<a name="ln6895">                               tr(&quot;Not a valid or supported MP3 encoding library!&quot;),</a>
<a name="ln6896">                               QString(), QString());</a>
<a name="ln6897">            qDebug(&quot;Not a valid or supported MP3 encoding library!&quot;);</a>
<a name="ln6898">            return false;</a>
<a name="ln6899">            }</a>
<a name="ln6900"> </a>
<a name="ln6901">      // Retrieve preferences</a>
<a name="ln6902">//      int highrate = 48000;</a>
<a name="ln6903">//      int lowrate = 8000;</a>
<a name="ln6904">//      int bitrate = 64;</a>
<a name="ln6905">//      int brate = 128;</a>
<a name="ln6906">//      int rmode = MODE_CBR;</a>
<a name="ln6907">//      int vmode = ROUTINE_FAST;</a>
<a name="ln6908">//      int cmode = CHANNEL_STEREO;</a>
<a name="ln6909"> </a>
<a name="ln6910">      int channels = 2;</a>
<a name="ln6911"> </a>
<a name="ln6912">      int oldSampleRate = MScore::sampleRate;</a>
<a name="ln6913">      int sampleRate = preferences.getInt(PREF_EXPORT_AUDIO_SAMPLERATE);</a>
<a name="ln6914">      exporter.setBitrate(preferences.getInt(PREF_EXPORT_MP3_BITRATE));</a>
<a name="ln6915"> </a>
<a name="ln6916">      int inSamples = exporter.initializeStream(channels, sampleRate);</a>
<a name="ln6917">      if (inSamples &lt; 0) {</a>
<a name="ln6918">            if (!MScore::noGui) {</a>
<a name="ln6919">                  QMessageBox::warning(0, tr(&quot;Encoding Error&quot;),</a>
<a name="ln6920">                     tr(&quot;Unable to initialize MP3 stream&quot;),</a>
<a name="ln6921">                     QString(), QString());</a>
<a name="ln6922">                  }</a>
<a name="ln6923">            qDebug(&quot;Unable to initialize MP3 stream&quot;);</a>
<a name="ln6924">            MScore::sampleRate = oldSampleRate;</a>
<a name="ln6925">            return false;</a>
<a name="ln6926">            }</a>
<a name="ln6927"> </a>
<a name="ln6928">      int bufferSize   = exporter.getOutBufferSize();</a>
<a name="ln6929">      uchar* bufferOut = new uchar[bufferSize];</a>
<a name="ln6930">      MasterSynthesizer* synth = synthesizerFactory();</a>
<a name="ln6931">      synth-&gt;init();</a>
<a name="ln6932">      synth-&gt;setSampleRate(sampleRate);</a>
<a name="ln6933">      if (MScore::noGui) { // use score settings if possible</a>
<a name="ln6934">            bool r = synth-&gt;setState(score-&gt;synthesizerState());</a>
<a name="ln6935">            if (!r)</a>
<a name="ln6936">                  synth-&gt;init();</a>
<a name="ln6937">            }</a>
<a name="ln6938">      else { // use current synth settings</a>
<a name="ln6939">            bool r = synth-&gt;setState(mscore-&gt;synthesizerState());</a>
<a name="ln6940">            if (!r)</a>
<a name="ln6941">                  synth-&gt;init();</a>
<a name="ln6942">            }</a>
<a name="ln6943"> </a>
<a name="ln6944">      MScore::sampleRate = sampleRate;</a>
<a name="ln6945"> </a>
<a name="ln6946">      if (!useCurrentSynthesizerState) {</a>
<a name="ln6947">            score-&gt;masterScore()-&gt;rebuildAndUpdateExpressive(synth-&gt;synthesizer(&quot;Fluid&quot;));</a>
<a name="ln6948">            score-&gt;renderMidi(&amp;events, score-&gt;synthesizerState());</a>
<a name="ln6949">            if (synti)</a>
<a name="ln6950">                  score-&gt;masterScore()-&gt;rebuildAndUpdateExpressive(synti-&gt;synthesizer(&quot;Fluid&quot;));</a>
<a name="ln6951"> </a>
<a name="ln6952">            if (events.empty())</a>
<a name="ln6953">                  return false;</a>
<a name="ln6954">            }</a>
<a name="ln6955"> </a>
<a name="ln6956">      QProgressDialog progress(this);</a>
<a name="ln6957">      progress.setWindowFlags(Qt::WindowFlags(Qt::Dialog | Qt::FramelessWindowHint | Qt::WindowTitleHint));</a>
<a name="ln6958">      progress.setWindowModality(Qt::ApplicationModal);</a>
<a name="ln6959">      //progress.setCancelButton(0);</a>
<a name="ln6960">      progress.setCancelButtonText(tr(&quot;Cancel&quot;));</a>
<a name="ln6961">      progress.setLabelText(tr(&quot;Exporting…&quot;));</a>
<a name="ln6962">      if (!MScore::noGui)</a>
<a name="ln6963">            progress.show();</a>
<a name="ln6964"> </a>
<a name="ln6965">      static const int FRAMES = 512;</a>
<a name="ln6966">      float bufferL[FRAMES];</a>
<a name="ln6967">      float bufferR[FRAMES];</a>
<a name="ln6968"> </a>
<a name="ln6969">      float  peak = 0.0;</a>
<a name="ln6970">      double gain = 1.0;</a>
<a name="ln6971">      EventMap::const_iterator endPos = events.cend();</a>
<a name="ln6972">      --endPos;</a>
<a name="ln6973">      const int et = (score-&gt;utick2utime(endPos-&gt;first) + 1) * MScore::sampleRate;</a>
<a name="ln6974">      const int maxEndTime = (score-&gt;utick2utime(endPos-&gt;first) + 3) * MScore::sampleRate;</a>
<a name="ln6975">      progress.setRange(0, et);</a>
<a name="ln6976"> </a>
<a name="ln6977">      for (int pass = 0; pass &lt; 2; ++pass) {</a>
<a name="ln6978">            EventMap::const_iterator playPos;</a>
<a name="ln6979">            playPos = events.cbegin();</a>
<a name="ln6980">            synth-&gt;allSoundsOff(-1);</a>
<a name="ln6981"> </a>
<a name="ln6982">            //</a>
<a name="ln6983">            // init instruments</a>
<a name="ln6984">            //</a>
<a name="ln6985">            for (Part* part : score-&gt;parts()) {</a>
<a name="ln6986">                  const InstrumentList* il = part-&gt;instruments();</a>
<a name="ln6987">                  for (auto i = il-&gt;begin(); i!= il-&gt;end(); i++) {</a>
<a name="ln6988">                        for (const Channel* channel : i-&gt;second-&gt;channel()) {</a>
<a name="ln6989">                              const Channel* a = score-&gt;masterScore()-&gt;playbackChannel(channel);</a>
<a name="ln6990">                              for (MidiCoreEvent e : a-&gt;initList()) {</a>
<a name="ln6991">                                    if (e.type() == ME_INVALID)</a>
<a name="ln6992">                                          continue;</a>
<a name="ln6993">                                    e.setChannel(a-&gt;channel());</a>
<a name="ln6994">                                    int syntiIdx= synth-&gt;index(score-&gt;masterScore()-&gt;midiMapping(a-&gt;channel())-&gt;articulation()-&gt;synti());</a>
<a name="ln6995">									synth-&gt;play(e, syntiIdx);</a>
<a name="ln6996">                                    }</a>
<a name="ln6997">                              }</a>
<a name="ln6998">                        }</a>
<a name="ln6999">                  }</a>
<a name="ln7000"> </a>
<a name="ln7001">            int playTime = 0.0;</a>
<a name="ln7002"> </a>
<a name="ln7003">            for (;;) {</a>
<a name="ln7004">                  unsigned frames = FRAMES;</a>
<a name="ln7005">                  float max = 0;</a>
<a name="ln7006">                  //</a>
<a name="ln7007">                  // collect events for one segment</a>
<a name="ln7008">                  //</a>
<a name="ln7009">                  memset(bufferL, 0, sizeof(float) * FRAMES);</a>
<a name="ln7010">                  memset(bufferR, 0, sizeof(float) * FRAMES);</a>
<a name="ln7011">                  double endTime = playTime + frames;</a>
<a name="ln7012"> </a>
<a name="ln7013">                  float* l = bufferL;</a>
<a name="ln7014">                  float* r = bufferR;</a>
<a name="ln7015"> </a>
<a name="ln7016">                  for (; playPos != events.cend(); ++playPos) {</a>
<a name="ln7017">                        double f = score-&gt;utick2utime(playPos-&gt;first) * MScore::sampleRate;</a>
<a name="ln7018">                        if (f &gt;= endTime)</a>
<a name="ln7019">                              break;</a>
<a name="ln7020">                        int n = f - playTime;</a>
<a name="ln7021">                        if (n) {</a>
<a name="ln7022">#if (!defined (_MSCVER) &amp;&amp; !defined (_MSC_VER))</a>
<a name="ln7023">                              float bu[n * 2];</a>
<a name="ln7024">                              memset(bu, 0, sizeof(float) * 2 * n);</a>
<a name="ln7025">#else</a>
<a name="ln7026">                              // MSVC does not support VLA. Replace with std::vector. If profiling determines that the</a>
<a name="ln7027">                              //    heap allocation is slow, an optimization might be used.</a>
<a name="ln7028">                              std::vector&lt;float&gt; vBu(n * 2, 0);   // Default initialized, memset() not required.</a>
<a name="ln7029">                              float* bu = vBu.data();</a>
<a name="ln7030">#endif</a>
<a name="ln7031"> </a>
<a name="ln7032">                              synth-&gt;process(n, bu);</a>
<a name="ln7033">                              float* sp = bu;</a>
<a name="ln7034">                              for (int i = 0; i &lt; n; ++i) {</a>
<a name="ln7035">                                    *l++ = *sp++;</a>
<a name="ln7036">                                    *r++ = *sp++;</a>
<a name="ln7037">                                    }</a>
<a name="ln7038">                              playTime  += n;</a>
<a name="ln7039">                              frames    -= n;</a>
<a name="ln7040">                              }</a>
<a name="ln7041">                        const NPlayEvent&amp; e = playPos-&gt;second;</a>
<a name="ln7042">                        if (e.isChannelEvent()) {</a>
<a name="ln7043">                              int channelIdx = e.channel();</a>
<a name="ln7044">                              Channel* c = score-&gt;masterScore()-&gt;midiMapping(channelIdx)-&gt;articulation();</a>
<a name="ln7045">                              if (!c-&gt;mute()) {</a>
<a name="ln7046">                                    synth-&gt;play(e, synth-&gt;index(c-&gt;synti()));</a>
<a name="ln7047">                                    }</a>
<a name="ln7048">                              }</a>
<a name="ln7049">                        }</a>
<a name="ln7050">                  if (frames) {</a>
<a name="ln7051">#if (!defined (_MSCVER) &amp;&amp; !defined (_MSC_VER))</a>
<a name="ln7052">                        float bu[frames * 2];</a>
<a name="ln7053">                        memset(bu, 0, sizeof(float) * 2 * frames);</a>
<a name="ln7054">#else</a>
<a name="ln7055">                        // MSVC does not support VLA. Replace with std::vector. If profiling determines that the</a>
<a name="ln7056">                        //    heap allocation is slow, an optimization might be used.</a>
<a name="ln7057">                        std::vector&lt;float&gt; vBu(frames * 2, 0);   // Default initialized, memset() not required.</a>
<a name="ln7058">                        float* bu = vBu.data();</a>
<a name="ln7059">#endif</a>
<a name="ln7060">                        synth-&gt;process(frames, bu);</a>
<a name="ln7061">                        float* sp = bu;</a>
<a name="ln7062">                        for (unsigned i = 0; i &lt; frames; ++i) {</a>
<a name="ln7063">                              *l++ = *sp++;</a>
<a name="ln7064">                              *r++ = *sp++;</a>
<a name="ln7065">                              }</a>
<a name="ln7066">                        playTime += frames;</a>
<a name="ln7067">                        }</a>
<a name="ln7068"> </a>
<a name="ln7069">                  if (pass == 1) {</a>
<a name="ln7070">                        for (int i = 0; i &lt; FRAMES; ++i) {</a>
<a name="ln7071">                              max = qMax(max, qAbs(bufferL[i]));</a>
<a name="ln7072">                              max = qMax(max, qAbs(bufferR[i]));</a>
<a name="ln7073">                              bufferL[i] *= gain;</a>
<a name="ln7074">                              bufferR[i] *= gain;</a>
<a name="ln7075">                              }</a>
<a name="ln7076">                        long bytes;</a>
<a name="ln7077">                        if (FRAMES &lt; inSamples)</a>
<a name="ln7078">                              bytes = exporter.encodeRemainder(bufferL, bufferR,  FRAMES , bufferOut);</a>
<a name="ln7079">                        else</a>
<a name="ln7080">                              bytes = exporter.encodeBuffer(bufferL, bufferR, bufferOut);</a>
<a name="ln7081">                        if (bytes &lt; 0) {</a>
<a name="ln7082">                              if (MScore::noGui)</a>
<a name="ln7083">                                    qDebug(&quot;exportmp3: error from encoder: %ld&quot;, bytes);</a>
<a name="ln7084">                              else</a>
<a name="ln7085">                                    QMessageBox::warning(0,</a>
<a name="ln7086">                                       tr(&quot;Encoding Error&quot;),</a>
<a name="ln7087">                                       tr(&quot;Error %1 returned from MP3 encoder&quot;).arg(bytes),</a>
<a name="ln7088">                                       QString(), QString());</a>
<a name="ln7089">                              break;</a>
<a name="ln7090">                              }</a>
<a name="ln7091">                        else</a>
<a name="ln7092">                              device-&gt;write((char*)bufferOut, bytes);</a>
<a name="ln7093">                        }</a>
<a name="ln7094">                  else {</a>
<a name="ln7095">                        for (int i = 0; i &lt; FRAMES; ++i) {</a>
<a name="ln7096">                              max = qMax(max, qAbs(bufferL[i]));</a>
<a name="ln7097">                              max = qMax(max, qAbs(bufferR[i]));</a>
<a name="ln7098">                              peak = qMax(peak, qAbs(bufferL[i]));</a>
<a name="ln7099">                              peak = qMax(peak, qAbs(bufferR[i]));</a>
<a name="ln7100">                              }</a>
<a name="ln7101">                        }</a>
<a name="ln7102">                  playTime = endTime;</a>
<a name="ln7103">                  if (!MScore::noGui) {</a>
<a name="ln7104">                        if (progress.wasCanceled())</a>
<a name="ln7105">                              break;</a>
<a name="ln7106">                        progress.setValue((pass * et + playTime) / 2);</a>
<a name="ln7107">                        qApp-&gt;processEvents();</a>
<a name="ln7108">                        }</a>
<a name="ln7109">                  if (playTime &gt;= et)</a>
<a name="ln7110">                        synth-&gt;allNotesOff(-1);</a>
<a name="ln7111">                  // create sound until the sound decays</a>
<a name="ln7112">                  if (playTime &gt;= et &amp;&amp; max * peak &lt; 0.000001)</a>
<a name="ln7113">                        break;</a>
<a name="ln7114">                  // hard limit</a>
<a name="ln7115">                  if (playTime &gt; maxEndTime)</a>
<a name="ln7116">                        break;</a>
<a name="ln7117">                  }</a>
<a name="ln7118">            if (progress.wasCanceled())</a>
<a name="ln7119">                  break;</a>
<a name="ln7120">            if (pass == 0 &amp;&amp; peak == 0.0) {</a>
<a name="ln7121">                  qDebug(&quot;song is empty&quot;);</a>
<a name="ln7122">                  break;</a>
<a name="ln7123">                  }</a>
<a name="ln7124">            gain = 0.99 / peak;</a>
<a name="ln7125">            }</a>
<a name="ln7126"> </a>
<a name="ln7127">      long bytes = exporter.finishStream(bufferOut);</a>
<a name="ln7128">      if (bytes &gt; 0L)</a>
<a name="ln7129">            device-&gt;write((char*)bufferOut, bytes);</a>
<a name="ln7130">      wasCanceled = progress.wasCanceled();</a>
<a name="ln7131">      progress.close();</a>
<a name="ln7132">      delete synth;</a>
<a name="ln7133">      delete[] bufferOut;</a>
<a name="ln7134">      MScore::sampleRate = oldSampleRate;</a>
<a name="ln7135">      return true;</a>
<a name="ln7136">#endif</a>
<a name="ln7137">      }</a>
<a name="ln7138"> </a>
<a name="ln7139">#ifndef TELEMETRY_DISABLED</a>
<a name="ln7140"> </a>
<a name="ln7141">//---------------------------------------------------------</a>
<a name="ln7142">//   tryToRequestTelemetryPermission</a>
<a name="ln7143">//---------------------------------------------------------</a>
<a name="ln7144"> </a>
<a name="ln7145">void tryToRequestTelemetryPermission()</a>
<a name="ln7146">      {</a>
<a name="ln7147">      static const QString telemetryVersion = &quot;3.4.1&quot;;</a>
<a name="ln7148">      QString accessRequestedAtVersion = preferences.getString(PREF_APP_STARTUP_TELEMETRY_ACCESS_REQUESTED);</a>
<a name="ln7149"> </a>
<a name="ln7150">      if (accessRequestedAtVersion == telemetryVersion)</a>
<a name="ln7151">            return;</a>
<a name="ln7152"> </a>
<a name="ln7153">      // Disable telemetry until the permission is explicitly confirmed by user</a>
<a name="ln7154">      preferences.setPreference(PREF_APP_TELEMETRY_ALLOWED, false);</a>
<a name="ln7155"> </a>
<a name="ln7156">      if (MScore::noGui)</a>
<a name="ln7157">            return;</a>
<a name="ln7158"> </a>
<a name="ln7159">      QEventLoop eventLoop;</a>
<a name="ln7160"> </a>
<a name="ln7161">      TelemetryPermissionDialog *requestDialog = new TelemetryPermissionDialog(mscore-&gt;getQmlUiEngine());</a>
<a name="ln7162">      QObject::connect(requestDialog, &amp;TelemetryPermissionDialog::closeRequested, [&amp;eventLoop] () {</a>
<a name="ln7163">            eventLoop.quit();</a>
<a name="ln7164">            });</a>
<a name="ln7165"> </a>
<a name="ln7166">      requestDialog-&gt;show();</a>
<a name="ln7167">      eventLoop.exec();</a>
<a name="ln7168">      requestDialog-&gt;deleteLater();</a>
<a name="ln7169"> </a>
<a name="ln7170">      preferences.setPreference(PREF_APP_STARTUP_TELEMETRY_ACCESS_REQUESTED, telemetryVersion);</a>
<a name="ln7171">      }</a>
<a name="ln7172">#endif</a>
<a name="ln7173"> </a>
<a name="ln7174">//---------------------------------------------------------</a>
<a name="ln7175">//   updateUiStyleAndTheme</a>
<a name="ln7176">//---------------------------------------------------------</a>
<a name="ln7177"> </a>
<a name="ln7178">void MuseScore::updateUiStyleAndTheme()</a>
<a name="ln7179">      {</a>
<a name="ln7180">      // set UI Theme</a>
<a name="ln7181">      QApplication::setStyle(QStyleFactory::create(&quot;Fusion&quot;));</a>
<a name="ln7182"> </a>
<a name="ln7183">      QString wd = QString(&quot;%1/%2&quot;).arg(QStandardPaths::writableLocation(QStandardPaths::DocumentsLocation)).arg(QCoreApplication::applicationName());</a>
<a name="ln7184">      // set UI Color Palette</a>
<a name="ln7185">      QPalette p(QApplication::palette());</a>
<a name="ln7186">      QString jsonPaletteFilename = preferences.isThemeDark() ? &quot;palette_dark_fusion.json&quot; : &quot;palette_light_fusion.json&quot;;;</a>
<a name="ln7187">      QFile jsonPalette(QString(&quot;:/themes/%1&quot;).arg(jsonPaletteFilename));</a>
<a name="ln7188">      // read from Documents TODO: remove this</a>
<a name="ln7189">      if (QFile::exists(QString(&quot;%1/%2&quot;).arg(wd, &quot;ms_palette.json&quot;)))</a>
<a name="ln7190">            jsonPalette.setFileName(QString(&quot;%1/%2&quot;).arg(wd, &quot;ms_palette.json&quot;));</a>
<a name="ln7191">      if (jsonPalette.open(QFile::ReadOnly | QFile::Text)) {</a>
<a name="ln7192">            QJsonDocument d = QJsonDocument::fromJson(jsonPalette.readAll());</a>
<a name="ln7193">            QJsonObject o = d.object();</a>
<a name="ln7194">            QMetaEnum metaEnum = QMetaEnum::fromType&lt;QPalette::ColorRole&gt;();</a>
<a name="ln7195">            for (int i = 0; i &lt; metaEnum.keyCount(); ++i) {</a>
<a name="ln7196">                  QJsonValue v = o.value(metaEnum.valueToKey(i));</a>
<a name="ln7197">                  if (!v.isUndefined())</a>
<a name="ln7198">                        p.setColor(static_cast&lt;QPalette::ColorRole&gt;(metaEnum.value(i)), QColor(v.toString()));</a>
<a name="ln7199">                  }</a>
<a name="ln7200">            }</a>
<a name="ln7201">      QApplication::setPalette(p);</a>
<a name="ln7202"> </a>
<a name="ln7203">      // set UI Style</a>
<a name="ln7204">      QString css;</a>
<a name="ln7205">      QString styleFilename = preferences.isThemeDark() ? &quot;style_dark_fusion.css&quot; : &quot;style_light_fusion.css&quot;;</a>
<a name="ln7206">      QFile fstyle(QString(&quot;:/themes/%1&quot;).arg(styleFilename));</a>
<a name="ln7207">      // read from Documents TODO: remove this</a>
<a name="ln7208">      if (QFile::exists(QString(&quot;%1/%2&quot;).arg(wd, &quot;ms_style.css&quot;)))</a>
<a name="ln7209">            fstyle.setFileName(QString(&quot;%1/%2&quot;).arg(wd, &quot;ms_style.css&quot;));</a>
<a name="ln7210">      if (fstyle.open(QFile::ReadOnly | QFile::Text)) {</a>
<a name="ln7211">            QTextStream in(&amp;fstyle);</a>
<a name="ln7212">            css = in.readAll();</a>
<a name="ln7213">            }</a>
<a name="ln7214"> </a>
<a name="ln7215">      css.replace(&quot;$voice1-bgcolor&quot;, MScore::selectColor[0].name(QColor::HexRgb));</a>
<a name="ln7216">      css.replace(&quot;$voice2-bgcolor&quot;, MScore::selectColor[1].name(QColor::HexRgb));</a>
<a name="ln7217">      css.replace(&quot;$voice3-bgcolor&quot;, MScore::selectColor[2].name(QColor::HexRgb));</a>
<a name="ln7218">      css.replace(&quot;$voice4-bgcolor&quot;, MScore::selectColor[3].name(QColor::HexRgb));</a>
<a name="ln7219"> </a>
<a name="ln7220">      if (preferences.isThemeDark()) {</a>
<a name="ln7221">            css.replace(&quot;$buttonHighlightDisabledOff&quot;, Ms::preferences.getColor(PREF_UI_BUTTON_HIGHLIGHT_COLOR_DISABLED_DARK_OFF).name().toLatin1());</a>
<a name="ln7222">            css.replace(&quot;$buttonHighlightDisabledOn&quot;, Ms::preferences.getColor(PREF_UI_BUTTON_HIGHLIGHT_COLOR_DISABLED_DARK_ON).name().toLatin1());</a>
<a name="ln7223">            css.replace(&quot;$buttonHighlightEnabledOff&quot;, Ms::preferences.getColor(PREF_UI_BUTTON_HIGHLIGHT_COLOR_ENABLED_DARK_OFF).name().toLatin1());</a>
<a name="ln7224">            css.replace(&quot;$buttonHighlightEnabledOn&quot;, Ms::preferences.getColor(PREF_UI_BUTTON_HIGHLIGHT_COLOR_ENABLED_DARK_ON).name().toLatin1());</a>
<a name="ln7225">            }</a>
<a name="ln7226">      else {</a>
<a name="ln7227">            css.replace(&quot;$buttonHighlightDisabledOff&quot;, Ms::preferences.getColor(PREF_UI_BUTTON_HIGHLIGHT_COLOR_DISABLED_LIGHT_OFF).name().toLatin1());</a>
<a name="ln7228">            css.replace(&quot;$buttonHighlightDisabledOn&quot;, Ms::preferences.getColor(PREF_UI_BUTTON_HIGHLIGHT_COLOR_DISABLED_LIGHT_ON).name().toLatin1());</a>
<a name="ln7229">            css.replace(&quot;$buttonHighlightEnabledOff&quot;, Ms::preferences.getColor(PREF_UI_BUTTON_HIGHLIGHT_COLOR_ENABLED_LIGHT_OFF).name().toLatin1());</a>
<a name="ln7230">            css.replace(&quot;$buttonHighlightEnabledOn&quot;, Ms::preferences.getColor(PREF_UI_BUTTON_HIGHLIGHT_COLOR_ENABLED_LIGHT_ON).name().toLatin1());</a>
<a name="ln7231">            }</a>
<a name="ln7232"> </a>
<a name="ln7233">      qApp-&gt;setStyleSheet(css);</a>
<a name="ln7234"> </a>
<a name="ln7235">      QString style = QString(&quot;*, QSpinBox { font: %1pt \&quot;%2\&quot; } &quot;)</a>
<a name="ln7236">                  .arg(QString::number(preferences.getInt(PREF_UI_THEME_FONTSIZE)), preferences.getString(PREF_UI_THEME_FONTFAMILY))</a>
<a name="ln7237">                  + qApp-&gt;styleSheet();</a>
<a name="ln7238">      qApp-&gt;setStyleSheet(style);</a>
<a name="ln7239"> </a>
<a name="ln7240">      genIcons();</a>
<a name="ln7241">      Shortcut::refreshIcons();</a>
<a name="ln7242">      }</a>
<a name="ln7243"> </a>
<a name="ln7244">//---------------------------------------------------------</a>
<a name="ln7245">//   fullVersion</a>
<a name="ln7246">///   \return Full version of MuseScore, including version</a>
<a name="ln7247">///   label (e.g. 3.4.0-Beta).</a>
<a name="ln7248">//---------------------------------------------------------</a>
<a name="ln7249"> </a>
<a name="ln7250">QString MuseScore::fullVersion()</a>
<a name="ln7251">      {</a>
<a name="ln7252">      QString version(VERSION);</a>
<a name="ln7253">      QString versionLabel(VERSION_LABEL);</a>
<a name="ln7254">      versionLabel = versionLabel.replace(' ', &quot;&quot;);</a>
<a name="ln7255">      if (!versionLabel.isEmpty())</a>
<a name="ln7256">            version.append(&quot;-&quot;).append(versionLabel);</a>
<a name="ln7257">      return version;</a>
<a name="ln7258">      }</a>
<a name="ln7259"> </a>
<a name="ln7260">//---------------------------------------------------------</a>
<a name="ln7261">//   initApplication</a>
<a name="ln7262">//---------------------------------------------------------</a>
<a name="ln7263"> </a>
<a name="ln7264">MuseScoreApplication* MuseScoreApplication::initApplication(int&amp; argc, char** argv)</a>
<a name="ln7265">      {</a>
<a name="ln7266">      QFile f(&quot;:/revision.h&quot;);</a>
<a name="ln7267">      f.open(QIODevice::ReadOnly);</a>
<a name="ln7268">      revision = QString(f.readAll()).trimmed();</a>
<a name="ln7269">      f.close();</a>
<a name="ln7270"> </a>
<a name="ln7271">      const char* appName;</a>
<a name="ln7272">      const char* appName2;</a>
<a name="ln7273">      if (MuseScore::unstable()) {</a>
<a name="ln7274">            appName2 = &quot;mscore-dev3&quot;;</a>
<a name="ln7275">            appName  = &quot;MuseScore3Development&quot;;</a>
<a name="ln7276">            }</a>
<a name="ln7277">      else {</a>
<a name="ln7278">            appName2 = &quot;mscore3&quot;;</a>
<a name="ln7279">            appName  = &quot;MuseScore3&quot;;</a>
<a name="ln7280">            }</a>
<a name="ln7281"> </a>
<a name="ln7282">      MuseScoreApplication* app = new MuseScoreApplication(appName2, argc, argv);</a>
<a name="ln7283">      QCoreApplication::setApplicationName(appName);</a>
<a name="ln7284"> </a>
<a name="ln7285">      QCoreApplication::setOrganizationName(&quot;MuseScore&quot;);</a>
<a name="ln7286">      QCoreApplication::setOrganizationDomain(&quot;musescore.org&quot;);</a>
<a name="ln7287">      QCoreApplication::setApplicationVersion(MuseScore::fullVersion());</a>
<a name="ln7288"> </a>
<a name="ln7289">#ifdef BUILD_CRASH_REPORTER</a>
<a name="ln7290">      {</a>
<a name="ln7291">      static_assert(sizeof(CRASHREPORTER_EXECUTABLE) &gt; 1,</a>
<a name="ln7292">         &quot;CRASHREPORTER_EXECUTABLE should be defined to build with crash reporter&quot;</a>
<a name="ln7293">         );</a>
<a name="ln7294">      CrashReporter::Handler* crashHandler = new CrashReporter::Handler(QDir::tempPath(), true, CRASHREPORTER_EXECUTABLE);</a>
<a name="ln7295">      QObject::connect(app, &amp;QCoreApplication::aboutToQuit, [crashHandler]() { delete crashHandler; });</a>
<a name="ln7296">      }</a>
<a name="ln7297">#endif</a>
<a name="ln7298"> </a>
<a name="ln7299">      return app;</a>
<a name="ln7300">      }</a>
<a name="ln7301"> </a>
<a name="ln7302">//---------------------------------------------------------</a>
<a name="ln7303">//   parseCommandLineArguments</a>
<a name="ln7304">//---------------------------------------------------------</a>
<a name="ln7305"> </a>
<a name="ln7306">MuseScoreApplication::CommandLineParseResult MuseScoreApplication::parseCommandLineArguments(MuseScoreApplication* app)</a>
<a name="ln7307">      {</a>
<a name="ln7308">      QCommandLineParser parser;</a>
<a name="ln7309">      CommandLineParseResult parseResult;</a>
<a name="ln7310"> </a>
<a name="ln7311">      parser.addHelpOption(); // -?, -h, --help</a>
<a name="ln7312">      parser.addVersionOption(); // -v, --version</a>
<a name="ln7313"> </a>
<a name="ln7314">    //parser.addOption(QCommandLineOption({&quot;v&quot;, &quot;version&quot;}, &quot;Print version&quot;)); // see above</a>
<a name="ln7315">      parser.addOption(QCommandLineOption(      &quot;long-version&quot;, &quot;Print detailed version information&quot;));</a>
<a name="ln7316">      parser.addOption(QCommandLineOption({&quot;d&quot;, &quot;debug&quot;}, &quot;Debug mode&quot;));</a>
<a name="ln7317">      parser.addOption(QCommandLineOption({&quot;L&quot;, &quot;layout-debug&quot;}, &quot;Layout debug mode&quot;));</a>
<a name="ln7318">      parser.addOption(QCommandLineOption({&quot;s&quot;, &quot;no-synthesizer&quot;}, &quot;No internal synthesizer&quot;));</a>
<a name="ln7319">      parser.addOption(QCommandLineOption({&quot;m&quot;, &quot;no-midi&quot;}, &quot;No MIDI&quot;));</a>
<a name="ln7320">      parser.addOption(QCommandLineOption({&quot;a&quot;, &quot;use-audio&quot;}, &quot;Use audio driver: jack, alsa, pulse, or portaudio&quot;, &quot;driver&quot;));</a>
<a name="ln7321">      parser.addOption(QCommandLineOption({&quot;n&quot;, &quot;new-score&quot;}, &quot;Start with new score&quot;));</a>
<a name="ln7322">      parser.addOption(QCommandLineOption({&quot;I&quot;, &quot;dump-midi-in&quot;}, &quot;Dump midi input&quot;));</a>
<a name="ln7323">      parser.addOption(QCommandLineOption({&quot;O&quot;, &quot;dump-midi-out&quot;}, &quot;Dump midi output&quot;));</a>
<a name="ln7324">      parser.addOption(QCommandLineOption({&quot;o&quot;, &quot;export-to&quot;}, &quot;Export to 'file'. Format depends on file's extension&quot;, &quot;file&quot;));</a>
<a name="ln7325">      parser.addOption(QCommandLineOption({&quot;r&quot;, &quot;image-resolution&quot;}, &quot;Used with '-o &lt;file&gt;.png'. Set output resolution for image export&quot;, &quot;DPI&quot;));</a>
<a name="ln7326">      parser.addOption(QCommandLineOption({&quot;T&quot;, &quot;trim-image&quot;}, &quot;Used with '-o &lt;file&gt;.png' and '-o &lt;file.svg&gt;'. Trim exported image with specified margin (in pixels)&quot;, &quot;margin&quot;));</a>
<a name="ln7327">      parser.addOption(QCommandLineOption({&quot;x&quot;, &quot;gui-scaling&quot;}, &quot;Set scaling factor for GUI elements&quot;, &quot;factor&quot;));</a>
<a name="ln7328">      parser.addOption(QCommandLineOption({&quot;D&quot;, &quot;monitor-resolution&quot;}, &quot;Specify monitor resolution&quot;, &quot;DPI&quot;));</a>
<a name="ln7329">      parser.addOption(QCommandLineOption({&quot;S&quot;, &quot;style&quot;}, &quot;Load style file&quot;, &quot;style&quot;));</a>
<a name="ln7330">      parser.addOption(QCommandLineOption({&quot;p&quot;, &quot;plugin&quot;}, &quot;Execute named plugin&quot;, &quot;name&quot;));</a>
<a name="ln7331">      parser.addOption(QCommandLineOption(      &quot;template-mode&quot;, &quot;Save template mode, no page size&quot;)); // and no platform and creationDate tags</a>
<a name="ln7332">      parser.addOption(QCommandLineOption({&quot;F&quot;, &quot;factory-settings&quot;}, &quot;Use factory settings&quot;));  // this includes -R, --revert-settimngs</a>
<a name="ln7333">      parser.addOption(QCommandLineOption({&quot;R&quot;, &quot;revert-settings&quot;}, &quot;Revert to factory settings, but keep default preferences&quot;));</a>
<a name="ln7334">      parser.addOption(QCommandLineOption({&quot;i&quot;, &quot;load-icons&quot;}, &quot;Load icons from INSTALLPATH/icons&quot;));</a>
<a name="ln7335">      parser.addOption(QCommandLineOption({&quot;j&quot;, &quot;job&quot;}, &quot;Process a conversion job&quot;, &quot;file&quot;));</a>
<a name="ln7336">      parser.addOption(QCommandLineOption({&quot;e&quot;, &quot;experimental&quot;}, &quot;Enable experimental features&quot;));</a>
<a name="ln7337">      parser.addOption(QCommandLineOption({&quot;c&quot;, &quot;config-folder&quot;}, &quot;Override configuration and settings folder&quot;, &quot;dir&quot;));</a>
<a name="ln7338">      parser.addOption(QCommandLineOption({&quot;t&quot;, &quot;test-mode&quot;}, &quot;Set test mode flag for all files&quot;)); // this includes --template-mode</a>
<a name="ln7339">      parser.addOption(QCommandLineOption(&quot;run-test-script&quot;, &quot;Run script tests listed in the command line arguments&quot;));</a>
<a name="ln7340">      parser.addOption(QCommandLineOption({&quot;M&quot;, &quot;midi-operations&quot;}, &quot;Specify MIDI import operations file&quot;, &quot;file&quot;));</a>
<a name="ln7341">      parser.addOption(QCommandLineOption({&quot;w&quot;, &quot;no-webview&quot;}, &quot;No web view in start center&quot;));</a>
<a name="ln7342">      parser.addOption(QCommandLineOption({&quot;P&quot;, &quot;export-score-parts&quot;}, &quot;Used with '-o &lt;file&gt;.pdf', export score and parts&quot;));</a>
<a name="ln7343">      parser.addOption(QCommandLineOption(      &quot;no-fallback-font&quot;, &quot;Don't use Bravura as fallback musical font&quot;));</a>
<a name="ln7344">      parser.addOption(QCommandLineOption({&quot;f&quot;, &quot;force&quot;}, &quot;Used with '-o &lt;file&gt;', ignore warnings reg. score being corrupted or from wrong version&quot;));</a>
<a name="ln7345">      parser.addOption(QCommandLineOption({&quot;b&quot;, &quot;bitrate&quot;}, &quot;Used with '-o &lt;file&gt;.mp3', sets bitrate, in kbps&quot;, &quot;bitrate&quot;));</a>
<a name="ln7346">      parser.addOption(QCommandLineOption({&quot;E&quot;, &quot;install-extension&quot;}, &quot;Install an extension, load soundfont as default unless if -e is passed too&quot;, &quot;extension file&quot;));</a>
<a name="ln7347">      parser.addOption(QCommandLineOption(&quot;score-media&quot;, &quot;Export all media (excepting mp3) for a given score in a single JSON file and print it to std out&quot;));</a>
<a name="ln7348">      parser.addOption(QCommandLineOption(&quot;score-meta&quot;, &quot;Export score metadata to JSON document and print it to stdout&quot;));</a>
<a name="ln7349">      parser.addOption(QCommandLineOption(&quot;score-mp3&quot;, &quot;Generates mp3 for the given score and export the data to a single JSON file, print it to std out&quot;));</a>
<a name="ln7350">      parser.addOption(QCommandLineOption(&quot;score-parts-pdf&quot;, &quot;Generates parts data for the given score and export the data to a single JSON file, print it to std out&quot;));</a>
<a name="ln7351">      parser.addOption(QCommandLineOption(&quot;score-transpose&quot;, &quot;Transposes the given score and exports the data to a single JSON file, prints it to std out&quot;, &quot;options&quot;));</a>
<a name="ln7352">      parser.addOption(QCommandLineOption(&quot;raw-diff&quot;, &quot;Print a raw diff for the given scores&quot;));</a>
<a name="ln7353">      parser.addOption(QCommandLineOption(&quot;diff&quot;, &quot;Print a diff for the given scores&quot;));</a>
<a name="ln7354"> </a>
<a name="ln7355">      parser.addPositionalArgument(&quot;scorefiles&quot;, &quot;The files to open&quot;, &quot;[scorefile...]&quot;);</a>
<a name="ln7356"> </a>
<a name="ln7357">      parser.process(QCoreApplication::arguments());</a>
<a name="ln7358"> </a>
<a name="ln7359">    //if (parser.isSet(&quot;v&quot;)) parser.showVersion(); // a) needs Qt &gt;= 5.4 , b) instead we use addVersionOption()</a>
<a name="ln7360">      if (parser.isSet(&quot;long-version&quot;)) {</a>
<a name="ln7361">            printVersion(&quot;MuseScore&quot;);</a>
<a name="ln7362">            parseResult.exit = true;</a>
<a name="ln7363">            return parseResult;</a>
<a name="ln7364">            }</a>
<a name="ln7365">      MScore::debugMode = parser.isSet(&quot;d&quot;);</a>
<a name="ln7366">      MScore::noHorizontalStretch = MScore::noVerticalStretch = parser.isSet(&quot;L&quot;);</a>
<a name="ln7367">      noSeq = parser.isSet(&quot;s&quot;);</a>
<a name="ln7368">      noMidi = parser.isSet(&quot;m&quot;);</a>
<a name="ln7369">      if (parser.isSet(&quot;a&quot;)) {</a>
<a name="ln7370">            audioDriver = parser.value(&quot;a&quot;);</a>
<a name="ln7371">            if (audioDriver.isEmpty())</a>
<a name="ln7372">                  parser.showHelp(EXIT_FAILURE);</a>
<a name="ln7373">            }</a>
<a name="ln7374">      startWithNewScore = parser.isSet(&quot;n&quot;);</a>
<a name="ln7375">      externalIcons = parser.isSet(&quot;i&quot;);</a>
<a name="ln7376">      midiInputTrace = parser.isSet(&quot;I&quot;);</a>
<a name="ln7377">      midiOutputTrace = parser.isSet(&quot;O&quot;);</a>
<a name="ln7378">      MScore::useFallbackFont = !parser.isSet(&quot;no-fallback-font&quot;);</a>
<a name="ln7379"> </a>
<a name="ln7380">      if ((converterMode = parser.isSet(&quot;o&quot;))) {</a>
<a name="ln7381">            MScore::noGui = true;</a>
<a name="ln7382">            outFileName = parser.value(&quot;o&quot;);</a>
<a name="ln7383">            if (outFileName.isEmpty())</a>
<a name="ln7384">                  parser.showHelp(EXIT_FAILURE);</a>
<a name="ln7385">            }</a>
<a name="ln7386">      if ((processJob = parser.isSet(&quot;j&quot;))) {</a>
<a name="ln7387">            MScore::noGui = true;</a>
<a name="ln7388">            converterMode = true;</a>
<a name="ln7389">            jsonFileName = parser.value(&quot;j&quot;);</a>
<a name="ln7390">            if (jsonFileName.isEmpty()) {</a>
<a name="ln7391">                  fprintf(stderr, &quot;json file name missing\n&quot;);</a>
<a name="ln7392">                  parser.showHelp(EXIT_FAILURE);</a>
<a name="ln7393">                  }</a>
<a name="ln7394">            }</a>
<a name="ln7395">      if ((pluginMode = parser.isSet(&quot;p&quot;))) {</a>
<a name="ln7396">            MScore::noGui = true;</a>
<a name="ln7397">            pluginName = parser.value(&quot;p&quot;);</a>
<a name="ln7398">            if (pluginName.isEmpty())</a>
<a name="ln7399">                  parser.showHelp(EXIT_FAILURE);</a>
<a name="ln7400">            }</a>
<a name="ln7401">      if (parser.isSet(&quot;E&quot;)) {</a>
<a name="ln7402">            MScore::noGui = true;</a>
<a name="ln7403">            extensionName = parser.value(&quot;E&quot;);</a>
<a name="ln7404">            }</a>
<a name="ln7405">      MScore::saveTemplateMode = parser.isSet(&quot;template-mode&quot;);</a>
<a name="ln7406">      if (parser.isSet(&quot;r&quot;)) {</a>
<a name="ln7407">            QString temp = parser.value(&quot;r&quot;);</a>
<a name="ln7408">            if (temp.isEmpty())</a>
<a name="ln7409">                   parser.showHelp(EXIT_FAILURE);</a>
<a name="ln7410">            bool ok = false;</a>
<a name="ln7411">            double res = temp.toDouble(&amp;ok);</a>
<a name="ln7412">            if (ok)</a>
<a name="ln7413">                  preferences.setTemporaryPreference(PREF_EXPORT_PNG_RESOLUTION, res);</a>
<a name="ln7414">            else</a>
<a name="ln7415">                  fprintf(stderr, &quot;PNG resolution value '%s' not recognized, using default setting from preferences instead.\n&quot;, qPrintable(temp));</a>
<a name="ln7416">            }</a>
<a name="ln7417">      if (parser.isSet(&quot;T&quot;)) {</a>
<a name="ln7418">            QString temp = parser.value(&quot;T&quot;);</a>
<a name="ln7419">            if (temp.isEmpty())</a>
<a name="ln7420">                   parser.showHelp(EXIT_FAILURE);</a>
<a name="ln7421">            bool ok = false;</a>
<a name="ln7422">            trimMargin = temp.toInt(&amp;ok);</a>
<a name="ln7423">            if (!ok) {</a>
<a name="ln7424">                  fprintf(stderr, &quot;Trim margin value '%s' not recognized, so no trimming will be done.\n&quot;, qPrintable(temp));</a>
<a name="ln7425">                  trimMargin = -1;</a>
<a name="ln7426">                  }</a>
<a name="ln7427">           }</a>
<a name="ln7428">      if (parser.isSet(&quot;x&quot;)) {</a>
<a name="ln7429">            QString temp = parser.value(&quot;x&quot;);</a>
<a name="ln7430">            if (temp.isEmpty())</a>
<a name="ln7431">                   parser.showHelp(EXIT_FAILURE);</a>
<a name="ln7432">            bool ok = false;</a>
<a name="ln7433">            guiScaling = temp.toDouble(&amp;ok);</a>
<a name="ln7434">            if (!ok) {</a>
<a name="ln7435">                  fprintf(stderr, &quot;GUI scaling value '%s' not recognized, so the values detected by Qt are taken.\n&quot;, qPrintable(temp));</a>
<a name="ln7436">                  guiScaling = 0.0;</a>
<a name="ln7437">                  }</a>
<a name="ln7438">            }</a>
<a name="ln7439">      if (parser.isSet(&quot;D&quot;)) {</a>
<a name="ln7440">            QString temp = parser.value(&quot;D&quot;);</a>
<a name="ln7441">            if (temp.isEmpty())</a>
<a name="ln7442">                   parser.showHelp(EXIT_FAILURE);</a>
<a name="ln7443">            bool ok = false;</a>
<a name="ln7444">            userDPI = temp.toDouble(&amp;ok);</a>
<a name="ln7445">            if (!ok) {</a>
<a name="ln7446">                  fprintf(stderr, &quot;DPI value '%s' not recognized, so the values detected by Qt are taken.\n&quot;, qPrintable(temp));</a>
<a name="ln7447">                  userDPI = 0.0;</a>
<a name="ln7448">                  }</a>
<a name="ln7449">            }</a>
<a name="ln7450">      if (parser.isSet(&quot;S&quot;)) {</a>
<a name="ln7451">            styleFile = parser.value(&quot;S&quot;);</a>
<a name="ln7452">            if (styleFile.isEmpty())</a>
<a name="ln7453">                  parser.showHelp(EXIT_FAILURE);</a>
<a name="ln7454">            }</a>
<a name="ln7455">      deletePreferences = parser.isSet(&quot;F&quot;);</a>
<a name="ln7456">      useFactorySettings = (deletePreferences || parser.isSet(&quot;R&quot;));</a>
<a name="ln7457">      enableExperimental = parser.isSet(&quot;e&quot;);</a>
<a name="ln7458">      if (parser.isSet(&quot;c&quot;)) {</a>
<a name="ln7459">            QString path = parser.value(&quot;c&quot;);</a>
<a name="ln7460">            if (path.isEmpty())</a>
<a name="ln7461">                  parser.showHelp(EXIT_FAILURE);</a>
<a name="ln7462">            QDir dir;</a>
<a name="ln7463">            if (dir.exists(path)) {</a>
<a name="ln7464">                  QSettings::setPath(QSettings::IniFormat, QSettings::UserScope, path);</a>
<a name="ln7465">                  QSettings::setPath(QSettings::IniFormat, QSettings::SystemScope, path);</a>
<a name="ln7466">                  dataPath = path;</a>
<a name="ln7467">                  }</a>
<a name="ln7468">            }</a>
<a name="ln7469">      MScore::testMode = parser.isSet(&quot;t&quot;);</a>
<a name="ln7470">      if (parser.isSet(&quot;M&quot;)) {</a>
<a name="ln7471">            QString temp = parser.value(&quot;M&quot;);</a>
<a name="ln7472">            if (temp.isEmpty())</a>
<a name="ln7473">                  parser.showHelp(EXIT_FAILURE);</a>
<a name="ln7474">            midiImportOperations.setOperationsFile(temp);</a>
<a name="ln7475">            }</a>
<a name="ln7476">      noWebView = parser.isSet(&quot;w&quot;);</a>
<a name="ln7477">      exportScoreParts = parser.isSet(&quot;export-score-parts&quot;);</a>
<a name="ln7478">      if (exportScoreParts &amp;&amp; !converterMode)</a>
<a name="ln7479">            parser.showHelp(EXIT_FAILURE);</a>
<a name="ln7480">      ignoreWarnings = parser.isSet(&quot;f&quot;);</a>
<a name="ln7481">      if (parser.isSet(&quot;b&quot;)) {</a>
<a name="ln7482">            QString temp = parser.value(&quot;b&quot;);</a>
<a name="ln7483">            if (temp.isEmpty())</a>
<a name="ln7484">                   parser.showHelp(EXIT_FAILURE);</a>
<a name="ln7485">            bool ok = false;</a>
<a name="ln7486">            int rate = temp.toInt(&amp;ok);</a>
<a name="ln7487">            if (ok)</a>
<a name="ln7488">                  preferences.setTemporaryPreference(PREF_EXPORT_MP3_BITRATE, rate);</a>
<a name="ln7489">            else</a>
<a name="ln7490">                  fprintf(stderr, &quot;MP3 bitrate value '%s' not recognized, using default setting from preferences instead.\n&quot;, qPrintable(temp));</a>
<a name="ln7491">           }</a>
<a name="ln7492"> </a>
<a name="ln7493">      if (parser.isSet(&quot;score-media&quot;)) {</a>
<a name="ln7494">            exportScoreMedia = true;</a>
<a name="ln7495">            MScore::noGui = true;</a>
<a name="ln7496">            converterMode = true;</a>
<a name="ln7497">            }</a>
<a name="ln7498"> </a>
<a name="ln7499">      if (parser.isSet(&quot;score-meta&quot;)) {</a>
<a name="ln7500">            exportScoreMeta = true;</a>
<a name="ln7501">            MScore::noGui = true;</a>
<a name="ln7502">            converterMode = true;</a>
<a name="ln7503">            }</a>
<a name="ln7504"> </a>
<a name="ln7505">      if (parser.isSet(&quot;score-mp3&quot;)) {</a>
<a name="ln7506">            exportScoreMp3 = true;</a>
<a name="ln7507">            MScore::noGui = true;</a>
<a name="ln7508">            converterMode = true;</a>
<a name="ln7509">            }</a>
<a name="ln7510"> </a>
<a name="ln7511">      if (parser.isSet(&quot;score-parts-pdf&quot;)) {</a>
<a name="ln7512">            exportScorePartsPdf = true;</a>
<a name="ln7513">            MScore::noGui = true;</a>
<a name="ln7514">            converterMode = true;</a>
<a name="ln7515">            }</a>
<a name="ln7516"> </a>
<a name="ln7517">      if (parser.isSet(&quot;score-transpose&quot;)) {</a>
<a name="ln7518">            exportTransposedScore = true;</a>
<a name="ln7519">            transposeExportOptions = parser.value(&quot;score-transpose&quot;);</a>
<a name="ln7520">            MScore::noGui = true;</a>
<a name="ln7521">            converterMode = true;</a>
<a name="ln7522">            }</a>
<a name="ln7523"> </a>
<a name="ln7524">      if (parser.isSet(&quot;raw-diff&quot;)) {</a>
<a name="ln7525">            MScore::noGui = true;</a>
<a name="ln7526">            rawDiffMode = true;</a>
<a name="ln7527">            }</a>
<a name="ln7528">      if (parser.isSet(&quot;diff&quot;)) {</a>
<a name="ln7529">            MScore::noGui = true;</a>
<a name="ln7530">            diffMode = true;</a>
<a name="ln7531">            }</a>
<a name="ln7532">      if (parser.isSet(&quot;run-test-script&quot;)) {</a>
<a name="ln7533">            if (rawDiffMode || diffMode)</a>
<a name="ln7534">                  qFatal(&quot;incompatible options&quot;);</a>
<a name="ln7535">            MScore::noGui = true;</a>
<a name="ln7536">            scriptTestMode = true;</a>
<a name="ln7537">            }</a>
<a name="ln7538"> </a>
<a name="ln7539">      QStringList argv = parser.positionalArguments();</a>
<a name="ln7540"> </a>
<a name="ln7541">      if (app &amp;&amp; !converterMode &amp;&amp; !pluginMode) {</a>
<a name="ln7542">            if (!argv.isEmpty()) {</a>
<a name="ln7543">                  int ok = true;</a>
<a name="ln7544">                  for (const QString&amp; message : argv) {</a>
<a name="ln7545">                        QFileInfo fi(message);</a>
<a name="ln7546">                        if (!app-&gt;sendMessage(fi.absoluteFilePath())) {</a>
<a name="ln7547">                              ok = false;</a>
<a name="ln7548">                              break;</a>
<a name="ln7549">                              }</a>
<a name="ln7550"> </a>
<a name="ln7551">                        }</a>
<a name="ln7552">                  if (ok) {</a>
<a name="ln7553">                        parseResult.exit = true;</a>
<a name="ln7554">                        return parseResult;</a>
<a name="ln7555">                        }</a>
<a name="ln7556">                  }</a>
<a name="ln7557">            else</a>
<a name="ln7558">                  if (app-&gt;sendMessage(QString(&quot;&quot;))) {</a>
<a name="ln7559">                        parseResult.exit = true;</a>
<a name="ln7560">                        return parseResult;</a>
<a name="ln7561">                        }</a>
<a name="ln7562">            }</a>
<a name="ln7563">      if (rawDiffMode || diffMode) {</a>
<a name="ln7564">            if (argv.size() != 2)</a>
<a name="ln7565">                  qFatal(&quot;Only two scores are needed for performing a comparison&quot;);</a>
<a name="ln7566">            }</a>
<a name="ln7567">      if (scriptTestMode &amp;&amp; argv.empty())</a>
<a name="ln7568">            qFatal(&quot;Please specify scripts to execute&quot;);</a>
<a name="ln7569"> </a>
<a name="ln7570">      parseResult.argv = argv;</a>
<a name="ln7571">      return parseResult;</a>
<a name="ln7572">      }</a>
<a name="ln7573">} // namespace Ms</a>
<a name="ln7574"> </a>
<a name="ln7575">//---------------------------------------------------------</a>
<a name="ln7576">//   initZitaResources</a>
<a name="ln7577">///   must be placed outside of namespace</a>
<a name="ln7578">//---------------------------------------------------------</a>
<a name="ln7579"> </a>
<a name="ln7580">static void initZitaResources()</a>
<a name="ln7581">      {</a>
<a name="ln7582">      Q_INIT_RESOURCE(zita);</a>
<a name="ln7583">      }</a>
<a name="ln7584"> </a>
<a name="ln7585">namespace Ms {</a>
<a name="ln7586">//---------------------------------------------------------</a>
<a name="ln7587">//   runApplication</a>
<a name="ln7588">//---------------------------------------------------------</a>
<a name="ln7589"> </a>
<a name="ln7590">int runApplication(int&amp; argc, char** av)</a>
<a name="ln7591">      {</a>
<a name="ln7592">#ifndef NDEBUG</a>
<a name="ln7593">      qSetMessagePattern(&quot;%{file}:%{function}: %{message}&quot;);</a>
<a name="ln7594">      Ms::checkStyles();</a>
<a name="ln7595">#endif</a>
<a name="ln7596"> </a>
<a name="ln7597">      QApplication::setDesktopSettingsAware(true);</a>
<a name="ln7598">#ifdef Q_OS_LINUX</a>
<a name="ln7599">      QGuiApplication::setDesktopFileName(&quot;mscore&quot;);</a>
<a name="ln7600">#endif</a>
<a name="ln7601">      QApplication::setAttribute(Qt::AA_UseHighDpiPixmaps);</a>
<a name="ln7602">      QApplication::setAttribute(Qt::AA_EnableHighDpiScaling);</a>
<a name="ln7603">#if defined(QT_DEBUG) &amp;&amp; defined(Q_OS_WIN)</a>
<a name="ln7604">      qInstallMessageHandler(mscoreMessageHandler);</a>
<a name="ln7605">#endif</a>
<a name="ln7606"> </a>
<a name="ln7607">#ifdef Q_OS_WIN</a>
<a name="ln7608">      if (!qEnvironmentVariableIsSet(&quot;QT_OPENGL_BUGLIST&quot;)) {</a>
<a name="ln7609">            // Set custom OpenGL buglist to work around rendering issues</a>
<a name="ln7610">            // on Windows 7 (#296682). This should also prevent crashes</a>
<a name="ln7611">            // happening for some Intel GPUs due to outdated buglist in Qt 5.9.</a>
<a name="ln7612">            qputenv(&quot;QT_OPENGL_BUGLIST&quot;, &quot;:/data/win_opengl_buglist.json&quot;);</a>
<a name="ln7613">            }</a>
<a name="ln7614">#endif</a>
<a name="ln7615"> </a>
<a name="ln7616">      qRegisterMetaTypeStreamOperators&lt;SessionStart&gt;(&quot;SessionStart&quot;);</a>
<a name="ln7617">      qRegisterMetaTypeStreamOperators&lt;MusicxmlExportBreaks&gt;(&quot;MusicxmlExportBreaks&quot;);</a>
<a name="ln7618">      qRegisterMetaTypeStreamOperators&lt;MuseScoreStyleType&gt;(&quot;MuseScoreStyleType&quot;);</a>
<a name="ln7619"> </a>
<a name="ln7620">      MuseScoreApplication* app = MuseScoreApplication::initApplication(argc, av);</a>
<a name="ln7621"> </a>
<a name="ln7622">      QAccessible::installFactory(AccessibleScoreView::ScoreViewFactory);</a>
<a name="ln7623">      QAccessible::installFactory(AccessibleSearchBox::SearchBoxFactory);</a>
<a name="ln7624">      QAccessible::installFactory(Awl::AccessibleAbstractSlider::AbstractSliderFactory);</a>
<a name="ln7625"> </a>
<a name="ln7626">      initZitaResources();</a>
<a name="ln7627"> </a>
<a name="ln7628">#ifndef Q_OS_MAC</a>
<a name="ln7629">      QSettings::setDefaultFormat(QSettings::IniFormat);</a>
<a name="ln7630">#endif</a>
<a name="ln7631"> </a>
<a name="ln7632">      auto cmdLineParseResult = MuseScoreApplication::parseCommandLineArguments(app);</a>
<a name="ln7633"> </a>
<a name="ln7634">      if (cmdLineParseResult.exit)</a>
<a name="ln7635">            return 0;</a>
<a name="ln7636"> </a>
<a name="ln7637">      MuseScore::init(cmdLineParseResult.argv);</a>
<a name="ln7638"> </a>
<a name="ln7639">      if (MScore::noGui) {</a>
<a name="ln7640">#ifdef Q_OS_MAC</a>
<a name="ln7641">            // see issue #28706: Hangup in converter mode with MusicXML source</a>
<a name="ln7642">            qApp-&gt;processEvents();</a>
<a name="ln7643">#endif</a>
<a name="ln7644">            const bool ok = processNonGui(cmdLineParseResult.argv);</a>
<a name="ln7645">            return ok ? EXIT_SUCCESS : EXIT_FAILURE;</a>
<a name="ln7646">            }</a>
<a name="ln7647"> </a>
<a name="ln7648">      return qApp-&gt;exec();</a>
<a name="ln7649">      }</a>
<a name="ln7650"> </a>
<a name="ln7651">//---------------------------------------------------------</a>
<a name="ln7652">//   init</a>
<a name="ln7653">//---------------------------------------------------------</a>
<a name="ln7654"> </a>
<a name="ln7655">void MuseScore::init(QStringList&amp; argv)</a>
<a name="ln7656">      {</a>
<a name="ln7657">      mscoreGlobalShare = getSharePath();</a>
<a name="ln7658">      iconPath = externalIcons ? mscoreGlobalShare + QString(&quot;icons/&quot;) :  QString(&quot;:/data/icons/&quot;);</a>
<a name="ln7659"> </a>
<a name="ln7660">      if (dataPath.isEmpty())</a>
<a name="ln7661">            dataPath = QStandardPaths::writableLocation(QStandardPaths::DataLocation);</a>
<a name="ln7662"> </a>
<a name="ln7663">      if (useFactorySettings) {</a>
<a name="ln7664">            if (deletePreferences)</a>
<a name="ln7665">                  QDir(dataPath).removeRecursively();</a>
<a name="ln7666">            QSettings settings;</a>
<a name="ln7667">            QFile::remove(settings.fileName() + &quot;.lock&quot;); //forcibly remove lock</a>
<a name="ln7668">            QFile::remove(settings.fileName());</a>
<a name="ln7669">            settings.clear();</a>
<a name="ln7670">            }</a>
<a name="ln7671"> </a>
<a name="ln7672">      // create local plugin directory</a>
<a name="ln7673">      // if not already there:</a>
<a name="ln7674">      QDir().mkpath(dataPath + &quot;/plugins&quot;);</a>
<a name="ln7675"> </a>
<a name="ln7676">      if (MScore::debugMode)</a>
<a name="ln7677">            qDebug(&quot;global share: &lt;%s&gt;&quot;, qPrintable(mscoreGlobalShare));</a>
<a name="ln7678"> </a>
<a name="ln7679">      // set translator before Shortcut are initialized to get translations for all shortcuts</a>
<a name="ln7680">      // can not use preferences to retrieve these values as it needs to be initialized after translator is set</a>
<a name="ln7681">      if (useFactorySettings)</a>
<a name="ln7682">            localeName = &quot;system&quot;;</a>
<a name="ln7683">      else {</a>
<a name="ln7684">            QSettings s;</a>
<a name="ln7685">            localeName = s.value(PREF_UI_APP_LANGUAGE, &quot;system&quot;).toString();</a>
<a name="ln7686">            }</a>
<a name="ln7687"> </a>
<a name="ln7688">      setMscoreLocale(localeName);</a>
<a name="ln7689"> </a>
<a name="ln7690">      Shortcut::init();</a>
<a name="ln7691">      preferences.init();</a>
<a name="ln7692"> </a>
<a name="ln7693">      QNetworkProxyFactory::setUseSystemConfiguration(true);</a>
<a name="ln7694"> </a>
<a name="ln7695">      MScore::init();         // initialize libmscore</a>
<a name="ln7696">      updateExternalValuesFromPreferences();</a>
<a name="ln7697"> </a>
<a name="ln7698">      // initialize current page size from default printer</a>
<a name="ln7699">#ifndef QT_NO_PRINTER</a>
<a name="ln7700">      if (!MScore::testMode &amp;&amp; !MScore::saveTemplateMode) {</a>
<a name="ln7701">            QPrinter p;</a>
<a name="ln7702">            if (p.isValid()) {</a>
<a name="ln7703">//                  qDebug(&quot;set paper size from default printer&quot;);</a>
<a name="ln7704">                  QRectF psf = p.paperRect(QPrinter::Inch);</a>
<a name="ln7705">                  MScore::defaultStyle().set(Sid::pageWidth,  psf.width());</a>
<a name="ln7706">                  MScore::defaultStyle().set(Sid::pageHeight, psf.height());</a>
<a name="ln7707">                  MScore::defaultStyle().set(Sid::pagePrintableWidth, psf.width()-20.0/INCH);</a>
<a name="ln7708">                  }</a>
<a name="ln7709">            }</a>
<a name="ln7710">#endif</a>
<a name="ln7711"> </a>
<a name="ln7712">      if (MScore::debugMode) {</a>
<a name="ln7713">            qDebug(&quot;DPI %f&quot;, DPI);</a>
<a name="ln7714"> </a>
<a name="ln7715">            QScreen* screen      = QGuiApplication::primaryScreen();</a>
<a name="ln7716">            qDebug() &lt;&lt; &quot;Information for screen:&quot; &lt;&lt; screen-&gt;name();</a>
<a name="ln7717">            qDebug() &lt;&lt; &quot;  Available geometry:&quot; &lt;&lt; screen-&gt;availableGeometry().x() &lt;&lt; screen-&gt;availableGeometry().y() &lt;&lt; screen-&gt;availableGeometry().width() &lt;&lt; &quot;x&quot; &lt;&lt; screen-&gt;availableGeometry().height();</a>
<a name="ln7718">            qDebug() &lt;&lt; &quot;  Available size:&quot; &lt;&lt; screen-&gt;availableSize().width() &lt;&lt; &quot;x&quot; &lt;&lt; screen-&gt;availableSize().height();</a>
<a name="ln7719">            qDebug() &lt;&lt; &quot;  Available virtual geometry:&quot; &lt;&lt; screen-&gt;availableVirtualGeometry().x() &lt;&lt; screen-&gt;availableVirtualGeometry().y() &lt;&lt; screen-&gt;availableVirtualGeometry().width() &lt;&lt; &quot;x&quot; &lt;&lt; screen-&gt;availableVirtualGeometry().height();</a>
<a name="ln7720">            qDebug() &lt;&lt; &quot;  Available virtual size:&quot; &lt;&lt; screen-&gt;availableVirtualSize().width() &lt;&lt; &quot;x&quot; &lt;&lt; screen-&gt;availableVirtualSize().height();</a>
<a name="ln7721">            qDebug() &lt;&lt; &quot;  Depth:&quot; &lt;&lt; screen-&gt;depth() &lt;&lt; &quot;bits&quot;;</a>
<a name="ln7722">            qDebug() &lt;&lt; &quot;  Geometry:&quot; &lt;&lt; screen-&gt;geometry().x() &lt;&lt; screen-&gt;geometry().y() &lt;&lt; screen-&gt;geometry().width() &lt;&lt; &quot;x&quot; &lt;&lt; screen-&gt;geometry().height();</a>
<a name="ln7723">            qDebug() &lt;&lt; &quot;  Logical DPI:&quot; &lt;&lt; screen-&gt;logicalDotsPerInch();</a>
<a name="ln7724">            qDebug() &lt;&lt; &quot;  Logical DPI X:&quot; &lt;&lt; screen-&gt;logicalDotsPerInchX();</a>
<a name="ln7725">            qDebug() &lt;&lt; &quot;  Logical DPI Y:&quot; &lt;&lt; screen-&gt;logicalDotsPerInchY();</a>
<a name="ln7726">            qDebug() &lt;&lt; &quot;  Physical DPI:&quot; &lt;&lt; screen-&gt;physicalDotsPerInch();</a>
<a name="ln7727">            qDebug() &lt;&lt; &quot;  Physical DPI X:&quot; &lt;&lt; screen-&gt;physicalDotsPerInchX();</a>
<a name="ln7728">            qDebug() &lt;&lt; &quot;  Physical DPI Y:&quot; &lt;&lt; screen-&gt;physicalDotsPerInchY();</a>
<a name="ln7729">            qDebug() &lt;&lt; &quot;  Physical size:&quot; &lt;&lt; screen-&gt;physicalSize().width() &lt;&lt; &quot;x&quot; &lt;&lt; screen-&gt;physicalSize().height() &lt;&lt; &quot;mm&quot;;</a>
<a name="ln7730">            qDebug() &lt;&lt; &quot;  Refresh rate:&quot; &lt;&lt; screen-&gt;refreshRate() &lt;&lt; &quot;Hz&quot;;</a>
<a name="ln7731">            qDebug() &lt;&lt; &quot;  Size:&quot; &lt;&lt; screen-&gt;size().width() &lt;&lt; &quot;x&quot; &lt;&lt; screen-&gt;size().height();</a>
<a name="ln7732">            qDebug() &lt;&lt; &quot;  Virtual geometry:&quot; &lt;&lt; screen-&gt;virtualGeometry().x() &lt;&lt; screen-&gt;virtualGeometry().y() &lt;&lt; screen-&gt;virtualGeometry().width() &lt;&lt; &quot;x&quot; &lt;&lt; screen-&gt;virtualGeometry().height();</a>
<a name="ln7733">            qDebug() &lt;&lt; &quot;  Virtual size:&quot; &lt;&lt; screen-&gt;virtualSize().width() &lt;&lt; &quot;x&quot; &lt;&lt; screen-&gt;virtualSize().height();</a>
<a name="ln7734">            }</a>
<a name="ln7735"> </a>
<a name="ln7736">      if (!MScore::testMode)</a>
<a name="ln7737">            MScore::readDefaultStyle(preferences.getString(PREF_SCORE_STYLE_DEFAULTSTYLEFILE));</a>
<a name="ln7738"> </a>
<a name="ln7739">      QSplashScreen* sc = 0;</a>
<a name="ln7740">      if (!MScore::noGui &amp;&amp; preferences.getBool(PREF_UI_APP_STARTUP_SHOWSPLASHSCREEN)) {</a>
<a name="ln7741">            QString pictureScaling;</a>
<a name="ln7742">            if (QGuiApplication::primaryScreen()-&gt;devicePixelRatio() &gt;= 2)</a>
<a name="ln7743">                  pictureScaling = &quot;@2x&quot;;</a>
<a name="ln7744">            QPixmap pm(&quot;:/data/splash&quot; + pictureScaling + &quot;.png&quot;);</a>
<a name="ln7745">            sc = new QSplashScreen(pm);</a>
<a name="ln7746">            sc-&gt;setWindowTitle(QString(&quot;MuseScore Startup&quot;));</a>
<a name="ln7747">#ifdef Q_OS_MAC // to have session dialog on top of splashscreen on mac</a>
<a name="ln7748">            sc-&gt;setWindowFlags(Qt::FramelessWindowHint);</a>
<a name="ln7749">#endif</a>
<a name="ln7750">            sc-&gt;show();</a>
<a name="ln7751">            qApp-&gt;processEvents();</a>
<a name="ln7752">            }</a>
<a name="ln7753"> </a>
<a name="ln7754">      if (!MScore::noGui)</a>
<a name="ln7755">            MuseScore::updateUiStyleAndTheme();</a>
<a name="ln7756">      else {</a>
<a name="ln7757">            genIcons(); // in GUI mode generated in updateUiStyleAndTheme()</a>
<a name="ln7758">            noSeq = true;</a>
<a name="ln7759">            }</a>
<a name="ln7760"> </a>
<a name="ln7761">      // Do not create sequencer and audio drivers if run with '-s'</a>
<a name="ln7762">      if (!noSeq) {</a>
<a name="ln7763">            seq            = new Seq();</a>
<a name="ln7764">            MScore::seq    = seq;</a>
<a name="ln7765">            Driver* driver = driverFactory(seq, audioDriver);</a>
<a name="ln7766">            synti          = synthesizerFactory();</a>
<a name="ln7767">            if (driver) {</a>
<a name="ln7768">                  MScore::sampleRate = driver-&gt;sampleRate();</a>
<a name="ln7769">                  synti-&gt;setSampleRate(MScore::sampleRate);</a>
<a name="ln7770">                  synti-&gt;init();</a>
<a name="ln7771"> </a>
<a name="ln7772">                  seq-&gt;setDriver(driver);</a>
<a name="ln7773">                  }</a>
<a name="ln7774">            else {</a>
<a name="ln7775">                  // Do not delete the sequencer If we can't load driver.</a>
<a name="ln7776">                  // Allow user to select the working driver later.</a>
<a name="ln7777">                  MScore::sampleRate = 44100;  // Would be changed when user changes driver</a>
<a name="ln7778">                  synti-&gt;setSampleRate(MScore::sampleRate);</a>
<a name="ln7779">                  synti-&gt;init();</a>
<a name="ln7780">                  }</a>
<a name="ln7781">            seq-&gt;setMasterSynthesizer(synti);</a>
<a name="ln7782">            }</a>
<a name="ln7783">      else {</a>
<a name="ln7784">            seq         = 0;</a>
<a name="ln7785">            MScore::seq = 0;</a>
<a name="ln7786">            }</a>
<a name="ln7787">//---</a>
<a name="ln7788">      //</a>
<a name="ln7789">      // avoid font problems by overriding the environment</a>
<a name="ln7790">      //    fall back to &quot;C&quot; locale</a>
<a name="ln7791">      //</a>
<a name="ln7792"> </a>
<a name="ln7793">      //#ifndef Q_OS_WIN</a>
<a name="ln7794">      //setenv(&quot;LANG&quot;, &quot;C&quot;, 1);</a>
<a name="ln7795">      //#endif</a>
<a name="ln7796">      //QLocale::setDefault(QLocale(QLocale::C));</a>
<a name="ln7797"> </a>
<a name="ln7798">      if (MScore::debugMode) {</a>
<a name="ln7799">            QStringList sl(QCoreApplication::libraryPaths());</a>
<a name="ln7800">            foreach(const QString&amp; s, sl)</a>
<a name="ln7801">                  qDebug(&quot;LibraryPath: &lt;%s&gt;&quot;, qPrintable(s));</a>
<a name="ln7802">            }</a>
<a name="ln7803"> </a>
<a name="ln7804">      // rastral size of font is 20pt = 20/72 inch = 20*DPI/72 dots</a>
<a name="ln7805">      //   staff has 5 lines = 4 * _spatium</a>
<a name="ln7806">      //   _spatium    = SPATIUM20;     // 20.0 / 72.0 * DPI / 4.0;</a>
<a name="ln7807"> </a>
<a name="ln7808">      if (!MScore::noGui) {</a>
<a name="ln7809">#ifndef Q_OS_MAC</a>
<a name="ln7810">            qApp-&gt;setWindowIcon(*icons[int(Icons::window_ICON)]);</a>
<a name="ln7811">#endif</a>
<a name="ln7812">            WorkspacesManager::initCurrentWorkspace();</a>
<a name="ln7813">            }</a>
<a name="ln7814"> </a>
<a name="ln7815">      mscore = new MuseScore();</a>
<a name="ln7816">      // create a score for internal use</a>
<a name="ln7817">      gscore = new MasterScore();</a>
<a name="ln7818">      gscore-&gt;setPaletteMode(true);</a>
<a name="ln7819">      gscore-&gt;setMovements(new Movements());</a>
<a name="ln7820">      gscore-&gt;setStyle(MScore::baseStyle());</a>
<a name="ln7821"> </a>
<a name="ln7822">      gscore-&gt;style().set(Sid::MusicalTextFont, QString(&quot;Bravura Text&quot;));</a>
<a name="ln7823">      ScoreFont* scoreFont = ScoreFont::fontFactory(&quot;Bravura&quot;);</a>
<a name="ln7824">      gscore-&gt;setScoreFont(scoreFont);</a>
<a name="ln7825">      gscore-&gt;setNoteHeadWidth(scoreFont-&gt;width(SymId::noteheadBlack, gscore-&gt;spatium()) / SPATIUM20);</a>
<a name="ln7826"> </a>
<a name="ln7827">#ifndef TELEMETRY_DISABLED</a>
<a name="ln7828">      tryToRequestTelemetryPermission();</a>
<a name="ln7829">#endif</a>
<a name="ln7830"> </a>
<a name="ln7831">      //read languages list</a>
<a name="ln7832">      mscore-&gt;readLanguages(mscoreGlobalShare + &quot;locale/languages.xml&quot;);</a>
<a name="ln7833"> </a>
<a name="ln7834">      if (!MScore::noGui) {</a>
<a name="ln7835">            if (preferences.getBool(PREF_APP_STARTUP_FIRSTSTART)) {</a>
<a name="ln7836">                  mscoreFirstStart = true;</a>
<a name="ln7837">                  StartupWizard* sw = new StartupWizard;</a>
<a name="ln7838">                  sw-&gt;exec();</a>
<a name="ln7839">                  preferences.setPreference(PREF_APP_STARTUP_FIRSTSTART, false);</a>
<a name="ln7840">                  preferences.setPreference(PREF_APP_KEYBOARDLAYOUT, sw-&gt;keyboardLayout());</a>
<a name="ln7841">                  preferences.setPreference(PREF_UI_APP_LANGUAGE, sw-&gt;language());</a>
<a name="ln7842">                  setMscoreLocale(sw-&gt;language());</a>
<a name="ln7843">                  Workspace::writeGlobalToolBar();</a>
<a name="ln7844">                  Workspace::writeGlobalGUIState();</a>
<a name="ln7845">                  Workspace* targetWorkspace = WorkspacesManager::visibleWorkspaces()[0];</a>
<a name="ln7846">                  if (targetWorkspace)</a>
<a name="ln7847">                        mscore-&gt;changeWorkspace(targetWorkspace, true);</a>
<a name="ln7848">                  </a>
<a name="ln7849">                  preferences.setPreference(PREF_UI_APP_STARTUP_SHOWTOURS, sw-&gt;showTours());</a>
<a name="ln7850">                  delete sw;</a>
<a name="ln7851"> </a>
<a name="ln7852">                  // reinitialize preferences so some default values are calculated based on chosen language</a>
<a name="ln7853">                  preferences.init();</a>
<a name="ln7854">                  // store preferences with locale-dependent default values</a>
<a name="ln7855">                  // so that the values from first start will be used later</a>
<a name="ln7856">                  preferences.setToDefaultValue(PREF_APP_PATHS_MYSCORES);</a>
<a name="ln7857">                  preferences.setToDefaultValue(PREF_APP_PATHS_MYSTYLES);</a>
<a name="ln7858">                  preferences.setToDefaultValue(PREF_APP_PATHS_MYIMAGES);</a>
<a name="ln7859">                  preferences.setToDefaultValue(PREF_APP_PATHS_MYTEMPLATES);</a>
<a name="ln7860">                  preferences.setToDefaultValue(PREF_APP_PATHS_MYPLUGINS);</a>
<a name="ln7861">                  preferences.setToDefaultValue(PREF_APP_PATHS_MYSOUNDFONTS);</a>
<a name="ln7862">                  preferences.setToDefaultValue(PREF_APP_PATHS_MYEXTENSIONS);</a>
<a name="ln7863">                  updateExternalValuesFromPreferences();</a>
<a name="ln7864">                  }</a>
<a name="ln7865">            if (!Shortcut::customSource()) {</a>
<a name="ln7866">                  QString keyboardLayout = preferences.getString(PREF_APP_KEYBOARDLAYOUT);</a>
<a name="ln7867">                  StartupWizard::autoSelectShortcuts(keyboardLayout);</a>
<a name="ln7868">                  }</a>
<a name="ln7869">            }</a>
<a name="ln7870"> </a>
<a name="ln7871">      if (!noSeq) {</a>
<a name="ln7872">            if (!seq-&gt;init())</a>
<a name="ln7873">                  qDebug(&quot;sequencer init failed&quot;);</a>
<a name="ln7874">            }</a>
<a name="ln7875"> </a>
<a name="ln7876">      QApplication::instance()-&gt;installEventFilter(mscore);</a>
<a name="ln7877"> </a>
<a name="ln7878">#ifndef TELEMETRY_DISABLED</a>
<a name="ln7879">      QApplication::instance()-&gt;installEventFilter(ActionEventObserver::instance());</a>
<a name="ln7880">      ActionEventObserver::instance()-&gt;setScoreState(mscore-&gt;state());</a>
<a name="ln7881">      QObject::connect(mscore, &amp;MuseScore::scoreStateChanged, ActionEventObserver::instance(), &amp;ActionEventObserver::setScoreState);</a>
<a name="ln7882">#endif</a>
<a name="ln7883"> </a>
<a name="ln7884">      mscore-&gt;setRevision(Ms::revision);</a>
<a name="ln7885">      int files = 0;</a>
<a name="ln7886">      bool restoredSession = false;</a>
<a name="ln7887"> </a>
<a name="ln7888">      if (MScore::noGui)</a>
<a name="ln7889">            return;</a>
<a name="ln7890">      else {</a>
<a name="ln7891">            mscore-&gt;readSettings();</a>
<a name="ln7892">            QObject::connect(qApp, SIGNAL(messageReceived(const QString&amp;)),</a>
<a name="ln7893">               mscore, SLOT(handleMessage(const QString&amp;)));</a>
<a name="ln7894"> </a>
<a name="ln7895">            static_cast&lt;QtSingleApplication*&gt;(qApp)-&gt;setActivationWindow(mscore, false);</a>
<a name="ln7896">            // count filenames specified on the command line</a>
<a name="ln7897">            // these are the non-empty strings remaining in argv</a>
<a name="ln7898">            foreach(const QString&amp; name, argv) {</a>
<a name="ln7899">                  if (!name.isEmpty())</a>
<a name="ln7900">                        ++files;</a>
<a name="ln7901">                  }</a>
<a name="ln7902">#ifdef Q_OS_MAC</a>
<a name="ln7903">            // app-&gt;paths contains files requested to be loaded by OS X</a>
<a name="ln7904">            // append these to argv and update file count</a>
<a name="ln7905">            foreach(const QString&amp; name, static_cast&lt;MuseScoreApplication*&gt;(qApp)-&gt;paths) {</a>
<a name="ln7906">                  if (!name.isEmpty()) {</a>
<a name="ln7907">                        argv &lt;&lt; name;</a>
<a name="ln7908">                        ++files;</a>
<a name="ln7909">                        }</a>
<a name="ln7910">                  }</a>
<a name="ln7911">#endif</a>
<a name="ln7912">            //</a>
<a name="ln7913">            // TODO: delete old session backups</a>
<a name="ln7914">            //</a>
<a name="ln7915">            restoredSession = mscore-&gt;restoreSession((preferences.sessionStart() == SessionStart::LAST &amp;&amp; (files == 0)));</a>
<a name="ln7916">            }</a>
<a name="ln7917"> </a>
<a name="ln7918">      errorMessage = new QErrorMessage(mscore);</a>
<a name="ln7919">#ifdef SCRIPT_INTERFACE</a>
<a name="ln7920">      mscore-&gt;getPluginManager()-&gt;readPluginList();</a>
<a name="ln7921">      mscore-&gt;loadPlugins();</a>
<a name="ln7922">#endif</a>
<a name="ln7923">      mscore-&gt;writeSessionFile(false);</a>
<a name="ln7924"> </a>
<a name="ln7925">#ifdef Q_OS_MAC</a>
<a name="ln7926">      // there's a bug in Qt showing the toolbar unified after switching showFullScreen(), showMaximized(),</a>
<a name="ln7927">      // showNormal()...</a>
<a name="ln7928">      mscore-&gt;setUnifiedTitleAndToolBarOnMac(false);</a>
<a name="ln7929"> </a>
<a name="ln7930">      // don't let macOS add &quot;Show Tab Bar&quot; to &quot;View&quot; Menu</a>
<a name="ln7931">      CocoaBridge::setAllowsAutomaticWindowTabbing(false);</a>
<a name="ln7932">#endif</a>
<a name="ln7933"> </a>
<a name="ln7934">      mscore-&gt;changeState(mscore-&gt;noScore() ? STATE_DISABLED : STATE_NORMAL);</a>
<a name="ln7935">      mscore-&gt;show();</a>
<a name="ln7936"> </a>
<a name="ln7937">      if (!restoredSession || files)</a>
<a name="ln7938">            loadScores(argv);</a>
<a name="ln7939"> </a>
<a name="ln7940">      if (mscore-&gt;hasToCheckForExtensionsUpdate())</a>
<a name="ln7941">            mscore-&gt;checkForExtensionsUpdate();</a>
<a name="ln7942"> </a>
<a name="ln7943">      if (QWidget* menubar = mscore-&gt;menuWidget())</a>
<a name="ln7944">            TourHandler::addWidgetToTour(&quot;welcome&quot;, menubar, &quot;menubar&quot;);</a>
<a name="ln7945"> </a>
<a name="ln7946">      if (!scoresOnCommandline &amp;&amp; preferences.getBool(PREF_UI_APP_STARTUP_SHOWSTARTCENTER) &amp;&amp; (!restoredSession || mscore-&gt;scores().size() == 0)) {</a>
<a name="ln7947">#ifdef Q_OS_MAC</a>
<a name="ln7948">// ugly, but on mac we get an event when a file is open.</a>
<a name="ln7949">// We can't get the event when the startcenter is shown.</a>
<a name="ln7950">// So we let the event loop run a bit before showing the start center.</a>
<a name="ln7951">            QTimer *timer = new QTimer();</a>
<a name="ln7952">            timer-&gt;setSingleShot(true);</a>
<a name="ln7953">            QObject::connect(timer, &amp;QTimer::timeout, [=]() {</a>
<a name="ln7954">                  if (!scoresOnCommandline) {</a>
<a name="ln7955">                        getAction(&quot;startcenter&quot;)-&gt;setChecked(true);</a>
<a name="ln7956">                        mscore-&gt;showStartcenter(true);</a>
<a name="ln7957">                        }</a>
<a name="ln7958">                  timer-&gt;deleteLater();</a>
<a name="ln7959">                  } );</a>
<a name="ln7960">            timer-&gt;start(500);</a>
<a name="ln7961">#else</a>
<a name="ln7962"> </a>
<a name="ln7963">            getAction(&quot;startcenter&quot;)-&gt;setChecked(true);</a>
<a name="ln7964">            mscore-&gt;showStartcenter(true);</a>
<a name="ln7965">#endif</a>
<a name="ln7966">            }</a>
<a name="ln7967">      else {</a>
<a name="ln7968">            mscore-&gt;tourHandler()-&gt;startTour(&quot;welcome&quot;);</a>
<a name="ln7969">            //otherwise, welcome tour will appear on closing StartCenter</a>
<a name="ln7970">            }</a>
<a name="ln7971"> </a>
<a name="ln7972">      if (sc) {</a>
<a name="ln7973">            sc-&gt;close();</a>
<a name="ln7974">            qApp-&gt;processEvents();</a>
<a name="ln7975">            }</a>
<a name="ln7976"> </a>
<a name="ln7977">      mscore-&gt;showPlayPanel(preferences.getBool(PREF_UI_APP_STARTUP_SHOWPLAYPANEL));</a>
<a name="ln7978">      QSettings settings;</a>
<a name="ln7979">      if (settings.value(&quot;synthControlVisible&quot;, false).toBool())</a>
<a name="ln7980">            mscore-&gt;showSynthControl(true);</a>
<a name="ln7981">      }</a>
<a name="ln7982"> </a>
<a name="ln7983">//---------------------------------------------------------</a>
<a name="ln7984">//   exportPartsPdfsToJSON</a>
<a name="ln7985">//---------------------------------------------------------</a>
<a name="ln7986"> </a>
<a name="ln7987">bool MuseScore::exportPartsPdfsToJSON(const QString&amp; inFilePath, const QString&amp; outFilePath)</a>
<a name="ln7988">{</a>
<a name="ln7989">      MasterScore* score = mscore-&gt;readScore(inFilePath);</a>
<a name="ln7990">      if (!score)</a>
<a name="ln7991">            return false;</a>
<a name="ln7992"> </a>
<a name="ln7993">      QString outPath = QFileInfo(inFilePath).path() + &quot;/&quot;;</a>
<a name="ln7994"> </a>
<a name="ln7995">      QJsonObject jsonForPdfs;</a>
<a name="ln7996">      QString outName = outPath + QFileInfo(inFilePath).completeBaseName() + &quot;.pdf&quot;;</a>
<a name="ln7997">      jsonForPdfs[&quot;score&quot;] = outName;</a>
<a name="ln7998"> </a>
<a name="ln7999">      //save score pdf</a>
<a name="ln8000">      if (!styleFile.isEmpty()) {</a>
<a name="ln8001">            QFile f(styleFile);</a>
<a name="ln8002">            if (f.open(QIODevice::ReadOnly))</a>
<a name="ln8003">                  score-&gt;style().load(&amp;f);</a>
<a name="ln8004">      }</a>
<a name="ln8005">      score-&gt;switchToPageMode();</a>
<a name="ln8006"> </a>
<a name="ln8007">      jsonForPdfs[&quot;scoreBin&quot;] = QString::fromLatin1(mscore-&gt;exportPdfAsJSON(score));</a>
<a name="ln8008"> </a>
<a name="ln8009">      //save extended score+parts and separate parts pdfs</a>
<a name="ln8010">      //if no parts, generate parts from existing instruments</a>
<a name="ln8011">      if (score-&gt;excerpts().size() == 0) {</a>
<a name="ln8012">            auto excerpts = Excerpt::createAllExcerpt(score);</a>
<a name="ln8013">            for (Excerpt* e : excerpts) {</a>
<a name="ln8014">                  Score* nscore = new Score(e-&gt;oscore());</a>
<a name="ln8015">                  e-&gt;setPartScore(nscore);</a>
<a name="ln8016">                  nscore-&gt;style().set(Sid::createMultiMeasureRests, true);</a>
<a name="ln8017">                  auto excerptCmdFake = new AddExcerpt(e);</a>
<a name="ln8018">                  excerptCmdFake-&gt;redo(nullptr);</a>
<a name="ln8019">                  Excerpt::createExcerpt(e);</a>
<a name="ln8020">            }</a>
<a name="ln8021">      }</a>
<a name="ln8022"> </a>
<a name="ln8023">      QList&lt;Score*&gt; scores;</a>
<a name="ln8024">      scores.append(score);</a>
<a name="ln8025">      QJsonArray partsArray;</a>
<a name="ln8026">      QJsonArray partsNamesArray;</a>
<a name="ln8027">      for (Excerpt* e : score-&gt;excerpts()) {</a>
<a name="ln8028">            scores.append(e-&gt;partScore());</a>
<a name="ln8029">            QJsonValue partNameVal(e-&gt;title());</a>
<a name="ln8030">            partsNamesArray.append(partNameVal);</a>
<a name="ln8031">            QJsonValue partVal(QString::fromLatin1(exportPdfAsJSON(e-&gt;partScore())));</a>
<a name="ln8032">            partsArray.append(partVal);</a>
<a name="ln8033">      }</a>
<a name="ln8034">      jsonForPdfs[&quot;parts&quot;] = partsNamesArray;</a>
<a name="ln8035">      jsonForPdfs[&quot;partsBin&quot;] = partsArray;</a>
<a name="ln8036"> </a>
<a name="ln8037">      jsonForPdfs[&quot;scoreFullPostfix&quot;] = QString(&quot;-Score_and_parts&quot;) + &quot;.pdf&quot;;</a>
<a name="ln8038"> </a>
<a name="ln8039">      QString tempFileName = outPath + &quot;tempPdf.pdf&quot;;</a>
<a name="ln8040">      bool res = mscore-&gt;savePdf(scores, tempFileName);</a>
<a name="ln8041">      QFile tempPdf(tempFileName);</a>
<a name="ln8042">      tempPdf.open(QIODevice::ReadWrite);</a>
<a name="ln8043">      QByteArray fullScoreData = tempPdf.readAll();</a>
<a name="ln8044">      tempPdf.remove();</a>
<a name="ln8045">      jsonForPdfs[&quot;scoreFullBin&quot;] = QString::fromLatin1(fullScoreData.toBase64());</a>
<a name="ln8046"> </a>
<a name="ln8047">      QJsonDocument jsonDoc(jsonForPdfs);</a>
<a name="ln8048">      const QString&amp; jsonPath{outFilePath};</a>
<a name="ln8049">      QFile file(jsonPath);</a>
<a name="ln8050">      res &amp;= file.open(QIODevice::WriteOnly);</a>
<a name="ln8051">      if (res) {</a>
<a name="ln8052">            file.write(jsonDoc.toJson(QJsonDocument::Compact));</a>
<a name="ln8053">            file.close();</a>
<a name="ln8054">      }</a>
<a name="ln8055"> </a>
<a name="ln8056">      delete score;</a>
<a name="ln8057">      return res;</a>
<a name="ln8058">      }</a>
<a name="ln8059"> </a>
<a name="ln8060">//---------------------------------------------------------</a>
<a name="ln8061">//   getQmlEngine</a>
<a name="ln8062">//---------------------------------------------------------</a>
<a name="ln8063"> </a>
<a name="ln8064">MsQmlEngine* MuseScore::getQmlUiEngine()</a>
<a name="ln8065">      {</a>
<a name="ln8066">      if (!_qmlUiEngine)</a>
<a name="ln8067">            _qmlUiEngine = new MsQmlEngine(this);</a>
<a name="ln8068">      return _qmlUiEngine;</a>
<a name="ln8069">      }</a>
<a name="ln8070"> </a>
<a name="ln8071">//---------------------------------------------------------</a>
<a name="ln8072">//   getPluginEngine</a>
<a name="ln8073">//---------------------------------------------------------</a>
<a name="ln8074"> </a>
<a name="ln8075">#ifdef SCRIPT_INTERFACE</a>
<a name="ln8076">QmlPluginEngine* MuseScore::getPluginEngine()</a>
<a name="ln8077">      {</a>
<a name="ln8078">      if (!_qmlEngine)</a>
<a name="ln8079">            _qmlEngine = new QmlPluginEngine(this);</a>
<a name="ln8080">      return _qmlEngine;</a>
<a name="ln8081">      }</a>
<a name="ln8082">#endif</a>
<a name="ln8083"> </a>
<a name="ln8084">//---------------------------------------------------------</a>
<a name="ln8085">//   scoreUnrolled</a>
<a name="ln8086">//    create a version of the given score with repeats unrolled</a>
<a name="ln8087">//---------------------------------------------------------</a>
<a name="ln8088"> </a>
<a name="ln8089">void MuseScore::scoreUnrolled(MasterScore * original)</a>
<a name="ln8090">      {</a>
<a name="ln8091">      MasterScore * score = original-&gt;unrollRepeats();</a>
<a name="ln8092">      setCurrentScoreView(appendScore(score));</a>
<a name="ln8093">      }</a>
<a name="ln8094">} // namespace Ms</a>

</code></pre>
<div class="balloon" rel="473"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v668/" target="_blank">V668</a> There is no sense in testing the 'pm' pointer against null, as the memory was allocated using the 'new' operator. The exception will be generated in the case of memory allocation error.</p></div>
<div class="balloon" rel="474"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="493"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v668/" target="_blank">V668</a> There is no sense in testing the 'pm' pointer against null, as the memory was allocated using the 'new' operator. The exception will be generated in the case of memory allocation error.</p></div>
<div class="balloon" rel="494"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="697"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1001/" target="_blank">V1001</a> The 'newerVersion' variable is assigned but is not used by the end of the function.</p></div>
<div class="balloon" rel="702"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression '!newerVersion' is always true.</p></div>
<div class="balloon" rel="2209"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="3354"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="3364"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="3382"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="3386"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="3390"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="3412"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="4219"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="4960"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="5056"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="5072"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="5136"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="5488"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="5502"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="5507"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="5508"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="5785"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="5789"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="5803"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'paletteWidget' pointer was utilized before it was verified against nullptr. Check lines: 5803, 5813.</p></div>
<div class="balloon" rel="6405"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="6438"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression '_timeline' is always true.</p></div>
<div class="balloon" rel="6924"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1048/" target="_blank">V1048</a> The 'MScore::sampleRate' variable was assigned the same value.</p></div>
<div class="balloon" rel="6953"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'bufferOut' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="7677"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="7801"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="8020"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'excerptCmdFake' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
