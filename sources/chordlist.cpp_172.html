
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>chordlist.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2011 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;config.h&quot;</a>
<a name="ln14">#include &quot;chordlist.h&quot;</a>
<a name="ln15">#include &quot;score.h&quot;</a>
<a name="ln16">#include &quot;xml.h&quot;</a>
<a name="ln17">#include &quot;pitchspelling.h&quot;</a>
<a name="ln18">#include &quot;mscore.h&quot;</a>
<a name="ln19"> </a>
<a name="ln20">namespace Ms {</a>
<a name="ln21"> </a>
<a name="ln22">//---------------------------------------------------------</a>
<a name="ln23">//   HChord</a>
<a name="ln24">//---------------------------------------------------------</a>
<a name="ln25"> </a>
<a name="ln26">HChord::HChord(const QString&amp; str)</a>
<a name="ln27">      {</a>
<a name="ln28">      static const char* const scaleNames[2][12] = {</a>
<a name="ln29">            { &quot;C&quot;, &quot;C#&quot;, &quot;D&quot;, &quot;D#&quot;, &quot;E&quot;, &quot;F&quot;, &quot;F#&quot;, &quot;G&quot;, &quot;G#&quot;, &quot;A&quot;, &quot;A#&quot;, &quot;B&quot; },</a>
<a name="ln30">            { &quot;C&quot;, &quot;Db&quot;, &quot;D&quot;, &quot;Eb&quot;, &quot;E&quot;, &quot;F&quot;, &quot;Gb&quot;, &quot;G&quot;, &quot;Ab&quot;, &quot;A&quot;, &quot;Bb&quot;, &quot;B&quot; }</a>
<a name="ln31">            };</a>
<a name="ln32">      keys = 0;</a>
<a name="ln33">      QStringList sl = str.split(&quot; &quot;, QString::SkipEmptyParts);</a>
<a name="ln34">      foreach(const QString&amp; s, sl) {</a>
<a name="ln35">            for (int i = 0; i &lt; 12; ++i) {</a>
<a name="ln36">                  if (s == scaleNames[0][i] || s == scaleNames[1][i]) {</a>
<a name="ln37">                        operator+=(i);</a>
<a name="ln38">                        break;</a>
<a name="ln39">                        }</a>
<a name="ln40">                  }</a>
<a name="ln41">            }</a>
<a name="ln42">      }</a>
<a name="ln43"> </a>
<a name="ln44">//---------------------------------------------------------</a>
<a name="ln45">//   HChord</a>
<a name="ln46">//---------------------------------------------------------</a>
<a name="ln47"> </a>
<a name="ln48">HChord::HChord(int a, int b, int c, int d, int e, int f, int g, int h, int i, int k, int l)</a>
<a name="ln49">      {</a>
<a name="ln50">      keys = 0;</a>
<a name="ln51">      if (a &gt;= 0)</a>
<a name="ln52">            operator+=(a);</a>
<a name="ln53">      if (b &gt;= 0)</a>
<a name="ln54">            operator+=(b);</a>
<a name="ln55">      if (c &gt;= 0)</a>
<a name="ln56">            operator+=(c);</a>
<a name="ln57">      if (d &gt;= 0)</a>
<a name="ln58">            operator+=(d);</a>
<a name="ln59">      if (e &gt;= 0)</a>
<a name="ln60">            operator+=(e);</a>
<a name="ln61">      if (f &gt;= 0)</a>
<a name="ln62">            operator+=(f);</a>
<a name="ln63">      if (g &gt;= 0)</a>
<a name="ln64">            operator+=(g);</a>
<a name="ln65">      if (h &gt;= 0)</a>
<a name="ln66">            operator+=(h);</a>
<a name="ln67">      if (i &gt;= 0)</a>
<a name="ln68">            operator+=(i);</a>
<a name="ln69">      if (k &gt;= 0)</a>
<a name="ln70">            operator+=(k);</a>
<a name="ln71">      if (l &gt;= 0)</a>
<a name="ln72">            operator+=(l);</a>
<a name="ln73">      }</a>
<a name="ln74"> </a>
<a name="ln75">//---------------------------------------------------------</a>
<a name="ln76">//   rotate</a>
<a name="ln77">//    rotate 12 Bits</a>
<a name="ln78">//---------------------------------------------------------</a>
<a name="ln79"> </a>
<a name="ln80">void HChord::rotate(int semiTones)</a>
<a name="ln81">      {</a>
<a name="ln82">      while (semiTones &gt; 0) {</a>
<a name="ln83">            if (keys &amp; 0x800)</a>
<a name="ln84">                  keys = ((keys &amp; ~0x800) &lt;&lt; 1) + 1;</a>
<a name="ln85">            else</a>
<a name="ln86">                  keys &lt;&lt;= 1;</a>
<a name="ln87">            --semiTones;</a>
<a name="ln88">            }</a>
<a name="ln89">      while (semiTones &lt; 0) {</a>
<a name="ln90">            if (keys &amp; 1)</a>
<a name="ln91">                  keys = (keys &gt;&gt; 1) | 0x800;</a>
<a name="ln92">            else</a>
<a name="ln93">                  keys &gt;&gt;= 1;</a>
<a name="ln94">            ++semiTones;</a>
<a name="ln95">            }</a>
<a name="ln96">      }</a>
<a name="ln97"> </a>
<a name="ln98">//---------------------------------------------------------</a>
<a name="ln99">//   name</a>
<a name="ln100">//---------------------------------------------------------</a>
<a name="ln101"> </a>
<a name="ln102">QString HChord::name(int tpc) const</a>
<a name="ln103">      {</a>
<a name="ln104">      static const HChord C0(0,3,6,9);</a>
<a name="ln105">      static const HChord C1(0,3);</a>
<a name="ln106"> </a>
<a name="ln107">      QString buf = tpc2name(tpc, NoteSpellingType::STANDARD, NoteCaseType::AUTO, false);</a>
<a name="ln108">      HChord c(*this);</a>
<a name="ln109"> </a>
<a name="ln110">      int key = tpc2pitch(tpc);</a>
<a name="ln111"> </a>
<a name="ln112">      c.rotate(-key);        // transpose to C</a>
<a name="ln113"> </a>
<a name="ln114">      // special cases</a>
<a name="ln115">      if (c == C0) {</a>
<a name="ln116">            buf += &quot;dim&quot;;</a>
<a name="ln117">            return buf;</a>
<a name="ln118">            }</a>
<a name="ln119">      if (c == C1) {</a>
<a name="ln120">            buf += &quot;no5&quot;;</a>
<a name="ln121">            return buf;</a>
<a name="ln122">            }</a>
<a name="ln123"> </a>
<a name="ln124">      bool seven   = false;</a>
<a name="ln125">      bool sharp9  = false;</a>
<a name="ln126">      bool nat11   = false;</a>
<a name="ln127">      bool sharp11 = false;</a>
<a name="ln128">      bool nat13   = false;</a>
<a name="ln129">      bool flat13  = false;</a>
<a name="ln130"> </a>
<a name="ln131">      // minor?</a>
<a name="ln132">      if (c.contains(3)) {</a>
<a name="ln133">            if (!c.contains(4))</a>
<a name="ln134">                  buf += &quot;m&quot;;</a>
<a name="ln135">            else</a>
<a name="ln136">                  sharp9 = true;</a>
<a name="ln137">            }</a>
<a name="ln138"> </a>
<a name="ln139">      // 7</a>
<a name="ln140">      if (c.contains(11)) {</a>
<a name="ln141">            buf += &quot;Maj7&quot;;</a>
<a name="ln142">            seven = true;</a>
<a name="ln143">            }</a>
<a name="ln144">      else if (c.contains(10)) {</a>
<a name="ln145">            buf += &quot;7&quot;;</a>
<a name="ln146">            seven = true;</a>
<a name="ln147">            }</a>
<a name="ln148"> </a>
<a name="ln149">      // 4</a>
<a name="ln150">      if (c.contains(5)) {</a>
<a name="ln151">            if (!c.contains(4)) {</a>
<a name="ln152">                  buf += &quot;sus4&quot;;</a>
<a name="ln153">                  }</a>
<a name="ln154">            else</a>
<a name="ln155">                  nat11 = true;</a>
<a name="ln156">            }</a>
<a name="ln157"> </a>
<a name="ln158">      // 5</a>
<a name="ln159">      if (c.contains(7)) {</a>
<a name="ln160">            if (c.contains(6))</a>
<a name="ln161">                  sharp11 = true;</a>
<a name="ln162">            if (c.contains(8))</a>
<a name="ln163">                  flat13 = true;</a>
<a name="ln164">            }</a>
<a name="ln165">      else {</a>
<a name="ln166">            if (c.contains(6))</a>
<a name="ln167">                  buf += &quot;b5&quot;;</a>
<a name="ln168">            if (c.contains(8))</a>
<a name="ln169">                  buf += &quot;#5&quot;;</a>
<a name="ln170">            }</a>
<a name="ln171"> </a>
<a name="ln172">      // 6</a>
<a name="ln173">      if (c.contains(9)) {</a>
<a name="ln174">            if (!seven)</a>
<a name="ln175">                  buf += &quot;6&quot;;</a>
<a name="ln176">            else</a>
<a name="ln177">                  nat13 = true;</a>
<a name="ln178">            }</a>
<a name="ln179"> </a>
<a name="ln180">      // 9</a>
<a name="ln181">      if (c.contains(1))</a>
<a name="ln182">            buf += &quot;b9&quot;;</a>
<a name="ln183">      if (c.contains(2))</a>
<a name="ln184">            buf += &quot;9&quot;;</a>
<a name="ln185">      if (sharp9)</a>
<a name="ln186">            buf += &quot;#9&quot;;</a>
<a name="ln187"> </a>
<a name="ln188">      // 11</a>
<a name="ln189">      if (nat11)</a>
<a name="ln190">            buf += &quot;11 &quot;;</a>
<a name="ln191">      if (sharp11)</a>
<a name="ln192">            buf += &quot;#11&quot;;</a>
<a name="ln193"> </a>
<a name="ln194">      // 13</a>
<a name="ln195">      if (flat13)</a>
<a name="ln196">            buf += &quot;b13&quot;;</a>
<a name="ln197">      if (nat13) {</a>
<a name="ln198">            if (c.contains(1) || c.contains(2) || sharp9 || nat11 || sharp11)</a>
<a name="ln199">                  buf += &quot;13&quot;;</a>
<a name="ln200">            else</a>
<a name="ln201">                  buf += &quot;add13&quot;;</a>
<a name="ln202">            }</a>
<a name="ln203">      return buf;</a>
<a name="ln204">      }</a>
<a name="ln205"> </a>
<a name="ln206">//---------------------------------------------------------</a>
<a name="ln207">//   voicing</a>
<a name="ln208">//---------------------------------------------------------</a>
<a name="ln209"> </a>
<a name="ln210">QString HChord::voicing() const</a>
<a name="ln211">      {</a>
<a name="ln212">      QString s = &quot;C&quot;;</a>
<a name="ln213">      const char* names[] = { &quot;C&quot;, &quot; Db&quot;, &quot; D&quot;, &quot; Eb&quot;, &quot; E&quot;, &quot; F&quot;, &quot; Gb&quot;, &quot; G&quot;, &quot; Ab&quot;, &quot; A&quot;, &quot; Bb&quot;, &quot; B&quot; };</a>
<a name="ln214"> </a>
<a name="ln215">      for (int i = 1; i &lt; 12; i++) {</a>
<a name="ln216">            if (contains(i))</a>
<a name="ln217">                  s += names[i];</a>
<a name="ln218">            }</a>
<a name="ln219">      return s;</a>
<a name="ln220">      }</a>
<a name="ln221"> </a>
<a name="ln222"> </a>
<a name="ln223">//---------------------------------------------------------</a>
<a name="ln224">//   print</a>
<a name="ln225">//---------------------------------------------------------</a>
<a name="ln226"> </a>
<a name="ln227">void HChord::print() const</a>
<a name="ln228">      {</a>
<a name="ln229">      const char* names[] = { &quot;C&quot;, &quot;Db&quot;, &quot;D&quot;, &quot;Eb&quot;, &quot;E&quot;, &quot;F&quot;, &quot;Gb&quot;, &quot;G&quot;, &quot;Ab&quot;, &quot;A&quot;, &quot;Bb&quot;, &quot;B&quot; };</a>
<a name="ln230"> </a>
<a name="ln231">      for (int i = 0; i &lt; 12; i++) {</a>
<a name="ln232">            if (contains(i))</a>
<a name="ln233">                  qDebug(&quot; %s&quot;, names[i]);</a>
<a name="ln234">            }</a>
<a name="ln235">      }</a>
<a name="ln236"> </a>
<a name="ln237">//---------------------------------------------------------</a>
<a name="ln238">//   add</a>
<a name="ln239">//---------------------------------------------------------</a>
<a name="ln240"> </a>
<a name="ln241">void HChord::add(const QList&lt;HDegree&gt;&amp; degreeList)</a>
<a name="ln242">      {</a>
<a name="ln243">// qDebug(&quot;HChord::add   &quot;);print();</a>
<a name="ln244">      // convert degrees to semitones</a>
<a name="ln245">      static const int degreeTable[] = {</a>
<a name="ln246">            // 1  2  3  4  5  6   7</a>
<a name="ln247">            // C  D  E  F  G  A   B</a>
<a name="ln248">               0, 2, 4, 5, 7, 9, 11</a>
<a name="ln249">            };</a>
<a name="ln250">      // factor in the degrees</a>
<a name="ln251">      foreach(const HDegree&amp; d, degreeList) {</a>
<a name="ln252">            int dv  = degreeTable[(d.value() - 1) % 7] + d.alter();</a>
<a name="ln253">            int dv1 = degreeTable[(d.value() - 1) % 7];</a>
<a name="ln254"> </a>
<a name="ln255">            if (d.value() == 7 &amp;&amp; d.alter() == 0) {</a>
<a name="ln256">                  // DEBUG: seventh degree is Bb, not B</a>
<a name="ln257">                  //        except Maj   (TODO)</a>
<a name="ln258">                  dv -= 1;</a>
<a name="ln259">                  }</a>
<a name="ln260"> </a>
<a name="ln261">            if (d.type() == HDegreeType::ADD)</a>
<a name="ln262">                  *this += dv;</a>
<a name="ln263">            else if (d.type() == HDegreeType::ALTER) {</a>
<a name="ln264">                  if (contains(dv1)) {</a>
<a name="ln265">                        *this -= dv1;</a>
<a name="ln266">                        *this += dv;</a>
<a name="ln267">                        }</a>
<a name="ln268">                  else {</a>
<a name="ln269">//                        qDebug(&quot;HDegreeType::ALTER: chord does not contain degree %d(%d):&quot;,</a>
<a name="ln270">//                           d.value(), d.alter());</a>
<a name="ln271">//                        print();</a>
<a name="ln272">                        *this += dv;      // DEBUG: default to add</a>
<a name="ln273">                        }</a>
<a name="ln274">                  }</a>
<a name="ln275">            else if (d.type() == HDegreeType::SUBTRACT) {</a>
<a name="ln276">                  if (contains(dv1))</a>
<a name="ln277">                        *this -= dv1;</a>
<a name="ln278">                  else {</a>
<a name="ln279">                        qDebug(&quot;SUB: chord does not contain degree %d(%d):&quot;,</a>
<a name="ln280">                           d.value(), d.alter());</a>
<a name="ln281">                        }</a>
<a name="ln282">                  }</a>
<a name="ln283">            else</a>
<a name="ln284">                  qDebug(&quot;degree type %d not supported&quot;, static_cast&lt;int&gt;(d.type()));</a>
<a name="ln285"> </a>
<a name="ln286">// qDebug(&quot;  HCHord::added  &quot;); print();</a>
<a name="ln287">            }</a>
<a name="ln288">      }</a>
<a name="ln289"> </a>
<a name="ln290">//---------------------------------------------------------</a>
<a name="ln291">//   readRenderList</a>
<a name="ln292">//---------------------------------------------------------</a>
<a name="ln293"> </a>
<a name="ln294">static void readRenderList(QString val, QList&lt;RenderAction&gt;&amp; renderList)</a>
<a name="ln295">      {</a>
<a name="ln296">      renderList.clear();</a>
<a name="ln297">      QStringList sl = val.split(&quot; &quot;, QString::SkipEmptyParts);</a>
<a name="ln298">      for (const QString&amp; s : sl) {</a>
<a name="ln299">            if (s.startsWith(&quot;m:&quot;)) {</a>
<a name="ln300">                  QStringList ssl = s.split(&quot;:&quot;, QString::SkipEmptyParts);</a>
<a name="ln301">                  if (ssl.size() == 3) {</a>
<a name="ln302">                        // m:x:y</a>
<a name="ln303">                        RenderAction a;</a>
<a name="ln304">                        a.type = RenderAction::RenderActionType::MOVE;</a>
<a name="ln305">                        a.movex = ssl[1].toDouble();</a>
<a name="ln306">                        a.movey = ssl[2].toDouble();</a>
<a name="ln307">                        renderList.append(a);</a>
<a name="ln308">                        }</a>
<a name="ln309">#if 0</a>
<a name="ln310">                  else if (ssl.size() == 2) {</a>
<a name="ln311">                        // m:keyword</a>
<a name="ln312">                        RenderAction a;</a>
<a name="ln313">                        a.type = RenderAction::RenderActionType::MOVE;</a>
<a name="ln314">                        // TODO: derive offset from keyword</a>
<a name="ln315">                        }</a>
<a name="ln316">#endif</a>
<a name="ln317">                  }</a>
<a name="ln318">            else if (s == &quot;:push&quot;)</a>
<a name="ln319">                  renderList.append(RenderAction(RenderAction::RenderActionType::PUSH));</a>
<a name="ln320">            else if (s == &quot;:pop&quot;)</a>
<a name="ln321">                  renderList.append(RenderAction(RenderAction::RenderActionType::POP));</a>
<a name="ln322">            else if (s == &quot;:n&quot;)</a>
<a name="ln323">                  renderList.append(RenderAction(RenderAction::RenderActionType::NOTE));</a>
<a name="ln324">            else if (s == &quot;:a&quot;)</a>
<a name="ln325">                  renderList.append(RenderAction(RenderAction::RenderActionType::ACCIDENTAL));</a>
<a name="ln326">            else {</a>
<a name="ln327">                  RenderAction a(RenderAction::RenderActionType::SET);</a>
<a name="ln328">                  a.text = s;</a>
<a name="ln329">                  renderList.append(a);</a>
<a name="ln330">                  }</a>
<a name="ln331">            }</a>
<a name="ln332">      }</a>
<a name="ln333"> </a>
<a name="ln334">//---------------------------------------------------------</a>
<a name="ln335">//   writeRenderList</a>
<a name="ln336">//---------------------------------------------------------</a>
<a name="ln337"> </a>
<a name="ln338">static void writeRenderList(XmlWriter&amp; xml, const QList&lt;RenderAction&gt;* al, const QString&amp; name)</a>
<a name="ln339">      {</a>
<a name="ln340">      QString s;</a>
<a name="ln341"> </a>
<a name="ln342">      int n = al-&gt;size();</a>
<a name="ln343">      for (int i = 0; i &lt; n; ++i) {</a>
<a name="ln344">            if (!s.isEmpty())</a>
<a name="ln345">                  s += &quot; &quot;;</a>
<a name="ln346">            const RenderAction&amp; a = (*al)[i];</a>
<a name="ln347">            switch(a.type) {</a>
<a name="ln348">                  case RenderAction::RenderActionType::SET:</a>
<a name="ln349">                        s += a.text;</a>
<a name="ln350">                        break;</a>
<a name="ln351">                  case RenderAction::RenderActionType::MOVE:</a>
<a name="ln352">                        if (a.movex != 0.0 || a.movey != 0.0)</a>
<a name="ln353">                              s += QString(&quot;m:%1:%2&quot;).arg(a.movex).arg(a.movey);</a>
<a name="ln354">                        break;</a>
<a name="ln355">                  case RenderAction::RenderActionType::PUSH:</a>
<a name="ln356">                        s += &quot;:push&quot;;</a>
<a name="ln357">                        break;</a>
<a name="ln358">                  case RenderAction::RenderActionType::POP:</a>
<a name="ln359">                        s += &quot;:pop&quot;;</a>
<a name="ln360">                        break;</a>
<a name="ln361">                  case RenderAction::RenderActionType::NOTE:</a>
<a name="ln362">                        s += &quot;:n&quot;;</a>
<a name="ln363">                        break;</a>
<a name="ln364">                  case RenderAction::RenderActionType::ACCIDENTAL:</a>
<a name="ln365">                        s += &quot;:a&quot;;</a>
<a name="ln366">                        break;</a>
<a name="ln367">                  }</a>
<a name="ln368">            }</a>
<a name="ln369">      xml.tag(name, s);</a>
<a name="ln370">      }</a>
<a name="ln371"> </a>
<a name="ln372">//---------------------------------------------------------</a>
<a name="ln373">//  read</a>
<a name="ln374">//---------------------------------------------------------</a>
<a name="ln375"> </a>
<a name="ln376">void ChordToken::read(XmlReader&amp; e)</a>
<a name="ln377">      {</a>
<a name="ln378">      QString c = e.attribute(&quot;class&quot;);</a>
<a name="ln379">      if (c == &quot;quality&quot;)</a>
<a name="ln380">            tokenClass = ChordTokenClass::QUALITY;</a>
<a name="ln381">      else if (c == &quot;extension&quot;)</a>
<a name="ln382">            tokenClass = ChordTokenClass::EXTENSION;</a>
<a name="ln383">      else if (c == &quot;modifier&quot;)</a>
<a name="ln384">            tokenClass = ChordTokenClass::MODIFIER;</a>
<a name="ln385">      else</a>
<a name="ln386">            tokenClass = ChordTokenClass::ALL;</a>
<a name="ln387">      while (e.readNextStartElement()) {</a>
<a name="ln388">            const QStringRef&amp; tag(e.name());</a>
<a name="ln389">            if (tag == &quot;name&quot;)</a>
<a name="ln390">                  names += e.readElementText();</a>
<a name="ln391">            else if (tag == &quot;render&quot;)</a>
<a name="ln392">                  readRenderList(e.readElementText(), renderList);</a>
<a name="ln393">            }</a>
<a name="ln394">      }</a>
<a name="ln395"> </a>
<a name="ln396">//---------------------------------------------------------</a>
<a name="ln397">//  write</a>
<a name="ln398">//---------------------------------------------------------</a>
<a name="ln399"> </a>
<a name="ln400">void ChordToken::write(XmlWriter&amp; xml) const</a>
<a name="ln401">      {</a>
<a name="ln402">      QString t = &quot;token&quot;;</a>
<a name="ln403">      switch (tokenClass) {</a>
<a name="ln404">            case ChordTokenClass::QUALITY:</a>
<a name="ln405">                  t += &quot; class=\&quot;quality\&quot;&quot;;</a>
<a name="ln406">                  break;</a>
<a name="ln407">            case ChordTokenClass::EXTENSION:</a>
<a name="ln408">                  t += &quot; class=\&quot;extension\&quot;&quot;;</a>
<a name="ln409">                  break;</a>
<a name="ln410">            case ChordTokenClass::MODIFIER:</a>
<a name="ln411">                  t += &quot; class=\&quot;modifier\&quot;&quot;;</a>
<a name="ln412">                  break;</a>
<a name="ln413">            default:</a>
<a name="ln414">                  break;</a>
<a name="ln415">      }</a>
<a name="ln416">      xml.stag(t);</a>
<a name="ln417">      foreach(const QString&amp; s, names)</a>
<a name="ln418">            xml.tag(&quot;name&quot;, s);</a>
<a name="ln419">      writeRenderList(xml, &amp;renderList, &quot;render&quot;);</a>
<a name="ln420">      xml.etag();</a>
<a name="ln421">      }</a>
<a name="ln422"> </a>
<a name="ln423">//---------------------------------------------------------</a>
<a name="ln424">//  ParsedChord</a>
<a name="ln425">//---------------------------------------------------------</a>
<a name="ln426"> </a>
<a name="ln427">ParsedChord::ParsedChord()</a>
<a name="ln428">      {</a>
<a name="ln429">      _parseable = false;</a>
<a name="ln430">      _understandable = false;</a>
<a name="ln431">      }</a>
<a name="ln432"> </a>
<a name="ln433">//---------------------------------------------------------</a>
<a name="ln434">//  configure</a>
<a name="ln435">//---------------------------------------------------------</a>
<a name="ln436"> </a>
<a name="ln437">void ParsedChord::configure(const ChordList* cl)</a>
<a name="ln438">      {</a>
<a name="ln439">      if (!cl)</a>
<a name="ln440">            return;</a>
<a name="ln441">      // TODO: allow this to be parameterized via chord list</a>
<a name="ln442">      major &lt;&lt; &quot;ma&quot; &lt;&lt; &quot;maj&quot; &lt;&lt; &quot;major&quot; &lt;&lt; &quot;t&quot; &lt;&lt; &quot;^&quot;;</a>
<a name="ln443">      minor &lt;&lt; &quot;mi&quot; &lt;&lt; &quot;min&quot; &lt;&lt; &quot;minor&quot; &lt;&lt; &quot;-&quot; &lt;&lt; &quot;=&quot;;</a>
<a name="ln444">      diminished &lt;&lt; &quot;dim&quot; &lt;&lt; &quot;o&quot;;</a>
<a name="ln445">      augmented &lt;&lt; &quot;aug&quot; &lt;&lt; &quot;+&quot;;</a>
<a name="ln446">      lower &lt;&lt; &quot;b&quot; &lt;&lt; &quot;-&quot; &lt;&lt; &quot;dim&quot;;</a>
<a name="ln447">      raise &lt;&lt; &quot;#&quot; &lt;&lt; &quot;+&quot; &lt;&lt; &quot;aug&quot;;</a>
<a name="ln448">      mod1 &lt;&lt; &quot;sus&quot; &lt;&lt; &quot;alt&quot;;</a>
<a name="ln449">      mod2 &lt;&lt; &quot;sus&quot; &lt;&lt; &quot;add&quot; &lt;&lt; &quot;no&quot; &lt;&lt; &quot;omit&quot; &lt;&lt; &quot;^&quot;;</a>
<a name="ln450">      symbols &lt;&lt; &quot;t&quot; &lt;&lt; &quot;^&quot; &lt;&lt; &quot;-&quot; &lt;&lt; &quot;+&quot; &lt;&lt; &quot;o&quot; &lt;&lt; &quot;0&quot;;</a>
<a name="ln451">      }</a>
<a name="ln452"> </a>
<a name="ln453">//---------------------------------------------------------</a>
<a name="ln454">//  correctXmlText</a>
<a name="ln455">//    remove digits from _xmlText, optionally replace with s</a>
<a name="ln456">//    needed for m(Maj9) et al</a>
<a name="ln457">//---------------------------------------------------------</a>
<a name="ln458"> </a>
<a name="ln459">void ParsedChord::correctXmlText(const QString&amp; s)</a>
<a name="ln460">      {</a>
<a name="ln461">      _xmlText.remove(QRegExp(&quot;[0-9]&quot;));</a>
<a name="ln462">      if (s != &quot;&quot;) {</a>
<a name="ln463">            int pos = _xmlText.lastIndexOf(')');</a>
<a name="ln464">            if (pos == -1)</a>
<a name="ln465">                  pos = _xmlText.size();</a>
<a name="ln466">            _xmlText.insert(pos,s);</a>
<a name="ln467">            }</a>
<a name="ln468">      }</a>
<a name="ln469"> </a>
<a name="ln470">//---------------------------------------------------------</a>
<a name="ln471">//  parse</a>
<a name="ln472">//    returns true if chord was parseable</a>
<a name="ln473">//---------------------------------------------------------</a>
<a name="ln474"> </a>
<a name="ln475">bool ParsedChord::parse(const QString&amp; s, const ChordList* cl, bool syntaxOnly, bool preferMinor)</a>
<a name="ln476">      {</a>
<a name="ln477">      QString tok1, tok1L, tok2, tok2L;</a>
<a name="ln478">      QString extensionDigits = &quot;123456789&quot;;</a>
<a name="ln479">      QString special = &quot;()[],/\\ &quot;;</a>
<a name="ln480">      QString leading = &quot;([ &quot;;</a>
<a name="ln481">      QString trailing = &quot;)],/\\ &quot;;</a>
<a name="ln482">      QString initial;</a>
<a name="ln483">      bool take6 = false, take7 = false, take9 = false, take11 = false, take13 = false;</a>
<a name="ln484">#if 0</a>
<a name="ln485">// enable this to allow quality or extension to be parenthesized</a>
<a name="ln486">      int firstLeadingToken;</a>
<a name="ln487">#endif</a>
<a name="ln488">      int lastLeadingToken;</a>
<a name="ln489">      int len = s.size();</a>
<a name="ln490">      int i, j;</a>
<a name="ln491">      int thirdKey = 0, seventhKey = 0;</a>
<a name="ln492">      bool susChord = false;</a>
<a name="ln493">      QList&lt;HDegree&gt; hdl;</a>
<a name="ln494">      int key[] = { 0, 0, 2, 4, 5, 7, 9, 11, 0, 2, 4, 5, 7, 9, 11 };</a>
<a name="ln495"> </a>
<a name="ln496">      configure(cl);</a>
<a name="ln497">      _name = s;</a>
<a name="ln498">      _parseable = true;</a>
<a name="ln499">      _understandable = true;</a>
<a name="ln500">      i = 0;</a>
<a name="ln501"> </a>
<a name="ln502">#if 0</a>
<a name="ln503">// enable this code to allow quality to be parenthesized</a>
<a name="ln504">// otherwise, parentheses will automatically cause contents to be interpreted as extension or modifier</a>
<a name="ln505">      // eat leading parens</a>
<a name="ln506">      firstLeadingToken = _tokenList.size();</a>
<a name="ln507">      while (i &lt; len &amp;&amp; leading.contains(s[i]))</a>
<a name="ln508">           addToken(QString(s[i++]),ChordTokenClass::QUALITY);</a>
<a name="ln509">#endif</a>
<a name="ln510">      lastLeadingToken = _tokenList.size();</a>
<a name="ln511">      // get quality</a>
<a name="ln512">      for (j = 0, tok1 = &quot;&quot;, tok1L = &quot;&quot;, initial = &quot;&quot;; i &lt; len; ++i, ++j) {</a>
<a name="ln513">            // up to first (non-zero) digit, paren, or comma</a>
<a name="ln514">            if (extensionDigits.contains(s[i]) || special.contains(s[i]))</a>
<a name="ln515">                  break;</a>
<a name="ln516">            tok1[j] = s[i];</a>
<a name="ln517">            tok1L[j] = s[i].toLower();</a>
<a name="ln518">            if (tok1L == &quot;m&quot; || major.contains(tok1L) || minor.contains(tok1L) || diminished.contains(tok1L) || augmented.contains(tok1L))</a>
<a name="ln519">                  initial = tok1;</a>
<a name="ln520">            }</a>
<a name="ln521">      // special case for &quot;madd&quot;, which needs to parse as m,add rather than ma,dd</a>
<a name="ln522">      if (tok1L.startsWith(&quot;madd&quot;))</a>
<a name="ln523">            initial = tok1[0];</a>
<a name="ln524">      // quality and first modifier ran together with no separation - eg, mima7, augadd</a>
<a name="ln525">      // keep quality portion, reset index to read modifier portion later</a>
<a name="ln526">      if (initial != &quot;&quot; &amp;&amp; initial != tok1 &amp;&amp; tok1L != &quot;tristan&quot; &amp;&amp; tok1L != &quot;omit&quot;) {</a>
<a name="ln527">            i -= (tok1.length() - initial.length());</a>
<a name="ln528">            tok1 = initial;</a>
<a name="ln529">            tok1L = initial.toLower();</a>
<a name="ln530">            }</a>
<a name="ln531">      // determine quality</a>
<a name="ln532">      if (tok1 == &quot;M&quot; || major.contains(tok1L)) {</a>
<a name="ln533">            _quality = &quot;major&quot;;</a>
<a name="ln534">            take6 = true; take7 = true; take9 = true; take11 = true; take13 = true;</a>
<a name="ln535">            if (!syntaxOnly)</a>
<a name="ln536">                  chord = HChord(&quot;C E G&quot;);</a>
<a name="ln537">            }</a>
<a name="ln538">      else if (tok1 == &quot;m&quot; || minor.contains(tok1L)) {</a>
<a name="ln539">            _quality = &quot;minor&quot;;</a>
<a name="ln540">            take6 = true; take7 = true; take9 = true; take11 = true; take13 = true;</a>
<a name="ln541">            if (!syntaxOnly)</a>
<a name="ln542">                  chord = HChord(&quot;C Eb G&quot;);</a>
<a name="ln543">            }</a>
<a name="ln544">      else if (diminished.contains(tok1L)) {</a>
<a name="ln545">            _quality = &quot;diminished&quot;;</a>
<a name="ln546">            take7 = true;</a>
<a name="ln547">            if (!syntaxOnly)</a>
<a name="ln548">                  chord = HChord(&quot;C Eb Gb&quot;);</a>
<a name="ln549">            }</a>
<a name="ln550">      else if (augmented.contains(tok1L)) {</a>
<a name="ln551">            _quality = &quot;augmented&quot;;</a>
<a name="ln552">            take7 = true;</a>
<a name="ln553">            if (!syntaxOnly)</a>
<a name="ln554">                  chord = HChord(&quot;C E G#&quot;);</a>
<a name="ln555">            }</a>
<a name="ln556">      else if (tok1L == &quot;0&quot;) {</a>
<a name="ln557">            _quality = &quot;half-diminished&quot;;</a>
<a name="ln558">            if (!syntaxOnly)</a>
<a name="ln559">                  chord = HChord(&quot;C Eb Gb Bb&quot;);</a>
<a name="ln560">            }</a>
<a name="ln561">      else if (tok1L == &quot;&quot;) {</a>
<a name="ln562">            // empty quality - this will turn out to be major or dominant (or minor if preferMinor)</a>
<a name="ln563">            _quality = &quot;&quot;;</a>
<a name="ln564">            if (!syntaxOnly)</a>
<a name="ln565">                  chord = preferMinor ? HChord(&quot;C Eb G&quot;) : HChord(&quot;C E G&quot;);</a>
<a name="ln566">            if (preferMinor)</a>
<a name="ln567">                  _name = &quot;=&quot; + _name;</a>
<a name="ln568">            }</a>
<a name="ln569">      else {</a>
<a name="ln570">            // anything else is not a quality after all, but a modifier</a>
<a name="ln571">            // reset to read again as modifier</a>
<a name="ln572">            _quality = &quot;&quot;;</a>
<a name="ln573">            tok1 = &quot;&quot;;</a>
<a name="ln574">            tok1L = &quot;&quot;;</a>
<a name="ln575">            i = lastLeadingToken;</a>
<a name="ln576">            if (!syntaxOnly)</a>
<a name="ln577">                  chord = HChord(&quot;C E G&quot;);</a>
<a name="ln578">            }</a>
<a name="ln579">      if (tok1L == &quot;=&quot;) {</a>
<a name="ln580">            tok1 = &quot;&quot;;</a>
<a name="ln581">            tok1L = &quot;&quot;;</a>
<a name="ln582">            }</a>
<a name="ln583">      if (tok1 != &quot;&quot;)</a>
<a name="ln584">            addToken(tok1,ChordTokenClass::QUALITY);</a>
<a name="ln585">#if 0</a>
<a name="ln586">// enable this code to allow quality to be parenthesized</a>
<a name="ln587">// otherwise, parentheses will automatically cause contents to be interpreted as extension or modifier</a>
<a name="ln588">      else {</a>
<a name="ln589">            // leading tokens were not really ChordTokenClass::QUALITY</a>
<a name="ln590">            for (int t = firstLeadingToken; t &lt; lastLeadingToken; ++t)</a>
<a name="ln591">                  _tokenList[t].tokenClass = ChordTokenClass::EXTENSION;</a>
<a name="ln592">            }</a>
<a name="ln593">#endif</a>
<a name="ln594">      if (!syntaxOnly) {</a>
<a name="ln595">            _xmlKind = _quality;</a>
<a name="ln596">            _xmlParens = &quot;no&quot;;</a>
<a name="ln597">            if (symbols.contains(tok1)) {</a>
<a name="ln598">                  _xmlSymbols = &quot;yes&quot;;</a>
<a name="ln599">                  _xmlText = &quot;&quot;;</a>
<a name="ln600">                  }</a>
<a name="ln601">            else {</a>
<a name="ln602">                  _xmlSymbols = &quot;no&quot;;</a>
<a name="ln603">                  _xmlText = tok1;</a>
<a name="ln604">                  }</a>
<a name="ln605">            }</a>
<a name="ln606">      // eat trailing parens and commas</a>
<a name="ln607">      while (i &lt; len &amp;&amp; trailing.contains(s[i]))</a>
<a name="ln608">           addToken(QString(s[i++]),ChordTokenClass::QUALITY);</a>
<a name="ln609"> </a>
<a name="ln610">#if 0</a>
<a name="ln611">// enable this code to allow extensions to be parenthesized</a>
<a name="ln612">// otherwise, parentheses will automatically cause contents to be interpreted as modifier</a>
<a name="ln613">      // eat leading parens</a>
<a name="ln614">      firstLeadingToken = _tokenList.size();</a>
<a name="ln615">      while (i &lt; len &amp;&amp; leading.contains(s[i]))</a>
<a name="ln616">            addToken(QString(s[i++]),ChordTokenClass::EXTENSION);</a>
<a name="ln617">#endif</a>
<a name="ln618">      lastLeadingToken = _tokenList.size();</a>
<a name="ln619">      // get extension - up to first non-digit other than comma or slash</a>
<a name="ln620">      for (j = 0, tok1 = &quot;&quot;; i &lt; len; ++i, ++j) {</a>
<a name="ln621">            if (!s[i].isDigit() &amp;&amp; s[i] != ',' &amp;&amp; s[i] != '/')</a>
<a name="ln622">                  break;</a>
<a name="ln623">            tok1[j] = s[i];</a>
<a name="ln624">            }</a>
<a name="ln625">      _extension = tok1;</a>
<a name="ln626">      if (_quality == &quot;&quot;) {</a>
<a name="ln627">            if (_extension == &quot;7&quot; || _extension == &quot;9&quot; || _extension == &quot;11&quot; || _extension == &quot;13&quot;) {</a>
<a name="ln628">                  _quality = preferMinor ? &quot;minor&quot; : &quot;dominant&quot;;</a>
<a name="ln629">                  if (!syntaxOnly)</a>
<a name="ln630">                        _xmlKind = preferMinor ? &quot;minor&quot; : &quot;dominant&quot;;</a>
<a name="ln631">                  take7 = true; take9 = true; take11 = true; take13 = true;</a>
<a name="ln632">                  }</a>
<a name="ln633">            else {</a>
<a name="ln634">                  _quality = preferMinor ? &quot;minor&quot; : &quot;major&quot;;</a>
<a name="ln635">                  if (!syntaxOnly)</a>
<a name="ln636">                        _xmlKind = preferMinor ? &quot;minor&quot; : &quot;major&quot;;</a>
<a name="ln637">                  take6 = true; take7 = true; take9 = true; take11 = true; take13 = true;</a>
<a name="ln638">                  }</a>
<a name="ln639">            }</a>
<a name="ln640">      if (tok1 != &quot;&quot;)</a>
<a name="ln641">            addToken(tok1,ChordTokenClass::EXTENSION);</a>
<a name="ln642">#if 0</a>
<a name="ln643">// enable this code to allow extensions to be parenthesized</a>
<a name="ln644">// otherwise, parentheses will automatically cause contents to be interpreted as modifier</a>
<a name="ln645">      else {</a>
<a name="ln646">            // leading tokens were not really ChordTokenClass::EXTENSION</a>
<a name="ln647">            for (int t = firstLeadingToken; t &lt; lastLeadingToken; ++t) {</a>
<a name="ln648">                  _tokenList[t].tokenClass = ChordTokenClass::MODIFIER;</a>
<a name="ln649">                  if (!syntaxOnly)</a>
<a name="ln650">                        _xmlParens = &quot;yes&quot;;</a>
<a name="ln651">                  }</a>
<a name="ln652">            }</a>
<a name="ln653">#endif</a>
<a name="ln654">      if (!syntaxOnly) {</a>
<a name="ln655">            if (_quality == &quot;minor&quot;)</a>
<a name="ln656">                  thirdKey = 3;</a>
<a name="ln657">            else</a>
<a name="ln658">                  thirdKey = 4;</a>
<a name="ln659">            if (_quality == &quot;major&quot;)</a>
<a name="ln660">                  seventhKey = 11;</a>
<a name="ln661">            else if (_quality == &quot;diminished&quot;)</a>
<a name="ln662">                  seventhKey = 9;</a>
<a name="ln663">            else</a>
<a name="ln664">                  seventhKey = 10;</a>
<a name="ln665">            _xmlText += _extension;</a>
<a name="ln666">            QStringList extl;</a>
<a name="ln667">            if (tok1 == &quot;2&quot;) {</a>
<a name="ln668">                  QString d = &quot;add&quot; + tok1;</a>
<a name="ln669">                  _xmlDegrees += d;</a>
<a name="ln670">                  _xmlText.remove(tok1);</a>
<a name="ln671">                  chord += 2;</a>
<a name="ln672">                  }</a>
<a name="ln673">            else if (tok1 == &quot;4&quot;) {</a>
<a name="ln674">                  QString d = &quot;add&quot; + tok1;</a>
<a name="ln675">                  _xmlDegrees += d;</a>
<a name="ln676">                  _xmlText.remove(tok1);</a>
<a name="ln677">                  chord += 5;</a>
<a name="ln678">                  }</a>
<a name="ln679">            else if (tok1 == &quot;5&quot;) {</a>
<a name="ln680">                  _xmlKind = &quot;power&quot;;</a>
<a name="ln681">                  chord -= thirdKey;</a>
<a name="ln682">                  }</a>
<a name="ln683">            else if (tok1 == &quot;6&quot;) {</a>
<a name="ln684">                  if (take6)</a>
<a name="ln685">                        _xmlKind += &quot;-sixth&quot;;</a>
<a name="ln686">                  else</a>
<a name="ln687">                        extl &lt;&lt; &quot;6&quot;;</a>
<a name="ln688">                  chord += 9;</a>
<a name="ln689">                  }</a>
<a name="ln690">            else if (tok1 == &quot;7&quot;) {</a>
<a name="ln691">                  if (take7)</a>
<a name="ln692">                        _xmlKind += &quot;-seventh&quot;;</a>
<a name="ln693">                  else if (_xmlKind != &quot;half-diminished&quot;)</a>
<a name="ln694">                        extl &lt;&lt; &quot;7&quot;;</a>
<a name="ln695">                  chord += seventhKey;</a>
<a name="ln696">                  }</a>
<a name="ln697">            else if (tok1 == &quot;9&quot;) {</a>
<a name="ln698">                  if (take9)</a>
<a name="ln699">                        _xmlKind += &quot;-ninth&quot;;</a>
<a name="ln700">                  else if (take7) {</a>
<a name="ln701">                              _xmlKind += &quot;-seventh&quot;;</a>
<a name="ln702">                              extl &lt;&lt; &quot;9&quot;;</a>
<a name="ln703">                              correctXmlText(&quot;7&quot;);</a>
<a name="ln704">                              }</a>
<a name="ln705">                  else if (_xmlKind == &quot;half-diminished&quot;) {</a>
<a name="ln706">                        extl &lt;&lt; &quot;9&quot;;</a>
<a name="ln707">                        correctXmlText();</a>
<a name="ln708">                        }</a>
<a name="ln709">                  else {</a>
<a name="ln710">                        extl &lt;&lt; &quot;7&quot; &lt;&lt; &quot;9&quot;;</a>
<a name="ln711">                        correctXmlText();</a>
<a name="ln712">                        }</a>
<a name="ln713">                  chord += seventhKey;</a>
<a name="ln714">                  chord += 2;</a>
<a name="ln715">                  }</a>
<a name="ln716">            else if (tok1 == &quot;11&quot;) {</a>
<a name="ln717">                  if (take11)</a>
<a name="ln718">                        _xmlKind += &quot;-11th&quot;;</a>
<a name="ln719">                  else if (take7) {</a>
<a name="ln720">                        _xmlKind += &quot;-seventh&quot;;</a>
<a name="ln721">                        extl &lt;&lt; &quot;9&quot; &lt;&lt; &quot;11&quot;;</a>
<a name="ln722">                        correctXmlText(&quot;7&quot;);</a>
<a name="ln723">                        }</a>
<a name="ln724">                  else if (_xmlKind == &quot;half-diminished&quot;) {</a>
<a name="ln725">                        extl &lt;&lt; &quot;9&quot; &lt;&lt; &quot;11&quot;;</a>
<a name="ln726">                        correctXmlText();</a>
<a name="ln727">                        }</a>
<a name="ln728">                  else {</a>
<a name="ln729">                        extl &lt;&lt; &quot;7&quot; &lt;&lt; &quot;9&quot; &lt;&lt; &quot;11&quot;;</a>
<a name="ln730">                        correctXmlText();</a>
<a name="ln731">                        }</a>
<a name="ln732">                  chord += seventhKey;</a>
<a name="ln733">                  chord += 2;</a>
<a name="ln734">                  chord += 5;</a>
<a name="ln735">                  }</a>
<a name="ln736">            else if (tok1 == &quot;13&quot;) {</a>
<a name="ln737">                  if (take13)</a>
<a name="ln738">                        _xmlKind += &quot;-13th&quot;;</a>
<a name="ln739">                  else if (take7) {</a>
<a name="ln740">                        _xmlKind += &quot;-seventh&quot;;</a>
<a name="ln741">                        extl &lt;&lt; &quot;9&quot; &lt;&lt; &quot;11&quot; &lt;&lt; &quot;13&quot;;</a>
<a name="ln742">                        correctXmlText(&quot;7&quot;);</a>
<a name="ln743">                        }</a>
<a name="ln744">                  else if (_xmlKind == &quot;half-diminished&quot;) {</a>
<a name="ln745">                        extl &lt;&lt; &quot;9&quot; &lt;&lt; &quot;11&quot; &lt;&lt; &quot;13&quot;;</a>
<a name="ln746">                        correctXmlText();</a>
<a name="ln747">                        }</a>
<a name="ln748">                  else {</a>
<a name="ln749">                        extl &lt;&lt; &quot;7&quot; &lt;&lt; &quot;9&quot; &lt;&lt; &quot;11&quot; &lt;&lt; &quot;13&quot;;</a>
<a name="ln750">                        correctXmlText();</a>
<a name="ln751">                        }</a>
<a name="ln752">                  chord += seventhKey;</a>
<a name="ln753">                  chord += 2;</a>
<a name="ln754">                  chord += 5;</a>
<a name="ln755">                  chord += 9;</a>
<a name="ln756">                  }</a>
<a name="ln757">            else if (tok1 == &quot;69&quot; || tok1 == &quot;6,9&quot; || tok1 == &quot;6/9&quot;) {</a>
<a name="ln758">                  if (take6) {</a>
<a name="ln759">                        _xmlKind += &quot;-sixth&quot;;</a>
<a name="ln760">                        extl &lt;&lt; &quot;9&quot;;</a>
<a name="ln761">                        correctXmlText(&quot;6&quot;);</a>
<a name="ln762">                        }</a>
<a name="ln763">                  else {</a>
<a name="ln764">                        extl &lt;&lt; &quot;6&quot; &lt;&lt; &quot;9&quot;;</a>
<a name="ln765">                        correctXmlText();</a>
<a name="ln766">                        }</a>
<a name="ln767">                  chord += 9;</a>
<a name="ln768">                  chord += 2;</a>
<a name="ln769">                  }</a>
<a name="ln770">            foreach (QString e, extl) {</a>
<a name="ln771">                  QString d = &quot;add&quot; + e;</a>
<a name="ln772">                  _xmlDegrees += d;</a>
<a name="ln773">                  }</a>
<a name="ln774">            if (_xmlKind == &quot;dominant-seventh&quot;)</a>
<a name="ln775">                  _xmlKind = &quot;dominant&quot;;</a>
<a name="ln776">            }</a>
<a name="ln777">      // eat trailing parens and commas</a>
<a name="ln778">      while (i &lt; len &amp;&amp; trailing.contains(s[i]))</a>
<a name="ln779">           addToken(QString(s[i++]),ChordTokenClass::EXTENSION);</a>
<a name="ln780"> </a>
<a name="ln781">      // get modifiers</a>
<a name="ln782">      bool addPending = false;</a>
<a name="ln783">      _modifierList.clear();</a>
<a name="ln784">      while (i &lt; len) {</a>
<a name="ln785">            // eat leading parens</a>
<a name="ln786">            while (i &lt; len &amp;&amp; leading.contains(s[i])) {</a>
<a name="ln787">                  addToken(QString(s[i++]),ChordTokenClass::MODIFIER);</a>
<a name="ln788">                  _xmlParens = &quot;yes&quot;;</a>
<a name="ln789">                  }</a>
<a name="ln790">            // get first token - up to first digit, paren, or comma</a>
<a name="ln791">            for (j = 0, tok1 = &quot;&quot;, tok1L = &quot;&quot;, initial = &quot;&quot;; i &lt; len; ++i, ++j) {</a>
<a name="ln792">                  if (s[i].isDigit() || special.contains(s[i]))</a>
<a name="ln793">                        break;</a>
<a name="ln794">                  tok1[j] = s[i];</a>
<a name="ln795">                  tok1L[j] = s[i].toLower();</a>
<a name="ln796">                  if (mod2.contains(tok1L))</a>
<a name="ln797">                        initial = tok1;</a>
<a name="ln798">                  }</a>
<a name="ln799">            // if we reached the end of the string and never got a token,</a>
<a name="ln800">            // then nothing to do, and no sense in looking for a second token</a>
<a name="ln801">            if (i == len &amp;&amp; tok1 == &quot;&quot;)</a>
<a name="ln802">                  break;</a>
<a name="ln803">            if (initial != &quot;&quot; &amp;&amp; initial != tok1) {</a>
<a name="ln804">                  // two modifiers ran together with no separation - eg, susb9</a>
<a name="ln805">                  // keep first, reset index to read second later</a>
<a name="ln806">                  i -= (tok1.length() - initial.length());</a>
<a name="ln807">                  tok1 = initial;</a>
<a name="ln808">                  tok1L = initial.toLower();</a>
<a name="ln809">                  }</a>
<a name="ln810">            // for &quot;add&quot;, just add the token and then read argument as a separate modifier</a>
<a name="ln811">            // this allows the argument to itself be a two-part string</a>
<a name="ln812">            // thus allowing addb9 -&gt; add;b,9</a>
<a name="ln813">            if (tok1L == &quot;add&quot;) {</a>
<a name="ln814">                  addToken(tok1,ChordTokenClass::MODIFIER);</a>
<a name="ln815">                  addPending = true;</a>
<a name="ln816">                  continue;</a>
<a name="ln817">                  }</a>
<a name="ln818">            // eat spaces</a>
<a name="ln819">            while (i &lt; len &amp;&amp; s[i] == ' ')</a>
<a name="ln820">                  ++i;</a>
<a name="ln821">            // get second token - a number &lt;= 13</a>
<a name="ln822">            for (j = 0, tok2 = &quot;&quot;; i &lt; len; ++i) {</a>
<a name="ln823">                  if (!s[i].isDigit())</a>
<a name="ln824">                        break;</a>
<a name="ln825">                  if (j == 1 &amp;&amp; (tok2[0] != '1' || s[i] &gt; '3'))</a>
<a name="ln826">                        break;</a>
<a name="ln827">                  tok2[j++] = s[i];</a>
<a name="ln828">                  }</a>
<a name="ln829">            tok2L = tok2.toLower();</a>
<a name="ln830">            // re-attach &quot;add&quot;</a>
<a name="ln831">            if (addPending) {</a>
<a name="ln832">                  if (raise.contains(tok1L))</a>
<a name="ln833">                        tok1L = &quot;#&quot;;</a>
<a name="ln834">                  else if (lower.contains(tok1L))</a>
<a name="ln835">                        tok1L = &quot;b&quot;;</a>
<a name="ln836">                  else if (tok1 == &quot;M&quot; || major.contains(tok1L))</a>
<a name="ln837">                        tok1L = &quot;major&quot;;</a>
<a name="ln838">                  tok2L = tok1L + tok2L;</a>
<a name="ln839">                  tok1L = &quot;add&quot;;</a>
<a name="ln840">                  }</a>
<a name="ln841">            // standardize spelling</a>
<a name="ln842">            if (tok1 == &quot;M&quot; || major.contains(tok1L))</a>
<a name="ln843">                  tok1L = &quot;major&quot;;</a>
<a name="ln844">            else if (tok1L == &quot;omit&quot;)</a>
<a name="ln845">                  tok1L = &quot;no&quot;;</a>
<a name="ln846">            else if (tok1L == &quot;sus&quot; &amp;&amp; tok2L == &quot;&quot;)</a>
<a name="ln847">                  tok2L = &quot;4&quot;;</a>
<a name="ln848">            else if (augmented.contains(tok1L) &amp;&amp; tok2L == &quot;&quot;) {</a>
<a name="ln849">                  if (_quality == &quot;dominant&quot; &amp;&amp; _extension == &quot;7&quot;) {</a>
<a name="ln850">                        _quality = &quot;augmented&quot;;</a>
<a name="ln851">                        if (!syntaxOnly) {</a>
<a name="ln852">                              _xmlKind = &quot;augmented-seventh&quot;;</a>
<a name="ln853">                              _xmlText = _extension + tok1;</a>
<a name="ln854">                              chord -= 7;</a>
<a name="ln855">                              chord += 8;</a>
<a name="ln856">                              }</a>
<a name="ln857">                        tok1L = &quot;&quot;;</a>
<a name="ln858">                        }</a>
<a name="ln859">                  else {</a>
<a name="ln860">                        tok1L = &quot;#&quot;;</a>
<a name="ln861">                        tok2L = &quot;5&quot;;</a>
<a name="ln862">                        }</a>
<a name="ln863">                  }</a>
<a name="ln864">            else if ((lower.contains(tok1L) || raise.contains(tok1L)) &amp;&amp; tok2L == &quot;&quot;) {</a>
<a name="ln865">                  // trailing alteration - treat as applying to extension (and convert to modifier)</a>
<a name="ln866">                  // this handles C5b, C9#, etc</a>
<a name="ln867">                  tok2L = _extension;</a>
<a name="ln868">                  if (!syntaxOnly) {</a>
<a name="ln869">                        _xmlKind = (_quality == &quot;dominant&quot;) ? &quot;major&quot; : _quality;</a>
<a name="ln870">                        _xmlText.remove(_extension);</a>
<a name="ln871">                        if (_extension == &quot;5&quot;)</a>
<a name="ln872">                              chord += thirdKey;</a>
<a name="ln873">                        else</a>
<a name="ln874">                              chord -= seventhKey;</a>
<a name="ln875">                        }</a>
<a name="ln876">                  if (_quality == &quot;dominant&quot;)</a>
<a name="ln877">                        _quality = &quot;major&quot;;</a>
<a name="ln878">                  _extension = &quot;&quot;;</a>
<a name="ln879">                  if (lower.contains(tok1L))</a>
<a name="ln880">                        tok1L = &quot;b&quot;;</a>
<a name="ln881">                  else</a>
<a name="ln882">                        tok1L = &quot;#&quot;;</a>
<a name="ln883">                  }</a>
<a name="ln884">            else if (lower.contains(tok1L))</a>
<a name="ln885">                  tok1L = &quot;b&quot;;</a>
<a name="ln886">            else if (raise.contains(tok1L))</a>
<a name="ln887">                  tok1L = &quot;#&quot;;</a>
<a name="ln888">            QString m = tok1L + tok2L;</a>
<a name="ln889">            if (m != &quot;&quot;)</a>
<a name="ln890">                  _modifierList += m;</a>
<a name="ln891">            if (tok1 != &quot;&quot;)</a>
<a name="ln892">                  addToken(tok1,ChordTokenClass::MODIFIER);</a>
<a name="ln893">            if (tok2 != &quot;&quot;)</a>
<a name="ln894">                  addToken(tok2,ChordTokenClass::MODIFIER);</a>
<a name="ln895">            if (!syntaxOnly) {</a>
<a name="ln896">                  int d;</a>
<a name="ln897">                  if (tok2L == &quot;&quot;)</a>
<a name="ln898">                        d = 0;</a>
<a name="ln899">                  else</a>
<a name="ln900">                        d = tok2L.toInt();</a>
<a name="ln901">                  if (d &gt; 13)</a>
<a name="ln902">                        d = 13;</a>
<a name="ln903">                  QString degree;</a>
<a name="ln904">                  bool alter = false;</a>
<a name="ln905">                  if (tok1L == &quot;add&quot;) {</a>
<a name="ln906">                        if (d)</a>
<a name="ln907">                              hdl += HDegree(d, 0, HDegreeType::ADD);</a>
<a name="ln908">                        else if (tok2L != &quot;&quot;) {</a>
<a name="ln909">                              // this was result of addPending</a>
<a name="ln910">                              // alteration; tok1 = alter, tok2 = value</a>
<a name="ln911">                              d = tok2.toInt();</a>
<a name="ln912">                              if (raise.contains(tok1) || tok1 == &quot;M&quot; || major.contains(tok1.toLower())) {</a>
<a name="ln913">                                    if (d == 7) {</a>
<a name="ln914">                                          chord += 11;</a>
<a name="ln915">                                          tok2L = &quot;#7&quot;;</a>
<a name="ln916">                                          }</a>
<a name="ln917">                                    else if (raise.contains(tok1))</a>
<a name="ln918">                                          hdl += HDegree(d, 1, HDegreeType::ADD);</a>
<a name="ln919">                                    }</a>
<a name="ln920">                              else if (lower.contains(tok1)) {</a>
<a name="ln921">                                    if (d == 7)</a>
<a name="ln922">                                          chord += 10;</a>
<a name="ln923">                                    else</a>
<a name="ln924">                                          hdl += HDegree(d, -1, HDegreeType::ADD);</a>
<a name="ln925">                                    }</a>
<a name="ln926">                              else if (d)</a>
<a name="ln927">                                    hdl += HDegree(d, 0, HDegreeType::ADD);</a>
<a name="ln928">                              }</a>
<a name="ln929">                        degree = &quot;add&quot; + tok2L;</a>
<a name="ln930">                        }</a>
<a name="ln931">                  else if (tok1L == &quot;no&quot;) {</a>
<a name="ln932">                        degree = &quot;sub&quot; + tok2L;</a>
<a name="ln933">                        if (d)</a>
<a name="ln934">                              hdl += HDegree(d, 0, HDegreeType::SUBTRACT);</a>
<a name="ln935">                        }</a>
<a name="ln936">                  else if (tok1L == &quot;sus&quot;) {</a>
<a name="ln937">#if 0</a>
<a name="ln938">// enable this code to export 7sus4 as dominant,sub3,add4 rather than suspended-fourth,add7 (similar for 9sus4, 13sus4)</a>
<a name="ln939">// should basically work, but not fully tested</a>
<a name="ln940">// probably needs corresponding special casing at end of loop</a>
<a name="ln941">                        if (_extension == &quot;&quot;) {</a>
<a name="ln942">                              if (tok2L == &quot;4&quot;)</a>
<a name="ln943">                                    _xmlKind = &quot;suspended-fourth&quot;;</a>
<a name="ln944">                              else if (tok2L == &quot;2&quot;)</a>
<a name="ln945">                                    _xmlKind = &quot;suspended-second&quot;;</a>
<a name="ln946">                              _xmlText = tok1 + tok2;</a>
<a name="ln947">                              }</a>
<a name="ln948">                        else {</a>
<a name="ln949">                              _xmlDegrees += &quot;sub3&quot;;</a>
<a name="ln950">                              tok1L = &quot;add&quot;;</a>
<a name="ln951">                              }</a>
<a name="ln952">#else</a>
<a name="ln953">// enable this code to export 7sus4 as suspended-fourth,add7 rather than dominant,sub3,add4 (similar for 9sus4, 13sus4)</a>
<a name="ln954">                        // convert chords with sus into suspended &quot;kind&quot;</a>
<a name="ln955">                        // extension then becomes a series of degree adds</a>
<a name="ln956">                        if (tok2L == &quot;4&quot;)</a>
<a name="ln957">                              _xmlKind = &quot;suspended-fourth&quot;;</a>
<a name="ln958">                        else if (tok2L == &quot;2&quot;)</a>
<a name="ln959">                              _xmlKind = &quot;suspended-second&quot;;</a>
<a name="ln960">                        _xmlText = tok1 + tok2;</a>
<a name="ln961">                        if (_extension == &quot;7&quot; || _extension == &quot;9&quot; || _extension == &quot;11&quot; || _extension == &quot;13&quot;) {</a>
<a name="ln962">                              _xmlDegrees += (_quality == &quot;major&quot;) ? &quot;add#7&quot; : &quot;add7&quot;;</a>
<a name="ln963">                              // hack for programs that cannot assemble names well</a>
<a name="ln964">                              // even though the kind is suspended, set text to also include the extension</a>
<a name="ln965">                              // in export, we will set the degree text to null</a>
<a name="ln966">                              _xmlText = _extension + _xmlText;</a>
<a name="ln967">                              degree = &quot;&quot;;</a>
<a name="ln968">                              }</a>
<a name="ln969">                        else if (_extension != &quot;&quot;)</a>
<a name="ln970">                              degree = &quot;add&quot; + _extension;</a>
<a name="ln971">                        if (_extension == &quot;13&quot;) {</a>
<a name="ln972">                              _xmlDegrees += &quot;add9&quot;;</a>
<a name="ln973">                              _xmlDegrees += &quot;add11&quot;;</a>
<a name="ln974">                              _xmlDegrees += &quot;add13&quot;;</a>
<a name="ln975">                        }</a>
<a name="ln976">                        else if (_extension == &quot;11&quot;) {</a>
<a name="ln977">                              _xmlDegrees += &quot;add9&quot;;</a>
<a name="ln978">                              _xmlDegrees += &quot;add11&quot;;</a>
<a name="ln979">                              }</a>
<a name="ln980">                        else if (_extension == &quot;9&quot;)</a>
<a name="ln981">                              _xmlDegrees += &quot;add9&quot;;</a>
<a name="ln982">#endif</a>
<a name="ln983">                        susChord = true;</a>
<a name="ln984">                        chord -= thirdKey;</a>
<a name="ln985">                        if (d)</a>
<a name="ln986">                              chord += key[d];</a>
<a name="ln987">                        }</a>
<a name="ln988">                  else if (tok1L == &quot;major&quot;) {</a>
<a name="ln989">                        if (_xmlKind.startsWith(&quot;minor&quot;)) {</a>
<a name="ln990">                              _xmlKind = &quot;major-minor&quot;;</a>
<a name="ln991">                              if (_extension == &quot;9&quot; || tok2L == &quot;9&quot;)</a>
<a name="ln992">                                    _xmlDegrees += &quot;add9&quot;;</a>
<a name="ln993">                              if (_extension == &quot;11&quot; || tok2L == &quot;11&quot;) {</a>
<a name="ln994">                                    _xmlDegrees += &quot;add9&quot;;</a>
<a name="ln995">                                    _xmlDegrees += &quot;add11&quot;;</a>
<a name="ln996">                                    }</a>
<a name="ln997">                              if (_extension == &quot;13&quot; || tok2L == &quot;13&quot;) {</a>
<a name="ln998">                                    _xmlDegrees += &quot;add9&quot;;</a>
<a name="ln999">                                    _xmlDegrees += &quot;add11&quot;;</a>
<a name="ln1000">                                    _xmlDegrees += &quot;add13&quot;;</a>
<a name="ln1001">                                    }</a>
<a name="ln1002">                              _xmlText += tok1 + tok2;</a>
<a name="ln1003">                              correctXmlText(&quot;7&quot;);</a>
<a name="ln1004">                              }</a>
<a name="ln1005">                        else</a>
<a name="ln1006">                              tok1L = &quot;add&quot;;</a>
<a name="ln1007">                        chord -= 10;</a>
<a name="ln1008">                        chord += 11;</a>
<a name="ln1009">                        if (d &amp;&amp; d != 7)</a>
<a name="ln1010">                              hdl += HDegree(d, 0, HDegreeType::ADD);</a>
<a name="ln1011">                        }</a>
<a name="ln1012">                  else if (tok1L == &quot;alt&quot;) {</a>
<a name="ln1013">                        _xmlDegrees += &quot;altb5&quot;;</a>
<a name="ln1014">                        _xmlDegrees += &quot;add#5&quot;;</a>
<a name="ln1015">                        _xmlDegrees += &quot;addb9&quot;;</a>
<a name="ln1016">                        _xmlDegrees += &quot;add#9&quot;;</a>
<a name="ln1017">                        chord -= 7;</a>
<a name="ln1018">                        chord += 6;</a>
<a name="ln1019">                        chord += 8;</a>
<a name="ln1020">                        chord += 1;</a>
<a name="ln1021">                        chord += 3;</a>
<a name="ln1022">                        }</a>
<a name="ln1023">                  else if (tok1L == &quot;blues&quot;) {</a>
<a name="ln1024">                        // this isn't really well-defined, but it might as well mean something</a>
<a name="ln1025">                        if (_extension == &quot;11&quot; || _extension == &quot;13&quot;)</a>
<a name="ln1026">                              _xmlDegrees += &quot;alt#9&quot;;</a>
<a name="ln1027">                        else</a>
<a name="ln1028">                              _xmlDegrees += &quot;add#9&quot;;</a>
<a name="ln1029">                        chord += 3;</a>
<a name="ln1030">                        }</a>
<a name="ln1031">                  else if (tok1L == &quot;lyd&quot;) {</a>
<a name="ln1032">                        if (_extension == &quot;13&quot;)</a>
<a name="ln1033">                              _xmlDegrees += &quot;alt#11&quot;;</a>
<a name="ln1034">                        else</a>
<a name="ln1035">                              _xmlDegrees += &quot;add#11&quot;;</a>
<a name="ln1036">                        chord += 6;</a>
<a name="ln1037">                        }</a>
<a name="ln1038">                  else if (tok1L == &quot;phryg&quot;) {</a>
<a name="ln1039">                        if (!_xmlKind.startsWith(&quot;minor&quot;))</a>
<a name="ln1040">                              _xmlKind = &quot;minor-seventh&quot;;</a>
<a name="ln1041">                        if (_extension == &quot;11&quot; || _extension == &quot;13&quot;)</a>
<a name="ln1042">                              _xmlDegrees += &quot;altb9&quot;;</a>
<a name="ln1043">                        else</a>
<a name="ln1044">                              _xmlDegrees += &quot;addb9&quot;;</a>
<a name="ln1045">                        _xmlText += tok1;</a>
<a name="ln1046">                        chord = HChord(&quot;C Db Eb G Bb&quot;);</a>
<a name="ln1047">                        }</a>
<a name="ln1048">                  else if (tok1L == &quot;tristan&quot;) {</a>
<a name="ln1049">                        _xmlKind = &quot;Tristan&quot;;</a>
<a name="ln1050">                        _xmlText = tok1;</a>
<a name="ln1051">                        chord = HChord(&quot;C F# A# D#&quot;);</a>
<a name="ln1052">                        }</a>
<a name="ln1053">                  else if (addPending) {</a>
<a name="ln1054">                        degree = &quot;add&quot; + tok1L + tok2L;</a>
<a name="ln1055">                        if (raise.contains(tok1L))</a>
<a name="ln1056">                              hdl += HDegree(d, 1, HDegreeType::ADD);</a>
<a name="ln1057">                        else if (lower.contains(tok1L))</a>
<a name="ln1058">                              hdl += HDegree(d, -1, HDegreeType::ADD);</a>
<a name="ln1059">                        else</a>
<a name="ln1060">                              hdl += HDegree(d, 0, HDegreeType::ADD);</a>
<a name="ln1061">                        }</a>
<a name="ln1062">                  else if (tok1L == &quot;&quot; &amp;&amp; tok2L != &quot;&quot;) {</a>
<a name="ln1063">                        degree = &quot;add&quot; + tok2L;</a>
<a name="ln1064">                        hdl += HDegree(d, 0, HDegreeType::ADD);</a>
<a name="ln1065">                        }</a>
<a name="ln1066">                  else if (lower.contains(tok1L)) {</a>
<a name="ln1067">                        tok1L = &quot;b&quot;;</a>
<a name="ln1068">                        alter = true;</a>
<a name="ln1069">                        }</a>
<a name="ln1070">                  else if (raise.contains(tok1L)) {</a>
<a name="ln1071">                        tok1L = &quot;#&quot;;</a>
<a name="ln1072">                        alter = true;</a>
<a name="ln1073">                        }</a>
<a name="ln1074">                  else {</a>
<a name="ln1075">                        _understandable = false;</a>
<a name="ln1076">                        if (s.startsWith(tok1)) {</a>
<a name="ln1077">                              // unrecognized token right from very beginning</a>
<a name="ln1078">                              _xmlKind = &quot;other&quot;;</a>
<a name="ln1079">                              _xmlText = tok1;</a>
<a name="ln1080">                              }</a>
<a name="ln1081">                        }</a>
<a name="ln1082">                  if (alter) {</a>
<a name="ln1083">                        if (tok2L == &quot;4&quot; &amp;&amp; _xmlKind == &quot;suspended-fourth&quot;)</a>
<a name="ln1084">                              degree = &quot;alt&quot;;</a>
<a name="ln1085">                        else if (tok2L == &quot;5&quot;)</a>
<a name="ln1086">                              degree = &quot;alt&quot;;</a>
<a name="ln1087">                        else if (tok2L == &quot;9&quot; &amp;&amp; (_extension == &quot;11&quot; || _extension == &quot;13&quot;))</a>
<a name="ln1088">                              degree = &quot;alt&quot;;</a>
<a name="ln1089">                        else if (tok2L == &quot;11&quot; &amp;&amp; _extension == &quot;13&quot;)</a>
<a name="ln1090">                              degree = &quot;alt&quot;;</a>
<a name="ln1091">                        else</a>
<a name="ln1092">                              degree = &quot;add&quot;;</a>
<a name="ln1093">                        degree += tok1L + tok2L;</a>
<a name="ln1094">                        if (chord.contains(key[d]) &amp;&amp; !(susChord &amp;&amp; (d == 11)))</a>
<a name="ln1095">                              hdl += HDegree(d, 0, HDegreeType::SUBTRACT);</a>
<a name="ln1096">                        if (tok1L == &quot;#&quot;)</a>
<a name="ln1097">                              hdl += HDegree(d, 1, HDegreeType::ADD);</a>
<a name="ln1098">                        else if (tok1L == &quot;b&quot;)</a>
<a name="ln1099">                              hdl += HDegree(d, -1, HDegreeType::ADD);</a>
<a name="ln1100">                        }</a>
<a name="ln1101">                  if (degree != &quot;&quot;)</a>
<a name="ln1102">                        _xmlDegrees += degree;</a>
<a name="ln1103">                  }</a>
<a name="ln1104">            // eat trailing parens and commas</a>
<a name="ln1105">            while (i &lt; len &amp;&amp; trailing.contains(s[i]))</a>
<a name="ln1106">                  addToken(QString(s[i++]),ChordTokenClass::MODIFIER);</a>
<a name="ln1107">            addPending = false;</a>
<a name="ln1108">            }</a>
<a name="ln1109">      if (!syntaxOnly) {</a>
<a name="ln1110">            chord.add(hdl);</a>
<a name="ln1111">            // fix &quot;add&quot; / &quot;alt&quot; conflicts</a>
<a name="ln1112">            // so add9,altb9 -&gt; addb9</a>
<a name="ln1113">            QStringList altList = _xmlDegrees.filter(&quot;alt&quot;);</a>
<a name="ln1114">            foreach (const QString&amp; d, altList) {</a>
<a name="ln1115">                  QString unalt(d);</a>
<a name="ln1116">                  unalt.replace(QRegExp(&quot;alt[b#]&quot;),&quot;add&quot;);</a>
<a name="ln1117">                  if (_xmlDegrees.removeAll(unalt) &gt; 0) {</a>
<a name="ln1118">                        QString alt(d);</a>
<a name="ln1119">                        alt.replace(&quot;alt&quot;,&quot;add&quot;);</a>
<a name="ln1120">                        int i1 = _xmlDegrees.indexOf(d);</a>
<a name="ln1121">                        _xmlDegrees.replace(i1, alt);</a>
<a name="ln1122">                        }</a>
<a name="ln1123">                  }</a>
<a name="ln1124">            }</a>
<a name="ln1125"> </a>
<a name="ln1126">      // construct handle</a>
<a name="ln1127">      if (!_modifierList.empty()) {</a>
<a name="ln1128">            _modifierList.sort();</a>
<a name="ln1129">            _modifiers = &quot;&lt;&quot; + _modifierList.join(&quot;&gt;&lt;&quot;) + &quot;&gt;&quot;;</a>
<a name="ln1130">            }</a>
<a name="ln1131">      _handle = &quot;&lt;&quot; + _quality + &quot;&gt;&lt;&quot; + _extension + &quot;&gt;&quot; + _modifiers;</a>
<a name="ln1132"> </a>
<a name="ln1133">      // force &lt;minor&gt;&lt;7&gt;&lt;b5&gt; to export as half-diminished</a>
<a name="ln1134">      if (!syntaxOnly &amp;&amp; _handle == &quot;&lt;minor&gt;&lt;7&gt;&lt;b5&gt;&quot;) {</a>
<a name="ln1135">                  _xmlKind = &quot;half-diminished&quot;;</a>
<a name="ln1136">                  _xmlText = s;</a>
<a name="ln1137">                  _xmlDegrees.clear();</a>
<a name="ln1138">            }</a>
<a name="ln1139">      if (MScore::debugMode) {</a>
<a name="ln1140">            qDebug(&quot;parse: source = &lt;%s&gt;, handle = %s&quot;, qPrintable(s), qPrintable(_handle));</a>
<a name="ln1141">            if (!syntaxOnly) {</a>
<a name="ln1142">                  qDebug(&quot;parse: HChord = &lt;%s&gt; (%d)&quot;, qPrintable(chord.voicing()), chord.getKeys());</a>
<a name="ln1143">                  qDebug(&quot;parse: xmlKind = &lt;%s&gt;, text = &lt;%s&gt;&quot;, qPrintable(_xmlKind), qPrintable(_xmlText));</a>
<a name="ln1144">                  qDebug(&quot;parse: xmlSymbols = %s, xmlParens = %s&quot;, qPrintable(_xmlSymbols), qPrintable(_xmlParens));</a>
<a name="ln1145">                  qDebug(&quot;parse: xmlDegrees = &lt;%s&gt;&quot;, qPrintable(_xmlDegrees.join(&quot;,&quot;)));</a>
<a name="ln1146">                  }</a>
<a name="ln1147">            }</a>
<a name="ln1148">      return _parseable;</a>
<a name="ln1149">      }</a>
<a name="ln1150"> </a>
<a name="ln1151">//---------------------------------------------------------</a>
<a name="ln1152">//   fromXml</a>
<a name="ln1153">//---------------------------------------------------------</a>
<a name="ln1154"> </a>
<a name="ln1155">QString ParsedChord::fromXml(const QString&amp; rawKind, const QString&amp; rawKindText, const QString&amp; useSymbols, const QString&amp; useParens, const QList&lt;HDegree&gt;&amp; dl, const ChordList* cl)</a>
<a name="ln1156">      {</a>
<a name="ln1157">      QString kind = rawKind;</a>
<a name="ln1158">      QString kindText = rawKindText;</a>
<a name="ln1159">      bool syms = (useSymbols == &quot;yes&quot;);</a>
<a name="ln1160">      bool parens = (useParens == &quot;yes&quot;);</a>
<a name="ln1161">      bool implied = false;</a>
<a name="ln1162">      bool extend = false;</a>
<a name="ln1163">      int extension = 0;</a>
<a name="ln1164">      _parseable = true;</a>
<a name="ln1165">      _understandable = true;</a>
<a name="ln1166"> </a>
<a name="ln1167">      // get quality info from kind</a>
<a name="ln1168">      if (kind == &quot;major-minor&quot;) {</a>
<a name="ln1169">            _quality = &quot;minor&quot;;</a>
<a name="ln1170">            _modifierList += &quot;major7&quot;;</a>
<a name="ln1171">            extend = true;</a>
<a name="ln1172">            }</a>
<a name="ln1173">      else if (kind.contains(&quot;major&quot;)) {</a>
<a name="ln1174">            _quality = &quot;major&quot;;</a>
<a name="ln1175">            if (kind == &quot;major&quot; || kind == &quot;major-sixth&quot;)</a>
<a name="ln1176">                  implied = true;</a>
<a name="ln1177">            }</a>
<a name="ln1178">      else if (kind.contains(&quot;minor&quot;))</a>
<a name="ln1179">            _quality = &quot;minor&quot;;</a>
<a name="ln1180">      else if (kind.contains(&quot;dominant&quot;)) {</a>
<a name="ln1181">            _quality = &quot;dominant&quot;;</a>
<a name="ln1182">            implied = true;</a>
<a name="ln1183">            extension = 7;</a>
<a name="ln1184">            }</a>
<a name="ln1185">      else if (kind == &quot;augmented-seventh&quot;) {</a>
<a name="ln1186">            _quality = &quot;augmented&quot;;</a>
<a name="ln1187">            extension = 7;</a>
<a name="ln1188">            extend = true;</a>
<a name="ln1189">            }</a>
<a name="ln1190">      else if (kind == &quot;augmented&quot;)</a>
<a name="ln1191">            _quality = &quot;augmented&quot;;</a>
<a name="ln1192">      else if (kind == &quot;half-diminished&quot;) {</a>
<a name="ln1193">            _quality = &quot;half-diminished&quot;;</a>
<a name="ln1194">            if (syms) {</a>
<a name="ln1195">                  extension = 7;</a>
<a name="ln1196">                  extend = true;</a>
<a name="ln1197">                  }</a>
<a name="ln1198">            }</a>
<a name="ln1199">      else if (kind == &quot;diminished-seventh&quot;) {</a>
<a name="ln1200">            _quality = &quot;diminished&quot;;</a>
<a name="ln1201">            extension = 7;</a>
<a name="ln1202">            }</a>
<a name="ln1203">      else if (kind == &quot;diminished&quot;)</a>
<a name="ln1204">            _quality = &quot;diminished&quot;;</a>
<a name="ln1205">      else if (kind == &quot;suspended-fourth&quot;) {</a>
<a name="ln1206">            _quality = &quot;major&quot;;</a>
<a name="ln1207">            implied = true;</a>
<a name="ln1208">            _modifierList += &quot;sus4&quot;;</a>
<a name="ln1209">            }</a>
<a name="ln1210">      else if (kind == &quot;suspended-second&quot;) {</a>
<a name="ln1211">            _quality = &quot;major&quot;;</a>
<a name="ln1212">            implied = true;</a>
<a name="ln1213">            _modifierList += &quot;sus2&quot;;</a>
<a name="ln1214">            }</a>
<a name="ln1215">      else if (kind == &quot;power&quot;) {</a>
<a name="ln1216">            _quality = &quot;major&quot;;</a>
<a name="ln1217">            implied = true;</a>
<a name="ln1218">            extension = 5;</a>
<a name="ln1219">            }</a>
<a name="ln1220">      else</a>
<a name="ln1221">            _quality = kind;</a>
<a name="ln1222"> </a>
<a name="ln1223">      // get extension info from kind</a>
<a name="ln1224">      if (kind.contains(&quot;seventh&quot;))</a>
<a name="ln1225">            extension = 7;</a>
<a name="ln1226">      else if (kind.contains(&quot;ninth&quot;))</a>
<a name="ln1227">            extension = 9;</a>
<a name="ln1228">      else if (kind.contains(&quot;11th&quot;))</a>
<a name="ln1229">            extension = 11;</a>
<a name="ln1230">      else if (kind.contains(&quot;13th&quot;))</a>
<a name="ln1231">            extension = 13;</a>
<a name="ln1232">      else if (kind.contains(&quot;sixth&quot;))</a>
<a name="ln1233">            extension = 6;</a>
<a name="ln1234"> </a>
<a name="ln1235">      // get modifier info from degree list</a>
<a name="ln1236">      foreach (const HDegree&amp; d, dl) {</a>
<a name="ln1237">            QString mod;</a>
<a name="ln1238">            int v = d.value();</a>
<a name="ln1239">            switch (d.type()) {</a>
<a name="ln1240">                  case HDegreeType::ADD:</a>
<a name="ln1241">                  case HDegreeType::ALTER:</a>
<a name="ln1242">                        switch (d.alter()) {</a>
<a name="ln1243">                              case -1:    mod = &quot;b&quot;; break;</a>
<a name="ln1244">                              case 1:     mod = &quot;#&quot;; break;</a>
<a name="ln1245">                              case 0:     mod = &quot;add&quot;; break;</a>
<a name="ln1246">                              }</a>
<a name="ln1247">                        break;</a>
<a name="ln1248">                  case HDegreeType::SUBTRACT:</a>
<a name="ln1249">                        mod = &quot;no&quot;;</a>
<a name="ln1250">                        break;</a>
<a name="ln1251">                  case HDegreeType::UNDEF:</a>
<a name="ln1252">                  default:</a>
<a name="ln1253">                        break;</a>
<a name="ln1254">                  }</a>
<a name="ln1255">            mod += QString(&quot;%1&quot;).arg(v);</a>
<a name="ln1256">            if (mod == &quot;add7&quot; &amp;&amp; kind.contains(&quot;suspended&quot;)) {</a>
<a name="ln1257">                  _quality = &quot;dominant&quot;;</a>
<a name="ln1258">                  implied = true;</a>
<a name="ln1259">                  extension = 7;</a>
<a name="ln1260">                  extend = true;</a>
<a name="ln1261">                  mod = &quot;&quot;;</a>
<a name="ln1262">                  }</a>
<a name="ln1263">            else if (mod == &quot;add#7&quot; &amp;&amp; kind.contains(&quot;suspended&quot;)) {</a>
<a name="ln1264">                  _quality = &quot;major&quot;;</a>
<a name="ln1265">                  implied = false;</a>
<a name="ln1266">                  extension = 7;</a>
<a name="ln1267">                  extend = true;</a>
<a name="ln1268">                  mod = &quot;&quot;;</a>
<a name="ln1269">                  }</a>
<a name="ln1270">            else if (mod == &quot;add9&quot; &amp;&amp; extend) {</a>
<a name="ln1271">                  if (extension &lt; 9)</a>
<a name="ln1272">                        extension = 9;</a>
<a name="ln1273">                  mod = &quot;&quot;;</a>
<a name="ln1274">                  }</a>
<a name="ln1275">            else if (mod == &quot;add11&quot; &amp;&amp; extend) {</a>
<a name="ln1276">                  if (extension &lt; 11)</a>
<a name="ln1277">                        extension = 11;</a>
<a name="ln1278">                  mod = &quot;&quot;;</a>
<a name="ln1279">                  }</a>
<a name="ln1280">            else if (mod == &quot;add13&quot; &amp;&amp; extend) {</a>
<a name="ln1281">                  extension = 13;</a>
<a name="ln1282">                  mod = &quot;&quot;;</a>
<a name="ln1283">                  }</a>
<a name="ln1284">            else if (mod == &quot;add9&quot; &amp;&amp; kind.contains(&quot;sixth&quot;)) {</a>
<a name="ln1285">                  extension = 69;</a>
<a name="ln1286">                  mod = &quot;&quot;;</a>
<a name="ln1287">                  }</a>
<a name="ln1288">            if (mod != &quot;&quot;)</a>
<a name="ln1289">                  _modifierList += mod;</a>
<a name="ln1290">            }</a>
<a name="ln1291">      // convert no3,add[42] into sus[42]</a>
<a name="ln1292">      int no3 = _modifierList.indexOf(&quot;no3&quot;);</a>
<a name="ln1293">      if (no3 &gt;= 0) {</a>
<a name="ln1294">            int addn = _modifierList.indexOf(&quot;add4&quot;);</a>
<a name="ln1295">            if (addn == -1)</a>
<a name="ln1296">                  addn = _modifierList.indexOf(&quot;add2&quot;);</a>
<a name="ln1297">            if (addn != -1) {</a>
<a name="ln1298">                  QString&amp; s = _modifierList[addn];</a>
<a name="ln1299">                  s.replace(&quot;add&quot;,&quot;sus&quot;);</a>
<a name="ln1300">                  _modifierList.removeAt(no3);</a>
<a name="ln1301">                  }</a>
<a name="ln1302">            }</a>
<a name="ln1303">      // convert kind=minor-seventh, degree=altb5 to kind=half-diminished (suppression of degree=altb comes later)</a>
<a name="ln1304">      if (kind == &quot;minor-seventh&quot; &amp;&amp; _modifierList.size() == 1 &amp;&amp; _modifierList.front() == &quot;b5&quot;)</a>
<a name="ln1305">            kind = &quot;half-diminished&quot;;</a>
<a name="ln1306">      // force parens where necessary)</a>
<a name="ln1307">      if (!parens &amp;&amp; extension == 0 &amp;&amp; !_modifierList.empty()) {</a>
<a name="ln1308">            QString firstMod = _modifierList.front();</a>
<a name="ln1309">            if (firstMod != &quot;&quot; &amp;&amp; (firstMod.startsWith('#') || firstMod.startsWith('b')))</a>
<a name="ln1310">                  parens = true;</a>
<a name="ln1311">            }</a>
<a name="ln1312"> </a>
<a name="ln1313">      // record extension</a>
<a name="ln1314">      if (extension)</a>
<a name="ln1315">            _extension = QString(&quot;%1&quot;).arg(extension);</a>
<a name="ln1316"> </a>
<a name="ln1317">      // validate kindText</a>
<a name="ln1318">      if (kindText != &quot;&quot; &amp;&amp; kind != &quot;none&quot; &amp;&amp; kind != &quot;other&quot;) {</a>
<a name="ln1319">            ParsedChord validate;</a>
<a name="ln1320">            validate.parse(kindText, cl, false);</a>
<a name="ln1321">            // kindText should parse to produce same kind, no degrees</a>
<a name="ln1322">            if (validate._xmlKind != kind || !validate._xmlDegrees.empty())</a>
<a name="ln1323">                  kindText = &quot;&quot;;</a>
<a name="ln1324">            }</a>
<a name="ln1325"> </a>
<a name="ln1326">      // construct name &amp; handle</a>
<a name="ln1327">      _name = &quot;&quot;;</a>
<a name="ln1328">      if (kindText != &quot;&quot;) {</a>
<a name="ln1329">            if (_extension != &quot;&quot; &amp;&amp; kind.contains(&quot;suspended&quot;))</a>
<a name="ln1330">                  _name += _extension;</a>
<a name="ln1331">            _name += kindText;</a>
<a name="ln1332">            if (extension == 69)</a>
<a name="ln1333">                  _name += &quot;9&quot;;</a>
<a name="ln1334">            }</a>
<a name="ln1335">      else if (implied)</a>
<a name="ln1336">            _name = _extension;</a>
<a name="ln1337">      else {</a>
<a name="ln1338">            if (_quality == &quot;major&quot;)</a>
<a name="ln1339">                  _name = syms ? &quot;^&quot; : &quot;maj&quot;;</a>
<a name="ln1340">            else if (_quality == &quot;minor&quot;)</a>
<a name="ln1341">                  _name = syms ? &quot;-&quot; : &quot;m&quot;;</a>
<a name="ln1342">            else if (_quality == &quot;augmented&quot;)</a>
<a name="ln1343">                  _name = syms ? &quot;+&quot; : &quot;aug&quot;;</a>
<a name="ln1344">            else if (_quality == &quot;diminished&quot;)</a>
<a name="ln1345">                  _name = syms ? &quot;o&quot; : &quot;dim&quot;;</a>
<a name="ln1346">            else if (_quality == &quot;half-diminished&quot;)</a>
<a name="ln1347">                  _name = syms ? &quot;0&quot; : &quot;m7b5&quot;;</a>
<a name="ln1348">            else</a>
<a name="ln1349">                  _name = _quality;</a>
<a name="ln1350">            _name += _extension;</a>
<a name="ln1351">            }</a>
<a name="ln1352">      if (parens)</a>
<a name="ln1353">            _name += &quot;(&quot;;</a>
<a name="ln1354">      foreach (QString mod, _modifierList) {</a>
<a name="ln1355">            mod.replace(&quot;major&quot;,&quot;maj&quot;);</a>
<a name="ln1356">            if (kindText != &quot;&quot; &amp;&amp; kind.contains(&quot;suspended&quot;) &amp;&amp; mod.startsWith(&quot;sus&quot;))</a>
<a name="ln1357">                  continue;</a>
<a name="ln1358">            else if (kindText != &quot;&quot; &amp;&amp; kind == &quot;major-minor&quot; &amp;&amp; mod.startsWith(&quot;maj&quot;))</a>
<a name="ln1359">                  continue;</a>
<a name="ln1360">            _name += mod;</a>
<a name="ln1361">            }</a>
<a name="ln1362">      if (parens)</a>
<a name="ln1363">            _name += &quot;)&quot;;</a>
<a name="ln1364"> </a>
<a name="ln1365">      // parse name to construct handle &amp; tokenList</a>
<a name="ln1366">      parse(_name, cl, true);</a>
<a name="ln1367"> </a>
<a name="ln1368">      // record original MusicXML</a>
<a name="ln1369">      _xmlKind = kind;</a>
<a name="ln1370">      _xmlText = kindText;</a>
<a name="ln1371">      _xmlSymbols = useSymbols;</a>
<a name="ln1372">      _xmlParens = useParens;</a>
<a name="ln1373">      foreach (const HDegree&amp; d, dl) {</a>
<a name="ln1374">            if (kind == &quot;half-diminished&quot; &amp;&amp; d.type() == HDegreeType::ALTER &amp;&amp; d.alter() == -1 &amp;&amp; d.value() == 5)</a>
<a name="ln1375">                  continue;</a>
<a name="ln1376">            _xmlDegrees += d.text();</a>
<a name="ln1377">            }</a>
<a name="ln1378"> </a>
<a name="ln1379">      return _name;</a>
<a name="ln1380">      }</a>
<a name="ln1381"> </a>
<a name="ln1382"> </a>
<a name="ln1383">//---------------------------------------------------------</a>
<a name="ln1384">//   position</a>
<a name="ln1385">//---------------------------------------------------------</a>
<a name="ln1386"> </a>
<a name="ln1387">qreal ChordList::position(const QStringList&amp; names, ChordTokenClass ctc) const</a>
<a name="ln1388">      {</a>
<a name="ln1389">      QString name = names.empty() ? &quot;&quot; : names.first();</a>
<a name="ln1390">      switch (ctc) {</a>
<a name="ln1391">            case ChordTokenClass::EXTENSION:</a>
<a name="ln1392">                  return _eadjust;</a>
<a name="ln1393">            case ChordTokenClass::MODIFIER: {</a>
<a name="ln1394">                  QChar c = name.isEmpty() ? name.at(0) : '0';</a>
<a name="ln1395">                  if (c.isDigit() || c.isPunct())</a>
<a name="ln1396">                        return _madjust;</a>
<a name="ln1397">                  else</a>
<a name="ln1398">                        return 0.0;</a>
<a name="ln1399">                  }</a>
<a name="ln1400">            default:</a>
<a name="ln1401">                  if (name == &quot;o&quot; || name == &quot;0&quot;)</a>
<a name="ln1402">                        return _eadjust;</a>
<a name="ln1403">                  else</a>
<a name="ln1404">                        return 0.0;</a>
<a name="ln1405">            }</a>
<a name="ln1406">      }</a>
<a name="ln1407"> </a>
<a name="ln1408">//---------------------------------------------------------</a>
<a name="ln1409">//   renderList</a>
<a name="ln1410">//---------------------------------------------------------</a>
<a name="ln1411"> </a>
<a name="ln1412">const QList&lt;RenderAction&gt;&amp; ParsedChord::renderList(const ChordList* cl)</a>
<a name="ln1413">      {</a>
<a name="ln1414">      // generate anew on each call,</a>
<a name="ln1415">      // in case chord list has changed since last time</a>
<a name="ln1416">      if (!_renderList.empty())</a>
<a name="ln1417">            _renderList.clear();</a>
<a name="ln1418">      bool adjust = cl-&gt;autoAdjust();</a>
<a name="ln1419">      for (ChordToken tok : _tokenList) {</a>
<a name="ln1420">            QString n = tok.names.first();</a>
<a name="ln1421">            QList&lt;RenderAction&gt; rl;</a>
<a name="ln1422">            QList&lt;ChordToken&gt; definedTokens;</a>
<a name="ln1423">            bool found = false;</a>
<a name="ln1424">            // potential definitions for token</a>
<a name="ln1425">            if (cl) {</a>
<a name="ln1426">                  for (ChordToken ct : cl-&gt;chordTokenList) {</a>
<a name="ln1427">                        for (QString ctn : ct.names) {</a>
<a name="ln1428">                              if (ctn == n)</a>
<a name="ln1429">                                    definedTokens += ct;</a>
<a name="ln1430">                              }</a>
<a name="ln1431">                        }</a>
<a name="ln1432">                  }</a>
<a name="ln1433">            // find matching class, fallback on ChordTokenClass::ALL</a>
<a name="ln1434">            ChordTokenClass ctc = ChordTokenClass::ALL;</a>
<a name="ln1435">            for (ChordToken matchingTok : definedTokens) {</a>
<a name="ln1436">                  if (tok.tokenClass == matchingTok.tokenClass) {</a>
<a name="ln1437">                        rl = matchingTok.renderList;</a>
<a name="ln1438">                        ctc = tok.tokenClass;</a>
<a name="ln1439">                        found = true;</a>
<a name="ln1440">                        break;</a>
<a name="ln1441">                        }</a>
<a name="ln1442">                  else if (matchingTok.tokenClass == ChordTokenClass::ALL) {</a>
<a name="ln1443">                        rl = matchingTok.renderList;</a>
<a name="ln1444">                        found = true;</a>
<a name="ln1445">                        }</a>
<a name="ln1446">                  }</a>
<a name="ln1447">            // check for adjustments</a>
<a name="ln1448">            // stop adjusting when first non-adjusted modifier found</a>
<a name="ln1449">            qreal p = adjust ? cl-&gt;position(tok.names, ctc) : 0.0;</a>
<a name="ln1450">            if (tok.tokenClass == ChordTokenClass::MODIFIER &amp;&amp; p == 0.0)</a>
<a name="ln1451">                  adjust = false;</a>
<a name="ln1452">            // build render list</a>
<a name="ln1453">            if (p != 0.0) {</a>
<a name="ln1454">                  RenderAction m1 = RenderAction(RenderAction::RenderActionType::MOVE);</a>
<a name="ln1455">                  m1.movex = 0.0;</a>
<a name="ln1456">                  m1.movey = p;</a>
<a name="ln1457">                  _renderList.append(m1);</a>
<a name="ln1458">                  }</a>
<a name="ln1459">            if (found) {</a>
<a name="ln1460">                  _renderList.append(rl);</a>
<a name="ln1461">                  }</a>
<a name="ln1462">            else {</a>
<a name="ln1463">                  // no definition for token, so render as literal</a>
<a name="ln1464">                  RenderAction a(RenderAction::RenderActionType::SET);</a>
<a name="ln1465">                  a.text = tok.names.first();</a>
<a name="ln1466">                  _renderList.append(a);</a>
<a name="ln1467">                  }</a>
<a name="ln1468">            if (p != 0.0) {</a>
<a name="ln1469">                  RenderAction m2 = RenderAction(RenderAction::RenderActionType::MOVE);</a>
<a name="ln1470">                  m2.movex = 0.0;</a>
<a name="ln1471">                  m2.movey = -p;</a>
<a name="ln1472">                  _renderList.append(m2);</a>
<a name="ln1473">                  }</a>
<a name="ln1474">            }</a>
<a name="ln1475">      return _renderList;</a>
<a name="ln1476">      }</a>
<a name="ln1477"> </a>
<a name="ln1478">//---------------------------------------------------------</a>
<a name="ln1479">//   addToken</a>
<a name="ln1480">//---------------------------------------------------------</a>
<a name="ln1481"> </a>
<a name="ln1482">void ParsedChord::addToken(QString s, ChordTokenClass tc)</a>
<a name="ln1483">      {</a>
<a name="ln1484">      if (s == &quot;&quot;)</a>
<a name="ln1485">            return;</a>
<a name="ln1486">      ChordToken tok;</a>
<a name="ln1487">      tok.names += s;</a>
<a name="ln1488">      tok.tokenClass = tc;</a>
<a name="ln1489">      _tokenList += tok;</a>
<a name="ln1490">      }</a>
<a name="ln1491"> </a>
<a name="ln1492">//---------------------------------------------------------</a>
<a name="ln1493">//   ChordDescription</a>
<a name="ln1494">//    this form is used when reading from file</a>
<a name="ln1495">//    a private id is assigned for id = 0</a>
<a name="ln1496">//---------------------------------------------------------</a>
<a name="ln1497"> </a>
<a name="ln1498">ChordDescription::ChordDescription(int i)</a>
<a name="ln1499">      {</a>
<a name="ln1500">      if (!i)</a>
<a name="ln1501">//            i = --(cl-&gt;privateID);</a>
<a name="ln1502">            i = -- ChordList::privateID;</a>
<a name="ln1503">      id = i;</a>
<a name="ln1504">      generated = false;</a>
<a name="ln1505">      renderListGenerated = false;</a>
<a name="ln1506">      exportOk = true;</a>
<a name="ln1507">      }</a>
<a name="ln1508"> </a>
<a name="ln1509">//---------------------------------------------------------</a>
<a name="ln1510">//   ChordDescription</a>
<a name="ln1511">//    this form is used when generating from name</a>
<a name="ln1512">//    a private id is always assigned</a>
<a name="ln1513">//---------------------------------------------------------</a>
<a name="ln1514"> </a>
<a name="ln1515">ChordDescription::ChordDescription(const QString&amp; name)</a>
<a name="ln1516">      {</a>
<a name="ln1517">      id = -- ChordList::privateID;</a>
<a name="ln1518">      generated = true;</a>
<a name="ln1519">      names.append(name);</a>
<a name="ln1520">      renderListGenerated = false;</a>
<a name="ln1521">      exportOk = false;</a>
<a name="ln1522">      }</a>
<a name="ln1523"> </a>
<a name="ln1524">//---------------------------------------------------------</a>
<a name="ln1525">//   complete</a>
<a name="ln1526">//    generate missing renderList and semantic (Xml) info</a>
<a name="ln1527">//---------------------------------------------------------</a>
<a name="ln1528"> </a>
<a name="ln1529">void ChordDescription::complete(ParsedChord* pc, const ChordList* cl)</a>
<a name="ln1530">      {</a>
<a name="ln1531">      ParsedChord tempPc;</a>
<a name="ln1532">      if (!pc) {</a>
<a name="ln1533">            // generate parsed chord for its rendering &amp; semantic (xml) info</a>
<a name="ln1534">            pc = &amp;tempPc;</a>
<a name="ln1535">            QString n;</a>
<a name="ln1536">            if (!names.empty())</a>
<a name="ln1537">                  n = names.front();</a>
<a name="ln1538">            pc-&gt;parse(n, cl);</a>
<a name="ln1539">            }</a>
<a name="ln1540">      parsedChords.append(*pc);</a>
<a name="ln1541">      if (renderList.empty() || renderListGenerated) {</a>
<a name="ln1542">            renderList = pc-&gt;renderList(cl);</a>
<a name="ln1543">            renderListGenerated = true;</a>
<a name="ln1544">            }</a>
<a name="ln1545">      if (xmlKind == &quot;&quot;) {</a>
<a name="ln1546">            xmlKind = pc-&gt;xmlKind();</a>
<a name="ln1547">            xmlDegrees = pc-&gt;xmlDegrees();</a>
<a name="ln1548">            }</a>
<a name="ln1549">      // these fields are not read from chord description files</a>
<a name="ln1550">      // so get them from the parsed representation in all cases</a>
<a name="ln1551">      xmlText = pc-&gt;xmlText();</a>
<a name="ln1552">      xmlSymbols = pc-&gt;xmlSymbols();</a>
<a name="ln1553">      xmlParens = pc-&gt;xmlParens();</a>
<a name="ln1554">      if (chord.getKeys() == 0) {</a>
<a name="ln1555">            chord = HChord(pc-&gt;keys());</a>
<a name="ln1556">            }</a>
<a name="ln1557">      _quality = pc-&gt;quality();</a>
<a name="ln1558">      }</a>
<a name="ln1559"> </a>
<a name="ln1560">//---------------------------------------------------------</a>
<a name="ln1561">//   read</a>
<a name="ln1562">//---------------------------------------------------------</a>
<a name="ln1563"> </a>
<a name="ln1564">void ChordDescription::read(XmlReader&amp; e)</a>
<a name="ln1565">      {</a>
<a name="ln1566">      int ni = 0;</a>
<a name="ln1567">      id = e.attribute(&quot;id&quot;).toInt();</a>
<a name="ln1568">      while (e.readNextStartElement()) {</a>
<a name="ln1569">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1570">            if (tag == &quot;name&quot;) {</a>
<a name="ln1571">                  QString n = e.readElementText();</a>
<a name="ln1572">                  // stack names for this file on top of the list</a>
<a name="ln1573">                  names.insert(ni++,n);</a>
<a name="ln1574">                  }</a>
<a name="ln1575">            else if (tag == &quot;xml&quot;)</a>
<a name="ln1576">                  xmlKind = e.readElementText();</a>
<a name="ln1577">            else if (tag == &quot;degree&quot;)</a>
<a name="ln1578">                  xmlDegrees.append(e.readElementText());</a>
<a name="ln1579">            else if (tag == &quot;voicing&quot;)</a>
<a name="ln1580">                  chord = HChord(e.readElementText());</a>
<a name="ln1581">            else if (tag == &quot;render&quot;) {</a>
<a name="ln1582">                  readRenderList(e.readElementText(), renderList);</a>
<a name="ln1583">                  renderListGenerated = false;</a>
<a name="ln1584">                  }</a>
<a name="ln1585">            else</a>
<a name="ln1586">                  e.unknown();</a>
<a name="ln1587">            }</a>
<a name="ln1588">      }</a>
<a name="ln1589"> </a>
<a name="ln1590">//---------------------------------------------------------</a>
<a name="ln1591">//   write</a>
<a name="ln1592">//---------------------------------------------------------</a>
<a name="ln1593"> </a>
<a name="ln1594">void ChordDescription::write(XmlWriter&amp; xml) const</a>
<a name="ln1595">      {</a>
<a name="ln1596">      if (generated &amp;&amp; !exportOk)</a>
<a name="ln1597">            return;</a>
<a name="ln1598">      if (id &gt; 0)</a>
<a name="ln1599">            xml.stag(QString(&quot;chord id=\&quot;%1\&quot;&quot;).arg(id));</a>
<a name="ln1600">      else</a>
<a name="ln1601">            xml.stag(QString(&quot;chord&quot;));</a>
<a name="ln1602">      foreach(const QString&amp; s, names)</a>
<a name="ln1603">            xml.tag(&quot;name&quot;, s);</a>
<a name="ln1604">      xml.tag(&quot;xml&quot;, xmlKind);</a>
<a name="ln1605">      xml.tag(&quot;voicing&quot;, chord.voicing());</a>
<a name="ln1606">      foreach(const QString&amp; s, xmlDegrees)</a>
<a name="ln1607">            xml.tag(&quot;degree&quot;, s);</a>
<a name="ln1608">      writeRenderList(xml, &amp;renderList, &quot;render&quot;);</a>
<a name="ln1609">      xml.etag();</a>
<a name="ln1610">      }</a>
<a name="ln1611"> </a>
<a name="ln1612"> </a>
<a name="ln1613">//---------------------------------------------------------</a>
<a name="ln1614">//   ChordList</a>
<a name="ln1615">//---------------------------------------------------------</a>
<a name="ln1616"> </a>
<a name="ln1617">int ChordList::privateID = -1000;</a>
<a name="ln1618"> </a>
<a name="ln1619">//---------------------------------------------------------</a>
<a name="ln1620">//   configureAutoAdjust</a>
<a name="ln1621">//---------------------------------------------------------</a>
<a name="ln1622"> </a>
<a name="ln1623">void ChordList::configureAutoAdjust(qreal emag, qreal eadjust, qreal mmag, qreal madjust)</a>
<a name="ln1624">      {</a>
<a name="ln1625">      _emag = emag;</a>
<a name="ln1626">      _eadjust = eadjust;</a>
<a name="ln1627">      _mmag = mmag;</a>
<a name="ln1628">      _madjust = madjust;</a>
<a name="ln1629">#if 0</a>
<a name="ln1630">      // TODO: regenerate all chord descriptions</a>
<a name="ln1631">      // currently we always reload the entire chordlist</a>
<a name="ln1632">      if (_autoAdjust) {</a>
<a name="ln1633">            for (ChordFont cf : fonts) {</a>
<a name="ln1634">                  if (cf.fontClass == &quot;extension&quot;)</a>
<a name="ln1635">                        cf.mag = _emag;</a>
<a name="ln1636">                  else if (cf.fontClass == &quot;modifier&quot;)</a>
<a name="ln1637">                        cf.mag = _mmag;</a>
<a name="ln1638">                  }</a>
<a name="ln1639">            }</a>
<a name="ln1640">#endif</a>
<a name="ln1641">      }</a>
<a name="ln1642"> </a>
<a name="ln1643">//---------------------------------------------------------</a>
<a name="ln1644">//   read</a>
<a name="ln1645">//---------------------------------------------------------</a>
<a name="ln1646"> </a>
<a name="ln1647">void ChordList::read(XmlReader&amp; e)</a>
<a name="ln1648">      {</a>
<a name="ln1649">      int fontIdx = 0;</a>
<a name="ln1650">      _autoAdjust = false;</a>
<a name="ln1651">      while (e.readNextStartElement()) {</a>
<a name="ln1652">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1653">            if (tag == &quot;font&quot;) {</a>
<a name="ln1654">                  ChordFont f;</a>
<a name="ln1655">                  f.family = e.attribute(&quot;family&quot;, &quot;default&quot;);</a>
<a name="ln1656">                  if (f.family == &quot;MuseJazz&quot;)</a>
<a name="ln1657">                        f.family = &quot;MuseJazz Text&quot;;</a>
<a name="ln1658">                  f.mag    = 1.0;</a>
<a name="ln1659">                  f.fontClass = e.attribute(&quot;class&quot;);</a>
<a name="ln1660">                  while (e.readNextStartElement()) {</a>
<a name="ln1661">                        if (e.name() == &quot;sym&quot;) {</a>
<a name="ln1662">                              ChordSymbol cs;</a>
<a name="ln1663">                              QString code;</a>
<a name="ln1664">                              QString symClass;</a>
<a name="ln1665">                              cs.fontIdx = fontIdx;</a>
<a name="ln1666">                              cs.name    = e.attribute(&quot;name&quot;);</a>
<a name="ln1667">                              cs.value   = e.attribute(&quot;value&quot;);</a>
<a name="ln1668">                              code       = e.attribute(&quot;code&quot;);</a>
<a name="ln1669">                              symClass   = e.attribute(&quot;class&quot;);</a>
<a name="ln1670">                              if (code != &quot;&quot;) {</a>
<a name="ln1671">                                    bool ok = true;</a>
<a name="ln1672">                                    int val = code.toInt(&amp;ok, 0);</a>
<a name="ln1673">                                    if (!ok) {</a>
<a name="ln1674">                                          cs.code = 0;</a>
<a name="ln1675">                                          cs.value = code;</a>
<a name="ln1676">                                          }</a>
<a name="ln1677">                                    else if (val &amp; 0xffff0000) {</a>
<a name="ln1678">                                          cs.code = 0;</a>
<a name="ln1679">                                          QChar high = QChar(QChar::highSurrogate(val));</a>
<a name="ln1680">                                          QChar low = QChar(QChar::lowSurrogate(val));</a>
<a name="ln1681">                                          cs.value = QString(&quot;%1%2&quot;).arg(high).arg(low);</a>
<a name="ln1682">                                          }</a>
<a name="ln1683">                                    else {</a>
<a name="ln1684">                                          cs.code = val;</a>
<a name="ln1685">                                          cs.value = QString(cs.code);</a>
<a name="ln1686">                                          }</a>
<a name="ln1687">                                    }</a>
<a name="ln1688">                              else</a>
<a name="ln1689">                                    cs.code = 0;</a>
<a name="ln1690">                              if (cs.value == &quot;&quot;)</a>
<a name="ln1691">                                    cs.value = cs.name;</a>
<a name="ln1692">                              cs.name = symClass + cs.name;</a>
<a name="ln1693">                              symbols.insert(cs.name, cs);</a>
<a name="ln1694">                              e.readNext();</a>
<a name="ln1695">                              }</a>
<a name="ln1696">                        else if (e.name() == &quot;mag&quot;)</a>
<a name="ln1697">                              f.mag = e.readDouble();</a>
<a name="ln1698">                        else</a>
<a name="ln1699">                              e.unknown();</a>
<a name="ln1700">                        }</a>
<a name="ln1701">                  if (_autoAdjust) {</a>
<a name="ln1702">                        if (f.fontClass == &quot;extension&quot;)</a>
<a name="ln1703">                              f.mag *= _emag;</a>
<a name="ln1704">                        else if (f.fontClass == &quot;modifier&quot;)</a>
<a name="ln1705">                              f.mag *= _mmag;</a>
<a name="ln1706">                        }</a>
<a name="ln1707">                  fonts.append(f);</a>
<a name="ln1708">                  ++fontIdx;</a>
<a name="ln1709">                  }</a>
<a name="ln1710">            else if (tag == &quot;autoAdjust&quot;) {</a>
<a name="ln1711">                  QString nmag = e.attribute(&quot;mag&quot;);</a>
<a name="ln1712">                  _nmag = nmag.toDouble();</a>
<a name="ln1713">                  QString nadjust = e.attribute(&quot;adjust&quot;);</a>
<a name="ln1714">                  _nadjust = nadjust.toDouble();</a>
<a name="ln1715">                  _autoAdjust = e.readBool();</a>
<a name="ln1716">                  }</a>
<a name="ln1717">            else if (tag == &quot;token&quot;) {</a>
<a name="ln1718">                  ChordToken t;</a>
<a name="ln1719">                  t.read(e);</a>
<a name="ln1720">                  chordTokenList.append(t);</a>
<a name="ln1721">                  }</a>
<a name="ln1722">            else if (tag == &quot;chord&quot;) {</a>
<a name="ln1723">                  int id = e.intAttribute(&quot;id&quot;);</a>
<a name="ln1724">                  // if no id attribute (id == 0), then assign it a private id</a>
<a name="ln1725">                  // user chords that match these ChordDescriptions will be treated as normal recognized chords</a>
<a name="ln1726">                  // except that the id will not be written to the score file</a>
<a name="ln1727">                  ChordDescription cd = (id &amp;&amp; contains(id)) ? take(id) : ChordDescription(id);</a>
<a name="ln1728"> </a>
<a name="ln1729">                  // record updated id</a>
<a name="ln1730">                  id = cd.id;</a>
<a name="ln1731">                  // read rest of description</a>
<a name="ln1732">                  cd.read(e);</a>
<a name="ln1733">                  // restore updated id</a>
<a name="ln1734">                  cd.id = id;</a>
<a name="ln1735">                  // throw away previously parsed chords</a>
<a name="ln1736">                  cd.parsedChords.clear();</a>
<a name="ln1737">                  // generate any missing info (including new parsed chords)</a>
<a name="ln1738">                  cd.complete(0,this);</a>
<a name="ln1739">                  // add to list</a>
<a name="ln1740">                  insert(id, cd);</a>
<a name="ln1741">                  }</a>
<a name="ln1742">            else if (tag == &quot;renderRoot&quot;)</a>
<a name="ln1743">                  readRenderList(e.readElementText(), renderListRoot);</a>
<a name="ln1744">            else if (tag == &quot;renderFunction&quot;)</a>
<a name="ln1745">                  readRenderList(e.readElementText(), renderListFunction);</a>
<a name="ln1746">            else if (tag == &quot;renderBase&quot;)</a>
<a name="ln1747">                  readRenderList(e.readElementText(), renderListBase);</a>
<a name="ln1748">            else</a>
<a name="ln1749">                  e.unknown();</a>
<a name="ln1750">            }</a>
<a name="ln1751">      }</a>
<a name="ln1752"> </a>
<a name="ln1753">//---------------------------------------------------------</a>
<a name="ln1754">//   write</a>
<a name="ln1755">//---------------------------------------------------------</a>
<a name="ln1756"> </a>
<a name="ln1757">void ChordList::write(XmlWriter&amp; xml) const</a>
<a name="ln1758">      {</a>
<a name="ln1759">      int fontIdx = 0;</a>
<a name="ln1760">      for (ChordFont f : fonts) {</a>
<a name="ln1761">            xml.stag(QString(&quot;font id=\&quot;%1\&quot; family=\&quot;%2\&quot;&quot;).arg(fontIdx).arg(f.family));</a>
<a name="ln1762">            xml.tag(&quot;mag&quot;, f.mag);</a>
<a name="ln1763">            for (ChordSymbol s : symbols) {</a>
<a name="ln1764">                  if (s.fontIdx == fontIdx) {</a>
<a name="ln1765">                        if (s.code.isNull())</a>
<a name="ln1766">                              xml.tagE(QString(&quot;sym name=\&quot;%1\&quot; value=\&quot;%2\&quot;&quot;).arg(s.name).arg(s.value));</a>
<a name="ln1767">                        else</a>
<a name="ln1768">                              xml.tagE(QString(&quot;sym name=\&quot;%1\&quot; code=\&quot;0x%2\&quot;&quot;).arg(s.name).arg(s.code.unicode(),0,16));</a>
<a name="ln1769">                        }</a>
<a name="ln1770">                  }</a>
<a name="ln1771">            xml.etag();</a>
<a name="ln1772">            ++fontIdx;</a>
<a name="ln1773">            }</a>
<a name="ln1774">      if (_autoAdjust)</a>
<a name="ln1775">            xml.tagE(QString(&quot;autoAdjust mag=\&quot;%1\&quot; adjust=\&quot;%2\&quot;&quot;).arg(_nmag).arg(_nadjust));</a>
<a name="ln1776">      foreach (ChordToken t, chordTokenList)</a>
<a name="ln1777">            t.write(xml);</a>
<a name="ln1778">      if (!renderListRoot.empty())</a>
<a name="ln1779">            writeRenderList(xml, &amp;renderListRoot, &quot;renderRoot&quot;);</a>
<a name="ln1780">      if (!renderListFunction.empty())</a>
<a name="ln1781">            writeRenderList(xml, &amp;renderListRoot, &quot;renderFunction&quot;);</a>
<a name="ln1782">      if (!renderListBase.empty())</a>
<a name="ln1783">            writeRenderList(xml, &amp;renderListBase, &quot;renderBase&quot;);</a>
<a name="ln1784">      for (const ChordDescription&amp; cd : *this)</a>
<a name="ln1785">            cd.write(xml);</a>
<a name="ln1786">      }</a>
<a name="ln1787"> </a>
<a name="ln1788">//---------------------------------------------------------</a>
<a name="ln1789">//   read</a>
<a name="ln1790">//    read Chord List, return false on error</a>
<a name="ln1791">//---------------------------------------------------------</a>
<a name="ln1792"> </a>
<a name="ln1793">bool ChordList::read(const QString&amp; name)</a>
<a name="ln1794">      {</a>
<a name="ln1795">//      qDebug(&quot;ChordList::read &lt;%s&gt;&quot;, qPrintable(name));</a>
<a name="ln1796">      QString path;</a>
<a name="ln1797">      QFileInfo ftest(name);</a>
<a name="ln1798">      if (ftest.isAbsolute())</a>
<a name="ln1799">            path = name;</a>
<a name="ln1800">      else {</a>
<a name="ln1801">#if defined(Q_OS_IOS)</a>
<a name="ln1802">            path = QString(&quot;%1/%2&quot;).arg(MScore::globalShare()).arg(name);</a>
<a name="ln1803">#elif defined(Q_OS_ANDROID)</a>
<a name="ln1804">            path = QString(&quot;:/styles/%1&quot;).arg(name);</a>
<a name="ln1805">#else</a>
<a name="ln1806">            path = QString(&quot;%1styles/%2&quot;).arg(MScore::globalShare()).arg(name);</a>
<a name="ln1807">#endif</a>
<a name="ln1808">            }</a>
<a name="ln1809">      // default to chords_std.xml</a>
<a name="ln1810">      QFileInfo fi(path);</a>
<a name="ln1811">      if (!fi.exists())</a>
<a name="ln1812">#if defined(Q_OS_IOS)</a>
<a name="ln1813">            path = QString(&quot;%1/%2&quot;).arg(MScore::globalShare()).arg(&quot;chords_std.xml&quot;);</a>
<a name="ln1814">#elif defined(Q_OS_ANDROID)</a>
<a name="ln1815">            path = QString(&quot;:/styles/chords_std.xml&quot;);</a>
<a name="ln1816">#else</a>
<a name="ln1817">            path = QString(&quot;%1styles/%2&quot;).arg(MScore::globalShare()).arg(&quot;chords_std.xml&quot;);</a>
<a name="ln1818">#endif</a>
<a name="ln1819"> </a>
<a name="ln1820">      if (name.isEmpty())</a>
<a name="ln1821">            return false;</a>
<a name="ln1822">      QFile f(path);</a>
<a name="ln1823">      if (!f.open(QIODevice::ReadOnly)) {</a>
<a name="ln1824">            MScore::lastError = QObject::tr(&quot;Cannot open chord description:\n%1\n%2&quot;).arg(f.fileName()).arg(f.errorString());</a>
<a name="ln1825">            qDebug(&quot;ChordList::read failed: &lt;%s&gt;&quot;, qPrintable(path));</a>
<a name="ln1826">            return false;</a>
<a name="ln1827">            }</a>
<a name="ln1828">      XmlReader e(&amp;f);</a>
<a name="ln1829"> </a>
<a name="ln1830">      while (e.readNextStartElement()) {</a>
<a name="ln1831">            if (e.name() == &quot;museScore&quot;) {</a>
<a name="ln1832">                  // QString version = e.attribute(QString(&quot;version&quot;));</a>
<a name="ln1833">                  // QStringList sl = version.split('.');</a>
<a name="ln1834">                  // int _mscVersion = sl[0].toInt() * 100 + sl[1].toInt();</a>
<a name="ln1835">                  read(e);</a>
<a name="ln1836">                  return true;</a>
<a name="ln1837">                  }</a>
<a name="ln1838">            }</a>
<a name="ln1839">      return false;</a>
<a name="ln1840">      }</a>
<a name="ln1841"> </a>
<a name="ln1842">//---------------------------------------------------------</a>
<a name="ln1843">//   writeChordList</a>
<a name="ln1844">//---------------------------------------------------------</a>
<a name="ln1845"> </a>
<a name="ln1846">bool ChordList::write(const QString&amp; name) const</a>
<a name="ln1847">      {</a>
<a name="ln1848">      QFileInfo info(name);</a>
<a name="ln1849"> </a>
<a name="ln1850">      if (info.suffix().isEmpty()) {</a>
<a name="ln1851">            QString path = info.filePath();</a>
<a name="ln1852">            path += QString(&quot;.xml&quot;);</a>
<a name="ln1853">            info.setFile(path);</a>
<a name="ln1854">            }</a>
<a name="ln1855"> </a>
<a name="ln1856">      QFile f(info.filePath());</a>
<a name="ln1857"> </a>
<a name="ln1858">      if (!f.open(QIODevice::WriteOnly)) {</a>
<a name="ln1859">            MScore::lastError = QObject::tr(&quot;Open chord description\n%1\nfailed: %2&quot;).arg(f.fileName()).arg(f.errorString());</a>
<a name="ln1860">            return false;</a>
<a name="ln1861">            }</a>
<a name="ln1862"> </a>
<a name="ln1863">      XmlWriter xml(0, &amp;f);</a>
<a name="ln1864">      xml.header();</a>
<a name="ln1865">      xml.stag(&quot;museScore version=\&quot;&quot; MSC_VERSION &quot;\&quot;&quot;);</a>
<a name="ln1866"> </a>
<a name="ln1867">      write(xml);</a>
<a name="ln1868">      xml.etag();</a>
<a name="ln1869">      if (f.error() != QFile::NoError) {</a>
<a name="ln1870">            MScore::lastError = QObject::tr(&quot;Write chord description failed: %1&quot;).arg(f.errorString());</a>
<a name="ln1871">            }</a>
<a name="ln1872">      return true;</a>
<a name="ln1873">      }</a>
<a name="ln1874"> </a>
<a name="ln1875">//---------------------------------------------------------</a>
<a name="ln1876">//   loaded</a>
<a name="ln1877">//---------------------------------------------------------</a>
<a name="ln1878"> </a>
<a name="ln1879">bool ChordList::loaded() const</a>
<a name="ln1880">      {</a>
<a name="ln1881">      // track whether a description file has been loaded</a>
<a name="ln1882">      // since chords.xml really doesn't load enough to stand alone,</a>
<a name="ln1883">      // we need a way to track when a &quot;real&quot; chord list has been loaded</a>
<a name="ln1884">      // for lack of anything better, key off renderListRoot</a>
<a name="ln1885">      return !renderListRoot.empty();</a>
<a name="ln1886">      }</a>
<a name="ln1887"> </a>
<a name="ln1888">//---------------------------------------------------------</a>
<a name="ln1889">//   unload</a>
<a name="ln1890">//---------------------------------------------------------</a>
<a name="ln1891"> </a>
<a name="ln1892">void ChordList::unload()</a>
<a name="ln1893">      {</a>
<a name="ln1894">      clear();</a>
<a name="ln1895">      symbols.clear();</a>
<a name="ln1896">      fonts.clear();</a>
<a name="ln1897">      renderListRoot.clear();</a>
<a name="ln1898">      renderListBase.clear();</a>
<a name="ln1899">      chordTokenList.clear();</a>
<a name="ln1900">      _autoAdjust = false;</a>
<a name="ln1901">      }</a>
<a name="ln1902"> </a>
<a name="ln1903">//---------------------------------------------------------</a>
<a name="ln1904">//   print</a>
<a name="ln1905">//    only for debugging</a>
<a name="ln1906">//---------------------------------------------------------</a>
<a name="ln1907"> </a>
<a name="ln1908">void RenderAction::print() const</a>
<a name="ln1909">      {</a>
<a name="ln1910">      static const char* names[] = {</a>
<a name="ln1911">            &quot;SET&quot;, &quot;MOVE&quot;, &quot;PUSH&quot;, &quot;POP&quot;,</a>
<a name="ln1912">            &quot;NOTE&quot;, &quot;ACCIDENTAL&quot;</a>
<a name="ln1913">            };</a>
<a name="ln1914">      qDebug(&quot;%10s &lt;%s&gt; %f %f&quot;, names[int(type)], qPrintable(text), movex, movey);</a>
<a name="ln1915">      }</a>
<a name="ln1916"> </a>
<a name="ln1917"> </a>
<a name="ln1918">}</a>

</code></pre>
<div class="balloon" rel="233"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="1145"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="1418"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'cl' pointer was utilized before it was verified against nullptr. Check lines: 1418, 1425.</p></div>
<div class="balloon" rel="1825"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
