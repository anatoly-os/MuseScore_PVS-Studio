
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>palette.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2011 Werner Schweer and others</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENSE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;palette.h&quot;</a>
<a name="ln14">#include &quot;musescore.h&quot;</a>
<a name="ln15">#include &quot;libmscore/element.h&quot;</a>
<a name="ln16">#include &quot;libmscore/style.h&quot;</a>
<a name="ln17">#include &quot;globals.h&quot;</a>
<a name="ln18">#include &quot;libmscore/sym.h&quot;</a>
<a name="ln19">#include &quot;libmscore/symbol.h&quot;</a>
<a name="ln20">#include &quot;libmscore/score.h&quot;</a>
<a name="ln21">#include &quot;libmscore/image.h&quot;</a>
<a name="ln22">#include &quot;libmscore/xml.h&quot;</a>
<a name="ln23">#include &quot;scoreview.h&quot;</a>
<a name="ln24">#include &quot;libmscore/note.h&quot;</a>
<a name="ln25">#include &quot;libmscore/chord.h&quot;</a>
<a name="ln26">#include &quot;libmscore/clef.h&quot;</a>
<a name="ln27">#include &quot;libmscore/segment.h&quot;</a>
<a name="ln28">#include &quot;libmscore/measure.h&quot;</a>
<a name="ln29">#include &quot;libmscore/staff.h&quot;</a>
<a name="ln30">#include &quot;libmscore/system.h&quot;</a>
<a name="ln31">#include &quot;libmscore/page.h&quot;</a>
<a name="ln32">#include &quot;libmscore/keysig.h&quot;</a>
<a name="ln33">#include &quot;libmscore/timesig.h&quot;</a>
<a name="ln34">#include &quot;preferences.h&quot;</a>
<a name="ln35">#include &quot;seq.h&quot;</a>
<a name="ln36">#include &quot;libmscore/part.h&quot;</a>
<a name="ln37">#include &quot;libmscore/textline.h&quot;</a>
<a name="ln38">#include &quot;libmscore/measure.h&quot;</a>
<a name="ln39">#include &quot;libmscore/icon.h&quot;</a>
<a name="ln40">#include &quot;libmscore/mscore.h&quot;</a>
<a name="ln41">#include &quot;libmscore/imageStore.h&quot;</a>
<a name="ln42">#include &quot;thirdparty/qzip/qzipreader_p.h&quot;</a>
<a name="ln43">#include &quot;thirdparty/qzip/qzipwriter_p.h&quot;</a>
<a name="ln44">#include &quot;libmscore/slur.h&quot;</a>
<a name="ln45">#include &quot;shortcut.h&quot;</a>
<a name="ln46">#include &quot;tourhandler.h&quot;</a>
<a name="ln47">#include &quot;script/recorderwidget.h&quot;</a>
<a name="ln48">#include &quot;libmscore/fret.h&quot;</a>
<a name="ln49">#include &quot;scoreaccessibility.h&quot;</a>
<a name="ln50"> </a>
<a name="ln51">namespace Ms {</a>
<a name="ln52"> </a>
<a name="ln53">//---------------------------------------------------------</a>
<a name="ln54">//   needsStaff</a>
<a name="ln55">//    should a staff been drawn if e is used as icon in</a>
<a name="ln56">//    a palette</a>
<a name="ln57">//---------------------------------------------------------</a>
<a name="ln58"> </a>
<a name="ln59">static bool needsStaff(Element* e)</a>
<a name="ln60">      {</a>
<a name="ln61">      if (e == 0)</a>
<a name="ln62">            return false;</a>
<a name="ln63">      switch(e-&gt;type()) {</a>
<a name="ln64">            case ElementType::CHORD:</a>
<a name="ln65">            case ElementType::BAR_LINE:</a>
<a name="ln66">            case ElementType::CLEF:</a>
<a name="ln67">            case ElementType::KEYSIG:</a>
<a name="ln68">            case ElementType::TIMESIG:</a>
<a name="ln69">            case ElementType::REST:</a>
<a name="ln70">            case ElementType::BAGPIPE_EMBELLISHMENT:</a>
<a name="ln71">                  return true;</a>
<a name="ln72">            default:</a>
<a name="ln73">                  return false;</a>
<a name="ln74">            }</a>
<a name="ln75">      }</a>
<a name="ln76"> </a>
<a name="ln77">//---------------------------------------------------------</a>
<a name="ln78">//   Palette</a>
<a name="ln79">//---------------------------------------------------------</a>
<a name="ln80"> </a>
<a name="ln81">Palette::Palette(QWidget* parent)</a>
<a name="ln82">   : QWidget(parent)</a>
<a name="ln83">      {</a>
<a name="ln84">      extraMag      = 1.0;</a>
<a name="ln85">      currentIdx    = -1;</a>
<a name="ln86">      dragIdx       = -1;</a>
<a name="ln87">      selectedIdx   = -1;</a>
<a name="ln88">      _yOffset      = 0.0;</a>
<a name="ln89">      setGrid(50, 60);</a>
<a name="ln90">      _drawGrid     = false;</a>
<a name="ln91">      _selectable   = false;</a>
<a name="ln92">      setMouseTracking(true);</a>
<a name="ln93">      setReadOnly(false);</a>
<a name="ln94">      setSystemPalette(false);</a>
<a name="ln95">      _moreElements = false;</a>
<a name="ln96">      setSizePolicy(QSizePolicy::MinimumExpanding, QSizePolicy::Ignored);</a>
<a name="ln97">      setObjectName(&quot;palette-cells&quot;);</a>
<a name="ln98">      }</a>
<a name="ln99"> </a>
<a name="ln100">Palette::Palette(std::unique_ptr&lt;PalettePanel&gt; pp, QWidget* parent)</a>
<a name="ln101">   : Palette(parent)</a>
<a name="ln102">      {</a>
<a name="ln103">      setName(pp-&gt;name());</a>
<a name="ln104">      const QSize gridSize = pp-&gt;gridSize();</a>
<a name="ln105">      setGrid(gridSize.width(), gridSize.height());</a>
<a name="ln106">      setMag(pp-&gt;mag());</a>
<a name="ln107">      setDrawGrid(pp-&gt;drawGrid());</a>
<a name="ln108">      setMoreElements(pp-&gt;moreElements());</a>
<a name="ln109"> </a>
<a name="ln110">      const auto allCells = pp-&gt;takeCells(0, pp-&gt;ncells());</a>
<a name="ln111">      for (const PaletteCellPtr&amp; cell : allCells) {</a>
<a name="ln112">            Element* e = cell.unique() ? cell-&gt;element.release() : (cell-&gt;element ? cell-&gt;element-&gt;clone() : nullptr);</a>
<a name="ln113">            if (e) {</a>
<a name="ln114">                  PaletteCell* newCell = append(e, cell-&gt;name, cell-&gt;tag, cell-&gt;mag);</a>
<a name="ln115">                  newCell-&gt;drawStaff = cell-&gt;drawStaff;</a>
<a name="ln116">                  newCell-&gt;xoffset = cell-&gt;xoffset;</a>
<a name="ln117">                  newCell-&gt;yoffset = cell-&gt;yoffset;</a>
<a name="ln118">                  newCell-&gt;readOnly = cell-&gt;readOnly;</a>
<a name="ln119">                  }</a>
<a name="ln120">            }</a>
<a name="ln121"> </a>
<a name="ln122">      if (moreElements())</a>
<a name="ln123">            connect(this, SIGNAL(displayMore(const QString&amp;)), mscore, SLOT(showMasterPalette(const QString&amp;)));</a>
<a name="ln124">      }</a>
<a name="ln125"> </a>
<a name="ln126">Palette::~Palette()</a>
<a name="ln127">      {</a>
<a name="ln128">      for (PaletteCell* cell : cells)</a>
<a name="ln129">            delete cell;</a>
<a name="ln130">      }</a>
<a name="ln131"> </a>
<a name="ln132">//---------------------------------------------------------</a>
<a name="ln133">//   resizeEvent</a>
<a name="ln134">//---------------------------------------------------------</a>
<a name="ln135"> </a>
<a name="ln136">void Palette::resizeEvent(QResizeEvent* e)</a>
<a name="ln137">      {</a>
<a name="ln138">      setFixedHeight(heightForWidth(e-&gt;size().width()));</a>
<a name="ln139">      }</a>
<a name="ln140"> </a>
<a name="ln141">//---------------------------------------------------------</a>
<a name="ln142">//   filter</a>
<a name="ln143">///  return true if all filtered</a>
<a name="ln144">//---------------------------------------------------------</a>
<a name="ln145"> </a>
<a name="ln146">bool Palette::filter(const QString&amp; text)</a>
<a name="ln147">      {</a>
<a name="ln148">      filterActive = false;</a>
<a name="ln149">      setMouseTracking(true);</a>
<a name="ln150">      QString t = text.toLower();</a>
<a name="ln151">      bool res = true;</a>
<a name="ln152">      dragCells.clear();</a>
<a name="ln153">      // if palette name is searched for, display all elements in the palette</a>
<a name="ln154">      if (_name.startsWith(t, Qt::CaseInsensitive)) {</a>
<a name="ln155">            PaletteCell* c  = cells.first();</a>
<a name="ln156">            for (PaletteCell* cell : cells)</a>
<a name="ln157">                  dragCells.append(cell);</a>
<a name="ln158"> </a>
<a name="ln159">            bool contains = t.isEmpty() || c;</a>
<a name="ln160">            if (!contains)</a>
<a name="ln161">                  filterActive = true;</a>
<a name="ln162">            if (contains &amp;&amp; res)</a>
<a name="ln163">                  res = false;</a>
<a name="ln164">            }</a>
<a name="ln165"> </a>
<a name="ln166">      for (PaletteCell* cell : cells) {</a>
<a name="ln167">            QStringList h = cell-&gt;name.toLower().split(&quot; &quot;);</a>
<a name="ln168">            bool c        = false;</a>
<a name="ln169">            QStringList n = t.split(&quot; &quot;);</a>
<a name="ln170">            for (QString hs : h) {</a>
<a name="ln171">                  for (QString ns : n) {</a>
<a name="ln172">                        if (!ns.trimmed().isEmpty())</a>
<a name="ln173">                              c = hs.trimmed().startsWith(ns.trimmed());</a>
<a name="ln174">                        }</a>
<a name="ln175">                  if (c)</a>
<a name="ln176">                        break;</a>
<a name="ln177">                  }</a>
<a name="ln178">            if (t.isEmpty() || c)</a>
<a name="ln179">                  dragCells.append(cell);</a>
<a name="ln180">            bool contains = t.isEmpty() || c;</a>
<a name="ln181">            if (!contains)</a>
<a name="ln182">                  filterActive = true;</a>
<a name="ln183">            if (contains &amp;&amp; res)</a>
<a name="ln184">                  res = false;</a>
<a name="ln185">            }</a>
<a name="ln186">      setFixedHeight(heightForWidth(width()));</a>
<a name="ln187">      updateGeometry();</a>
<a name="ln188">      return res;</a>
<a name="ln189">      }</a>
<a name="ln190"> </a>
<a name="ln191">//---------------------------------------------------------</a>
<a name="ln192">//   setMoreElements</a>
<a name="ln193">//---------------------------------------------------------</a>
<a name="ln194"> </a>
<a name="ln195">void Palette::setMoreElements(bool val)</a>
<a name="ln196">      {</a>
<a name="ln197">      _moreElements = val;</a>
<a name="ln198">      if (val &amp;&amp; (cells.isEmpty() || cells.back()-&gt;tag != &quot;ShowMore&quot;)) {</a>
<a name="ln199">            PaletteCell* cell = new PaletteCell;</a>
<a name="ln200">            cell-&gt;name      = tr(&quot;Show More&quot;);</a>
<a name="ln201">            cell-&gt;tag       = &quot;ShowMore&quot;;</a>
<a name="ln202">            cells.append(cell);</a>
<a name="ln203">            }</a>
<a name="ln204">      else if (!val &amp;&amp; !cells.isEmpty() &amp;&amp; (cells.last()-&gt;tag == &quot;ShowMore&quot;) ) {</a>
<a name="ln205">            PaletteCell* cell = cells.takeLast();</a>
<a name="ln206">            delete cell;</a>
<a name="ln207">            }</a>
<a name="ln208">      }</a>
<a name="ln209"> </a>
<a name="ln210">//---------------------------------------------------------</a>
<a name="ln211">//   setSystemPalette</a>
<a name="ln212">//---------------------------------------------------------</a>
<a name="ln213"> </a>
<a name="ln214">void Palette::setSystemPalette(bool val)</a>
<a name="ln215">      {</a>
<a name="ln216">      _systemPalette = val;</a>
<a name="ln217">      if (val)</a>
<a name="ln218">            setReadOnly(true);</a>
<a name="ln219">      }</a>
<a name="ln220"> </a>
<a name="ln221">//---------------------------------------------------------</a>
<a name="ln222">//   setReadOnly</a>
<a name="ln223">//---------------------------------------------------------</a>
<a name="ln224"> </a>
<a name="ln225">void Palette::setReadOnly(bool val)</a>
<a name="ln226">      {</a>
<a name="ln227">      _readOnly = val;</a>
<a name="ln228">      setAcceptDrops(!val);</a>
<a name="ln229">      }</a>
<a name="ln230"> </a>
<a name="ln231">//---------------------------------------------------------</a>
<a name="ln232">//   setMag</a>
<a name="ln233">//---------------------------------------------------------</a>
<a name="ln234"> </a>
<a name="ln235">void Palette::setMag(qreal val)</a>
<a name="ln236">      {</a>
<a name="ln237">      extraMag = val;</a>
<a name="ln238">      }</a>
<a name="ln239"> </a>
<a name="ln240">//---------------------------------------------------------</a>
<a name="ln241">//   guiMag</a>
<a name="ln242">//---------------------------------------------------------</a>
<a name="ln243"> </a>
<a name="ln244">qreal Palette::guiMag()</a>
<a name="ln245">      {</a>
<a name="ln246">      qreal pref = preferences.getDouble(PREF_APP_PALETTESCALE);</a>
<a name="ln247">      if (guiScaling &lt;= 1.0)                    // low DPI: target is 100% life size</a>
<a name="ln248">            return pref * guiScaling;</a>
<a name="ln249">      else if (guiScaling &gt; 1.33)               // high DPI: target is 75% life size</a>
<a name="ln250">            return pref * guiScaling * 0.75;</a>
<a name="ln251">      else                                      // medium high DPI: no target, scaling dependent on resolution</a>
<a name="ln252">            return pref;                        // (will be 75-100% range)</a>
<a name="ln253">      }</a>
<a name="ln254"> </a>
<a name="ln255">//---------------------------------------------------------</a>
<a name="ln256">//   contextMenuEvent</a>
<a name="ln257">//---------------------------------------------------------</a>
<a name="ln258"> </a>
<a name="ln259">void Palette::contextMenuEvent(QContextMenuEvent* event)</a>
<a name="ln260">      {</a>
<a name="ln261">      if (!_showContextMenu)</a>
<a name="ln262">            return;</a>
<a name="ln263">      int i = idx(event-&gt;pos());</a>
<a name="ln264">      if (i == -1) {</a>
<a name="ln265">            // palette context menu</a>
<a name="ln266">            if (!_moreElements)</a>
<a name="ln267">                  return;</a>
<a name="ln268">            QMenu menu;</a>
<a name="ln269">            QAction* moreAction = menu.addAction(tr(&quot;More Elements…&quot;));</a>
<a name="ln270">            moreAction-&gt;setEnabled(_moreElements);</a>
<a name="ln271">            QAction* action = menu.exec(mapToGlobal(event-&gt;pos()));</a>
<a name="ln272">            if (action == moreAction)</a>
<a name="ln273">                  emit displayMore(_name);</a>
<a name="ln274">            return;</a>
<a name="ln275">            }</a>
<a name="ln276"> </a>
<a name="ln277">      QMenu menu;</a>
<a name="ln278">      QAction* deleteCellAction   = menu.addAction(tr(&quot;Delete&quot;));</a>
<a name="ln279">      QAction* contextAction = menu.addAction(tr(&quot;Properties…&quot;));</a>
<a name="ln280">      deleteCellAction-&gt;setEnabled(!_readOnly);</a>
<a name="ln281">      contextAction-&gt;setEnabled(!_readOnly);</a>
<a name="ln282">      QAction* moreAction    = menu.addAction(tr(&quot;More Elements…&quot;));</a>
<a name="ln283">      moreAction-&gt;setEnabled(_moreElements);</a>
<a name="ln284"> </a>
<a name="ln285">      if (filterActive || (cellAt(i) &amp;&amp; cellAt(i)-&gt;readOnly))</a>
<a name="ln286">            deleteCellAction-&gt;setEnabled(false);</a>
<a name="ln287"> </a>
<a name="ln288">      if (!deleteCellAction-&gt;isEnabled() &amp;&amp; !contextAction-&gt;isEnabled() &amp;&amp; !moreAction-&gt;isEnabled())</a>
<a name="ln289">            return;</a>
<a name="ln290"> </a>
<a name="ln291">      const QAction* action = menu.exec(mapToGlobal(event-&gt;pos()));</a>
<a name="ln292"> </a>
<a name="ln293">      if (action == deleteCellAction) {</a>
<a name="ln294">            PaletteCell* cell = cellAt(i);</a>
<a name="ln295">            if (cell) {</a>
<a name="ln296">                  int ret = QMessageBox::warning(this, QWidget::tr(&quot;Delete palette cell&quot;),</a>
<a name="ln297">                                                 QWidget::tr(&quot;Are you sure you want to delete palette cell \&quot;%1\&quot;?&quot;)</a>
<a name="ln298">                                                 .arg(cell-&gt;name), QMessageBox::Yes | QMessageBox::No,</a>
<a name="ln299">                                                 QMessageBox::Yes);</a>
<a name="ln300">                  if (ret != QMessageBox::Yes)</a>
<a name="ln301">                        return;</a>
<a name="ln302">                  if(cell-&gt;tag == &quot;ShowMore&quot;)</a>
<a name="ln303">                        _moreElements = false;</a>
<a name="ln304">                  delete cell;</a>
<a name="ln305">                  }</a>
<a name="ln306">            cells[i] = nullptr;</a>
<a name="ln307">            emit changed();</a>
<a name="ln308">            }</a>
<a name="ln309">      else if (action == contextAction) {</a>
<a name="ln310">            //disable due to the new implementation</a>
<a name="ln311">            /*PaletteCell* c = cellAt(i);</a>
<a name="ln312">            if (c == 0)</a>
<a name="ln313">                  return;</a>
<a name="ln314">            PaletteCellProperties props(c);</a>
<a name="ln315">            if (props.exec())</a>
<a name="ln316">                  emit changed();*/</a>
<a name="ln317">            }</a>
<a name="ln318">      else if (moreAction &amp;&amp; (action == moreAction))</a>
<a name="ln319">            emit displayMore(_name);</a>
<a name="ln320"> </a>
<a name="ln321">      bool sizeChanged = false;</a>
<a name="ln322">      for (int j = 0; j &lt; cells.size(); ++j) {</a>
<a name="ln323">            if (!cellAt(j)) {</a>
<a name="ln324">                  cells.removeAt(j);</a>
<a name="ln325">                  sizeChanged = true;</a>
<a name="ln326">                  }</a>
<a name="ln327">            }</a>
<a name="ln328">      if (sizeChanged) {</a>
<a name="ln329">            setFixedHeight(heightForWidth(width()));</a>
<a name="ln330">            updateGeometry();</a>
<a name="ln331">            }</a>
<a name="ln332">      update();</a>
<a name="ln333">      }</a>
<a name="ln334"> </a>
<a name="ln335">//---------------------------------------------------------</a>
<a name="ln336">//   setGrid</a>
<a name="ln337">//---------------------------------------------------------</a>
<a name="ln338"> </a>
<a name="ln339">void Palette::setGrid(int hh, int vv)</a>
<a name="ln340">      {</a>
<a name="ln341">      hgrid = hh;</a>
<a name="ln342">      vgrid = vv;</a>
<a name="ln343">      QSize s(hgrid, vgrid);</a>
<a name="ln344">      s *= guiMag();</a>
<a name="ln345">      setSizeIncrement(s);</a>
<a name="ln346">      setBaseSize(s);</a>
<a name="ln347">      setMinimumSize(s);</a>
<a name="ln348">      updateGeometry();</a>
<a name="ln349">      }</a>
<a name="ln350"> </a>
<a name="ln351">//---------------------------------------------------------</a>
<a name="ln352">//   element</a>
<a name="ln353">//---------------------------------------------------------</a>
<a name="ln354"> </a>
<a name="ln355">Element* Palette::element(int idx)</a>
<a name="ln356">      {</a>
<a name="ln357">      if (idx &lt; size() &amp;&amp; cellAt(idx))</a>
<a name="ln358">            return cellAt(idx)-&gt;element.get();</a>
<a name="ln359">      else</a>
<a name="ln360">            return 0;</a>
<a name="ln361">      }</a>
<a name="ln362"> </a>
<a name="ln363">//---------------------------------------------------------</a>
<a name="ln364">//   mousePressEvent</a>
<a name="ln365">//---------------------------------------------------------</a>
<a name="ln366"> </a>
<a name="ln367">void Palette::mousePressEvent(QMouseEvent* ev)</a>
<a name="ln368">      {</a>
<a name="ln369">      dragStartPosition = ev-&gt;pos();</a>
<a name="ln370">      dragIdx           = idx(dragStartPosition);</a>
<a name="ln371"> </a>
<a name="ln372">      pressedIndex = dragIdx;</a>
<a name="ln373"> </a>
<a name="ln374">/*</a>
<a name="ln375">      // Take out of edit mode to prevent crashes when adding</a>
<a name="ln376">      // elements from palette</a>
<a name="ln377"> </a>
<a name="ln378">      ScoreView* cv = mscore-&gt;currentScoreView();</a>
<a name="ln379">      if (cv &amp;&amp; cv-&gt;editMode())</a>
<a name="ln380">            cv-&gt;changeState(ViewState::NORMAL);</a>
<a name="ln381">*/</a>
<a name="ln382">      if (dragIdx == -1)</a>
<a name="ln383">            return;</a>
<a name="ln384">      if (_selectable) {</a>
<a name="ln385">            if (dragIdx != selectedIdx) {</a>
<a name="ln386">                  update(idxRect(dragIdx) | idxRect(selectedIdx));</a>
<a name="ln387">                  selectedIdx = dragIdx;</a>
<a name="ln388">                  }</a>
<a name="ln389">            emit boxClicked(dragIdx);</a>
<a name="ln390">            }</a>
<a name="ln391">      PaletteCell* cell = cellAt(dragIdx);</a>
<a name="ln392">      if (cell &amp;&amp; (cell-&gt;tag == &quot;ShowMore&quot;))</a>
<a name="ln393">            emit displayMore(_name);</a>
<a name="ln394"> </a>
<a name="ln395">      update();</a>
<a name="ln396">      }</a>
<a name="ln397"> </a>
<a name="ln398">//---------------------------------------------------------</a>
<a name="ln399">//   mouseMoveEvent</a>
<a name="ln400">//---------------------------------------------------------</a>
<a name="ln401"> </a>
<a name="ln402">void Palette::mouseMoveEvent(QMouseEvent* ev)</a>
<a name="ln403">      {</a>
<a name="ln404">      if ((currentIdx != -1) &amp;&amp; (dragIdx == currentIdx) &amp;&amp; (ev-&gt;buttons() &amp; Qt::LeftButton)</a>
<a name="ln405">         &amp;&amp; (ev-&gt;pos() - dragStartPosition).manhattanLength() &gt; QApplication::startDragDistance())</a>
<a name="ln406">            {</a>
<a name="ln407">            PaletteCell* cell = cellAt(currentIdx);</a>
<a name="ln408">            if (cell &amp;&amp; cell-&gt;element) {</a>
<a name="ln409">                  QDrag* drag         = new QDrag(this);</a>
<a name="ln410">                  QMimeData* mimeData = new QMimeData;</a>
<a name="ln411">                  const Element* el   = cell-&gt;element.get();</a>
<a name="ln412"> </a>
<a name="ln413">                  mimeData-&gt;setData(mimeSymbolFormat, el-&gt;mimeData(QPointF()));</a>
<a name="ln414">                  drag-&gt;setMimeData(mimeData);</a>
<a name="ln415"> </a>
<a name="ln416">                  drag-&gt;setPixmap(pixmap(currentIdx));</a>
<a name="ln417"> </a>
<a name="ln418">                  QPoint hotsp(drag-&gt;pixmap().rect().bottomRight());</a>
<a name="ln419">                  drag-&gt;setHotSpot(hotsp);</a>
<a name="ln420"> </a>
<a name="ln421">                  Qt::DropActions da;</a>
<a name="ln422">                  if (!(_readOnly || filterActive) &amp;&amp; (ev-&gt;modifiers() &amp; Qt::ShiftModifier)) {</a>
<a name="ln423">                        dragCells = cells;      // backup</a>
<a name="ln424">                        da = Qt::MoveAction;</a>
<a name="ln425">                        }</a>
<a name="ln426">                  else</a>
<a name="ln427">                        da = Qt::CopyAction;</a>
<a name="ln428">                  Qt::DropAction a = drag-&gt;exec(da);</a>
<a name="ln429">                  if (da == Qt::MoveAction &amp;&amp; a != da)</a>
<a name="ln430">                        cells = dragCells;      // restore on a failed move action</a>
<a name="ln431">                  update();</a>
<a name="ln432">                  }</a>
<a name="ln433">            }</a>
<a name="ln434">      else {</a>
<a name="ln435">            currentIdx = idx(ev-&gt;pos());</a>
<a name="ln436">            if (currentIdx != -1 &amp;&amp; cellAt(currentIdx) == 0)</a>
<a name="ln437">                  currentIdx = -1;</a>
<a name="ln438">            update();</a>
<a name="ln439">            }</a>
<a name="ln440">      }</a>
<a name="ln441"> </a>
<a name="ln442">//---------------------------------------------------------</a>
<a name="ln443">//   applyDrop</a>
<a name="ln444">//---------------------------------------------------------</a>
<a name="ln445"> </a>
<a name="ln446">static void applyDrop(Score* score, ScoreView* viewer, Element* target, Element* e, Qt::KeyboardModifiers modifiers, QPointF pt = QPointF())</a>
<a name="ln447">      {</a>
<a name="ln448">      EditData&amp; dropData = viewer-&gt;getEditData();</a>
<a name="ln449">      dropData.pos         = pt.isNull() ? target-&gt;pagePos() : pt;</a>
<a name="ln450">      dropData.dragOffset  = QPointF();</a>
<a name="ln451">      dropData.modifiers   = modifiers;</a>
<a name="ln452">      dropData.dropElement = e;</a>
<a name="ln453"> </a>
<a name="ln454">      if (target-&gt;acceptDrop(dropData)) {</a>
<a name="ln455">            // use same code path as drag&amp;drop</a>
<a name="ln456"> </a>
<a name="ln457">            QByteArray a = e-&gt;mimeData(QPointF());</a>
<a name="ln458">//printf(&quot;&lt;&lt;%s&gt;&gt;\n&quot;, a.data());</a>
<a name="ln459"> </a>
<a name="ln460">            XmlReader n(a);</a>
<a name="ln461">            Fraction duration;  // dummy</a>
<a name="ln462">            QPointF dragOffset;</a>
<a name="ln463">            ElementType type = Element::readType(n, &amp;dragOffset, &amp;duration);</a>
<a name="ln464">            dropData.dropElement = Element::create(type, score);</a>
<a name="ln465"> </a>
<a name="ln466">            dropData.dropElement-&gt;read(n);</a>
<a name="ln467">            dropData.dropElement-&gt;styleChanged();   // update to local style</a>
<a name="ln468"> </a>
<a name="ln469">            Element* el = target-&gt;drop(dropData);</a>
<a name="ln470">            if (el &amp;&amp; !viewer-&gt;noteEntryMode())</a>
<a name="ln471">                  score-&gt;select(el, SelectType::SINGLE, 0);</a>
<a name="ln472">            dropData.dropElement = 0;</a>
<a name="ln473">            }</a>
<a name="ln474">      }</a>
<a name="ln475"> </a>
<a name="ln476">//---------------------------------------------------------</a>
<a name="ln477">//   applyPaletteElement</a>
<a name="ln478">//---------------------------------------------------------</a>
<a name="ln479"> </a>
<a name="ln480">bool Palette::applyPaletteElement(Element* element, Qt::KeyboardModifiers modifiers)</a>
<a name="ln481">      {</a>
<a name="ln482">      Score* score = mscore-&gt;currentScore();</a>
<a name="ln483">      if (score == 0)</a>
<a name="ln484">            return false;</a>
<a name="ln485">      const Selection sel = score-&gt;selection(); // make a copy of selection state before applying the operation.</a>
<a name="ln486">      if (sel.isNone())</a>
<a name="ln487">            return false;</a>
<a name="ln488"> </a>
<a name="ln489">//       Element* element = 0;</a>
<a name="ln490">//       if (cell)</a>
<a name="ln491">//             element = cell-&gt;element.get();</a>
<a name="ln492">      if (element == 0)</a>
<a name="ln493">            return false;</a>
<a name="ln494">      </a>
<a name="ln495">      if (element-&gt;isSpanner())</a>
<a name="ln496">            TourHandler::startTour(&quot;spanner-drop-apply&quot;);</a>
<a name="ln497"> </a>
<a name="ln498">#ifdef MSCORE_UNSTABLE</a>
<a name="ln499">      if (ScriptRecorder* rec = mscore-&gt;getScriptRecorder()) {</a>
<a name="ln500">            if (modifiers == 0)</a>
<a name="ln501">                  rec-&gt;recordPaletteElement(element);</a>
<a name="ln502">            }</a>
<a name="ln503">#endif</a>
<a name="ln504"> </a>
<a name="ln505">      ScoreView* viewer = mscore-&gt;currentScoreView();</a>
<a name="ln506"> </a>
<a name="ln507">      // exit edit mode, to allow for palette element to be applied properly</a>
<a name="ln508">      if (viewer &amp;&amp; viewer-&gt;editMode() &amp;&amp; !(viewer-&gt;mscoreState() &amp; STATE_ALLTEXTUAL_EDIT))</a>
<a name="ln509">            viewer-&gt;changeState(ViewState::NORMAL);</a>
<a name="ln510"> </a>
<a name="ln511">      if (viewer-&gt;mscoreState() != STATE_EDIT</a>
<a name="ln512">         &amp;&amp; viewer-&gt;mscoreState() != STATE_LYRICS_EDIT</a>
<a name="ln513">         &amp;&amp; viewer-&gt;mscoreState() != STATE_HARMONY_FIGBASS_EDIT) { // Already in startCmd in this case</a>
<a name="ln514">            score-&gt;startCmd();</a>
<a name="ln515">            }</a>
<a name="ln516">      if (sel.isList()) {</a>
<a name="ln517">            ChordRest* cr1 = sel.firstChordRest();</a>
<a name="ln518">            ChordRest* cr2 = sel.lastChordRest();</a>
<a name="ln519">            bool addSingle = false;       // add a single line only</a>
<a name="ln520">            if (cr1 &amp;&amp; cr2 == cr1) {</a>
<a name="ln521">                  // one chordrest selected, ok to add line</a>
<a name="ln522">                  addSingle = true;</a>
<a name="ln523">                  }</a>
<a name="ln524">            else if (sel.elements().size() == 2 &amp;&amp; cr1 &amp;&amp; cr2 &amp;&amp; cr1 != cr2) {</a>
<a name="ln525">                  // two chordrests selected</a>
<a name="ln526">                  // must be on same staff in order to add line, except for slur</a>
<a name="ln527">                  if (element-&gt;isSlur() || cr1-&gt;staffIdx() == cr2-&gt;staffIdx())</a>
<a name="ln528">                        addSingle = true;</a>
<a name="ln529">                  }</a>
<a name="ln530">            if (viewer-&gt;mscoreState() == STATE_NOTE_ENTRY_STAFF_DRUM &amp;&amp; element-&gt;isChord()) {</a>
<a name="ln531">                  // use input position rather than selection if possible</a>
<a name="ln532">                  Element* e = score-&gt;inputState().cr();</a>
<a name="ln533">                  if (!e)</a>
<a name="ln534">                        e = sel.elements().first();</a>
<a name="ln535">                  if (e) {</a>
<a name="ln536">                        // get note if selection was full chord</a>
<a name="ln537">                        if (e-&gt;isChord())</a>
<a name="ln538">                              e = toChord(e)-&gt;upNote();</a>
<a name="ln539">                        // use voice of element being added to (otherwise we can might corrupt the measure)</a>
<a name="ln540">                        element-&gt;setTrack(e-&gt;voice());</a>
<a name="ln541">                        applyDrop(score, viewer, e, element, modifiers);</a>
<a name="ln542">                        // continue in same track</a>
<a name="ln543">                        score-&gt;inputState().setTrack(e-&gt;track());</a>
<a name="ln544">                        }</a>
<a name="ln545">                  else</a>
<a name="ln546">                        qDebug(&quot;nowhere to place drum note&quot;);</a>
<a name="ln547">                  }</a>
<a name="ln548">            else if (element-&gt;isLayoutBreak()) {</a>
<a name="ln549">                  LayoutBreak* breakElement = toLayoutBreak(element);</a>
<a name="ln550">                  score-&gt;cmdToggleLayoutBreak(breakElement-&gt;layoutBreakType());</a>
<a name="ln551">                  }</a>
<a name="ln552">            else if (element-&gt;isSlur() &amp;&amp; addSingle) {</a>
<a name="ln553">                  viewer-&gt;cmdAddSlur(toSlur(element));</a>
<a name="ln554">                  }</a>
<a name="ln555">            else if (element-&gt;isSLine() &amp;&amp; !element-&gt;isGlissando() &amp;&amp; addSingle) {</a>
<a name="ln556">                  Segment* startSegment = cr1-&gt;segment();</a>
<a name="ln557">                  Segment* endSegment = cr2-&gt;segment();</a>
<a name="ln558">                  if (element-&gt;type() == ElementType::PEDAL &amp;&amp; cr2 != cr1)</a>
<a name="ln559">                        endSegment = endSegment-&gt;nextCR(cr2-&gt;track());</a>
<a name="ln560">                  // TODO - handle cross-voice selections</a>
<a name="ln561">                  int idx = cr1-&gt;staffIdx();</a>
<a name="ln562"> </a>
<a name="ln563">                  QByteArray a = element-&gt;mimeData(QPointF());</a>
<a name="ln564">//printf(&quot;&lt;&lt;%s&gt;&gt;\n&quot;, a.data());</a>
<a name="ln565">                  XmlReader e(a);</a>
<a name="ln566">                  Fraction duration;  // dummy</a>
<a name="ln567">                  QPointF dragOffset;</a>
<a name="ln568">                  ElementType type = Element::readType(e, &amp;dragOffset, &amp;duration);</a>
<a name="ln569">                  Spanner* spanner = static_cast&lt;Spanner*&gt;(Element::create(type, score));</a>
<a name="ln570">                  spanner-&gt;read(e);</a>
<a name="ln571">                  spanner-&gt;styleChanged();</a>
<a name="ln572">                  score-&gt;cmdAddSpanner(spanner, idx, startSegment, endSegment);</a>
<a name="ln573">                  }</a>
<a name="ln574">            else {</a>
<a name="ln575">                  for (Element* e : sel.elements())</a>
<a name="ln576">                        applyDrop(score, viewer, e, element, modifiers);</a>
<a name="ln577">                  }</a>
<a name="ln578">            }</a>
<a name="ln579">      else if (sel.isRange()) {</a>
<a name="ln580">            if (element-&gt;type() == ElementType::BAR_LINE</a>
<a name="ln581">                || element-&gt;type() == ElementType::MARKER</a>
<a name="ln582">                || element-&gt;type() == ElementType::JUMP</a>
<a name="ln583">                || element-&gt;type() == ElementType::SPACER</a>
<a name="ln584">                || element-&gt;type() == ElementType::VBOX</a>
<a name="ln585">                || element-&gt;type() == ElementType::HBOX</a>
<a name="ln586">                || element-&gt;type() == ElementType::TBOX</a>
<a name="ln587">                || element-&gt;type() == ElementType::MEASURE</a>
<a name="ln588">                || element-&gt;type() == ElementType::BRACKET</a>
<a name="ln589">                || element-&gt;type() == ElementType::STAFFTYPE_CHANGE</a>
<a name="ln590">                || (element-&gt;type() == ElementType::ICON</a>
<a name="ln591">                    &amp;&amp; (toIcon(element)-&gt;iconType() == IconType::VFRAME</a>
<a name="ln592">                        || toIcon(element)-&gt;iconType() == IconType::HFRAME</a>
<a name="ln593">                        || toIcon(element)-&gt;iconType() == IconType::TFRAME</a>
<a name="ln594">                        || toIcon(element)-&gt;iconType() == IconType::MEASURE</a>
<a name="ln595">                        || toIcon(element)-&gt;iconType() == IconType::BRACKETS))) {</a>
<a name="ln596">                  Measure* last = sel.endSegment() ? sel.endSegment()-&gt;measure() : nullptr;</a>
<a name="ln597">                  for (Measure* m = sel.startSegment()-&gt;measure(); m; m = m-&gt;nextMeasureMM()) {</a>
<a name="ln598">                        QRectF r = m-&gt;staffabbox(sel.staffStart());</a>
<a name="ln599">                        QPointF pt(r.x() + r.width() * .5, r.y() + r.height() * .5);</a>
<a name="ln600">                        pt += m-&gt;system()-&gt;page()-&gt;pos();</a>
<a name="ln601">                        applyDrop(score, viewer, m, element, modifiers, pt);</a>
<a name="ln602">                        if (m == last)</a>
<a name="ln603">                              break;</a>
<a name="ln604">                        }</a>
<a name="ln605">                  }</a>
<a name="ln606">            else if (element-&gt;type() == ElementType::LAYOUT_BREAK) {</a>
<a name="ln607">                  LayoutBreak* breakElement = static_cast&lt;LayoutBreak*&gt;(element);</a>
<a name="ln608">                  score-&gt;cmdToggleLayoutBreak(breakElement-&gt;layoutBreakType());</a>
<a name="ln609">                  }</a>
<a name="ln610">            else if (element-&gt;isClef() || element-&gt;isKeySig() || element-&gt;isTimeSig()) {</a>
<a name="ln611">                  Measure* m1 = sel.startSegment()-&gt;measure();</a>
<a name="ln612">                  Measure* m2 = sel.endSegment() ? sel.endSegment()-&gt;measure() : nullptr;</a>
<a name="ln613">                  if (m2 == m1 &amp;&amp; sel.startSegment()-&gt;rtick().isZero())</a>
<a name="ln614">                        m2 = nullptr;     // don't restore original if one full measure selected</a>
<a name="ln615">                  else if (m2)</a>
<a name="ln616">                        m2 = m2-&gt;nextMeasureMM();</a>
<a name="ln617">                  // for clefs, apply to each staff separately</a>
<a name="ln618">                  // otherwise just apply to top staff</a>
<a name="ln619">                  int staffIdx1 = sel.staffStart();</a>
<a name="ln620">                  int staffIdx2 = element-&gt;type() == ElementType::CLEF ? sel.staffEnd() : staffIdx1 + 1;</a>
<a name="ln621">                  for (int i = staffIdx1; i &lt; staffIdx2; ++i) {</a>
<a name="ln622">                        // for clefs, use mid-measure changes if appropriate</a>
<a name="ln623">                        Element* e1 = nullptr;</a>
<a name="ln624">                        Element* e2 = nullptr;</a>
<a name="ln625">                        // use mid-measure clef changes as appropriate</a>
<a name="ln626">                        if (element-&gt;type() == ElementType::CLEF) {</a>
<a name="ln627">                              if (sel.startSegment()-&gt;isChordRestType() &amp;&amp; sel.startSegment()-&gt;rtick().isNotZero()) {</a>
<a name="ln628">                                    ChordRest* cr = static_cast&lt;ChordRest*&gt;(sel.startSegment()-&gt;nextChordRest(i * VOICES));</a>
<a name="ln629">                                    if (cr &amp;&amp; cr-&gt;isChord())</a>
<a name="ln630">                                          e1 = static_cast&lt;Chord*&gt;(cr)-&gt;upNote();</a>
<a name="ln631">                                    else</a>
<a name="ln632">                                          e1 = cr;</a>
<a name="ln633">                                    }</a>
<a name="ln634">                              if (sel.endSegment() &amp;&amp; sel.endSegment()-&gt;segmentType() == SegmentType::ChordRest) {</a>
<a name="ln635">                                    ChordRest* cr = static_cast&lt;ChordRest*&gt;(sel.endSegment()-&gt;nextChordRest(i * VOICES));</a>
<a name="ln636">                                    if (cr &amp;&amp; cr-&gt;isChord())</a>
<a name="ln637">                                          e2 = static_cast&lt;Chord*&gt;(cr)-&gt;upNote();</a>
<a name="ln638">                                    else</a>
<a name="ln639">                                          e2 = cr;</a>
<a name="ln640">                                    }</a>
<a name="ln641">                              }</a>
<a name="ln642">                        if (m2 || e2) {</a>
<a name="ln643">                              // restore original clef/keysig/timesig</a>
<a name="ln644">                              Staff* staff = score-&gt;staff(i);</a>
<a name="ln645">                              Fraction tick1 = sel.startSegment()-&gt;tick();</a>
<a name="ln646">                              Element* oelement = nullptr;</a>
<a name="ln647">                              switch (element-&gt;type()) {</a>
<a name="ln648">                                    case ElementType::CLEF:</a>
<a name="ln649">                                          {</a>
<a name="ln650">                                          Clef* oclef = new Clef(score);</a>
<a name="ln651">                                          oclef-&gt;setClefType(staff-&gt;clef(tick1));</a>
<a name="ln652">                                          oelement = oclef;</a>
<a name="ln653">                                          break;</a>
<a name="ln654">                                          }</a>
<a name="ln655">                                    case ElementType::KEYSIG:</a>
<a name="ln656">                                          {</a>
<a name="ln657">                                          KeySig* okeysig = new KeySig(score);</a>
<a name="ln658">                                          okeysig-&gt;setKeySigEvent(staff-&gt;keySigEvent(tick1));</a>
<a name="ln659">                                          if (!score-&gt;styleB(Sid::concertPitch) &amp;&amp; !okeysig-&gt;isCustom() &amp;&amp; !okeysig-&gt;isAtonal()) {</a>
<a name="ln660">                                                Interval v = staff-&gt;part()-&gt;instrument(tick1)-&gt;transpose();</a>
<a name="ln661">                                                if (!v.isZero()) {</a>
<a name="ln662">                                                      Key k = okeysig-&gt;key();</a>
<a name="ln663">                                                      okeysig-&gt;setKey(transposeKey(k, v, okeysig-&gt;part()-&gt;preferSharpFlat()));</a>
<a name="ln664">                                                      }</a>
<a name="ln665">                                                }</a>
<a name="ln666">                                          oelement = okeysig;</a>
<a name="ln667">                                          break;</a>
<a name="ln668">                                          }</a>
<a name="ln669">                                    case ElementType::TIMESIG:</a>
<a name="ln670">                                          {</a>
<a name="ln671">                                          TimeSig* otimesig = new TimeSig(score);</a>
<a name="ln672">                                          otimesig-&gt;setFrom(staff-&gt;timeSig(tick1));</a>
<a name="ln673">                                          oelement = otimesig;</a>
<a name="ln674">                                          break;</a>
<a name="ln675">                                          }</a>
<a name="ln676">                                    default:</a>
<a name="ln677">                                          break;</a>
<a name="ln678">                                    }</a>
<a name="ln679">                              if (oelement) {</a>
<a name="ln680">                                    if (e2) {</a>
<a name="ln681">                                          applyDrop(score, viewer, e2, oelement, modifiers);</a>
<a name="ln682">                                          }</a>
<a name="ln683">                                    else {</a>
<a name="ln684">                                          QRectF r = m2-&gt;staffabbox(i);</a>
<a name="ln685">                                          QPointF pt(r.x() + r.width() * .5, r.y() + r.height() * .5);</a>
<a name="ln686">                                          pt += m2-&gt;system()-&gt;page()-&gt;pos();</a>
<a name="ln687">                                          applyDrop(score, viewer, m2, oelement, modifiers, pt);</a>
<a name="ln688">                                          }</a>
<a name="ln689">                                    delete oelement;</a>
<a name="ln690">                                    }</a>
<a name="ln691">                              }</a>
<a name="ln692">                        // apply new clef/keysig/timesig</a>
<a name="ln693">                        if (e1) {</a>
<a name="ln694">                              applyDrop(score, viewer, e1, element, modifiers);</a>
<a name="ln695">                              }</a>
<a name="ln696">                        else {</a>
<a name="ln697">                              QRectF r = m1-&gt;staffabbox(i);</a>
<a name="ln698">                              QPointF pt(r.x() + r.width() * .5, r.y() + r.height() * .5);</a>
<a name="ln699">                              pt += m1-&gt;system()-&gt;page()-&gt;pos();</a>
<a name="ln700">                              applyDrop(score, viewer, m1, element, modifiers, pt);</a>
<a name="ln701">                              }</a>
<a name="ln702">                        }</a>
<a name="ln703">                  }</a>
<a name="ln704">            else if (element-&gt;isSlur()) {</a>
<a name="ln705">                  viewer-&gt;cmdAddSlur(toSlur(element));</a>
<a name="ln706">                  }</a>
<a name="ln707">            else if (element-&gt;isSLine() &amp;&amp; element-&gt;type() != ElementType::GLISSANDO) {</a>
<a name="ln708">                  Segment* startSegment = sel.startSegment();</a>
<a name="ln709">                  Segment* endSegment = sel.endSegment();</a>
<a name="ln710">                  bool firstStaffOnly = element-&gt;isVolta() &amp;&amp; !(modifiers &amp; Qt::ControlModifier);</a>
<a name="ln711">                  int startStaff = firstStaffOnly ? 0 : sel.staffStart();</a>
<a name="ln712">                  int endStaff   = firstStaffOnly ? 1 : sel.staffEnd();</a>
<a name="ln713">                  for (int i = startStaff; i &lt; endStaff; ++i) {</a>
<a name="ln714">                        Spanner* spanner = static_cast&lt;Spanner*&gt;(element-&gt;clone());</a>
<a name="ln715">                        spanner-&gt;setScore(score);</a>
<a name="ln716">                        spanner-&gt;styleChanged();</a>
<a name="ln717">                        score-&gt;cmdAddSpanner(spanner, i, startSegment, endSegment);</a>
<a name="ln718">                        }</a>
<a name="ln719">                  }</a>
<a name="ln720">            else {</a>
<a name="ln721">                  int track1 = sel.staffStart() * VOICES;</a>
<a name="ln722">                  int track2 = sel.staffEnd() * VOICES;</a>
<a name="ln723">                  Segment* startSegment = sel.startSegment();</a>
<a name="ln724">                  Segment* endSegment = sel.endSegment(); //keep it, it could change during the loop</a>
<a name="ln725">                  for (Segment* s = startSegment; s &amp;&amp; s != endSegment; s = s-&gt;next1()) {</a>
<a name="ln726">                        for (int track = track1; track &lt; track2; ++track) {</a>
<a name="ln727">                              Element* e = s-&gt;element(track);</a>
<a name="ln728">                              if (e == 0 || !score-&gt;selectionFilter().canSelect(e) || !score-&gt;selectionFilter().canSelectVoice(track))</a>
<a name="ln729">                                    continue;</a>
<a name="ln730">                              if (e-&gt;isChord()) {</a>
<a name="ln731">                                    Chord* chord = toChord(e);</a>
<a name="ln732">                                    for (Note* n : chord-&gt;notes())</a>
<a name="ln733">                                          applyDrop(score, viewer, n, element, modifiers);</a>
<a name="ln734">                                    }</a>
<a name="ln735">                              else {</a>
<a name="ln736">                                    // do not apply articulation to barline in a range selection</a>
<a name="ln737">                                    if (!e-&gt;isBarLine() || !element-&gt;isArticulation())</a>
<a name="ln738">                                          applyDrop(score, viewer, e, element, modifiers);</a>
<a name="ln739">                                    }</a>
<a name="ln740">                              }</a>
<a name="ln741">                        }</a>
<a name="ln742">                  }</a>
<a name="ln743">            }</a>
<a name="ln744">      else</a>
<a name="ln745">            qDebug(&quot;unknown selection state&quot;);</a>
<a name="ln746"> </a>
<a name="ln747">      if (viewer-&gt;mscoreState() != STATE_EDIT</a>
<a name="ln748">         &amp;&amp; viewer-&gt;mscoreState() != STATE_LYRICS_EDIT</a>
<a name="ln749">         &amp;&amp; viewer-&gt;mscoreState() != STATE_HARMONY_FIGBASS_EDIT) { //Already in startCmd mode in this case</a>
<a name="ln750">            score-&gt;endCmd();</a>
<a name="ln751">            if (viewer-&gt;mscoreState() == STATE_NOTE_ENTRY_STAFF_DRUM)</a>
<a name="ln752">                  viewer-&gt;moveCursor();</a>
<a name="ln753">            }</a>
<a name="ln754">      else if (viewer-&gt;mscoreState() &amp; STATE_ALLTEXTUAL_EDIT)</a>
<a name="ln755">            viewer-&gt;setFocus();</a>
<a name="ln756">      viewer-&gt;setDropTarget(0);</a>
<a name="ln757">//      mscore-&gt;endCmd();</a>
<a name="ln758">      return true;</a>
<a name="ln759">      }</a>
<a name="ln760"> </a>
<a name="ln761">//---------------------------------------------------------</a>
<a name="ln762">//   keyPressEvent</a>
<a name="ln763">//---------------------------------------------------------</a>
<a name="ln764"> </a>
<a name="ln765">void PaletteScrollArea::keyPressEvent(QKeyEvent* event)</a>
<a name="ln766">      {</a>
<a name="ln767">      QWidget* w = this-&gt;widget();</a>
<a name="ln768">      Palette* p = static_cast&lt;Palette*&gt;(w);</a>
<a name="ln769">      int pressedKey = event-&gt;key();</a>
<a name="ln770">      switch (pressedKey) {</a>
<a name="ln771">            case Qt::Key_Right:</a>
<a name="ln772">            case Qt::Key_Left:</a>
<a name="ln773">            case Qt::Key_Up:</a>
<a name="ln774">            case Qt::Key_Down:</a>
<a name="ln775">                  {</a>
<a name="ln776">                  int idx = p-&gt;getSelectedIdx();</a>
<a name="ln777">                  if (pressedKey == Qt::Key_Left || pressedKey == Qt::Key_Up)</a>
<a name="ln778">                        idx--;</a>
<a name="ln779">                  else</a>
<a name="ln780">                        idx++;</a>
<a name="ln781">                  if (idx &lt; 0)</a>
<a name="ln782">                        idx = p-&gt;size() - 1;</a>
<a name="ln783">                  else if (idx &gt;= p-&gt;size())</a>
<a name="ln784">                        idx = 0;</a>
<a name="ln785">                  p-&gt;setSelected(idx);</a>
<a name="ln786">                  p-&gt;setCurrentIdx(idx);</a>
<a name="ln787">                  // set widget name to name of selected element</a>
<a name="ln788">                  // we could set the description, but some screen readers ignore it</a>
<a name="ln789">                  QString name = p-&gt;cellAt(idx)-&gt;translatedName();</a>
<a name="ln790">                  ScoreAccessibility::makeReadable(name);</a>
<a name="ln791">                  setAccessibleName(name);</a>
<a name="ln792">                  QAccessibleEvent aev(this, QAccessible::NameChanged);</a>
<a name="ln793">                  QAccessible::updateAccessibility(&amp;aev);</a>
<a name="ln794">                  p-&gt;update();</a>
<a name="ln795">                  break;</a>
<a name="ln796">                  }</a>
<a name="ln797">            case Qt::Key_Enter:</a>
<a name="ln798">            case Qt::Key_Return:</a>
<a name="ln799">                  if (!p-&gt;disableElementsApply())</a>
<a name="ln800">                        p-&gt;applyPaletteElement();</a>
<a name="ln801">                  break;</a>
<a name="ln802">            default:</a>
<a name="ln803">                  break;</a>
<a name="ln804">            }</a>
<a name="ln805">      QScrollArea::keyPressEvent(event);</a>
<a name="ln806">      }</a>
<a name="ln807"> </a>
<a name="ln808">//---------------------------------------------------------</a>
<a name="ln809">//   mouseDoubleClickEvent</a>
<a name="ln810">//---------------------------------------------------------</a>
<a name="ln811"> </a>
<a name="ln812">void Palette::mouseDoubleClickEvent(QMouseEvent* event)</a>
<a name="ln813">      {</a>
<a name="ln814">      if (_useDoubleClickToActivate)</a>
<a name="ln815">            applyElementAtPosition(event-&gt;pos(), event-&gt;modifiers());</a>
<a name="ln816">      }</a>
<a name="ln817"> </a>
<a name="ln818">//---------------------------------------------------------</a>
<a name="ln819">//   mouseReleaseEvent</a>
<a name="ln820">//---------------------------------------------------------</a>
<a name="ln821"> </a>
<a name="ln822">void Palette::mouseReleaseEvent(QMouseEvent* event)</a>
<a name="ln823">      {</a>
<a name="ln824">      pressedIndex = -1;</a>
<a name="ln825"> </a>
<a name="ln826">      update();</a>
<a name="ln827"> </a>
<a name="ln828">      if (!_useDoubleClickToActivate)</a>
<a name="ln829">            applyElementAtPosition(event-&gt;pos(), event-&gt;modifiers());</a>
<a name="ln830">      }</a>
<a name="ln831"> </a>
<a name="ln832">void Palette::applyElementAtPosition(QPoint pos, Qt::KeyboardModifiers modifiers)</a>
<a name="ln833">      {</a>
<a name="ln834">      if (_disableElementsApply)</a>
<a name="ln835">            return;</a>
<a name="ln836"> </a>
<a name="ln837">      const int index = idx(pos);</a>
<a name="ln838"> </a>
<a name="ln839">      if (index == -1)</a>
<a name="ln840">            return;</a>
<a name="ln841"> </a>
<a name="ln842">      Score* score = mscore-&gt;currentScore();</a>
<a name="ln843"> </a>
<a name="ln844">      if (!score || score-&gt;selection().isNone())</a>
<a name="ln845">            return;</a>
<a name="ln846"> </a>
<a name="ln847">      PaletteCell* cell = cellAt(index);</a>
<a name="ln848"> </a>
<a name="ln849">      if (!cell)</a>
<a name="ln850">            return;</a>
<a name="ln851"> </a>
<a name="ln852">      applyPaletteElement(cell-&gt;element.get(), modifiers);</a>
<a name="ln853">      }</a>
<a name="ln854"> </a>
<a name="ln855">//---------------------------------------------------------</a>
<a name="ln856">//   idx</a>
<a name="ln857">//---------------------------------------------------------</a>
<a name="ln858"> </a>
<a name="ln859">int Palette::idx(const QPoint&amp; p) const</a>
<a name="ln860">      {</a>
<a name="ln861">      int hgridM = gridWidthM();</a>
<a name="ln862">      int vgridM = gridHeightM();</a>
<a name="ln863">      if (columns() == 0)</a>
<a name="ln864">            return -1;</a>
<a name="ln865">      int rightBorder = width() % hgridM;</a>
<a name="ln866">      int hhgrid      = hgridM + (rightBorder / columns());</a>
<a name="ln867"> </a>
<a name="ln868">      int x = p.x();</a>
<a name="ln869">      int y = p.y();</a>
<a name="ln870"> </a>
<a name="ln871">      int row = y / vgridM;</a>
<a name="ln872">      int col = x / hhgrid;</a>
<a name="ln873"> </a>
<a name="ln874">      int nc = columns();</a>
<a name="ln875">      if (col &gt; nc)</a>
<a name="ln876">            return -1;</a>
<a name="ln877"> </a>
<a name="ln878">      int idx = row * nc + col;</a>
<a name="ln879">      if (idx &lt; 0 || idx &gt;= size())</a>
<a name="ln880">            return -1;</a>
<a name="ln881">      return idx;</a>
<a name="ln882">      }</a>
<a name="ln883"> </a>
<a name="ln884">//---------------------------------------------------------</a>
<a name="ln885">//   idx2</a>
<a name="ln886">//   returns indexes outside of cells.size()</a>
<a name="ln887">//---------------------------------------------------------</a>
<a name="ln888"> </a>
<a name="ln889">int Palette::idx2(const QPoint&amp; p) const</a>
<a name="ln890">      {</a>
<a name="ln891">      int hgridM = gridWidthM();</a>
<a name="ln892">      int vgridM = gridHeightM();</a>
<a name="ln893">      if (columns() == 0)</a>
<a name="ln894">            return -1;</a>
<a name="ln895">      int rightBorder = width() % hgridM;</a>
<a name="ln896">      int hhgrid      = hgridM + (rightBorder / columns());</a>
<a name="ln897"> </a>
<a name="ln898">      int x = p.x();</a>
<a name="ln899">      int y = p.y();</a>
<a name="ln900"> </a>
<a name="ln901">      int row = y / vgridM;</a>
<a name="ln902">      int col = x / hhgrid;</a>
<a name="ln903"> </a>
<a name="ln904">      int nc = columns();</a>
<a name="ln905">      if (col &gt; nc)</a>
<a name="ln906">            return -1;</a>
<a name="ln907"> </a>
<a name="ln908">      int idx = row * nc + col;</a>
<a name="ln909">      if (idx &lt; 0 || idx &gt; columns()*rows())</a>
<a name="ln910">            return -1;</a>
<a name="ln911">      return idx;</a>
<a name="ln912">      }</a>
<a name="ln913"> </a>
<a name="ln914">//---------------------------------------------------------</a>
<a name="ln915">//   idxRect</a>
<a name="ln916">//---------------------------------------------------------</a>
<a name="ln917"> </a>
<a name="ln918">QRect Palette::idxRect(int i) const</a>
<a name="ln919">      {</a>
<a name="ln920">      int hgridM = gridWidthM();</a>
<a name="ln921">      int vgridM = gridHeightM();</a>
<a name="ln922">      if (i == -1)</a>
<a name="ln923">            return QRect();</a>
<a name="ln924">     if (columns() == 0)</a>
<a name="ln925">            return QRect();</a>
<a name="ln926"> </a>
<a name="ln927">      int rightBorder = width() % hgridM;</a>
<a name="ln928">      int hhgrid = hgridM + (rightBorder / columns());</a>
<a name="ln929"> </a>
<a name="ln930">      int cc = i % columns();</a>
<a name="ln931">      int cr = i / columns();</a>
<a name="ln932">      return QRect(cc * hhgrid, cr * vgridM, hhgrid, vgridM);</a>
<a name="ln933">      }</a>
<a name="ln934"> </a>
<a name="ln935">//---------------------------------------------------------</a>
<a name="ln936">//   leaveEvent</a>
<a name="ln937">//---------------------------------------------------------</a>
<a name="ln938"> </a>
<a name="ln939">void Palette::leaveEvent(QEvent*)</a>
<a name="ln940">      {</a>
<a name="ln941">      if (currentIdx != -1) {</a>
<a name="ln942">            QRect r = idxRect(currentIdx);</a>
<a name="ln943">            if (!(QGuiApplication::keyboardModifiers() &amp; Qt::ShiftModifier))</a>
<a name="ln944">                  currentIdx = -1;</a>
<a name="ln945">            update(r);</a>
<a name="ln946">            }</a>
<a name="ln947">      }</a>
<a name="ln948"> </a>
<a name="ln949">//---------------------------------------------------------</a>
<a name="ln950">//   nextPaletteElement</a>
<a name="ln951">//---------------------------------------------------------</a>
<a name="ln952"> </a>
<a name="ln953">void Palette::nextPaletteElement()</a>
<a name="ln954">      {</a>
<a name="ln955">      int i = currentIdx;</a>
<a name="ln956">      if (i == -1)</a>
<a name="ln957">            return;</a>
<a name="ln958">      i++;</a>
<a name="ln959">      if (i &lt; size() &amp;&amp; cellAt(i))</a>
<a name="ln960">            currentIdx = i;</a>
<a name="ln961"> </a>
<a name="ln962">      // TODO: screenreader support</a>
<a name="ln963">      //QString name = qApp-&gt;translate(&quot;Palette&quot;, cellAt(i)-&gt;name.toUtf8());</a>
<a name="ln964">      //ScoreAccessibility::makeReadable(name);</a>
<a name="ln965"> </a>
<a name="ln966">      update();</a>
<a name="ln967">      }</a>
<a name="ln968"> </a>
<a name="ln969">//---------------------------------------------------------</a>
<a name="ln970">//   prevPaletteElement</a>
<a name="ln971">//---------------------------------------------------------</a>
<a name="ln972"> </a>
<a name="ln973">void Palette::prevPaletteElement()</a>
<a name="ln974">      {</a>
<a name="ln975">      int i = currentIdx;</a>
<a name="ln976">      if (i == -1)</a>
<a name="ln977">            return;</a>
<a name="ln978">      i--;</a>
<a name="ln979">      if (i &gt;= 0 &amp;&amp; cellAt(i))</a>
<a name="ln980">            currentIdx = i;</a>
<a name="ln981"> </a>
<a name="ln982">      // TODO: screenreader support</a>
<a name="ln983">      //QString name = qApp-&gt;translate(&quot;Palette&quot;, cellAt(i)-&gt;name.toUtf8());</a>
<a name="ln984">      //ScoreAccessibility::makeReadable(name);</a>
<a name="ln985"> </a>
<a name="ln986">      update();</a>
<a name="ln987">      }</a>
<a name="ln988"> </a>
<a name="ln989">//---------------------------------------------------------</a>
<a name="ln990">//   applyPaletteElement</a>
<a name="ln991">//---------------------------------------------------------</a>
<a name="ln992"> </a>
<a name="ln993">void Palette::applyPaletteElement()</a>
<a name="ln994">      {</a>
<a name="ln995">      Score* score = mscore-&gt;currentScore();</a>
<a name="ln996">      if (score == 0)</a>
<a name="ln997">            return;</a>
<a name="ln998">      const Selection&amp; sel = score-&gt;selection();</a>
<a name="ln999">      if (sel.isNone())</a>
<a name="ln1000">            return;</a>
<a name="ln1001">      // apply currently selected palette symbol to selected score elements</a>
<a name="ln1002">      int i = currentIdx;</a>
<a name="ln1003">      if (i &lt; size() &amp;&amp; cellAt(i))</a>
<a name="ln1004">            applyPaletteElement(cellAt(i)-&gt;element.get());</a>
<a name="ln1005">      else</a>
<a name="ln1006">            return;</a>
<a name="ln1007">      }</a>
<a name="ln1008"> </a>
<a name="ln1009">//---------------------------------------------------------</a>
<a name="ln1010">//   append</a>
<a name="ln1011">//    append element to palette</a>
<a name="ln1012">//---------------------------------------------------------</a>
<a name="ln1013"> </a>
<a name="ln1014">PaletteCell* Palette::append(Element* s, const QString&amp; name, QString tag, qreal mag)</a>
<a name="ln1015">      {</a>
<a name="ln1016">      if (s == 0) {</a>
<a name="ln1017">            cells.append(0);</a>
<a name="ln1018">            return 0;</a>
<a name="ln1019">            }</a>
<a name="ln1020">      PaletteCell* cell = new PaletteCell;</a>
<a name="ln1021">      int idx;</a>
<a name="ln1022">      if (_moreElements) {</a>
<a name="ln1023">            cells.insert(cells.size() - 1, cell);</a>
<a name="ln1024">            idx = cells.size() - 2;</a>
<a name="ln1025">            }</a>
<a name="ln1026">      else {</a>
<a name="ln1027">            cells.append(cell);</a>
<a name="ln1028">            idx = cells.size() - 1;</a>
<a name="ln1029">            }</a>
<a name="ln1030">      PaletteCell* pc = add(idx, s, name, tag, mag);</a>
<a name="ln1031">      setFixedHeight(heightForWidth(width()));</a>
<a name="ln1032">      updateGeometry();</a>
<a name="ln1033">      return pc;</a>
<a name="ln1034">      }</a>
<a name="ln1035"> </a>
<a name="ln1036">//---------------------------------------------------------</a>
<a name="ln1037">//   add</a>
<a name="ln1038">//---------------------------------------------------------</a>
<a name="ln1039"> </a>
<a name="ln1040">PaletteCell* Palette::add(int idx, Element* s, const QString&amp; name, QString tag, qreal mag)</a>
<a name="ln1041">      {</a>
<a name="ln1042">      if (s) {</a>
<a name="ln1043">            s-&gt;setPos(0.0, 0.0);</a>
<a name="ln1044">            s-&gt;setOffset(QPointF());</a>
<a name="ln1045">            }</a>
<a name="ln1046"> </a>
<a name="ln1047">      PaletteCell* cell = new PaletteCell;</a>
<a name="ln1048">      if (idx &lt; cells.size()) {</a>
<a name="ln1049">            delete cells[idx];</a>
<a name="ln1050">            }</a>
<a name="ln1051">      else {</a>
<a name="ln1052">            for (int i = cells.size(); i &lt;= idx; ++i)</a>
<a name="ln1053">                  cells.append(0);</a>
<a name="ln1054">            }</a>
<a name="ln1055">      cells[idx]      = cell;</a>
<a name="ln1056">      cell-&gt;element.reset(s);</a>
<a name="ln1057">      cell-&gt;name      = name;</a>
<a name="ln1058">      cell-&gt;tag       = tag;</a>
<a name="ln1059">      cell-&gt;drawStaff = needsStaff(s);</a>
<a name="ln1060">      cell-&gt;xoffset   = 0;</a>
<a name="ln1061">      cell-&gt;yoffset   = 0;</a>
<a name="ln1062">      cell-&gt;mag       = mag;</a>
<a name="ln1063">      cell-&gt;readOnly  = false;</a>
<a name="ln1064">      update();</a>
<a name="ln1065">      if (s &amp;&amp; s-&gt;isIcon()) {</a>
<a name="ln1066">            Icon* icon = toIcon(s);</a>
<a name="ln1067">            connect(getAction(icon-&gt;action()), SIGNAL(toggled(bool)), SLOT(actionToggled(bool)));</a>
<a name="ln1068">            }</a>
<a name="ln1069">      updateGeometry();</a>
<a name="ln1070">      return cell;</a>
<a name="ln1071">      }</a>
<a name="ln1072"> </a>
<a name="ln1073">//---------------------------------------------------------</a>
<a name="ln1074">//   paintPaletteElement</a>
<a name="ln1075">//---------------------------------------------------------</a>
<a name="ln1076"> </a>
<a name="ln1077">static void paintPaletteElement(void* data, Element* e)</a>
<a name="ln1078">      {</a>
<a name="ln1079">      QPainter* p = static_cast&lt;QPainter*&gt;(data);</a>
<a name="ln1080">      p-&gt;save();</a>
<a name="ln1081">      p-&gt;translate(e-&gt;pos());</a>
<a name="ln1082">      e-&gt;draw(p);</a>
<a name="ln1083">      p-&gt;restore();</a>
<a name="ln1084">      }</a>
<a name="ln1085"> </a>
<a name="ln1086">//---------------------------------------------------------</a>
<a name="ln1087">//   paintEvent</a>
<a name="ln1088">//---------------------------------------------------------</a>
<a name="ln1089"> </a>
<a name="ln1090">void Palette::paintEvent(QPaintEvent* /*event*/)</a>
<a name="ln1091">      {</a>
<a name="ln1092">      qreal _spatium = gscore-&gt;spatium();</a>
<a name="ln1093">      qreal magS     = PALETTE_SPATIUM * extraMag * guiMag();</a>
<a name="ln1094">      qreal mag      = magS / _spatium;</a>
<a name="ln1095">//      qreal mag      = PALETTE_SPATIUM * extraMag / _spatium;</a>
<a name="ln1096">      gscore-&gt;setSpatium(SPATIUM20);</a>
<a name="ln1097"> </a>
<a name="ln1098">      QPainter p(this);</a>
<a name="ln1099">      p.setRenderHint(QPainter::Antialiasing, true);</a>
<a name="ln1100"> </a>
<a name="ln1101">      QColor bgColor(0xf6, 0xf0, 0xda);</a>
<a name="ln1102">      if (preferences.getBool(PREF_UI_CANVAS_FG_USECOLOR))</a>
<a name="ln1103">            bgColor = preferences.getColor(PREF_UI_CANVAS_FG_COLOR);</a>
<a name="ln1104">#if 1</a>
<a name="ln1105">      p.setBrush(bgColor);</a>
<a name="ln1106">      p.drawRoundedRect(0, 0, width(), height(), 2, 2);</a>
<a name="ln1107">#else</a>
<a name="ln1108">      p.fillRect(event-&gt;rect(), QColor(0xf6, 0xf0, 0xda));</a>
<a name="ln1109">#endif</a>
<a name="ln1110">      //</a>
<a name="ln1111">      // draw grid</a>
<a name="ln1112">      //</a>
<a name="ln1113">      int hgridM = gridWidthM();</a>
<a name="ln1114">      int vgridM = gridHeightM();</a>
<a name="ln1115"> </a>
<a name="ln1116">      if (columns() == 0)</a>
<a name="ln1117">            return;</a>
<a name="ln1118">      int rightBorder = width() % hgridM;</a>
<a name="ln1119">      int hhgrid = hgridM + (rightBorder / columns());</a>
<a name="ln1120"> </a>
<a name="ln1121">      if (_drawGrid) {</a>
<a name="ln1122">            p.setPen(Qt::gray);</a>
<a name="ln1123">            for (int row = 1; row &lt; rows(); ++row) {</a>
<a name="ln1124">                  int x2 = row &lt; rows()-1 ? columns() * hhgrid : width();</a>
<a name="ln1125">                  int y  = row * vgridM;</a>
<a name="ln1126">                  p.drawLine(0, y, x2, y);</a>
<a name="ln1127">                  }</a>
<a name="ln1128">            for (int column = 1; column &lt; columns(); ++column) {</a>
<a name="ln1129">                  int x = hhgrid * column;</a>
<a name="ln1130">                  p.drawLine(x, 0, x, rows() * vgridM);</a>
<a name="ln1131">                  }</a>
<a name="ln1132">            }</a>
<a name="ln1133"> </a>
<a name="ln1134">      qreal dy = lrint(2 * magS);</a>
<a name="ln1135"> </a>
<a name="ln1136">      //</a>
<a name="ln1137">      // draw symbols</a>
<a name="ln1138">      //</a>
<a name="ln1139"> </a>
<a name="ln1140">      // QPen pen(palette().color(QPalette::Normal, QPalette::Text));</a>
<a name="ln1141">      QPen pen(Qt::black);</a>
<a name="ln1142">      pen.setWidthF(MScore::defaultStyle().value(Sid::staffLineWidth).toDouble() * magS);</a>
<a name="ln1143"> </a>
<a name="ln1144">      for (int idx = 0; idx &lt; ccp()-&gt;size(); ++idx) {</a>
<a name="ln1145">            int yoffset  = gscore-&gt;spatium() * _yOffset;</a>
<a name="ln1146">            QRect r      = idxRect(idx);</a>
<a name="ln1147">            QRect rShift = r.translated(0, yoffset);</a>
<a name="ln1148">            p.setPen(pen);</a>
<a name="ln1149">            QColor c(MScore::selectColor[0]);</a>
<a name="ln1150"> </a>
<a name="ln1151">            if (idx == selectedIdx) {</a>
<a name="ln1152">                  c.setAlphaF(0.5);</a>
<a name="ln1153">                  p.fillRect(r, c);</a>
<a name="ln1154">                  }</a>
<a name="ln1155">            else if (idx == pressedIndex) {</a>
<a name="ln1156">                  c.setAlphaF(0.75);</a>
<a name="ln1157">                  p.fillRect(r, c);</a>
<a name="ln1158">                  }</a>
<a name="ln1159">            else if (idx == currentIdx) {</a>
<a name="ln1160">                  c.setAlphaF(0.2);</a>
<a name="ln1161">                  p.fillRect(r, c);</a>
<a name="ln1162">                  }</a>
<a name="ln1163"> </a>
<a name="ln1164">            if (ccp()-&gt;at(idx) == 0)</a>
<a name="ln1165">                  continue;</a>
<a name="ln1166">            PaletteCell* cc = ccp()-&gt;at(idx);      // current cell</a>
<a name="ln1167"> </a>
<a name="ln1168">            QString tag = cc-&gt;tag;</a>
<a name="ln1169">            if (!tag.isEmpty()) {</a>
<a name="ln1170">                  p.setPen(Qt::darkGray);</a>
<a name="ln1171">                  QFont f(p.font());</a>
<a name="ln1172">                  f.setPointSize(12);</a>
<a name="ln1173">                  p.setFont(f);</a>
<a name="ln1174">                  if (tag == &quot;ShowMore&quot;)</a>
<a name="ln1175">                        p.drawText(idxRect(idx), Qt::AlignCenter, &quot;???&quot;);</a>
<a name="ln1176">                  else</a>
<a name="ln1177">                        p.drawText(rShift, Qt::AlignLeft | Qt::AlignTop, tag);</a>
<a name="ln1178">                  }</a>
<a name="ln1179"> </a>
<a name="ln1180">            p.setPen(pen);</a>
<a name="ln1181"> </a>
<a name="ln1182">            Element* el = cc-&gt;element.get();</a>
<a name="ln1183">            if (el == 0)</a>
<a name="ln1184">                  continue;</a>
<a name="ln1185">            bool drawStaff = cc-&gt;drawStaff;</a>
<a name="ln1186">            int row    = idx / columns();</a>
<a name="ln1187">            int column = idx % columns();</a>
<a name="ln1188"> </a>
<a name="ln1189">            qreal cellMag = cc-&gt;mag * mag;</a>
<a name="ln1190">            if (el-&gt;isIcon()) {</a>
<a name="ln1191">                  toIcon(el)-&gt;setExtent((hhgrid &lt; vgridM ? hhgrid : vgridM) - 4);</a>
<a name="ln1192">                  cellMag = 1.0;</a>
<a name="ln1193">                  }</a>
<a name="ln1194">            el-&gt;layout();</a>
<a name="ln1195"> </a>
<a name="ln1196">            if (drawStaff) {</a>
<a name="ln1197">                  qreal y = r.y() + vgridM * .5 - dy + _yOffset * _spatium * cellMag;</a>
<a name="ln1198">                  qreal x = r.x() + 3;</a>
<a name="ln1199">                  qreal w = hhgrid - 6;</a>
<a name="ln1200">                  for (int i = 0; i &lt; 5; ++i) {</a>
<a name="ln1201">                        qreal yy = y + i * magS;</a>
<a name="ln1202">                        p.drawLine(QLineF(x, yy, x + w, yy));</a>
<a name="ln1203">                        }</a>
<a name="ln1204">                  }</a>
<a name="ln1205">            p.save();</a>
<a name="ln1206">            p.scale(cellMag, cellMag);</a>
<a name="ln1207"> </a>
<a name="ln1208">            double gw = hhgrid / cellMag;</a>
<a name="ln1209">            double gh = vgridM / cellMag;</a>
<a name="ln1210">            double gx = column * gw + cc-&gt;xoffset * _spatium;</a>
<a name="ln1211">            double gy = row    * gh + cc-&gt;yoffset * _spatium;</a>
<a name="ln1212"> </a>
<a name="ln1213">            double sw = el-&gt;width();</a>
<a name="ln1214">            double sh = el-&gt;height();</a>
<a name="ln1215">            double sy;</a>
<a name="ln1216"> </a>
<a name="ln1217">            if (drawStaff)</a>
<a name="ln1218">                  sy = gy + gh * .5 - 2.0 * _spatium;</a>
<a name="ln1219">            else</a>
<a name="ln1220">                  sy  = gy + (gh - sh) * .5 - el-&gt;bbox().y();</a>
<a name="ln1221">            double sx  = gx + (gw - sw) * .5 - el-&gt;bbox().x();</a>
<a name="ln1222"> </a>
<a name="ln1223">            sy += _yOffset * _spatium;</a>
<a name="ln1224"> </a>
<a name="ln1225">            p.translate(sx, sy);</a>
<a name="ln1226">            cc-&gt;x = sx;</a>
<a name="ln1227">            cc-&gt;y = sy;</a>
<a name="ln1228"> </a>
<a name="ln1229">            QColor color;</a>
<a name="ln1230">            if (idx != selectedIdx) {</a>
<a name="ln1231">                  // show voice colors for notes</a>
<a name="ln1232">                  if (el-&gt;isChord())</a>
<a name="ln1233">                        color = el-&gt;curColor();</a>
<a name="ln1234">                  else</a>
<a name="ln1235">                        color = palette().color(QPalette::Normal, QPalette::Text);</a>
<a name="ln1236">                  }</a>
<a name="ln1237">            else</a>
<a name="ln1238">                  color = palette().color(QPalette::Normal, QPalette::HighlightedText);</a>
<a name="ln1239"> </a>
<a name="ln1240">            p.setPen(QPen(color));</a>
<a name="ln1241">            el-&gt;scanElements(&amp;p, paintPaletteElement);</a>
<a name="ln1242">            p.restore();</a>
<a name="ln1243">            }</a>
<a name="ln1244">      }</a>
<a name="ln1245"> </a>
<a name="ln1246">//---------------------------------------------------------</a>
<a name="ln1247">//   pixmap</a>
<a name="ln1248">//---------------------------------------------------------</a>
<a name="ln1249"> </a>
<a name="ln1250">QPixmap Palette::pixmap(int paletteIdx) const</a>
<a name="ln1251">      {</a>
<a name="ln1252">      qreal _spatium = gscore-&gt;spatium();</a>
<a name="ln1253">      qreal magS     = PALETTE_SPATIUM * extraMag * guiMag();</a>
<a name="ln1254">      qreal mag      = magS / _spatium;</a>
<a name="ln1255">//      qreal guiMag = guiScaling * preferences.getDouble(PREF_APP_PALETTESCALE);</a>
<a name="ln1256">//      qreal mag      = PALETTE_SPATIUM * extraMag * guiMag / _spatium;</a>
<a name="ln1257">      PaletteCell* c = cellAt(paletteIdx);</a>
<a name="ln1258">      if (!c || !c-&gt;element)</a>
<a name="ln1259">            return QPixmap();</a>
<a name="ln1260">      qreal cellMag = c-&gt;mag * mag;</a>
<a name="ln1261">      Element* e = c-&gt;element.get();</a>
<a name="ln1262">      e-&gt;layout();</a>
<a name="ln1263">      QRectF r = e-&gt;bbox();</a>
<a name="ln1264">      int w    = lrint(r.width()  * cellMag);</a>
<a name="ln1265">      int h    = lrint(r.height() * cellMag);</a>
<a name="ln1266"> </a>
<a name="ln1267">      if (w * h == 0) {</a>
<a name="ln1268">            qDebug(&quot;zero pixmap %d %d %s&quot;, w, h, e-&gt;name());</a>
<a name="ln1269">            return QPixmap();</a>
<a name="ln1270">            }</a>
<a name="ln1271"> </a>
<a name="ln1272">      QPixmap pm(w, h);</a>
<a name="ln1273">      pm.fill(Qt::transparent);</a>
<a name="ln1274">      QPainter p(&amp;pm);</a>
<a name="ln1275">      p.setRenderHint(QPainter::Antialiasing, true);</a>
<a name="ln1276"> </a>
<a name="ln1277">      if (e-&gt;isIcon())</a>
<a name="ln1278">            toIcon(e)-&gt;setExtent(w &lt; h ? w : h);</a>
<a name="ln1279">      p.scale(cellMag, cellMag);</a>
<a name="ln1280"> </a>
<a name="ln1281">      p.translate(-r.topLeft());</a>
<a name="ln1282">      QPointF pos = e-&gt;ipos();</a>
<a name="ln1283">      e-&gt;setPos(0, 0);</a>
<a name="ln1284"> </a>
<a name="ln1285">      QColor color;</a>
<a name="ln1286">       // show voice colors for notes</a>
<a name="ln1287">      if (e-&gt;isChord()) {</a>
<a name="ln1288">             Chord* chord = toChord(e);</a>
<a name="ln1289">             for (Note* n : chord-&gt;notes())</a>
<a name="ln1290">                   n-&gt;setSelected(true);</a>
<a name="ln1291">             color = e-&gt;curColor();</a>
<a name="ln1292">             }</a>
<a name="ln1293">       else</a>
<a name="ln1294">             color = palette().color(QPalette::Normal, QPalette::Text);</a>
<a name="ln1295"> </a>
<a name="ln1296">      p.setPen(QPen(color));</a>
<a name="ln1297">      e-&gt;scanElements(&amp;p, paintPaletteElement);</a>
<a name="ln1298"> </a>
<a name="ln1299">      e-&gt;setPos(pos);</a>
<a name="ln1300">      return pm;</a>
<a name="ln1301">      }</a>
<a name="ln1302"> </a>
<a name="ln1303">//---------------------------------------------------------</a>
<a name="ln1304">//   event</a>
<a name="ln1305">//---------------------------------------------------------</a>
<a name="ln1306"> </a>
<a name="ln1307">bool Palette::event(QEvent* ev)</a>
<a name="ln1308">      {</a>
<a name="ln1309">      int hgridM = gridWidthM();</a>
<a name="ln1310">      int vgridM = gridHeightM();</a>
<a name="ln1311">      // disable mouse hover when keyboard navigation is enabled</a>
<a name="ln1312">      if (filterActive &amp;&amp; (ev-&gt;type() == QEvent::MouseMove || ev-&gt;type() == QEvent::ToolTip</a>
<a name="ln1313">          || ev-&gt;type() == QEvent::WindowDeactivate)) {</a>
<a name="ln1314">            return true;</a>
<a name="ln1315">            }</a>
<a name="ln1316">      else if (columns() &amp;&amp; (ev-&gt;type() == QEvent::ToolTip)) {</a>
<a name="ln1317">            int rightBorder = width() % hgridM;</a>
<a name="ln1318">            int hhgrid = hgridM + (rightBorder / columns());</a>
<a name="ln1319">            QHelpEvent* he = (QHelpEvent*)ev;</a>
<a name="ln1320">            int x = he-&gt;pos().x();</a>
<a name="ln1321">            int y = he-&gt;pos().y();</a>
<a name="ln1322"> </a>
<a name="ln1323">            int row = y / vgridM;</a>
<a name="ln1324">            int col = x / hhgrid;</a>
<a name="ln1325"> </a>
<a name="ln1326">            if (row &lt; 0 || row &gt;= rows())</a>
<a name="ln1327">                  return false;</a>
<a name="ln1328">            if (col &lt; 0 || col &gt;= columns())</a>
<a name="ln1329">                  return false;</a>
<a name="ln1330">            int idx = row * columns() + col;</a>
<a name="ln1331">            if (idx &gt;= cells.size())</a>
<a name="ln1332">                  return false;</a>
<a name="ln1333">            if (cellAt(idx) == 0)</a>
<a name="ln1334">                  return false;</a>
<a name="ln1335">            QToolTip::showText(he-&gt;globalPos(), cellAt(idx)-&gt;translatedName(), this);</a>
<a name="ln1336">            return false;</a>
<a name="ln1337">            }</a>
<a name="ln1338">      return QWidget::event(ev);</a>
<a name="ln1339">      }</a>
<a name="ln1340"> </a>
<a name="ln1341">//---------------------------------------------------------</a>
<a name="ln1342">//   write</a>
<a name="ln1343">//---------------------------------------------------------</a>
<a name="ln1344"> </a>
<a name="ln1345">void Palette::write(XmlWriter&amp; xml) const</a>
<a name="ln1346">      {</a>
<a name="ln1347">      xml.stag(QString(&quot;Palette name=\&quot;%1\&quot;&quot;).arg(XmlWriter::xmlString(_name)));</a>
<a name="ln1348">      xml.tag(&quot;gridWidth&quot;, hgrid);</a>
<a name="ln1349">      xml.tag(&quot;gridHeight&quot;, vgrid);</a>
<a name="ln1350">      xml.tag(&quot;mag&quot;, extraMag);</a>
<a name="ln1351">      if (_drawGrid)</a>
<a name="ln1352">            xml.tag(&quot;grid&quot;, _drawGrid);</a>
<a name="ln1353"> </a>
<a name="ln1354">      xml.tag(&quot;moreElements&quot;, _moreElements);</a>
<a name="ln1355">      if (_yOffset != 0.0)</a>
<a name="ln1356">            xml.tag(&quot;yoffset&quot;, _yOffset);</a>
<a name="ln1357"> </a>
<a name="ln1358">      int n = cells.size();</a>
<a name="ln1359">      for (int i = 0; i &lt; n; ++i) {</a>
<a name="ln1360">            if (cells[i] &amp;&amp; cells[i]-&gt;tag == &quot;ShowMore&quot;)</a>
<a name="ln1361">                  continue;</a>
<a name="ln1362">            if (cells[i] == 0 || cells[i]-&gt;element == 0) {</a>
<a name="ln1363">                  xml.tagE(&quot;Cell&quot;);</a>
<a name="ln1364">                  continue;</a>
<a name="ln1365">                  }</a>
<a name="ln1366">            if (!cells[i]-&gt;name.isEmpty())</a>
<a name="ln1367">                  xml.stag(QString(&quot;Cell name=\&quot;%1\&quot;&quot;).arg(XmlWriter::xmlString(cells[i]-&gt;name)));</a>
<a name="ln1368">            else</a>
<a name="ln1369">                  xml.stag(&quot;Cell&quot;);</a>
<a name="ln1370">            if (cells[i]-&gt;drawStaff)</a>
<a name="ln1371">                  xml.tag(&quot;staff&quot;, cells[i]-&gt;drawStaff);</a>
<a name="ln1372">            if (cells[i]-&gt;xoffset)</a>
<a name="ln1373">                  xml.tag(&quot;xoffset&quot;, cells[i]-&gt;xoffset);</a>
<a name="ln1374">            if (cells[i]-&gt;yoffset)</a>
<a name="ln1375">                  xml.tag(&quot;yoffset&quot;, cells[i]-&gt;yoffset);</a>
<a name="ln1376">            if (!cells[i]-&gt;tag.isEmpty())</a>
<a name="ln1377">                  xml.tag(&quot;tag&quot;, cells[i]-&gt;tag);</a>
<a name="ln1378">            if (cells[i]-&gt;mag != 1.0)</a>
<a name="ln1379">                  xml.tag(&quot;mag&quot;, cells[i]-&gt;mag);</a>
<a name="ln1380">            cells[i]-&gt;element-&gt;write(xml);</a>
<a name="ln1381">            xml.etag();</a>
<a name="ln1382">            }</a>
<a name="ln1383">      xml.etag();</a>
<a name="ln1384">      }</a>
<a name="ln1385"> </a>
<a name="ln1386">//---------------------------------------------------------</a>
<a name="ln1387">//   read</a>
<a name="ln1388">//---------------------------------------------------------</a>
<a name="ln1389"> </a>
<a name="ln1390">bool Palette::read(const QString&amp; p)</a>
<a name="ln1391">      {</a>
<a name="ln1392">      QString path(p);</a>
<a name="ln1393">      if (!path.endsWith(&quot;.mpal&quot;))</a>
<a name="ln1394">            path += &quot;.mpal&quot;;</a>
<a name="ln1395"> </a>
<a name="ln1396">      MQZipReader f(path);</a>
<a name="ln1397">      if (!f.exists()) {</a>
<a name="ln1398">            qDebug(&quot;palette &lt;%s&gt; not found&quot;, qPrintable(path));</a>
<a name="ln1399">            return false;</a>
<a name="ln1400">            }</a>
<a name="ln1401">      clear();</a>
<a name="ln1402"> </a>
<a name="ln1403">      QByteArray ba = f.fileData(&quot;META-INF/container.xml&quot;);</a>
<a name="ln1404"> </a>
<a name="ln1405">      XmlReader e(ba);</a>
<a name="ln1406">      // extract first rootfile</a>
<a name="ln1407">      QString rootfile = &quot;&quot;;</a>
<a name="ln1408">      QList&lt;QString&gt; images;</a>
<a name="ln1409">      while (e.readNextStartElement()) {</a>
<a name="ln1410">            if (e.name() != &quot;container&quot;) {</a>
<a name="ln1411">                  e.unknown();</a>
<a name="ln1412">                  break;;</a>
<a name="ln1413">                  }</a>
<a name="ln1414">            while (e.readNextStartElement()) {</a>
<a name="ln1415">                  if (e.name() != &quot;rootfiles&quot;) {</a>
<a name="ln1416">                        e.unknown();</a>
<a name="ln1417">                        break;</a>
<a name="ln1418">                        }</a>
<a name="ln1419">                  while (e.readNextStartElement()) {</a>
<a name="ln1420">                        const QStringRef&amp; tag(e.name());</a>
<a name="ln1421"> </a>
<a name="ln1422">                        if (tag == &quot;rootfile&quot;) {</a>
<a name="ln1423">                              if (rootfile.isEmpty())</a>
<a name="ln1424">                                    rootfile = e.attribute(&quot;full-path&quot;);</a>
<a name="ln1425">                              e.readNext();</a>
<a name="ln1426">                              }</a>
<a name="ln1427">                        else if (tag == &quot;file&quot;)</a>
<a name="ln1428">                              images.append(e.readElementText());</a>
<a name="ln1429">                        else</a>
<a name="ln1430">                              e.unknown();</a>
<a name="ln1431">                        }</a>
<a name="ln1432">                  }</a>
<a name="ln1433">            }</a>
<a name="ln1434">      //</a>
<a name="ln1435">      // load images</a>
<a name="ln1436">      //</a>
<a name="ln1437">      foreach(const QString&amp; s, images)</a>
<a name="ln1438">            imageStore.add(s, f.fileData(s));</a>
<a name="ln1439"> </a>
<a name="ln1440">      if (rootfile.isEmpty()) {</a>
<a name="ln1441">            qDebug(&quot;can't find rootfile in: %s&quot;, qPrintable(path));</a>
<a name="ln1442">            return false;</a>
<a name="ln1443">            }</a>
<a name="ln1444"> </a>
<a name="ln1445">      ba = f.fileData(rootfile);</a>
<a name="ln1446">      e.clear();</a>
<a name="ln1447">      e.addData(ba);</a>
<a name="ln1448">      while (e.readNextStartElement()) {</a>
<a name="ln1449">            if (e.name() == &quot;museScore&quot;) {</a>
<a name="ln1450">                  QString version = e.attribute(&quot;version&quot;);</a>
<a name="ln1451">                  QStringList sl = version.split('.');</a>
<a name="ln1452">                  int versionId = sl[0].toInt() * 100 + sl[1].toInt();</a>
<a name="ln1453">                  gscore-&gt;setMscVersion(versionId);</a>
<a name="ln1454"> </a>
<a name="ln1455">                  while (e.readNextStartElement()) {</a>
<a name="ln1456">                        if (e.name() == &quot;Palette&quot;) {</a>
<a name="ln1457">                              QString name = e.attribute(&quot;name&quot;);</a>
<a name="ln1458">                              setName(name);</a>
<a name="ln1459">                              read(e);</a>
<a name="ln1460">                              }</a>
<a name="ln1461">                        else</a>
<a name="ln1462">                              e.unknown();</a>
<a name="ln1463">                        }</a>
<a name="ln1464">                  }</a>
<a name="ln1465">            else</a>
<a name="ln1466">                  e.unknown();</a>
<a name="ln1467">            }</a>
<a name="ln1468">      return true;</a>
<a name="ln1469">      }</a>
<a name="ln1470"> </a>
<a name="ln1471">//---------------------------------------------------------</a>
<a name="ln1472">//   writeFailed</a>
<a name="ln1473">//---------------------------------------------------------</a>
<a name="ln1474"> </a>
<a name="ln1475">static void writeFailed(const QString&amp; path)</a>
<a name="ln1476">      {</a>
<a name="ln1477">      QString s = qApp-&gt;translate(&quot;Palette&quot;, &quot;Writing Palette File\n%1\nfailed: &quot;).arg(path); // reason?</a>
<a name="ln1478">      QMessageBox::critical(mscore, qApp-&gt;translate(&quot;Palette&quot;, &quot;Writing Palette File&quot;), s);</a>
<a name="ln1479">      }</a>
<a name="ln1480"> </a>
<a name="ln1481">//---------------------------------------------------------</a>
<a name="ln1482">//   write</a>
<a name="ln1483">//    write as compressed zip file and include</a>
<a name="ln1484">//    images as needed</a>
<a name="ln1485">//---------------------------------------------------------</a>
<a name="ln1486"> </a>
<a name="ln1487">void Palette::write(const QString&amp; p)</a>
<a name="ln1488">      {</a>
<a name="ln1489">      QSet&lt;ImageStoreItem*&gt; images;</a>
<a name="ln1490">      int n = cells.size();</a>
<a name="ln1491">      for (int i = 0; i &lt; n; ++i) {</a>
<a name="ln1492">            if (cells[i] == 0 || cells[i]-&gt;element == 0 || cells[i]-&gt;element-&gt;type() != ElementType::IMAGE)</a>
<a name="ln1493">                  continue;</a>
<a name="ln1494">            images.insert(static_cast&lt;Image*&gt;(cells[i]-&gt;element.get())-&gt;storeItem());</a>
<a name="ln1495">            }</a>
<a name="ln1496"> </a>
<a name="ln1497">      QString path(p);</a>
<a name="ln1498">      if (!path.endsWith(&quot;.mpal&quot;))</a>
<a name="ln1499">            path += &quot;.mpal&quot;;</a>
<a name="ln1500"> </a>
<a name="ln1501">      MQZipWriter f(path);</a>
<a name="ln1502">      // f.setCompressionPolicy(QZipWriter::NeverCompress);</a>
<a name="ln1503">      f.setCreationPermissions(</a>
<a name="ln1504">         QFile::ReadOwner | QFile::WriteOwner | QFile::ExeOwner</a>
<a name="ln1505">         | QFile::ReadUser | QFile::WriteUser | QFile::ExeUser</a>
<a name="ln1506">         | QFile::ReadGroup | QFile::WriteGroup | QFile::ExeGroup</a>
<a name="ln1507">         | QFile::ReadOther | QFile::WriteOther | QFile::ExeOther);</a>
<a name="ln1508"> </a>
<a name="ln1509">      if (f.status() != MQZipWriter::NoError) {</a>
<a name="ln1510">            writeFailed(path);</a>
<a name="ln1511">            return;</a>
<a name="ln1512">            }</a>
<a name="ln1513">      QBuffer cbuf;</a>
<a name="ln1514">      cbuf.open(QIODevice::ReadWrite);</a>
<a name="ln1515">      XmlWriter xml(gscore, &amp;cbuf);</a>
<a name="ln1516">      xml.header();</a>
<a name="ln1517">      xml.stag(&quot;container&quot;);</a>
<a name="ln1518">      xml.stag(&quot;rootfiles&quot;);</a>
<a name="ln1519">      xml.stag(QString(&quot;rootfile full-path=\&quot;%1\&quot;&quot;).arg(XmlWriter::xmlString(&quot;palette.xml&quot;)));</a>
<a name="ln1520">      xml.etag();</a>
<a name="ln1521">      foreach (ImageStoreItem* ip, images) {</a>
<a name="ln1522">            QString ipath = QString(&quot;Pictures/&quot;) + ip-&gt;hashName();</a>
<a name="ln1523">            xml.tag(&quot;file&quot;, ipath);</a>
<a name="ln1524">            }</a>
<a name="ln1525">      xml.etag();</a>
<a name="ln1526">      xml.etag();</a>
<a name="ln1527">      cbuf.seek(0);</a>
<a name="ln1528">      //f.addDirectory(&quot;META-INF&quot;);</a>
<a name="ln1529">      //f.addDirectory(&quot;Pictures&quot;);</a>
<a name="ln1530">      f.addFile(&quot;META-INF/container.xml&quot;, cbuf.data());</a>
<a name="ln1531"> </a>
<a name="ln1532">      // save images</a>
<a name="ln1533">      foreach(ImageStoreItem* ip, images) {</a>
<a name="ln1534">            QString ipath = QString(&quot;Pictures/&quot;) + ip-&gt;hashName();</a>
<a name="ln1535">            f.addFile(ipath, ip-&gt;buffer());</a>
<a name="ln1536">            }</a>
<a name="ln1537">      {</a>
<a name="ln1538">      QBuffer cbuf1;</a>
<a name="ln1539">      cbuf1.open(QIODevice::ReadWrite);</a>
<a name="ln1540">      XmlWriter xml1(gscore, &amp;cbuf1);</a>
<a name="ln1541">      xml1.header();</a>
<a name="ln1542">      xml1.stag(&quot;museScore version=\&quot;&quot; MSC_VERSION &quot;\&quot;&quot;);</a>
<a name="ln1543">      write(xml1);</a>
<a name="ln1544">      xml1.etag();</a>
<a name="ln1545">      cbuf1.close();</a>
<a name="ln1546">      f.addFile(&quot;palette.xml&quot;, cbuf1.data());</a>
<a name="ln1547">      }</a>
<a name="ln1548">      f.close();</a>
<a name="ln1549">      if (f.status() != MQZipWriter::NoError)</a>
<a name="ln1550">            writeFailed(path);</a>
<a name="ln1551">      }</a>
<a name="ln1552"> </a>
<a name="ln1553">//---------------------------------------------------------</a>
<a name="ln1554">//   read</a>
<a name="ln1555">//---------------------------------------------------------</a>
<a name="ln1556"> </a>
<a name="ln1557">void Palette::read(XmlReader&amp; e)</a>
<a name="ln1558">      {</a>
<a name="ln1559">      while (e.readNextStartElement()) {</a>
<a name="ln1560">            const QStringRef&amp; t(e.name());</a>
<a name="ln1561">            if (t == &quot;gridWidth&quot;)</a>
<a name="ln1562">                  hgrid = e.readDouble();</a>
<a name="ln1563">            else if (t == &quot;gridHeight&quot;)</a>
<a name="ln1564">                  vgrid = e.readDouble();</a>
<a name="ln1565">            else if (t == &quot;mag&quot;)</a>
<a name="ln1566">                  extraMag = e.readDouble();</a>
<a name="ln1567">            else if (t == &quot;grid&quot;)</a>
<a name="ln1568">                  _drawGrid = e.readInt();</a>
<a name="ln1569">            else if (t == &quot;moreElements&quot;)</a>
<a name="ln1570">                  setMoreElements(e.readInt());</a>
<a name="ln1571">            else if (t == &quot;yoffset&quot;)</a>
<a name="ln1572">                  _yOffset = e.readDouble();</a>
<a name="ln1573">            else if (t == &quot;drumPalette&quot;)      // obsolete</a>
<a name="ln1574">                  e.skipCurrentElement();</a>
<a name="ln1575">            else if (t == &quot;Cell&quot;) {</a>
<a name="ln1576">                  PaletteCell* cell = new PaletteCell;</a>
<a name="ln1577">                  cell-&gt;name = e.attribute(&quot;name&quot;);</a>
<a name="ln1578">                  bool add = true;</a>
<a name="ln1579">                  while (e.readNextStartElement()) {</a>
<a name="ln1580">                        const QStringRef&amp; t1(e.name());</a>
<a name="ln1581">                        if (t1 == &quot;staff&quot;)</a>
<a name="ln1582">                              cell-&gt;drawStaff = e.readInt();</a>
<a name="ln1583">                        else if (t1 == &quot;xoffset&quot;)</a>
<a name="ln1584">                              cell-&gt;xoffset = e.readDouble();</a>
<a name="ln1585">                        else if (t1 == &quot;yoffset&quot;)</a>
<a name="ln1586">                              cell-&gt;yoffset = e.readDouble();</a>
<a name="ln1587">                        else if (t1 == &quot;mag&quot;)</a>
<a name="ln1588">                              cell-&gt;mag = e.readDouble();</a>
<a name="ln1589">                        else if (t1 == &quot;tag&quot;)</a>
<a name="ln1590">                              cell-&gt;tag = e.readElementText();</a>
<a name="ln1591">                        else {</a>
<a name="ln1592">                              cell-&gt;element.reset(Element::name2Element(t1, gscore));</a>
<a name="ln1593">                              if (cell-&gt;element == 0) {</a>
<a name="ln1594">                                    e.unknown();</a>
<a name="ln1595">                                    delete cell;</a>
<a name="ln1596">                                    return;</a>
<a name="ln1597">                                    }</a>
<a name="ln1598">                              else {</a>
<a name="ln1599">                                    cell-&gt;element-&gt;read(e);</a>
<a name="ln1600">                                    cell-&gt;element-&gt;styleChanged();</a>
<a name="ln1601">                                    if (cell-&gt;element-&gt;type() == ElementType::ICON) {</a>
<a name="ln1602">                                          Icon* icon = static_cast&lt;Icon*&gt;(cell-&gt;element.get());</a>
<a name="ln1603">                                          QAction* ac = getAction(icon-&gt;action());</a>
<a name="ln1604">                                          if (ac) {</a>
<a name="ln1605">                                                QIcon qicon(ac-&gt;icon());</a>
<a name="ln1606">                                                icon-&gt;setAction(icon-&gt;action(), qicon);</a>
<a name="ln1607">                                                }</a>
<a name="ln1608">                                          else {</a>
<a name="ln1609">                                                add = false; // action is not valid, don't add it to the palette.</a>
<a name="ln1610">                                                }</a>
<a name="ln1611">                                          }</a>
<a name="ln1612">                                    }</a>
<a name="ln1613">                              }</a>
<a name="ln1614">                        }</a>
<a name="ln1615">                  if (add) {</a>
<a name="ln1616">                        int idx = _moreElements ? cells.size() - 1 : cells.size();</a>
<a name="ln1617">                        cells.insert(idx, cell);</a>
<a name="ln1618">                        }</a>
<a name="ln1619">                  }</a>
<a name="ln1620">            else</a>
<a name="ln1621">                  e.unknown();</a>
<a name="ln1622">            }</a>
<a name="ln1623">            // make sure hgrid and vgrid are not 0, we divide by them later</a>
<a name="ln1624">            if (hgrid &lt;= 0)</a>
<a name="ln1625">                  hgrid = 28;</a>
<a name="ln1626">            if (vgrid &lt;= 0)</a>
<a name="ln1627">                  vgrid = 28;</a>
<a name="ln1628">      }</a>
<a name="ln1629"> </a>
<a name="ln1630">//---------------------------------------------------------</a>
<a name="ln1631">//   clear</a>
<a name="ln1632">//---------------------------------------------------------</a>
<a name="ln1633"> </a>
<a name="ln1634">void Palette::clear()</a>
<a name="ln1635">      {</a>
<a name="ln1636">      qDeleteAll(cells);</a>
<a name="ln1637">      cells.clear();</a>
<a name="ln1638">      }</a>
<a name="ln1639"> </a>
<a name="ln1640">//---------------------------------------------------------</a>
<a name="ln1641">//   columns</a>
<a name="ln1642">//---------------------------------------------------------</a>
<a name="ln1643"> </a>
<a name="ln1644">int Palette::columns() const</a>
<a name="ln1645">      {</a>
<a name="ln1646">      return width() / gridWidthM();</a>
<a name="ln1647">      }</a>
<a name="ln1648"> </a>
<a name="ln1649">//---------------------------------------------------------</a>
<a name="ln1650">//   rows</a>
<a name="ln1651">//---------------------------------------------------------</a>
<a name="ln1652"> </a>
<a name="ln1653">int Palette::rows() const</a>
<a name="ln1654">      {</a>
<a name="ln1655">      int c = columns();</a>
<a name="ln1656">      if (c == 0)</a>
<a name="ln1657">            return 0;</a>
<a name="ln1658">      return (size() + c - 1) / c;</a>
<a name="ln1659">      }</a>
<a name="ln1660"> </a>
<a name="ln1661">//---------------------------------------------------------</a>
<a name="ln1662">//   heightForWidth</a>
<a name="ln1663">//---------------------------------------------------------</a>
<a name="ln1664"> </a>
<a name="ln1665">int Palette::heightForWidth(int w) const</a>
<a name="ln1666">      {</a>
<a name="ln1667">      int hgridM = gridWidthM();</a>
<a name="ln1668">      int vgridM = gridHeightM();</a>
<a name="ln1669">      int c = w / hgridM;</a>
<a name="ln1670">      if (c &lt;= 0)</a>
<a name="ln1671">            c = 1;</a>
<a name="ln1672">      int s = size();</a>
<a name="ln1673">      if (_moreElements)</a>
<a name="ln1674">            s += 1;</a>
<a name="ln1675">      int rows = (s + c - 1) / c;</a>
<a name="ln1676">      if (rows &lt;= 0)</a>
<a name="ln1677">            rows = 1;</a>
<a name="ln1678">      qreal magS = PALETTE_SPATIUM * extraMag * guiMag();</a>
<a name="ln1679">      int h = lrint(_yOffset * 2 * magS);</a>
<a name="ln1680">      return rows * vgridM + h;</a>
<a name="ln1681">      }</a>
<a name="ln1682"> </a>
<a name="ln1683">//---------------------------------------------------------</a>
<a name="ln1684">//   sizeHint</a>
<a name="ln1685">//---------------------------------------------------------</a>
<a name="ln1686"> </a>
<a name="ln1687">QSize Palette::sizeHint() const</a>
<a name="ln1688">      {</a>
<a name="ln1689">      int h = heightForWidth(width());</a>
<a name="ln1690">      int hgridM = gridWidthM();</a>
<a name="ln1691">      return QSize((width() / hgridM) * hgridM, h);</a>
<a name="ln1692">      }</a>
<a name="ln1693"> </a>
<a name="ln1694">//---------------------------------------------------------</a>
<a name="ln1695">//   actionToggled</a>
<a name="ln1696">//---------------------------------------------------------</a>
<a name="ln1697"> </a>
<a name="ln1698">void Palette::actionToggled(bool /*val*/)</a>
<a name="ln1699">      {</a>
<a name="ln1700">      selectedIdx = -1;</a>
<a name="ln1701">      int nn = ccp()-&gt;size();</a>
<a name="ln1702">      for (int n = 0; n &lt; nn; ++n) {</a>
<a name="ln1703">            const Element* e = cellAt(n)-&gt;element.get();</a>
<a name="ln1704">            if (e &amp;&amp; e-&gt;type() == ElementType::ICON) {</a>
<a name="ln1705">                  QAction* a = getAction(static_cast&lt;const Icon*&gt;(e)-&gt;action());</a>
<a name="ln1706">                  if (a-&gt;isChecked()) {</a>
<a name="ln1707">                        selectedIdx = n;</a>
<a name="ln1708">                        break;</a>
<a name="ln1709">                        }</a>
<a name="ln1710">                  }</a>
<a name="ln1711">            }</a>
<a name="ln1712">      update();</a>
<a name="ln1713">      }</a>
<a name="ln1714"> </a>
<a name="ln1715">//---------------------------------------------------------</a>
<a name="ln1716">//   PaletteProperties</a>
<a name="ln1717">//---------------------------------------------------------</a>
<a name="ln1718"> </a>
<a name="ln1719">PaletteProperties::PaletteProperties(Palette* p, QWidget* parent)</a>
<a name="ln1720">   : QDialog(parent)</a>
<a name="ln1721">      {</a>
<a name="ln1722">      setObjectName(&quot;PaletteProperties&quot;);</a>
<a name="ln1723">      setupUi(this);</a>
<a name="ln1724">      setWindowFlags(this-&gt;windowFlags() &amp; ~Qt::WindowContextHelpButtonHint);</a>
<a name="ln1725"> </a>
<a name="ln1726">      palette = p;</a>
<a name="ln1727"> </a>
<a name="ln1728">      name-&gt;setText(palette-&gt;name());</a>
<a name="ln1729">      cellWidth-&gt;setValue(palette-&gt;gridWidth());</a>
<a name="ln1730">      cellHeight-&gt;setValue(palette-&gt;gridHeight());</a>
<a name="ln1731">      showGrid-&gt;setChecked(palette-&gt;drawGrid());</a>
<a name="ln1732">      elementOffset-&gt;setValue(palette-&gt;yOffset());</a>
<a name="ln1733">      mag-&gt;setValue(palette-&gt;mag());</a>
<a name="ln1734"> </a>
<a name="ln1735">      MuseScore::restoreGeometry(this);</a>
<a name="ln1736">      }</a>
<a name="ln1737"> </a>
<a name="ln1738">//---------------------------------------------------------</a>
<a name="ln1739">//   accept</a>
<a name="ln1740">//---------------------------------------------------------</a>
<a name="ln1741"> </a>
<a name="ln1742">void PaletteProperties::accept()</a>
<a name="ln1743">      {</a>
<a name="ln1744">      palette-&gt;setName(name-&gt;text());</a>
<a name="ln1745">      palette-&gt;setGrid(cellWidth-&gt;value(), cellHeight-&gt;value());</a>
<a name="ln1746">      palette-&gt;setDrawGrid(showGrid-&gt;isChecked());</a>
<a name="ln1747">      palette-&gt;setYOffset(elementOffset-&gt;value());</a>
<a name="ln1748">      palette-&gt;setMag(mag-&gt;value());</a>
<a name="ln1749">      palette-&gt;emitChanged();</a>
<a name="ln1750">      QDialog::accept();</a>
<a name="ln1751">      }</a>
<a name="ln1752"> </a>
<a name="ln1753">//---------------------------------------------------------</a>
<a name="ln1754">//   hideEvent</a>
<a name="ln1755">//---------------------------------------------------------</a>
<a name="ln1756"> </a>
<a name="ln1757">void PaletteProperties::hideEvent(QHideEvent* event)</a>
<a name="ln1758">      {</a>
<a name="ln1759">      MuseScore::saveGeometry(this);</a>
<a name="ln1760">      QWidget::hideEvent(event);</a>
<a name="ln1761">      }</a>
<a name="ln1762"> </a>
<a name="ln1763">//---------------------------------------------------------</a>
<a name="ln1764">// PaletteScrollArea</a>
<a name="ln1765">//---------------------------------------------------------</a>
<a name="ln1766"> </a>
<a name="ln1767">PaletteScrollArea::PaletteScrollArea(Palette* w, QWidget* parent)</a>
<a name="ln1768">   : QScrollArea(parent)</a>
<a name="ln1769">      {</a>
<a name="ln1770">      setHorizontalScrollBarPolicy(Qt::ScrollBarAlwaysOff);</a>
<a name="ln1771">      setVerticalScrollBarPolicy(Qt::ScrollBarAsNeeded);</a>
<a name="ln1772">      setWidget(w);</a>
<a name="ln1773">      setWidgetResizable(false);</a>
<a name="ln1774">      _restrictHeight = true;</a>
<a name="ln1775">      setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Minimum);</a>
<a name="ln1776">      }</a>
<a name="ln1777"> </a>
<a name="ln1778">//---------------------------------------------------------</a>
<a name="ln1779">// resizeEvent</a>
<a name="ln1780">//---------------------------------------------------------</a>
<a name="ln1781"> </a>
<a name="ln1782">void PaletteScrollArea::resizeEvent(QResizeEvent* re)</a>
<a name="ln1783">      {</a>
<a name="ln1784">      QScrollArea::resizeEvent(re); // necessary?</a>
<a name="ln1785"> </a>
<a name="ln1786">      Palette* palette = static_cast&lt;Palette*&gt;(widget());</a>
<a name="ln1787">      int h = palette-&gt;heightForWidth(width());</a>
<a name="ln1788">      palette-&gt;resize(QSize(width() - 6, h));</a>
<a name="ln1789">      if (_restrictHeight) {</a>
<a name="ln1790">            setMaximumHeight(h+6);</a>
<a name="ln1791">            }</a>
<a name="ln1792">      }</a>
<a name="ln1793"> </a>
<a name="ln1794">//---------------------------------------------------------</a>
<a name="ln1795">//   dragEnterEvent</a>
<a name="ln1796">//---------------------------------------------------------</a>
<a name="ln1797"> </a>
<a name="ln1798">void Palette::dragEnterEvent(QDragEnterEvent* event)</a>
<a name="ln1799">      {</a>
<a name="ln1800">      const QMimeData* dta = event-&gt;mimeData();</a>
<a name="ln1801">      if (dta-&gt;hasUrls()) {</a>
<a name="ln1802">            QList&lt;QUrl&gt;ul = event-&gt;mimeData()-&gt;urls();</a>
<a name="ln1803">            QUrl u = ul.front();</a>
<a name="ln1804">            if (MScore::debugMode) {</a>
<a name="ln1805">                  qDebug(&quot;dragEnterEvent: Url: %s&quot;, qPrintable(u.toString()));</a>
<a name="ln1806">                  qDebug(&quot;   scheme &lt;%s&gt; path &lt;%s&gt;&quot;, qPrintable(u.scheme()), qPrintable(u.path()));</a>
<a name="ln1807">                  }</a>
<a name="ln1808">            if (u.scheme() == &quot;file&quot;) {</a>
<a name="ln1809">                  QFileInfo fi(u.path());</a>
<a name="ln1810">                  QString suffix(fi.suffix().toLower());</a>
<a name="ln1811">                  if (suffix == &quot;svg&quot;</a>
<a name="ln1812">                     || suffix == &quot;jpg&quot;</a>
<a name="ln1813">                     || suffix == &quot;jpeg&quot;</a>
<a name="ln1814">                     || suffix == &quot;png&quot;</a>
<a name="ln1815">                     ) {</a>
<a name="ln1816">                        event-&gt;acceptProposedAction();</a>
<a name="ln1817">                        }</a>
<a name="ln1818">                  }</a>
<a name="ln1819">            }</a>
<a name="ln1820">      else if (dta-&gt;hasFormat(mimeSymbolFormat)) {</a>
<a name="ln1821">            event-&gt;accept();</a>
<a name="ln1822">            update();</a>
<a name="ln1823">            }</a>
<a name="ln1824">      else {</a>
<a name="ln1825">            event-&gt;ignore();</a>
<a name="ln1826">#ifndef NDEBUG</a>
<a name="ln1827">            qDebug(&quot;dragEnterEvent: formats:&quot;);</a>
<a name="ln1828">            for (const QString&amp; s : event-&gt;mimeData()-&gt;formats())</a>
<a name="ln1829">                  qDebug(&quot;   %s&quot;, qPrintable(s));</a>
<a name="ln1830">#endif</a>
<a name="ln1831">            }</a>
<a name="ln1832">      }</a>
<a name="ln1833"> </a>
<a name="ln1834">//---------------------------------------------------------</a>
<a name="ln1835">//   dragMoveEvent</a>
<a name="ln1836">//---------------------------------------------------------</a>
<a name="ln1837"> </a>
<a name="ln1838">void Palette::dragMoveEvent(QDragMoveEvent* event)</a>
<a name="ln1839">      {</a>
<a name="ln1840">      int i = idx(event-&gt;pos());</a>
<a name="ln1841">      if (event-&gt;source() == this) {</a>
<a name="ln1842">            if (i != -1) {</a>
<a name="ln1843">                  if (currentIdx != -1 &amp;&amp; event-&gt;proposedAction() == Qt::MoveAction) {</a>
<a name="ln1844">                        if (i != currentIdx) {</a>
<a name="ln1845">                              PaletteCell* c = cells.takeAt(currentIdx);</a>
<a name="ln1846">                              cells.insert(i, c);</a>
<a name="ln1847">                              currentIdx = i;</a>
<a name="ln1848">                              update();</a>
<a name="ln1849">                              }</a>
<a name="ln1850">                        event-&gt;accept();</a>
<a name="ln1851">                        return;</a>
<a name="ln1852">                        }</a>
<a name="ln1853">                  }</a>
<a name="ln1854">            event-&gt;ignore();</a>
<a name="ln1855">            }</a>
<a name="ln1856">      else</a>
<a name="ln1857">            event-&gt;accept();</a>
<a name="ln1858">      }</a>
<a name="ln1859"> </a>
<a name="ln1860">//---------------------------------------------------------</a>
<a name="ln1861">//   dropEvent</a>
<a name="ln1862">//---------------------------------------------------------</a>
<a name="ln1863"> </a>
<a name="ln1864">void Palette::dropEvent(QDropEvent* event)</a>
<a name="ln1865">      {</a>
<a name="ln1866">      Element* e = 0;</a>
<a name="ln1867">      QString name;</a>
<a name="ln1868"> </a>
<a name="ln1869">      const QMimeData* datap = event-&gt;mimeData();</a>
<a name="ln1870">      if (datap-&gt;hasUrls()) {</a>
<a name="ln1871">            QList&lt;QUrl&gt;ul = event-&gt;mimeData()-&gt;urls();</a>
<a name="ln1872">            QUrl u = ul.front();</a>
<a name="ln1873">            if (u.scheme() == &quot;file&quot;) {</a>
<a name="ln1874">                  QFileInfo fi(u.path());</a>
<a name="ln1875">                  Image* s = new Image(gscore);</a>
<a name="ln1876">                  QString filePath(u.toLocalFile());</a>
<a name="ln1877">                  s-&gt;load(filePath);</a>
<a name="ln1878">                  e = s;</a>
<a name="ln1879">                  QFileInfo f(filePath);</a>
<a name="ln1880">                  name = f.completeBaseName();</a>
<a name="ln1881">                  }</a>
<a name="ln1882">            }</a>
<a name="ln1883">      else if (datap-&gt;hasFormat(mimeSymbolFormat)) {</a>
<a name="ln1884">            QByteArray dta(event-&gt;mimeData()-&gt;data(mimeSymbolFormat));</a>
<a name="ln1885">            XmlReader xml(dta);</a>
<a name="ln1886">            QPointF dragOffset;</a>
<a name="ln1887">            Fraction duration;</a>
<a name="ln1888">            ElementType type = Element::readType(xml, &amp;dragOffset, &amp;duration);</a>
<a name="ln1889"> </a>
<a name="ln1890">            if (type == ElementType::SYMBOL) {</a>
<a name="ln1891">                  Symbol* symbol = new Symbol(gscore);</a>
<a name="ln1892">                  symbol-&gt;read(xml);</a>
<a name="ln1893">                  e = symbol;</a>
<a name="ln1894">                  }</a>
<a name="ln1895">            else {</a>
<a name="ln1896">                  e = Element::create(type, gscore);</a>
<a name="ln1897">                  if (e) {</a>
<a name="ln1898">                        e-&gt;read(xml);</a>
<a name="ln1899">                        e-&gt;setTrack(0);</a>
<a name="ln1900">                        if (e-&gt;isIcon()) {</a>
<a name="ln1901">                              Icon* i = toIcon(e);</a>
<a name="ln1902">                              const QByteArray&amp; action = i-&gt;action();</a>
<a name="ln1903">                              if (!action.isEmpty()) {</a>
<a name="ln1904">                                    const Shortcut* s = Shortcut::getShortcut(action);</a>
<a name="ln1905">                                    if (s) {</a>
<a name="ln1906">                                          QAction* a = s-&gt;action();</a>
<a name="ln1907">                                          QIcon icon(a-&gt;icon());</a>
<a name="ln1908">                                          i-&gt;setAction(action, icon);</a>
<a name="ln1909">                                          }</a>
<a name="ln1910">                                    }</a>
<a name="ln1911">                              }</a>
<a name="ln1912">                        }</a>
<a name="ln1913">                  }</a>
<a name="ln1914">            }</a>
<a name="ln1915">      if (e == 0) {</a>
<a name="ln1916">            event-&gt;ignore();</a>
<a name="ln1917">            return;</a>
<a name="ln1918">            }</a>
<a name="ln1919">      if (event-&gt;source() == this) {</a>
<a name="ln1920">            delete e;</a>
<a name="ln1921">            if (event-&gt;proposedAction() == Qt::MoveAction) {</a>
<a name="ln1922">                  event-&gt;accept();</a>
<a name="ln1923">                  emit changed();</a>
<a name="ln1924">                  return;</a>
<a name="ln1925">                  }</a>
<a name="ln1926">            event-&gt;ignore();</a>
<a name="ln1927">            return;</a>
<a name="ln1928">            }</a>
<a name="ln1929">      </a>
<a name="ln1930">      if (e-&gt;isFretDiagram()) {</a>
<a name="ln1931">            name = toFretDiagram(e)-&gt;harmonyText();</a>
<a name="ln1932">            }</a>
<a name="ln1933"> </a>
<a name="ln1934">      e-&gt;setSelected(false);</a>
<a name="ln1935">      int i = idx(event-&gt;pos());</a>
<a name="ln1936">      if (i == -1 || cells[i])</a>
<a name="ln1937">            append(e, name);</a>
<a name="ln1938">      else</a>
<a name="ln1939">            add(i, e, name);</a>
<a name="ln1940">      event-&gt;accept();</a>
<a name="ln1941">      while (!cells.isEmpty() &amp;&amp; cells.back() == 0)</a>
<a name="ln1942">            cells.removeLast();</a>
<a name="ln1943">      setFixedHeight(heightForWidth(width()));</a>
<a name="ln1944">      updateGeometry();</a>
<a name="ln1945">      update();</a>
<a name="ln1946">      emit changed();</a>
<a name="ln1947">      }</a>
<a name="ln1948"> </a>
<a name="ln1949">}</a>
<a name="ln1950"> </a>

</code></pre>
<div class="balloon" rel="288"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'moreAction' pointer was utilized before it was verified against nullptr. Check lines: 288, 318.</p></div>
<div class="balloon" rel="511"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1004/" target="_blank">V1004</a> The 'viewer' pointer was used unsafely after it was verified against nullptr. Check lines: 508, 511.</p></div>
<div class="balloon" rel="1398"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="1441"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="1805"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
