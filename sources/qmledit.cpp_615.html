
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>qmledit.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2011 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//</a>
<a name="ln12">//  Syntax highlighter based on example code from Ariya Hidayat</a>
<a name="ln13">//  (git://gitorious.org/ofi-labs/x2.git BSD licensed).</a>
<a name="ln14">//=============================================================================</a>
<a name="ln15"> </a>
<a name="ln16">#include &quot;qmledit.h&quot;</a>
<a name="ln17">#include &quot;musescore.h&quot;</a>
<a name="ln18"> </a>
<a name="ln19">namespace Ms {</a>
<a name="ln20"> </a>
<a name="ln21">//---------------------------------------------------------</a>
<a name="ln22">//   JSHighlighter</a>
<a name="ln23">//---------------------------------------------------------</a>
<a name="ln24"> </a>
<a name="ln25">JSHighlighter::JSHighlighter(QTextDocument *parent)</a>
<a name="ln26">    : QSyntaxHighlighter(parent)</a>
<a name="ln27">    , m_markCaseSensitivity(Qt::CaseInsensitive)</a>
<a name="ln28">      {</a>
<a name="ln29">      // default color scheme</a>
<a name="ln30">      m_colors[QmlEdit::Normal]     = QColor(&quot;#000000&quot;);</a>
<a name="ln31">      m_colors[QmlEdit::Comment]    = QColor(&quot;#808080&quot;);</a>
<a name="ln32">      m_colors[QmlEdit::Number]     = QColor(&quot;#008000&quot;);</a>
<a name="ln33">      m_colors[QmlEdit::String]     = QColor(&quot;#800000&quot;);</a>
<a name="ln34">      m_colors[QmlEdit::Operator]   = QColor(&quot;#808000&quot;);</a>
<a name="ln35">      m_colors[QmlEdit::Identifier] = QColor(&quot;#000020&quot;);</a>
<a name="ln36">      m_colors[QmlEdit::Keyword]    = QColor(&quot;#000080&quot;);</a>
<a name="ln37">      m_colors[QmlEdit::BuiltIn]    = QColor(&quot;#008080&quot;);</a>
<a name="ln38">      m_colors[QmlEdit::Marker]     = QColor(&quot;#ffff00&quot;);</a>
<a name="ln39"> </a>
<a name="ln40">      // https://developer.mozilla.org/en/JavaScript/Reference/Reserved_Words</a>
<a name="ln41"> </a>
<a name="ln42">      static const char* data1[] = { &quot;break&quot;, &quot;case&quot;, &quot;catch&quot;, &quot;continue&quot;,</a>
<a name="ln43">         &quot;default&quot;, &quot;delete&quot;, &quot;do&quot;, &quot;else&quot;, &quot;finally&quot;, &quot;for&quot;, &quot;function&quot;,</a>
<a name="ln44">         &quot;if&quot;, &quot;in&quot;, &quot;instanceof&quot;, &quot;new&quot;, &quot;return&quot;, &quot;switch&quot;, &quot;this&quot;, &quot;throw&quot;,</a>
<a name="ln45">         &quot;try&quot;, &quot;typeof&quot;, &quot;var&quot;, &quot;void&quot;, &quot;while&quot;, &quot;with&quot;, &quot;true&quot;, &quot;false&quot;,</a>
<a name="ln46">         &quot;null&quot; };</a>
<a name="ln47"> </a>
<a name="ln48">      for (unsigned int i = 0; i &lt; sizeof(data1)/sizeof(*data1); ++i)</a>
<a name="ln49">            m_keywords.insert(data1[i]);</a>
<a name="ln50"> </a>
<a name="ln51">      // built-in and other popular objects + properties</a>
<a name="ln52"> </a>
<a name="ln53">      static const char* data2[] = { &quot;Object&quot;, &quot;prototype&quot;, &quot;create&quot;,</a>
<a name="ln54">         &quot;defineProperty&quot;, &quot;defineProperties&quot;, &quot;getOwnPropertyDescriptor&quot;,</a>
<a name="ln55">         &quot;keys&quot;, &quot;getOwnPropertyNames&quot;, &quot;constructor&quot;, &quot;__parent__&quot;, &quot;__proto__&quot;,</a>
<a name="ln56">         &quot;__defineGetter__&quot;, &quot;__defineSetter__&quot;, &quot;eval&quot;, &quot;hasOwnProperty&quot;,</a>
<a name="ln57">         &quot;isPrototypeOf&quot;, &quot;__lookupGetter__&quot;, &quot;__lookupSetter__&quot;, &quot;__noSuchMethod__&quot;,</a>
<a name="ln58">         &quot;propertyIsEnumerable&quot;, &quot;toSource&quot;, &quot;toLocaleString&quot;, &quot;toString&quot;,</a>
<a name="ln59">         &quot;unwatch&quot;, &quot;valueOf&quot;, &quot;watch&quot;, &quot;Function&quot;, &quot;arguments&quot;, &quot;arity&quot;, &quot;caller&quot;,</a>
<a name="ln60">         &quot;constructor&quot;, &quot;length&quot;, &quot;name&quot;, &quot;apply&quot;, &quot;bind&quot;, &quot;call&quot;, &quot;String&quot;,</a>
<a name="ln61">         &quot;fromCharCode&quot;, &quot;length&quot;, &quot;charAt&quot;, &quot;charCodeAt&quot;, &quot;concat&quot;, &quot;indexOf&quot;,</a>
<a name="ln62">         &quot;lastIndexOf&quot;, &quot;localCompare&quot;, &quot;match&quot;, &quot;quote&quot;, &quot;replace&quot;, &quot;search&quot;,</a>
<a name="ln63">         &quot;slice&quot;, &quot;split&quot;, &quot;substr&quot;, &quot;substring&quot;, &quot;toLocaleLowerCase&quot;,</a>
<a name="ln64">         &quot;toLocaleUpperCase&quot;, &quot;toLowerCase&quot;, &quot;toUpperCase&quot;, &quot;trim&quot;, &quot;trimLeft&quot;,</a>
<a name="ln65">         &quot;trimRight&quot;, &quot;Array&quot;, &quot;isArray&quot;, &quot;index&quot;, &quot;input&quot;, &quot;pop&quot;, &quot;push&quot;,</a>
<a name="ln66">         &quot;reverse&quot;, &quot;shift&quot;, &quot;sort&quot;, &quot;splice&quot;, &quot;unshift&quot;, &quot;concat&quot;, &quot;join&quot;,</a>
<a name="ln67">         &quot;filter&quot;, &quot;forEach&quot;, &quot;every&quot;, &quot;map&quot;, &quot;some&quot;, &quot;reduce&quot;, &quot;reduceRight&quot;,</a>
<a name="ln68">         &quot;RegExp&quot;, &quot;global&quot;, &quot;ignoreCase&quot;, &quot;lastIndex&quot;, &quot;multiline&quot;, &quot;source&quot;,</a>
<a name="ln69">         &quot;exec&quot;, &quot;test&quot;, &quot;JSON&quot;, &quot;parse&quot;, &quot;stringify&quot;, &quot;decodeURI&quot;,</a>
<a name="ln70">         &quot;decodeURIComponent&quot;, &quot;encodeURI&quot;, &quot;encodeURIComponent&quot;, &quot;eval&quot;,</a>
<a name="ln71">         &quot;isFinite&quot;, &quot;isNaN&quot;, &quot;parseFloat&quot;, &quot;parseInt&quot;, &quot;Infinity&quot;, &quot;NaN&quot;,</a>
<a name="ln72">         &quot;undefined&quot;, &quot;Math&quot;, &quot;E&quot;, &quot;LN2&quot;, &quot;LN10&quot;, &quot;LOG2E&quot;, &quot;LOG10E&quot;, &quot;PI&quot;,</a>
<a name="ln73">         &quot;SQRT1_2&quot;, &quot;SQRT2&quot;, &quot;abs&quot;, &quot;acos&quot;, &quot;asin&quot;, &quot;atan&quot;, &quot;atan2&quot;, &quot;ceil&quot;,</a>
<a name="ln74">         &quot;cos&quot;, &quot;exp&quot;, &quot;floor&quot;, &quot;log&quot;, &quot;max&quot;, &quot;min&quot;, &quot;pow&quot;, &quot;random&quot;, &quot;round&quot;,</a>
<a name="ln75">         &quot;sin&quot;, &quot;sqrt&quot;, &quot;tan&quot;, &quot;document&quot;, &quot;window&quot;, &quot;navigator&quot;, &quot;userAgent&quot;</a>
<a name="ln76">         };</a>
<a name="ln77"> </a>
<a name="ln78">      for (unsigned int i = 0; i &lt; sizeof(data2)/sizeof(*data2); ++i)</a>
<a name="ln79">            m_knownIds.insert(data2[i]);</a>
<a name="ln80">      }</a>
<a name="ln81"> </a>
<a name="ln82">//---------------------------------------------------------</a>
<a name="ln83">//   setColor</a>
<a name="ln84">//---------------------------------------------------------</a>
<a name="ln85"> </a>
<a name="ln86">void JSHighlighter::setColor(QmlEdit::ColorComponent component, const QColor&amp; color)</a>
<a name="ln87">      {</a>
<a name="ln88">      m_colors[component] = color;</a>
<a name="ln89">      rehighlight();</a>
<a name="ln90">      }</a>
<a name="ln91"> </a>
<a name="ln92">//---------------------------------------------------------</a>
<a name="ln93">//   highlightBlock</a>
<a name="ln94">//---------------------------------------------------------</a>
<a name="ln95"> </a>
<a name="ln96">void JSHighlighter::highlightBlock(const QString&amp; text)</a>
<a name="ln97">      {</a>
<a name="ln98">      // parsing state</a>
<a name="ln99">      enum class State : char {</a>
<a name="ln100">            Start = 0,</a>
<a name="ln101">            Number = 1,</a>
<a name="ln102">            Identifier = 2,</a>
<a name="ln103">            String = 3,</a>
<a name="ln104">            Comment = 4,</a>
<a name="ln105">            Regex = 5</a>
<a name="ln106">            };</a>
<a name="ln107"> </a>
<a name="ln108">      QList&lt;int&gt; bracketPositions;</a>
<a name="ln109">      int blockState = previousBlockState();</a>
<a name="ln110">      int bracketLevel = blockState &gt;&gt; 4;</a>
<a name="ln111">      State state = State(blockState &amp; 15);</a>
<a name="ln112">      if (blockState &lt; 0) {</a>
<a name="ln113">            bracketLevel = 0;</a>
<a name="ln114">            state = State::Start;</a>
<a name="ln115">            }</a>
<a name="ln116">      int start = 0;</a>
<a name="ln117">      int i = 0;</a>
<a name="ln118">      while (i &lt;= text.length()) {</a>
<a name="ln119">            QChar ch = (i &lt; text.length()) ? text.at(i) : QChar();</a>
<a name="ln120">            QChar next = (i &lt; text.length() - 1) ? text.at(i + 1) : QChar();</a>
<a name="ln121">            switch (state) {</a>
<a name="ln122">                  case State::Start:</a>
<a name="ln123">                        start = i;</a>
<a name="ln124">                        if (ch.isSpace()) {</a>
<a name="ln125">                              ++i;</a>
<a name="ln126">                              }</a>
<a name="ln127">                        else if (ch.isDigit()) {</a>
<a name="ln128">                              ++i;</a>
<a name="ln129">                              state = State::Number;</a>
<a name="ln130">                              }</a>
<a name="ln131">                        else if (ch.isLetter() || ch == '_') {</a>
<a name="ln132">                              ++i;</a>
<a name="ln133">                              state = State::Identifier;</a>
<a name="ln134">                              }</a>
<a name="ln135">                        else if (ch == '\'' || ch == '\&quot;') {</a>
<a name="ln136">                              ++i;</a>
<a name="ln137">                              state = State::String;</a>
<a name="ln138">                              }</a>
<a name="ln139">                        else if (ch == '/' &amp;&amp; next == '*') {</a>
<a name="ln140">                              ++i;</a>
<a name="ln141">                              ++i;</a>
<a name="ln142">                              state = State::Comment;</a>
<a name="ln143">                              }</a>
<a name="ln144">                        else if (ch == '/' &amp;&amp; next == '/') {</a>
<a name="ln145">                              i = text.length();</a>
<a name="ln146">                              setFormat(start, text.length(), m_colors[QmlEdit::Comment]);</a>
<a name="ln147">                              }</a>
<a name="ln148">                        else if (ch == '/' &amp;&amp; next != '*') {</a>
<a name="ln149">                              ++i;</a>
<a name="ln150">                              state = State::Regex;</a>
<a name="ln151">                              }</a>
<a name="ln152">                        else {</a>
<a name="ln153">                              if (!QString(&quot;(){}[]&quot;).contains(ch))</a>
<a name="ln154">                                    setFormat(start, 1, m_colors[QmlEdit::Operator]);</a>
<a name="ln155">                              if (ch =='{' || ch == '}') {</a>
<a name="ln156">                                    bracketPositions += i;</a>
<a name="ln157">                                    if (ch == '{')</a>
<a name="ln158">                                          bracketLevel++;</a>
<a name="ln159">                                    else</a>
<a name="ln160">                                          bracketLevel--;</a>
<a name="ln161">                                    }</a>
<a name="ln162">                              ++i;</a>
<a name="ln163">                              state = State::Start;</a>
<a name="ln164">                              }</a>
<a name="ln165">                        break;</a>
<a name="ln166">                  case State::Number:</a>
<a name="ln167">                        if (ch.isSpace() || !ch.isDigit()) {</a>
<a name="ln168">                              setFormat(start, i - start, m_colors[QmlEdit::Number]);</a>
<a name="ln169">                              state = State::Start;</a>
<a name="ln170">                              }</a>
<a name="ln171">                        else {</a>
<a name="ln172">                              ++i;</a>
<a name="ln173">                              }</a>
<a name="ln174">                        break;</a>
<a name="ln175">                  case State::Identifier:</a>
<a name="ln176">                        if (ch.isSpace() || !(ch.isDigit() || ch.isLetter() || ch == '_')) {</a>
<a name="ln177">                              QString token = text.mid(start, i - start).trimmed();</a>
<a name="ln178">                              if (m_keywords.contains(token))</a>
<a name="ln179">                                    setFormat(start, i - start, m_colors[QmlEdit::Keyword]);</a>
<a name="ln180">                              else if (m_knownIds.contains(token))</a>
<a name="ln181">                                    setFormat(start, i - start, m_colors[QmlEdit::BuiltIn]);</a>
<a name="ln182">                              state = State::Start;</a>
<a name="ln183">                              }</a>
<a name="ln184">                        else {</a>
<a name="ln185">                              ++i;</a>
<a name="ln186">                              }</a>
<a name="ln187">                        break;</a>
<a name="ln188">                  case State::String:</a>
<a name="ln189">                        if (ch == text.at(start)) {</a>
<a name="ln190">                              QChar prev = (i &gt; 0) ? text.at(i - 1) : QChar();</a>
<a name="ln191">                              if (prev != '\\') {</a>
<a name="ln192">                                    ++i;</a>
<a name="ln193">                                    setFormat(start, i - start, m_colors[QmlEdit::String]);</a>
<a name="ln194">                                    state = State::Start;</a>
<a name="ln195">                                    }</a>
<a name="ln196">                              else {</a>
<a name="ln197">                                    ++i;</a>
<a name="ln198">                                    }</a>
<a name="ln199">                              }</a>
<a name="ln200">                        else {</a>
<a name="ln201">                              ++i;</a>
<a name="ln202">                              }</a>
<a name="ln203">                        break;</a>
<a name="ln204">                  case State::Comment:</a>
<a name="ln205">                        if (ch == '*' &amp;&amp; next == '/') {</a>
<a name="ln206">                              ++i;</a>
<a name="ln207">                              ++i;</a>
<a name="ln208">                              setFormat(start, i - start, m_colors[QmlEdit::Comment]);</a>
<a name="ln209">                              state = State::Start;</a>
<a name="ln210">                              }</a>
<a name="ln211">                        else {</a>
<a name="ln212">                              ++i;</a>
<a name="ln213">                              }</a>
<a name="ln214">                        break;</a>
<a name="ln215">                  case State::Regex:</a>
<a name="ln216">                        if (ch == '/') {</a>
<a name="ln217">                              QChar prev = (i &gt; 0) ? text.at(i - 1) : QChar();</a>
<a name="ln218">                              if (prev != '\\') {</a>
<a name="ln219">                                    ++i;</a>
<a name="ln220">                                    setFormat(start, i - start, m_colors[QmlEdit::String]);</a>
<a name="ln221">                                    state = State::Start;</a>
<a name="ln222">                                    }</a>
<a name="ln223">                              else {</a>
<a name="ln224">                                    ++i;</a>
<a name="ln225">                                    }</a>
<a name="ln226">                              }</a>
<a name="ln227">                        else {</a>
<a name="ln228">                              ++i;</a>
<a name="ln229">                              }</a>
<a name="ln230">                        break;</a>
<a name="ln231">                  default:</a>
<a name="ln232">                        state = State::Start;</a>
<a name="ln233">                        break;</a>
<a name="ln234">                  }</a>
<a name="ln235">            }</a>
<a name="ln236"> </a>
<a name="ln237">      if (state == State::Comment)</a>
<a name="ln238">            setFormat(start, text.length(), m_colors[QmlEdit::Comment]);</a>
<a name="ln239">      else</a>
<a name="ln240">            state = State::Start;</a>
<a name="ln241"> </a>
<a name="ln242">      if (!m_markString.isEmpty()) {</a>
<a name="ln243">            int pos = 0;</a>
<a name="ln244">            int len = m_markString.length();</a>
<a name="ln245">            QTextCharFormat markerFormat;</a>
<a name="ln246">            markerFormat.setBackground(m_colors[QmlEdit::Marker]);</a>
<a name="ln247">            markerFormat.setForeground(m_colors[QmlEdit::Normal]);</a>
<a name="ln248">            for (;;) {</a>
<a name="ln249">                  pos = text.indexOf(m_markString, pos, m_markCaseSensitivity);</a>
<a name="ln250">                  if (pos &lt; 0)</a>
<a name="ln251">                        break;</a>
<a name="ln252">                  setFormat(pos, len, markerFormat);</a>
<a name="ln253">                        ++pos;</a>
<a name="ln254">                  }</a>
<a name="ln255">            }</a>
<a name="ln256">      if (!bracketPositions.isEmpty()) {</a>
<a name="ln257">            JSBlockData *blockData = reinterpret_cast&lt;JSBlockData*&gt;(currentBlock().userData());</a>
<a name="ln258">            if (!blockData) {</a>
<a name="ln259">                  blockData = new JSBlockData;</a>
<a name="ln260">                  currentBlock().setUserData(blockData);</a>
<a name="ln261">                  }</a>
<a name="ln262">            blockData-&gt;bracketPositions = bracketPositions;</a>
<a name="ln263">            }</a>
<a name="ln264">      blockState = (int(state) &amp; 15) | (bracketLevel &lt;&lt; 4);</a>
<a name="ln265">      setCurrentBlockState(blockState);</a>
<a name="ln266">      }</a>
<a name="ln267"> </a>
<a name="ln268">//---------------------------------------------------------</a>
<a name="ln269">//   mark</a>
<a name="ln270">//---------------------------------------------------------</a>
<a name="ln271"> </a>
<a name="ln272">void JSHighlighter::mark(const QString &amp;str, Qt::CaseSensitivity caseSensitivity)</a>
<a name="ln273">      {</a>
<a name="ln274">      m_markString = str;</a>
<a name="ln275">      m_markCaseSensitivity = caseSensitivity;</a>
<a name="ln276">      rehighlight();</a>
<a name="ln277">      }</a>
<a name="ln278"> </a>
<a name="ln279">//---------------------------------------------------------</a>
<a name="ln280">//   keywords</a>
<a name="ln281">//---------------------------------------------------------</a>
<a name="ln282"> </a>
<a name="ln283">QStringList JSHighlighter::keywords() const</a>
<a name="ln284">      {</a>
<a name="ln285">      return m_keywords.toList();</a>
<a name="ln286">      }</a>
<a name="ln287"> </a>
<a name="ln288">//---------------------------------------------------------</a>
<a name="ln289">//   setKeywords</a>
<a name="ln290">//---------------------------------------------------------</a>
<a name="ln291"> </a>
<a name="ln292">void JSHighlighter::setKeywords(const QStringList &amp;keywords)</a>
<a name="ln293">      {</a>
<a name="ln294">      m_keywords = QSet&lt;QString&gt;::fromList(keywords);</a>
<a name="ln295">      rehighlight();</a>
<a name="ln296">      }</a>
<a name="ln297"> </a>
<a name="ln298">//---------------------------------------------------------</a>
<a name="ln299">//   Binding</a>
<a name="ln300">//---------------------------------------------------------</a>
<a name="ln301"> </a>
<a name="ln302">struct Binding {</a>
<a name="ln303">      const char* name;</a>
<a name="ln304">      int key1, key2;</a>
<a name="ln305">      const char* slot;</a>
<a name="ln306">      };</a>
<a name="ln307"> </a>
<a name="ln308">//---------------------------------------------------------</a>
<a name="ln309">//   QmlEdit</a>
<a name="ln310">//---------------------------------------------------------</a>
<a name="ln311"> </a>
<a name="ln312">QmlEdit::QmlEdit(QWidget* parent)</a>
<a name="ln313">   : QPlainTextEdit(parent)</a>
<a name="ln314">      {</a>
<a name="ln315">      setBackgroundVisible(true);</a>
<a name="ln316">      setLineWrapMode(QPlainTextEdit::NoWrap);</a>
<a name="ln317">      QFont font(&quot;FreeMono&quot;, 12);</a>
<a name="ln318">      font.setStyleHint(QFont::TypeWriter);</a>
<a name="ln319">      font.setFixedPitch(true);</a>
<a name="ln320">      setFont(font);</a>
<a name="ln321">      document()-&gt;setDefaultFont(font);</a>
<a name="ln322"> </a>
<a name="ln323">      QTextCursor c = textCursor();</a>
<a name="ln324">      QTextCharFormat cf = c.charFormat();</a>
<a name="ln325">      cf.setFont(font);</a>
<a name="ln326">      c.setCharFormat(cf);</a>
<a name="ln327">      setTextCursor(c);</a>
<a name="ln328"> </a>
<a name="ln329">#if 0</a>
<a name="ln330">      static const Binding bindings[] = {</a>
<a name="ln331">            { &quot;start&quot;,       Qt::CTRL+Qt::Key_Q, Qt::CTRL+Qt::Key_E, SLOT(start()) },</a>
<a name="ln332">            { &quot;end&quot;,         Qt::CTRL+Qt::Key_Q, Qt::CTRL+Qt::Key_X, SLOT(end()) },</a>
<a name="ln333">            { &quot;startOfLine&quot;, Qt::CTRL+Qt::Key_Q, Qt::CTRL+Qt::Key_S, SLOT(startOfLine()) },</a>
<a name="ln334">            { &quot;endOfLine&quot;,   Qt::CTRL+Qt::Key_Q, Qt::CTRL+Qt::Key_D, SLOT(endOfLine())   },</a>
<a name="ln335">            { &quot;up&quot;,          Qt::CTRL+Qt::Key_E, 0, SLOT(upLine())     },</a>
<a name="ln336">            { &quot;down&quot;,        Qt::CTRL+Qt::Key_X, 0, SLOT(downLine())   },</a>
<a name="ln337">            { &quot;right&quot;,       Qt::CTRL+Qt::Key_D, 0, SLOT(right())      },</a>
<a name="ln338">            { &quot;left&quot;,        Qt::CTRL+Qt::Key_S, 0, SLOT(left())       },</a>
<a name="ln339">            { &quot;rightWord&quot;,   Qt::CTRL+Qt::Key_F, 0, SLOT(rightWord())  },</a>
<a name="ln340">            { &quot;leftWord&quot;,    Qt::CTRL+Qt::Key_A, 0, SLOT(leftWord())   },</a>
<a name="ln341">            { &quot;pick&quot;,        Qt::Key_F8,         0, SLOT(pick())       },</a>
<a name="ln342">            { &quot;put&quot;,         Qt::Key_F9,         0, SLOT(put())        },</a>
<a name="ln343">            { &quot;delLine&quot;,     Qt::CTRL+Qt::Key_Y, 0, SLOT(delLine())    },</a>
<a name="ln344">            { &quot;delWord&quot;,     Qt::CTRL+Qt::Key_T, 0, SLOT(delWord())    }</a>
<a name="ln345">            };</a>
<a name="ln346">#endif</a>
<a name="ln347">      setTabChangesFocus(false);</a>
<a name="ln348">      setBackgroundVisible(false);</a>
<a name="ln349">      setCursorWidth(3);</a>
<a name="ln350"> </a>
<a name="ln351">      QPalette p = palette();</a>
<a name="ln352">      p.setColor(QPalette::Text, Qt::black);</a>
<a name="ln353">      p.setColor(QPalette::Base, QColor(0xe0, 0xe0, 0xe0));</a>
<a name="ln354">      setPalette(p);</a>
<a name="ln355">      hl = new JSHighlighter(document());</a>
<a name="ln356">      lineNumberArea = new LineNumberArea(this);</a>
<a name="ln357"> </a>
<a name="ln358">#if 0</a>
<a name="ln359">      for (unsigned int i = 0; i &lt; sizeof(bindings)/sizeof(*bindings); ++i) {</a>
<a name="ln360">            const Binding&amp; b = bindings[i];</a>
<a name="ln361">            QAction* a = new QAction(b.name, this);</a>
<a name="ln362">            a-&gt;setShortcut(QKeySequence(b.key1, b.key2));</a>
<a name="ln363">            a-&gt;setShortcutContext(Qt::WidgetShortcut);</a>
<a name="ln364">            a-&gt;setPriority(QAction::HighPriority);</a>
<a name="ln365">            addAction(a);</a>
<a name="ln366">            connect(a, SIGNAL(triggered()), b.slot);</a>
<a name="ln367">            }</a>
<a name="ln368">#endif</a>
<a name="ln369"> </a>
<a name="ln370">      connect(this, SIGNAL(blockCountChanged(int)),   SLOT(updateLineNumberAreaWidth(int)));</a>
<a name="ln371">      connect(this, SIGNAL(updateRequest(QRect,int)), SLOT(updateLineNumberArea(QRect,int)));</a>
<a name="ln372">      connect(this, SIGNAL(cursorPositionChanged()),  SLOT(highlightCurrentLine()));</a>
<a name="ln373"> </a>
<a name="ln374">      updateLineNumberAreaWidth(0);</a>
<a name="ln375">      highlightCurrentLine();</a>
<a name="ln376">      }</a>
<a name="ln377"> </a>
<a name="ln378">//---------------------------------------------------------</a>
<a name="ln379">//   focusInEvent</a>
<a name="ln380">//---------------------------------------------------------</a>
<a name="ln381"> </a>
<a name="ln382">void QmlEdit::focusInEvent(QFocusEvent* event)</a>
<a name="ln383">      {</a>
<a name="ln384">      mscoreState = mscore-&gt;state();</a>
<a name="ln385">      mscore-&gt;changeState(STATE_DISABLED);</a>
<a name="ln386">      QPlainTextEdit::focusInEvent(event);</a>
<a name="ln387">      }</a>
<a name="ln388"> </a>
<a name="ln389">//---------------------------------------------------------</a>
<a name="ln390">//   focusOutEvent</a>
<a name="ln391">//---------------------------------------------------------</a>
<a name="ln392"> </a>
<a name="ln393">void QmlEdit::focusOutEvent(QFocusEvent* event)</a>
<a name="ln394">      {</a>
<a name="ln395">      mscore-&gt;changeState(mscoreState);</a>
<a name="ln396">      QPlainTextEdit::focusOutEvent(event);</a>
<a name="ln397">      }</a>
<a name="ln398"> </a>
<a name="ln399">//---------------------------------------------------------</a>
<a name="ln400">//   move</a>
<a name="ln401">//---------------------------------------------------------</a>
<a name="ln402"> </a>
<a name="ln403">void QmlEdit::move(QTextCursor::MoveOperation op)</a>
<a name="ln404">      {</a>
<a name="ln405">      QTextCursor tc(textCursor());</a>
<a name="ln406">      tc.movePosition(op);</a>
<a name="ln407">      setTextCursor(tc);</a>
<a name="ln408">      update();</a>
<a name="ln409">      }</a>
<a name="ln410"> </a>
<a name="ln411">//---------------------------------------------------------</a>
<a name="ln412">//   ~QmlEdit</a>
<a name="ln413">//---------------------------------------------------------</a>
<a name="ln414"> </a>
<a name="ln415">QmlEdit::~QmlEdit()</a>
<a name="ln416">      {</a>
<a name="ln417">      delete hl;</a>
<a name="ln418">      }</a>
<a name="ln419"> </a>
<a name="ln420">//---------------------------------------------------------</a>
<a name="ln421">//   lineNumberAreaWidth</a>
<a name="ln422">//---------------------------------------------------------</a>
<a name="ln423"> </a>
<a name="ln424">int QmlEdit::lineNumberAreaWidth()</a>
<a name="ln425">      {</a>
<a name="ln426">      QString num { QString::number(blockCount()) };</a>
<a name="ln427"> </a>
<a name="ln428">      // HACK: boundingRect() subtracts internal whitespace. Internal whitespace</a>
<a name="ln429">      // amounts to roughly half the width, so I multiply by 2. Then I also</a>
<a name="ln430">      // subtract twice the string's length px to combat the left margin growing</a>
<a name="ln431">      // each time the string grows.</a>
<a name="ln432">      int space { 6 + (fontMetrics().boundingRect(num).width() - num.size()) * 2 };</a>
<a name="ln433">      return space;</a>
<a name="ln434">      }</a>
<a name="ln435"> </a>
<a name="ln436">//---------------------------------------------------------</a>
<a name="ln437">//   updateLineNumberAreaWidth</a>
<a name="ln438">//---------------------------------------------------------</a>
<a name="ln439"> </a>
<a name="ln440">void QmlEdit::updateLineNumberAreaWidth(int /* newBlockCount */)</a>
<a name="ln441">      {</a>
<a name="ln442">      setViewportMargins(lineNumberAreaWidth(), 0, 0, 0);</a>
<a name="ln443">      }</a>
<a name="ln444"> </a>
<a name="ln445">//---------------------------------------------------------</a>
<a name="ln446">//   updateLineNumberArea</a>
<a name="ln447">//---------------------------------------------------------</a>
<a name="ln448"> </a>
<a name="ln449">void QmlEdit::updateLineNumberArea(const QRect&amp; rect, int dy)</a>
<a name="ln450">      {</a>
<a name="ln451">      if (dy)</a>
<a name="ln452">            lineNumberArea-&gt;scroll(0, dy);</a>
<a name="ln453">      else</a>
<a name="ln454">            lineNumberArea-&gt;update(0, rect.y(), lineNumberArea-&gt;width(), rect.height());</a>
<a name="ln455"> </a>
<a name="ln456">      if (rect.contains(viewport()-&gt;rect()))</a>
<a name="ln457">            updateLineNumberAreaWidth(0);</a>
<a name="ln458">      }</a>
<a name="ln459"> </a>
<a name="ln460">//---------------------------------------------------------</a>
<a name="ln461">//   resizeEvent</a>
<a name="ln462">//---------------------------------------------------------</a>
<a name="ln463"> </a>
<a name="ln464">void QmlEdit::resizeEvent(QResizeEvent *e)</a>
<a name="ln465">      {</a>
<a name="ln466">      QPlainTextEdit::resizeEvent(e);</a>
<a name="ln467"> </a>
<a name="ln468">      QRect cr = contentsRect();</a>
<a name="ln469">      lineNumberArea-&gt;setGeometry(QRect(cr.left(), cr.top(), lineNumberAreaWidth(), cr.height()));</a>
<a name="ln470">      }</a>
<a name="ln471"> </a>
<a name="ln472">//---------------------------------------------------------</a>
<a name="ln473">//   highlightCurrentLine</a>
<a name="ln474">//---------------------------------------------------------</a>
<a name="ln475"> </a>
<a name="ln476">void QmlEdit::highlightCurrentLine()</a>
<a name="ln477">      {</a>
<a name="ln478">      QList&lt;QTextEdit::ExtraSelection&gt; extraSelections;</a>
<a name="ln479"> </a>
<a name="ln480">      if (!isReadOnly()) {</a>
<a name="ln481">            QTextEdit::ExtraSelection selection;</a>
<a name="ln482"> </a>
<a name="ln483">            QColor lineColor = QColor(Qt::white);</a>
<a name="ln484"> </a>
<a name="ln485">            selection.format.setBackground(lineColor);</a>
<a name="ln486">            selection.format.setProperty(QTextFormat::FullWidthSelection, true);</a>
<a name="ln487">            selection.cursor = textCursor();</a>
<a name="ln488">            selection.cursor.clearSelection();</a>
<a name="ln489">            extraSelections.append(selection);</a>
<a name="ln490">            }</a>
<a name="ln491"> </a>
<a name="ln492">      setExtraSelections(extraSelections);</a>
<a name="ln493">      }</a>
<a name="ln494"> </a>
<a name="ln495">//---------------------------------------------------------</a>
<a name="ln496">//   lineNumberAreaPaintEvent</a>
<a name="ln497">//---------------------------------------------------------</a>
<a name="ln498"> </a>
<a name="ln499">void QmlEdit::lineNumberAreaPaintEvent(QPaintEvent *event)</a>
<a name="ln500">      {</a>
<a name="ln501">      QPainter painter(lineNumberArea);</a>
<a name="ln502">      painter.fillRect(event-&gt;rect(), Qt::lightGray);</a>
<a name="ln503"> </a>
<a name="ln504">      QFont font(&quot;FreeMono&quot;, 12);</a>
<a name="ln505">      font.setStyleHint(QFont::TypeWriter);</a>
<a name="ln506">      font.setFixedPitch(true);</a>
<a name="ln507">      painter.setFont(font);</a>
<a name="ln508"> </a>
<a name="ln509">      QTextBlock block = firstVisibleBlock();</a>
<a name="ln510">      int blockNumber = block.blockNumber();</a>
<a name="ln511">      int top = static_cast&lt;int&gt;(blockBoundingGeometry(block).translated(contentOffset()).top());</a>
<a name="ln512">      int bottom = top + static_cast&lt;int&gt;(blockBoundingRect(block).height());</a>
<a name="ln513"> </a>
<a name="ln514">      int w = lineNumberArea-&gt;width();</a>
<a name="ln515">      int h = fontMetrics().height();</a>
<a name="ln516">      while (block.isValid() &amp;&amp; top &lt;= event-&gt;rect().bottom()) {</a>
<a name="ln517">            if (block.isVisible() &amp;&amp; bottom &gt;= event-&gt;rect().top()) {</a>
<a name="ln518">                  QString number = QString::number(blockNumber + 1);</a>
<a name="ln519">                  painter.setPen(Qt::black);</a>
<a name="ln520">                  painter.drawText(0, top, w-3, h, Qt::AlignRight, number);</a>
<a name="ln521">                  }</a>
<a name="ln522"> </a>
<a name="ln523">            block = block.next();</a>
<a name="ln524">            top   = bottom;</a>
<a name="ln525">            bottom = top + static_cast&lt;int&gt;(blockBoundingRect(block).height());</a>
<a name="ln526">            ++blockNumber;</a>
<a name="ln527">            }</a>
<a name="ln528">      }</a>
<a name="ln529"> </a>
<a name="ln530">//---------------------------------------------------------</a>
<a name="ln531">//   pick</a>
<a name="ln532">//---------------------------------------------------------</a>
<a name="ln533"> </a>
<a name="ln534">void QmlEdit::pick()</a>
<a name="ln535">      {</a>
<a name="ln536">      pickBuffer = textCursor().block().text();</a>
<a name="ln537">      }</a>
<a name="ln538"> </a>
<a name="ln539">//---------------------------------------------------------</a>
<a name="ln540">//   put</a>
<a name="ln541">//---------------------------------------------------------</a>
<a name="ln542"> </a>
<a name="ln543">void QmlEdit::put()</a>
<a name="ln544">      {</a>
<a name="ln545">      QTextCursor c = textCursor();</a>
<a name="ln546">      int column = c.columnNumber();</a>
<a name="ln547">      c.movePosition(QTextCursor::StartOfBlock);</a>
<a name="ln548">      c.insertText(pickBuffer + &quot;\n&quot;);</a>
<a name="ln549">      c.movePosition(QTextCursor::Right, QTextCursor::MoveAnchor, column);</a>
<a name="ln550">      c.movePosition(QTextCursor::Up);</a>
<a name="ln551">      setTextCursor(c);</a>
<a name="ln552">      }</a>
<a name="ln553"> </a>
<a name="ln554">//---------------------------------------------------------</a>
<a name="ln555">//   delLine</a>
<a name="ln556">//---------------------------------------------------------</a>
<a name="ln557"> </a>
<a name="ln558">void QmlEdit::delLine()</a>
<a name="ln559">      {</a>
<a name="ln560">      QTextCursor c = textCursor();</a>
<a name="ln561">      c.select(QTextCursor::BlockUnderCursor);</a>
<a name="ln562">      pickBuffer = c.selectedText().mid(1);</a>
<a name="ln563">      c.removeSelectedText();</a>
<a name="ln564">      c.movePosition(QTextCursor::Down);</a>
<a name="ln565">      setTextCursor(c);</a>
<a name="ln566">      }</a>
<a name="ln567"> </a>
<a name="ln568">//---------------------------------------------------------</a>
<a name="ln569">//   delWord</a>
<a name="ln570">//---------------------------------------------------------</a>
<a name="ln571"> </a>
<a name="ln572">void QmlEdit::delWord()</a>
<a name="ln573">      {</a>
<a name="ln574">      QTextCursor c = textCursor();</a>
<a name="ln575">      int i = c.position();</a>
<a name="ln576">      if (document()-&gt;characterAt(i) == QChar(' ')) {</a>
<a name="ln577">            while(document()-&gt;characterAt(i) == QChar(' '))</a>
<a name="ln578">                  c.deleteChar();</a>
<a name="ln579">            }</a>
<a name="ln580">      else {</a>
<a name="ln581">            for (;;) {</a>
<a name="ln582">                  QChar ch = document()-&gt;characterAt(i);</a>
<a name="ln583">                  if (ch == QChar(' ') || ch == QChar('\n'))</a>
<a name="ln584">                        break;</a>
<a name="ln585">                  c.deleteChar();</a>
<a name="ln586">                  }</a>
<a name="ln587">            while(document()-&gt;characterAt(i) == QChar(' '))</a>
<a name="ln588">                  c.deleteChar();</a>
<a name="ln589">            }</a>
<a name="ln590">      }</a>
<a name="ln591"> </a>
<a name="ln592">//---------------------------------------------------------</a>
<a name="ln593">//   downLine</a>
<a name="ln594">//---------------------------------------------------------</a>
<a name="ln595"> </a>
<a name="ln596">void QmlEdit::downLine()</a>
<a name="ln597">      {</a>
<a name="ln598">      qDebug(&quot;Down line&quot;);</a>
<a name="ln599">      move(QTextCursor::Down);</a>
<a name="ln600">      }</a>
<a name="ln601"> </a>
<a name="ln602">//---------------------------------------------------------</a>
<a name="ln603">//   leftWord</a>
<a name="ln604">//---------------------------------------------------------</a>
<a name="ln605"> </a>
<a name="ln606">void QmlEdit::leftWord()</a>
<a name="ln607">      {</a>
<a name="ln608">      QTextCursor c = textCursor();</a>
<a name="ln609"> </a>
<a name="ln610">      if (c.positionInBlock() == 0)</a>
<a name="ln611">            return;</a>
<a name="ln612">      c.movePosition(QTextCursor::Left);</a>
<a name="ln613"> </a>
<a name="ln614">      bool inSpace = true;</a>
<a name="ln615">      for (;c.positionInBlock();) {</a>
<a name="ln616">            int i = c.position();</a>
<a name="ln617">            if (document()-&gt;characterAt(i) == QChar(' ')) {</a>
<a name="ln618">                  if (!inSpace) {</a>
<a name="ln619">                        c.movePosition(QTextCursor::Right);</a>
<a name="ln620">                        break;</a>
<a name="ln621">                        }</a>
<a name="ln622">                  }</a>
<a name="ln623">            else {</a>
<a name="ln624">                  if (inSpace)</a>
<a name="ln625">                        inSpace = false;</a>
<a name="ln626">                  }</a>
<a name="ln627">            c.movePosition(QTextCursor::Left);</a>
<a name="ln628">            }</a>
<a name="ln629">      setTextCursor(c);</a>
<a name="ln630">      }</a>
<a name="ln631"> </a>
<a name="ln632">//---------------------------------------------------------</a>
<a name="ln633">//   keyPressEvent</a>
<a name="ln634">//---------------------------------------------------------</a>
<a name="ln635"> </a>
<a name="ln636">void QmlEdit::keyPressEvent(QKeyEvent* event)</a>
<a name="ln637">      {</a>
<a name="ln638"> </a>
<a name="ln639">      if (event-&gt;modifiers() != Qt::ControlModifier &amp;&amp; event-&gt;key() == Qt::Key_Tab) {</a>
<a name="ln640">            tab();</a>
<a name="ln641">            event-&gt;accept();</a>
<a name="ln642">            return;</a>
<a name="ln643">            }</a>
<a name="ln644">      if (event-&gt;modifiers() != Qt::ControlModifier &amp;&amp;</a>
<a name="ln645">          (event-&gt;key() == Qt::Key_Enter || event-&gt;key() == Qt::Key_Return)) {</a>
<a name="ln646">            autoIndent();</a>
<a name="ln647">            event-&gt;accept();</a>
<a name="ln648">            return;</a>
<a name="ln649">            }</a>
<a name="ln650">      QPlainTextEdit::keyPressEvent(event);</a>
<a name="ln651">      }</a>
<a name="ln652"> </a>
<a name="ln653">//---------------------------------------------------------</a>
<a name="ln654">//   autoindent - line new line up with start of previous.</a>
<a name="ln655">//---------------------------------------------------------</a>
<a name="ln656">void QmlEdit::autoIndent()</a>
<a name="ln657">      {</a>
<a name="ln658">      QTextCursor c = textCursor();</a>
<a name="ln659">      QTextBlock b = c.block();</a>
<a name="ln660">      QString line = &quot;&quot;;</a>
<a name="ln661">      while (line.trimmed() == &quot;&quot; &amp;&amp; b.isValid()) // Find last non-blank line to line up on.</a>
<a name="ln662">            {</a>
<a name="ln663">            line = b.text();</a>
<a name="ln664">            b = b.previous();</a>
<a name="ln665">            }</a>
<a name="ln666">      int indent = 0;</a>
<a name="ln667">      c.insertText(&quot;\n&quot;);</a>
<a name="ln668">      while (line[indent] == &quot; &quot;) {</a>
<a name="ln669">            indent += 1;</a>
<a name="ln670">            c.insertText(&quot; &quot;);</a>
<a name="ln671">            }</a>
<a name="ln672">      }</a>
<a name="ln673"> </a>
<a name="ln674">//---------------------------------------------------------</a>
<a name="ln675">//   tab</a>
<a name="ln676">//---------------------------------------------------------</a>
<a name="ln677"> </a>
<a name="ln678">void QmlEdit::tab()</a>
<a name="ln679">      {</a>
<a name="ln680">      QTextCursor c = textCursor();</a>
<a name="ln681">      c.insertText(&quot; &quot;);</a>
<a name="ln682">      while (c.positionInBlock() % 6)</a>
<a name="ln683">            c.insertText(&quot; &quot;);</a>
<a name="ln684">      setTextCursor(c);</a>
<a name="ln685">      }</a>
<a name="ln686">}</a>
<a name="ln687"> </a>

</code></pre>
<div class="balloon" rel="163"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1048/" target="_blank">V1048</a> The 'state' variable was assigned the same value.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
