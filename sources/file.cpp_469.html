
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>file.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2014 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">/**</a>
<a name="ln14"> File handling: loading and saving.</a>
<a name="ln15"> */</a>
<a name="ln16"> </a>
<a name="ln17">#include &quot;config.h&quot;</a>
<a name="ln18">#include &quot;globals.h&quot;</a>
<a name="ln19">#include &quot;musescore.h&quot;</a>
<a name="ln20">#include &quot;scoreview.h&quot;</a>
<a name="ln21">#include &quot;exportmidi.h&quot;</a>
<a name="ln22">#include &quot;libmscore/xml.h&quot;</a>
<a name="ln23">#include &quot;libmscore/element.h&quot;</a>
<a name="ln24">#include &quot;libmscore/note.h&quot;</a>
<a name="ln25">#include &quot;libmscore/rest.h&quot;</a>
<a name="ln26">#include &quot;libmscore/sig.h&quot;</a>
<a name="ln27">#include &quot;libmscore/clef.h&quot;</a>
<a name="ln28">#include &quot;libmscore/key.h&quot;</a>
<a name="ln29">#include &quot;instrdialog.h&quot;</a>
<a name="ln30">#include &quot;libmscore/score.h&quot;</a>
<a name="ln31">#include &quot;libmscore/page.h&quot;</a>
<a name="ln32">#include &quot;libmscore/dynamic.h&quot;</a>
<a name="ln33">#include &quot;file.h&quot;</a>
<a name="ln34">#include &quot;libmscore/style.h&quot;</a>
<a name="ln35">#include &quot;libmscore/tempo.h&quot;</a>
<a name="ln36">#include &quot;libmscore/select.h&quot;</a>
<a name="ln37">#include &quot;preferences.h&quot;</a>
<a name="ln38">#include &quot;playpanel.h&quot;</a>
<a name="ln39">#include &quot;libmscore/staff.h&quot;</a>
<a name="ln40">#include &quot;libmscore/part.h&quot;</a>
<a name="ln41">#include &quot;libmscore/utils.h&quot;</a>
<a name="ln42">#include &quot;libmscore/barline.h&quot;</a>
<a name="ln43">#include &quot;palette.h&quot;</a>
<a name="ln44">#include &quot;symboldialog.h&quot;</a>
<a name="ln45">#include &quot;libmscore/slur.h&quot;</a>
<a name="ln46">#include &quot;libmscore/hairpin.h&quot;</a>
<a name="ln47">#include &quot;libmscore/ottava.h&quot;</a>
<a name="ln48">#include &quot;libmscore/textline.h&quot;</a>
<a name="ln49">#include &quot;libmscore/pedal.h&quot;</a>
<a name="ln50">#include &quot;libmscore/trill.h&quot;</a>
<a name="ln51">#include &quot;libmscore/volta.h&quot;</a>
<a name="ln52">#include &quot;newwizard.h&quot;</a>
<a name="ln53">#include &quot;libmscore/timesig.h&quot;</a>
<a name="ln54">#include &quot;libmscore/box.h&quot;</a>
<a name="ln55">#include &quot;libmscore/excerpt.h&quot;</a>
<a name="ln56">#include &quot;libmscore/system.h&quot;</a>
<a name="ln57">#include &quot;libmscore/tuplet.h&quot;</a>
<a name="ln58">#include &quot;libmscore/keysig.h&quot;</a>
<a name="ln59">#include &quot;magbox.h&quot;</a>
<a name="ln60">#include &quot;libmscore/measure.h&quot;</a>
<a name="ln61">#include &quot;libmscore/undo.h&quot;</a>
<a name="ln62">#include &quot;libmscore/repeatlist.h&quot;</a>
<a name="ln63">#include &quot;scoretab.h&quot;</a>
<a name="ln64">#include &quot;libmscore/beam.h&quot;</a>
<a name="ln65">#include &quot;libmscore/stafftype.h&quot;</a>
<a name="ln66">#include &quot;seq.h&quot;</a>
<a name="ln67">#include &quot;libmscore/revisions.h&quot;</a>
<a name="ln68">#include &quot;libmscore/lyrics.h&quot;</a>
<a name="ln69">#include &quot;libmscore/segment.h&quot;</a>
<a name="ln70">#include &quot;libmscore/tempotext.h&quot;</a>
<a name="ln71">#include &quot;libmscore/sym.h&quot;</a>
<a name="ln72">#include &quot;libmscore/image.h&quot;</a>
<a name="ln73">#include &quot;libmscore/stafflines.h&quot;</a>
<a name="ln74">#include &quot;synthesizer/msynthesizer.h&quot;</a>
<a name="ln75">#include &quot;svggenerator.h&quot;</a>
<a name="ln76">#include &quot;scorePreview.h&quot;</a>
<a name="ln77">#include &quot;scorecmp/scorecmp.h&quot;</a>
<a name="ln78">#include &quot;extension.h&quot;</a>
<a name="ln79">#include &quot;tourhandler.h&quot;</a>
<a name="ln80"> </a>
<a name="ln81">#ifdef OMR</a>
<a name="ln82">#include &quot;omr/omr.h&quot;</a>
<a name="ln83">#include &quot;omr/omrpage.h&quot;</a>
<a name="ln84">#include &quot;omr/importpdf.h&quot;</a>
<a name="ln85">#endif</a>
<a name="ln86"> </a>
<a name="ln87">#include &quot;libmscore/chordlist.h&quot;</a>
<a name="ln88">#include &quot;libmscore/mscore.h&quot;</a>
<a name="ln89">#include &quot;thirdparty/qzip/qzipreader_p.h&quot;</a>
<a name="ln90"> </a>
<a name="ln91"> </a>
<a name="ln92">namespace Ms {</a>
<a name="ln93"> </a>
<a name="ln94">extern void importSoundfont(QString name);</a>
<a name="ln95"> </a>
<a name="ln96">extern MasterSynthesizer* synti;</a>
<a name="ln97"> </a>
<a name="ln98">//---------------------------------------------------------</a>
<a name="ln99">//   paintElement(s)</a>
<a name="ln100">//---------------------------------------------------------</a>
<a name="ln101"> </a>
<a name="ln102">static void paintElement(QPainter&amp; p, const Element* e)</a>
<a name="ln103">      {</a>
<a name="ln104">      QPointF pos(e-&gt;pagePos());</a>
<a name="ln105">      p.translate(pos);</a>
<a name="ln106">      e-&gt;draw(&amp;p);</a>
<a name="ln107">      p.translate(-pos);</a>
<a name="ln108">      }</a>
<a name="ln109"> </a>
<a name="ln110">static void paintElements(QPainter&amp; p, const QList&lt;Element*&gt;&amp; el)</a>
<a name="ln111">      {</a>
<a name="ln112">      for (Element* e : el) {</a>
<a name="ln113">            if (!e-&gt;visible())</a>
<a name="ln114">                  continue;</a>
<a name="ln115">            paintElement(p, e);</a>
<a name="ln116">            }</a>
<a name="ln117">      }</a>
<a name="ln118"> </a>
<a name="ln119">//---------------------------------------------------------</a>
<a name="ln120">//   createDefaultFileName</a>
<a name="ln121">//---------------------------------------------------------</a>
<a name="ln122"> </a>
<a name="ln123">static QString createDefaultFileName(QString fn)</a>
<a name="ln124">      {</a>
<a name="ln125">      //</a>
<a name="ln126">      // special characters in filenames are a constant source</a>
<a name="ln127">      // of trouble, this replaces some of them common in german:</a>
<a name="ln128">      //</a>
<a name="ln129">      fn = fn.simplified();</a>
<a name="ln130">      fn = fn.replace(QChar(' '),  &quot;_&quot;);</a>
<a name="ln131">      fn = fn.replace(QChar('\n'), &quot;_&quot;);</a>
<a name="ln132">      fn = fn.replace(QChar(0xe4), &quot;ae&quot;); // &amp;auml;</a>
<a name="ln133">      fn = fn.replace(QChar(0xf6), &quot;oe&quot;); // &amp;ouml;</a>
<a name="ln134">      fn = fn.replace(QChar(0xfc), &quot;ue&quot;); // &amp;uuml;</a>
<a name="ln135">      fn = fn.replace(QChar(0xdf), &quot;ss&quot;); // &amp;szlig;</a>
<a name="ln136">      fn = fn.replace(QChar(0xc4), &quot;Ae&quot;); // &amp;Auml;</a>
<a name="ln137">      fn = fn.replace(QChar(0xd6), &quot;Oe&quot;); // &amp;Ouml;</a>
<a name="ln138">      fn = fn.replace(QChar(0xdc), &quot;Ue&quot;); // &amp;Uuml;</a>
<a name="ln139">      fn = fn.replace(QChar(0x266d),&quot;b&quot;); // musical flat sign, happen in instrument names, so can happen in part (file) names</a>
<a name="ln140">      fn = fn.replace(QChar(0x266f),&quot;#&quot;); // musical sharp sign, can happen in titles, so can happen in score (file) names</a>
<a name="ln141">      fn = fn.replace( QRegExp( &quot;[&quot; + QRegExp::escape( &quot;\\/:*?\&quot;&lt;&gt;|&quot; ) + &quot;]&quot; ), &quot;_&quot; ); //FAT/NTFS special chars</a>
<a name="ln142">      return fn;</a>
<a name="ln143">      }</a>
<a name="ln144"> </a>
<a name="ln145">QString MuseScore::saveFilename(QString fn)</a>
<a name="ln146">      {</a>
<a name="ln147">      return createDefaultFileName(fn);</a>
<a name="ln148">      }</a>
<a name="ln149"> </a>
<a name="ln150">//---------------------------------------------------------</a>
<a name="ln151">//   readScoreError</a>
<a name="ln152">//    if &quot;ask&quot; is true, ask to ignore; returns true if</a>
<a name="ln153">//    ignore is pressed by user</a>
<a name="ln154">//    returns true if -f is used in converter mode</a>
<a name="ln155">//---------------------------------------------------------</a>
<a name="ln156"> </a>
<a name="ln157">static bool readScoreError(const QString&amp; name, Score::FileError error, bool ask)</a>
<a name="ln158">      {</a>
<a name="ln159">//printf(&quot;&lt;%s&gt; %d\n&quot;, qPrintable(name), int(error));</a>
<a name="ln160">      QString msg = QObject::tr(&quot;Cannot read file %1:\n&quot;).arg(name);</a>
<a name="ln161">      QString detailedMsg;</a>
<a name="ln162">      bool canIgnore = false;</a>
<a name="ln163">      switch(error) {</a>
<a name="ln164">            case Score::FileError::FILE_NO_ERROR:</a>
<a name="ln165">                  return false;</a>
<a name="ln166">            case Score::FileError::FILE_BAD_FORMAT:</a>
<a name="ln167">                  msg +=  QObject::tr(&quot;bad format&quot;);</a>
<a name="ln168">                  detailedMsg = MScore::lastError;</a>
<a name="ln169">                  break;</a>
<a name="ln170">            case Score::FileError::FILE_UNKNOWN_TYPE:</a>
<a name="ln171">                  msg += QObject::tr(&quot;unknown type&quot;);</a>
<a name="ln172">                  break;</a>
<a name="ln173">            case Score::FileError::FILE_NO_ROOTFILE:</a>
<a name="ln174">                  break;</a>
<a name="ln175">            case Score::FileError::FILE_TOO_OLD:</a>
<a name="ln176">                  msg += QObject::tr(&quot;It was last saved with a version older than 2.0.0.\n&quot;</a>
<a name="ln177">                                     &quot;You can convert this score by opening and then\n&quot;</a>
<a name="ln178">                                     &quot;saving with MuseScore version 2.x.\n&quot;</a>
<a name="ln179">                                     &quot;Visit the %1MuseScore download page%2 to obtain such a 2.x version.&quot;)</a>
<a name="ln180">                              .arg(&quot;&lt;a href=\&quot;https://musescore.org/download#older-versions\&quot;&gt;&quot;)</a>
<a name="ln181">                              .arg(&quot;&lt;/a&gt;&quot;);</a>
<a name="ln182">                  canIgnore = true;</a>
<a name="ln183">                  break;</a>
<a name="ln184">            case Score::FileError::FILE_TOO_NEW:</a>
<a name="ln185">                  msg += QObject::tr(&quot;This score was saved using a newer version of MuseScore.\n&quot;</a>
<a name="ln186">                                     &quot;Visit the %1MuseScore website%2 to obtain the latest version.&quot;)</a>
<a name="ln187">                              .arg(&quot;&lt;a href=\&quot;https://musescore.org\&quot;&gt;&quot;)</a>
<a name="ln188">                              .arg(&quot;&lt;/a&gt;&quot;);</a>
<a name="ln189">                  canIgnore = true;</a>
<a name="ln190">                  break;</a>
<a name="ln191">            case Score::FileError::FILE_NOT_FOUND:</a>
<a name="ln192">                  msg = QObject::tr(&quot;File \&quot;%1\&quot; not found.&quot;).arg(name);</a>
<a name="ln193">                  break;</a>
<a name="ln194">            case Score::FileError::FILE_CORRUPTED:</a>
<a name="ln195">                  msg = QObject::tr(&quot;File \&quot;%1\&quot; corrupted.&quot;).arg(name);</a>
<a name="ln196">                  detailedMsg = MScore::lastError;</a>
<a name="ln197">                  canIgnore = true;</a>
<a name="ln198">                  break;</a>
<a name="ln199">            case Score::FileError::FILE_OLD_300_FORMAT:</a>
<a name="ln200">                  msg += QObject::tr(&quot;It was last saved with a developer version of 3.0.\n&quot;);</a>
<a name="ln201">                  canIgnore = true;</a>
<a name="ln202">                  break;</a>
<a name="ln203">            case Score::FileError::FILE_ERROR:</a>
<a name="ln204">            case Score::FileError::FILE_OPEN_ERROR:</a>
<a name="ln205">            default:</a>
<a name="ln206">                  msg += MScore::lastError;</a>
<a name="ln207">                  break;</a>
<a name="ln208">            }</a>
<a name="ln209">      if (converterMode &amp;&amp; canIgnore &amp;&amp; ignoreWarnings) {</a>
<a name="ln210">            fprintf(stderr, &quot;%s\n\nWarning ignored, forcing score to load\n&quot;, qPrintable(msg));</a>
<a name="ln211">            return true;</a>
<a name="ln212">            }</a>
<a name="ln213">       if (converterMode || pluginMode) {</a>
<a name="ln214">            fprintf(stderr, &quot;%s\n&quot;, qPrintable(msg));</a>
<a name="ln215">            return false;</a>
<a name="ln216">            }</a>
<a name="ln217">      QMessageBox msgBox;</a>
<a name="ln218">      msgBox.setWindowTitle(QObject::tr(&quot;Load Error&quot;));</a>
<a name="ln219">      msgBox.setText(msg.replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;));</a>
<a name="ln220">      msgBox.setDetailedText(detailedMsg);</a>
<a name="ln221">      msgBox.setTextFormat(Qt::RichText);</a>
<a name="ln222">      if (canIgnore &amp;&amp; ask)  {</a>
<a name="ln223">            msgBox.setIcon(QMessageBox::Warning);</a>
<a name="ln224">            msgBox.setStandardButtons(</a>
<a name="ln225">               QMessageBox::Cancel | QMessageBox::Ignore</a>
<a name="ln226">               );</a>
<a name="ln227">            return msgBox.exec() == QMessageBox::Ignore;</a>
<a name="ln228">            }</a>
<a name="ln229">      else {</a>
<a name="ln230">            msgBox.setIcon(QMessageBox::Critical);</a>
<a name="ln231">            msgBox.setStandardButtons(</a>
<a name="ln232">               QMessageBox::Ok</a>
<a name="ln233">               );</a>
<a name="ln234">            msgBox.exec();</a>
<a name="ln235">            }</a>
<a name="ln236">      return false;</a>
<a name="ln237">      }</a>
<a name="ln238"> </a>
<a name="ln239">//---------------------------------------------------------</a>
<a name="ln240">//   checkDirty</a>
<a name="ln241">//    if dirty, save score</a>
<a name="ln242">//    return true on cancel</a>
<a name="ln243">//---------------------------------------------------------</a>
<a name="ln244"> </a>
<a name="ln245">bool MuseScore::checkDirty(MasterScore* s)</a>
<a name="ln246">      {</a>
<a name="ln247">      if (s-&gt;dirty() || s-&gt;created()) {</a>
<a name="ln248">            QMessageBox::StandardButton n = QMessageBox::warning(this, tr(&quot;MuseScore&quot;),</a>
<a name="ln249">               tr(&quot;Save changes to the score \&quot;%1\&quot;\n&quot;</a>
<a name="ln250">               &quot;before closing?&quot;).arg(s-&gt;fileInfo()-&gt;completeBaseName()),</a>
<a name="ln251">               QMessageBox::Save | QMessageBox::Discard | QMessageBox::Cancel,</a>
<a name="ln252">               QMessageBox::Save);</a>
<a name="ln253">            if (n == QMessageBox::Save) {</a>
<a name="ln254">                  if (s-&gt;masterScore()-&gt;isSavable()) {</a>
<a name="ln255">                        if (!saveFile(s))</a>
<a name="ln256">                              return true;</a>
<a name="ln257">                        }</a>
<a name="ln258">                  else {</a>
<a name="ln259">                        if (!saveAs(s, false))</a>
<a name="ln260">                              return true;</a>
<a name="ln261">                        }</a>
<a name="ln262"> </a>
<a name="ln263">                  }</a>
<a name="ln264">            else if (n == QMessageBox::Cancel)</a>
<a name="ln265">                  return true;</a>
<a name="ln266">            }</a>
<a name="ln267">      return false;</a>
<a name="ln268">      }</a>
<a name="ln269"> </a>
<a name="ln270">//---------------------------------------------------------</a>
<a name="ln271">//   loadFile</a>
<a name="ln272">//---------------------------------------------------------</a>
<a name="ln273"> </a>
<a name="ln274">/**</a>
<a name="ln275"> Create a modal file open dialog.</a>
<a name="ln276"> If a file is selected, load it.</a>
<a name="ln277"> Handles the GUI's file-open action.</a>
<a name="ln278"> */</a>
<a name="ln279"> </a>
<a name="ln280">void MuseScore::loadFiles(bool switchTab, bool singleFile)</a>
<a name="ln281">      {</a>
<a name="ln282">      QStringList files = getOpenScoreNames(</a>
<a name="ln283">#ifdef OMR</a>
<a name="ln284">         tr(&quot;All Supported Files&quot;) + &quot; (*.mscz *.mscx *.mxl *.musicxml *.xml *.mid *.midi *.kar *.md *.mgu *.sgu *.cap *.capx *.pdf *.ove *.scw *.bww *.gtp *.gp3 *.gp4 *.gp5 *.gpx);;&quot; +</a>
<a name="ln285">#else</a>
<a name="ln286">         tr(&quot;All Supported Files&quot;) + &quot; (*.mscz *.mscx *.mxl *.musicxml *.xml *.mid *.midi *.kar *.md *.mgu *.sgu *.cap *.capx *.ove *.scw *.bww *.gtp *.gp3 *.gp4 *.gp5 *.gpx *.ptb);;&quot; +</a>
<a name="ln287">#endif</a>
<a name="ln288">         tr(&quot;MuseScore Files&quot;) + &quot; (*.mscz *.mscx);;&quot; +</a>
<a name="ln289">         tr(&quot;MusicXML Files&quot;) + &quot; (*.mxl *.musicxml *.xml);;&quot; +</a>
<a name="ln290">         tr(&quot;MIDI Files&quot;) + &quot; (*.mid *.midi *.kar);;&quot; +</a>
<a name="ln291">         tr(&quot;MuseData Files&quot;) + &quot; (*.md);;&quot; +</a>
<a name="ln292">         tr(&quot;Capella Files&quot;) + &quot; (*.cap *.capx);;&quot; +</a>
<a name="ln293">         tr(&quot;BB Files (experimental)&quot;) + &quot; (*.mgu *.sgu);;&quot; +</a>
<a name="ln294">#ifdef OMR</a>
<a name="ln295">         tr(&quot;PDF Files (experimental OMR)&quot;) + &quot; (*.pdf);;&quot; +</a>
<a name="ln296">#endif</a>
<a name="ln297">         tr(&quot;Overture / Score Writer Files (experimental)&quot;) + &quot; (*.ove *.scw);;&quot; +</a>
<a name="ln298">         tr(&quot;Bagpipe Music Writer Files (experimental)&quot;) + &quot; (*.bww);;&quot; +</a>
<a name="ln299">         tr(&quot;Guitar Pro Files&quot;) + &quot; (*.gtp *.gp3 *.gp4 *.gp5 *.gpx);;&quot; +</a>
<a name="ln300">         tr(&quot;Power Tab Editor Files (experimental)&quot;) + &quot; (*.ptb)&quot;,</a>
<a name="ln301">         tr(&quot;Load Score&quot;),</a>
<a name="ln302">         singleFile</a>
<a name="ln303">         );</a>
<a name="ln304">      for (const QString&amp; s : files)</a>
<a name="ln305">            openScore(s, switchTab);</a>
<a name="ln306">      mscore-&gt;tourHandler()-&gt;showDelayedWelcomeTour();</a>
<a name="ln307">      }</a>
<a name="ln308"> </a>
<a name="ln309">//---------------------------------------------------------</a>
<a name="ln310">//   openScore</a>
<a name="ln311">//---------------------------------------------------------</a>
<a name="ln312"> </a>
<a name="ln313">Score* MuseScore::openScore(const QString&amp; fn, bool switchTab)</a>
<a name="ln314">      {</a>
<a name="ln315">      //</a>
<a name="ln316">      // make sure we load a file only once</a>
<a name="ln317">      //</a>
<a name="ln318">      QFileInfo fi(fn);</a>
<a name="ln319">      QString path = fi.canonicalFilePath();</a>
<a name="ln320">      for (Score* s : scoreList) {</a>
<a name="ln321">            if (s-&gt;masterScore()-&gt;fileInfo()-&gt;canonicalFilePath() == path) {</a>
<a name="ln322">                  if (switchTab)</a>
<a name="ln323">                        setCurrentScoreView(scoreList.indexOf(s-&gt;masterScore()));</a>
<a name="ln324">                  return 0;</a>
<a name="ln325">                  }</a>
<a name="ln326">            }</a>
<a name="ln327"> </a>
<a name="ln328">      MasterScore* score = readScore(fn);</a>
<a name="ln329">      if (score) {</a>
<a name="ln330">            score-&gt;updateCapo();</a>
<a name="ln331">            const int tabIdx = appendScore(score);</a>
<a name="ln332">            if (switchTab)</a>
<a name="ln333">                  setCurrentScoreView(tabIdx);</a>
<a name="ln334">            writeSessionFile(false);</a>
<a name="ln335">            }</a>
<a name="ln336">      return score;</a>
<a name="ln337">      }</a>
<a name="ln338"> </a>
<a name="ln339">//---------------------------------------------------------</a>
<a name="ln340">//   readScore</a>
<a name="ln341">//---------------------------------------------------------</a>
<a name="ln342"> </a>
<a name="ln343">MasterScore* MuseScore::readScore(const QString&amp; name)</a>
<a name="ln344">      {</a>
<a name="ln345">      if (name.isEmpty())</a>
<a name="ln346">            return 0;</a>
<a name="ln347"> </a>
<a name="ln348">      MasterScore* score = new MasterScore(MScore::baseStyle());</a>
<a name="ln349">      setMidiReopenInProgress(name);</a>
<a name="ln350">      Score::FileError rv = Ms::readScore(score, name, false);</a>
<a name="ln351">      if (rv == Score::FileError::FILE_TOO_OLD || rv == Score::FileError::FILE_TOO_NEW || rv == Score::FileError::FILE_CORRUPTED) {</a>
<a name="ln352">            if (readScoreError(name, rv, true)) {</a>
<a name="ln353">                  if (rv != Score::FileError::FILE_CORRUPTED) {</a>
<a name="ln354">                        // don’t read file again if corrupted</a>
<a name="ln355">                        // the check routine may try to fix it</a>
<a name="ln356">                        delete score;</a>
<a name="ln357">                        score = new MasterScore();</a>
<a name="ln358">                        score-&gt;setMovements(new Movements());</a>
<a name="ln359">                        score-&gt;setStyle(MScore::baseStyle());</a>
<a name="ln360">                        rv = Ms::readScore(score, name, true);</a>
<a name="ln361">                        }</a>
<a name="ln362">                  else</a>
<a name="ln363">                        rv = Score::FileError::FILE_NO_ERROR;</a>
<a name="ln364">                  }</a>
<a name="ln365">            else {</a>
<a name="ln366">                  delete score;</a>
<a name="ln367">                  return 0;</a>
<a name="ln368">                  }</a>
<a name="ln369">            }</a>
<a name="ln370">      if (rv != Score::FileError::FILE_NO_ERROR) {</a>
<a name="ln371">            // in case of user abort while reading, the error has already been reported</a>
<a name="ln372">            // else report it now</a>
<a name="ln373">            if (rv != Score::FileError::FILE_USER_ABORT &amp;&amp; rv != Score::FileError::FILE_IGNORE_ERROR)</a>
<a name="ln374">                  readScoreError(name, rv, false);</a>
<a name="ln375">            delete score;</a>
<a name="ln376">            score = 0;</a>
<a name="ln377">            return 0;</a>
<a name="ln378">            }</a>
<a name="ln379">      allowShowMidiPanel(name);</a>
<a name="ln380">      if (score)</a>
<a name="ln381">            addRecentScore(score);</a>
<a name="ln382"> </a>
<a name="ln383">      return score;</a>
<a name="ln384">      }</a>
<a name="ln385"> </a>
<a name="ln386">//---------------------------------------------------------</a>
<a name="ln387">//   saveFile</a>
<a name="ln388">///   Save the current score.</a>
<a name="ln389">///   Handles the GUI's file-save action.</a>
<a name="ln390">//</a>
<a name="ln391">//    return true on success</a>
<a name="ln392">//---------------------------------------------------------</a>
<a name="ln393"> </a>
<a name="ln394">bool MuseScore::saveFile()</a>
<a name="ln395">      {</a>
<a name="ln396">      return saveFile(cs-&gt;masterScore());</a>
<a name="ln397">      }</a>
<a name="ln398"> </a>
<a name="ln399">//---------------------------------------------------------</a>
<a name="ln400">//   saveFile</a>
<a name="ln401">///   Save the score.</a>
<a name="ln402">//</a>
<a name="ln403">//    return true on success</a>
<a name="ln404">//---------------------------------------------------------</a>
<a name="ln405"> </a>
<a name="ln406">bool MuseScore::saveFile(MasterScore* score)</a>
<a name="ln407">      {</a>
<a name="ln408">      if (score == 0)</a>
<a name="ln409">            return false;</a>
<a name="ln410">      if (score-&gt;created()) {</a>
<a name="ln411">            QString fn = score-&gt;masterScore()-&gt;fileInfo()-&gt;fileName();</a>
<a name="ln412">            Text* t = score-&gt;getText(Tid::TITLE);</a>
<a name="ln413">            if (t)</a>
<a name="ln414">                  fn = t-&gt;plainText();</a>
<a name="ln415">            QString name = createDefaultFileName(fn);</a>
<a name="ln416">            QString f1 = tr(&quot;MuseScore 3 File&quot;) + &quot; (*.mscz)&quot;;</a>
<a name="ln417">            QString f2 = tr(&quot;Uncompressed MuseScore 3 File&quot;) + &quot; (*.mscx)&quot;;     // for debugging purposes</a>
<a name="ln418"> </a>
<a name="ln419">            QSettings set;</a>
<a name="ln420">            if (mscore-&gt;lastSaveDirectory.isEmpty())</a>
<a name="ln421">                  mscore-&gt;lastSaveDirectory = set.value(&quot;lastSaveDirectory&quot;, preferences.getString(PREF_APP_PATHS_MYSCORES)).toString();</a>
<a name="ln422">            QString saveDirectory = mscore-&gt;lastSaveDirectory;</a>
<a name="ln423"> </a>
<a name="ln424">            if (saveDirectory.isEmpty())</a>
<a name="ln425">                  saveDirectory = preferences.getString(PREF_APP_PATHS_MYSCORES);</a>
<a name="ln426"> </a>
<a name="ln427">            QString fname = QString(&quot;%1/%2&quot;).arg(saveDirectory).arg(name);</a>
<a name="ln428">            QString filter = f1 + &quot;;;&quot; + f2;</a>
<a name="ln429">            if (QFileInfo(fname).suffix().isEmpty())</a>
<a name="ln430">                  fname += &quot;.mscz&quot;;</a>
<a name="ln431"> </a>
<a name="ln432">            fn = mscore-&gt;getSaveScoreName(tr(&quot;Save Score&quot;), fname, filter);</a>
<a name="ln433">            if (fn.isEmpty())</a>
<a name="ln434">                  return false;</a>
<a name="ln435">            score-&gt;masterScore()-&gt;fileInfo()-&gt;setFile(fn);</a>
<a name="ln436"> </a>
<a name="ln437">            mscore-&gt;lastSaveDirectory = score-&gt;masterScore()-&gt;fileInfo()-&gt;absolutePath();</a>
<a name="ln438"> </a>
<a name="ln439">            if (!score-&gt;masterScore()-&gt;saveFile()) {</a>
<a name="ln440">                  QMessageBox::critical(mscore, tr(&quot;Save File&quot;), MScore::lastError);</a>
<a name="ln441">                  return false;</a>
<a name="ln442">                  }</a>
<a name="ln443">            addRecentScore(score);</a>
<a name="ln444">            writeSessionFile(false);</a>
<a name="ln445">            }</a>
<a name="ln446">      else if (!score-&gt;masterScore()-&gt;saveFile()) {</a>
<a name="ln447">            QMessageBox::critical(mscore, tr(&quot;Save File&quot;), MScore::lastError);</a>
<a name="ln448">            return false;</a>
<a name="ln449">            }</a>
<a name="ln450">      score-&gt;setCreated(false);</a>
<a name="ln451">      updateWindowTitle(score);</a>
<a name="ln452">      scoreCmpTool-&gt;updateScoreVersions(score);</a>
<a name="ln453">      int idx = scoreList.indexOf(score-&gt;masterScore());</a>
<a name="ln454">      tab1-&gt;setTabText(idx, score-&gt;fileInfo()-&gt;completeBaseName());</a>
<a name="ln455">      if (tab2)</a>
<a name="ln456">            tab2-&gt;setTabText(idx, score-&gt;fileInfo()-&gt;completeBaseName());</a>
<a name="ln457">      QString tmp = score-&gt;tmpName();</a>
<a name="ln458">      if (!tmp.isEmpty()) {</a>
<a name="ln459">            QFile f(tmp);</a>
<a name="ln460">            if (!f.remove())</a>
<a name="ln461">                  qDebug(&quot;cannot remove temporary file &lt;%s&gt;&quot;, qPrintable(f.fileName()));</a>
<a name="ln462">            score-&gt;setTmpName(&quot;&quot;);</a>
<a name="ln463">            }</a>
<a name="ln464">      writeSessionFile(false);</a>
<a name="ln465">      return true;</a>
<a name="ln466">      }</a>
<a name="ln467"> </a>
<a name="ln468">//---------------------------------------------------------</a>
<a name="ln469">//   createDefaultName</a>
<a name="ln470">//---------------------------------------------------------</a>
<a name="ln471"> </a>
<a name="ln472">QString MuseScore::createDefaultName() const</a>
<a name="ln473">      {</a>
<a name="ln474">      QString name(tr(&quot;Untitled&quot;));</a>
<a name="ln475">      int n;</a>
<a name="ln476">      for (n = 1; ; ++n) {</a>
<a name="ln477">            bool nameExists = false;</a>
<a name="ln478">            QString tmpName;</a>
<a name="ln479">            if (n == 1)</a>
<a name="ln480">                  tmpName = name;</a>
<a name="ln481">            else</a>
<a name="ln482">                  tmpName = QString(&quot;%1-%2&quot;).arg(name).arg(n);</a>
<a name="ln483">            for (MasterScore* s : scoreList) {</a>
<a name="ln484">                  if (s-&gt;fileInfo()-&gt;completeBaseName() == tmpName) {</a>
<a name="ln485">                        nameExists = true;</a>
<a name="ln486">                        break;</a>
<a name="ln487">                        }</a>
<a name="ln488">                  }</a>
<a name="ln489">            if (!nameExists) {</a>
<a name="ln490">                  name = tmpName;</a>
<a name="ln491">                  break;</a>
<a name="ln492">                  }</a>
<a name="ln493">            }</a>
<a name="ln494">      return name;</a>
<a name="ln495">      }</a>
<a name="ln496"> </a>
<a name="ln497">//---------------------------------------------------------</a>
<a name="ln498">//   getNewFile</a>
<a name="ln499">//    create new score</a>
<a name="ln500">//---------------------------------------------------------</a>
<a name="ln501"> </a>
<a name="ln502">MasterScore* MuseScore::getNewFile()</a>
<a name="ln503">      {</a>
<a name="ln504">      if (!newWizard)</a>
<a name="ln505">            newWizard = new NewWizard(this);</a>
<a name="ln506">      else {</a>
<a name="ln507">            newWizard-&gt;updateValues();</a>
<a name="ln508">            newWizard-&gt;restart();</a>
<a name="ln509">            }</a>
<a name="ln510">      if (newWizard-&gt;exec() != QDialog::Accepted)</a>
<a name="ln511">            return 0;</a>
<a name="ln512">      int measures            = newWizard-&gt;measures();</a>
<a name="ln513">      Fraction timesig        = newWizard-&gt;timesig();</a>
<a name="ln514">      TimeSigType timesigType = newWizard-&gt;timesigType();</a>
<a name="ln515">      KeySigEvent ks          = newWizard-&gt;keysig();</a>
<a name="ln516">      VBox* nvb               = nullptr;</a>
<a name="ln517"> </a>
<a name="ln518">      int pickupTimesigZ;</a>
<a name="ln519">      int pickupTimesigN;</a>
<a name="ln520">      bool pickupMeasure = newWizard-&gt;pickupMeasure(&amp;pickupTimesigZ, &amp;pickupTimesigN);</a>
<a name="ln521">      if (pickupMeasure)</a>
<a name="ln522">            measures += 1;</a>
<a name="ln523"> </a>
<a name="ln524">      MasterScore* score = new MasterScore(MScore::defaultStyle());</a>
<a name="ln525">      QString tp         = newWizard-&gt;templatePath();</a>
<a name="ln526"> </a>
<a name="ln527">      QList&lt;Excerpt*&gt; excerpts;</a>
<a name="ln528">      if (!newWizard-&gt;emptyScore()) {</a>
<a name="ln529">            MasterScore* tscore = new MasterScore(MScore::defaultStyle());</a>
<a name="ln530">            Score::FileError rv = Ms::readScore(tscore, tp, false);</a>
<a name="ln531">            if (rv != Score::FileError::FILE_NO_ERROR) {</a>
<a name="ln532">                  readScoreError(newWizard-&gt;templatePath(), rv, false);</a>
<a name="ln533">                  delete tscore;</a>
<a name="ln534">                  delete score;</a>
<a name="ln535">                  return 0;</a>
<a name="ln536">                  }</a>
<a name="ln537">            score-&gt;setStyle(tscore-&gt;style());</a>
<a name="ln538"> </a>
<a name="ln539">            // create instruments from template</a>
<a name="ln540">            for (Part* tpart : tscore-&gt;parts()) {</a>
<a name="ln541">                  Part* part = new Part(score);</a>
<a name="ln542">                  part-&gt;setInstrument(tpart-&gt;instrument());</a>
<a name="ln543">                  part-&gt;setPartName(tpart-&gt;partName());</a>
<a name="ln544"> </a>
<a name="ln545">                  for (Staff* tstaff : *tpart-&gt;staves()) {</a>
<a name="ln546">                        Staff* staff = new Staff(score);</a>
<a name="ln547">                        staff-&gt;setPart(part);</a>
<a name="ln548">                        staff-&gt;init(tstaff);</a>
<a name="ln549">                        if (tstaff-&gt;links() &amp;&amp; !part-&gt;staves()-&gt;isEmpty()) {</a>
<a name="ln550">                              Staff* linkedStaff = part-&gt;staves()-&gt;back();</a>
<a name="ln551">                              staff-&gt;linkTo(linkedStaff);</a>
<a name="ln552">                              }</a>
<a name="ln553">                        part-&gt;insertStaff(staff, -1);</a>
<a name="ln554">                        score-&gt;staves().append(staff);</a>
<a name="ln555">                        }</a>
<a name="ln556">                  score-&gt;appendPart(part);</a>
<a name="ln557">                  }</a>
<a name="ln558">            for (Excerpt* ex : tscore-&gt;excerpts()) {</a>
<a name="ln559">                  Excerpt* x = new Excerpt(score);</a>
<a name="ln560">                  x-&gt;setTitle(ex-&gt;title());</a>
<a name="ln561">                  for (Part* p : ex-&gt;parts()) {</a>
<a name="ln562">                        int pidx = tscore-&gt;parts().indexOf(p);</a>
<a name="ln563">                        if (pidx == -1)</a>
<a name="ln564">                              qDebug(&quot;newFile: part not found&quot;);</a>
<a name="ln565">                        else</a>
<a name="ln566">                              x-&gt;parts().append(score-&gt;parts()[pidx]);</a>
<a name="ln567">                        }</a>
<a name="ln568">                  excerpts.append(x);</a>
<a name="ln569">                  }</a>
<a name="ln570">            MeasureBase* mb = tscore-&gt;first();</a>
<a name="ln571">            if (mb &amp;&amp; mb-&gt;isVBox()) {</a>
<a name="ln572">                  VBox* tvb = toVBox(mb);</a>
<a name="ln573">                  nvb = new VBox(score);</a>
<a name="ln574">                  nvb-&gt;setBoxHeight(tvb-&gt;boxHeight());</a>
<a name="ln575">                  nvb-&gt;setBoxWidth(tvb-&gt;boxWidth());</a>
<a name="ln576">                  nvb-&gt;setTopGap(tvb-&gt;topGap());</a>
<a name="ln577">                  nvb-&gt;setBottomGap(tvb-&gt;bottomGap());</a>
<a name="ln578">                  nvb-&gt;setTopMargin(tvb-&gt;topMargin());</a>
<a name="ln579">                  nvb-&gt;setBottomMargin(tvb-&gt;bottomMargin());</a>
<a name="ln580">                  nvb-&gt;setLeftMargin(tvb-&gt;leftMargin());</a>
<a name="ln581">                  nvb-&gt;setRightMargin(tvb-&gt;rightMargin());</a>
<a name="ln582">                  }</a>
<a name="ln583">            delete tscore;</a>
<a name="ln584">            }</a>
<a name="ln585">      else {</a>
<a name="ln586">            score = new MasterScore(MScore::defaultStyle());</a>
<a name="ln587">            newWizard-&gt;createInstruments(score);</a>
<a name="ln588">            }</a>
<a name="ln589">      score-&gt;setCreated(true);</a>
<a name="ln590">      score-&gt;fileInfo()-&gt;setFile(createDefaultName());</a>
<a name="ln591"> </a>
<a name="ln592">      score-&gt;style().checkChordList();</a>
<a name="ln593">      if (!newWizard-&gt;title().isEmpty())</a>
<a name="ln594">            score-&gt;fileInfo()-&gt;setFile(newWizard-&gt;title());</a>
<a name="ln595"> </a>
<a name="ln596">      score-&gt;sigmap()-&gt;add(0, timesig);</a>
<a name="ln597"> </a>
<a name="ln598">      Fraction firstMeasureTicks = pickupMeasure ? Fraction(pickupTimesigZ, pickupTimesigN) : timesig;</a>
<a name="ln599"> </a>
<a name="ln600">      for (int i = 0; i &lt; measures; ++i) {</a>
<a name="ln601">            Fraction tick = firstMeasureTicks + timesig * (i - 1);</a>
<a name="ln602">            if (i == 0)</a>
<a name="ln603">                  tick = Fraction(0,1);</a>
<a name="ln604">            QList&lt;Rest*&gt; puRests;</a>
<a name="ln605">            for (Score* _score : score-&gt;scoreList()) {</a>
<a name="ln606">                  Rest* rest = 0;</a>
<a name="ln607">                  Measure* measure = new Measure(_score);</a>
<a name="ln608">                  measure-&gt;setTimesig(timesig);</a>
<a name="ln609">                  measure-&gt;setTicks(timesig);</a>
<a name="ln610">                  measure-&gt;setTick(tick);</a>
<a name="ln611"> </a>
<a name="ln612">                  if (pickupMeasure &amp;&amp; tick.isZero()) {</a>
<a name="ln613">                        measure-&gt;setIrregular(true);        // don’t count pickup measure</a>
<a name="ln614">                        measure-&gt;setTicks(Fraction(pickupTimesigZ, pickupTimesigN));</a>
<a name="ln615">                        }</a>
<a name="ln616">                  _score-&gt;measures()-&gt;add(measure);</a>
<a name="ln617"> </a>
<a name="ln618">                  for (Staff* staff : _score-&gt;staves()) {</a>
<a name="ln619">                        int staffIdx = staff-&gt;idx();</a>
<a name="ln620">                        if (tick.isZero()) {</a>
<a name="ln621">                              TimeSig* ts = new TimeSig(_score);</a>
<a name="ln622">                              ts-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln623">                              ts-&gt;setSig(timesig, timesigType);</a>
<a name="ln624">                              Measure* m = _score-&gt;firstMeasure();</a>
<a name="ln625">                              Segment* s = m-&gt;getSegment(SegmentType::TimeSig, Fraction(0,1));</a>
<a name="ln626">                              s-&gt;add(ts);</a>
<a name="ln627">                              Part* part = staff-&gt;part();</a>
<a name="ln628">                              if (!part-&gt;instrument()-&gt;useDrumset()) {</a>
<a name="ln629">                                    //</a>
<a name="ln630">                                    // transpose key</a>
<a name="ln631">                                    //</a>
<a name="ln632">                                    KeySigEvent nKey = ks;</a>
<a name="ln633">                                    if (!nKey.custom() &amp;&amp; !nKey.isAtonal() &amp;&amp; part-&gt;instrument()-&gt;transpose().chromatic &amp;&amp; !score-&gt;styleB(Sid::concertPitch)) {</a>
<a name="ln634">                                          int diff = -part-&gt;instrument()-&gt;transpose().chromatic;</a>
<a name="ln635">                                          nKey.setKey(transposeKey(nKey.key(), diff, part-&gt;preferSharpFlat()));</a>
<a name="ln636">                                          }</a>
<a name="ln637">                                    // do not create empty keysig unless custom or atonal</a>
<a name="ln638">                                    if (nKey.custom() || nKey.isAtonal() || nKey.key() != Key::C) {</a>
<a name="ln639">                                          staff-&gt;setKey(Fraction(0,1), nKey);</a>
<a name="ln640">                                          KeySig* keysig = new KeySig(score);</a>
<a name="ln641">                                          keysig-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln642">                                          keysig-&gt;setKeySigEvent(nKey);</a>
<a name="ln643">                                          Segment* ss = measure-&gt;getSegment(SegmentType::KeySig, Fraction(0,1));</a>
<a name="ln644">                                          ss-&gt;add(keysig);</a>
<a name="ln645">                                          }</a>
<a name="ln646">                                    }</a>
<a name="ln647">                              }</a>
<a name="ln648"> </a>
<a name="ln649">                        // determined if this staff is linked to previous so we can reuse rests</a>
<a name="ln650">                        bool linkedToPrevious = staffIdx &amp;&amp; staff-&gt;isLinked(_score-&gt;staff(staffIdx - 1));</a>
<a name="ln651">                        if (measure-&gt;timesig() != measure-&gt;ticks()) {</a>
<a name="ln652">                              if (!linkedToPrevious)</a>
<a name="ln653">                                    puRests.clear();</a>
<a name="ln654">                              std::vector&lt;TDuration&gt; dList = toDurationList(measure-&gt;ticks(), false);</a>
<a name="ln655">                              if (!dList.empty()) {</a>
<a name="ln656">                                    Fraction ltick = tick;</a>
<a name="ln657">                                    int k = 0;</a>
<a name="ln658">                                    foreach (TDuration d, dList) {</a>
<a name="ln659">                                          if (k &lt; puRests.count())</a>
<a name="ln660">                                                rest = static_cast&lt;Rest*&gt;(puRests[k]-&gt;linkedClone());</a>
<a name="ln661">                                          else {</a>
<a name="ln662">                                                rest = new Rest(score, d);</a>
<a name="ln663">                                                puRests.append(rest);</a>
<a name="ln664">                                                }</a>
<a name="ln665">                                          rest-&gt;setScore(_score);</a>
<a name="ln666">                                          rest-&gt;setTicks(d.fraction());</a>
<a name="ln667">                                          rest-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln668">                                          Segment* seg = measure-&gt;getSegment(SegmentType::ChordRest, ltick);</a>
<a name="ln669">                                          seg-&gt;add(rest);</a>
<a name="ln670">                                          ltick += rest-&gt;actualTicks();</a>
<a name="ln671">                                          k++;</a>
<a name="ln672">                                          }</a>
<a name="ln673">                                    }</a>
<a name="ln674">                              }</a>
<a name="ln675">                        else {</a>
<a name="ln676">                              if (linkedToPrevious &amp;&amp; rest)</a>
<a name="ln677">                                    rest = static_cast&lt;Rest*&gt;(rest-&gt;linkedClone());</a>
<a name="ln678">                              else</a>
<a name="ln679">                                    rest = new Rest(score, TDuration(TDuration::DurationType::V_MEASURE));</a>
<a name="ln680">                              rest-&gt;setScore(_score);</a>
<a name="ln681">                              rest-&gt;setTicks(measure-&gt;ticks());</a>
<a name="ln682">                              rest-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln683">                              Segment* seg = measure-&gt;getSegment(SegmentType::ChordRest, tick);</a>
<a name="ln684">                              seg-&gt;add(rest);</a>
<a name="ln685">                              }</a>
<a name="ln686">                        }</a>
<a name="ln687">                  }</a>
<a name="ln688">            }</a>
<a name="ln689">//TODO      score-&gt;lastMeasure()-&gt;setEndBarLineType(BarLineType::END, false);</a>
<a name="ln690"> </a>
<a name="ln691">      //</a>
<a name="ln692">      // select first rest</a>
<a name="ln693">      //</a>
<a name="ln694">      Measure* m = score-&gt;firstMeasure();</a>
<a name="ln695">      for (Segment* s = m-&gt;first(); s; s = s-&gt;next()) {</a>
<a name="ln696">            if (s-&gt;segmentType() == SegmentType::ChordRest) {</a>
<a name="ln697">                  if (s-&gt;element(0)) {</a>
<a name="ln698">                        score-&gt;select(s-&gt;element(0), SelectType::SINGLE, 0);</a>
<a name="ln699">                        break;</a>
<a name="ln700">                        }</a>
<a name="ln701">                  }</a>
<a name="ln702">            }</a>
<a name="ln703"> </a>
<a name="ln704">      QString title     = newWizard-&gt;title();</a>
<a name="ln705">      QString subtitle  = newWizard-&gt;subtitle();</a>
<a name="ln706">      QString composer  = newWizard-&gt;composer();</a>
<a name="ln707">      QString poet      = newWizard-&gt;poet();</a>
<a name="ln708">      QString copyright = newWizard-&gt;copyright();</a>
<a name="ln709"> </a>
<a name="ln710">      if (!title.isEmpty() || !subtitle.isEmpty() || !composer.isEmpty() || !poet.isEmpty()) {</a>
<a name="ln711">            MeasureBase* measure = score-&gt;measures()-&gt;first();</a>
<a name="ln712">            if (measure-&gt;type() != ElementType::VBOX) {</a>
<a name="ln713">                  MeasureBase* nm = nvb ? nvb : new VBox(score);</a>
<a name="ln714">                  nm-&gt;setTick(Fraction(0,1));</a>
<a name="ln715">                  nm-&gt;setNext(measure);</a>
<a name="ln716">                  score-&gt;measures()-&gt;add(nm);</a>
<a name="ln717">                  measure = nm;</a>
<a name="ln718">                  }</a>
<a name="ln719">            else if (nvb) {</a>
<a name="ln720">                  delete nvb;</a>
<a name="ln721">                  }</a>
<a name="ln722">            if (!title.isEmpty()) {</a>
<a name="ln723">                  Text* s = new Text(score, Tid::TITLE);</a>
<a name="ln724">                  s-&gt;setPlainText(title);</a>
<a name="ln725">                  measure-&gt;add(s);</a>
<a name="ln726">                  score-&gt;setMetaTag(&quot;workTitle&quot;, title);</a>
<a name="ln727">                  }</a>
<a name="ln728">            if (!subtitle.isEmpty()) {</a>
<a name="ln729">                  Text* s = new Text(score, Tid::SUBTITLE);</a>
<a name="ln730">                  s-&gt;setPlainText(subtitle);</a>
<a name="ln731">                  measure-&gt;add(s);</a>
<a name="ln732">                  }</a>
<a name="ln733">            if (!composer.isEmpty()) {</a>
<a name="ln734">                  Text* s = new Text(score, Tid::COMPOSER);</a>
<a name="ln735">                  s-&gt;setPlainText(composer);</a>
<a name="ln736">                  measure-&gt;add(s);</a>
<a name="ln737">                  score-&gt;setMetaTag(&quot;composer&quot;, composer);</a>
<a name="ln738">                  }</a>
<a name="ln739">            if (!poet.isEmpty()) {</a>
<a name="ln740">                  Text* s = new Text(score, Tid::POET);</a>
<a name="ln741">                  s-&gt;setPlainText(poet);</a>
<a name="ln742">                  measure-&gt;add(s);</a>
<a name="ln743">                  // the poet() functions returns data called lyricist in the dialog</a>
<a name="ln744">                  score-&gt;setMetaTag(&quot;lyricist&quot;, poet);</a>
<a name="ln745">                  }</a>
<a name="ln746">            }</a>
<a name="ln747">      else if (nvb) {</a>
<a name="ln748">            delete nvb;</a>
<a name="ln749">            }</a>
<a name="ln750"> </a>
<a name="ln751">      if (newWizard-&gt;createTempo()) {</a>
<a name="ln752">            double tempo = newWizard-&gt;tempo();</a>
<a name="ln753">            TempoText* tt = new TempoText(score);</a>
<a name="ln754">            tt-&gt;setXmlText(QString(&quot;&lt;sym&gt;metNoteQuarterUp&lt;/sym&gt; = %1&quot;).arg(tempo));</a>
<a name="ln755">            tempo /= 60;      // bpm -&gt; bps</a>
<a name="ln756"> </a>
<a name="ln757">            tt-&gt;setTempo(tempo);</a>
<a name="ln758">            tt-&gt;setFollowText(true);</a>
<a name="ln759">            tt-&gt;setTrack(0);</a>
<a name="ln760">            Segment* seg = score-&gt;firstMeasure()-&gt;first(SegmentType::ChordRest);</a>
<a name="ln761">            seg-&gt;add(tt);</a>
<a name="ln762">            score-&gt;setTempo(seg, tempo);</a>
<a name="ln763">            }</a>
<a name="ln764">      if (!copyright.isEmpty())</a>
<a name="ln765">            score-&gt;setMetaTag(&quot;copyright&quot;, copyright);</a>
<a name="ln766"> </a>
<a name="ln767">      if (synti)</a>
<a name="ln768">            score-&gt;setSynthesizerState(synti-&gt;state());</a>
<a name="ln769"> </a>
<a name="ln770">      // Call this even if synti doesn't exist - we need to rebuild either way</a>
<a name="ln771">      score-&gt;rebuildAndUpdateExpressive(MuseScore::synthesizer(&quot;Fluid&quot;));</a>
<a name="ln772"> </a>
<a name="ln773">      {</a>
<a name="ln774">            ScoreLoad sl;</a>
<a name="ln775">            score-&gt;doLayout();</a>
<a name="ln776">            }</a>
<a name="ln777"> </a>
<a name="ln778">      for (Excerpt* x : excerpts) {</a>
<a name="ln779">            Score* xs = new Score(static_cast&lt;MasterScore*&gt;(score));</a>
<a name="ln780">            xs-&gt;style().set(Sid::createMultiMeasureRests, true);</a>
<a name="ln781">            x-&gt;setPartScore(xs);</a>
<a name="ln782">            xs-&gt;setExcerpt(x);</a>
<a name="ln783">            score-&gt;excerpts().append(x);</a>
<a name="ln784">            Excerpt::createExcerpt(x);</a>
<a name="ln785">            }</a>
<a name="ln786">      score-&gt;setExcerptsChanged(true);</a>
<a name="ln787">      return score;</a>
<a name="ln788">      }</a>
<a name="ln789"> </a>
<a name="ln790">//---------------------------------------------------------</a>
<a name="ln791">//   newFile</a>
<a name="ln792">//    create new score</a>
<a name="ln793">//---------------------------------------------------------</a>
<a name="ln794"> </a>
<a name="ln795">void MuseScore::newFile()</a>
<a name="ln796">      {</a>
<a name="ln797">      MasterScore* score = getNewFile();</a>
<a name="ln798">      if (score)</a>
<a name="ln799">            setCurrentScoreView(appendScore(score));</a>
<a name="ln800">      mscore-&gt;tourHandler()-&gt;showDelayedWelcomeTour();</a>
<a name="ln801">      }</a>
<a name="ln802"> </a>
<a name="ln803">//---------------------------------------------------------</a>
<a name="ln804">//   copy</a>
<a name="ln805">//    Copy content of src file do dest file overwriting it.</a>
<a name="ln806">//    Implemented manually as QFile::copy refuses to</a>
<a name="ln807">//    overwrite existing files.</a>
<a name="ln808">//---------------------------------------------------------</a>
<a name="ln809"> </a>
<a name="ln810">static bool copy(QFile&amp; src, QFile&amp; dest)</a>
<a name="ln811">      {</a>
<a name="ln812">      src.open(QIODevice::ReadOnly);</a>
<a name="ln813">      dest.open(QIODevice::WriteOnly);</a>
<a name="ln814">      constexpr qint64 size = 1024 * 1024;</a>
<a name="ln815">      char* buf = new char[size];</a>
<a name="ln816">      bool err = false;</a>
<a name="ln817">      while (qint64 r = src.read(buf, size)) {</a>
<a name="ln818">            if (r &lt; 0) {</a>
<a name="ln819">                  err = true;</a>
<a name="ln820">                  break;</a>
<a name="ln821">                  }</a>
<a name="ln822">            qint64 w = dest.write(buf, r);</a>
<a name="ln823">            if (w &lt; r) {</a>
<a name="ln824">                  err = true;</a>
<a name="ln825">                  break;</a>
<a name="ln826">                  }</a>
<a name="ln827">            }</a>
<a name="ln828">      dest.close();</a>
<a name="ln829">      src.close();</a>
<a name="ln830">      delete[] buf;</a>
<a name="ln831">      return !err;</a>
<a name="ln832">      }</a>
<a name="ln833"> </a>
<a name="ln834">//---------------------------------------------------------</a>
<a name="ln835">//   getTemporaryScoreFileCopy</a>
<a name="ln836">//    baseNameTemplate is the template to be passed to</a>
<a name="ln837">//    QTemporaryFile constructor but without suffix and</a>
<a name="ln838">//    directory --- they are defined automatically.</a>
<a name="ln839">//---------------------------------------------------------</a>
<a name="ln840"> </a>
<a name="ln841">QTemporaryFile* MuseScore::getTemporaryScoreFileCopy(const QFileInfo&amp; info, const QString&amp; baseNameTemplate)</a>
<a name="ln842">      {</a>
<a name="ln843">      QString suffix(info.suffix());</a>
<a name="ln844">      if (suffix.endsWith(&quot;,&quot;)) // some backup files created by MuseScore</a>
<a name="ln845">            suffix.chop(1);</a>
<a name="ln846">      QTemporaryFile* f = new QTemporaryFile(</a>
<a name="ln847">         QDir::temp().absoluteFilePath(baseNameTemplate + '.' + suffix),</a>
<a name="ln848">         this</a>
<a name="ln849">         );</a>
<a name="ln850">      QFile src(info.absoluteFilePath());</a>
<a name="ln851">      if (!copy(src, *f)) {</a>
<a name="ln852">            delete f;</a>
<a name="ln853">            return nullptr;</a>
<a name="ln854">            }</a>
<a name="ln855">      return f;</a>
<a name="ln856">      }</a>
<a name="ln857"> </a>
<a name="ln858">//---------------------------------------------------------</a>
<a name="ln859">//   addScorePreview</a>
<a name="ln860">//    add a score preview to the file dialog</a>
<a name="ln861">//---------------------------------------------------------</a>
<a name="ln862"> </a>
<a name="ln863">static void addScorePreview(QFileDialog* dialog)</a>
<a name="ln864">      {</a>
<a name="ln865">      QSplitter* splitter = dialog-&gt;findChild&lt;QSplitter*&gt;(&quot;splitter&quot;);</a>
<a name="ln866">      if (splitter) {</a>
<a name="ln867">            ScorePreview* preview = new ScorePreview;</a>
<a name="ln868">            splitter-&gt;addWidget(preview);</a>
<a name="ln869">            dialog-&gt;connect(dialog, SIGNAL(currentChanged(const QString&amp;)), preview, SLOT(setScore(const QString&amp;)));</a>
<a name="ln870">            }</a>
<a name="ln871">      }</a>
<a name="ln872"> </a>
<a name="ln873">//---------------------------------------------------------</a>
<a name="ln874">//   sidebarUrls</a>
<a name="ln875">//    return a list of standard file dialog sidebar urls</a>
<a name="ln876">//---------------------------------------------------------</a>
<a name="ln877"> </a>
<a name="ln878">static QList&lt;QUrl&gt; sidebarUrls()</a>
<a name="ln879">      {</a>
<a name="ln880">      QList&lt;QUrl&gt; urls;</a>
<a name="ln881">      urls.append(QUrl::fromLocalFile(QDir::homePath()));</a>
<a name="ln882">      QFileInfo myScores(preferences.getString(PREF_APP_PATHS_MYSCORES));</a>
<a name="ln883">      urls.append(QUrl::fromLocalFile(myScores.absoluteFilePath()));</a>
<a name="ln884">      urls.append(QUrl::fromLocalFile(QDir::currentPath()));</a>
<a name="ln885">      return urls;</a>
<a name="ln886">      }</a>
<a name="ln887"> </a>
<a name="ln888">//---------------------------------------------------------</a>
<a name="ln889">//   getOpenScoreNames</a>
<a name="ln890">//---------------------------------------------------------</a>
<a name="ln891"> </a>
<a name="ln892">QStringList MuseScore::getOpenScoreNames(const QString&amp; filter, const QString&amp; title, bool singleFile)</a>
<a name="ln893">      {</a>
<a name="ln894">      QSettings set;</a>
<a name="ln895">      QString dir = set.value(&quot;lastOpenPath&quot;, preferences.getString(PREF_APP_PATHS_MYSCORES)).toString();</a>
<a name="ln896">      if (preferences.getBool(PREF_UI_APP_USENATIVEDIALOGS)) {</a>
<a name="ln897">            QStringList fileList = QFileDialog::getOpenFileNames(this,</a>
<a name="ln898">               title, dir, filter);</a>
<a name="ln899">            if (fileList.count() &gt; 0) {</a>
<a name="ln900">                  QFileInfo fi(fileList[0]);</a>
<a name="ln901">                  set.setValue(&quot;lastOpenPath&quot;, fi.absolutePath());</a>
<a name="ln902">                  }</a>
<a name="ln903">            return fileList;</a>
<a name="ln904">            }</a>
<a name="ln905">      QFileInfo myScores(preferences.getString(PREF_APP_PATHS_MYSCORES));</a>
<a name="ln906">      if (myScores.isRelative())</a>
<a name="ln907">            myScores.setFile(QDir::home(), preferences.getString(PREF_APP_PATHS_MYSCORES));</a>
<a name="ln908"> </a>
<a name="ln909">      if (loadScoreDialog == 0) {</a>
<a name="ln910">            loadScoreDialog = new QFileDialog(this);</a>
<a name="ln911">            loadScoreDialog-&gt;setFileMode(singleFile ? QFileDialog::ExistingFile : QFileDialog::ExistingFiles);</a>
<a name="ln912">            loadScoreDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln913">            loadScoreDialog-&gt;setWindowTitle(title);</a>
<a name="ln914">            addScorePreview(loadScoreDialog);</a>
<a name="ln915"> </a>
<a name="ln916">            loadScoreDialog-&gt;setNameFilter(filter);</a>
<a name="ln917">            restoreDialogState(&quot;loadScoreDialog&quot;, loadScoreDialog);</a>
<a name="ln918">            loadScoreDialog-&gt;setAcceptMode(QFileDialog::AcceptOpen);</a>
<a name="ln919">            loadScoreDialog-&gt;setDirectory(dir);</a>
<a name="ln920">            }</a>
<a name="ln921">      else {</a>
<a name="ln922">            // dialog already exists, but set title and filter</a>
<a name="ln923">            loadScoreDialog-&gt;setWindowTitle(title);</a>
<a name="ln924">            loadScoreDialog-&gt;setNameFilter(filter);</a>
<a name="ln925">            }</a>
<a name="ln926">      // setup side bar urls</a>
<a name="ln927">      QList&lt;QUrl&gt; urls = sidebarUrls();</a>
<a name="ln928">      urls.append(QUrl::fromLocalFile(mscoreGlobalShare+&quot;/demos&quot;));</a>
<a name="ln929">      loadScoreDialog-&gt;setSidebarUrls(urls);</a>
<a name="ln930"> </a>
<a name="ln931">      QStringList result;</a>
<a name="ln932">      if (loadScoreDialog-&gt;exec())</a>
<a name="ln933">            result = loadScoreDialog-&gt;selectedFiles();</a>
<a name="ln934">      set.setValue(&quot;lastOpenPath&quot;, loadScoreDialog-&gt;directory().absolutePath());</a>
<a name="ln935">      return result;</a>
<a name="ln936">      }</a>
<a name="ln937"> </a>
<a name="ln938">//---------------------------------------------------------</a>
<a name="ln939">//   getSaveScoreName</a>
<a name="ln940">//---------------------------------------------------------</a>
<a name="ln941"> </a>
<a name="ln942">QString MuseScore::getSaveScoreName(const QString&amp; title, QString&amp; name, const QString&amp; filter, bool selectFolder)</a>
<a name="ln943">      {</a>
<a name="ln944">      QFileInfo myName(name);</a>
<a name="ln945">      if (myName.isRelative())</a>
<a name="ln946">            myName.setFile(QDir::home(), name);</a>
<a name="ln947">      name = myName.absoluteFilePath();</a>
<a name="ln948"> </a>
<a name="ln949">      if (preferences.getBool(PREF_UI_APP_USENATIVEDIALOGS)) {</a>
<a name="ln950">            QString s;</a>
<a name="ln951">            QFileDialog::Options options = selectFolder ? QFileDialog::ShowDirsOnly : QFileDialog::Options(0);</a>
<a name="ln952">            return QFileDialog::getSaveFileName(this, title, name, filter, &amp;s, options);</a>
<a name="ln953">            }</a>
<a name="ln954"> </a>
<a name="ln955">      QFileInfo myScores(preferences.getString(PREF_APP_PATHS_MYSCORES));</a>
<a name="ln956">      if (myScores.isRelative())</a>
<a name="ln957">            myScores.setFile(QDir::home(), preferences.getString(PREF_APP_PATHS_MYSCORES));</a>
<a name="ln958">      if (saveScoreDialog == 0) {</a>
<a name="ln959">            saveScoreDialog = new QFileDialog(this);</a>
<a name="ln960">            saveScoreDialog-&gt;setFileMode(QFileDialog::AnyFile);</a>
<a name="ln961">            saveScoreDialog-&gt;setOption(QFileDialog::DontConfirmOverwrite, false);</a>
<a name="ln962">            saveScoreDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln963">            saveScoreDialog-&gt;setAcceptMode(QFileDialog::AcceptSave);</a>
<a name="ln964">            addScorePreview(saveScoreDialog);</a>
<a name="ln965"> </a>
<a name="ln966">            restoreDialogState(&quot;saveScoreDialog&quot;, saveScoreDialog);</a>
<a name="ln967">            }</a>
<a name="ln968">      // setup side bar urls</a>
<a name="ln969">      saveScoreDialog-&gt;setSidebarUrls(sidebarUrls());</a>
<a name="ln970"> </a>
<a name="ln971">      if (selectFolder)</a>
<a name="ln972">            saveScoreDialog-&gt;setFileMode(QFileDialog::Directory);</a>
<a name="ln973"> </a>
<a name="ln974">      saveScoreDialog-&gt;setWindowTitle(title);</a>
<a name="ln975">      saveScoreDialog-&gt;setNameFilter(filter);</a>
<a name="ln976">      saveScoreDialog-&gt;selectFile(name);</a>
<a name="ln977"> </a>
<a name="ln978">      if (!selectFolder) {</a>
<a name="ln979">            connect(saveScoreDialog, SIGNAL(filterSelected(const QString&amp;)),</a>
<a name="ln980">               SLOT(saveScoreDialogFilterSelected(const QString&amp;)));</a>
<a name="ln981">            }</a>
<a name="ln982">      QString s;</a>
<a name="ln983">      if (saveScoreDialog-&gt;exec())</a>
<a name="ln984">            s = saveScoreDialog-&gt;selectedFiles().front();</a>
<a name="ln985">      return s;</a>
<a name="ln986">      }</a>
<a name="ln987"> </a>
<a name="ln988">//---------------------------------------------------------</a>
<a name="ln989">//   saveScoreDialogFilterSelected</a>
<a name="ln990">//    update selected file name extensions, when filter</a>
<a name="ln991">//    has changed</a>
<a name="ln992">//---------------------------------------------------------</a>
<a name="ln993"> </a>
<a name="ln994">void MuseScore::saveScoreDialogFilterSelected(const QString&amp; s)</a>
<a name="ln995">      {</a>
<a name="ln996">      QRegExp rx(QString(&quot;.+\\(\\*\\.(.+)\\)&quot;));</a>
<a name="ln997">      if (rx.exactMatch(s)) {</a>
<a name="ln998">            QFileInfo fi(saveScoreDialog-&gt;selectedFiles().front());</a>
<a name="ln999">            saveScoreDialog-&gt;selectFile(fi.completeBaseName() + &quot;.&quot; + rx.cap(1));</a>
<a name="ln1000">            }</a>
<a name="ln1001">      }</a>
<a name="ln1002"> </a>
<a name="ln1003">//---------------------------------------------------------</a>
<a name="ln1004">//   getStyleFilename</a>
<a name="ln1005">//---------------------------------------------------------</a>
<a name="ln1006"> </a>
<a name="ln1007">QString MuseScore::getStyleFilename(bool open, const QString&amp; title)</a>
<a name="ln1008">      {</a>
<a name="ln1009">      QFileInfo myStyles(preferences.getString(PREF_APP_PATHS_MYSTYLES));</a>
<a name="ln1010">      if (myStyles.isRelative())</a>
<a name="ln1011">            myStyles.setFile(QDir::home(), preferences.getString(PREF_APP_PATHS_MYSTYLES));</a>
<a name="ln1012">      QString defaultPath = myStyles.absoluteFilePath();</a>
<a name="ln1013"> </a>
<a name="ln1014">      if (preferences.getBool(PREF_UI_APP_USENATIVEDIALOGS)) {</a>
<a name="ln1015">            QString fn;</a>
<a name="ln1016">            if (open) {</a>
<a name="ln1017">                  fn = QFileDialog::getOpenFileName(</a>
<a name="ln1018">                     this, tr(&quot;Load Style&quot;),</a>
<a name="ln1019">                     defaultPath,</a>
<a name="ln1020">                     tr(&quot;MuseScore Styles&quot;) + &quot; (*.mss)&quot;</a>
<a name="ln1021">                     );</a>
<a name="ln1022">                  }</a>
<a name="ln1023">            else {</a>
<a name="ln1024">                  fn = QFileDialog::getSaveFileName(</a>
<a name="ln1025">                     this, tr(&quot;Save Style&quot;),</a>
<a name="ln1026">                     defaultPath,</a>
<a name="ln1027">                     tr(&quot;MuseScore Style File&quot;) + &quot; (*.mss)&quot;</a>
<a name="ln1028">                     );</a>
<a name="ln1029">                  }</a>
<a name="ln1030">            return fn;</a>
<a name="ln1031">            }</a>
<a name="ln1032"> </a>
<a name="ln1033">      QFileDialog* dialog;</a>
<a name="ln1034">      QList&lt;QUrl&gt; urls;</a>
<a name="ln1035">      QString home = QDir::homePath();</a>
<a name="ln1036">      urls.append(QUrl::fromLocalFile(home));</a>
<a name="ln1037">      urls.append(QUrl::fromLocalFile(defaultPath));</a>
<a name="ln1038">      urls.append(QUrl::fromLocalFile(QDir::currentPath()));</a>
<a name="ln1039"> </a>
<a name="ln1040">      if (open) {</a>
<a name="ln1041">            if (loadStyleDialog == 0) {</a>
<a name="ln1042">                  loadStyleDialog = new QFileDialog(this);</a>
<a name="ln1043">                  loadStyleDialog-&gt;setFileMode(QFileDialog::ExistingFile);</a>
<a name="ln1044">                  loadStyleDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln1045">                  loadStyleDialog-&gt;setWindowTitle(title.isEmpty() ? tr(&quot;Load Style&quot;) : title);</a>
<a name="ln1046">                  loadStyleDialog-&gt;setNameFilter(tr(&quot;MuseScore Style File&quot;) + &quot; (*.mss)&quot;);</a>
<a name="ln1047">                  loadStyleDialog-&gt;setDirectory(defaultPath);</a>
<a name="ln1048"> </a>
<a name="ln1049">                  restoreDialogState(&quot;loadStyleDialog&quot;, loadStyleDialog);</a>
<a name="ln1050">                  loadStyleDialog-&gt;setAcceptMode(QFileDialog::AcceptOpen);</a>
<a name="ln1051">                  }</a>
<a name="ln1052">            urls.append(QUrl::fromLocalFile(mscoreGlobalShare+&quot;/styles&quot;));</a>
<a name="ln1053">            dialog = loadStyleDialog;</a>
<a name="ln1054">            }</a>
<a name="ln1055">      else {</a>
<a name="ln1056">            if (saveStyleDialog == 0) {</a>
<a name="ln1057">                  saveStyleDialog = new QFileDialog(this);</a>
<a name="ln1058">                  saveStyleDialog-&gt;setAcceptMode(QFileDialog::AcceptSave);</a>
<a name="ln1059">                  saveStyleDialog-&gt;setFileMode(QFileDialog::AnyFile);</a>
<a name="ln1060">                  saveStyleDialog-&gt;setOption(QFileDialog::DontConfirmOverwrite, false);</a>
<a name="ln1061">                  saveStyleDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln1062">                  saveStyleDialog-&gt;setWindowTitle(title.isEmpty() ? tr(&quot;Save Style&quot;) : title);</a>
<a name="ln1063">                  saveStyleDialog-&gt;setNameFilter(tr(&quot;MuseScore Style File&quot;) + &quot; (*.mss)&quot;);</a>
<a name="ln1064">                  saveStyleDialog-&gt;setDirectory(defaultPath);</a>
<a name="ln1065"> </a>
<a name="ln1066">                  restoreDialogState(&quot;saveStyleDialog&quot;, saveStyleDialog);</a>
<a name="ln1067">                  saveStyleDialog-&gt;setAcceptMode(QFileDialog::AcceptSave);</a>
<a name="ln1068">                  }</a>
<a name="ln1069">            dialog = saveStyleDialog;</a>
<a name="ln1070">            }</a>
<a name="ln1071">      // setup side bar urls</a>
<a name="ln1072">      dialog-&gt;setSidebarUrls(urls);</a>
<a name="ln1073"> </a>
<a name="ln1074">      if (dialog-&gt;exec()) {</a>
<a name="ln1075">            QStringList result = dialog-&gt;selectedFiles();</a>
<a name="ln1076">            return result.front();</a>
<a name="ln1077">            }</a>
<a name="ln1078">      return QString();</a>
<a name="ln1079">      }</a>
<a name="ln1080"> </a>
<a name="ln1081">//---------------------------------------------------------</a>
<a name="ln1082">//   getChordStyleFilename</a>
<a name="ln1083">//---------------------------------------------------------</a>
<a name="ln1084"> </a>
<a name="ln1085">QString MuseScore::getChordStyleFilename(bool open)</a>
<a name="ln1086">      {</a>
<a name="ln1087">      QString filter = tr(&quot;Chord Symbols Style File&quot;) + &quot; (*.xml)&quot;;</a>
<a name="ln1088"> </a>
<a name="ln1089">      QFileInfo myStyles(preferences.getString(PREF_APP_PATHS_MYSTYLES));</a>
<a name="ln1090">      if (myStyles.isRelative())</a>
<a name="ln1091">            myStyles.setFile(QDir::home(), preferences.getString(PREF_APP_PATHS_MYSTYLES));</a>
<a name="ln1092">      QString defaultPath = myStyles.absoluteFilePath();</a>
<a name="ln1093"> </a>
<a name="ln1094">      if (preferences.getBool(PREF_UI_APP_USENATIVEDIALOGS)) {</a>
<a name="ln1095">            QString fn;</a>
<a name="ln1096">            if (open) {</a>
<a name="ln1097">                  fn = QFileDialog::getOpenFileName(</a>
<a name="ln1098">                     this, tr(&quot;Load Chord Symbols Style&quot;),</a>
<a name="ln1099">                     defaultPath,</a>
<a name="ln1100">                     filter</a>
<a name="ln1101">                     );</a>
<a name="ln1102">                  }</a>
<a name="ln1103">            else {</a>
<a name="ln1104">                  fn = QFileDialog::getSaveFileName(</a>
<a name="ln1105">                     this, tr(&quot;Save Chord Symbols Style&quot;),</a>
<a name="ln1106">                     defaultPath,</a>
<a name="ln1107">                     filter</a>
<a name="ln1108">                     );</a>
<a name="ln1109">                  }</a>
<a name="ln1110">            return fn;</a>
<a name="ln1111">            }</a>
<a name="ln1112"> </a>
<a name="ln1113">      QFileDialog* dialog;</a>
<a name="ln1114">      QList&lt;QUrl&gt; urls;</a>
<a name="ln1115">      QString home = QDir::homePath();</a>
<a name="ln1116">      urls.append(QUrl::fromLocalFile(home));</a>
<a name="ln1117">      urls.append(QUrl::fromLocalFile(defaultPath));</a>
<a name="ln1118">      urls.append(QUrl::fromLocalFile(QDir::currentPath()));</a>
<a name="ln1119"> </a>
<a name="ln1120">      QSettings set;</a>
<a name="ln1121">      if (open) {</a>
<a name="ln1122">            if (loadChordStyleDialog == 0) {</a>
<a name="ln1123">                  loadChordStyleDialog = new QFileDialog(this);</a>
<a name="ln1124">                  loadChordStyleDialog-&gt;setFileMode(QFileDialog::ExistingFile);</a>
<a name="ln1125">                  loadChordStyleDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln1126">                  loadChordStyleDialog-&gt;setWindowTitle(tr(&quot;Load Chord Symbols Style&quot;));</a>
<a name="ln1127">                  loadChordStyleDialog-&gt;setNameFilter(filter);</a>
<a name="ln1128">                  loadChordStyleDialog-&gt;setDirectory(defaultPath);</a>
<a name="ln1129"> </a>
<a name="ln1130">                  restoreDialogState(&quot;loadChordStyleDialog&quot;, loadChordStyleDialog);</a>
<a name="ln1131">                  loadChordStyleDialog-&gt;restoreState(set.value(&quot;loadChordStyleDialog&quot;).toByteArray());</a>
<a name="ln1132">                  loadChordStyleDialog-&gt;setAcceptMode(QFileDialog::AcceptOpen);</a>
<a name="ln1133">                  }</a>
<a name="ln1134">            // setup side bar urls</a>
<a name="ln1135">            urls.append(QUrl::fromLocalFile(mscoreGlobalShare+&quot;/styles&quot;));</a>
<a name="ln1136">            dialog = loadChordStyleDialog;</a>
<a name="ln1137">            }</a>
<a name="ln1138">      else {</a>
<a name="ln1139">            if (saveChordStyleDialog == 0) {</a>
<a name="ln1140">                  saveChordStyleDialog = new QFileDialog(this);</a>
<a name="ln1141">                  saveChordStyleDialog-&gt;setAcceptMode(QFileDialog::AcceptSave);</a>
<a name="ln1142">                  saveChordStyleDialog-&gt;setFileMode(QFileDialog::AnyFile);</a>
<a name="ln1143">                  saveChordStyleDialog-&gt;setOption(QFileDialog::DontConfirmOverwrite, false);</a>
<a name="ln1144">                  saveChordStyleDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln1145">                  saveChordStyleDialog-&gt;setWindowTitle(tr(&quot;Save Style&quot;));</a>
<a name="ln1146">                  saveChordStyleDialog-&gt;setNameFilter(filter);</a>
<a name="ln1147">                  saveChordStyleDialog-&gt;setDirectory(defaultPath);</a>
<a name="ln1148"> </a>
<a name="ln1149">                  restoreDialogState(&quot;saveChordStyleDialog&quot;, saveChordStyleDialog);</a>
<a name="ln1150">                  saveChordStyleDialog-&gt;setAcceptMode(QFileDialog::AcceptSave);</a>
<a name="ln1151">                  }</a>
<a name="ln1152">            dialog = saveChordStyleDialog;</a>
<a name="ln1153">            }</a>
<a name="ln1154">      // setup side bar urls</a>
<a name="ln1155">      dialog-&gt;setSidebarUrls(urls);</a>
<a name="ln1156">      if (dialog-&gt;exec()) {</a>
<a name="ln1157">            QStringList result = dialog-&gt;selectedFiles();</a>
<a name="ln1158">            return result.front();</a>
<a name="ln1159">            }</a>
<a name="ln1160">      return QString();</a>
<a name="ln1161">      }</a>
<a name="ln1162"> </a>
<a name="ln1163">//---------------------------------------------------------</a>
<a name="ln1164">//   getScanFile</a>
<a name="ln1165">//---------------------------------------------------------</a>
<a name="ln1166"> </a>
<a name="ln1167">QString MuseScore::getScanFile(const QString&amp; d)</a>
<a name="ln1168">      {</a>
<a name="ln1169">      QString filter = tr(&quot;PDF Scan File&quot;) + &quot; (*.pdf);;All (*)&quot;;</a>
<a name="ln1170">      QString defaultPath = d.isEmpty() ? QDir::homePath() : d;</a>
<a name="ln1171">      if (preferences.getBool(PREF_UI_APP_USENATIVEDIALOGS)) {</a>
<a name="ln1172">            QString s = QFileDialog::getOpenFileName(</a>
<a name="ln1173">               mscore,</a>
<a name="ln1174">               MuseScore::tr(&quot;Choose PDF Scan&quot;),</a>
<a name="ln1175">               defaultPath,</a>
<a name="ln1176">               filter</a>
<a name="ln1177">               );</a>
<a name="ln1178">            return s;</a>
<a name="ln1179">            }</a>
<a name="ln1180"> </a>
<a name="ln1181">      if (loadScanDialog == 0) {</a>
<a name="ln1182">            loadScanDialog = new QFileDialog(this);</a>
<a name="ln1183">            loadScanDialog-&gt;setFileMode(QFileDialog::ExistingFile);</a>
<a name="ln1184">            loadScanDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln1185">            loadScanDialog-&gt;setWindowTitle(tr(&quot;Choose PDF Scan&quot;));</a>
<a name="ln1186">            loadScanDialog-&gt;setNameFilter(filter);</a>
<a name="ln1187">            loadScanDialog-&gt;setDirectory(defaultPath);</a>
<a name="ln1188"> </a>
<a name="ln1189">            restoreDialogState(&quot;loadScanDialog&quot;, loadScanDialog);</a>
<a name="ln1190">            loadScanDialog-&gt;setAcceptMode(QFileDialog::AcceptOpen);</a>
<a name="ln1191">            }</a>
<a name="ln1192"> </a>
<a name="ln1193">      //</a>
<a name="ln1194">      // setup side bar urls</a>
<a name="ln1195">      //</a>
<a name="ln1196">      QList&lt;QUrl&gt; urls;</a>
<a name="ln1197">      QString home = QDir::homePath();</a>
<a name="ln1198">      urls.append(QUrl::fromLocalFile(home));</a>
<a name="ln1199">      urls.append(QUrl::fromLocalFile(QDir::currentPath()));</a>
<a name="ln1200">      loadScanDialog-&gt;setSidebarUrls(urls);</a>
<a name="ln1201"> </a>
<a name="ln1202">      if (loadScanDialog-&gt;exec()) {</a>
<a name="ln1203">            QStringList result = loadScanDialog-&gt;selectedFiles();</a>
<a name="ln1204">            return result.front();</a>
<a name="ln1205">            }</a>
<a name="ln1206">      return QString();</a>
<a name="ln1207">      }</a>
<a name="ln1208"> </a>
<a name="ln1209">//---------------------------------------------------------</a>
<a name="ln1210">//   getAudioFile</a>
<a name="ln1211">//---------------------------------------------------------</a>
<a name="ln1212"> </a>
<a name="ln1213">QString MuseScore::getAudioFile(const QString&amp; d)</a>
<a name="ln1214">      {</a>
<a name="ln1215">      QString filter = tr(&quot;Ogg Audio File&quot;) + &quot; (*.ogg);;All (*)&quot;;</a>
<a name="ln1216">      QString defaultPath = d.isEmpty() ? QDir::homePath() : d;</a>
<a name="ln1217">      if (preferences.getBool(PREF_UI_APP_USENATIVEDIALOGS)) {</a>
<a name="ln1218">            QString s = QFileDialog::getOpenFileName(</a>
<a name="ln1219">               mscore,</a>
<a name="ln1220">               MuseScore::tr(&quot;Choose Audio File&quot;),</a>
<a name="ln1221">               defaultPath,</a>
<a name="ln1222">               filter</a>
<a name="ln1223">               );</a>
<a name="ln1224">            return s;</a>
<a name="ln1225">            }</a>
<a name="ln1226"> </a>
<a name="ln1227">      if (loadAudioDialog == 0) {</a>
<a name="ln1228">            loadAudioDialog = new QFileDialog(this);</a>
<a name="ln1229">            loadAudioDialog-&gt;setFileMode(QFileDialog::ExistingFile);</a>
<a name="ln1230">            loadAudioDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln1231">            loadAudioDialog-&gt;setWindowTitle(tr(&quot;Choose Ogg Audio File&quot;));</a>
<a name="ln1232">            loadAudioDialog-&gt;setNameFilter(filter);</a>
<a name="ln1233">            loadAudioDialog-&gt;setDirectory(defaultPath);</a>
<a name="ln1234"> </a>
<a name="ln1235">            restoreDialogState(&quot;loadAudioDialog&quot;, loadAudioDialog);</a>
<a name="ln1236">            loadAudioDialog-&gt;setAcceptMode(QFileDialog::AcceptOpen);</a>
<a name="ln1237">            }</a>
<a name="ln1238"> </a>
<a name="ln1239">      //</a>
<a name="ln1240">      // setup side bar urls</a>
<a name="ln1241">      //</a>
<a name="ln1242">      QList&lt;QUrl&gt; urls;</a>
<a name="ln1243">      QString home = QDir::homePath();</a>
<a name="ln1244">      urls.append(QUrl::fromLocalFile(home));</a>
<a name="ln1245">      urls.append(QUrl::fromLocalFile(QDir::currentPath()));</a>
<a name="ln1246">      loadAudioDialog-&gt;setSidebarUrls(urls);</a>
<a name="ln1247"> </a>
<a name="ln1248">      if (loadAudioDialog-&gt;exec()) {</a>
<a name="ln1249">            QStringList result = loadAudioDialog-&gt;selectedFiles();</a>
<a name="ln1250">            return result.front();</a>
<a name="ln1251">            }</a>
<a name="ln1252">      return QString();</a>
<a name="ln1253">      }</a>
<a name="ln1254"> </a>
<a name="ln1255">//---------------------------------------------------------</a>
<a name="ln1256">//   getFotoFilename</a>
<a name="ln1257">//---------------------------------------------------------</a>
<a name="ln1258"> </a>
<a name="ln1259">QString MuseScore::getFotoFilename(QString&amp; filter, QString* selectedFilter)</a>
<a name="ln1260">      {</a>
<a name="ln1261">      QString title = tr(&quot;Save Image&quot;);</a>
<a name="ln1262"> </a>
<a name="ln1263">      QFileInfo myImages(preferences.getString(PREF_APP_PATHS_MYIMAGES));</a>
<a name="ln1264">      if (myImages.isRelative())</a>
<a name="ln1265">            myImages.setFile(QDir::home(), preferences.getString(PREF_APP_PATHS_MYIMAGES));</a>
<a name="ln1266">      QString defaultPath = myImages.absoluteFilePath();</a>
<a name="ln1267"> </a>
<a name="ln1268">      // compute the image capture path</a>
<a name="ln1269">      QString myCapturePath;</a>
<a name="ln1270">      // if no saves were made for current score, then use the score's name as default</a>
<a name="ln1271">      if (!cs-&gt;masterScore()-&gt;savedCapture()) {</a>
<a name="ln1272">            // set the current score's name as the default name for saved captures</a>
<a name="ln1273">            QString scoreName = cs-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName();</a>
<a name="ln1274">            QString name = createDefaultFileName(scoreName);</a>
<a name="ln1275">            QString fname = QString(&quot;%1/%2&quot;).arg(defaultPath).arg(name);</a>
<a name="ln1276">            QFileInfo myCapture(fname);</a>
<a name="ln1277">            if (myCapture.isRelative())</a>
<a name="ln1278">                myCapture.setFile(QDir::home(), fname);</a>
<a name="ln1279">            myCapturePath = myCapture.absoluteFilePath();</a>
<a name="ln1280">            }</a>
<a name="ln1281">      else</a>
<a name="ln1282">            myCapturePath = lastSaveCaptureName;</a>
<a name="ln1283"> </a>
<a name="ln1284">      if (preferences.getBool(PREF_UI_APP_USENATIVEDIALOGS)) {</a>
<a name="ln1285">            QString fn;</a>
<a name="ln1286">            fn = QFileDialog::getSaveFileName(</a>
<a name="ln1287">               this,</a>
<a name="ln1288">               title,</a>
<a name="ln1289">               myCapturePath,</a>
<a name="ln1290">               filter,</a>
<a name="ln1291">               selectedFilter</a>
<a name="ln1292">               );</a>
<a name="ln1293">            // if a save was made for this current score</a>
<a name="ln1294">            if (!fn.isEmpty()) {</a>
<a name="ln1295">                cs-&gt;masterScore()-&gt;setSavedCapture(true);</a>
<a name="ln1296">                // store the last name used for saving an image capture</a>
<a name="ln1297">                lastSaveCaptureName = fn;</a>
<a name="ln1298">                }</a>
<a name="ln1299">            return fn;</a>
<a name="ln1300">            }</a>
<a name="ln1301"> </a>
<a name="ln1302">      QList&lt;QUrl&gt; urls;</a>
<a name="ln1303">      urls.append(QUrl::fromLocalFile(QDir::homePath()));</a>
<a name="ln1304">      urls.append(QUrl::fromLocalFile(defaultPath));</a>
<a name="ln1305">      urls.append(QUrl::fromLocalFile(QDir::currentPath()));</a>
<a name="ln1306"> </a>
<a name="ln1307">      if (saveImageDialog == 0) {</a>
<a name="ln1308">            saveImageDialog = new QFileDialog(this);</a>
<a name="ln1309">            saveImageDialog-&gt;setFileMode(QFileDialog::AnyFile);</a>
<a name="ln1310">            saveImageDialog-&gt;setAcceptMode(QFileDialog::AcceptSave);</a>
<a name="ln1311">            saveImageDialog-&gt;setOption(QFileDialog::DontConfirmOverwrite, false);</a>
<a name="ln1312">            saveImageDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln1313">            saveImageDialog-&gt;setWindowTitle(title);</a>
<a name="ln1314">            saveImageDialog-&gt;setNameFilter(filter);</a>
<a name="ln1315">            saveImageDialog-&gt;setDirectory(defaultPath);</a>
<a name="ln1316"> </a>
<a name="ln1317">            restoreDialogState(&quot;saveImageDialog&quot;, saveImageDialog);</a>
<a name="ln1318">            saveImageDialog-&gt;setAcceptMode(QFileDialog::AcceptSave);</a>
<a name="ln1319">            }</a>
<a name="ln1320"> </a>
<a name="ln1321">      // setup side bar urls</a>
<a name="ln1322">      saveImageDialog-&gt;setSidebarUrls(urls);</a>
<a name="ln1323"> </a>
<a name="ln1324">      // set file's name using the computed path</a>
<a name="ln1325">      saveImageDialog-&gt;selectFile(myCapturePath);</a>
<a name="ln1326"> </a>
<a name="ln1327">      if (saveImageDialog-&gt;exec()) {</a>
<a name="ln1328">            QStringList result = saveImageDialog-&gt;selectedFiles();</a>
<a name="ln1329">            *selectedFilter = saveImageDialog-&gt;selectedNameFilter();</a>
<a name="ln1330">            // a save was made for this current score</a>
<a name="ln1331">            cs-&gt;masterScore()-&gt;setSavedCapture(true);</a>
<a name="ln1332">            // store the last name used for saving an image capture</a>
<a name="ln1333">            lastSaveCaptureName = result.front();</a>
<a name="ln1334">            return result.front();</a>
<a name="ln1335">            }</a>
<a name="ln1336">      return QString();</a>
<a name="ln1337">      }</a>
<a name="ln1338"> </a>
<a name="ln1339">//---------------------------------------------------------</a>
<a name="ln1340">//   getPaletteFilename</a>
<a name="ln1341">//---------------------------------------------------------</a>
<a name="ln1342"> </a>
<a name="ln1343">QString MuseScore::getPaletteFilename(bool open, const QString&amp; name)</a>
<a name="ln1344">      {</a>
<a name="ln1345">      QString title;</a>
<a name="ln1346">      QString filter;</a>
<a name="ln1347">      QString wd      = QString(&quot;%1/%2&quot;).arg(QStandardPaths::writableLocation(QStandardPaths::HomeLocation)).arg(QCoreApplication::applicationName());</a>
<a name="ln1348">      if (open) {</a>
<a name="ln1349">            title  = tr(&quot;Load Palette&quot;);</a>
<a name="ln1350">            filter = tr(&quot;MuseScore Palette&quot;) + &quot; (*.mpal)&quot;;</a>
<a name="ln1351">            }</a>
<a name="ln1352">      else {</a>
<a name="ln1353">            title  = tr(&quot;Save Palette&quot;);</a>
<a name="ln1354">            filter = tr(&quot;MuseScore Palette&quot;) + &quot; (*.mpal)&quot;;</a>
<a name="ln1355">            }</a>
<a name="ln1356"> </a>
<a name="ln1357">      QFileInfo myPalettes(wd);</a>
<a name="ln1358">      QString defaultPath = myPalettes.absoluteFilePath();</a>
<a name="ln1359">      if (!name.isEmpty()) {</a>
<a name="ln1360">            QString fname = createDefaultFileName(name);</a>
<a name="ln1361">            QFileInfo myName(fname);</a>
<a name="ln1362">            if (myName.isRelative())</a>
<a name="ln1363">                  myName.setFile(defaultPath, fname);</a>
<a name="ln1364">            defaultPath = myName.absoluteFilePath();</a>
<a name="ln1365">            }</a>
<a name="ln1366"> </a>
<a name="ln1367">      if (preferences.getBool(PREF_UI_APP_USENATIVEDIALOGS)) {</a>
<a name="ln1368">            QString fn;</a>
<a name="ln1369">            if (open)</a>
<a name="ln1370">                  fn = QFileDialog::getOpenFileName(this, title, defaultPath, filter);</a>
<a name="ln1371">            else</a>
<a name="ln1372">                  fn = QFileDialog::getSaveFileName(this, title, defaultPath, filter);</a>
<a name="ln1373">            return fn;</a>
<a name="ln1374">            }</a>
<a name="ln1375"> </a>
<a name="ln1376">      QFileDialog* dialog;</a>
<a name="ln1377">      QList&lt;QUrl&gt; urls;</a>
<a name="ln1378">      urls.append(QUrl::fromLocalFile(QDir::homePath()));</a>
<a name="ln1379">      urls.append(QUrl::fromLocalFile(QDir::currentPath()));</a>
<a name="ln1380">      urls.append(QUrl::fromLocalFile(defaultPath));</a>
<a name="ln1381"> </a>
<a name="ln1382">      if (open) {</a>
<a name="ln1383">            if (loadPaletteDialog == 0) {</a>
<a name="ln1384">                  loadPaletteDialog = new QFileDialog(this);</a>
<a name="ln1385">                  loadPaletteDialog-&gt;setFileMode(QFileDialog::ExistingFile);</a>
<a name="ln1386">                  loadPaletteDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln1387">                  loadPaletteDialog-&gt;setDirectory(defaultPath);</a>
<a name="ln1388"> </a>
<a name="ln1389">                  restoreDialogState(&quot;loadPaletteDialog&quot;, loadPaletteDialog);</a>
<a name="ln1390">                  loadPaletteDialog-&gt;setAcceptMode(QFileDialog::AcceptOpen);</a>
<a name="ln1391">                  }</a>
<a name="ln1392">            dialog = loadPaletteDialog;</a>
<a name="ln1393">            }</a>
<a name="ln1394">      else {</a>
<a name="ln1395">            if (savePaletteDialog == 0) {</a>
<a name="ln1396">                  savePaletteDialog = new QFileDialog(this);</a>
<a name="ln1397">                  savePaletteDialog-&gt;setAcceptMode(QFileDialog::AcceptSave);</a>
<a name="ln1398">                  savePaletteDialog-&gt;setFileMode(QFileDialog::AnyFile);</a>
<a name="ln1399">                  savePaletteDialog-&gt;setOption(QFileDialog::DontConfirmOverwrite, false);</a>
<a name="ln1400">                  savePaletteDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln1401">                  savePaletteDialog-&gt;setDirectory(defaultPath);</a>
<a name="ln1402"> </a>
<a name="ln1403">                  restoreDialogState(&quot;savePaletteDialog&quot;, savePaletteDialog);</a>
<a name="ln1404">                  savePaletteDialog-&gt;setAcceptMode(QFileDialog::AcceptSave);</a>
<a name="ln1405">                  }</a>
<a name="ln1406">            dialog = savePaletteDialog;</a>
<a name="ln1407">            }</a>
<a name="ln1408">      dialog-&gt;setWindowTitle(title);</a>
<a name="ln1409">      dialog-&gt;setNameFilter(filter);</a>
<a name="ln1410"> </a>
<a name="ln1411">      // setup side bar urls</a>
<a name="ln1412">      dialog-&gt;setSidebarUrls(urls);</a>
<a name="ln1413"> </a>
<a name="ln1414">      if (dialog-&gt;exec()) {</a>
<a name="ln1415">            QStringList result = dialog-&gt;selectedFiles();</a>
<a name="ln1416">            return result.front();</a>
<a name="ln1417">            }</a>
<a name="ln1418">      return QString();</a>
<a name="ln1419">      }</a>
<a name="ln1420"> </a>
<a name="ln1421">//---------------------------------------------------------</a>
<a name="ln1422">//   getPluginFilename</a>
<a name="ln1423">//---------------------------------------------------------</a>
<a name="ln1424"> </a>
<a name="ln1425">QString MuseScore::getPluginFilename(bool open)</a>
<a name="ln1426">      {</a>
<a name="ln1427">      QString title;</a>
<a name="ln1428">      QString filter;</a>
<a name="ln1429">      if (open) {</a>
<a name="ln1430">            title  = tr(&quot;Load Plugin&quot;);</a>
<a name="ln1431">            filter = tr(&quot;MuseScore Plugin&quot;) + &quot; (*.qml)&quot;;</a>
<a name="ln1432">            }</a>
<a name="ln1433">      else {</a>
<a name="ln1434">            title  = tr(&quot;Save Plugin&quot;);</a>
<a name="ln1435">            filter = tr(&quot;MuseScore Plugin File&quot;) + &quot; (*.qml)&quot;;</a>
<a name="ln1436">            }</a>
<a name="ln1437"> </a>
<a name="ln1438">      QFileInfo myPlugins(preferences.getString(PREF_APP_PATHS_MYPLUGINS));</a>
<a name="ln1439">      if (myPlugins.isRelative())</a>
<a name="ln1440">            myPlugins.setFile(QDir::home(), preferences.getString(PREF_APP_PATHS_MYPLUGINS));</a>
<a name="ln1441">      QString defaultPath = myPlugins.absoluteFilePath();</a>
<a name="ln1442"> </a>
<a name="ln1443">      QString name  = createDefaultFileName(&quot;Plugin&quot;);</a>
<a name="ln1444">      QString fname = QString(&quot;%1/%2.qml&quot;).arg(defaultPath).arg(name);</a>
<a name="ln1445">      if (preferences.getBool(PREF_UI_APP_USENATIVEDIALOGS)) {</a>
<a name="ln1446">            QString fn;</a>
<a name="ln1447">            if (open)</a>
<a name="ln1448">                  fn = QFileDialog::getOpenFileName(this, title, defaultPath, filter);</a>
<a name="ln1449">            else</a>
<a name="ln1450">                  fn = QFileDialog::getSaveFileName(this, title, defaultPath, filter);</a>
<a name="ln1451">            return fn;</a>
<a name="ln1452">            }</a>
<a name="ln1453"> </a>
<a name="ln1454">      QFileDialog* dialog;</a>
<a name="ln1455">      QList&lt;QUrl&gt; urls;</a>
<a name="ln1456">      QString home = QDir::homePath();</a>
<a name="ln1457">      urls.append(QUrl::fromLocalFile(home));</a>
<a name="ln1458">      urls.append(QUrl::fromLocalFile(defaultPath));</a>
<a name="ln1459">      urls.append(QUrl::fromLocalFile(QDir::currentPath()));</a>
<a name="ln1460"> </a>
<a name="ln1461">      if (open) {</a>
<a name="ln1462">            if (loadPluginDialog == 0) {</a>
<a name="ln1463">                  loadPluginDialog = new QFileDialog(this);</a>
<a name="ln1464">                  loadPluginDialog-&gt;setFileMode(QFileDialog::ExistingFile);</a>
<a name="ln1465">                  loadPluginDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln1466">                  loadPluginDialog-&gt;setDirectory(defaultPath);</a>
<a name="ln1467"> </a>
<a name="ln1468">                  QSettings set;</a>
<a name="ln1469">                  loadPluginDialog-&gt;restoreState(set.value(&quot;loadPluginDialog&quot;).toByteArray());</a>
<a name="ln1470">                  loadPluginDialog-&gt;setAcceptMode(QFileDialog::AcceptOpen);</a>
<a name="ln1471">                  }</a>
<a name="ln1472">            urls.append(QUrl::fromLocalFile(mscoreGlobalShare+&quot;/plugins&quot;));</a>
<a name="ln1473">            dialog = loadPluginDialog;</a>
<a name="ln1474">            }</a>
<a name="ln1475">      else {</a>
<a name="ln1476">            if (savePluginDialog == 0) {</a>
<a name="ln1477">                  savePluginDialog = new QFileDialog(this);</a>
<a name="ln1478">                  QSettings set;</a>
<a name="ln1479">                  savePluginDialog-&gt;restoreState(set.value(&quot;savePluginDialog&quot;).toByteArray());</a>
<a name="ln1480">                  savePluginDialog-&gt;setAcceptMode(QFileDialog::AcceptSave);</a>
<a name="ln1481">                  savePluginDialog-&gt;setFileMode(QFileDialog::AnyFile);</a>
<a name="ln1482">                  savePluginDialog-&gt;setOption(QFileDialog::DontConfirmOverwrite, false);</a>
<a name="ln1483">                  savePluginDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln1484">                  savePluginDialog-&gt;setWindowTitle(tr(&quot;Save Plugin&quot;));</a>
<a name="ln1485">                  savePluginDialog-&gt;setNameFilter(filter);</a>
<a name="ln1486">                  savePluginDialog-&gt;setDirectory(defaultPath);</a>
<a name="ln1487">                  savePluginDialog-&gt;selectFile(fname);</a>
<a name="ln1488">                  }</a>
<a name="ln1489">            dialog = savePluginDialog;</a>
<a name="ln1490">            }</a>
<a name="ln1491">      dialog-&gt;setWindowTitle(title);</a>
<a name="ln1492">      dialog-&gt;setNameFilter(filter);</a>
<a name="ln1493"> </a>
<a name="ln1494">      // setup side bar urls</a>
<a name="ln1495">      dialog-&gt;setSidebarUrls(urls);</a>
<a name="ln1496"> </a>
<a name="ln1497">      if (dialog-&gt;exec()) {</a>
<a name="ln1498">            QStringList result = dialog-&gt;selectedFiles();</a>
<a name="ln1499">            return result.front();</a>
<a name="ln1500">            }</a>
<a name="ln1501">      return QString();</a>
<a name="ln1502">      }</a>
<a name="ln1503"> </a>
<a name="ln1504">//---------------------------------------------------------</a>
<a name="ln1505">//   getDrumsetFilename</a>
<a name="ln1506">//---------------------------------------------------------</a>
<a name="ln1507"> </a>
<a name="ln1508">QString MuseScore::getDrumsetFilename(bool open)</a>
<a name="ln1509">      {</a>
<a name="ln1510">      QString title;</a>
<a name="ln1511">      QString filter;</a>
<a name="ln1512">      if (open) {</a>
<a name="ln1513">            title  = tr(&quot;Load Drumset&quot;);</a>
<a name="ln1514">            filter = tr(&quot;MuseScore Drumset&quot;) + &quot; (*.drm)&quot;;</a>
<a name="ln1515">            }</a>
<a name="ln1516">      else {</a>
<a name="ln1517">            title  = tr(&quot;Save Drumset&quot;);</a>
<a name="ln1518">            filter = tr(&quot;MuseScore Drumset File&quot;) + &quot; (*.drm)&quot;;</a>
<a name="ln1519">            }</a>
<a name="ln1520"> </a>
<a name="ln1521">      QFileInfo myStyles(preferences.getString(PREF_APP_PATHS_MYSTYLES));</a>
<a name="ln1522">      if (myStyles.isRelative())</a>
<a name="ln1523">            myStyles.setFile(QDir::home(), preferences.getString(PREF_APP_PATHS_MYSTYLES));</a>
<a name="ln1524">      QString defaultPath  = myStyles.absoluteFilePath();</a>
<a name="ln1525"> </a>
<a name="ln1526">      if (preferences.getBool(PREF_UI_APP_USENATIVEDIALOGS)) {</a>
<a name="ln1527">            QString fn;</a>
<a name="ln1528">            if (open)</a>
<a name="ln1529">                  fn = QFileDialog::getOpenFileName(this, title, defaultPath, filter);</a>
<a name="ln1530">            else</a>
<a name="ln1531">                  fn = QFileDialog::getSaveFileName(this, title, defaultPath, filter);</a>
<a name="ln1532">            return fn;</a>
<a name="ln1533">            }</a>
<a name="ln1534"> </a>
<a name="ln1535"> </a>
<a name="ln1536">      QFileDialog* dialog;</a>
<a name="ln1537">      QList&lt;QUrl&gt; urls;</a>
<a name="ln1538">      QString home = QDir::homePath();</a>
<a name="ln1539">      urls.append(QUrl::fromLocalFile(home));</a>
<a name="ln1540">      urls.append(QUrl::fromLocalFile(defaultPath));</a>
<a name="ln1541">      urls.append(QUrl::fromLocalFile(QDir::currentPath()));</a>
<a name="ln1542"> </a>
<a name="ln1543">      if (open) {</a>
<a name="ln1544">            if (loadDrumsetDialog == 0) {</a>
<a name="ln1545">                  loadDrumsetDialog = new QFileDialog(this);</a>
<a name="ln1546">                  loadDrumsetDialog-&gt;setFileMode(QFileDialog::ExistingFile);</a>
<a name="ln1547">                  loadDrumsetDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln1548">                  loadDrumsetDialog-&gt;setDirectory(defaultPath);</a>
<a name="ln1549"> </a>
<a name="ln1550">                  restoreDialogState(&quot;loadDrumsetDialog&quot;, loadDrumsetDialog);</a>
<a name="ln1551">                  loadDrumsetDialog-&gt;setAcceptMode(QFileDialog::AcceptOpen);</a>
<a name="ln1552">                  }</a>
<a name="ln1553">            dialog = loadDrumsetDialog;</a>
<a name="ln1554">            }</a>
<a name="ln1555">      else {</a>
<a name="ln1556">            if (saveDrumsetDialog == 0) {</a>
<a name="ln1557">                  saveDrumsetDialog = new QFileDialog(this);</a>
<a name="ln1558">                  saveDrumsetDialog-&gt;setAcceptMode(QFileDialog::AcceptSave);</a>
<a name="ln1559">                  saveDrumsetDialog-&gt;setFileMode(QFileDialog::AnyFile);</a>
<a name="ln1560">                  saveDrumsetDialog-&gt;setOption(QFileDialog::DontConfirmOverwrite, false);</a>
<a name="ln1561">                  saveDrumsetDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln1562">                  saveDrumsetDialog-&gt;setDirectory(defaultPath);</a>
<a name="ln1563"> </a>
<a name="ln1564">                  restoreDialogState(&quot;saveDrumsetDialog&quot;, saveDrumsetDialog);</a>
<a name="ln1565">                  saveDrumsetDialog-&gt;setAcceptMode(QFileDialog::AcceptSave);</a>
<a name="ln1566">                  }</a>
<a name="ln1567">            dialog = saveDrumsetDialog;</a>
<a name="ln1568">            }</a>
<a name="ln1569">      dialog-&gt;setWindowTitle(title);</a>
<a name="ln1570">      dialog-&gt;setNameFilter(filter);</a>
<a name="ln1571"> </a>
<a name="ln1572">      // setup side bar urls</a>
<a name="ln1573">      dialog-&gt;setSidebarUrls(urls);</a>
<a name="ln1574"> </a>
<a name="ln1575">      if (dialog-&gt;exec()) {</a>
<a name="ln1576">            QStringList result = dialog-&gt;selectedFiles();</a>
<a name="ln1577">            return result.front();</a>
<a name="ln1578">            }</a>
<a name="ln1579">      return QString();</a>
<a name="ln1580">      }</a>
<a name="ln1581"> </a>
<a name="ln1582">//---------------------------------------------------------</a>
<a name="ln1583">//   printFile</a>
<a name="ln1584">//---------------------------------------------------------</a>
<a name="ln1585"> </a>
<a name="ln1586">void MuseScore::printFile()</a>
<a name="ln1587">      {</a>
<a name="ln1588">#ifndef QT_NO_PRINTER</a>
<a name="ln1589">      LayoutMode layoutMode = cs-&gt;layoutMode();</a>
<a name="ln1590">      if (layoutMode != LayoutMode::PAGE) {</a>
<a name="ln1591">            cs-&gt;setLayoutMode(LayoutMode::PAGE);</a>
<a name="ln1592">            cs-&gt;doLayout();</a>
<a name="ln1593">            }</a>
<a name="ln1594"> </a>
<a name="ln1595">      QPrinter printerDev(QPrinter::HighResolution);</a>
<a name="ln1596">      QSizeF size(cs-&gt;styleD(Sid::pageWidth), cs-&gt;styleD(Sid::pageHeight));</a>
<a name="ln1597">      QPageSize ps(QPageSize::id(size, QPageSize::Inch));</a>
<a name="ln1598">      printerDev.setPageSize(ps);</a>
<a name="ln1599">      printerDev.setPageOrientation(size.width() &gt; size.height() ? QPageLayout::Landscape : QPageLayout::Portrait);</a>
<a name="ln1600"> </a>
<a name="ln1601">      printerDev.setCreator(&quot;MuseScore Version: &quot; VERSION);</a>
<a name="ln1602">      printerDev.setFullPage(true);</a>
<a name="ln1603">      if (!printerDev.setPageMargins(QMarginsF()))</a>
<a name="ln1604">            qDebug(&quot;unable to clear printer margins&quot;);</a>
<a name="ln1605">      printerDev.setColorMode(QPrinter::Color);</a>
<a name="ln1606">      if (cs-&gt;isMaster())</a>
<a name="ln1607">            printerDev.setDocName(cs-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName());</a>
<a name="ln1608">      else</a>
<a name="ln1609">            printerDev.setDocName(cs-&gt;excerpt()-&gt;title());</a>
<a name="ln1610">      printerDev.setOutputFormat(QPrinter::NativeFormat);</a>
<a name="ln1611">      int pages    = cs-&gt;pages().size();</a>
<a name="ln1612">      printerDev.setFromTo(1, pages);</a>
<a name="ln1613"> </a>
<a name="ln1614">#if defined(Q_OS_MAC) || defined(Q_OS_WIN)</a>
<a name="ln1615">      printerDev.setOutputFileName(&quot;&quot;);</a>
<a name="ln1616">#else</a>
<a name="ln1617">      // when setting this on windows platform, pd.exec() does not</a>
<a name="ln1618">      // show dialog</a>
<a name="ln1619">      if (cs-&gt;isMaster())</a>
<a name="ln1620">            printerDev.setOutputFileName(cs-&gt;masterScore()-&gt;fileInfo()-&gt;path() + &quot;/&quot; + cs-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName() + &quot;.pdf&quot;);</a>
<a name="ln1621">      else</a>
<a name="ln1622">            printerDev.setOutputFileName(cs-&gt;masterScore()-&gt;fileInfo()-&gt;path() + &quot;/&quot; + cs-&gt;excerpt()-&gt;title() + &quot;.pdf&quot;);</a>
<a name="ln1623">#endif</a>
<a name="ln1624"> </a>
<a name="ln1625">      QPrintDialog pd(&amp;printerDev, 0);</a>
<a name="ln1626"> </a>
<a name="ln1627">      if (pd.exec()) {</a>
<a name="ln1628">            QPainter p(&amp;printerDev);</a>
<a name="ln1629">            p.setRenderHint(QPainter::Antialiasing, true);</a>
<a name="ln1630">            p.setRenderHint(QPainter::TextAntialiasing, true);</a>
<a name="ln1631">            double mag_ = printerDev.logicalDpiX() / DPI;</a>
<a name="ln1632"> </a>
<a name="ln1633">            double pr = MScore::pixelRatio;</a>
<a name="ln1634">            MScore::pixelRatio = 1.0 / mag_;</a>
<a name="ln1635">            p.scale(mag_, mag_);</a>
<a name="ln1636"> </a>
<a name="ln1637">            int fromPage = printerDev.fromPage() - 1;</a>
<a name="ln1638">            int toPage   = printerDev.toPage() - 1;</a>
<a name="ln1639">            if (fromPage &lt; 0)</a>
<a name="ln1640">                  fromPage = 0;</a>
<a name="ln1641">            if ((toPage &lt; 0) || (toPage &gt;= pages))</a>
<a name="ln1642">                  toPage = pages - 1;</a>
<a name="ln1643"> </a>
<a name="ln1644">            for (int copy = 0; copy &lt; printerDev.numCopies(); ++copy) {</a>
<a name="ln1645">                  bool firstPage = true;</a>
<a name="ln1646">                  for (int n = fromPage; n &lt;= toPage; ++n) {</a>
<a name="ln1647">                        if (!firstPage)</a>
<a name="ln1648">                              printerDev.newPage();</a>
<a name="ln1649">                        firstPage = false;</a>
<a name="ln1650"> </a>
<a name="ln1651">                        cs-&gt;print(&amp;p, n);</a>
<a name="ln1652">                        if ((copy + 1) &lt; printerDev.numCopies())</a>
<a name="ln1653">                              printerDev.newPage();</a>
<a name="ln1654">                        }</a>
<a name="ln1655">                  }</a>
<a name="ln1656">            p.end();</a>
<a name="ln1657">            MScore::pixelRatio = pr;</a>
<a name="ln1658">            }</a>
<a name="ln1659"> </a>
<a name="ln1660">      if (layoutMode != cs-&gt;layoutMode()) {</a>
<a name="ln1661">            cs-&gt;setLayoutMode(layoutMode);</a>
<a name="ln1662">            cs-&gt;doLayout();</a>
<a name="ln1663">            }</a>
<a name="ln1664">#endif</a>
<a name="ln1665">      }</a>
<a name="ln1666"> </a>
<a name="ln1667">//---------------------------------------------------------</a>
<a name="ln1668">//   exportFile</a>
<a name="ln1669">//    return true on success</a>
<a name="ln1670">//---------------------------------------------------------</a>
<a name="ln1671"> </a>
<a name="ln1672">void MuseScore::exportFile()</a>
<a name="ln1673">      {</a>
<a name="ln1674">      QStringList fl;</a>
<a name="ln1675">      fl.append(tr(&quot;PDF File&quot;) + &quot; (*.pdf)&quot;);</a>
<a name="ln1676">      fl.append(tr(&quot;PNG Bitmap Graphic&quot;) + &quot; (*.png)&quot;);</a>
<a name="ln1677">      fl.append(tr(&quot;Scalable Vector Graphics&quot;) + &quot; (*.svg)&quot;);</a>
<a name="ln1678">#ifdef HAS_AUDIOFILE</a>
<a name="ln1679">      fl.append(tr(&quot;Wave Audio&quot;) + &quot; (*.wav)&quot;);</a>
<a name="ln1680">      fl.append(tr(&quot;FLAC Audio&quot;) + &quot; (*.flac)&quot;);</a>
<a name="ln1681">      fl.append(tr(&quot;Ogg Vorbis Audio&quot;) + &quot; (*.ogg)&quot;);</a>
<a name="ln1682">#endif</a>
<a name="ln1683">#ifdef USE_LAME</a>
<a name="ln1684">      fl.append(tr(&quot;MP3 Audio&quot;) + &quot; (*.mp3)&quot;);</a>
<a name="ln1685">#endif</a>
<a name="ln1686">      fl.append(tr(&quot;Standard MIDI File&quot;) + &quot; (*.mid)&quot;);</a>
<a name="ln1687">      fl.append(tr(&quot;Compressed MusicXML File&quot;) + &quot; (*.mxl)&quot;);</a>
<a name="ln1688">      fl.append(tr(&quot;Uncompressed MusicXML File&quot;) + &quot; (*.musicxml)&quot;);</a>
<a name="ln1689">      fl.append(tr(&quot;Uncompressed MusicXML File (outdated)&quot;) + &quot; (*.xml)&quot;);</a>
<a name="ln1690">      fl.append(tr(&quot;Uncompressed MuseScore 3 File&quot;) + &quot; (*.mscx)&quot;);     // for debugging purposes</a>
<a name="ln1691"> </a>
<a name="ln1692">      QString saveDialogTitle = tr(&quot;Export&quot;);</a>
<a name="ln1693"> </a>
<a name="ln1694">      QString saveDirectory;</a>
<a name="ln1695">      if (cs-&gt;masterScore()-&gt;fileInfo()-&gt;exists())</a>
<a name="ln1696">            saveDirectory = cs-&gt;masterScore()-&gt;fileInfo()-&gt;dir().path();</a>
<a name="ln1697">      else {</a>
<a name="ln1698">            QSettings set;</a>
<a name="ln1699">            if (lastSaveCopyDirectory.isEmpty())</a>
<a name="ln1700">                  lastSaveCopyDirectory = set.value(&quot;lastSaveCopyDirectory&quot;, preferences.getString(PREF_APP_PATHS_MYSCORES)).toString();</a>
<a name="ln1701">            saveDirectory = lastSaveCopyDirectory;</a>
<a name="ln1702">            }</a>
<a name="ln1703"> </a>
<a name="ln1704">      if (saveDirectory.isEmpty())</a>
<a name="ln1705">            saveDirectory = preferences.getString(PREF_APP_PATHS_MYSCORES);</a>
<a name="ln1706"> </a>
<a name="ln1707">      if (lastSaveCopyFormat.isEmpty()) {</a>
<a name="ln1708">            QSettings set;</a>
<a name="ln1709">            lastSaveCopyFormat = set.value(&quot;lastSaveCopyFormat&quot;, &quot;pdf&quot;).toString();</a>
<a name="ln1710">            }</a>
<a name="ln1711">      QString saveFormat = lastSaveCopyFormat;</a>
<a name="ln1712"> </a>
<a name="ln1713">      if (saveFormat.isEmpty())</a>
<a name="ln1714">            saveFormat = &quot;pdf&quot;;</a>
<a name="ln1715"> </a>
<a name="ln1716">      QString name;</a>
<a name="ln1717">#ifdef Q_OS_WIN</a>
<a name="ln1718">      if (QSysInfo::WindowsVersion == QSysInfo::WV_XP) {</a>
<a name="ln1719">            if (!cs-&gt;isMaster())</a>
<a name="ln1720">                  name = QString(&quot;%1/%2-%3&quot;).arg(saveDirectory).arg(cs-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName()).arg(createDefaultFileName(cs-&gt;title()));</a>
<a name="ln1721">            else</a>
<a name="ln1722">                  name = QString(&quot;%1/%2&quot;).arg(saveDirectory).arg(cs-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName());</a>
<a name="ln1723">            }</a>
<a name="ln1724">      else</a>
<a name="ln1725">#endif</a>
<a name="ln1726">      if (!cs-&gt;isMaster())</a>
<a name="ln1727">            name = QString(&quot;%1/%2-%3.%4&quot;).arg(saveDirectory).arg(cs-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName()).arg(createDefaultFileName(cs-&gt;title())).arg(saveFormat);</a>
<a name="ln1728">      else</a>
<a name="ln1729">            name = QString(&quot;%1/%2.%3&quot;).arg(saveDirectory).arg(cs-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName()).arg(saveFormat);</a>
<a name="ln1730"> </a>
<a name="ln1731">      int idx = fl.indexOf(QRegExp(&quot;.+\\(\\*\\.&quot; + saveFormat + &quot;\\)&quot;), Qt::CaseInsensitive);</a>
<a name="ln1732">      if (idx != -1)</a>
<a name="ln1733">            fl.move(idx, 0);</a>
<a name="ln1734">      QString filter = fl.join(&quot;;;&quot;);</a>
<a name="ln1735">      QString fn = getSaveScoreName(saveDialogTitle, name, filter);</a>
<a name="ln1736">      if (fn.isEmpty())</a>
<a name="ln1737">            return;</a>
<a name="ln1738"> </a>
<a name="ln1739">      QFileInfo fi(fn);</a>
<a name="ln1740">      lastSaveCopyDirectory = fi.absolutePath();</a>
<a name="ln1741">      lastSaveCopyFormat = fi.suffix();</a>
<a name="ln1742"> </a>
<a name="ln1743">      if (fi.suffix().isEmpty())</a>
<a name="ln1744">            QMessageBox::critical(this, tr(&quot;Export&quot;), tr(&quot;Cannot determine file type&quot;));</a>
<a name="ln1745">      else</a>
<a name="ln1746">            saveAs(cs, true, fn, fi.suffix());</a>
<a name="ln1747">      }</a>
<a name="ln1748"> </a>
<a name="ln1749">//---------------------------------------------------------</a>
<a name="ln1750">//   exportParts</a>
<a name="ln1751">//    return true on success</a>
<a name="ln1752">//---------------------------------------------------------</a>
<a name="ln1753"> </a>
<a name="ln1754">bool MuseScore::exportParts()</a>
<a name="ln1755">      {</a>
<a name="ln1756">      QStringList fl;</a>
<a name="ln1757">      fl.append(tr(&quot;PDF File&quot;) + &quot; (*.pdf)&quot;);</a>
<a name="ln1758">      fl.append(tr(&quot;PNG Bitmap Graphic&quot;) + &quot; (*.png)&quot;);</a>
<a name="ln1759">      fl.append(tr(&quot;Scalable Vector Graphics&quot;) + &quot; (*.svg)&quot;);</a>
<a name="ln1760">#ifdef HAS_AUDIOFILE</a>
<a name="ln1761">      fl.append(tr(&quot;Wave Audio&quot;) + &quot; (*.wav)&quot;);</a>
<a name="ln1762">      fl.append(tr(&quot;FLAC Audio&quot;) + &quot; (*.flac)&quot;);</a>
<a name="ln1763">      fl.append(tr(&quot;Ogg Vorbis Audio&quot;) + &quot; (*.ogg)&quot;);</a>
<a name="ln1764">#endif</a>
<a name="ln1765">#ifdef USE_LAME</a>
<a name="ln1766">      fl.append(tr(&quot;MP3 Audio&quot;) + &quot; (*.mp3)&quot;);</a>
<a name="ln1767">#endif</a>
<a name="ln1768">      fl.append(tr(&quot;Standard MIDI File&quot;) + &quot; (*.mid)&quot;);</a>
<a name="ln1769">      fl.append(tr(&quot;Compressed MusicXML File&quot;) + &quot; (*.mxl)&quot;);</a>
<a name="ln1770">      fl.append(tr(&quot;Uncompressed MusicXML File&quot;) + &quot; (*.musicxml)&quot;);</a>
<a name="ln1771">      fl.append(tr(&quot;Uncompressed MusicXML File (outdated)&quot;) + &quot; (*.xml)&quot;);</a>
<a name="ln1772">      fl.append(tr(&quot;MuseScore 3 File&quot;) + &quot; (*.mscz)&quot;);</a>
<a name="ln1773">      fl.append(tr(&quot;Uncompressed MuseScore 3 File&quot;) + &quot; (*.mscx)&quot;);     // for debugging purposes</a>
<a name="ln1774"> </a>
<a name="ln1775">      QString saveDialogTitle = tr(&quot;Export Parts&quot;);</a>
<a name="ln1776"> </a>
<a name="ln1777">      QString saveDirectory;</a>
<a name="ln1778">      if (cs-&gt;masterScore()-&gt;fileInfo()-&gt;exists())</a>
<a name="ln1779">            saveDirectory = cs-&gt;masterScore()-&gt;fileInfo()-&gt;dir().path();</a>
<a name="ln1780">      else {</a>
<a name="ln1781">            QSettings set;</a>
<a name="ln1782">            if (lastSaveCopyDirectory.isEmpty())</a>
<a name="ln1783">                lastSaveCopyDirectory = set.value(&quot;lastSaveCopyDirectory&quot;, preferences.getString(PREF_APP_PATHS_MYSCORES)).toString();</a>
<a name="ln1784">            saveDirectory = lastSaveCopyDirectory;</a>
<a name="ln1785">            }</a>
<a name="ln1786"> </a>
<a name="ln1787">      if (saveDirectory.isEmpty())</a>
<a name="ln1788">            saveDirectory = preferences.getString(PREF_APP_PATHS_MYSCORES);</a>
<a name="ln1789"> </a>
<a name="ln1790">      if (lastSaveCopyFormat.isEmpty()) {</a>
<a name="ln1791">            QSettings set;</a>
<a name="ln1792">            lastSaveCopyFormat = set.value(&quot;lastSaveCopyFormat&quot;, &quot;pdf&quot;).toString();</a>
<a name="ln1793">            }</a>
<a name="ln1794">      QString saveFormat = lastSaveCopyFormat;</a>
<a name="ln1795"> </a>
<a name="ln1796">      if (saveFormat.isEmpty())</a>
<a name="ln1797">            saveFormat = &quot;pdf&quot;;</a>
<a name="ln1798"> </a>
<a name="ln1799">      QString scoreName = cs-&gt;isMaster() ? cs-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName() : cs-&gt;title();</a>
<a name="ln1800">      QString name;</a>
<a name="ln1801">#ifdef Q_OS_WIN</a>
<a name="ln1802">      if (QSysInfo::WindowsVersion == QSysInfo::WV_XP)</a>
<a name="ln1803">            name = QString(&quot;%1/%2&quot;).arg(saveDirectory).arg(scoreName);</a>
<a name="ln1804">      else</a>
<a name="ln1805">#endif</a>
<a name="ln1806">      name = QString(&quot;%1/%2.%3&quot;).arg(saveDirectory).arg(scoreName).arg(saveFormat);</a>
<a name="ln1807"> </a>
<a name="ln1808">      int idx = fl.indexOf(QRegExp(&quot;.+\\(\\*\\.&quot; + saveFormat + &quot;\\)&quot;), Qt::CaseInsensitive);</a>
<a name="ln1809">      if (idx != -1)</a>
<a name="ln1810">            fl.move(idx, 0);</a>
<a name="ln1811">      QString filter = fl.join(&quot;;;&quot;);</a>
<a name="ln1812">      QString fn = getSaveScoreName(saveDialogTitle, name, filter);</a>
<a name="ln1813">      if (fn.isEmpty())</a>
<a name="ln1814">          return false;</a>
<a name="ln1815"> </a>
<a name="ln1816">      QFileInfo fi(fn);</a>
<a name="ln1817">      lastSaveCopyDirectory = fi.absolutePath();</a>
<a name="ln1818">      lastSaveCopyFormat = fi.suffix();</a>
<a name="ln1819"> </a>
<a name="ln1820">      QString ext = fi.suffix();</a>
<a name="ln1821">      if (ext.isEmpty()) {</a>
<a name="ln1822">            QMessageBox::critical(this, tr(&quot;Export Parts&quot;), tr(&quot;Cannot determine file type&quot;));</a>
<a name="ln1823">            return false;</a>
<a name="ln1824">            }</a>
<a name="ln1825"> </a>
<a name="ln1826">      Score* thisScore = cs-&gt;masterScore();</a>
<a name="ln1827">      bool overwrite = false;</a>
<a name="ln1828">      bool noToAll = false;</a>
<a name="ln1829">      QString confirmReplaceTitle = tr(&quot;Confirm Replace&quot;);</a>
<a name="ln1830">      QString confirmReplaceMessage = tr(&quot;\&quot;%1\&quot; already exists.\nDo you want to replace it?\n&quot;);</a>
<a name="ln1831">      QString replaceMessage = tr(&quot;Replace&quot;);</a>
<a name="ln1832">      QString skipMessage = tr(&quot;Skip&quot;);</a>
<a name="ln1833">      foreach (Excerpt* e, thisScore-&gt;excerpts())  {</a>
<a name="ln1834">            Score* pScore = e-&gt;partScore();</a>
<a name="ln1835">            QString partfn = fi.absolutePath() + &quot;/&quot; + fi.completeBaseName() + &quot;-&quot; + createDefaultFileName(pScore-&gt;title()) + &quot;.&quot; + ext;</a>
<a name="ln1836">            QFileInfo fip(partfn);</a>
<a name="ln1837">            if (fip.exists() &amp;&amp; !overwrite) {</a>
<a name="ln1838">                  if(noToAll)</a>
<a name="ln1839">                        continue;</a>
<a name="ln1840">                  QMessageBox msgBox( QMessageBox::Question, confirmReplaceTitle,</a>
<a name="ln1841">                        confirmReplaceMessage.arg(QDir::toNativeSeparators(partfn)),</a>
<a name="ln1842">                        QMessageBox::Yes |  QMessageBox::YesToAll | QMessageBox::No |  QMessageBox::NoToAll);</a>
<a name="ln1843">                  msgBox.setButtonText(QMessageBox::Yes, replaceMessage);</a>
<a name="ln1844">                  msgBox.setButtonText(QMessageBox::No, skipMessage);</a>
<a name="ln1845">                  msgBox.setButtonText(QMessageBox::YesToAll, tr(&quot;Replace All&quot;));</a>
<a name="ln1846">                  msgBox.setButtonText(QMessageBox::NoToAll, tr(&quot;Skip All&quot;));</a>
<a name="ln1847">                  int sb = msgBox.exec();</a>
<a name="ln1848">                  if(sb == QMessageBox::YesToAll) {</a>
<a name="ln1849">                        overwrite = true;</a>
<a name="ln1850">                        }</a>
<a name="ln1851">                  else if (sb == QMessageBox::NoToAll) {</a>
<a name="ln1852">                        noToAll = true;</a>
<a name="ln1853">                        continue;</a>
<a name="ln1854">                        }</a>
<a name="ln1855">                  else if (sb == QMessageBox::No)</a>
<a name="ln1856">                        continue;</a>
<a name="ln1857">                  }</a>
<a name="ln1858"> </a>
<a name="ln1859">            if (!saveAs(pScore, true, partfn, ext))</a>
<a name="ln1860">                  return false;</a>
<a name="ln1861">            }</a>
<a name="ln1862">      // For PDF, also export score and parts together</a>
<a name="ln1863">      if (ext.toLower() == &quot;pdf&quot;) {</a>
<a name="ln1864">            QList&lt;Score*&gt; scores;</a>
<a name="ln1865">            scores.append(thisScore);</a>
<a name="ln1866">            foreach(Excerpt* e, thisScore-&gt;excerpts())  {</a>
<a name="ln1867">                  scores.append(e-&gt;partScore());</a>
<a name="ln1868">                  }</a>
<a name="ln1869">            QString partfn(fi.absolutePath() + &quot;/&quot; + fi.completeBaseName() + &quot;-&quot; + createDefaultFileName(tr(&quot;Score_and_Parts&quot;)) + &quot;.pdf&quot;);</a>
<a name="ln1870">            QFileInfo fip(partfn);</a>
<a name="ln1871">            if(fip.exists() &amp;&amp; !overwrite) {</a>
<a name="ln1872">                  if (!noToAll) {</a>
<a name="ln1873">                        QMessageBox msgBox( QMessageBox::Question, confirmReplaceTitle,</a>
<a name="ln1874">                              confirmReplaceMessage.arg(QDir::toNativeSeparators(partfn)),</a>
<a name="ln1875">                              QMessageBox::Yes | QMessageBox::No);</a>
<a name="ln1876">                        msgBox.setButtonText(QMessageBox::Yes, replaceMessage);</a>
<a name="ln1877">                        msgBox.setButtonText(QMessageBox::No, skipMessage);</a>
<a name="ln1878">                        int sb = msgBox.exec();</a>
<a name="ln1879">                        if(sb == QMessageBox::Yes) {</a>
<a name="ln1880">                              if (!savePdf(scores, partfn))</a>
<a name="ln1881">                                    return false;</a>
<a name="ln1882">                              }</a>
<a name="ln1883">                        }</a>
<a name="ln1884">                  }</a>
<a name="ln1885">            else if (!savePdf(scores, partfn))</a>
<a name="ln1886">                  return false;</a>
<a name="ln1887">      }</a>
<a name="ln1888">      if(!noToAll)</a>
<a name="ln1889">            QMessageBox::information(this, tr(&quot;Export Parts&quot;), tr(&quot;Parts were successfully exported&quot;));</a>
<a name="ln1890">      return true;</a>
<a name="ln1891">      }</a>
<a name="ln1892"> </a>
<a name="ln1893">//---------------------------------------------------------</a>
<a name="ln1894">//   saveAs</a>
<a name="ln1895">//---------------------------------------------------------</a>
<a name="ln1896"> </a>
<a name="ln1897">bool MuseScore::saveAs(Score* cs_, bool saveCopy, const QString&amp; path, const QString&amp; ext)</a>
<a name="ln1898">      {</a>
<a name="ln1899">      bool rv = false;</a>
<a name="ln1900">      QString suffix = &quot;.&quot; + ext;</a>
<a name="ln1901">      QString fn(path);</a>
<a name="ln1902">      if (!fn.endsWith(suffix))</a>
<a name="ln1903">            fn += suffix;</a>
<a name="ln1904"> </a>
<a name="ln1905">      LayoutMode layoutMode = cs_-&gt;layoutMode();</a>
<a name="ln1906">      if (ext == &quot;mscx&quot; || ext == &quot;mscz&quot;) {</a>
<a name="ln1907">            // save as mscore *.msc[xz] file</a>
<a name="ln1908">            QFileInfo fi(fn);</a>
<a name="ln1909">            rv = true;</a>
<a name="ln1910">            // store new file and path into score fileInfo</a>
<a name="ln1911">            // to have it accessible to resources</a>
<a name="ln1912">            QFileInfo originalScoreFileInfo(*cs_-&gt;masterScore()-&gt;fileInfo());</a>
<a name="ln1913">            cs_-&gt;masterScore()-&gt;fileInfo()-&gt;setFile(fn);</a>
<a name="ln1914">            if (!cs_-&gt;isMaster()) { // clone metaTags from masterScore</a>
<a name="ln1915">                  QMapIterator&lt;QString, QString&gt; j(cs_-&gt;masterScore()-&gt;metaTags());</a>
<a name="ln1916">                  while (j.hasNext()) {</a>
<a name="ln1917">                        j.next();</a>
<a name="ln1918">                        if (j.key() != &quot;partName&quot;) // don't copy &quot;partName&quot; should that exist in masterScore</a>
<a name="ln1919">                              cs_-&gt;metaTags().insert(j.key(), j.value());</a>
<a name="ln1920">#if defined(Q_OS_WIN)   // Update &quot;platform&quot;, may not be worth the effort</a>
<a name="ln1921">                        cs_-&gt;metaTags().insert(&quot;platform&quot;, &quot;Microsoft Windows&quot;);</a>
<a name="ln1922">#elif defined(Q_OS_MAC)</a>
<a name="ln1923">                        cs_-&gt;metaTags().insert(&quot;platform&quot;, &quot;Apple Macintosh&quot;);</a>
<a name="ln1924">#elif defined(Q_OS_LINUX)</a>
<a name="ln1925">                        cs_-&gt;metaTags().insert(&quot;platform&quot;, &quot;Linux&quot;);</a>
<a name="ln1926">#else</a>
<a name="ln1927">                        cs_-&gt;metaTags().insert(&quot;platform&quot;, &quot;Unknown&quot;);</a>
<a name="ln1928">#endif</a>
<a name="ln1929">                        cs_-&gt;metaTags().insert(&quot;source&quot;, &quot;&quot;); // Empty &quot;source&quot; to avoid clashes with masterrScore when doing &quot;Save online&quot;</a>
<a name="ln1930">                        cs_-&gt;metaTags().insert(&quot;creationDate&quot;, QDate::currentDate().toString(Qt::ISODate)); // update &quot;creationDate&quot;</a>
<a name="ln1931">                        }</a>
<a name="ln1932">                  }</a>
<a name="ln1933">            try {</a>
<a name="ln1934">                  if (ext == &quot;mscz&quot;)</a>
<a name="ln1935">                        cs_-&gt;saveCompressedFile(fi, false);</a>
<a name="ln1936">                  else</a>
<a name="ln1937">                        cs_-&gt;saveFile(fi);</a>
<a name="ln1938">                  }</a>
<a name="ln1939">            catch (QString s) {</a>
<a name="ln1940">                  rv = false;</a>
<a name="ln1941">                  QMessageBox::critical(this, tr(&quot;Save As&quot;), s);</a>
<a name="ln1942">                  }</a>
<a name="ln1943">            if (!cs_-&gt;isMaster()) { // remove metaTags added above</a>
<a name="ln1944">                  QMapIterator&lt;QString, QString&gt; j(cs_-&gt;masterScore()-&gt;metaTags());</a>
<a name="ln1945">                  while (j.hasNext()) {</a>
<a name="ln1946">                        j.next();</a>
<a name="ln1947">                        // remove all but &quot;partName&quot;, should that exist in masterScore</a>
<a name="ln1948">                        if (j.key() != &quot;partName&quot;)</a>
<a name="ln1949">                              cs_-&gt;metaTags().remove(j.key());</a>
<a name="ln1950">                        }</a>
<a name="ln1951">                  }</a>
<a name="ln1952">            *cs_-&gt;masterScore()-&gt;fileInfo() = originalScoreFileInfo;          // restore original file info</a>
<a name="ln1953"> </a>
<a name="ln1954">            if (rv &amp;&amp; !saveCopy) {</a>
<a name="ln1955">                  cs_-&gt;masterScore()-&gt;fileInfo()-&gt;setFile(fn);</a>
<a name="ln1956">                  updateWindowTitle(cs_);</a>
<a name="ln1957">                  cs_-&gt;undoStack()-&gt;setClean();</a>
<a name="ln1958">                  dirtyChanged(cs_);</a>
<a name="ln1959">                  cs_-&gt;setCreated(false);</a>
<a name="ln1960">                  scoreCmpTool-&gt;updateScoreVersions(cs_);</a>
<a name="ln1961">                  addRecentScore(cs_);</a>
<a name="ln1962">                  writeSessionFile(false);</a>
<a name="ln1963">                  }</a>
<a name="ln1964">            }</a>
<a name="ln1965">      else if ((ext == &quot;musicxml&quot;) || (ext == &quot;xml&quot;)) {</a>
<a name="ln1966">            // save as MusicXML *.musicxml file</a>
<a name="ln1967">            rv = saveXml(cs_, fn);</a>
<a name="ln1968">            }</a>
<a name="ln1969">      else if (ext == &quot;mxl&quot;) {</a>
<a name="ln1970">            // save as compressed MusicXML *.mxl file</a>
<a name="ln1971">            rv = saveMxl(cs_, fn);</a>
<a name="ln1972">            }</a>
<a name="ln1973">      else if (ext == &quot;mid&quot;) {</a>
<a name="ln1974">            // save as midi file *.mid</a>
<a name="ln1975">            rv = saveMidi(cs_, fn);</a>
<a name="ln1976">            }</a>
<a name="ln1977">      else if (ext == &quot;pdf&quot;) {</a>
<a name="ln1978">            // save as pdf file *.pdf</a>
<a name="ln1979">            cs_-&gt;switchToPageMode();</a>
<a name="ln1980">            rv = savePdf(cs_, fn);</a>
<a name="ln1981">            }</a>
<a name="ln1982">      else if (ext == &quot;png&quot;) {</a>
<a name="ln1983">            // save as png file *.png</a>
<a name="ln1984">            cs_-&gt;switchToPageMode();</a>
<a name="ln1985">            rv = savePng(cs_, fn);</a>
<a name="ln1986">            }</a>
<a name="ln1987">      else if (ext == &quot;svg&quot;) {</a>
<a name="ln1988">            // save as svg file *.svg</a>
<a name="ln1989">            cs_-&gt;switchToPageMode();</a>
<a name="ln1990">            rv = saveSvg(cs_, fn);</a>
<a name="ln1991">            }</a>
<a name="ln1992">#ifdef HAS_AUDIOFILE</a>
<a name="ln1993">      else if (ext == &quot;wav&quot; || ext == &quot;flac&quot; || ext == &quot;ogg&quot;)</a>
<a name="ln1994">            rv = saveAudio(cs_, fn);</a>
<a name="ln1995">#endif</a>
<a name="ln1996">#ifdef USE_LAME</a>
<a name="ln1997">      else if (ext == &quot;mp3&quot;)</a>
<a name="ln1998">            rv = saveMp3(cs_, fn);</a>
<a name="ln1999">#endif</a>
<a name="ln2000">      else if (ext == &quot;spos&quot;) {</a>
<a name="ln2001">            cs_-&gt;switchToPageMode();</a>
<a name="ln2002">            // save positions of segments</a>
<a name="ln2003">            rv = savePositions(cs_, fn, true);</a>
<a name="ln2004">            }</a>
<a name="ln2005">      else if (ext == &quot;mpos&quot;) {</a>
<a name="ln2006">            cs_-&gt;switchToPageMode();</a>
<a name="ln2007">            // save positions of measures</a>
<a name="ln2008">            rv = savePositions(cs_, fn, false);</a>
<a name="ln2009">            }</a>
<a name="ln2010">      else if (ext == &quot;mlog&quot;) {</a>
<a name="ln2011">            rv = cs_-&gt;sanityCheck(fn);</a>
<a name="ln2012">            }</a>
<a name="ln2013">      else if (ext == &quot;metajson&quot;) {</a>
<a name="ln2014">            rv = saveMetadataJSON(cs, fn);</a>
<a name="ln2015">            }</a>
<a name="ln2016">      else {</a>
<a name="ln2017">            qDebug(&quot;Internal error: unsupported extension &lt;%s&gt;&quot;,</a>
<a name="ln2018">               qPrintable(ext));</a>
<a name="ln2019">            return false;</a>
<a name="ln2020">            }</a>
<a name="ln2021">      if (!rv &amp;&amp; !MScore::noGui)</a>
<a name="ln2022">            QMessageBox::critical(this, tr(&quot;MuseScore:&quot;), tr(&quot;Cannot write into %1&quot;).arg(fn));</a>
<a name="ln2023"> </a>
<a name="ln2024">      if (layoutMode != cs_-&gt;layoutMode()) {</a>
<a name="ln2025">            cs_-&gt;setLayoutMode(layoutMode);</a>
<a name="ln2026">            cs_-&gt;doLayout();</a>
<a name="ln2027">            }</a>
<a name="ln2028">      return rv;</a>
<a name="ln2029">      }</a>
<a name="ln2030"> </a>
<a name="ln2031">//---------------------------------------------------------</a>
<a name="ln2032">//   saveMidi</a>
<a name="ln2033">//---------------------------------------------------------</a>
<a name="ln2034"> </a>
<a name="ln2035">bool MuseScore::saveMidi(Score* score, const QString&amp; name)</a>
<a name="ln2036">      {</a>
<a name="ln2037">      ExportMidi em(score);</a>
<a name="ln2038">      return em.write(name, preferences.getBool(PREF_IO_MIDI_EXPANDREPEATS), preferences.getBool(PREF_IO_MIDI_EXPORTRPNS), synthesizerState());</a>
<a name="ln2039">      }</a>
<a name="ln2040"> </a>
<a name="ln2041">bool MuseScore::saveMidi(Score* score, QIODevice* device)</a>
<a name="ln2042">      {</a>
<a name="ln2043">      ExportMidi em(score);</a>
<a name="ln2044">      return em.write(device, preferences.getBool(PREF_IO_MIDI_EXPANDREPEATS), preferences.getBool(PREF_IO_MIDI_EXPORTRPNS), synthesizerState());</a>
<a name="ln2045">      }</a>
<a name="ln2046"> </a>
<a name="ln2047">//---------------------------------------------------------</a>
<a name="ln2048">//   savePdf</a>
<a name="ln2049">//---------------------------------------------------------</a>
<a name="ln2050"> </a>
<a name="ln2051">bool MuseScore::savePdf(const QString&amp; saveName)</a>
<a name="ln2052">      {</a>
<a name="ln2053">      return savePdf(cs, saveName);</a>
<a name="ln2054">      }</a>
<a name="ln2055"> </a>
<a name="ln2056">bool MuseScore::savePdf(Score* cs_, const QString&amp; saveName)</a>
<a name="ln2057">      {</a>
<a name="ln2058">      QPrinter printer;</a>
<a name="ln2059">      printer.setOutputFileName(saveName);</a>
<a name="ln2060">      return savePdf(cs_, printer);</a>
<a name="ln2061">      }</a>
<a name="ln2062"> </a>
<a name="ln2063">bool MuseScore::savePdf(Score* cs_, QPrinter&amp; printer)</a>
<a name="ln2064">      {</a>
<a name="ln2065">      cs_-&gt;setPrinting(true);</a>
<a name="ln2066">      MScore::pdfPrinting = true;</a>
<a name="ln2067"> </a>
<a name="ln2068">      printer.setResolution(preferences.getInt(PREF_EXPORT_PDF_DPI));</a>
<a name="ln2069">      QSizeF size(cs_-&gt;styleD(Sid::pageWidth), cs_-&gt;styleD(Sid::pageHeight));</a>
<a name="ln2070">      printer.setPaperSize(size, QPrinter::Inch);</a>
<a name="ln2071">      printer.setFullPage(true);</a>
<a name="ln2072">      printer.setColorMode(QPrinter::Color);</a>
<a name="ln2073">#if defined(Q_OS_MAC)</a>
<a name="ln2074">      printer.setOutputFormat(QPrinter::NativeFormat);</a>
<a name="ln2075">#else</a>
<a name="ln2076">      printer.setOutputFormat(QPrinter::PdfFormat);</a>
<a name="ln2077">#endif</a>
<a name="ln2078"> </a>
<a name="ln2079">      printer.setCreator(&quot;MuseScore Version: &quot; VERSION);</a>
<a name="ln2080">      if (!printer.setPageMargins(QMarginsF()))</a>
<a name="ln2081">            qDebug(&quot;unable to clear printer margins&quot;);</a>
<a name="ln2082"> </a>
<a name="ln2083">      QString title = cs_-&gt;metaTag(&quot;workTitle&quot;);</a>
<a name="ln2084">      if (title.isEmpty()) // workTitle unset?</a>
<a name="ln2085">            title = cs_-&gt;masterScore()-&gt;title(); // fall back to (master)score's tab title</a>
<a name="ln2086">      if (!cs_-&gt;isMaster()) { // excerpt?</a>
<a name="ln2087">            QString partname = cs_-&gt;metaTag(&quot;partName&quot;);</a>
<a name="ln2088">            if (partname.isEmpty()) // partName unset?</a>
<a name="ln2089">                  partname = cs_-&gt;title(); // fall back to excerpt's tab title</a>
<a name="ln2090">            title += &quot; - &quot; + partname;</a>
<a name="ln2091">            }</a>
<a name="ln2092">      printer.setDocName(title); // set PDF's meta data for Title</a>
<a name="ln2093"> </a>
<a name="ln2094">      QPainter p;</a>
<a name="ln2095">      if (!p.begin(&amp;printer))</a>
<a name="ln2096">            return false;</a>
<a name="ln2097">      p.setRenderHint(QPainter::Antialiasing, true);</a>
<a name="ln2098">      p.setRenderHint(QPainter::TextAntialiasing, true);</a>
<a name="ln2099"> </a>
<a name="ln2100">      p.setViewport(QRect(0.0, 0.0, size.width() * printer.logicalDpiX(),</a>
<a name="ln2101">         size.height() * printer.logicalDpiY()));</a>
<a name="ln2102">      p.setWindow(QRect(0.0, 0.0, size.width() * DPI, size.height() * DPI));</a>
<a name="ln2103"> </a>
<a name="ln2104">      double pr = MScore::pixelRatio;</a>
<a name="ln2105">      MScore::pixelRatio = DPI / printer.logicalDpiX();</a>
<a name="ln2106"> </a>
<a name="ln2107">      const QList&lt;Page*&gt; pl = cs_-&gt;pages();</a>
<a name="ln2108">      int pages = pl.size();</a>
<a name="ln2109">      bool firstPage = true;</a>
<a name="ln2110">      for (int n = 0; n &lt; pages; ++n) {</a>
<a name="ln2111">            if (!firstPage)</a>
<a name="ln2112">                  printer.newPage();</a>
<a name="ln2113">            firstPage = false;</a>
<a name="ln2114">            cs_-&gt;print(&amp;p, n);</a>
<a name="ln2115">            }</a>
<a name="ln2116">      p.end();</a>
<a name="ln2117">      cs_-&gt;setPrinting(false);</a>
<a name="ln2118"> </a>
<a name="ln2119">      MScore::pixelRatio = pr;</a>
<a name="ln2120">      MScore::pdfPrinting = false;</a>
<a name="ln2121">      return true;</a>
<a name="ln2122">      }</a>
<a name="ln2123"> </a>
<a name="ln2124">bool MuseScore::savePdf(QList&lt;Score*&gt; cs_, const QString&amp; saveName)</a>
<a name="ln2125">      {</a>
<a name="ln2126">      if (cs_.empty())</a>
<a name="ln2127">            return false;</a>
<a name="ln2128">      Score* firstScore = cs_[0];</a>
<a name="ln2129"> </a>
<a name="ln2130">      QPrinter printer;</a>
<a name="ln2131">      printer.setOutputFileName(saveName);</a>
<a name="ln2132">      printer.setResolution(preferences.getInt(PREF_EXPORT_PDF_DPI));</a>
<a name="ln2133">      QSizeF size(firstScore-&gt;styleD(Sid::pageWidth), firstScore-&gt;styleD(Sid::pageHeight));</a>
<a name="ln2134">      QPageSize ps(QPageSize::id(size, QPageSize::Inch, QPageSize::FuzzyOrientationMatch));</a>
<a name="ln2135">      printer.setPageSize(ps);</a>
<a name="ln2136">      printer.setPageOrientation(size.width() &gt; size.height() ? QPageLayout::Landscape : QPageLayout::Portrait);</a>
<a name="ln2137">      printer.setFullPage(true);</a>
<a name="ln2138">      printer.setColorMode(QPrinter::Color);</a>
<a name="ln2139">#if defined(Q_OS_MAC)</a>
<a name="ln2140">      printer.setOutputFormat(QPrinter::NativeFormat);</a>
<a name="ln2141">#else</a>
<a name="ln2142">      printer.setOutputFormat(QPrinter::PdfFormat);</a>
<a name="ln2143">#endif</a>
<a name="ln2144">      </a>
<a name="ln2145">      printer.setCreator(&quot;MuseScore Version: &quot; VERSION);</a>
<a name="ln2146">      if (!printer.setPageMargins(QMarginsF()))</a>
<a name="ln2147">            qDebug(&quot;unable to clear printer margins&quot;);</a>
<a name="ln2148"> </a>
<a name="ln2149">      QString title = firstScore-&gt;metaTag(&quot;workTitle&quot;);</a>
<a name="ln2150">      if (title.isEmpty()) // workTitle unset?</a>
<a name="ln2151">            title = firstScore-&gt;title(); // fall back to (master)score's tab title</a>
<a name="ln2152">      title += &quot; - &quot; + tr(&quot;Score and Parts&quot;);</a>
<a name="ln2153">      printer.setDocName(title); // set PDF's meta data for Title</a>
<a name="ln2154"> </a>
<a name="ln2155">      QPainter p;</a>
<a name="ln2156">      if (!p.begin(&amp;printer))</a>
<a name="ln2157">            return false;</a>
<a name="ln2158"> </a>
<a name="ln2159">      p.setRenderHint(QPainter::Antialiasing, true);</a>
<a name="ln2160">      p.setRenderHint(QPainter::TextAntialiasing, true);</a>
<a name="ln2161"> </a>
<a name="ln2162">      double pr = MScore::pixelRatio;</a>
<a name="ln2163"> </a>
<a name="ln2164">      bool firstPage = true;</a>
<a name="ln2165">      for (Score* s : cs_) {</a>
<a name="ln2166">            LayoutMode layoutMode = s-&gt;layoutMode();</a>
<a name="ln2167">            if (layoutMode != LayoutMode::PAGE) {</a>
<a name="ln2168">                  s-&gt;setLayoutMode(LayoutMode::PAGE);</a>
<a name="ln2169">            //      s-&gt;doLayout();</a>
<a name="ln2170">                  }</a>
<a name="ln2171">            s-&gt;doLayout();</a>
<a name="ln2172"> </a>
<a name="ln2173">            // done in Score::print() also, but do it here as well to be safe</a>
<a name="ln2174">            s-&gt;setPrinting(true);</a>
<a name="ln2175">            MScore::pdfPrinting = true;</a>
<a name="ln2176"> </a>
<a name="ln2177">            QSizeF size1(s-&gt;styleD(Sid::pageWidth), s-&gt;styleD(Sid::pageHeight));</a>
<a name="ln2178">            QPageSize ps1(QPageSize::id(size1, QPageSize::Inch, QPageSize::FuzzyOrientationMatch));</a>
<a name="ln2179">            printer.setPageSize(ps1);</a>
<a name="ln2180">            printer.setPageOrientation(size1.width() &gt; size1.height() ? QPageLayout::Landscape : QPageLayout::Portrait);</a>
<a name="ln2181">            p.setViewport(QRect(0.0, 0.0, size1.width() * printer.logicalDpiX(),</a>
<a name="ln2182">               size1.height() * printer.logicalDpiY()));</a>
<a name="ln2183">            p.setWindow(QRect(0.0, 0.0, size1.width() * DPI, size1.height() * DPI));</a>
<a name="ln2184"> </a>
<a name="ln2185">            MScore::pixelRatio = DPI / printer.logicalDpiX();</a>
<a name="ln2186">            const QList&lt;Page*&gt; pl = s-&gt;pages();</a>
<a name="ln2187">            int pages    = pl.size();</a>
<a name="ln2188">            for (int n = 0; n &lt; pages; ++n) {</a>
<a name="ln2189">                  if (!firstPage)</a>
<a name="ln2190">                        printer.newPage();</a>
<a name="ln2191">                  firstPage = false;</a>
<a name="ln2192">                  s-&gt;print(&amp;p, n);</a>
<a name="ln2193">                  }</a>
<a name="ln2194">            MScore::pixelRatio = pr;</a>
<a name="ln2195"> </a>
<a name="ln2196">            //reset score</a>
<a name="ln2197">            s-&gt;setPrinting(false);</a>
<a name="ln2198">            MScore::pdfPrinting = false;</a>
<a name="ln2199"> </a>
<a name="ln2200">            if (layoutMode != s-&gt;layoutMode()) {</a>
<a name="ln2201">                  s-&gt;setLayoutMode(layoutMode);</a>
<a name="ln2202">                  s-&gt;doLayout();</a>
<a name="ln2203">                  }</a>
<a name="ln2204">            }</a>
<a name="ln2205">      p.end();</a>
<a name="ln2206">      return true;</a>
<a name="ln2207">      }</a>
<a name="ln2208"> </a>
<a name="ln2209">//---------------------------------------------------------</a>
<a name="ln2210">//   importSoundfont</a>
<a name="ln2211">//---------------------------------------------------------</a>
<a name="ln2212"> </a>
<a name="ln2213">void importSoundfont(QString name)</a>
<a name="ln2214">      {</a>
<a name="ln2215">      QFileInfo info(name);</a>
<a name="ln2216">      int ret = QMessageBox::question(0, QWidget::tr(&quot;Install SoundFont&quot;),</a>
<a name="ln2217">            QWidget::tr(&quot;Do you want to install the SoundFont %1?&quot;).arg(info.fileName()),</a>
<a name="ln2218">             QMessageBox::Yes|QMessageBox::No, QMessageBox::NoButton);</a>
<a name="ln2219">      if (ret == QMessageBox::Yes) {</a>
<a name="ln2220">            QStringList pl = preferences.getString(PREF_APP_PATHS_MYSOUNDFONTS).split(&quot;;&quot;);</a>
<a name="ln2221">            QString destPath;</a>
<a name="ln2222">            for (QString s : pl) {</a>
<a name="ln2223">                  QFileInfo dest(s);</a>
<a name="ln2224">                  if (dest.isWritable())</a>
<a name="ln2225">                        destPath = s;</a>
<a name="ln2226">                  }</a>
<a name="ln2227">            if (!destPath.isEmpty()) {</a>
<a name="ln2228">                  QString destFilePath = destPath+ &quot;/&quot; +info.fileName();</a>
<a name="ln2229">                  QFileInfo destFileInfo(destFilePath);</a>
<a name="ln2230">                  QFile destFile(destFilePath);</a>
<a name="ln2231">                  if (destFileInfo.exists()) {</a>
<a name="ln2232">                        int ret1 = QMessageBox::question(0, QWidget::tr(&quot;Overwrite?&quot;),</a>
<a name="ln2233">                          QWidget::tr(&quot;%1 already exists.\nDo you want to overwrite it?&quot;).arg(destFileInfo.absoluteFilePath()),</a>
<a name="ln2234">                          QMessageBox::Yes|QMessageBox::No, QMessageBox::No);</a>
<a name="ln2235">                        if (ret1 == QMessageBox::No)</a>
<a name="ln2236">                              return;</a>
<a name="ln2237">                        destFile.remove();</a>
<a name="ln2238">                        }</a>
<a name="ln2239">                  QFile orig(name);</a>
<a name="ln2240">                  if (orig.copy(destFilePath)) {</a>
<a name="ln2241">                        QMessageBox::information(0, QWidget::tr(&quot;SoundFont installed&quot;), QWidget::tr(&quot;SoundFont installed. Please go to View &gt; Synthesizer to add it and View &gt; Mixer to choose an instrument sound.&quot;));</a>
<a name="ln2242">                        }</a>
<a name="ln2243">                  }</a>
<a name="ln2244">            }</a>
<a name="ln2245">      }</a>
<a name="ln2246"> </a>
<a name="ln2247">//---------------------------------------------------------</a>
<a name="ln2248">//   importExtension</a>
<a name="ln2249">//---------------------------------------------------------</a>
<a name="ln2250"> </a>
<a name="ln2251">void importExtension(QString name)</a>
<a name="ln2252">      {</a>
<a name="ln2253">      mscore-&gt;importExtension(name);</a>
<a name="ln2254">      }</a>
<a name="ln2255"> </a>
<a name="ln2256">//---------------------------------------------------------</a>
<a name="ln2257">//   readScore</a>
<a name="ln2258">///   Import file \a name</a>
<a name="ln2259">//---------------------------------------------------------</a>
<a name="ln2260"> </a>
<a name="ln2261">Score::FileError readScore(MasterScore* score, QString name, bool ignoreVersionError)</a>
<a name="ln2262">      {</a>
<a name="ln2263">      ScoreLoad sl;</a>
<a name="ln2264"> </a>
<a name="ln2265">      QFileInfo info(name);</a>
<a name="ln2266">      QString suffix  = info.suffix().toLower();</a>
<a name="ln2267">      score-&gt;setName(info.completeBaseName());</a>
<a name="ln2268">      score-&gt;setImportedFilePath(name);</a>
<a name="ln2269"> </a>
<a name="ln2270">      // Set the default synthesizer state before we read</a>
<a name="ln2271">      if (synti)</a>
<a name="ln2272">            score-&gt;setSynthesizerState(synti-&gt;state());</a>
<a name="ln2273"> </a>
<a name="ln2274">      if (suffix == &quot;mscz&quot; || suffix == &quot;mscx&quot;) {</a>
<a name="ln2275">            Score::FileError rv = score-&gt;loadMsc(name, ignoreVersionError);</a>
<a name="ln2276">            if (score &amp;&amp; score-&gt;masterScore()-&gt;fileInfo()-&gt;path().startsWith(&quot;:/&quot;))</a>
<a name="ln2277">                  score-&gt;setCreated(true);</a>
<a name="ln2278">            if (rv != Score::FileError::FILE_NO_ERROR)</a>
<a name="ln2279">                  return rv;</a>
<a name="ln2280">            }</a>
<a name="ln2281">      else if (suffix == &quot;sf2&quot; || suffix == &quot;sf3&quot;) {</a>
<a name="ln2282">            importSoundfont(name);</a>
<a name="ln2283">            return Score::FileError::FILE_IGNORE_ERROR;</a>
<a name="ln2284">            }</a>
<a name="ln2285">      else if (suffix == &quot;muxt&quot;) {</a>
<a name="ln2286">           importExtension(name);</a>
<a name="ln2287">           return Score::FileError::FILE_IGNORE_ERROR;</a>
<a name="ln2288">           }</a>
<a name="ln2289">      else {</a>
<a name="ln2290">            // typedef Score::FileError (*ImportFunction)(MasterScore*, const QString&amp;);</a>
<a name="ln2291">            struct ImportDef {</a>
<a name="ln2292">                  const char* extension;</a>
<a name="ln2293">                  // ImportFunction importF;</a>
<a name="ln2294">                  Score::FileError (*importF)(MasterScore*, const QString&amp;);</a>
<a name="ln2295">                  };</a>
<a name="ln2296">            static const ImportDef imports[] = {</a>
<a name="ln2297">                  { &quot;xml&quot;,  &amp;importMusicXml           },</a>
<a name="ln2298">                  { &quot;musicxml&quot;, &amp;importMusicXml       },</a>
<a name="ln2299">                  { &quot;mxl&quot;,  &amp;importCompressedMusicXml },</a>
<a name="ln2300">                  { &quot;mid&quot;,  &amp;importMidi               },</a>
<a name="ln2301">                  { &quot;midi&quot;, &amp;importMidi               },</a>
<a name="ln2302">                  { &quot;kar&quot;,  &amp;importMidi               },</a>
<a name="ln2303">                  { &quot;md&quot;,   &amp;importMuseData           },</a>
<a name="ln2304">                  { &quot;mgu&quot;,  &amp;importBB                 },</a>
<a name="ln2305">                  { &quot;sgu&quot;,  &amp;importBB                 },</a>
<a name="ln2306">                  { &quot;cap&quot;,  &amp;importCapella            },</a>
<a name="ln2307">                  { &quot;capx&quot;, &amp;importCapXml             },</a>
<a name="ln2308">                  { &quot;ove&quot;,  &amp;importOve                },</a>
<a name="ln2309">                  { &quot;scw&quot;,  &amp;importOve                },</a>
<a name="ln2310">#ifdef OMR</a>
<a name="ln2311">                  { &quot;pdf&quot;,  &amp;importPdf                },</a>
<a name="ln2312">#endif</a>
<a name="ln2313">                  { &quot;bww&quot;,  &amp;importBww                },</a>
<a name="ln2314">                  { &quot;gtp&quot;,  &amp;importGTP                },</a>
<a name="ln2315">                  { &quot;gp3&quot;,  &amp;importGTP                },</a>
<a name="ln2316">                  { &quot;gp4&quot;,  &amp;importGTP                },</a>
<a name="ln2317">                  { &quot;gp5&quot;,  &amp;importGTP                },</a>
<a name="ln2318">                  { &quot;gpx&quot;,  &amp;importGTP                },</a>
<a name="ln2319">                  { &quot;ptb&quot;,  &amp;importGTP                },</a>
<a name="ln2320">                  };</a>
<a name="ln2321"> </a>
<a name="ln2322">            // import</a>
<a name="ln2323">            if (!preferences.getString(PREF_IMPORT_STYLE_STYLEFILE).isEmpty()) {</a>
<a name="ln2324">                  QFile f(preferences.getString(PREF_IMPORT_STYLE_STYLEFILE));</a>
<a name="ln2325">                  // silently ignore style file on error</a>
<a name="ln2326">                  if (f.open(QIODevice::ReadOnly))</a>
<a name="ln2327">                        score-&gt;style().load(&amp;f);</a>
<a name="ln2328">                  }</a>
<a name="ln2329">            else {</a>
<a name="ln2330">                  score-&gt;style().checkChordList();</a>
<a name="ln2331">                  }</a>
<a name="ln2332">            bool found = false;</a>
<a name="ln2333">            for (auto i : imports) {</a>
<a name="ln2334">                  if (i.extension == suffix) {</a>
<a name="ln2335">                        Score::FileError rv = (*i.importF)(score, name);</a>
<a name="ln2336">                        if (rv != Score::FileError::FILE_NO_ERROR)</a>
<a name="ln2337">                              return rv;</a>
<a name="ln2338">                        found = true;</a>
<a name="ln2339">                        break;</a>
<a name="ln2340">                        }</a>
<a name="ln2341">                  }</a>
<a name="ln2342">            if (!found) {</a>
<a name="ln2343">                  qDebug(&quot;unknown file suffix &lt;%s&gt;, name &lt;%s&gt;&quot;, qPrintable(suffix), qPrintable(name));</a>
<a name="ln2344">                  return Score::FileError::FILE_UNKNOWN_TYPE;</a>
<a name="ln2345">                  }</a>
<a name="ln2346">            score-&gt;setMetaTag(&quot;originalFormat&quot;, suffix);</a>
<a name="ln2347">            score-&gt;connectTies();</a>
<a name="ln2348">            score-&gt;setCreated(true); // force save as for imported files</a>
<a name="ln2349">            }</a>
<a name="ln2350"> </a>
<a name="ln2351">      score-&gt;rebuildMidiMapping();</a>
<a name="ln2352">      score-&gt;setSoloMute();</a>
<a name="ln2353">      for (Score* s : score-&gt;scoreList()) {</a>
<a name="ln2354">            s-&gt;setPlaylistDirty();</a>
<a name="ln2355">            s-&gt;addLayoutFlags(LayoutFlag::FIX_PITCH_VELO);</a>
<a name="ln2356">            s-&gt;setLayoutAll();</a>
<a name="ln2357">            }</a>
<a name="ln2358">      score-&gt;updateChannel();</a>
<a name="ln2359">      score-&gt;updateExpressive(MuseScore::synthesizer(&quot;Fluid&quot;));</a>
<a name="ln2360">      score-&gt;setSaved(false);</a>
<a name="ln2361">      score-&gt;update();</a>
<a name="ln2362"> </a>
<a name="ln2363">      if (!ignoreVersionError &amp;&amp; !MScore::noGui)</a>
<a name="ln2364">            if (!score-&gt;sanityCheck(QString()))</a>
<a name="ln2365">                  return Score::FileError::FILE_CORRUPTED;</a>
<a name="ln2366">      return Score::FileError::FILE_NO_ERROR;</a>
<a name="ln2367">      }</a>
<a name="ln2368"> </a>
<a name="ln2369">//---------------------------------------------------------</a>
<a name="ln2370">//   saveAs</a>
<a name="ln2371">//    return true on success</a>
<a name="ln2372">//---------------------------------------------------------</a>
<a name="ln2373"> </a>
<a name="ln2374">/**</a>
<a name="ln2375"> Save the current score using a different name or type.</a>
<a name="ln2376"> Handles the GUI's file-save-as and file-save-a-copy actions.</a>
<a name="ln2377"> The saveCopy flag, if true, does not change the name of the active score nor marks it clean.</a>
<a name="ln2378"> Return true if OK and false on error.</a>
<a name="ln2379"> */</a>
<a name="ln2380"> </a>
<a name="ln2381">bool MuseScore::saveAs(Score* cs_, bool saveCopy)</a>
<a name="ln2382">      {</a>
<a name="ln2383">      QStringList fl;</a>
<a name="ln2384">      fl.append(tr(&quot;MuseScore 3 File&quot;) + &quot; (*.mscz)&quot;);</a>
<a name="ln2385">      fl.append(tr(&quot;Uncompressed MuseScore 3 File&quot;) + &quot; (*.mscx)&quot;);     // for debugging purposes</a>
<a name="ln2386">      QString saveDialogTitle = saveCopy ? tr(&quot;Save a Copy&quot;) :</a>
<a name="ln2387">                                           tr(&quot;Save As&quot;);</a>
<a name="ln2388"> </a>
<a name="ln2389">      QString saveDirectory;</a>
<a name="ln2390">      if (cs_-&gt;masterScore()-&gt;fileInfo()-&gt;exists())</a>
<a name="ln2391">            saveDirectory = cs_-&gt;masterScore()-&gt;fileInfo()-&gt;dir().path();</a>
<a name="ln2392">      else {</a>
<a name="ln2393">            QSettings set;</a>
<a name="ln2394">            if (saveCopy) {</a>
<a name="ln2395">                  if (mscore-&gt;lastSaveCopyDirectory.isEmpty())</a>
<a name="ln2396">                        mscore-&gt;lastSaveCopyDirectory = set.value(&quot;lastSaveCopyDirectory&quot;, preferences.getString(PREF_APP_PATHS_MYSCORES)).toString();</a>
<a name="ln2397">                  saveDirectory = mscore-&gt;lastSaveCopyDirectory;</a>
<a name="ln2398">                  }</a>
<a name="ln2399">            else {</a>
<a name="ln2400">                  if (mscore-&gt;lastSaveDirectory.isEmpty())</a>
<a name="ln2401">                        mscore-&gt;lastSaveDirectory = set.value(&quot;lastSaveDirectory&quot;, preferences.getString(PREF_APP_PATHS_MYSCORES)).toString();</a>
<a name="ln2402">                  saveDirectory = mscore-&gt;lastSaveDirectory;</a>
<a name="ln2403">                  }</a>
<a name="ln2404">            }</a>
<a name="ln2405"> </a>
<a name="ln2406">      if (saveDirectory.isEmpty())</a>
<a name="ln2407">            saveDirectory = preferences.getString(PREF_APP_PATHS_MYSCORES);</a>
<a name="ln2408"> </a>
<a name="ln2409">      QString name;</a>
<a name="ln2410">#ifdef Q_OS_WIN</a>
<a name="ln2411">      if (QSysInfo::WindowsVersion == QSysInfo::WV_XP) {</a>
<a name="ln2412">            if (!cs_-&gt;isMaster())</a>
<a name="ln2413">                  name = QString(&quot;%1/%2-%3&quot;).arg(saveDirectory).arg(cs_-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName()).arg(createDefaultFileName(cs-&gt;title()));</a>
<a name="ln2414">            else</a>
<a name="ln2415">                  name = QString(&quot;%1/%2&quot;).arg(saveDirectory).arg(cs_-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName());</a>
<a name="ln2416">            }</a>
<a name="ln2417">      else</a>
<a name="ln2418">#endif</a>
<a name="ln2419">      if (!cs_-&gt;isMaster())</a>
<a name="ln2420">            name = QString(&quot;%1/%2-%3.mscz&quot;).arg(saveDirectory).arg(cs_-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName()).arg(createDefaultFileName(cs-&gt;title()));</a>
<a name="ln2421">      else</a>
<a name="ln2422">            name = QString(&quot;%1/%2.mscz&quot;).arg(saveDirectory).arg(cs_-&gt;masterScore()-&gt;fileInfo()-&gt;completeBaseName());</a>
<a name="ln2423"> </a>
<a name="ln2424">      QString filter = fl.join(&quot;;;&quot;);</a>
<a name="ln2425">      QString fn     = mscore-&gt;getSaveScoreName(saveDialogTitle, name, filter);</a>
<a name="ln2426">      if (fn.isEmpty())</a>
<a name="ln2427">            return false;</a>
<a name="ln2428"> </a>
<a name="ln2429">      QFileInfo fi(fn);</a>
<a name="ln2430">      if (saveCopy)</a>
<a name="ln2431">            mscore-&gt;lastSaveCopyDirectory = fi.absolutePath();</a>
<a name="ln2432">      else</a>
<a name="ln2433">            mscore-&gt;lastSaveDirectory = fi.absolutePath();</a>
<a name="ln2434"> </a>
<a name="ln2435">      if (fi.suffix().isEmpty()) {</a>
<a name="ln2436">            if (!MScore::noGui)</a>
<a name="ln2437">                  QMessageBox::critical(mscore, tr(&quot;Save As&quot;), tr(&quot;Cannot determine file type&quot;));</a>
<a name="ln2438">            return false;</a>
<a name="ln2439">            }</a>
<a name="ln2440">      return saveAs(cs_, saveCopy, fn, fi.suffix());</a>
<a name="ln2441">      }</a>
<a name="ln2442"> </a>
<a name="ln2443">//---------------------------------------------------------</a>
<a name="ln2444">//   saveSelection</a>
<a name="ln2445">//    return true on success</a>
<a name="ln2446">//---------------------------------------------------------</a>
<a name="ln2447"> </a>
<a name="ln2448">bool MuseScore::saveSelection(Score* cs_)</a>
<a name="ln2449">      {</a>
<a name="ln2450">      if (!cs_-&gt;selection().isRange()) {</a>
<a name="ln2451">            if(!MScore::noGui) QMessageBox::warning(mscore, tr(&quot;Save Selection&quot;), tr(&quot;Please select one or more measures&quot;));</a>
<a name="ln2452">            return false;</a>
<a name="ln2453">            }</a>
<a name="ln2454">      QStringList fl;</a>
<a name="ln2455">      fl.append(tr(&quot;MuseScore 3 File&quot;) + &quot; (*.mscz)&quot;);</a>
<a name="ln2456">      fl.append(tr(&quot;Uncompressed MuseScore 3 File&quot;) + &quot; (*.mscx)&quot;);     // for debugging purposes</a>
<a name="ln2457">      QString saveDialogTitle = tr(&quot;Save Selection&quot;);</a>
<a name="ln2458"> </a>
<a name="ln2459">      QString saveDirectory;</a>
<a name="ln2460">      if (cs_-&gt;masterScore()-&gt;fileInfo()-&gt;exists())</a>
<a name="ln2461">            saveDirectory = cs_-&gt;masterScore()-&gt;fileInfo()-&gt;dir().path();</a>
<a name="ln2462">      else {</a>
<a name="ln2463">            QSettings set;</a>
<a name="ln2464">            if (mscore-&gt;lastSaveDirectory.isEmpty())</a>
<a name="ln2465">                  mscore-&gt;lastSaveDirectory = set.value(&quot;lastSaveDirectory&quot;, preferences.getString(PREF_APP_PATHS_MYSCORES)).toString();</a>
<a name="ln2466">            saveDirectory = mscore-&gt;lastSaveDirectory;</a>
<a name="ln2467">            }</a>
<a name="ln2468"> </a>
<a name="ln2469">      if (saveDirectory.isEmpty())</a>
<a name="ln2470">            saveDirectory = preferences.getString(PREF_APP_PATHS_MYSCORES);</a>
<a name="ln2471"> </a>
<a name="ln2472">      QString name   = QString(&quot;%1/%2.mscz&quot;).arg(saveDirectory).arg(cs_-&gt;title());</a>
<a name="ln2473">      QString filter = fl.join(&quot;;;&quot;);</a>
<a name="ln2474">      QString fn     = mscore-&gt;getSaveScoreName(saveDialogTitle, name, filter);</a>
<a name="ln2475">      if (fn.isEmpty())</a>
<a name="ln2476">            return false;</a>
<a name="ln2477"> </a>
<a name="ln2478">      QFileInfo fi(fn);</a>
<a name="ln2479">      mscore-&gt;lastSaveDirectory = fi.absolutePath();</a>
<a name="ln2480"> </a>
<a name="ln2481">      QString ext = fi.suffix();</a>
<a name="ln2482">      if (ext.isEmpty()) {</a>
<a name="ln2483">            QMessageBox::critical(mscore, tr(&quot;Save Selection&quot;), tr(&quot;Cannot determine file type&quot;));</a>
<a name="ln2484">            return false;</a>
<a name="ln2485">            }</a>
<a name="ln2486">      bool rv = true;</a>
<a name="ln2487">      try {</a>
<a name="ln2488">            cs_-&gt;saveCompressedFile(fi, true);</a>
<a name="ln2489">            }</a>
<a name="ln2490">      catch (QString s) {</a>
<a name="ln2491">            rv = false;</a>
<a name="ln2492">            QMessageBox::critical(this, tr(&quot;Save Selected&quot;), s);</a>
<a name="ln2493">            }</a>
<a name="ln2494">      return rv;</a>
<a name="ln2495">      }</a>
<a name="ln2496"> </a>
<a name="ln2497">//---------------------------------------------------------</a>
<a name="ln2498">//   addImage</a>
<a name="ln2499">//---------------------------------------------------------</a>
<a name="ln2500"> </a>
<a name="ln2501">void MuseScore::addImage(Score* score, Element* e)</a>
<a name="ln2502">      {</a>
<a name="ln2503">      QString fn = QFileDialog::getOpenFileName(</a>
<a name="ln2504">         0,</a>
<a name="ln2505">         tr(&quot;Insert Image&quot;),</a>
<a name="ln2506">         &quot;&quot;,            // lastOpenPath,</a>
<a name="ln2507">         tr(&quot;All Supported Files&quot;) + &quot; (*.svg *.jpg *.jpeg *.png);;&quot; +</a>
<a name="ln2508">         tr(&quot;Scalable Vector Graphics&quot;) + &quot; (*.svg);;&quot; +</a>
<a name="ln2509">         tr(&quot;JPEG&quot;) + &quot; (*.jpg *.jpeg);;&quot; +</a>
<a name="ln2510">         tr(&quot;PNG Bitmap Graphic&quot;) + &quot; (*.png)&quot;,</a>
<a name="ln2511">         0,</a>
<a name="ln2512">         preferences.getBool(PREF_UI_APP_USENATIVEDIALOGS) ? QFileDialog::Options() : QFileDialog::DontUseNativeDialog</a>
<a name="ln2513">         );</a>
<a name="ln2514">      if (fn.isEmpty())</a>
<a name="ln2515">            return;</a>
<a name="ln2516"> </a>
<a name="ln2517">      QFileInfo fi(fn);</a>
<a name="ln2518">      Image* s = new Image(score);</a>
<a name="ln2519">      QString suffix(fi.suffix().toLower());</a>
<a name="ln2520"> </a>
<a name="ln2521">      if (suffix == &quot;svg&quot;)</a>
<a name="ln2522">            s-&gt;setImageType(ImageType::SVG);</a>
<a name="ln2523">      else if (suffix == &quot;jpg&quot; || suffix == &quot;jpeg&quot; || suffix == &quot;png&quot;)</a>
<a name="ln2524">            s-&gt;setImageType(ImageType::RASTER);</a>
<a name="ln2525">      else</a>
<a name="ln2526">            return;</a>
<a name="ln2527">      s-&gt;load(fn);</a>
<a name="ln2528">      s-&gt;setParent(e);</a>
<a name="ln2529">      score-&gt;undoAddElement(s);</a>
<a name="ln2530">      }</a>
<a name="ln2531"> </a>
<a name="ln2532">#if 0</a>
<a name="ln2533">//---------------------------------------------------------</a>
<a name="ln2534">//   trim</a>
<a name="ln2535">//    returns copy of source with whitespace trimmed and margin added</a>
<a name="ln2536">//---------------------------------------------------------</a>
<a name="ln2537"> </a>
<a name="ln2538">static QRect trim(QImage source, int margin)</a>
<a name="ln2539">      {</a>
<a name="ln2540">      int w = source.width();</a>
<a name="ln2541">      int h = source.height();</a>
<a name="ln2542">      int x1 = w;</a>
<a name="ln2543">      int x2 = 0;</a>
<a name="ln2544">      int y1 = h;</a>
<a name="ln2545">      int y2 = 0;</a>
<a name="ln2546">      for (int x = 0; x &lt; w; ++x) {</a>
<a name="ln2547">            for (int y = 0; y &lt; h; ++y) {</a>
<a name="ln2548">                  QRgb c = source.pixel(x, y);</a>
<a name="ln2549">                  if (c != 0 &amp;&amp; c != 0xffffffff) {</a>
<a name="ln2550">                        if (x &lt; x1)</a>
<a name="ln2551">                              x1 = x;</a>
<a name="ln2552">                        if (x &gt; x2)</a>
<a name="ln2553">                              x2 = x;</a>
<a name="ln2554">                        if (y &lt; y1)</a>
<a name="ln2555">                              y1 = y;</a>
<a name="ln2556">                        if (y &gt; y2)</a>
<a name="ln2557">                              y2 = y;</a>
<a name="ln2558">                        }</a>
<a name="ln2559">                  }</a>
<a name="ln2560">            }</a>
<a name="ln2561">      int x = qMax(x1 - margin, 0);</a>
<a name="ln2562">      int y = qMax(y1 - margin, 0);</a>
<a name="ln2563">      w = qMin(w, x2 + 1 + margin) - x;</a>
<a name="ln2564">      h = qMin(h, y2 + 1 + margin) - y;</a>
<a name="ln2565">      return QRect(x, y, w, h);</a>
<a name="ln2566">      }</a>
<a name="ln2567">#endif</a>
<a name="ln2568"> </a>
<a name="ln2569">//---------------------------------------------------------</a>
<a name="ln2570">//   savePng</a>
<a name="ln2571">//    return true on success.  Works with editor, shows additional windows.</a>
<a name="ln2572">//---------------------------------------------------------</a>
<a name="ln2573"> </a>
<a name="ln2574">bool MuseScore::savePng(Score* score, const QString&amp; name)</a>
<a name="ln2575">      {</a>
<a name="ln2576">      const QList&lt;Page*&gt;&amp; pl = score-&gt;pages();</a>
<a name="ln2577">      int pages = pl.size();</a>
<a name="ln2578">      int padding = QString(&quot;%1&quot;).arg(pages).size();</a>
<a name="ln2579">      bool overwrite = false;</a>
<a name="ln2580">      bool noToAll = false;</a>
<a name="ln2581">      for (int pageNumber = 0; pageNumber &lt; pages; ++pageNumber) {</a>
<a name="ln2582">            QString fileName(name);</a>
<a name="ln2583">            if (fileName.endsWith(&quot;.png&quot;))</a>
<a name="ln2584">                  fileName = fileName.left(fileName.size() - 4);</a>
<a name="ln2585">            fileName += QString(&quot;-%1.png&quot;).arg(pageNumber+1, padding, 10, QLatin1Char('0'));</a>
<a name="ln2586">            if (!converterMode) {</a>
<a name="ln2587">                  QFileInfo fip(fileName);</a>
<a name="ln2588">                  if(fip.exists() &amp;&amp; !overwrite) {</a>
<a name="ln2589">                        if(noToAll)</a>
<a name="ln2590">                              continue;</a>
<a name="ln2591">                        QMessageBox msgBox( QMessageBox::Question, tr(&quot;Confirm Replace&quot;),</a>
<a name="ln2592">                              tr(&quot;\&quot;%1\&quot; already exists.\nDo you want to replace it?\n&quot;).arg(QDir::toNativeSeparators(fileName)),</a>
<a name="ln2593">                              QMessageBox::Yes |  QMessageBox::YesToAll | QMessageBox::No |  QMessageBox::NoToAll);</a>
<a name="ln2594">                        msgBox.setButtonText(QMessageBox::Yes, tr(&quot;Replace&quot;));</a>
<a name="ln2595">                        msgBox.setButtonText(QMessageBox::No, tr(&quot;Skip&quot;));</a>
<a name="ln2596">                        msgBox.setButtonText(QMessageBox::YesToAll, tr(&quot;Replace All&quot;));</a>
<a name="ln2597">                        msgBox.setButtonText(QMessageBox::NoToAll, tr(&quot;Skip All&quot;));</a>
<a name="ln2598">                        int sb = msgBox.exec();</a>
<a name="ln2599">                        if(sb == QMessageBox::YesToAll) {</a>
<a name="ln2600">                              overwrite = true;</a>
<a name="ln2601">                              }</a>
<a name="ln2602">                        else if (sb == QMessageBox::NoToAll) {</a>
<a name="ln2603">                              noToAll = true;</a>
<a name="ln2604">                              continue;</a>
<a name="ln2605">                              }</a>
<a name="ln2606">                        else if (sb == QMessageBox::No)</a>
<a name="ln2607">                              continue;</a>
<a name="ln2608">                        }</a>
<a name="ln2609">                  }</a>
<a name="ln2610">            QFile f(fileName);</a>
<a name="ln2611">            if (!f.open(QIODevice::WriteOnly))</a>
<a name="ln2612">                  return false;</a>
<a name="ln2613">            bool rv = savePng(score, &amp;f, pageNumber);</a>
<a name="ln2614">            if (!rv)</a>
<a name="ln2615">                  return false;</a>
<a name="ln2616">            }</a>
<a name="ln2617">      return true;</a>
<a name="ln2618">      }</a>
<a name="ln2619"> </a>
<a name="ln2620">//---------------------------------------------------------</a>
<a name="ln2621">//   savePng with options</a>
<a name="ln2622">//    return true on success</a>
<a name="ln2623">//---------------------------------------------------------</a>
<a name="ln2624"> </a>
<a name="ln2625">bool MuseScore::savePng(Score* score, QIODevice* device, int pageNumber, bool drawPageBackground)</a>
<a name="ln2626">      {</a>
<a name="ln2627">      const bool screenshot = false;</a>
<a name="ln2628">      const bool transparent = preferences.getBool(PREF_EXPORT_PNG_USETRANSPARENCY) &amp;&amp; !drawPageBackground;</a>
<a name="ln2629">      const double convDpi = preferences.getDouble(PREF_EXPORT_PNG_RESOLUTION);</a>
<a name="ln2630">      const int localTrimMargin = trimMargin;</a>
<a name="ln2631">      const QImage::Format format = QImage::Format_ARGB32_Premultiplied;</a>
<a name="ln2632"> </a>
<a name="ln2633">      bool rv = true;</a>
<a name="ln2634">      score-&gt;setPrinting(!screenshot);    // don’t print page break symbols etc.</a>
<a name="ln2635">      double pr = MScore::pixelRatio;</a>
<a name="ln2636"> </a>
<a name="ln2637">      QImage::Format f;</a>
<a name="ln2638">      if (format != QImage::Format_Indexed8)</a>
<a name="ln2639">          f = format;</a>
<a name="ln2640">      else</a>
<a name="ln2641">          f = QImage::Format_ARGB32_Premultiplied;</a>
<a name="ln2642"> </a>
<a name="ln2643">      const QList&lt;Page*&gt;&amp; pl = score-&gt;pages();</a>
<a name="ln2644"> </a>
<a name="ln2645">      Page* page = pl.at(pageNumber);</a>
<a name="ln2646">      QRectF r;</a>
<a name="ln2647">      if (localTrimMargin &gt;= 0) {</a>
<a name="ln2648">            QMarginsF margins(localTrimMargin, localTrimMargin, localTrimMargin, localTrimMargin);</a>
<a name="ln2649">            r = page-&gt;tbbox() + margins;</a>
<a name="ln2650">            }</a>
<a name="ln2651">      else</a>
<a name="ln2652">            r = page-&gt;abbox();</a>
<a name="ln2653">      int w = lrint(r.width()  * convDpi / DPI);</a>
<a name="ln2654">      int h = lrint(r.height() * convDpi / DPI);</a>
<a name="ln2655"> </a>
<a name="ln2656">      QImage printer(w, h, f);</a>
<a name="ln2657">      printer.setDotsPerMeterX(lrint((convDpi * 1000) / INCH));</a>
<a name="ln2658">      printer.setDotsPerMeterY(lrint((convDpi * 1000) / INCH));</a>
<a name="ln2659"> </a>
<a name="ln2660">      printer.fill(transparent ? 0 : 0xffffffff);</a>
<a name="ln2661">      double mag_ = convDpi / DPI;</a>
<a name="ln2662">      MScore::pixelRatio = 1.0 / mag_;</a>
<a name="ln2663"> </a>
<a name="ln2664">      QPainter p(&amp;printer);</a>
<a name="ln2665">      p.setRenderHint(QPainter::Antialiasing, true);</a>
<a name="ln2666">      p.setRenderHint(QPainter::TextAntialiasing, true);</a>
<a name="ln2667">      p.scale(mag_, mag_);</a>
<a name="ln2668">      if (localTrimMargin &gt;= 0)</a>
<a name="ln2669">            p.translate(-r.topLeft());</a>
<a name="ln2670"> </a>
<a name="ln2671">      QList&lt; Element*&gt; pel = page-&gt;elements();</a>
<a name="ln2672">      qStableSort(pel.begin(), pel.end(), elementLessThan);</a>
<a name="ln2673">      paintElements(p, pel);</a>
<a name="ln2674">       if (format == QImage::Format_Indexed8) {</a>
<a name="ln2675">            //convert to grayscale &amp; respect alpha</a>
<a name="ln2676">            QVector&lt;QRgb&gt; colorTable;</a>
<a name="ln2677">            colorTable.push_back(QColor(0, 0, 0, 0).rgba());</a>
<a name="ln2678">            if (!transparent) {</a>
<a name="ln2679">                  for (int i = 1; i &lt; 256; i++)</a>
<a name="ln2680">                        colorTable.push_back(QColor(i, i, i).rgb());</a>
<a name="ln2681">                  }</a>
<a name="ln2682">            else {</a>
<a name="ln2683">                  for (int i = 1; i &lt; 256; i++)</a>
<a name="ln2684">                        colorTable.push_back(QColor(0, 0, 0, i).rgba());</a>
<a name="ln2685">                  }</a>
<a name="ln2686">            printer = printer.convertToFormat(QImage::Format_Indexed8, colorTable);</a>
<a name="ln2687">            }</a>
<a name="ln2688">      printer.save(device, &quot;png&quot;);</a>
<a name="ln2689">      score-&gt;setPrinting(false);</a>
<a name="ln2690">      MScore::pixelRatio = pr;</a>
<a name="ln2691">      return rv;</a>
<a name="ln2692">      }</a>
<a name="ln2693"> </a>
<a name="ln2694">//---------------------------------------------------------</a>
<a name="ln2695">//   WallpaperPreview</a>
<a name="ln2696">//---------------------------------------------------------</a>
<a name="ln2697"> </a>
<a name="ln2698">WallpaperPreview::WallpaperPreview(QWidget* parent)</a>
<a name="ln2699">   : QFrame(parent)</a>
<a name="ln2700">      {</a>
<a name="ln2701">      _pixmap = 0;</a>
<a name="ln2702">      }</a>
<a name="ln2703"> </a>
<a name="ln2704">//---------------------------------------------------------</a>
<a name="ln2705">//   paintEvent</a>
<a name="ln2706">//---------------------------------------------------------</a>
<a name="ln2707"> </a>
<a name="ln2708">void WallpaperPreview::paintEvent(QPaintEvent* ev)</a>
<a name="ln2709">      {</a>
<a name="ln2710">      QPainter p(this);</a>
<a name="ln2711">      int fw = frameWidth();</a>
<a name="ln2712">      QRect r(frameRect().adjusted(fw, fw, -2*fw, -2*fw));</a>
<a name="ln2713">      if (_pixmap)</a>
<a name="ln2714">            p.drawTiledPixmap(r, *_pixmap);</a>
<a name="ln2715">      QFrame::paintEvent(ev);</a>
<a name="ln2716">      }</a>
<a name="ln2717"> </a>
<a name="ln2718">//---------------------------------------------------------</a>
<a name="ln2719">//   setImage</a>
<a name="ln2720">//---------------------------------------------------------</a>
<a name="ln2721"> </a>
<a name="ln2722">void WallpaperPreview::setImage(const QString&amp; path)</a>
<a name="ln2723">      {</a>
<a name="ln2724">      qDebug(&quot;setImage &lt;%s&gt;&quot;, qPrintable(path));</a>
<a name="ln2725">      delete _pixmap;</a>
<a name="ln2726">      _pixmap = new QPixmap(path);</a>
<a name="ln2727">      update();</a>
<a name="ln2728">      }</a>
<a name="ln2729"> </a>
<a name="ln2730">//---------------------------------------------------------</a>
<a name="ln2731">//   getWallpaper</a>
<a name="ln2732">//---------------------------------------------------------</a>
<a name="ln2733"> </a>
<a name="ln2734">QString MuseScore::getWallpaper(const QString&amp; caption)</a>
<a name="ln2735">      {</a>
<a name="ln2736">      QString filter = tr(&quot;Images&quot;) + &quot; (*.jpg *.jpeg *.png);;&quot; + tr(&quot;All&quot;) + &quot; (*)&quot;;</a>
<a name="ln2737">      QString d = mscoreGlobalShare + &quot;/wallpaper&quot;;</a>
<a name="ln2738"> </a>
<a name="ln2739">      if (preferences.getBool(PREF_UI_APP_USENATIVEDIALOGS)) {</a>
<a name="ln2740">            QString s = QFileDialog::getOpenFileName(</a>
<a name="ln2741">               this,                            // parent</a>
<a name="ln2742">               caption,</a>
<a name="ln2743">               d,</a>
<a name="ln2744">               filter</a>
<a name="ln2745">               );</a>
<a name="ln2746">            return s;</a>
<a name="ln2747">            }</a>
<a name="ln2748"> </a>
<a name="ln2749">      if (loadBackgroundDialog == 0) {</a>
<a name="ln2750">            loadBackgroundDialog = new QFileDialog(this);</a>
<a name="ln2751">            loadBackgroundDialog-&gt;setFileMode(QFileDialog::ExistingFile);</a>
<a name="ln2752">            loadBackgroundDialog-&gt;setOption(QFileDialog::DontUseNativeDialog, true);</a>
<a name="ln2753">            loadBackgroundDialog-&gt;setWindowTitle(caption);</a>
<a name="ln2754">            loadBackgroundDialog-&gt;setNameFilter(filter);</a>
<a name="ln2755">            loadBackgroundDialog-&gt;setDirectory(d);</a>
<a name="ln2756"> </a>
<a name="ln2757">            QSettings set;</a>
<a name="ln2758">            loadBackgroundDialog-&gt;restoreState(set.value(&quot;loadBackgroundDialog&quot;).toByteArray());</a>
<a name="ln2759">            loadBackgroundDialog-&gt;setAcceptMode(QFileDialog::AcceptOpen);</a>
<a name="ln2760"> </a>
<a name="ln2761">            QSplitter* sp = loadBackgroundDialog-&gt;findChild&lt;QSplitter*&gt;(&quot;splitter&quot;);</a>
<a name="ln2762">            if (sp) {</a>
<a name="ln2763">                  WallpaperPreview* preview = new WallpaperPreview;</a>
<a name="ln2764">                  sp-&gt;addWidget(preview);</a>
<a name="ln2765">                  connect(loadBackgroundDialog, SIGNAL(currentChanged(const QString&amp;)),</a>
<a name="ln2766">                     preview, SLOT(setImage(const QString&amp;)));</a>
<a name="ln2767">                  }</a>
<a name="ln2768">            }</a>
<a name="ln2769"> </a>
<a name="ln2770">      //</a>
<a name="ln2771">      // setup side bar urls</a>
<a name="ln2772">      //</a>
<a name="ln2773">      QList&lt;QUrl&gt; urls;</a>
<a name="ln2774">      QString home = QDir::homePath();</a>
<a name="ln2775">      urls.append(QUrl::fromLocalFile(d));</a>
<a name="ln2776">      urls.append(QUrl::fromLocalFile(home));</a>
<a name="ln2777">      urls.append(QUrl::fromLocalFile(QDir::currentPath()));</a>
<a name="ln2778">      loadBackgroundDialog-&gt;setSidebarUrls(urls);</a>
<a name="ln2779"> </a>
<a name="ln2780">      if (loadBackgroundDialog-&gt;exec()) {</a>
<a name="ln2781">            QStringList result = loadBackgroundDialog-&gt;selectedFiles();</a>
<a name="ln2782">            return result.front();</a>
<a name="ln2783">            }</a>
<a name="ln2784">      return QString();</a>
<a name="ln2785">      }</a>
<a name="ln2786"> </a>
<a name="ln2787">//---------------------------------------------------------</a>
<a name="ln2788">//   MuseScore::saveSvg</a>
<a name="ln2789">//---------------------------------------------------------</a>
<a name="ln2790">// [TODO:</a>
<a name="ln2791">// [In most of the functions above the Score* parameter is named &quot;cs&quot;.</a>
<a name="ln2792">// [But there is also a member variable in class MuseScoreCore called &quot;cs&quot;</a>
<a name="ln2793">// [and it too is a Score*. If the member variable exists, the functions</a>
<a name="ln2794">// [should not bother to pass it around, especially with multiple names.</a>
<a name="ln2795">// [I have continued to use the &quot;score&quot; argument in this function, but</a>
<a name="ln2796">// [I was just following the existing convention, inconsistent as it is.</a>
<a name="ln2797">// [All the class MuseScore member functions should use the member variable.</a>
<a name="ln2798">// [This file is currently undergoing a bunch of changes, and that's the kind</a>
<a name="ln2799">// [of edit that must be coordinated with the MuseScore master code base.</a>
<a name="ln2800">//</a>
<a name="ln2801">bool MuseScore::saveSvg(Score* score, const QString&amp; saveName)</a>
<a name="ln2802">      {</a>
<a name="ln2803">      const QList&lt;Page*&gt;&amp; pl = score-&gt;pages();</a>
<a name="ln2804">      int pages = pl.size();</a>
<a name="ln2805">      int padding = QString(&quot;%1&quot;).arg(pages).size();</a>
<a name="ln2806">      bool overwrite = false;</a>
<a name="ln2807">      bool noToAll = false;</a>
<a name="ln2808">      for (int pageNumber = 0; pageNumber &lt; pages; ++pageNumber) {</a>
<a name="ln2809">            QString fileName(saveName);</a>
<a name="ln2810">            if (fileName.endsWith(&quot;.svg&quot;))</a>
<a name="ln2811">                  fileName = fileName.left(fileName.size() - 4);</a>
<a name="ln2812">            fileName += QString(&quot;-%1.svg&quot;).arg(pageNumber+1, padding, 10, QLatin1Char('0'));</a>
<a name="ln2813">            if (!converterMode) {</a>
<a name="ln2814">                  QFileInfo fip(fileName);</a>
<a name="ln2815">                  if(fip.exists() &amp;&amp; !overwrite) {</a>
<a name="ln2816">                        if(noToAll)</a>
<a name="ln2817">                              continue;</a>
<a name="ln2818">                        QMessageBox msgBox( QMessageBox::Question, tr(&quot;Confirm Replace&quot;),</a>
<a name="ln2819">                              tr(&quot;\&quot;%1\&quot; already exists.\nDo you want to replace it?\n&quot;).arg(QDir::toNativeSeparators(fileName)),</a>
<a name="ln2820">                              QMessageBox::Yes |  QMessageBox::YesToAll | QMessageBox::No |  QMessageBox::NoToAll);</a>
<a name="ln2821">                        msgBox.setButtonText(QMessageBox::Yes, tr(&quot;Replace&quot;));</a>
<a name="ln2822">                        msgBox.setButtonText(QMessageBox::No, tr(&quot;Skip&quot;));</a>
<a name="ln2823">                        msgBox.setButtonText(QMessageBox::YesToAll, tr(&quot;Replace All&quot;));</a>
<a name="ln2824">                        msgBox.setButtonText(QMessageBox::NoToAll, tr(&quot;Skip All&quot;));</a>
<a name="ln2825">                        int sb = msgBox.exec();</a>
<a name="ln2826">                        if(sb == QMessageBox::YesToAll) {</a>
<a name="ln2827">                              overwrite = true;</a>
<a name="ln2828">                              }</a>
<a name="ln2829">                        else if (sb == QMessageBox::NoToAll) {</a>
<a name="ln2830">                              noToAll = true;</a>
<a name="ln2831">                              continue;</a>
<a name="ln2832">                              }</a>
<a name="ln2833">                        else if (sb == QMessageBox::No)</a>
<a name="ln2834">                              continue;</a>
<a name="ln2835">                        }</a>
<a name="ln2836">                  }</a>
<a name="ln2837">            QFile f(fileName);</a>
<a name="ln2838">            if (!f.open(QIODevice::WriteOnly))</a>
<a name="ln2839">                  return false;</a>
<a name="ln2840">            bool rv = saveSvg(score, &amp;f, pageNumber);</a>
<a name="ln2841">            if (!rv)</a>
<a name="ln2842">                  return false;</a>
<a name="ln2843">            }</a>
<a name="ln2844">      return true;</a>
<a name="ln2845">      }</a>
<a name="ln2846"> </a>
<a name="ln2847">//---------------------------------------------------------</a>
<a name="ln2848">//   MuseScore::saveSvg</a>
<a name="ln2849">///  Save a single page</a>
<a name="ln2850">//---------------------------------------------------------</a>
<a name="ln2851"> </a>
<a name="ln2852">bool MuseScore::saveSvg(Score* score, QIODevice* device, int pageNumber, bool drawPageBackground)</a>
<a name="ln2853">      {</a>
<a name="ln2854">      QString title(score-&gt;title());</a>
<a name="ln2855">      score-&gt;setPrinting(true);</a>
<a name="ln2856">      MScore::pdfPrinting = true;</a>
<a name="ln2857">      MScore::svgPrinting = true;</a>
<a name="ln2858">      const QList&lt;Page*&gt;&amp; pl = score-&gt;pages();</a>
<a name="ln2859">      int pages = pl.size();</a>
<a name="ln2860">      double pr = MScore::pixelRatio;</a>
<a name="ln2861"> </a>
<a name="ln2862">      Page* page = pl.at(pageNumber);</a>
<a name="ln2863">      SvgGenerator printer;</a>
<a name="ln2864">      printer.setTitle(pages &gt; 1 ? QString(&quot;%1 (%2)&quot;).arg(title).arg(pageNumber + 1) : title);</a>
<a name="ln2865">      printer.setOutputDevice(device);</a>
<a name="ln2866"> </a>
<a name="ln2867">      QRectF r;</a>
<a name="ln2868">      if (trimMargin &gt;= 0) {</a>
<a name="ln2869">            QMarginsF margins(trimMargin, trimMargin, trimMargin, trimMargin);</a>
<a name="ln2870">            r = page-&gt;tbbox() + margins;</a>
<a name="ln2871">            }</a>
<a name="ln2872">      else</a>
<a name="ln2873">            r = page-&gt;abbox();</a>
<a name="ln2874">      qreal w = r.width();</a>
<a name="ln2875">      qreal h = r.height();</a>
<a name="ln2876">      printer.setSize(QSize(w, h));</a>
<a name="ln2877">      printer.setViewBox(QRectF(0, 0, w, h));</a>
<a name="ln2878">      QPainter p(&amp;printer);</a>
<a name="ln2879">      p.setRenderHint(QPainter::Antialiasing, true);</a>
<a name="ln2880">      p.setRenderHint(QPainter::TextAntialiasing, true);</a>
<a name="ln2881">      if (trimMargin &gt;= 0 &amp;&amp; score-&gt;npages() == 1)</a>
<a name="ln2882">            p.translate(-r.topLeft());</a>
<a name="ln2883">      MScore::pixelRatio = DPI / printer.logicalDpiX();</a>
<a name="ln2884">      if (trimMargin &gt;= 0)</a>
<a name="ln2885">             p.translate(-r.topLeft());</a>
<a name="ln2886"> </a>
<a name="ln2887">      if (drawPageBackground)</a>
<a name="ln2888">            p.fillRect(r, Qt::white);</a>
<a name="ln2889"> </a>
<a name="ln2890">      // 1st pass: StaffLines</a>
<a name="ln2891">      for  (System* s : page-&gt;systems()) {</a>
<a name="ln2892">            for (int i = 0, n = s-&gt;staves()-&gt;size(); i &lt; n; i++) {</a>
<a name="ln2893">                  if (score-&gt;staff(i)-&gt;invisible() || !score-&gt;staff(i)-&gt;show())</a>
<a name="ln2894">                        continue;  // ignore invisible staves</a>
<a name="ln2895">                  if (s-&gt;staves()-&gt;isEmpty() || !s-&gt;staff(i)-&gt;show())</a>
<a name="ln2896">                        continue;</a>
<a name="ln2897">                  Measure* fm = s-&gt;firstMeasure();</a>
<a name="ln2898">                  if (!fm) // only boxes, hence no staff lines</a>
<a name="ln2899">                        continue;</a>
<a name="ln2900"> </a>
<a name="ln2901">                  // The goal here is to draw SVG staff lines more efficiently.</a>
<a name="ln2902">                  // MuseScore draws staff lines by measure, but for SVG they can</a>
<a name="ln2903">                  // generally be drawn once for each system. This makes a big</a>
<a name="ln2904">                  // difference for scores that scroll horizontally on a single</a>
<a name="ln2905">                  // page. But there are exceptions to this rule:</a>
<a name="ln2906">                  //</a>
<a name="ln2907">                  //   ~ One (or more) invisible measure(s) in a system/staff ~</a>
<a name="ln2908">                  //   ~ One (or more) elements of type HBOX or VBOX          ~</a>
<a name="ln2909">                  //</a>
<a name="ln2910">                  // In these cases the SVG staff lines for the system/staff</a>
<a name="ln2911">                  // are drawn by measure.</a>
<a name="ln2912">                  //</a>
<a name="ln2913">                  bool byMeasure = false;</a>
<a name="ln2914">                  for (MeasureBase* mb = fm; mb; mb = s-&gt;nextMeasure(mb)) {</a>
<a name="ln2915">                        if (!mb-&gt;isMeasure() || !toMeasure(mb)-&gt;visible(i)) {</a>
<a name="ln2916">                              byMeasure = true;</a>
<a name="ln2917">                              break;</a>
<a name="ln2918">                              }</a>
<a name="ln2919">                        }</a>
<a name="ln2920">                  if (byMeasure) { // Draw visible staff lines by measure</a>
<a name="ln2921">                        for (MeasureBase* mb = fm; mb; mb = s-&gt;nextMeasure(mb)) {</a>
<a name="ln2922">                              if (mb-&gt;isMeasure() &amp;&amp; toMeasure(mb)-&gt;visible(i)) {</a>
<a name="ln2923">                                    StaffLines* sl = toMeasure(mb)-&gt;staffLines(i);</a>
<a name="ln2924">                                    printer.setElement(sl);</a>
<a name="ln2925">                                    paintElement(p, sl);</a>
<a name="ln2926">                                    }</a>
<a name="ln2927">                              }</a>
<a name="ln2928">                        }</a>
<a name="ln2929">                  else { // Draw staff lines once per system</a>
<a name="ln2930">                        StaffLines* firstSL = s-&gt;firstMeasure()-&gt;staffLines(i)-&gt;clone();</a>
<a name="ln2931">                        StaffLines*  lastSL =  s-&gt;lastMeasure()-&gt;staffLines(i);</a>
<a name="ln2932"> </a>
<a name="ln2933">                        qreal lastX =  lastSL-&gt;bbox().right()</a>
<a name="ln2934">                                    +  lastSL-&gt;pagePos().x()</a>
<a name="ln2935">                                    - firstSL-&gt;pagePos().x();</a>
<a name="ln2936">                        QVector&lt;QLineF&gt;&amp; lines = firstSL-&gt;getLines();</a>
<a name="ln2937">                        for (int l = 0, c = lines.size(); l &lt; c; l++)</a>
<a name="ln2938">                              lines[l].setP2(QPointF(lastX, lines[l].p2().y()));</a>
<a name="ln2939"> </a>
<a name="ln2940">                        printer.setElement(firstSL);</a>
<a name="ln2941">                        paintElement(p, firstSL);</a>
<a name="ln2942">                        }</a>
<a name="ln2943">                  }</a>
<a name="ln2944">            }</a>
<a name="ln2945">      // 2nd pass: the rest of the elements</a>
<a name="ln2946">      QList&lt;Element*&gt; pel = page-&gt;elements();</a>
<a name="ln2947">      qStableSort(pel.begin(), pel.end(), elementLessThan);</a>
<a name="ln2948">      ElementType eType;</a>
<a name="ln2949">      for (const Element* e : pel) {</a>
<a name="ln2950">            // Always exclude invisible elements</a>
<a name="ln2951">            if (!e-&gt;visible())</a>
<a name="ln2952">                  continue;</a>
<a name="ln2953"> </a>
<a name="ln2954">            eType = e-&gt;type();</a>
<a name="ln2955">            switch (eType) { // In future sub-type code, this switch() grows, and eType gets used</a>
<a name="ln2956">            case ElementType::STAFF_LINES : // Handled in the 1st pass above</a>
<a name="ln2957">                  continue; // Exclude from 2nd pass</a>
<a name="ln2958">                  break;</a>
<a name="ln2959">            default:</a>
<a name="ln2960">                  break;</a>
<a name="ln2961">            } // switch(eType)</a>
<a name="ln2962"> </a>
<a name="ln2963">            // Set the Element pointer inside SvgGenerator/SvgPaintEngine</a>
<a name="ln2964">            printer.setElement(e);</a>
<a name="ln2965"> </a>
<a name="ln2966">            // Paint it</a>
<a name="ln2967">            paintElement(p, e);</a>
<a name="ln2968">            }</a>
<a name="ln2969">      p.end(); // Writes MuseScore SVG file to disk, finally</a>
<a name="ln2970"> </a>
<a name="ln2971">      // Clean up and return</a>
<a name="ln2972">      MScore::pixelRatio = pr;</a>
<a name="ln2973">      score-&gt;setPrinting(false);</a>
<a name="ln2974">      MScore::pdfPrinting = false;</a>
<a name="ln2975">      MScore::svgPrinting = false;</a>
<a name="ln2976">      return true;</a>
<a name="ln2977">      }</a>
<a name="ln2978"> </a>
<a name="ln2979">//---------------------------------------------------------</a>
<a name="ln2980">//   createThumbnail</a>
<a name="ln2981">//---------------------------------------------------------</a>
<a name="ln2982"> </a>
<a name="ln2983">static QPixmap createThumbnail(const QString&amp; name)</a>
<a name="ln2984">      {</a>
<a name="ln2985">      if (!(name.endsWith(&quot;.mscx&quot;) || name.endsWith(&quot;.mscz&quot;)))</a>
<a name="ln2986">            return QPixmap();</a>
<a name="ln2987">      MasterScore* score = new MasterScore(MScore::defaultStyle());</a>
<a name="ln2988">      Score::FileError error = readScore(score, name, true);</a>
<a name="ln2989">      if (error != Score::FileError::FILE_NO_ERROR || !score-&gt;firstMeasure()) {</a>
<a name="ln2990">            delete score;</a>
<a name="ln2991">            return QPixmap();</a>
<a name="ln2992">            }</a>
<a name="ln2993">      score-&gt;doLayout();</a>
<a name="ln2994">      QImage pm = score-&gt;createThumbnail();</a>
<a name="ln2995">      delete score;</a>
<a name="ln2996">      return QPixmap::fromImage(pm);</a>
<a name="ln2997">      }</a>
<a name="ln2998"> </a>
<a name="ln2999">//---------------------------------------------------------</a>
<a name="ln3000">//   extractThumbnail</a>
<a name="ln3001">//---------------------------------------------------------</a>
<a name="ln3002"> </a>
<a name="ln3003">QPixmap MuseScore::extractThumbnail(const QString&amp; name)</a>
<a name="ln3004">      {</a>
<a name="ln3005">      QPixmap pm; //  = icons[File_ICON].pixmap(QSize(100,140));</a>
<a name="ln3006">      if (!name.endsWith(&quot;.mscz&quot;))</a>
<a name="ln3007">            return createThumbnail(name);</a>
<a name="ln3008">      MQZipReader uz(name);</a>
<a name="ln3009">      if (!uz.exists()) {</a>
<a name="ln3010">            qDebug(&quot;extractThumbnail: &lt;%s&gt; not found&quot;, qPrintable(name));</a>
<a name="ln3011">            return pm;</a>
<a name="ln3012">            }</a>
<a name="ln3013">      QByteArray ba = uz.fileData(&quot;Thumbnails/thumbnail.png&quot;);</a>
<a name="ln3014">      if (ba.isEmpty())</a>
<a name="ln3015">            return createThumbnail(name);</a>
<a name="ln3016">      pm.loadFromData(ba, &quot;PNG&quot;);</a>
<a name="ln3017">      return pm;</a>
<a name="ln3018">      }</a>
<a name="ln3019"> </a>
<a name="ln3020">//---------------------------------------------------------</a>
<a name="ln3021">//   saveMetadataJSON</a>
<a name="ln3022">//---------------------------------------------------------</a>
<a name="ln3023"> </a>
<a name="ln3024">bool MuseScore::saveMetadataJSON(Score* score, const QString&amp; name)</a>
<a name="ln3025">      {</a>
<a name="ln3026">      QFile f(name);</a>
<a name="ln3027">      if (!f.open(QIODevice::WriteOnly))</a>
<a name="ln3028">            return false;</a>
<a name="ln3029"> </a>
<a name="ln3030">      QJsonObject json = saveMetadataJSON(score);</a>
<a name="ln3031">      QJsonDocument saveDoc(json);</a>
<a name="ln3032">      f.write(saveDoc.toJson());</a>
<a name="ln3033">      f.close();</a>
<a name="ln3034">      return true;</a>
<a name="ln3035">      }</a>
<a name="ln3036"> </a>
<a name="ln3037">//---------------------------------------------------------</a>
<a name="ln3038">//   findTextByType</a>
<a name="ln3039">//    @data must contain std::pair&lt;Tid, QStringList*&gt;*</a>
<a name="ln3040">//          Tid specifies text style</a>
<a name="ln3041">//          QStringList* specifies the container to keep found text</a>
<a name="ln3042">//</a>
<a name="ln3043">//    For usage with Score::scanElements().</a>
<a name="ln3044">//    Finds all text elements with specified style.</a>
<a name="ln3045">//---------------------------------------------------------</a>
<a name="ln3046">static void findTextByType(void* data, Element* element)</a>
<a name="ln3047">      {</a>
<a name="ln3048">      if (!element-&gt;isTextBase())</a>
<a name="ln3049">            return;</a>
<a name="ln3050">      TextBase* text = toTextBase(element);</a>
<a name="ln3051">      auto* typeStringsData = static_cast&lt;std::pair&lt;Tid, QStringList*&gt;*&gt;(data);</a>
<a name="ln3052">      if (text-&gt;tid() == typeStringsData-&gt;first) {</a>
<a name="ln3053">            // or if score-&gt;getTextStyleUserName().contains(&quot;Title&quot;) ???</a>
<a name="ln3054">            // That is bad since it may be localized</a>
<a name="ln3055">            QStringList* titleStrings = typeStringsData-&gt;second;</a>
<a name="ln3056">            Q_ASSERT(titleStrings);</a>
<a name="ln3057">            titleStrings-&gt;append(text-&gt;plainText());</a>
<a name="ln3058">            }</a>
<a name="ln3059">      }</a>
<a name="ln3060"> </a>
<a name="ln3061">QJsonObject MuseScore::saveMetadataJSON(Score* score)</a>
<a name="ln3062">      {</a>
<a name="ln3063">      auto boolToString = [](bool b) { return b ? &quot;true&quot; : &quot;false&quot;; };</a>
<a name="ln3064">      QJsonObject json;</a>
<a name="ln3065"> </a>
<a name="ln3066">      // title</a>
<a name="ln3067">      QString title;</a>
<a name="ln3068">      Text* t = score-&gt;getText(Tid::TITLE);</a>
<a name="ln3069">      if (t)</a>
<a name="ln3070">            title = t-&gt;plainText();</a>
<a name="ln3071">      if (title.isEmpty())</a>
<a name="ln3072">            title = score-&gt;metaTag(&quot;workTitle&quot;);</a>
<a name="ln3073">      if (title.isEmpty())</a>
<a name="ln3074">            title = score-&gt;title();</a>
<a name="ln3075">      json.insert(&quot;title&quot;, title);</a>
<a name="ln3076"> </a>
<a name="ln3077">      // subtitle</a>
<a name="ln3078">      QString subtitle;</a>
<a name="ln3079">      t = score-&gt;getText(Tid::SUBTITLE);</a>
<a name="ln3080">      if (t)</a>
<a name="ln3081">            subtitle = t-&gt;plainText();</a>
<a name="ln3082">      json.insert(&quot;subtitle&quot;, subtitle);</a>
<a name="ln3083"> </a>
<a name="ln3084">      // composer</a>
<a name="ln3085">      QString composer;</a>
<a name="ln3086">      t = score-&gt;getText(Tid::COMPOSER);</a>
<a name="ln3087">      if (t)</a>
<a name="ln3088">            composer = t-&gt;plainText();</a>
<a name="ln3089">      if (composer.isEmpty())</a>
<a name="ln3090">            composer = score-&gt;metaTag(&quot;composer&quot;);</a>
<a name="ln3091">      json.insert(&quot;composer&quot;, composer);</a>
<a name="ln3092"> </a>
<a name="ln3093">      // poet</a>
<a name="ln3094">      QString poet;</a>
<a name="ln3095">      t = score-&gt;getText(Tid::POET);</a>
<a name="ln3096">      if (t)</a>
<a name="ln3097">            poet = t-&gt;plainText();</a>
<a name="ln3098">      if (poet.isEmpty())</a>
<a name="ln3099">            poet = score-&gt;metaTag(&quot;lyricist&quot;);</a>
<a name="ln3100">      json.insert(&quot;poet&quot;, poet);</a>
<a name="ln3101"> </a>
<a name="ln3102">      json.insert(&quot;mscoreVersion&quot;, score-&gt;mscoreVersion());</a>
<a name="ln3103">      json.insert(&quot;fileVersion&quot;, score-&gt;mscVersion());</a>
<a name="ln3104"> </a>
<a name="ln3105">      json.insert(&quot;pages&quot;, score-&gt;npages());</a>
<a name="ln3106">      json.insert(&quot;measures&quot;, score-&gt;nmeasures());</a>
<a name="ln3107">      json.insert(&quot;hasLyrics&quot;, boolToString(score-&gt;hasLyrics()));</a>
<a name="ln3108">      json.insert(&quot;hasHarmonies&quot;, boolToString(score-&gt;hasHarmonies()));</a>
<a name="ln3109">      json.insert(&quot;keysig&quot;, score-&gt;keysig());</a>
<a name="ln3110"> </a>
<a name="ln3111">      // timeSig</a>
<a name="ln3112">      QString timeSig;</a>
<a name="ln3113">      int staves = score-&gt;nstaves();</a>
<a name="ln3114">      int tracks = staves * VOICES;</a>
<a name="ln3115">      Segment* tss = score-&gt;firstSegmentMM(SegmentType::TimeSig);</a>
<a name="ln3116">      if (tss) {</a>
<a name="ln3117">            Element* e = nullptr;</a>
<a name="ln3118">            for (int track = 0; track &lt; tracks; ++track) {</a>
<a name="ln3119">                  e = tss-&gt;element(track);</a>
<a name="ln3120">                  if (e) break;</a>
<a name="ln3121">                  }</a>
<a name="ln3122">            if (e &amp;&amp; e-&gt;isTimeSig()) {</a>
<a name="ln3123">                  TimeSig* ts = toTimeSig(e);</a>
<a name="ln3124">                  timeSig = QString(&quot;%1/%2&quot;).arg(ts-&gt;numerator()).arg(ts-&gt;denominator());</a>
<a name="ln3125">                  }</a>
<a name="ln3126">            }</a>
<a name="ln3127">      json.insert(&quot;timesig&quot;, timeSig);</a>
<a name="ln3128"> </a>
<a name="ln3129">      json.insert(&quot;duration&quot;, score-&gt;duration());</a>
<a name="ln3130">      json.insert(&quot;lyrics&quot;, score-&gt;extractLyrics());</a>
<a name="ln3131"> </a>
<a name="ln3132">      // tempo</a>
<a name="ln3133">       int tempo = 0;</a>
<a name="ln3134">       QString tempoText;</a>
<a name="ln3135">       for (Segment* seg = score-&gt;firstSegmentMM(SegmentType::All); seg; seg = seg-&gt;next1MM()) {</a>
<a name="ln3136">             auto annotations = seg-&gt;annotations();</a>
<a name="ln3137">             for (Element* a : annotations) {</a>
<a name="ln3138">                   if (a &amp;&amp; a-&gt;isTempoText()) {</a>
<a name="ln3139">                         TempoText* tt = toTempoText(a);</a>
<a name="ln3140">                         tempo = round(tt-&gt;tempo() * 60);</a>
<a name="ln3141">                         tempoText = tt-&gt;xmlText();</a>
<a name="ln3142">                         }</a>
<a name="ln3143">                   }</a>
<a name="ln3144">             }</a>
<a name="ln3145">      json.insert(&quot;tempo&quot;, tempo);</a>
<a name="ln3146">      json.insert(&quot;tempoText&quot;, tempoText);</a>
<a name="ln3147"> </a>
<a name="ln3148">      // parts</a>
<a name="ln3149">      QJsonArray jsonPartsArray;</a>
<a name="ln3150">      for (Part* p : score-&gt;parts()) {</a>
<a name="ln3151">            QJsonObject jsonPart;</a>
<a name="ln3152">            jsonPart.insert(&quot;name&quot;, p-&gt;longName().replace(&quot;\n&quot;, &quot;&quot;));</a>
<a name="ln3153">            int midiProgram = p-&gt;midiProgram();</a>
<a name="ln3154">            if (p-&gt;midiChannel() == 9)</a>
<a name="ln3155">                midiProgram = 128;</a>
<a name="ln3156">            jsonPart.insert(&quot;program&quot;, midiProgram);</a>
<a name="ln3157">            jsonPart.insert(&quot;instrumentId&quot;, p-&gt;instrumentId());</a>
<a name="ln3158">            jsonPart.insert(&quot;lyricCount&quot;, p-&gt;lyricCount());</a>
<a name="ln3159">            jsonPart.insert(&quot;harmonyCount&quot;, p-&gt;harmonyCount());</a>
<a name="ln3160">            jsonPart.insert(&quot;hasPitchedStaff&quot;, boolToString(p-&gt;hasPitchedStaff()));</a>
<a name="ln3161">            jsonPart.insert(&quot;hasTabStaff&quot;, boolToString(p-&gt;hasTabStaff()));</a>
<a name="ln3162">            jsonPart.insert(&quot;hasDrumStaff&quot;, boolToString(p-&gt;hasDrumStaff()));</a>
<a name="ln3163">            jsonPart.insert(&quot;isVisible&quot;, boolToString(p-&gt;show()));</a>
<a name="ln3164">            jsonPartsArray.append(jsonPart);</a>
<a name="ln3165">            }</a>
<a name="ln3166">      json.insert(&quot;parts&quot;, jsonPartsArray);</a>
<a name="ln3167"> </a>
<a name="ln3168">      // pageFormat</a>
<a name="ln3169">      QJsonObject jsonPageformat;</a>
<a name="ln3170">      jsonPageformat.insert(&quot;height&quot;,round(score-&gt;styleD(Sid::pageHeight) * INCH));</a>
<a name="ln3171">      jsonPageformat.insert(&quot;width&quot;, round(score-&gt;styleD(Sid::pageWidth) * INCH));</a>
<a name="ln3172">      jsonPageformat.insert(&quot;twosided&quot;, boolToString(score-&gt;styleB(Sid::pageTwosided)));</a>
<a name="ln3173">      json.insert(&quot;pageFormat&quot;, jsonPageformat);</a>
<a name="ln3174"> </a>
<a name="ln3175">      //text frames metadata</a>
<a name="ln3176">      QJsonObject jsonTypeData;</a>
<a name="ln3177">      static std::vector&lt;std::pair&lt;QString, Tid&gt;&gt; namesTypesList {</a>
<a name="ln3178">            {&quot;titles&quot;, Tid::TITLE},</a>
<a name="ln3179">            {&quot;subtitles&quot;, Tid::SUBTITLE},</a>
<a name="ln3180">            {&quot;composers&quot;, Tid::COMPOSER},</a>
<a name="ln3181">            {&quot;poets&quot;, Tid::POET}</a>
<a name="ln3182">            };</a>
<a name="ln3183">      for (auto nameType : namesTypesList) {</a>
<a name="ln3184">            QJsonArray typeData;</a>
<a name="ln3185">            QStringList typeTextStrings;</a>
<a name="ln3186">            std::pair&lt;Tid, QStringList*&gt; extendedTitleData = std::make_pair(nameType.second, &amp;typeTextStrings);</a>
<a name="ln3187">            score-&gt;scanElements(&amp;extendedTitleData, findTextByType);</a>
<a name="ln3188">            for (auto typeStr : typeTextStrings)</a>
<a name="ln3189">                  typeData.append(typeStr);</a>
<a name="ln3190">            jsonTypeData.insert(nameType.first, typeData);</a>
<a name="ln3191">            }</a>
<a name="ln3192">      json.insert(&quot;textFramesData&quot;, jsonTypeData);</a>
<a name="ln3193"> </a>
<a name="ln3194">      return json;</a>
<a name="ln3195">      }</a>
<a name="ln3196"> </a>
<a name="ln3197">class CustomJsonWriter</a>
<a name="ln3198">{</a>
<a name="ln3199">public:</a>
<a name="ln3200">      CustomJsonWriter(const QString&amp; filePath)</a>
<a name="ln3201">      {</a>
<a name="ln3202">      jsonFormatFile.setFileName(filePath);</a>
<a name="ln3203">      jsonFormatFile.open(QIODevice::WriteOnly);</a>
<a name="ln3204">      jsonFormatFile.write(&quot;{\n&quot;);</a>
<a name="ln3205">      }</a>
<a name="ln3206"> </a>
<a name="ln3207">      ~CustomJsonWriter()</a>
<a name="ln3208">      {</a>
<a name="ln3209">      jsonFormatFile.write(&quot;\n}\n&quot;);</a>
<a name="ln3210">      jsonFormatFile.close();</a>
<a name="ln3211">      }</a>
<a name="ln3212"> </a>
<a name="ln3213">      void addKey(const char* arrayName)</a>
<a name="ln3214">      {</a>
<a name="ln3215">      jsonFormatFile.write(&quot;\&quot;&quot;);</a>
<a name="ln3216">      jsonFormatFile.write(arrayName);</a>
<a name="ln3217">      jsonFormatFile.write(&quot;\&quot;: &quot;);</a>
<a name="ln3218">      }</a>
<a name="ln3219"> </a>
<a name="ln3220">      void addValue(const QByteArray&amp; data, bool lastJsonElement = false, bool isJson = false)</a>
<a name="ln3221">      {</a>
<a name="ln3222">      if (!isJson)</a>
<a name="ln3223">            jsonFormatFile.write(&quot;\&quot;&quot;);</a>
<a name="ln3224">      jsonFormatFile.write(data);</a>
<a name="ln3225">      if (!isJson)</a>
<a name="ln3226">            jsonFormatFile.write(&quot;\&quot;&quot;);</a>
<a name="ln3227">      if (!lastJsonElement)</a>
<a name="ln3228">            jsonFormatFile.write(&quot;,\n&quot;);</a>
<a name="ln3229">      }</a>
<a name="ln3230"> </a>
<a name="ln3231">      void openArray()</a>
<a name="ln3232">      {</a>
<a name="ln3233">      jsonFormatFile.write(&quot; [&quot;);</a>
<a name="ln3234">      }</a>
<a name="ln3235"> </a>
<a name="ln3236">      void closeArray(bool lastJsonElement = false)</a>
<a name="ln3237">      {</a>
<a name="ln3238">      jsonFormatFile.write(&quot;]&quot;);</a>
<a name="ln3239">      if (!lastJsonElement)</a>
<a name="ln3240">            jsonFormatFile.write(&quot;,&quot;);</a>
<a name="ln3241">      jsonFormatFile.write(&quot;\n&quot;);</a>
<a name="ln3242">      }</a>
<a name="ln3243"> </a>
<a name="ln3244">private:</a>
<a name="ln3245">      QFile jsonFormatFile;</a>
<a name="ln3246">};</a>
<a name="ln3247"> </a>
<a name="ln3248">//---------------------------------------------------------</a>
<a name="ln3249">//   exportMp3AsJSON</a>
<a name="ln3250">//---------------------------------------------------------</a>
<a name="ln3251"> </a>
<a name="ln3252">bool MuseScore::exportMp3AsJSON(const QString&amp; inFilePath, const QString&amp; outFilePath)</a>
<a name="ln3253">      {</a>
<a name="ln3254">      std::unique_ptr&lt;MasterScore&gt; score(mscore-&gt;readScore(inFilePath));</a>
<a name="ln3255">      if (!score)</a>
<a name="ln3256">            return false;</a>
<a name="ln3257"> </a>
<a name="ln3258">      CustomJsonWriter jsonWriter(outFilePath);</a>
<a name="ln3259">      jsonWriter.addKey(&quot;mp3&quot;);</a>
<a name="ln3260">      //export score audio</a>
<a name="ln3261">      QByteArray mp3Data;</a>
<a name="ln3262">      QBuffer mp3Device(&amp;mp3Data);</a>
<a name="ln3263">      mp3Device.open(QIODevice::ReadWrite);</a>
<a name="ln3264">      bool dummy = false;</a>
<a name="ln3265">      mscore-&gt;saveMp3(score.get(), &amp;mp3Device, dummy);</a>
<a name="ln3266">      jsonWriter.addValue(mp3Data.toBase64(), true);</a>
<a name="ln3267">      return true;</a>
<a name="ln3268">      }</a>
<a name="ln3269"> </a>
<a name="ln3270">QByteArray MuseScore::exportPdfAsJSON(Score* score)</a>
<a name="ln3271">      {</a>
<a name="ln3272">      QPrinter printer;</a>
<a name="ln3273">      auto tempPdfFileName = &quot;/tmp/MUTempPdf.pdf&quot;;</a>
<a name="ln3274">      printer.setOutputFileName(tempPdfFileName);</a>
<a name="ln3275">      mscore-&gt;savePdf(score, printer);</a>
<a name="ln3276">      QFile tempPdfFile(tempPdfFileName);</a>
<a name="ln3277">      QByteArray pdfData;</a>
<a name="ln3278">      if (tempPdfFile.open(QIODevice::ReadWrite)) {</a>
<a name="ln3279">            pdfData = tempPdfFile.readAll();</a>
<a name="ln3280">            tempPdfFile.close();</a>
<a name="ln3281">            tempPdfFile.remove();</a>
<a name="ln3282">            }</a>
<a name="ln3283"> </a>
<a name="ln3284">      return pdfData.toBase64();</a>
<a name="ln3285">      }</a>
<a name="ln3286"> </a>
<a name="ln3287">//---------------------------------------------------------</a>
<a name="ln3288">//   exportAllMediaFiles</a>
<a name="ln3289">//---------------------------------------------------------</a>
<a name="ln3290"> </a>
<a name="ln3291">bool MuseScore::exportAllMediaFiles(const QString&amp; inFilePath, const QString&amp; outFilePath)</a>
<a name="ln3292">      {</a>
<a name="ln3293">      std::unique_ptr&lt;MasterScore&gt; score(mscore-&gt;readScore(inFilePath));</a>
<a name="ln3294">      if (!score)</a>
<a name="ln3295">            return false;</a>
<a name="ln3296"> </a>
<a name="ln3297">      score-&gt;switchToPageMode();</a>
<a name="ln3298"> </a>
<a name="ln3299">      //// JSON specification ///////////////////////////</a>
<a name="ln3300">      //jsonForMedia[&quot;pngs&quot;] = pngsJsonArray;</a>
<a name="ln3301">      //jsonForMedia[&quot;mposXML&quot;] = mposJson;</a>
<a name="ln3302">      //jsonForMedia[&quot;sposXML&quot;] = sposJson;</a>
<a name="ln3303">      //jsonForMedia[&quot;pdf&quot;] = pdfJson;</a>
<a name="ln3304">      //jsonForMedia[&quot;svgs&quot;] = svgsJsonArray;</a>
<a name="ln3305">      //jsonForMedia[&quot;midi&quot;] = midiJson;</a>
<a name="ln3306">      //jsonForMedia[&quot;mxml&quot;] = mxmlJson;</a>
<a name="ln3307">      //jsonForMedia[&quot;metadata&quot;] = mdJson;</a>
<a name="ln3308">      ///////////////////////////////////////////////////</a>
<a name="ln3309"> </a>
<a name="ln3310">      bool res = true;</a>
<a name="ln3311">      CustomJsonWriter jsonWriter(outFilePath);</a>
<a name="ln3312">      //export score pngs and svgs</a>
<a name="ln3313">      jsonWriter.addKey(&quot;pngs&quot;);</a>
<a name="ln3314">      jsonWriter.openArray();</a>
<a name="ln3315">      for (int i = 0; i &lt; score-&gt;pages().size(); ++i) {</a>
<a name="ln3316">            QByteArray pngData;</a>
<a name="ln3317">            QBuffer pngDevice(&amp;pngData);</a>
<a name="ln3318">            pngDevice.open(QIODevice::ReadWrite);</a>
<a name="ln3319">            res &amp;= mscore-&gt;savePng(score.get(), &amp;pngDevice, i, /* drawPageBackground */ true);</a>
<a name="ln3320">            bool lastArrayValue = ((score-&gt;pages().size() - 1) == i);</a>
<a name="ln3321">            jsonWriter.addValue(pngData.toBase64(), lastArrayValue);</a>
<a name="ln3322">            }</a>
<a name="ln3323">      jsonWriter.closeArray();</a>
<a name="ln3324"> </a>
<a name="ln3325">      jsonWriter.addKey(&quot;svgs&quot;);</a>
<a name="ln3326">      jsonWriter.openArray();</a>
<a name="ln3327">      for (int i = 0; i &lt; score-&gt;pages().size(); ++i) {</a>
<a name="ln3328">            QByteArray svgData;</a>
<a name="ln3329">            QBuffer svgDevice(&amp;svgData);</a>
<a name="ln3330">            svgDevice.open(QIODevice::ReadWrite);</a>
<a name="ln3331">            res &amp;= mscore-&gt;saveSvg(score.get(), &amp;svgDevice, i, /* drawPageBackground */ true);</a>
<a name="ln3332">            bool lastArrayValue = ((score-&gt;pages().size() - 1) == i);</a>
<a name="ln3333">            jsonWriter.addValue(svgData.toBase64(), lastArrayValue);</a>
<a name="ln3334">            }</a>
<a name="ln3335">      jsonWriter.closeArray();</a>
<a name="ln3336"> </a>
<a name="ln3337">      {</a>
<a name="ln3338">      //export score .spos</a>
<a name="ln3339">      QByteArray partDataPos;</a>
<a name="ln3340">      QBuffer partPosDevice(&amp;partDataPos);</a>
<a name="ln3341">      partPosDevice.open(QIODevice::ReadWrite);</a>
<a name="ln3342">      savePositions(score.get(), &amp;partPosDevice, true);</a>
<a name="ln3343">      jsonWriter.addKey(&quot;sposXML&quot;);</a>
<a name="ln3344">      jsonWriter.addValue(partDataPos.toBase64());</a>
<a name="ln3345">      partPosDevice.close();</a>
<a name="ln3346">      partDataPos.clear();</a>
<a name="ln3347"> </a>
<a name="ln3348">      //export score .mpos</a>
<a name="ln3349">      partPosDevice.open(QIODevice::ReadWrite);</a>
<a name="ln3350">      savePositions(score.get(), &amp;partPosDevice, false);</a>
<a name="ln3351">      jsonWriter.addKey(&quot;mposXML&quot;);</a>
<a name="ln3352">      jsonWriter.addValue(partDataPos.toBase64());</a>
<a name="ln3353">      }</a>
<a name="ln3354"> </a>
<a name="ln3355">      //export score pdf</a>
<a name="ln3356">      jsonWriter.addKey(&quot;pdf&quot;);</a>
<a name="ln3357">      jsonWriter.addValue(exportPdfAsJSON(score.get()));</a>
<a name="ln3358"> </a>
<a name="ln3359">      {</a>
<a name="ln3360">      //export score midi</a>
<a name="ln3361">      QByteArray midiData;</a>
<a name="ln3362">      QBuffer midiDevice(&amp;midiData);</a>
<a name="ln3363">      midiDevice.open(QIODevice::ReadWrite);</a>
<a name="ln3364">      res &amp;= mscore-&gt;saveMidi(score.get(), &amp;midiDevice);</a>
<a name="ln3365">      jsonWriter.addKey(&quot;midi&quot;);</a>
<a name="ln3366">      jsonWriter.addValue(midiData.toBase64());</a>
<a name="ln3367">      }</a>
<a name="ln3368"> </a>
<a name="ln3369">      {</a>
<a name="ln3370">      //export musicxml</a>
<a name="ln3371">      QByteArray mxmlData;</a>
<a name="ln3372">      QBuffer mxmlDevice(&amp;mxmlData);</a>
<a name="ln3373">      mxmlDevice.open(QIODevice::ReadWrite);</a>
<a name="ln3374">      res &amp;= saveMxl(score.get(), &amp;mxmlDevice);</a>
<a name="ln3375">      jsonWriter.addKey(&quot;mxml&quot;);</a>
<a name="ln3376">      jsonWriter.addValue(mxmlData.toBase64());</a>
<a name="ln3377">      }</a>
<a name="ln3378"> </a>
<a name="ln3379">      //export metadata</a>
<a name="ln3380">      QJsonDocument doc(mscore-&gt;saveMetadataJSON(score.get()));</a>
<a name="ln3381">      jsonWriter.addKey(&quot;metadata&quot;);</a>
<a name="ln3382">      jsonWriter.addValue(doc.toJson(QJsonDocument::Compact), true, true);</a>
<a name="ln3383"> </a>
<a name="ln3384">      return res;</a>
<a name="ln3385">      }</a>
<a name="ln3386"> </a>
<a name="ln3387">//---------------------------------------------------------</a>
<a name="ln3388">//   exportScoreMetadata</a>
<a name="ln3389">//---------------------------------------------------------</a>
<a name="ln3390"> </a>
<a name="ln3391">bool MuseScore::exportScoreMetadata(const QString&amp; inFilePath, const QString&amp; outFilePath)</a>
<a name="ln3392">      {</a>
<a name="ln3393">      std::unique_ptr&lt;MasterScore&gt; score(mscore-&gt;readScore(inFilePath));</a>
<a name="ln3394">      if (!score)</a>
<a name="ln3395">            return false;</a>
<a name="ln3396"> </a>
<a name="ln3397">      score-&gt;switchToPageMode();</a>
<a name="ln3398"> </a>
<a name="ln3399">      //// JSON specification ///////////////////////////</a>
<a name="ln3400">      //jsonForMedia[&quot;metadata&quot;] = mdJson;</a>
<a name="ln3401">      ///////////////////////////////////////////////////</a>
<a name="ln3402"> </a>
<a name="ln3403">      CustomJsonWriter jsonWriter(outFilePath);</a>
<a name="ln3404"> </a>
<a name="ln3405">      //export metadata</a>
<a name="ln3406">      QJsonDocument doc(mscore-&gt;saveMetadataJSON(score.get()));</a>
<a name="ln3407">      jsonWriter.addKey(&quot;metadata&quot;);</a>
<a name="ln3408">      jsonWriter.addValue(doc.toJson(QJsonDocument::Compact), true, true);</a>
<a name="ln3409"> </a>
<a name="ln3410">      return true;</a>
<a name="ln3411">      }</a>
<a name="ln3412"> </a>
<a name="ln3413">//---------------------------------------------------------</a>
<a name="ln3414">//   exportTransposedScoreToJSON</a>
<a name="ln3415">//---------------------------------------------------------</a>
<a name="ln3416"> </a>
<a name="ln3417">bool MuseScore::exportTransposedScoreToJSON(const QString&amp; inFilePath, const QString&amp; transposeOptions, const QString&amp; outFilePath)</a>
<a name="ln3418">      {</a>
<a name="ln3419">      QJsonDocument doc = QJsonDocument::fromJson(transposeOptions.toUtf8());</a>
<a name="ln3420">      if (!doc.isObject()) {</a>
<a name="ln3421">            qCritical(&quot;Transpose options JSON is not an object: %s&quot;, qUtf8Printable(transposeOptions));</a>
<a name="ln3422">            return false;</a>
<a name="ln3423">            }</a>
<a name="ln3424"> </a>
<a name="ln3425">      QJsonObject options = doc.object();</a>
<a name="ln3426"> </a>
<a name="ln3427">      TransposeMode mode;</a>
<a name="ln3428">      const QString modeName = options[&quot;mode&quot;].toString();</a>
<a name="ln3429">      if (modeName == &quot;by_key&quot;)</a>
<a name="ln3430">            mode = TransposeMode::BY_KEY;</a>
<a name="ln3431">      else if (modeName == &quot;by_interval&quot;)</a>
<a name="ln3432">            mode = TransposeMode::BY_INTERVAL;</a>
<a name="ln3433">      else if (modeName == &quot;diatonically&quot;)</a>
<a name="ln3434">            mode = TransposeMode::DIATONICALLY;</a>
<a name="ln3435">      else {</a>
<a name="ln3436">            qCritical(&quot;Transpose: invalid \&quot;mode\&quot; option: %s&quot;, qUtf8Printable(modeName));</a>
<a name="ln3437">            return false;</a>
<a name="ln3438">            }</a>
<a name="ln3439"> </a>
<a name="ln3440">      TransposeDirection direction;</a>
<a name="ln3441">      const QString directionName = options[&quot;direction&quot;].toString();</a>
<a name="ln3442">      if (directionName == &quot;up&quot;)</a>
<a name="ln3443">            direction = TransposeDirection::UP;</a>
<a name="ln3444">      else if (directionName == &quot;down&quot;)</a>
<a name="ln3445">            direction = TransposeDirection::DOWN;</a>
<a name="ln3446">      else if (directionName == &quot;closest&quot;)</a>
<a name="ln3447">            direction = TransposeDirection::CLOSEST;</a>
<a name="ln3448">      else {</a>
<a name="ln3449">            qCritical(&quot;Transpose: invalid \&quot;direction\&quot; option: %s&quot;, qUtf8Printable(directionName));</a>
<a name="ln3450">            return false;</a>
<a name="ln3451">            }</a>
<a name="ln3452"> </a>
<a name="ln3453">      constexpr int defaultKey = int(Key::INVALID);</a>
<a name="ln3454">      const Key targetKey = Key(options[&quot;targetKey&quot;].toInt(defaultKey));</a>
<a name="ln3455">      if (mode == TransposeMode::BY_KEY) {</a>
<a name="ln3456">            const bool targetKeyValid = int(Key::MIN) &lt;= int(targetKey) &amp;&amp; int(targetKey) &lt;= int(Key::MAX);</a>
<a name="ln3457">            if (!targetKeyValid) {</a>
<a name="ln3458">                  qCritical(&quot;Transpose: invalid targetKey: %d&quot;, int(targetKey));</a>
<a name="ln3459">                  return false;</a>
<a name="ln3460">                  }</a>
<a name="ln3461">            }</a>
<a name="ln3462"> </a>
<a name="ln3463">      const int transposeInterval = options[&quot;transposeInterval&quot;].toInt(-1);</a>
<a name="ln3464">      if (mode != TransposeMode::BY_KEY) {</a>
<a name="ln3465">            const bool transposeIntervalValid = -1 &lt; transposeInterval &amp;&amp; transposeInterval &lt; intervalListSize;</a>
<a name="ln3466">            if (!transposeIntervalValid) {</a>
<a name="ln3467">                  qCritical(&quot;Transpose: invalid transposeInterval: %d&quot;, transposeInterval);</a>
<a name="ln3468">                  return false;</a>
<a name="ln3469">                  }</a>
<a name="ln3470">            }</a>
<a name="ln3471"> </a>
<a name="ln3472">      const bool transposeKeySignatures = options[&quot;transposeKeySignatures&quot;].toBool();</a>
<a name="ln3473">      const bool transposeChordNames = options[&quot;transposeChordNames&quot;].toBool();</a>
<a name="ln3474">      const bool useDoubleSharpsFlats = options[&quot;useDoubleSharpsFlats&quot;].toBool();</a>
<a name="ln3475"> </a>
<a name="ln3476">      std::unique_ptr&lt;MasterScore&gt; score(mscore-&gt;readScore(inFilePath));</a>
<a name="ln3477">      if (!score)</a>
<a name="ln3478">            return false;</a>
<a name="ln3479"> </a>
<a name="ln3480">      score-&gt;switchToPageMode();</a>
<a name="ln3481">      score-&gt;cmdSelectAll();</a>
<a name="ln3482"> </a>
<a name="ln3483">      score-&gt;startCmd();</a>
<a name="ln3484">      const bool transposed = score-&gt;transpose(mode, direction, targetKey, transposeInterval, transposeKeySignatures, transposeChordNames, useDoubleSharpsFlats);</a>
<a name="ln3485">      if (!transposed) {</a>
<a name="ln3486">            qCritical(&quot;Transposition failed&quot;);</a>
<a name="ln3487">            return false;</a>
<a name="ln3488">            }</a>
<a name="ln3489">      score-&gt;endCmd();</a>
<a name="ln3490"> </a>
<a name="ln3491">      bool res = true;</a>
<a name="ln3492">      CustomJsonWriter jsonWriter(outFilePath);</a>
<a name="ln3493"> </a>
<a name="ln3494">      // export mscz</a>
<a name="ln3495">      {</a>
<a name="ln3496">      jsonWriter.addKey(&quot;mscz&quot;);</a>
<a name="ln3497">      bool saved = false;</a>
<a name="ln3498">      QTemporaryFile tmpFile(QString(&quot;%1_transposed.XXXXXX.mscz&quot;).arg(score-&gt;title()));</a>
<a name="ln3499">      if (tmpFile.open()) {</a>
<a name="ln3500">            QFileInfo fi(tmpFile.fileName());</a>
<a name="ln3501">            saved = score-&gt;Score::saveCompressedFile(&amp;tmpFile, fi, /* onlySelection */ false);</a>
<a name="ln3502">            tmpFile.close();</a>
<a name="ln3503">            tmpFile.open();</a>
<a name="ln3504">            jsonWriter.addValue(tmpFile.readAll().toBase64());</a>
<a name="ln3505">            tmpFile.close();</a>
<a name="ln3506">            }</a>
<a name="ln3507"> </a>
<a name="ln3508">      if (!saved) {</a>
<a name="ln3509">            qCritical(&quot;Transpose: adding mscz failed&quot;);</a>
<a name="ln3510">            jsonWriter.addValue(&quot;&quot;);</a>
<a name="ln3511">            res = false;</a>
<a name="ln3512">            }</a>
<a name="ln3513">      }</a>
<a name="ln3514"> </a>
<a name="ln3515">      // export score pdf</a>
<a name="ln3516">      jsonWriter.addKey(&quot;pdf&quot;);</a>
<a name="ln3517">      jsonWriter.addValue(exportPdfAsJSON(score.get()), /* lastJsonElement */ true);</a>
<a name="ln3518"> </a>
<a name="ln3519">      return res;</a>
<a name="ln3520">      }</a>
<a name="ln3521"> </a>
<a name="ln3522">}</a>
<a name="ln3523"> </a>

</code></pre>
<div class="balloon" rel="380"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v668/" target="_blank">V668</a> There is no sense in testing the 'score' pointer against null, as the memory was allocated using the 'new' operator. The exception will be generated in the case of memory allocation error.</p></div>
<div class="balloon" rel="461"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="2017"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="2275"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'score' pointer was utilized before it was verified against nullptr. Check lines: 2275, 2276.</p></div>
<div class="balloon" rel="2267"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'score' pointer was utilized before it was verified against nullptr. Check lines: 2267, 2276.</p></div>
<div class="balloon" rel="2526"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 's' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="2724"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="3010"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="3421"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'critical' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="3436"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'critical' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="3449"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'critical' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
