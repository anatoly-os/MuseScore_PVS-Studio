
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>xmlreader.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2016 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;xml.h&quot;</a>
<a name="ln14">#include &quot;measure.h&quot;</a>
<a name="ln15">#include &quot;score.h&quot;</a>
<a name="ln16">#include &quot;spanner.h&quot;</a>
<a name="ln17">#include &quot;staff.h&quot;</a>
<a name="ln18">#include &quot;beam.h&quot;</a>
<a name="ln19">#include &quot;tuplet.h&quot;</a>
<a name="ln20"> </a>
<a name="ln21">namespace Ms {</a>
<a name="ln22"> </a>
<a name="ln23">//---------------------------------------------------------</a>
<a name="ln24">//   ~XmlReader</a>
<a name="ln25">//---------------------------------------------------------</a>
<a name="ln26"> </a>
<a name="ln27">XmlReader::~XmlReader()</a>
<a name="ln28">      {</a>
<a name="ln29">      if (!_connectors.empty() || !_pendingConnectors.empty()) {</a>
<a name="ln30">            qDebug(&quot;XmlReader::~XmlReader: there are unpaired connectors left&quot;);</a>
<a name="ln31">            for (auto&amp; c : _connectors) {</a>
<a name="ln32">                  Element* conn = c-&gt;releaseConnector();</a>
<a name="ln33">                  if (conn &amp;&amp; !conn-&gt;isTuplet()) // tuplets are added to score even when not finished</a>
<a name="ln34">                        delete conn;</a>
<a name="ln35">                  }</a>
<a name="ln36">            for (auto&amp; c : _pendingConnectors)</a>
<a name="ln37">                  delete c-&gt;releaseConnector();</a>
<a name="ln38">            }</a>
<a name="ln39">      }</a>
<a name="ln40"> </a>
<a name="ln41">//---------------------------------------------------------</a>
<a name="ln42">//   intAttribute</a>
<a name="ln43">//---------------------------------------------------------</a>
<a name="ln44"> </a>
<a name="ln45">int XmlReader::intAttribute(const char* s, int _default) const</a>
<a name="ln46">      {</a>
<a name="ln47">      if (attributes().hasAttribute(s))</a>
<a name="ln48">            // return attributes().value(s).toString().toInt();</a>
<a name="ln49">            return attributes().value(s).toInt();</a>
<a name="ln50">      else</a>
<a name="ln51">            return _default;</a>
<a name="ln52">      }</a>
<a name="ln53"> </a>
<a name="ln54">int XmlReader::intAttribute(const char* s) const</a>
<a name="ln55">      {</a>
<a name="ln56">      return attributes().value(s).toInt();</a>
<a name="ln57">      }</a>
<a name="ln58"> </a>
<a name="ln59">//---------------------------------------------------------</a>
<a name="ln60">//   doubleAttribute</a>
<a name="ln61">//---------------------------------------------------------</a>
<a name="ln62"> </a>
<a name="ln63">double XmlReader::doubleAttribute(const char* s) const</a>
<a name="ln64">      {</a>
<a name="ln65">      return attributes().value(s).toDouble();</a>
<a name="ln66">      }</a>
<a name="ln67"> </a>
<a name="ln68">double XmlReader::doubleAttribute(const char* s, double _default) const</a>
<a name="ln69">      {</a>
<a name="ln70">      if (attributes().hasAttribute(s))</a>
<a name="ln71">            return attributes().value(s).toDouble();</a>
<a name="ln72">      else</a>
<a name="ln73">            return _default;</a>
<a name="ln74">      }</a>
<a name="ln75"> </a>
<a name="ln76">//---------------------------------------------------------</a>
<a name="ln77">//   attribute</a>
<a name="ln78">//---------------------------------------------------------</a>
<a name="ln79"> </a>
<a name="ln80">QString XmlReader::attribute(const char* s, const QString&amp; _default) const</a>
<a name="ln81">      {</a>
<a name="ln82">      if (attributes().hasAttribute(s))</a>
<a name="ln83">            return attributes().value(s).toString();</a>
<a name="ln84">      else</a>
<a name="ln85">            return _default;</a>
<a name="ln86">      }</a>
<a name="ln87"> </a>
<a name="ln88">//---------------------------------------------------------</a>
<a name="ln89">//   hasAttribute</a>
<a name="ln90">//---------------------------------------------------------</a>
<a name="ln91"> </a>
<a name="ln92">bool XmlReader::hasAttribute(const char* s) const</a>
<a name="ln93">      {</a>
<a name="ln94">      return attributes().hasAttribute(s);</a>
<a name="ln95">      }</a>
<a name="ln96"> </a>
<a name="ln97">//---------------------------------------------------------</a>
<a name="ln98">//   readPoint</a>
<a name="ln99">//---------------------------------------------------------</a>
<a name="ln100"> </a>
<a name="ln101">QPointF XmlReader::readPoint()</a>
<a name="ln102">      {</a>
<a name="ln103">      Q_ASSERT(tokenType() == QXmlStreamReader::StartElement);</a>
<a name="ln104">#ifndef NDEBUG</a>
<a name="ln105">      if (!attributes().hasAttribute(&quot;x&quot;)) {</a>
<a name="ln106">            QXmlStreamAttributes map = attributes();</a>
<a name="ln107">            qDebug(&quot;XmlReader::readPoint: x attribute missing: %s (%d)&quot;,</a>
<a name="ln108">               name().toUtf8().data(), map.size());</a>
<a name="ln109">            for (int i = 0; i &lt; map.size(); ++i) {</a>
<a name="ln110">                  const QXmlStreamAttribute&amp; a = map.at(i);</a>
<a name="ln111">                  qDebug(&quot; attr &lt;%s&gt; &lt;%s&gt;&quot;, a.name().toUtf8().data(), a.value().toUtf8().data());</a>
<a name="ln112">                  }</a>
<a name="ln113">            unknown();</a>
<a name="ln114">            }</a>
<a name="ln115">      if (!attributes().hasAttribute(&quot;y&quot;)) {</a>
<a name="ln116">            qDebug(&quot;XmlReader::readPoint: y attribute missing: %s&quot;, name().toUtf8().data());</a>
<a name="ln117">            unknown();</a>
<a name="ln118">            }</a>
<a name="ln119">#endif</a>
<a name="ln120">      qreal x = doubleAttribute(&quot;x&quot;, 0.0);</a>
<a name="ln121">      qreal y = doubleAttribute(&quot;y&quot;, 0.0);</a>
<a name="ln122">      readNext();</a>
<a name="ln123">      return QPointF(x, y);</a>
<a name="ln124">      }</a>
<a name="ln125"> </a>
<a name="ln126">//---------------------------------------------------------</a>
<a name="ln127">//   readColor</a>
<a name="ln128">//---------------------------------------------------------</a>
<a name="ln129"> </a>
<a name="ln130">QColor XmlReader::readColor()</a>
<a name="ln131">      {</a>
<a name="ln132">      Q_ASSERT(tokenType() == QXmlStreamReader::StartElement);</a>
<a name="ln133">      QColor c;</a>
<a name="ln134">      c.setRed(intAttribute(&quot;r&quot;));</a>
<a name="ln135">      c.setGreen(intAttribute(&quot;g&quot;));</a>
<a name="ln136">      c.setBlue(intAttribute(&quot;b&quot;));</a>
<a name="ln137">      c.setAlpha(intAttribute(&quot;a&quot;, 255));</a>
<a name="ln138">      skipCurrentElement();</a>
<a name="ln139">      return c;</a>
<a name="ln140">      }</a>
<a name="ln141"> </a>
<a name="ln142">//---------------------------------------------------------</a>
<a name="ln143">//   readSize</a>
<a name="ln144">//---------------------------------------------------------</a>
<a name="ln145"> </a>
<a name="ln146">QSizeF XmlReader::readSize()</a>
<a name="ln147">      {</a>
<a name="ln148">      Q_ASSERT(tokenType() == QXmlStreamReader::StartElement);</a>
<a name="ln149">      QSizeF p;</a>
<a name="ln150">      p.setWidth(doubleAttribute(&quot;w&quot;, 0.0));</a>
<a name="ln151">      p.setHeight(doubleAttribute(&quot;h&quot;, 0.0));</a>
<a name="ln152">      skipCurrentElement();</a>
<a name="ln153">      return p;</a>
<a name="ln154">      }</a>
<a name="ln155"> </a>
<a name="ln156">//---------------------------------------------------------</a>
<a name="ln157">//   readRect</a>
<a name="ln158">//---------------------------------------------------------</a>
<a name="ln159"> </a>
<a name="ln160">QRectF XmlReader::readRect()</a>
<a name="ln161">      {</a>
<a name="ln162">      Q_ASSERT(tokenType() == QXmlStreamReader::StartElement);</a>
<a name="ln163">      QRectF p;</a>
<a name="ln164">      p.setX(doubleAttribute(&quot;x&quot;, 0.0));</a>
<a name="ln165">      p.setY(doubleAttribute(&quot;y&quot;, 0.0));</a>
<a name="ln166">      p.setWidth(doubleAttribute(&quot;w&quot;, 0.0));</a>
<a name="ln167">      p.setHeight(doubleAttribute(&quot;h&quot;, 0.0));</a>
<a name="ln168">      skipCurrentElement();</a>
<a name="ln169">      return p;</a>
<a name="ln170">      }</a>
<a name="ln171"> </a>
<a name="ln172">//---------------------------------------------------------</a>
<a name="ln173">//   readFraction</a>
<a name="ln174">//    recognizes this two styles:</a>
<a name="ln175">//    &lt;move z=&quot;2&quot; n=&quot;4&quot;/&gt;     (old style)</a>
<a name="ln176">//    &lt;move&gt;2/4&lt;/move&gt;        (new style)</a>
<a name="ln177">//---------------------------------------------------------</a>
<a name="ln178"> </a>
<a name="ln179">Fraction XmlReader::readFraction()</a>
<a name="ln180">      {</a>
<a name="ln181">      Q_ASSERT(tokenType() == QXmlStreamReader::StartElement);</a>
<a name="ln182">      int z = attribute(&quot;z&quot;, &quot;0&quot;).toInt();</a>
<a name="ln183">      int n = attribute(&quot;n&quot;, &quot;1&quot;).toInt();</a>
<a name="ln184">      const QString&amp; s(readElementText());</a>
<a name="ln185">      if (!s.isEmpty()) {</a>
<a name="ln186">            int i = s.indexOf('/');</a>
<a name="ln187">            if (i == -1) {</a>
<a name="ln188">                  qDebug(&quot;reading ticks &lt;%s&gt;&quot;, qPrintable(s));</a>
<a name="ln189">                  return Fraction::fromTicks(s.toInt());</a>
<a name="ln190">                  }</a>
<a name="ln191">            else {</a>
<a name="ln192">                  z = s.left(i).toInt();</a>
<a name="ln193">                  n = s.mid(i+1).toInt();</a>
<a name="ln194">                  }</a>
<a name="ln195">            }</a>
<a name="ln196">      return Fraction(z, n);</a>
<a name="ln197">      }</a>
<a name="ln198"> </a>
<a name="ln199">//---------------------------------------------------------</a>
<a name="ln200">//   unknown</a>
<a name="ln201">//    unknown tag read</a>
<a name="ln202">//---------------------------------------------------------</a>
<a name="ln203"> </a>
<a name="ln204">void XmlReader::unknown()</a>
<a name="ln205">      {</a>
<a name="ln206">      if (QXmlStreamReader::error())</a>
<a name="ln207">            qDebug(&quot;%s &quot;, qPrintable(errorString()));</a>
<a name="ln208">      if (!docName.isEmpty())</a>
<a name="ln209">            qDebug(&quot;tag in &lt;%s&gt; line %lld col %lld: %s&quot;,</a>
<a name="ln210">               qPrintable(docName), lineNumber(), columnNumber(), name().toUtf8().data());</a>
<a name="ln211">      else</a>
<a name="ln212">            qDebug(&quot;line %lld col %lld: %s&quot;, lineNumber(), columnNumber(), name().toUtf8().data());</a>
<a name="ln213">      skipCurrentElement();</a>
<a name="ln214">      }</a>
<a name="ln215"> </a>
<a name="ln216">//---------------------------------------------------------</a>
<a name="ln217">//   location</a>
<a name="ln218">//---------------------------------------------------------</a>
<a name="ln219"> </a>
<a name="ln220">Location XmlReader::location(bool forceAbsFrac) const</a>
<a name="ln221">      {</a>
<a name="ln222">      Location l = Location::absolute();</a>
<a name="ln223">      fillLocation(l, forceAbsFrac);</a>
<a name="ln224">      return l;</a>
<a name="ln225">      }</a>
<a name="ln226"> </a>
<a name="ln227">//---------------------------------------------------------</a>
<a name="ln228">//   fillLocation</a>
<a name="ln229">//    fills location fields which have default values with</a>
<a name="ln230">//    values relevant for the current reader's position.</a>
<a name="ln231">//    When in paste mode (or forceAbsFrac is true) absolute</a>
<a name="ln232">//    fraction values are used and measure number is set to</a>
<a name="ln233">//    zero.</a>
<a name="ln234">//---------------------------------------------------------</a>
<a name="ln235"> </a>
<a name="ln236">void XmlReader::fillLocation(Location&amp; l, bool forceAbsFrac) const</a>
<a name="ln237">      {</a>
<a name="ln238">      constexpr Location defaults = Location::absolute();</a>
<a name="ln239">      const bool absFrac = (pasteMode() || forceAbsFrac);</a>
<a name="ln240">      if (l.track() == defaults.track())</a>
<a name="ln241">            l.setTrack(track());</a>
<a name="ln242">      if (l.frac() == defaults.frac())</a>
<a name="ln243">            l.setFrac(absFrac ? tick() : rtick());</a>
<a name="ln244">      if (l.measure() == defaults.measure())</a>
<a name="ln245">            l.setMeasure(absFrac ? 0 : currentMeasureIndex());</a>
<a name="ln246">      }</a>
<a name="ln247"> </a>
<a name="ln248">//---------------------------------------------------------</a>
<a name="ln249">//   setLocation</a>
<a name="ln250">//    sets a new reading location, taking into account its</a>
<a name="ln251">//    type (absolute or relative).</a>
<a name="ln252">//---------------------------------------------------------</a>
<a name="ln253"> </a>
<a name="ln254">void XmlReader::setLocation(const Location&amp; l)</a>
<a name="ln255">      {</a>
<a name="ln256">      if (l.isRelative()) {</a>
<a name="ln257">            Location newLoc = l;</a>
<a name="ln258">            newLoc.toAbsolute(location());</a>
<a name="ln259">            int intTicks = l.frac().ticks();</a>
<a name="ln260">            if (_tick == Fraction::fromTicks(_intTick + intTicks)) {</a>
<a name="ln261">                  _intTick += intTicks;</a>
<a name="ln262">                  setTrack(newLoc.track() - _trackOffset);</a>
<a name="ln263">                  return;</a>
<a name="ln264">                  }</a>
<a name="ln265">            setLocation(newLoc); // recursion</a>
<a name="ln266">            return;</a>
<a name="ln267">            }</a>
<a name="ln268">      setTrack(l.track() - _trackOffset);</a>
<a name="ln269">      setTick(l.frac() - _tickOffset);</a>
<a name="ln270">      if (!pasteMode()) {</a>
<a name="ln271">            Q_ASSERT(l.measure() == currentMeasureIndex());</a>
<a name="ln272">            incTick(currentMeasure()-&gt;tick());</a>
<a name="ln273">            }</a>
<a name="ln274">      }</a>
<a name="ln275"> </a>
<a name="ln276">//---------------------------------------------------------</a>
<a name="ln277">//   addBeam</a>
<a name="ln278">//---------------------------------------------------------</a>
<a name="ln279"> </a>
<a name="ln280">void XmlReader::addBeam(Beam* s)</a>
<a name="ln281">      {</a>
<a name="ln282">      _beams.insert(s-&gt;id(), s);</a>
<a name="ln283">      }</a>
<a name="ln284"> </a>
<a name="ln285">//---------------------------------------------------------</a>
<a name="ln286">//   addTuplet</a>
<a name="ln287">//---------------------------------------------------------</a>
<a name="ln288"> </a>
<a name="ln289">void XmlReader::addTuplet(Tuplet* s)</a>
<a name="ln290">      {</a>
<a name="ln291">      _tuplets.insert(s-&gt;id(), s);</a>
<a name="ln292">      }</a>
<a name="ln293"> </a>
<a name="ln294">//---------------------------------------------------------</a>
<a name="ln295">//   readDouble</a>
<a name="ln296">//---------------------------------------------------------</a>
<a name="ln297"> </a>
<a name="ln298">double XmlReader::readDouble(double min, double max)</a>
<a name="ln299">      {</a>
<a name="ln300">      double val = readElementText().toDouble();</a>
<a name="ln301">      if (val &lt; min)</a>
<a name="ln302">            val = min;</a>
<a name="ln303">      else if (val &gt; max)</a>
<a name="ln304">            val = max;</a>
<a name="ln305">      return val;</a>
<a name="ln306">      }</a>
<a name="ln307"> </a>
<a name="ln308">//---------------------------------------------------------</a>
<a name="ln309">//   readBool</a>
<a name="ln310">//---------------------------------------------------------</a>
<a name="ln311"> </a>
<a name="ln312">bool XmlReader::readBool()</a>
<a name="ln313">      {</a>
<a name="ln314">      bool val;</a>
<a name="ln315">      QXmlStreamReader::TokenType tt = readNext();</a>
<a name="ln316">      if (tt == QXmlStreamReader::Characters) {</a>
<a name="ln317">            val = text().toInt() != 0;</a>
<a name="ln318">            readNext();</a>
<a name="ln319">            }</a>
<a name="ln320">      else</a>
<a name="ln321">            val = true;</a>
<a name="ln322">      return val;</a>
<a name="ln323">      }</a>
<a name="ln324"> </a>
<a name="ln325">//---------------------------------------------------------</a>
<a name="ln326">//   checkTuplets</a>
<a name="ln327">//---------------------------------------------------------</a>
<a name="ln328"> </a>
<a name="ln329">void XmlReader::checkTuplets()</a>
<a name="ln330">      {</a>
<a name="ln331">      for (Tuplet* tuplet : tuplets()) {</a>
<a name="ln332">            if (tuplet-&gt;elements().empty()) {</a>
<a name="ln333">                  // this should not happen and is a sign of input file corruption</a>
<a name="ln334">                  qDebug(&quot;Measure:read(): empty tuplet id %d (%p), input file corrupted?&quot;,</a>
<a name="ln335">                     tuplet-&gt;id(), tuplet);</a>
<a name="ln336">                  delete tuplet;</a>
<a name="ln337">                  }</a>
<a name="ln338">            else {</a>
<a name="ln339">                  //sort tuplet elements. Needed for nested tuplets #22537</a>
<a name="ln340">                  tuplet-&gt;sortElements();</a>
<a name="ln341">                  tuplet-&gt;sanitizeTuplet();</a>
<a name="ln342">                  }</a>
<a name="ln343">            }</a>
<a name="ln344">      // This requires a separate pass in case of nested tuplets that required sanitizing</a>
<a name="ln345">      for (Tuplet* tuplet : tuplets())</a>
<a name="ln346">            tuplet-&gt;addMissingElements();</a>
<a name="ln347">      }</a>
<a name="ln348"> </a>
<a name="ln349">//---------------------------------------------------------</a>
<a name="ln350">//   htmlToString</a>
<a name="ln351">//---------------------------------------------------------</a>
<a name="ln352"> </a>
<a name="ln353">void XmlReader::htmlToString(int level, QString* s)</a>
<a name="ln354">      {</a>
<a name="ln355">      *s += QString(&quot;&lt;%1&quot;).arg(name().toString());</a>
<a name="ln356">      for (const QXmlStreamAttribute&amp; a : attributes())</a>
<a name="ln357">            *s += QString(&quot; %1=\&quot;%2\&quot;&quot;).arg(a.name().toString()).arg(a.value().toString());</a>
<a name="ln358">      *s += &quot;&gt;&quot;;</a>
<a name="ln359">      ++level;</a>
<a name="ln360">      for (;;) {</a>
<a name="ln361">            QXmlStreamReader::TokenType t = readNext();</a>
<a name="ln362">            switch(t) {</a>
<a name="ln363">                  case QXmlStreamReader::StartElement:</a>
<a name="ln364">                        htmlToString(level, s);</a>
<a name="ln365">                        break;</a>
<a name="ln366">                  case QXmlStreamReader::EndElement:</a>
<a name="ln367">                        *s += QString(&quot;&lt;/%1&gt;&quot;).arg(name().toString());</a>
<a name="ln368">                        --level;</a>
<a name="ln369">                        return;</a>
<a name="ln370">                  case QXmlStreamReader::Characters:</a>
<a name="ln371">                        if (!isWhitespace())</a>
<a name="ln372">                              *s += text().toString().toHtmlEscaped();</a>
<a name="ln373">                        break;</a>
<a name="ln374">                  case QXmlStreamReader::Comment:</a>
<a name="ln375">                        break;</a>
<a name="ln376"> </a>
<a name="ln377">                  default:</a>
<a name="ln378">                        qDebug(&quot;htmlToString: read token: %s&quot;, qPrintable(tokenString()));</a>
<a name="ln379">                        return;</a>
<a name="ln380">                  }</a>
<a name="ln381">            }</a>
<a name="ln382">      }</a>
<a name="ln383"> </a>
<a name="ln384">//-------------------------------------------------------------------</a>
<a name="ln385">//   readXml</a>
<a name="ln386">//    read verbatim until end tag of current level is reached</a>
<a name="ln387">//-------------------------------------------------------------------</a>
<a name="ln388"> </a>
<a name="ln389">QString XmlReader::readXml()</a>
<a name="ln390">      {</a>
<a name="ln391">      QString s;</a>
<a name="ln392">      int level = 1;</a>
<a name="ln393">      for (QXmlStreamReader::TokenType t = readNext(); t != QXmlStreamReader::EndElement; t = readNext()) {</a>
<a name="ln394">            switch (t) {</a>
<a name="ln395">                  case QXmlStreamReader::StartElement:</a>
<a name="ln396">                        htmlToString(level, &amp;s);</a>
<a name="ln397">                        break;</a>
<a name="ln398">                  case QXmlStreamReader::EndElement:</a>
<a name="ln399">                        break;</a>
<a name="ln400">                  case QXmlStreamReader::Characters:</a>
<a name="ln401">                        s += text().toString().toHtmlEscaped();</a>
<a name="ln402">                        break;</a>
<a name="ln403">                  case QXmlStreamReader::Comment:</a>
<a name="ln404">                        break;</a>
<a name="ln405"> </a>
<a name="ln406">                  default:</a>
<a name="ln407">                        qDebug(&quot;htmlToString: read token: %s&quot;, qPrintable(tokenString()));</a>
<a name="ln408">                        return s;</a>
<a name="ln409">                  }</a>
<a name="ln410">            }</a>
<a name="ln411">      return s;</a>
<a name="ln412">      }</a>
<a name="ln413"> </a>
<a name="ln414">//---------------------------------------------------------</a>
<a name="ln415">//   readPlacement</a>
<a name="ln416">//---------------------------------------------------------</a>
<a name="ln417"> </a>
<a name="ln418">PlaceText readPlacement(XmlReader&amp; e)</a>
<a name="ln419">      {</a>
<a name="ln420">      const QString&amp; s(e.readElementText());</a>
<a name="ln421">      if (s == &quot;auto&quot; || s == &quot;0&quot;)</a>
<a name="ln422">            return PlaceText::AUTO;</a>
<a name="ln423">      if (s == &quot;above&quot; || s == &quot;1&quot;)</a>
<a name="ln424">            return PlaceText::ABOVE;</a>
<a name="ln425">      if (s == &quot;below&quot; || s == &quot;2&quot;)</a>
<a name="ln426">            return PlaceText::BELOW;</a>
<a name="ln427">      if (s == &quot;left&quot; || s == &quot;3&quot;)</a>
<a name="ln428">            return PlaceText::LEFT;</a>
<a name="ln429">      qDebug(&quot;unknown placement value &lt;%s&gt;&quot;, qPrintable(s));</a>
<a name="ln430">      return PlaceText::AUTO;</a>
<a name="ln431">      }</a>
<a name="ln432"> </a>
<a name="ln433">//---------------------------------------------------------</a>
<a name="ln434">//   spannerValues</a>
<a name="ln435">//---------------------------------------------------------</a>
<a name="ln436"> </a>
<a name="ln437">const SpannerValues* XmlReader::spannerValues(int id) const</a>
<a name="ln438">      {</a>
<a name="ln439">      for (const SpannerValues&amp; v : _spannerValues) {</a>
<a name="ln440">            if (v.spannerId == id)</a>
<a name="ln441">                  return &amp;v;</a>
<a name="ln442">            }</a>
<a name="ln443">      return 0;</a>
<a name="ln444">      }</a>
<a name="ln445"> </a>
<a name="ln446">//---------------------------------------------------------</a>
<a name="ln447">//   addSpanner</a>
<a name="ln448">//---------------------------------------------------------</a>
<a name="ln449"> </a>
<a name="ln450">void XmlReader::addSpanner(int id, Spanner* s)</a>
<a name="ln451">      {</a>
<a name="ln452">      _spanner.append(std::pair&lt;int, Spanner*&gt;(id, s));</a>
<a name="ln453">      }</a>
<a name="ln454"> </a>
<a name="ln455">//---------------------------------------------------------</a>
<a name="ln456">//   removeSpanner</a>
<a name="ln457">//---------------------------------------------------------</a>
<a name="ln458"> </a>
<a name="ln459">void XmlReader::removeSpanner(const Spanner* s)</a>
<a name="ln460">      {</a>
<a name="ln461">      for (auto i : _spanner) {</a>
<a name="ln462">            if (i.second == s) {</a>
<a name="ln463">                  _spanner.removeOne(i);</a>
<a name="ln464">                  return;</a>
<a name="ln465">                  }</a>
<a name="ln466">            }</a>
<a name="ln467">      }</a>
<a name="ln468"> </a>
<a name="ln469">//---------------------------------------------------------</a>
<a name="ln470">//   findSpanner</a>
<a name="ln471">//---------------------------------------------------------</a>
<a name="ln472"> </a>
<a name="ln473">Spanner* XmlReader::findSpanner(int id)</a>
<a name="ln474">      {</a>
<a name="ln475">      for (auto i : _spanner) {</a>
<a name="ln476">            if (i.first == id)</a>
<a name="ln477">                  return i.second;</a>
<a name="ln478">            }</a>
<a name="ln479">      return nullptr;</a>
<a name="ln480">      }</a>
<a name="ln481"> </a>
<a name="ln482">//---------------------------------------------------------</a>
<a name="ln483">//   spannerId</a>
<a name="ln484">//---------------------------------------------------------</a>
<a name="ln485"> </a>
<a name="ln486">int XmlReader::spannerId(const Spanner* s)</a>
<a name="ln487">      {</a>
<a name="ln488">      for (auto i : _spanner) {</a>
<a name="ln489">            if (i.second == s)</a>
<a name="ln490">                  return i.first;</a>
<a name="ln491">            }</a>
<a name="ln492">      qDebug(&quot;XmlReader::spannerId not found&quot;);</a>
<a name="ln493">      return -1;</a>
<a name="ln494">      }</a>
<a name="ln495"> </a>
<a name="ln496">//---------------------------------------------------------</a>
<a name="ln497">//   addUserTextStyle</a>
<a name="ln498">//    return false if mapping is not possible</a>
<a name="ln499">//      (too many user text styles)</a>
<a name="ln500">//---------------------------------------------------------</a>
<a name="ln501"> </a>
<a name="ln502">Tid XmlReader::addUserTextStyle(const QString&amp; name)</a>
<a name="ln503">      {</a>
<a name="ln504">      qDebug(&quot;%s&quot;, qPrintable(name));</a>
<a name="ln505">      Tid id = Tid::TEXT_STYLES;</a>
<a name="ln506">      if (userTextStyles.size() == 0)</a>
<a name="ln507">            id = Tid::USER1;</a>
<a name="ln508">      else if (userTextStyles.size() == 1)</a>
<a name="ln509">            id = Tid::USER2;</a>
<a name="ln510">      else if (userTextStyles.size() == 2)</a>
<a name="ln511">            id = Tid::USER3;</a>
<a name="ln512">      else if (userTextStyles.size() == 3)</a>
<a name="ln513">            id = Tid::USER4;</a>
<a name="ln514">      else if (userTextStyles.size() == 4)</a>
<a name="ln515">            id = Tid::USER5;</a>
<a name="ln516">      else if (userTextStyles.size() == 5)</a>
<a name="ln517">            id = Tid::USER6;</a>
<a name="ln518">      else if (userTextStyles.size() == 6)</a>
<a name="ln519">            id = Tid::USER7;</a>
<a name="ln520">      else if (userTextStyles.size() == 7)</a>
<a name="ln521">            id = Tid::USER8;</a>
<a name="ln522">      else if (userTextStyles.size() == 8)</a>
<a name="ln523">            id = Tid::USER9;</a>
<a name="ln524">      else if (userTextStyles.size() == 9)</a>
<a name="ln525">            id = Tid::USER10;</a>
<a name="ln526">      else if (userTextStyles.size() == 10)</a>
<a name="ln527">            id = Tid::USER11;</a>
<a name="ln528">      else if (userTextStyles.size() == 11)</a>
<a name="ln529">            id = Tid::USER12;</a>
<a name="ln530">      else</a>
<a name="ln531">            qDebug(&quot;too many user defined textstyles&quot;);</a>
<a name="ln532">      if (id != Tid::TEXT_STYLES)</a>
<a name="ln533">            userTextStyles.push_back({name, id});</a>
<a name="ln534">      return id;</a>
<a name="ln535">      }</a>
<a name="ln536"> </a>
<a name="ln537">//---------------------------------------------------------</a>
<a name="ln538">//   lookupUserTextStyle</a>
<a name="ln539">//---------------------------------------------------------</a>
<a name="ln540"> </a>
<a name="ln541">Tid XmlReader::lookupUserTextStyle(const QString&amp; name)</a>
<a name="ln542">      {</a>
<a name="ln543">      for (const auto&amp; i : userTextStyles) {</a>
<a name="ln544">            if (i.name == name)</a>
<a name="ln545">                  return i.ss;</a>
<a name="ln546">            }</a>
<a name="ln547">      return Tid::TEXT_STYLES;       // not found</a>
<a name="ln548">      }</a>
<a name="ln549"> </a>
<a name="ln550">//---------------------------------------------------------</a>
<a name="ln551">//   performReadAhead</a>
<a name="ln552">//    If f is called, the device will be non-sequential and</a>
<a name="ln553">//    open. Reading position equals to the current value of</a>
<a name="ln554">//    characterOffset(), but it is possible to seek for any</a>
<a name="ln555">//    other position inside f.</a>
<a name="ln556">//---------------------------------------------------------</a>
<a name="ln557"> </a>
<a name="ln558">void XmlReader::performReadAhead(std::function&lt;void(QIODevice&amp;)&gt; f)</a>
<a name="ln559">      {</a>
<a name="ln560">      if (!_readAheadDevice || _readAheadDevice-&gt;isSequential())</a>
<a name="ln561">            return;</a>
<a name="ln562">      if (!_readAheadDevice-&gt;isOpen())</a>
<a name="ln563">            _readAheadDevice-&gt;open(QIODevice::ReadOnly);</a>
<a name="ln564"> </a>
<a name="ln565">      const auto pos = _readAheadDevice-&gt;pos();</a>
<a name="ln566">      _readAheadDevice-&gt;seek(characterOffset());</a>
<a name="ln567">      f(*_readAheadDevice);</a>
<a name="ln568">      _readAheadDevice-&gt;seek(pos);</a>
<a name="ln569">      }</a>
<a name="ln570"> </a>
<a name="ln571">//---------------------------------------------------------</a>
<a name="ln572">//   addConnectorInfo</a>
<a name="ln573">//---------------------------------------------------------</a>
<a name="ln574"> </a>
<a name="ln575">void XmlReader::addConnectorInfo(std::unique_ptr&lt;ConnectorInfoReader&gt; c)</a>
<a name="ln576">      {</a>
<a name="ln577">      _connectors.push_back(std::move(c));</a>
<a name="ln578">      ConnectorInfoReader* c1 = _connectors.back().get();</a>
<a name="ln579">      c1-&gt;update();</a>
<a name="ln580">      for (std::unique_ptr&lt;ConnectorInfoReader&gt;&amp; c2 : _connectors) {</a>
<a name="ln581">            if (c2-&gt;connect(c1)) {</a>
<a name="ln582">                  if (c2-&gt;finished()) {</a>
<a name="ln583">                        c2-&gt;addToScore(pasteMode());</a>
<a name="ln584">                        removeConnector(c2.get());</a>
<a name="ln585">                        }</a>
<a name="ln586">                  break;</a>
<a name="ln587">                  }</a>
<a name="ln588">            }</a>
<a name="ln589">      }</a>
<a name="ln590"> </a>
<a name="ln591">//---------------------------------------------------------</a>
<a name="ln592">//   removeConnector</a>
<a name="ln593">//---------------------------------------------------------</a>
<a name="ln594"> </a>
<a name="ln595">void XmlReader::removeConnector(const ConnectorInfoReader* c)</a>
<a name="ln596">      {</a>
<a name="ln597">      while (c-&gt;prev())</a>
<a name="ln598">            c = c-&gt;prev();</a>
<a name="ln599">      while (c) {</a>
<a name="ln600">            ConnectorInfoReader* next = c-&gt;next();</a>
<a name="ln601">            for (auto it = _connectors.begin(); it != _connectors.end(); ++it) {</a>
<a name="ln602">                  if (it-&gt;get() == c) {</a>
<a name="ln603">                        _connectors.erase(it);</a>
<a name="ln604">                        break;</a>
<a name="ln605">                        }</a>
<a name="ln606">                  }</a>
<a name="ln607">            c = next;</a>
<a name="ln608">            }</a>
<a name="ln609">      }</a>
<a name="ln610"> </a>
<a name="ln611">//---------------------------------------------------------</a>
<a name="ln612">//   checkConnectors</a>
<a name="ln613">//---------------------------------------------------------</a>
<a name="ln614"> </a>
<a name="ln615">void XmlReader::checkConnectors()</a>
<a name="ln616">      {</a>
<a name="ln617">      for (std::unique_ptr&lt;ConnectorInfoReader&gt;&amp; c : _pendingConnectors)</a>
<a name="ln618">            addConnectorInfo(std::move(c));</a>
<a name="ln619">      _pendingConnectors.clear();</a>
<a name="ln620">      }</a>
<a name="ln621"> </a>
<a name="ln622">//---------------------------------------------------------</a>
<a name="ln623">//   distanceSort</a>
<a name="ln624">//---------------------------------------------------------</a>
<a name="ln625"> </a>
<a name="ln626">static bool distanceSort(const QPair&lt;int, QPair&lt;ConnectorInfoReader*, ConnectorInfoReader*&gt;&gt;&amp; p1, const QPair&lt;int, QPair&lt;ConnectorInfoReader*, ConnectorInfoReader*&gt;&gt;&amp; p2)</a>
<a name="ln627">      {</a>
<a name="ln628">      return p1.first &lt; p2.first;</a>
<a name="ln629">      }</a>
<a name="ln630"> </a>
<a name="ln631">//---------------------------------------------------------</a>
<a name="ln632">//   reconnectBrokenConnectors</a>
<a name="ln633">//---------------------------------------------------------</a>
<a name="ln634"> </a>
<a name="ln635">void XmlReader::reconnectBrokenConnectors()</a>
<a name="ln636">      {</a>
<a name="ln637">      if (_connectors.empty())</a>
<a name="ln638">            return;</a>
<a name="ln639">      qDebug(&quot;Reconnecting broken connectors (%d nodes)&quot;, int(_connectors.size()));</a>
<a name="ln640">      QList&lt;QPair&lt;int, QPair&lt;ConnectorInfoReader*, ConnectorInfoReader*&gt;&gt;&gt; brokenPairs;</a>
<a name="ln641">      for (size_t i = 1; i &lt; _connectors.size(); ++i) {</a>
<a name="ln642">            for (size_t j = 0; j &lt; i; ++j) {</a>
<a name="ln643">                  ConnectorInfoReader* c1 = _connectors[i].get();</a>
<a name="ln644">                  ConnectorInfoReader* c2 = _connectors[j].get();</a>
<a name="ln645">                  int d = c1-&gt;connectionDistance(*c2);</a>
<a name="ln646">                  if (d &gt;= 0)</a>
<a name="ln647">                        brokenPairs.append(qMakePair(d, qMakePair(c1, c2)));</a>
<a name="ln648">                  else</a>
<a name="ln649">                        brokenPairs.append(qMakePair(-d, qMakePair(c2, c1)));</a>
<a name="ln650">                  }</a>
<a name="ln651">            }</a>
<a name="ln652">      std::sort(brokenPairs.begin(), brokenPairs.end(), distanceSort);</a>
<a name="ln653">      for (auto&amp; distPair : brokenPairs) {</a>
<a name="ln654">            if (distPair.first == INT_MAX)</a>
<a name="ln655">                  continue;</a>
<a name="ln656">            auto&amp; pair = distPair.second;</a>
<a name="ln657">            if (pair.first-&gt;next() || pair.second-&gt;prev())</a>
<a name="ln658">                  continue;</a>
<a name="ln659">            pair.first-&gt;forceConnect(pair.second);</a>
<a name="ln660">            }</a>
<a name="ln661">      QSet&lt;ConnectorInfoReader*&gt; reconnected;</a>
<a name="ln662">      for (auto&amp; conn : _connectors) {</a>
<a name="ln663">            ConnectorInfoReader* c = conn.get();</a>
<a name="ln664">            if (c-&gt;finished())</a>
<a name="ln665">                  reconnected.insert(static_cast&lt;ConnectorInfoReader*&gt;(c-&gt;start()));</a>
<a name="ln666">            }</a>
<a name="ln667">      for (ConnectorInfoReader* cptr : reconnected) {</a>
<a name="ln668">            cptr-&gt;addToScore(pasteMode());</a>
<a name="ln669">            removeConnector(cptr);</a>
<a name="ln670">            }</a>
<a name="ln671">      qDebug(&quot;reconnected %d broken connectors&quot;, reconnected.count());</a>
<a name="ln672">      }</a>
<a name="ln673"> </a>
<a name="ln674">//---------------------------------------------------------</a>
<a name="ln675">//   addLink</a>
<a name="ln676">//---------------------------------------------------------</a>
<a name="ln677"> </a>
<a name="ln678">void XmlReader::addLink(Staff* s, LinkedElements* link)</a>
<a name="ln679">      {</a>
<a name="ln680">      int staff = s-&gt;idx();</a>
<a name="ln681">      const bool masterScore = s-&gt;score()-&gt;isMaster();</a>
<a name="ln682">      if (!masterScore)</a>
<a name="ln683">            staff *= -1;</a>
<a name="ln684"> </a>
<a name="ln685">      QList&lt;QPair&lt;LinkedElements*, Location&gt;&gt;&amp; staffLinks = _staffLinkedElements[staff];</a>
<a name="ln686">      if (!masterScore) {</a>
<a name="ln687">            if (!staffLinks.empty()</a>
<a name="ln688">               &amp;&amp; (link-&gt;mainElement()-&gt;score() != staffLinks.front().first-&gt;mainElement()-&gt;score())</a>
<a name="ln689">               )</a>
<a name="ln690">                  staffLinks.clear();</a>
<a name="ln691">            }</a>
<a name="ln692"> </a>
<a name="ln693">      Location l = location(true);</a>
<a name="ln694">      _linksIndexer.assignLocalIndex(l);</a>
<a name="ln695">      staffLinks.push_back(qMakePair(link, l));</a>
<a name="ln696">      }</a>
<a name="ln697"> </a>
<a name="ln698">//---------------------------------------------------------</a>
<a name="ln699">//   getLink</a>
<a name="ln700">//---------------------------------------------------------</a>
<a name="ln701"> </a>
<a name="ln702">LinkedElements* XmlReader::getLink(bool masterScore, const Location&amp; l, int localIndexDiff)</a>
<a name="ln703">      {</a>
<a name="ln704">      int staff = l.staff();</a>
<a name="ln705">      if (!masterScore)</a>
<a name="ln706">            staff *= -1;</a>
<a name="ln707">      const int localIndex = _linksIndexer.assignLocalIndex(l) + localIndexDiff;</a>
<a name="ln708">      QList&lt;QPair&lt;LinkedElements*, Location&gt;&gt;&amp; staffLinks = _staffLinkedElements[staff];</a>
<a name="ln709"> </a>
<a name="ln710">      if (!staffLinks.isEmpty() &amp;&amp; staffLinks.constLast().second == l) {</a>
<a name="ln711">            // This element potentially affects local index for &quot;main&quot;</a>
<a name="ln712">            // elements that may go afterwards at the same tick, so</a>
<a name="ln713">            // append it to staffLinks as well.</a>
<a name="ln714">            staffLinks.push_back(staffLinks.constLast()); // nothing should reference exactly this local index, so it shouldn't matter what to append</a>
<a name="ln715">            }</a>
<a name="ln716"> </a>
<a name="ln717">      for (int i = 0; i &lt; staffLinks.size(); ++i) {</a>
<a name="ln718">            if (staffLinks[i].second == l) {</a>
<a name="ln719">                  if (localIndex == 0)</a>
<a name="ln720">                        return staffLinks[i].first;</a>
<a name="ln721">                  i += localIndex;</a>
<a name="ln722">                  if ((i &lt; 0) || (i &gt;= staffLinks.size()))</a>
<a name="ln723">                        return nullptr;</a>
<a name="ln724">                  if (staffLinks[i].second == l)</a>
<a name="ln725">                        return staffLinks[i].first;</a>
<a name="ln726">                  return nullptr;</a>
<a name="ln727">                  }</a>
<a name="ln728">            }</a>
<a name="ln729">      return nullptr;</a>
<a name="ln730">      }</a>
<a name="ln731"> </a>
<a name="ln732">//---------------------------------------------------------</a>
<a name="ln733">//   assignLocalIndex</a>
<a name="ln734">//---------------------------------------------------------</a>
<a name="ln735"> </a>
<a name="ln736">int LinksIndexer::assignLocalIndex(const Location&amp; mainElementLocation)</a>
<a name="ln737">      {</a>
<a name="ln738">      if (_lastLinkedElementLoc == mainElementLocation)</a>
<a name="ln739">            return (++_lastLocalIndex);</a>
<a name="ln740">      _lastLocalIndex = 0;</a>
<a name="ln741">      _lastLinkedElementLoc = mainElementLocation;</a>
<a name="ln742">      return 0;</a>
<a name="ln743">      }</a>
<a name="ln744"> </a>
<a name="ln745">//---------------------------------------------------------</a>
<a name="ln746">//   rtick</a>
<a name="ln747">//    return relative position in measure</a>
<a name="ln748">//---------------------------------------------------------</a>
<a name="ln749"> </a>
<a name="ln750">Fraction XmlReader::rtick() const</a>
<a name="ln751">      {</a>
<a name="ln752">      return _curMeasure ? _tick - _curMeasure-&gt;tick() : _tick;</a>
<a name="ln753">      }</a>
<a name="ln754"> </a>
<a name="ln755">//---------------------------------------------------------</a>
<a name="ln756">//   setTick</a>
<a name="ln757">//---------------------------------------------------------</a>
<a name="ln758"> </a>
<a name="ln759">void XmlReader::setTick(const Fraction&amp; f)</a>
<a name="ln760">      {</a>
<a name="ln761">      _tick = f.reduced();</a>
<a name="ln762">      _intTick = _tick.ticks();</a>
<a name="ln763">      }</a>
<a name="ln764"> </a>
<a name="ln765">//---------------------------------------------------------</a>
<a name="ln766">//   incTick</a>
<a name="ln767">//---------------------------------------------------------</a>
<a name="ln768"> </a>
<a name="ln769">void XmlReader::incTick(const Fraction&amp; f)</a>
<a name="ln770">      {</a>
<a name="ln771">      _tick += f;</a>
<a name="ln772">      _tick.reduce();</a>
<a name="ln773">      _intTick += f.ticks();</a>
<a name="ln774">      }</a>
<a name="ln775">}</a>
<a name="ln776"> </a>
<a name="ln777"> </a>

</code></pre>
<div class="balloon" rel="188"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="207"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="378"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="407"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="429"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="504"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
