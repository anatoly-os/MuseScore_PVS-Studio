
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>dragdrop.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2011 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;libmscore/score.h&quot;</a>
<a name="ln14">#include &quot;libmscore/element.h&quot;</a>
<a name="ln15">#include &quot;libmscore/note.h&quot;</a>
<a name="ln16">#include &quot;libmscore/rest.h&quot;</a>
<a name="ln17">#include &quot;libmscore/measure.h&quot;</a>
<a name="ln18">#include &quot;libmscore/system.h&quot;</a>
<a name="ln19">#include &quot;libmscore/segment.h&quot;</a>
<a name="ln20">#include &quot;libmscore/page.h&quot;</a>
<a name="ln21">#include &quot;libmscore/image.h&quot;</a>
<a name="ln22">#include &quot;libmscore/text.h&quot;</a>
<a name="ln23">#include &quot;libmscore/spanner.h&quot;</a>
<a name="ln24">#include &quot;libmscore/chord.h&quot;</a>
<a name="ln25">#include &quot;libmscore/icon.h&quot;</a>
<a name="ln26">#include &quot;libmscore/xml.h&quot;</a>
<a name="ln27">#include &quot;libmscore/stafflines.h&quot;</a>
<a name="ln28">#include &quot;musescore.h&quot;</a>
<a name="ln29">#include &quot;scoreview.h&quot;</a>
<a name="ln30">#include &quot;continuouspanel.h&quot;</a>
<a name="ln31">#include &quot;tourhandler.h&quot;</a>
<a name="ln32"> </a>
<a name="ln33">namespace Ms {</a>
<a name="ln34"> </a>
<a name="ln35">//---------------------------------------------------------</a>
<a name="ln36">//   setDropTarget</a>
<a name="ln37">//---------------------------------------------------------</a>
<a name="ln38"> </a>
<a name="ln39">void ScoreView::setDropTarget(const Element* el)</a>
<a name="ln40">      {</a>
<a name="ln41">      if (dropTarget != el) {</a>
<a name="ln42">            if (dropTarget) {</a>
<a name="ln43">                  dropTarget-&gt;setDropTarget(false);</a>
<a name="ln44">                  dropTarget = 0;</a>
<a name="ln45">                  }</a>
<a name="ln46">            dropTarget = el;</a>
<a name="ln47">            if (dropTarget) {</a>
<a name="ln48">                  dropTarget-&gt;setDropTarget(true);</a>
<a name="ln49">                  }</a>
<a name="ln50">            }</a>
<a name="ln51">      if (!dropAnchor.isNull()) {</a>
<a name="ln52">            QRectF r;</a>
<a name="ln53">            r.setTopLeft(dropAnchor.p1());</a>
<a name="ln54">            r.setBottomRight(dropAnchor.p2());</a>
<a name="ln55">            dropAnchor = QLineF();</a>
<a name="ln56">            }</a>
<a name="ln57">      if (dropRectangle.isValid()) {</a>
<a name="ln58">            dropRectangle = QRectF();</a>
<a name="ln59">            }</a>
<a name="ln60">      update();</a>
<a name="ln61">      }</a>
<a name="ln62"> </a>
<a name="ln63">//---------------------------------------------------------</a>
<a name="ln64">//   setDropRectangle</a>
<a name="ln65">//---------------------------------------------------------</a>
<a name="ln66"> </a>
<a name="ln67">void ScoreView::setDropRectangle(const QRectF&amp; r)</a>
<a name="ln68">      {</a>
<a name="ln69">      if (dropRectangle.isValid())</a>
<a name="ln70">            _score-&gt;addRefresh(dropRectangle);</a>
<a name="ln71">      dropRectangle = r;</a>
<a name="ln72">      if (dropTarget) {</a>
<a name="ln73">            dropTarget-&gt;setDropTarget(false);</a>
<a name="ln74">            _score-&gt;addRefresh(dropTarget-&gt;canvasBoundingRect());</a>
<a name="ln75">            dropTarget = 0;</a>
<a name="ln76">            }</a>
<a name="ln77">      else if (!dropAnchor.isNull()) {</a>
<a name="ln78">            QRectF rf;</a>
<a name="ln79">            rf.setTopLeft(dropAnchor.p1());</a>
<a name="ln80">            rf.setBottomRight(dropAnchor.p2());</a>
<a name="ln81">            _score-&gt;addRefresh(rf.normalized());</a>
<a name="ln82">            dropAnchor = QLineF();</a>
<a name="ln83">            }</a>
<a name="ln84">//      _score-&gt;addRefresh(r);</a>
<a name="ln85">      update();</a>
<a name="ln86">      }</a>
<a name="ln87"> </a>
<a name="ln88">//---------------------------------------------------------</a>
<a name="ln89">//   setDropAnchor</a>
<a name="ln90">//---------------------------------------------------------</a>
<a name="ln91"> </a>
<a name="ln92">void ScoreView::setDropAnchor(const QLineF&amp; l)</a>
<a name="ln93">      {</a>
<a name="ln94">      if (!dropAnchor.isNull()) {</a>
<a name="ln95">            qreal w = 2 / _matrix.m11();</a>
<a name="ln96">            QRectF r;</a>
<a name="ln97">            r.setTopLeft(dropAnchor.p1());</a>
<a name="ln98">            r.setBottomRight(dropAnchor.p2());</a>
<a name="ln99">            r = r.normalized();</a>
<a name="ln100">            r.adjust(-w, -w, 2*w, 2*w);</a>
<a name="ln101">//            _score-&gt;addRefresh(r);</a>
<a name="ln102">            }</a>
<a name="ln103">      if (dropRectangle.isValid()) {</a>
<a name="ln104">//            _score-&gt;addRefresh(dropRectangle);</a>
<a name="ln105">            dropRectangle = QRectF();</a>
<a name="ln106">            }</a>
<a name="ln107">      dropAnchor = l;</a>
<a name="ln108">      if (!dropAnchor.isNull()) {</a>
<a name="ln109">            qreal w = 2 / _matrix.m11();</a>
<a name="ln110">            QRectF r;</a>
<a name="ln111">            r.setTopLeft(dropAnchor.p1());</a>
<a name="ln112">            r.setBottomRight(dropAnchor.p2());</a>
<a name="ln113">            r = r.normalized();</a>
<a name="ln114">            r.adjust(-w, -w, 2*w, 2*w);</a>
<a name="ln115">//            _score-&gt;addRefresh(r);</a>
<a name="ln116">            }</a>
<a name="ln117">      update();</a>
<a name="ln118">      }</a>
<a name="ln119"> </a>
<a name="ln120">//---------------------------------------------------------</a>
<a name="ln121">//   setViewRect</a>
<a name="ln122">//---------------------------------------------------------</a>
<a name="ln123"> </a>
<a name="ln124">void ScoreView::setViewRect(const QRectF&amp; r)</a>
<a name="ln125">      {</a>
<a name="ln126">      QRectF rr = _matrix.mapRect(r);</a>
<a name="ln127">      QPoint d = rr.topLeft().toPoint();</a>
<a name="ln128">      int dx   = -d.x();</a>
<a name="ln129">      int dy   = -d.y();</a>
<a name="ln130">      QApplication::sendPostedEvents(this, 0);</a>
<a name="ln131">      _matrix.setMatrix(_matrix.m11(), _matrix.m12(), _matrix.m13(), _matrix.m21(),</a>
<a name="ln132">         _matrix.m22(), _matrix.m23(), _matrix.dx()+dx, _matrix.dy()+dy, _matrix.m33());</a>
<a name="ln133">      imatrix = _matrix.inverted();</a>
<a name="ln134">      scroll(dx, dy, QRect(0, 0, width(), height()));</a>
<a name="ln135">      emit offsetChanged(_matrix.dx(), _matrix.dy());</a>
<a name="ln136">      if (_continuousPanel-&gt;visible())</a>
<a name="ln137">            update();</a>
<a name="ln138">      }</a>
<a name="ln139"> </a>
<a name="ln140">//---------------------------------------------------------</a>
<a name="ln141">//   dragTimeAnchorElement</a>
<a name="ln142">//    pos is in canvas coordinates</a>
<a name="ln143">//    return true if there is a valid target</a>
<a name="ln144">//---------------------------------------------------------</a>
<a name="ln145"> </a>
<a name="ln146">bool ScoreView::dragTimeAnchorElement(const QPointF&amp; pos)</a>
<a name="ln147">      {</a>
<a name="ln148">      int staffIdx;</a>
<a name="ln149">      Segment* seg;</a>
<a name="ln150">      MeasureBase* mb = _score-&gt;pos2measure(pos, &amp;staffIdx, 0, &amp;seg, 0);</a>
<a name="ln151">      int track  = staffIdx * VOICES;</a>
<a name="ln152"> </a>
<a name="ln153">      if (mb &amp;&amp; mb-&gt;isMeasure() &amp;&amp; seg-&gt;element(track)) {</a>
<a name="ln154">            Measure* m = toMeasure(mb);</a>
<a name="ln155">            System* s  = m-&gt;system();</a>
<a name="ln156">            qreal y    = s-&gt;staff(staffIdx)-&gt;y() + s-&gt;pos().y() + s-&gt;page()-&gt;pos().y();</a>
<a name="ln157">            QPointF anchor(seg-&gt;canvasBoundingRect().x(), y);</a>
<a name="ln158">            setDropAnchor(QLineF(pos, anchor));</a>
<a name="ln159">            editData.dropElement-&gt;score()-&gt;addRefresh(editData.dropElement-&gt;canvasBoundingRect());</a>
<a name="ln160">            editData.dropElement-&gt;setTrack(track);</a>
<a name="ln161">            editData.dropElement-&gt;score()-&gt;addRefresh(editData.dropElement-&gt;canvasBoundingRect());</a>
<a name="ln162">            return true;</a>
<a name="ln163">            }</a>
<a name="ln164">      editData.dropElement-&gt;score()-&gt;addRefresh(editData.dropElement-&gt;canvasBoundingRect());</a>
<a name="ln165">      setDropTarget(0);</a>
<a name="ln166">      return false;</a>
<a name="ln167">      }</a>
<a name="ln168"> </a>
<a name="ln169">//---------------------------------------------------------</a>
<a name="ln170">//   dragMeasureAnchorElement</a>
<a name="ln171">//---------------------------------------------------------</a>
<a name="ln172"> </a>
<a name="ln173">bool ScoreView::dragMeasureAnchorElement(const QPointF&amp; pos)</a>
<a name="ln174">      {</a>
<a name="ln175">      int staffIdx;</a>
<a name="ln176">      Segment* seg;</a>
<a name="ln177">      MeasureBase* mb = _score-&gt;pos2measure(pos, &amp;staffIdx, 0, &amp;seg, 0);</a>
<a name="ln178">      if (!(editData.modifiers &amp; Qt::ControlModifier))</a>
<a name="ln179">            staffIdx = 0;</a>
<a name="ln180">      int track = staffIdx * VOICES;</a>
<a name="ln181"> </a>
<a name="ln182">      if (mb &amp;&amp; mb-&gt;isMeasure()) {</a>
<a name="ln183">            Measure* m = toMeasure(mb);</a>
<a name="ln184">            System* s  = m-&gt;system();</a>
<a name="ln185">            qreal y    = s-&gt;staff(staffIdx)-&gt;y() + s-&gt;pos().y() + s-&gt;page()-&gt;pos().y();</a>
<a name="ln186">            QRectF b(m-&gt;canvasBoundingRect());</a>
<a name="ln187">            if (pos.x() &gt;= (b.x() + b.width() * .5) &amp;&amp; m != _score-&gt;lastMeasureMM() &amp;&amp; m-&gt;nextMeasure()-&gt;system() == m-&gt;system())</a>
<a name="ln188">                  m = m-&gt;nextMeasure();</a>
<a name="ln189">            QPointF anchor(m-&gt;canvasBoundingRect().x(), y);</a>
<a name="ln190">            setDropAnchor(QLineF(pos, anchor));</a>
<a name="ln191">            editData.dropElement-&gt;score()-&gt;addRefresh(editData.dropElement-&gt;canvasBoundingRect());</a>
<a name="ln192">            editData.dropElement-&gt;setTrack(track);</a>
<a name="ln193">            editData.dropElement-&gt;score()-&gt;addRefresh(editData.dropElement-&gt;canvasBoundingRect());</a>
<a name="ln194">            return true;</a>
<a name="ln195">            }</a>
<a name="ln196">      editData.dropElement-&gt;score()-&gt;addRefresh(editData.dropElement-&gt;canvasBoundingRect());</a>
<a name="ln197">      setDropTarget(0);</a>
<a name="ln198">      return false;</a>
<a name="ln199">      }</a>
<a name="ln200"> </a>
<a name="ln201">//---------------------------------------------------------</a>
<a name="ln202">//   dragEnterEvent</a>
<a name="ln203">//---------------------------------------------------------</a>
<a name="ln204"> </a>
<a name="ln205">void ScoreView::dragEnterEvent(QDragEnterEvent* event)</a>
<a name="ln206">      {</a>
<a name="ln207">      double _spatium = score()-&gt;spatium();</a>
<a name="ln208">      editData.dropElement = 0;</a>
<a name="ln209"> </a>
<a name="ln210">      const QMimeData* dta = event-&gt;mimeData();</a>
<a name="ln211"> </a>
<a name="ln212">      if (dta-&gt;hasFormat(mimeSymbolListFormat) || dta-&gt;hasFormat(mimeStaffListFormat)) {</a>
<a name="ln213">            if (event-&gt;possibleActions() &amp; Qt::CopyAction)</a>
<a name="ln214">                  event-&gt;setDropAction(Qt::CopyAction);</a>
<a name="ln215">            if (event-&gt;dropAction() == Qt::CopyAction)</a>
<a name="ln216">                  event-&gt;accept();</a>
<a name="ln217">            return;</a>
<a name="ln218">            }</a>
<a name="ln219"> </a>
<a name="ln220">      if (dta-&gt;hasFormat(mimeSymbolFormat)) {</a>
<a name="ln221">            if (event-&gt;possibleActions() &amp; Qt::CopyAction)</a>
<a name="ln222">                  event-&gt;setDropAction(Qt::CopyAction);</a>
<a name="ln223">            if (event-&gt;dropAction() == Qt::CopyAction)</a>
<a name="ln224">                  event-&gt;accept();</a>
<a name="ln225"> </a>
<a name="ln226">            mscore-&gt;notifyElementDraggedToScoreView();</a>
<a name="ln227"> </a>
<a name="ln228">            QByteArray a = dta-&gt;data(mimeSymbolFormat);</a>
<a name="ln229"> </a>
<a name="ln230">            if (MScore::debugMode)</a>
<a name="ln231">                  qDebug(&quot;ScoreView::dragEnterEvent Symbol: &lt;%s&gt;&quot;, a.data());</a>
<a name="ln232"> </a>
<a name="ln233">            XmlReader e(a);</a>
<a name="ln234">            editData.dragOffset = QPoint();</a>
<a name="ln235">            Fraction duration;  // dummy</a>
<a name="ln236">            ElementType type = Element::readType(e, &amp;editData.dragOffset, &amp;duration);</a>
<a name="ln237"> </a>
<a name="ln238">            Element* el = Element::create(type, score());</a>
<a name="ln239">            if (el) {</a>
<a name="ln240">                  if (type == ElementType::BAR_LINE || type == ElementType::ARPEGGIO || type == ElementType::BRACKET)</a>
<a name="ln241">                        el-&gt;setHeight(_spatium * 5);</a>
<a name="ln242">                  editData.dropElement = el;</a>
<a name="ln243">                  editData.dropElement-&gt;setParent(0);</a>
<a name="ln244">                  editData.dropElement-&gt;read(e);</a>
<a name="ln245">                  editData.dropElement-&gt;layout();</a>
<a name="ln246">                  }</a>
<a name="ln247">            return;</a>
<a name="ln248">            }</a>
<a name="ln249"> </a>
<a name="ln250">      if (dta-&gt;hasUrls()) {</a>
<a name="ln251">            QList&lt;QUrl&gt;ul = dta-&gt;urls();</a>
<a name="ln252">            QUrl u = ul.front();</a>
<a name="ln253"> </a>
<a name="ln254">            QMimeDatabase db;</a>
<a name="ln255">            if (!QImageReader::supportedMimeTypes().contains(db.mimeTypeForUrl(u).name().toLatin1())) {</a>
<a name="ln256">                  event-&gt;ignore();</a>
<a name="ln257">                  return;</a>
<a name="ln258">                  }</a>
<a name="ln259"> </a>
<a name="ln260">            Image* image = 0;</a>
<a name="ln261">            if (u.scheme() == &quot;file&quot;) {</a>
<a name="ln262">                  QFileInfo fi(u.path());</a>
<a name="ln263">                  image = new Image(score());</a>
<a name="ln264">                  QString str(u.toLocalFile());</a>
<a name="ln265">                  image-&gt;load(str);</a>
<a name="ln266">                  }</a>
<a name="ln267">            else if (u.scheme() == &quot;http&quot; || u.scheme() == &quot;https&quot;) {</a>
<a name="ln268">                  QNetworkAccessManager manager;</a>
<a name="ln269">                  QNetworkReply* reply = manager.get(QNetworkRequest(u));</a>
<a name="ln270"> </a>
<a name="ln271">                  // TODO:</a>
<a name="ln272">                  //    feed progress bar in loop</a>
<a name="ln273">                  //    implement timeout/abort</a>
<a name="ln274"> </a>
<a name="ln275">                  QMutex mutex;</a>
<a name="ln276">                  QWaitCondition wc;</a>
<a name="ln277">                  while (!reply-&gt;isFinished()) {</a>
<a name="ln278">                        mutex.lock();</a>
<a name="ln279">                        wc.wait(&amp;mutex, 100);</a>
<a name="ln280">                        qApp-&gt;processEvents();</a>
<a name="ln281">                        mutex.unlock();</a>
<a name="ln282">                        }</a>
<a name="ln283">                  QByteArray ba = reply-&gt;readAll();</a>
<a name="ln284"> </a>
<a name="ln285">                  image = new Image(score());</a>
<a name="ln286">                  image-&gt;loadFromData(u.path(), ba);</a>
<a name="ln287">                  delete reply;</a>
<a name="ln288">                  }</a>
<a name="ln289">            if (image) {</a>
<a name="ln290">                  editData.dropElement = image;</a>
<a name="ln291">                  editData.dropElement-&gt;setParent(0);</a>
<a name="ln292">                  editData.dropElement-&gt;layout();</a>
<a name="ln293">                  event-&gt;accept();</a>
<a name="ln294">                  }</a>
<a name="ln295">            return;</a>
<a name="ln296">            }</a>
<a name="ln297">      qDebug(&quot;unknown drop format: formats:&quot;);</a>
<a name="ln298">      for (const QString&amp; s : dta-&gt;formats())</a>
<a name="ln299">            qDebug(&quot;  &lt;%s&gt;&quot;, qPrintable(s));</a>
<a name="ln300">      event-&gt;ignore();</a>
<a name="ln301">      }</a>
<a name="ln302"> </a>
<a name="ln303">//---------------------------------------------------------</a>
<a name="ln304">//   getDropTarget</a>
<a name="ln305">//---------------------------------------------------------</a>
<a name="ln306"> </a>
<a name="ln307">Element* ScoreView::getDropTarget(EditData&amp; ed)</a>
<a name="ln308">      {</a>
<a name="ln309">      QList&lt;Element*&gt; el = elementsAt(ed.pos);</a>
<a name="ln310">      setDropTarget(0);</a>
<a name="ln311">      for (Element* e : el) {</a>
<a name="ln312">            if (e-&gt;isStaffLines()) {</a>
<a name="ln313">                  if (el.size() &gt; 2)      // is not first class drop target</a>
<a name="ln314">                        continue;</a>
<a name="ln315">                  e = toStaffLines(e)-&gt;measure();</a>
<a name="ln316">                  }</a>
<a name="ln317">            if (e-&gt;acceptDrop(ed)) {</a>
<a name="ln318">                  if (!e-&gt;isMeasure())</a>
<a name="ln319">                        setDropTarget(e);</a>
<a name="ln320">                  return e;</a>
<a name="ln321">                  }</a>
<a name="ln322">            }</a>
<a name="ln323">      return nullptr;</a>
<a name="ln324">      }</a>
<a name="ln325"> </a>
<a name="ln326">//---------------------------------------------------------</a>
<a name="ln327">//   dragMoveEvent</a>
<a name="ln328">//---------------------------------------------------------</a>
<a name="ln329"> </a>
<a name="ln330">void ScoreView::dragMoveEvent(QDragMoveEvent* event)</a>
<a name="ln331">      {</a>
<a name="ln332">      // we always accept the drop action</a>
<a name="ln333">      // to get a &quot;drop&quot; Event:</a>
<a name="ln334"> </a>
<a name="ln335">      if (MScore::debugMode) {</a>
<a name="ln336">            if (!editData.dropElement)</a>
<a name="ln337">                  qDebug(&quot;no drop element&quot;);</a>
<a name="ln338">            else</a>
<a name="ln339">                  qDebug(&quot;&lt;%s&gt;&quot;, editData.dropElement-&gt;name());</a>
<a name="ln340">            }</a>
<a name="ln341"> </a>
<a name="ln342">      if (!editData.dropElement || mscore-&gt;state() == STATE_PLAY) {  // no editing during play</a>
<a name="ln343">            event-&gt;ignore();</a>
<a name="ln344">            return;</a>
<a name="ln345">            }</a>
<a name="ln346"> </a>
<a name="ln347">      const QMimeData* dta = event-&gt;mimeData();</a>
<a name="ln348">      if (dta-&gt;hasFormat(mimeSymbolFormat)</a>
<a name="ln349">         || dta-&gt;hasFormat(mimeSymbolListFormat)</a>
<a name="ln350">         || dta-&gt;hasFormat(mimeStaffListFormat)) {</a>
<a name="ln351">            if (event-&gt;possibleActions() &amp; Qt::CopyAction)</a>
<a name="ln352">                  event-&gt;setDropAction(Qt::CopyAction);</a>
<a name="ln353">            }</a>
<a name="ln354"> </a>
<a name="ln355">      // convert window to canvas position</a>
<a name="ln356">      QPointF pos(imatrix.map(QPointF(event-&gt;pos())));</a>
<a name="ln357">      editData.pos       = pos;</a>
<a name="ln358">      editData.modifiers = event-&gt;keyboardModifiers();</a>
<a name="ln359"> </a>
<a name="ln360">      switch (editData.dropElement-&gt;type()) {</a>
<a name="ln361">            case ElementType::VOLTA:</a>
<a name="ln362">                  event-&gt;setAccepted(dragMeasureAnchorElement(pos));</a>
<a name="ln363">                  break;</a>
<a name="ln364">            case ElementType::PEDAL:</a>
<a name="ln365">            case ElementType::LET_RING:</a>
<a name="ln366">            case ElementType::VIBRATO:</a>
<a name="ln367">            case ElementType::PALM_MUTE:</a>
<a name="ln368">            case ElementType::OTTAVA:</a>
<a name="ln369">            case ElementType::TRILL:</a>
<a name="ln370">            case ElementType::HAIRPIN:</a>
<a name="ln371">            case ElementType::TEXTLINE:</a>
<a name="ln372">                  event-&gt;setAccepted(dragTimeAnchorElement(pos));</a>
<a name="ln373">                  break;</a>
<a name="ln374">            case ElementType::IMAGE:</a>
<a name="ln375">            case ElementType::SYMBOL:</a>
<a name="ln376">            case ElementType::FSYMBOL:</a>
<a name="ln377">            case ElementType::DYNAMIC:</a>
<a name="ln378">            case ElementType::KEYSIG:</a>
<a name="ln379">            case ElementType::CLEF:</a>
<a name="ln380">            case ElementType::TIMESIG:</a>
<a name="ln381">            case ElementType::BAR_LINE:</a>
<a name="ln382">            case ElementType::ARPEGGIO:</a>
<a name="ln383">            case ElementType::BREATH:</a>
<a name="ln384">            case ElementType::GLISSANDO:</a>
<a name="ln385">            case ElementType::BRACKET:</a>
<a name="ln386">            case ElementType::ARTICULATION:</a>
<a name="ln387">            case ElementType::FERMATA:</a>
<a name="ln388">            case ElementType::CHORDLINE:</a>
<a name="ln389">            case ElementType::BEND:</a>
<a name="ln390">            case ElementType::ACCIDENTAL:</a>
<a name="ln391">            case ElementType::TEXT:</a>
<a name="ln392">            case ElementType::FINGERING:</a>
<a name="ln393">            case ElementType::TEMPO_TEXT:</a>
<a name="ln394">            case ElementType::STAFF_TEXT:</a>
<a name="ln395">            case ElementType::SYSTEM_TEXT:</a>
<a name="ln396">            case ElementType::NOTEHEAD:</a>
<a name="ln397">            case ElementType::TREMOLO:</a>
<a name="ln398">            case ElementType::LAYOUT_BREAK:</a>
<a name="ln399">            case ElementType::MARKER:</a>
<a name="ln400">            case ElementType::STAFF_STATE:</a>
<a name="ln401">            case ElementType::INSTRUMENT_CHANGE:</a>
<a name="ln402">            case ElementType::REHEARSAL_MARK:</a>
<a name="ln403">            case ElementType::JUMP:</a>
<a name="ln404">            case ElementType::REPEAT_MEASURE:</a>
<a name="ln405">            case ElementType::ICON:</a>
<a name="ln406">            case ElementType::CHORD:</a>
<a name="ln407">            case ElementType::SPACER:</a>
<a name="ln408">            case ElementType::SLUR:</a>
<a name="ln409">            case ElementType::HARMONY:</a>
<a name="ln410">            case ElementType::BAGPIPE_EMBELLISHMENT:</a>
<a name="ln411">            case ElementType::AMBITUS:</a>
<a name="ln412">            case ElementType::TREMOLOBAR:</a>
<a name="ln413">            case ElementType::FIGURED_BASS:</a>
<a name="ln414">            case ElementType::LYRICS:</a>
<a name="ln415">            case ElementType::FRET_DIAGRAM:</a>
<a name="ln416">            case ElementType::STAFFTYPE_CHANGE:</a>
<a name="ln417">                  event-&gt;setAccepted(getDropTarget(editData));</a>
<a name="ln418">                  break;</a>
<a name="ln419">            default:</a>
<a name="ln420">                  if (MScore::debugMode)</a>
<a name="ln421">                        qDebug(&quot;no target&quot;);</a>
<a name="ln422">                  event-&gt;ignore();</a>
<a name="ln423">                  break;</a>
<a name="ln424">            }</a>
<a name="ln425">      }</a>
<a name="ln426"> </a>
<a name="ln427">//---------------------------------------------------------</a>
<a name="ln428">//   dropEvent</a>
<a name="ln429">//---------------------------------------------------------</a>
<a name="ln430"> </a>
<a name="ln431">void ScoreView::dropEvent(QDropEvent* event)</a>
<a name="ln432">      {</a>
<a name="ln433">      if (state == ViewState::PLAY) {</a>
<a name="ln434">            event-&gt;ignore();</a>
<a name="ln435">            return;</a>
<a name="ln436">            }</a>
<a name="ln437">      QPointF pos(imatrix.map(QPointF(event-&gt;pos())));</a>
<a name="ln438"> </a>
<a name="ln439">      editData.pos       = pos;</a>
<a name="ln440">      editData.modifiers = event-&gt;keyboardModifiers();</a>
<a name="ln441"> </a>
<a name="ln442">      if (editData.dropElement) {</a>
<a name="ln443">            bool firstStaffOnly = false;</a>
<a name="ln444">            bool applyUserOffset = false;</a>
<a name="ln445">            bool triggerSpannerDropApplyTour = editData.dropElement-&gt;isSpanner();</a>
<a name="ln446">            editData.dropElement-&gt;styleChanged();</a>
<a name="ln447">            _score-&gt;startCmd();</a>
<a name="ln448">            Q_ASSERT(editData.dropElement-&gt;score() == score());</a>
<a name="ln449">            _score-&gt;addRefresh(editData.dropElement-&gt;canvasBoundingRect());</a>
<a name="ln450">            switch (editData.dropElement-&gt;type()) {</a>
<a name="ln451">                  case ElementType::VOLTA:</a>
<a name="ln452">                        // voltas drop to first staff by default, or closest staff if Control is held</a>
<a name="ln453">                        firstStaffOnly = !(editData.modifiers &amp; Qt::ControlModifier);</a>
<a name="ln454">                        // fall-thru</a>
<a name="ln455">                  case ElementType::OTTAVA:</a>
<a name="ln456">                  case ElementType::TRILL:</a>
<a name="ln457">                  case ElementType::PEDAL:</a>
<a name="ln458">                  case ElementType::LET_RING:</a>
<a name="ln459">                  case ElementType::VIBRATO:</a>
<a name="ln460">                  case ElementType::PALM_MUTE:</a>
<a name="ln461">                  case ElementType::HAIRPIN:</a>
<a name="ln462">                  case ElementType::TEXTLINE:</a>
<a name="ln463">                        {</a>
<a name="ln464">                        Spanner* spanner = static_cast&lt;Spanner*&gt;(editData.dropElement);</a>
<a name="ln465">                        score()-&gt;cmdAddSpanner(spanner, pos, firstStaffOnly);</a>
<a name="ln466">                        score()-&gt;setUpdateAll();</a>
<a name="ln467">                        event-&gt;acceptProposedAction();</a>
<a name="ln468">                        }</a>
<a name="ln469">                        break;</a>
<a name="ln470">                  case ElementType::SYMBOL:</a>
<a name="ln471">                  case ElementType::FSYMBOL:</a>
<a name="ln472">                  case ElementType::IMAGE:</a>
<a name="ln473">                        applyUserOffset = true;</a>
<a name="ln474">                        // fall-thru</a>
<a name="ln475">                  case ElementType::DYNAMIC:</a>
<a name="ln476">                  case ElementType::FRET_DIAGRAM:</a>
<a name="ln477">                  case ElementType::HARMONY:</a>
<a name="ln478">                        {</a>
<a name="ln479">                        Element* el = elementAt(pos);</a>
<a name="ln480">                        if (el == 0 || el-&gt;type() == ElementType::STAFF_LINES) {</a>
<a name="ln481">                              int staffIdx;</a>
<a name="ln482">                              Segment* seg;</a>
<a name="ln483">                              QPointF offset;</a>
<a name="ln484">                              el = _score-&gt;pos2measure(pos, &amp;staffIdx, 0, &amp;seg, &amp;offset);</a>
<a name="ln485">                              if (el &amp;&amp; el-&gt;isMeasure()) {</a>
<a name="ln486">                                    editData.dropElement-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln487">                                    editData.dropElement-&gt;setParent(seg);</a>
<a name="ln488">                                    if (applyUserOffset)</a>
<a name="ln489">                                          editData.dropElement-&gt;setOffset(offset);</a>
<a name="ln490">                                    score()-&gt;undoAddElement(editData.dropElement);</a>
<a name="ln491">                                    }</a>
<a name="ln492">                              else {</a>
<a name="ln493">                                    qDebug(&quot;cannot drop here&quot;);</a>
<a name="ln494">                                    delete editData.dropElement;</a>
<a name="ln495">                                    }</a>
<a name="ln496">                              }</a>
<a name="ln497">                        else {</a>
<a name="ln498">                              _score-&gt;addRefresh(el-&gt;canvasBoundingRect());</a>
<a name="ln499">                              _score-&gt;addRefresh(editData.dropElement-&gt;canvasBoundingRect());</a>
<a name="ln500"> </a>
<a name="ln501">                              if (!el-&gt;acceptDrop(editData)) {</a>
<a name="ln502">                                    qDebug(&quot;drop %s onto %s not accepted&quot;, editData.dropElement-&gt;name(), el-&gt;name());</a>
<a name="ln503">                                    break;</a>
<a name="ln504">                                    }</a>
<a name="ln505">                              Element* dropElement = el-&gt;drop(editData);</a>
<a name="ln506">                              _score-&gt;addRefresh(el-&gt;canvasBoundingRect());</a>
<a name="ln507">                              if (dropElement) {</a>
<a name="ln508">                                    _score-&gt;select(dropElement, SelectType::SINGLE, 0);</a>
<a name="ln509">                                    _score-&gt;addRefresh(dropElement-&gt;canvasBoundingRect());</a>
<a name="ln510">                                    }</a>
<a name="ln511">                              }</a>
<a name="ln512">                        }</a>
<a name="ln513">                        event-&gt;acceptProposedAction();</a>
<a name="ln514">                        break;</a>
<a name="ln515">                  case ElementType::HBOX:</a>
<a name="ln516">                  case ElementType::VBOX:</a>
<a name="ln517">                  case ElementType::KEYSIG:</a>
<a name="ln518">                  case ElementType::CLEF:</a>
<a name="ln519">                  case ElementType::TIMESIG:</a>
<a name="ln520">                  case ElementType::BAR_LINE:</a>
<a name="ln521">                  case ElementType::ARPEGGIO:</a>
<a name="ln522">                  case ElementType::BREATH:</a>
<a name="ln523">                  case ElementType::GLISSANDO:</a>
<a name="ln524">                  case ElementType::BRACKET:</a>
<a name="ln525">                  case ElementType::ARTICULATION:</a>
<a name="ln526">                  case ElementType::FERMATA:</a>
<a name="ln527">                  case ElementType::CHORDLINE:</a>
<a name="ln528">                  case ElementType::BEND:</a>
<a name="ln529">                  case ElementType::ACCIDENTAL:</a>
<a name="ln530">                  case ElementType::TEXT:</a>
<a name="ln531">                  case ElementType::FINGERING:</a>
<a name="ln532">                  case ElementType::TEMPO_TEXT:</a>
<a name="ln533">                  case ElementType::STAFF_TEXT:</a>
<a name="ln534">                  case ElementType::SYSTEM_TEXT:</a>
<a name="ln535">                  case ElementType::NOTEHEAD:</a>
<a name="ln536">                  case ElementType::TREMOLO:</a>
<a name="ln537">                  case ElementType::LAYOUT_BREAK:</a>
<a name="ln538">                  case ElementType::MARKER:</a>
<a name="ln539">                  case ElementType::STAFF_STATE:</a>
<a name="ln540">                  case ElementType::INSTRUMENT_CHANGE:</a>
<a name="ln541">                  case ElementType::REHEARSAL_MARK:</a>
<a name="ln542">                  case ElementType::JUMP:</a>
<a name="ln543">                  case ElementType::REPEAT_MEASURE:</a>
<a name="ln544">                  case ElementType::ICON:</a>
<a name="ln545">                  case ElementType::NOTE:</a>
<a name="ln546">                  case ElementType::CHORD:</a>
<a name="ln547">                  case ElementType::SPACER:</a>
<a name="ln548">                  case ElementType::SLUR:</a>
<a name="ln549">                  case ElementType::BAGPIPE_EMBELLISHMENT:</a>
<a name="ln550">                  case ElementType::AMBITUS:</a>
<a name="ln551">                  case ElementType::TREMOLOBAR:</a>
<a name="ln552">                  case ElementType::FIGURED_BASS:</a>
<a name="ln553">                  case ElementType::LYRICS:</a>
<a name="ln554">                  case ElementType::STAFFTYPE_CHANGE: {</a>
<a name="ln555">                        Element* el = getDropTarget(editData);</a>
<a name="ln556">                        if (!el) {</a>
<a name="ln557">                              if (!dropCanvas(editData.dropElement)) {</a>
<a name="ln558">                                    qDebug(&quot;cannot drop %s(%p) to canvas&quot;, editData.dropElement-&gt;name(), editData.dropElement);</a>
<a name="ln559">                                    delete editData.dropElement;</a>
<a name="ln560">                                    }</a>
<a name="ln561">                              break;</a>
<a name="ln562">                              }</a>
<a name="ln563">                        _score-&gt;addRefresh(el-&gt;canvasBoundingRect());</a>
<a name="ln564"> </a>
<a name="ln565">                        // HACK ALERT!</a>
<a name="ln566">                        if (el-&gt;isMeasure() &amp;&amp; editData.dropElement-&gt;isLayoutBreak()) {</a>
<a name="ln567">                              Measure* m = toMeasure(el);</a>
<a name="ln568">                              if (m-&gt;isMMRest())</a>
<a name="ln569">                                    el = m-&gt;mmRestLast();</a>
<a name="ln570">                              }</a>
<a name="ln571"> </a>
<a name="ln572">                        Element* dropElement = el-&gt;drop(editData);</a>
<a name="ln573">                        _score-&gt;addRefresh(el-&gt;canvasBoundingRect());</a>
<a name="ln574">                        if (dropElement) {</a>
<a name="ln575">                              if (!_score-&gt;noteEntryMode())</a>
<a name="ln576">                                    _score-&gt;select(dropElement, SelectType::SINGLE, 0);</a>
<a name="ln577">                              _score-&gt;addRefresh(dropElement-&gt;canvasBoundingRect());</a>
<a name="ln578">                              }</a>
<a name="ln579">                        event-&gt;acceptProposedAction();</a>
<a name="ln580">                        }</a>
<a name="ln581">                        break;</a>
<a name="ln582">                  default:</a>
<a name="ln583">                        delete editData.dropElement;</a>
<a name="ln584">                        break;</a>
<a name="ln585">                  }</a>
<a name="ln586">            editData.dropElement = 0;</a>
<a name="ln587">            setDropTarget(0); // this also resets dropRectangle and dropAnchor</a>
<a name="ln588">            score()-&gt;endCmd();</a>
<a name="ln589">            // update input cursor position (must be done after layout)</a>
<a name="ln590">            if (noteEntryMode())</a>
<a name="ln591">                  moveCursor();</a>
<a name="ln592">            if (triggerSpannerDropApplyTour)</a>
<a name="ln593">                  TourHandler::startTour(&quot;spanner-drop-apply&quot;);</a>
<a name="ln594">            return;</a>
<a name="ln595">            }</a>
<a name="ln596"> </a>
<a name="ln597">      editData.dropElement = 0;</a>
<a name="ln598">      const QMimeData* md = event-&gt;mimeData();</a>
<a name="ln599">      QByteArray dta;</a>
<a name="ln600">      ElementType etype;</a>
<a name="ln601">      if (md-&gt;hasFormat(mimeSymbolListFormat)) {</a>
<a name="ln602">            etype = ElementType::ELEMENT_LIST;</a>
<a name="ln603">            dta = md-&gt;data(mimeSymbolListFormat);</a>
<a name="ln604">            }</a>
<a name="ln605">      else if (md-&gt;hasFormat(mimeStaffListFormat)) {</a>
<a name="ln606">            etype = ElementType::STAFF_LIST;</a>
<a name="ln607">            dta = md-&gt;data(mimeStaffListFormat);</a>
<a name="ln608">            }</a>
<a name="ln609">      else {</a>
<a name="ln610">            qDebug(&quot;cannot drop this object: unknown mime type&quot;);</a>
<a name="ln611">            QStringList sl = md-&gt;formats();</a>
<a name="ln612">            for (const QString&amp; s : sl)</a>
<a name="ln613">                  qDebug(&quot;  %s&quot;, qPrintable(s));</a>
<a name="ln614">            _score-&gt;update();</a>
<a name="ln615">            return;</a>
<a name="ln616">            }</a>
<a name="ln617"> </a>
<a name="ln618">qDebug(&quot;drop &lt;%s&gt;&quot;, dta.data());</a>
<a name="ln619"> </a>
<a name="ln620">      Element* el = elementAt(pos);</a>
<a name="ln621">      if (el == 0 || el-&gt;type() != ElementType::MEASURE) {</a>
<a name="ln622">            setDropTarget(0);</a>
<a name="ln623">            return;</a>
<a name="ln624">            }</a>
<a name="ln625">      Measure* measure = (Measure*) el;</a>
<a name="ln626"> </a>
<a name="ln627">      if (etype == ElementType::ELEMENT_LIST) {</a>
<a name="ln628">            qDebug(&quot;drop element list&quot;);</a>
<a name="ln629">            }</a>
<a name="ln630">      else if (etype == ElementType::MEASURE_LIST || etype == ElementType::STAFF_LIST) {</a>
<a name="ln631">            _score-&gt;startCmd();</a>
<a name="ln632">            XmlReader xml(dta);</a>
<a name="ln633">            System* s = measure-&gt;system();</a>
<a name="ln634">            int idx   = s-&gt;y2staff(pos.y());</a>
<a name="ln635">            if (idx != -1) {</a>
<a name="ln636">                  Segment* seg = measure-&gt;first();</a>
<a name="ln637">                  // assume there is always a ChordRest segment</a>
<a name="ln638">                  while (!seg-&gt;isChordRestType())</a>
<a name="ln639">                        seg = seg-&gt;next();</a>
<a name="ln640">                  score()-&gt;pasteStaff(xml, seg, idx);</a>
<a name="ln641">                  }</a>
<a name="ln642">            event-&gt;acceptProposedAction();</a>
<a name="ln643">            _score-&gt;endCmd();</a>
<a name="ln644">            }</a>
<a name="ln645">      setDropTarget(0); // this also resets dropRectangle and dropAnchor</a>
<a name="ln646">      }</a>
<a name="ln647"> </a>
<a name="ln648">//---------------------------------------------------------</a>
<a name="ln649">//   dragLeaveEvent</a>
<a name="ln650">//---------------------------------------------------------</a>
<a name="ln651"> </a>
<a name="ln652">void ScoreView::dragLeaveEvent(QDragLeaveEvent*)</a>
<a name="ln653">      {</a>
<a name="ln654">      if (editData.dropElement) {</a>
<a name="ln655">            _score-&gt;setUpdateAll();</a>
<a name="ln656">            delete editData.dropElement;</a>
<a name="ln657">            editData.dropElement = 0;</a>
<a name="ln658">            _score-&gt;update();</a>
<a name="ln659">            }</a>
<a name="ln660">      setDropTarget(0);</a>
<a name="ln661">      }</a>
<a name="ln662"> </a>
<a name="ln663">//---------------------------------------------------------</a>
<a name="ln664">//   dropCanvas</a>
<a name="ln665">//---------------------------------------------------------</a>
<a name="ln666"> </a>
<a name="ln667">bool ScoreView::dropCanvas(Element* e)</a>
<a name="ln668">      {</a>
<a name="ln669">      if (e-&gt;isIcon()) {</a>
<a name="ln670">            switch (toIcon(e)-&gt;iconType()) {</a>
<a name="ln671">                  case IconType::VFRAME:</a>
<a name="ln672">                        score()-&gt;insertMeasure(ElementType::VBOX, 0);</a>
<a name="ln673">                        break;</a>
<a name="ln674">                  case IconType::HFRAME:</a>
<a name="ln675">                        score()-&gt;insertMeasure(ElementType::HBOX, 0);</a>
<a name="ln676">                        break;</a>
<a name="ln677">                  case IconType::TFRAME:</a>
<a name="ln678">                        score()-&gt;insertMeasure(ElementType::TBOX, 0);</a>
<a name="ln679">                        break;</a>
<a name="ln680">                  case IconType::FFRAME:</a>
<a name="ln681">                        score()-&gt;insertMeasure(ElementType::FBOX, 0);</a>
<a name="ln682">                        break;</a>
<a name="ln683">                  case IconType::MEASURE:</a>
<a name="ln684">                        score()-&gt;insertMeasure(ElementType::MEASURE, 0);</a>
<a name="ln685">                        break;</a>
<a name="ln686">                  default:</a>
<a name="ln687">                        return false;</a>
<a name="ln688">                  }</a>
<a name="ln689">            delete e;</a>
<a name="ln690">            return true;</a>
<a name="ln691">            }</a>
<a name="ln692">      return false;</a>
<a name="ln693">      }</a>
<a name="ln694"> </a>
<a name="ln695">}</a>
<a name="ln696"> </a>

</code></pre>
<div class="balloon" rel="231"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="299"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="339"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="597"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1048/" target="_blank">V1048</a> The 'editData.dropElement' variable was assigned the same value.</p></div>
<div class="balloon" rel="613"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="618"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="630"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v560/" target="_blank">V560</a> A part of conditional expression is always false: etype == ElementType::MEASURE_LIST.</p></div>
<div class="balloon" rel="630"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v560/" target="_blank">V560</a> A part of conditional expression is always true: etype == ElementType::STAFF_LIST.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
