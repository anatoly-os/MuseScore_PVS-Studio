
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>events.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2017 Werner Schweer &amp; others</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;scoreview.h&quot;</a>
<a name="ln14">#include &quot;magbox.h&quot;</a>
<a name="ln15">#include &quot;musescore.h&quot;</a>
<a name="ln16">#include &quot;seq.h&quot;</a>
<a name="ln17">#include &quot;texttools.h&quot;</a>
<a name="ln18">#include &quot;fotomode.h&quot;</a>
<a name="ln19">#include &quot;tourhandler.h&quot;</a>
<a name="ln20">#include &quot;scoreaccessibility.h&quot;</a>
<a name="ln21">#include &quot;libmscore/score.h&quot;</a>
<a name="ln22">#include &quot;libmscore/keysig.h&quot;</a>
<a name="ln23">#include &quot;libmscore/segment.h&quot;</a>
<a name="ln24">#include &quot;libmscore/utils.h&quot;</a>
<a name="ln25">#include &quot;libmscore/text.h&quot;</a>
<a name="ln26">#include &quot;libmscore/measure.h&quot;</a>
<a name="ln27">#include &quot;libmscore/stafflines.h&quot;</a>
<a name="ln28">#include &quot;libmscore/chord.h&quot;</a>
<a name="ln29">#include &quot;libmscore/shadownote.h&quot;</a>
<a name="ln30">#include &quot;libmscore/repeatlist.h&quot;</a>
<a name="ln31">#include &quot;libmscore/select.h&quot;</a>
<a name="ln32">#include &quot;libmscore/staff.h&quot;</a>
<a name="ln33"> </a>
<a name="ln34">namespace Ms {</a>
<a name="ln35"> </a>
<a name="ln36">//---------------------------------------------------------</a>
<a name="ln37">//   event</a>
<a name="ln38">//---------------------------------------------------------</a>
<a name="ln39"> </a>
<a name="ln40">bool ScoreView::event(QEvent* event)</a>
<a name="ln41">      {</a>
<a name="ln42">      switch (event-&gt;type()) {</a>
<a name="ln43">            case QEvent::KeyPress: {</a>
<a name="ln44">                  QKeyEvent* ke = static_cast&lt;QKeyEvent*&gt;(event);</a>
<a name="ln45">                  const int key = ke-&gt;key();</a>
<a name="ln46">                  if (key != Qt::Key_Tab &amp;&amp; key != Qt::Key_Backtab)</a>
<a name="ln47">                        break;</a>
<a name="ln48"> </a>
<a name="ln49">                  if (textEditMode()) {</a>
<a name="ln50">                        // block Tab/Backtab in text editing mode</a>
<a name="ln51">                        return true;</a>
<a name="ln52">                        }</a>
<a name="ln53"> </a>
<a name="ln54">                  if (hasEditGrips() || editMode()) {</a>
<a name="ln55">                        if (ke-&gt;key() == Qt::Key_Tab)</a>
<a name="ln56">                              editData.element-&gt;nextGrip(editData);</a>
<a name="ln57">                        else</a>
<a name="ln58">                              editData.element-&gt;prevGrip(editData);</a>
<a name="ln59">                        updateGrips();</a>
<a name="ln60">                        _score-&gt;update();</a>
<a name="ln61">                        return true;</a>
<a name="ln62">                        }</a>
<a name="ln63">                  }</a>
<a name="ln64">                  break;</a>
<a name="ln65">            case QEvent::ShortcutOverride: {</a>
<a name="ln66">                  QKeyEvent* ke = static_cast&lt;QKeyEvent*&gt;(event);</a>
<a name="ln67">                  switch (ke-&gt;key()) {</a>
<a name="ln68">                        case Qt::Key_Left:</a>
<a name="ln69">                        case Qt::Key_Right:</a>
<a name="ln70">                        case Qt::Key_Up:</a>
<a name="ln71">                        case Qt::Key_Down: {</a>
<a name="ln72">                              if (!hasEditGrips())</a>
<a name="ln73">                                    break;</a>
<a name="ln74">                              const auto m = ke-&gt;modifiers();</a>
<a name="ln75">                              // KeypadModifier is necessary on MacOS as arrow keys seem to always</a>
<a name="ln76">                              // trigger that modifier there. However it would probably be appropriate</a>
<a name="ln77">                              // to allow it on other systems too.</a>
<a name="ln78">                              const auto allowedModifiers = (editData.curGrip == Grip::NO_GRIP)</a>
<a name="ln79">                                 ? (Qt::KeypadModifier | Qt::ShiftModifier)</a>
<a name="ln80">                                 : (Qt::KeypadModifier | Qt::ShiftModifier | Qt::ControlModifier);</a>
<a name="ln81">                              if ((m &amp; ~allowedModifiers) == 0) {</a>
<a name="ln82">                                    ke-&gt;accept();</a>
<a name="ln83">                                    return true;</a>
<a name="ln84">                                    }</a>
<a name="ln85">                              }</a>
<a name="ln86">                              break;</a>
<a name="ln87">                        default:</a>
<a name="ln88">                              break;</a>
<a name="ln89">                        }</a>
<a name="ln90">                  }</a>
<a name="ln91">                  break;</a>
<a name="ln92">            case QEvent::Gesture:</a>
<a name="ln93">                  return gestureEvent(static_cast&lt;QGestureEvent*&gt;(event));</a>
<a name="ln94">            case QEvent::MouseButtonPress:</a>
<a name="ln95">                  if (qApp-&gt;focusWidget() != this) {</a>
<a name="ln96">                        QMouseEvent* me = static_cast&lt;QMouseEvent*&gt;(event);</a>
<a name="ln97">                        if (me-&gt;button() == Qt::LeftButton)</a>
<a name="ln98">                              this-&gt;setFocus();</a>
<a name="ln99">                        }</a>
<a name="ln100">                  break;</a>
<a name="ln101">            default:</a>
<a name="ln102">                  break;</a>
<a name="ln103">            }</a>
<a name="ln104"> </a>
<a name="ln105">      return QWidget::event(event);</a>
<a name="ln106">      }</a>
<a name="ln107"> </a>
<a name="ln108">//---------------------------------------------------------</a>
<a name="ln109">//   gestureEvent</a>
<a name="ln110">//    fired on touchscreen gestures as well as Mac touchpad gestures</a>
<a name="ln111">//---------------------------------------------------------</a>
<a name="ln112"> </a>
<a name="ln113">bool ScoreView::gestureEvent(QGestureEvent *event)</a>
<a name="ln114">      {</a>
<a name="ln115">      if (QGesture *gesture = event-&gt;gesture(Qt::PinchGesture)) {</a>
<a name="ln116">            // Zoom in/out when receiving a pinch gesture</a>
<a name="ln117">            QPinchGesture *pinch = static_cast&lt;QPinchGesture *&gt;(gesture);</a>
<a name="ln118"> </a>
<a name="ln119">            static qreal magStart = 1.0;</a>
<a name="ln120">            if (pinch-&gt;state() == Qt::GestureStarted) {</a>
<a name="ln121">                  magStart = lmag();</a>
<a name="ln122">                  }</a>
<a name="ln123">            if (pinch-&gt;changeFlags() &amp; QPinchGesture::ScaleFactorChanged) {</a>
<a name="ln124">                  // On Windows, totalScaleFactor() contains the net magnification.</a>
<a name="ln125">                  // On OS X, totalScaleFactor() is 1, and scaleFactor() contains the net magnification.</a>
<a name="ln126">                  qreal value = pinch-&gt;totalScaleFactor();</a>
<a name="ln127">                  if (value == 1) {</a>
<a name="ln128">                        value = pinch-&gt;scaleFactor();</a>
<a name="ln129">                        }</a>
<a name="ln130">                  zoom(magStart*value, pinch-&gt;centerPoint());</a>
<a name="ln131">                  }</a>
<a name="ln132">            }</a>
<a name="ln133">      return true;</a>
<a name="ln134">      }</a>
<a name="ln135"> </a>
<a name="ln136">//---------------------------------------------------------</a>
<a name="ln137">//   wheelEvent</a>
<a name="ln138">//---------------------------------------------------------</a>
<a name="ln139"> </a>
<a name="ln140">void ScoreView::wheelEvent(QWheelEvent* event)</a>
<a name="ln141">       {</a>
<a name="ln142">#define PIXELSSTEPSFACTOR 5</a>
<a name="ln143"> </a>
<a name="ln144">      QPoint pixelsScrolled = event-&gt;pixelDelta();</a>
<a name="ln145">      QPoint stepsScrolled  = event-&gt;angleDelta();</a>
<a name="ln146"> </a>
<a name="ln147">      int dx = 0, dy = 0, n = 0;</a>
<a name="ln148">      qreal nReal = 0.0;</a>
<a name="ln149"> </a>
<a name="ln150">      if (!pixelsScrolled.isNull()) {</a>
<a name="ln151">            dx = pixelsScrolled.x();</a>
<a name="ln152">            dy = pixelsScrolled.y();</a>
<a name="ln153">            nReal = static_cast&lt;qreal&gt;(dy) / PIXELSSTEPSFACTOR;</a>
<a name="ln154">            }</a>
<a name="ln155">      else if (!stepsScrolled.isNull()) {</a>
<a name="ln156">            dx = static_cast&lt;qreal&gt;(stepsScrolled.x()) * qMax(2, width() / 10) / 120;</a>
<a name="ln157">            dy = static_cast&lt;qreal&gt;(stepsScrolled.y()) * qMax(2, height() / 10) / 120;</a>
<a name="ln158">            nReal = static_cast&lt;qreal&gt;(stepsScrolled.y()) / 120;</a>
<a name="ln159">            }</a>
<a name="ln160"> </a>
<a name="ln161">      n = static_cast&lt;int&gt;(nReal);</a>
<a name="ln162"> </a>
<a name="ln163">      //this functionality seems currently blocked by the context menu</a>
<a name="ln164">      if (event-&gt;buttons() &amp; Qt::RightButton) {</a>
<a name="ln165">            bool up = n &gt; 0;</a>
<a name="ln166">            if (!up)</a>
<a name="ln167">                  n = -n;</a>
<a name="ln168">            score()-&gt;startCmd();</a>
<a name="ln169">            for (int i = 0; i &lt; n; ++i)</a>
<a name="ln170">                  score()-&gt;upDown(up, UpDownMode::CHROMATIC);</a>
<a name="ln171">            score()-&gt;endCmd();</a>
<a name="ln172">            return;</a>
<a name="ln173">            }</a>
<a name="ln174"> </a>
<a name="ln175">      if (event-&gt;modifiers() &amp; Qt::ControlModifier) { // Windows touch pad pinches also execute this</a>
<a name="ln176">            QApplication::sendPostedEvents(this, 0);</a>
<a name="ln177">            zoomStep(nReal, event-&gt;pos());</a>
<a name="ln178">            return;</a>
<a name="ln179">            }</a>
<a name="ln180"> </a>
<a name="ln181">      //make shift+scroll go horizontally</a>
<a name="ln182">      if (event-&gt;modifiers() &amp; Qt::ShiftModifier &amp;&amp; dx == 0) {</a>
<a name="ln183">            dx = dy;</a>
<a name="ln184">            dy = 0;</a>
<a name="ln185">            }</a>
<a name="ln186"> </a>
<a name="ln187">      if (dx == 0 &amp;&amp; dy == 0)</a>
<a name="ln188">            return;</a>
<a name="ln189"> </a>
<a name="ln190">      constraintCanvas(&amp;dx, &amp;dy);</a>
<a name="ln191"> </a>
<a name="ln192">      _matrix.setMatrix(_matrix.m11(), _matrix.m12(), _matrix.m13(), _matrix.m21(),</a>
<a name="ln193">         _matrix.m22(), _matrix.m23(), _matrix.dx()+dx, _matrix.dy()+dy, _matrix.m33());</a>
<a name="ln194">      imatrix = _matrix.inverted();</a>
<a name="ln195"> </a>
<a name="ln196">      scroll(dx, dy, QRect(0, 0, width(), height()));</a>
<a name="ln197">      emit viewRectChanged();</a>
<a name="ln198">      emit offsetChanged(_matrix.dx(), _matrix.dy());</a>
<a name="ln199">      }</a>
<a name="ln200"> </a>
<a name="ln201">//---------------------------------------------------------</a>
<a name="ln202">//   resizeEvent</a>
<a name="ln203">//---------------------------------------------------------</a>
<a name="ln204"> </a>
<a name="ln205">void ScoreView::resizeEvent(QResizeEvent* /*ev*/)</a>
<a name="ln206">      {</a>
<a name="ln207">      if (_magIdx != MagIdx::MAG_FREE)</a>
<a name="ln208">            setMag(mscore-&gt;getMag(this));</a>
<a name="ln209">      emit sizeChanged();</a>
<a name="ln210"> </a>
<a name="ln211">      // The score may need to be repositioned now.</a>
<a name="ln212">      // So figure out how far it needs to move in each direction...</a>
<a name="ln213">      int dx = 0, dy = 0;</a>
<a name="ln214">      constraintCanvas(&amp;dx, &amp;dy);</a>
<a name="ln215"> </a>
<a name="ln216">      if (dx == 0 &amp;&amp; dy == 0)</a>
<a name="ln217">            return;</a>
<a name="ln218"> </a>
<a name="ln219">      // ...and adjust its position accordingly.</a>
<a name="ln220">      _matrix.setMatrix(_matrix.m11(), _matrix.m12(), _matrix.m13(), _matrix.m21(),</a>
<a name="ln221">         _matrix.m22(), _matrix.m23(), _matrix.dx()+dx, _matrix.dy()+dy, _matrix.m33());</a>
<a name="ln222">      imatrix = _matrix.inverted();</a>
<a name="ln223"> </a>
<a name="ln224">      scroll(dx, dy, QRect(0, 0, width(), height()));</a>
<a name="ln225">      emit viewRectChanged();</a>
<a name="ln226">      emit offsetChanged(_matrix.dx(), _matrix.dy());</a>
<a name="ln227">      }</a>
<a name="ln228"> </a>
<a name="ln229">//---------------------------------------------------------</a>
<a name="ln230">//   focusInEvent</a>
<a name="ln231">//---------------------------------------------------------</a>
<a name="ln232"> </a>
<a name="ln233">void ScoreView::focusInEvent(QFocusEvent* event)</a>
<a name="ln234">      {</a>
<a name="ln235">      if (this != mscore-&gt;currentScoreView())</a>
<a name="ln236">         mscore-&gt;setCurrentScoreView(this);</a>
<a name="ln237"> </a>
<a name="ln238">      if (mscore-&gt;splitScreen()) {</a>
<a name="ln239">            if (!focusFrame) {</a>
<a name="ln240">                  focusFrame = new QFocusFrame;</a>
<a name="ln241">                  QPalette p(focusFrame-&gt;palette());</a>
<a name="ln242">                  p.setColor(QPalette::WindowText, Qt::blue);</a>
<a name="ln243">                  focusFrame-&gt;setPalette(p);</a>
<a name="ln244">                  }</a>
<a name="ln245">            focusFrame-&gt;setWidget(static_cast&lt;QWidget*&gt;(this));</a>
<a name="ln246">            }</a>
<a name="ln247">      if (state == ViewState::NORMAL)</a>
<a name="ln248">            updateEditElement();</a>
<a name="ln249">      QWidget::focusInEvent(event);</a>
<a name="ln250">      }</a>
<a name="ln251"> </a>
<a name="ln252">//---------------------------------------------------------</a>
<a name="ln253">//   focusOutEvent</a>
<a name="ln254">//---------------------------------------------------------</a>
<a name="ln255"> </a>
<a name="ln256">void ScoreView::focusOutEvent(QFocusEvent* event)</a>
<a name="ln257">      {</a>
<a name="ln258">      if (state == ViewState::NORMAL)</a>
<a name="ln259">            setEditElement(nullptr);</a>
<a name="ln260">      if (focusFrame)</a>
<a name="ln261">            focusFrame-&gt;setWidget(0);</a>
<a name="ln262">      QWidget::focusOutEvent(event);</a>
<a name="ln263">      }</a>
<a name="ln264"> </a>
<a name="ln265">//---------------------------------------------------------</a>
<a name="ln266">//   startTextEditingOnMouseRelease</a>
<a name="ln267">//---------------------------------------------------------</a>
<a name="ln268"> </a>
<a name="ln269">bool ScoreView::startTextEditingOnMouseRelease(QMouseEvent* mouseEvent)</a>
<a name="ln270">      {</a>
<a name="ln271">      if (!editData.element || mouseEvent-&gt;button() != Qt::LeftButton)</a>
<a name="ln272">            return false;</a>
<a name="ln273"> </a>
<a name="ln274">      if (!(editData.element-&gt;isEditable() &amp;&amp; editData.element-&gt;isTextBase()))</a>
<a name="ln275">            return false;</a>
<a name="ln276"> </a>
<a name="ln277">      TextBase* textBase = toTextBase(editData.element);</a>
<a name="ln278"> </a>
<a name="ln279">      if (!editData.element-&gt;canvasBoundingRect().contains(toLogical(mouseEvent-&gt;pos()))) {</a>
<a name="ln280">            // mouse up OUTSIDE textbase - clear any priming</a>
<a name="ln281">            textBase-&gt;setPrimed(false);</a>
<a name="ln282">            return false;</a>
<a name="ln283">            }</a>
<a name="ln284"> </a>
<a name="ln285">      if (!textBase-&gt;isPrimed()) {</a>
<a name="ln286">            // mouse up INSIDE textBase - set priming</a>
<a name="ln287">            textBase-&gt;setPrimed(true);</a>
<a name="ln288">            return false;</a>
<a name="ln289">            }</a>
<a name="ln290"> </a>
<a name="ln291">      // mouse up INSIDE primed textBase - start editing</a>
<a name="ln292">      startEditMode(textBase);</a>
<a name="ln293">      setCursor(QCursor(Qt::IBeamCursor));</a>
<a name="ln294">      textBase-&gt;setPrimed(false);</a>
<a name="ln295">      return true;</a>
<a name="ln296">      }</a>
<a name="ln297"> </a>
<a name="ln298">//---------------------------------------------------------</a>
<a name="ln299">//   mouseReleaseEvent</a>
<a name="ln300">//---------------------------------------------------------</a>
<a name="ln301"> </a>
<a name="ln302">void ScoreView::mouseReleaseEvent(QMouseEvent* mouseEvent)</a>
<a name="ln303">      {</a>
<a name="ln304">      editData.buttons = Qt::NoButton;</a>
<a name="ln305">      if (seq)</a>
<a name="ln306">            seq-&gt;stopNoteTimer();</a>
<a name="ln307">      switch (state) {</a>
<a name="ln308">            case ViewState::DRAG:</a>
<a name="ln309">            case ViewState::DRAG_OBJECT:</a>
<a name="ln310">            case ViewState::LASSO:</a>
<a name="ln311">                  changeState(ViewState::NORMAL);</a>
<a name="ln312">                  break;</a>
<a name="ln313">            case ViewState::DRAG_EDIT:</a>
<a name="ln314">                  if (editData.element &amp;&amp; editData.element-&gt;normalModeEditBehavior() == Element::EditBehavior::Edit) {</a>
<a name="ln315">                        changeState(ViewState::NORMAL);</a>
<a name="ln316">                        break;</a>
<a name="ln317">                        }</a>
<a name="ln318">                  changeState(ViewState::EDIT);</a>
<a name="ln319">                  break;</a>
<a name="ln320">            case ViewState::FOTO_DRAG:</a>
<a name="ln321">            case ViewState::FOTO_DRAG_EDIT:</a>
<a name="ln322">            case ViewState::FOTO_DRAG_OBJECT:</a>
<a name="ln323">                  changeState(ViewState::FOTO);</a>
<a name="ln324">                  break;</a>
<a name="ln325">            case ViewState::NORMAL:</a>
<a name="ln326">                  if (startTextEditingOnMouseRelease(mouseEvent))</a>
<a name="ln327">                        break;</a>
<a name="ln328"> </a>
<a name="ln329">                  if (modifySelection) {</a>
<a name="ln330">                        _score-&gt;select(elementToSelect);</a>
<a name="ln331">                        modifySelection = false;</a>
<a name="ln332">                        elementToSelect = nullptr;</a>
<a name="ln333">                        _score-&gt;update();</a>
<a name="ln334">                        mscore-&gt;endCmd();</a>
<a name="ln335">                        }</a>
<a name="ln336">                  break;</a>
<a name="ln337">            case ViewState::EDIT:</a>
<a name="ln338">            case ViewState::NOTE_ENTRY:</a>
<a name="ln339">            case ViewState::PLAY:</a>
<a name="ln340">            case ViewState::ENTRY_PLAY:</a>
<a name="ln341">            case ViewState::FOTO:</a>
<a name="ln342">                  break;</a>
<a name="ln343">            case ViewState::FOTO_LASSO:</a>
<a name="ln344">                  changeState(ViewState::FOTO);</a>
<a name="ln345">                  break;</a>
<a name="ln346">            }</a>
<a name="ln347">      }</a>
<a name="ln348"> </a>
<a name="ln349">//---------------------------------------------------------</a>
<a name="ln350">//   mousePressEventNormal</a>
<a name="ln351">//    handle mouse press event for NORMAL mode</a>
<a name="ln352">//---------------------------------------------------------</a>
<a name="ln353"> </a>
<a name="ln354">void ScoreView::mousePressEventNormal(QMouseEvent* ev)</a>
<a name="ln355">      {</a>
<a name="ln356">      _score-&gt;masterScore()-&gt;cmdState().reset();      // DEBUG: should not be necessary</a>
<a name="ln357">      modifySelection = false;</a>
<a name="ln358">      elementToSelect = nullptr;</a>
<a name="ln359"> </a>
<a name="ln360">      Qt::KeyboardModifiers keyState = ev-&gt;modifiers();</a>
<a name="ln361">      SelectType st = SelectType::SINGLE;</a>
<a name="ln362">      if (keyState == Qt::NoModifier)</a>
<a name="ln363">            st = SelectType::SINGLE;</a>
<a name="ln364">      else if (keyState &amp; Qt::ShiftModifier)</a>
<a name="ln365">            st = SelectType::RANGE;</a>
<a name="ln366">      else if (keyState &amp; Qt::ControlModifier)</a>
<a name="ln367">            st = SelectType::ADD;</a>
<a name="ln368"> </a>
<a name="ln369">      Element* e = editData.element;</a>
<a name="ln370">      if (e) {</a>
<a name="ln371">            if (keyState == (Qt::ShiftModifier | Qt::ControlModifier)) {</a>
<a name="ln372">                  cloneElement(e);</a>
<a name="ln373">                  return;</a>
<a name="ln374">                  }</a>
<a name="ln375">            if (e-&gt;isKeySig() &amp;&amp; (keyState != Qt::ControlModifier) &amp;&amp; st == SelectType::SINGLE) {</a>
<a name="ln376">                  // special case: select for all staves</a>
<a name="ln377">                  Segment* s = toKeySig(e)-&gt;segment();</a>
<a name="ln378">                  bool first = true;</a>
<a name="ln379">                  for (int staffIdx = 0; staffIdx &lt; _score-&gt;nstaves(); ++staffIdx) {</a>
<a name="ln380">                        Element* ee = s-&gt;element(staffIdx * VOICES);</a>
<a name="ln381">                        if (ee) {</a>
<a name="ln382">                              ee-&gt;score()-&gt;select(ee, first ? SelectType::SINGLE : SelectType::ADD);</a>
<a name="ln383">                              first = false;</a>
<a name="ln384">                              }</a>
<a name="ln385">                        }</a>
<a name="ln386">                  }</a>
<a name="ln387">            else {</a>
<a name="ln388">                  if (st == SelectType::ADD) {</a>
<a name="ln389">                        // e is the top element in stacking order,</a>
<a name="ln390">                        // but we want to replace it with &quot;first non-measure element after a selected element&quot;</a>
<a name="ln391">                        // (if such an element exists)</a>
<a name="ln392">                        QList&lt;Element*&gt; ll = elementsNear(editData.startMove);</a>
<a name="ln393">                        bool found = false;</a>
<a name="ln394">                        for (Element* ee : ll) {</a>
<a name="ln395">                              if (found) {</a>
<a name="ln396">                                    e = ee;</a>
<a name="ln397">                                    if (!e-&gt;isMeasure())</a>
<a name="ln398">                                          break;</a>
<a name="ln399">                                    }</a>
<a name="ln400">                              else if (ee-&gt;selected()) {</a>
<a name="ln401">                                    found = true;</a>
<a name="ln402">                                    ee-&gt;score()-&gt;deselect(ee);</a>
<a name="ln403">                                    e = nullptr;</a>
<a name="ln404">                                    }</a>
<a name="ln405">                              }</a>
<a name="ln406">                        }</a>
<a name="ln407">                  if (e) {</a>
<a name="ln408">                        if (!e-&gt;selected())</a>
<a name="ln409">                              e-&gt;score()-&gt;select(e, st, -1);</a>
<a name="ln410">                        else if (st != SelectType::ADD) {</a>
<a name="ln411">                              modifySelection = true;</a>
<a name="ln412">                              elementToSelect = e;</a>
<a name="ln413">                              }</a>
<a name="ln414">                        }</a>
<a name="ln415">                  }</a>
<a name="ln416">            if (e &amp;&amp; e-&gt;isNote()) {</a>
<a name="ln417">                  e-&gt;score()-&gt;updateCapo();</a>
<a name="ln418">                  mscore-&gt;play(e);</a>
<a name="ln419">                  }</a>
<a name="ln420">            if (e) {</a>
<a name="ln421">                  _score = e-&gt;score();</a>
<a name="ln422">                  _score-&gt;setUpdateAll();</a>
<a name="ln423">                  }</a>
<a name="ln424">            }</a>
<a name="ln425">      else {</a>
<a name="ln426">            // special case: check if measure is selected</a>
<a name="ln427">            int staffIdx;</a>
<a name="ln428">            Measure* m = _score-&gt;pos2measure(editData.startMove, &amp;staffIdx, 0, 0, 0);</a>
<a name="ln429">            if (m) {</a>
<a name="ln430">                  QRectF r = m-&gt;staffLines(staffIdx)-&gt;canvasBoundingRect();</a>
<a name="ln431">                  if (_score-&gt;staff(staffIdx)-&gt;lines(m-&gt;tick()) == 1) {</a>
<a name="ln432">                        r.setHeight(m-&gt;spatium() * 2);</a>
<a name="ln433">                        r.translate(0.0, -m-&gt;spatium());</a>
<a name="ln434">                        }</a>
<a name="ln435">                  if (r.contains(editData.startMove)) {</a>
<a name="ln436">                        //TourHandler::startTour(&quot;select-tour&quot;);</a>
<a name="ln437">                        _score-&gt;select(m, st, staffIdx);</a>
<a name="ln438">                        _score-&gt;setUpdateAll();</a>
<a name="ln439">                        }</a>
<a name="ln440">                  else if (st != SelectType::ADD)</a>
<a name="ln441">                        modifySelection = true;</a>
<a name="ln442">                  }</a>
<a name="ln443">            else if (st != SelectType::ADD)</a>
<a name="ln444">                  modifySelection = true;</a>
<a name="ln445">            }</a>
<a name="ln446">      _score-&gt;update();</a>
<a name="ln447">      mscore-&gt;endCmd();</a>
<a name="ln448">      }</a>
<a name="ln449"> </a>
<a name="ln450">//---------------------------------------------------------</a>
<a name="ln451">//   mousePressEvent</a>
<a name="ln452">//---------------------------------------------------------</a>
<a name="ln453"> </a>
<a name="ln454">void ScoreView::mousePressEvent(QMouseEvent* ev)</a>
<a name="ln455">      {</a>
<a name="ln456"> </a>
<a name="ln457">      if (tripleClickPending) {</a>
<a name="ln458">            if (textEditMode()) {</a>
<a name="ln459">                  TextBase* textBase = toTextBase(editData.element);</a>
<a name="ln460">                  textBase-&gt;multiClickSelect(editData, MultiClick::Triple);</a>
<a name="ln461">                  mscore-&gt;textTools()-&gt;updateTools(editData);</a>
<a name="ln462">                  textBase-&gt;endHexState(editData);</a>
<a name="ln463">                  update();</a>
<a name="ln464">                  return;</a>
<a name="ln465">                  }</a>
<a name="ln466">            }</a>
<a name="ln467"> </a>
<a name="ln468">      editData.startMovePixel = ev-&gt;pos();</a>
<a name="ln469">      editData.startMove = toLogical(ev-&gt;pos());</a>
<a name="ln470">      editData.lastPos   = editData.startMove;</a>
<a name="ln471">      editData.pos       = editData.startMove;</a>
<a name="ln472">      editData.buttons   = ev-&gt;buttons();</a>
<a name="ln473">      editData.modifiers = qApp-&gt;keyboardModifiers();</a>
<a name="ln474"> </a>
<a name="ln475">      bool gripFound = false;</a>
<a name="ln476">      if (hasEditGrips() &amp;&amp; ev-&gt;button() == Qt::LeftButton) {</a>
<a name="ln477">            switch (state) {</a>
<a name="ln478">                  case ViewState::NORMAL:</a>
<a name="ln479">                  case ViewState::EDIT:</a>
<a name="ln480">                  case ViewState::FOTO: {</a>
<a name="ln481">                        const qreal a = editData.grip[0].width() * 0.5;</a>
<a name="ln482">                        for (int i = 0; i &lt; editData.grips; ++i) {</a>
<a name="ln483">                              if (editData.grip[i].adjusted(-a, -a, a, a).contains(editData.startMove)) {</a>
<a name="ln484">                                    editData.curGrip = Grip(i);</a>
<a name="ln485">                                    updateGrips();</a>
<a name="ln486">                                    score()-&gt;update();</a>
<a name="ln487">                                    gripFound = true;</a>
<a name="ln488">                                    break;</a>
<a name="ln489">                                    }</a>
<a name="ln490">                              }</a>
<a name="ln491"> </a>
<a name="ln492">                        if (!gripFound)</a>
<a name="ln493">                              editData.curGrip = Grip::NO_GRIP;</a>
<a name="ln494">                        }</a>
<a name="ln495">                        break;</a>
<a name="ln496">                  default:</a>
<a name="ln497">                        break;</a>
<a name="ln498">                  }</a>
<a name="ln499">            }</a>
<a name="ln500"> </a>
<a name="ln501">      switch (state) {</a>
<a name="ln502">            case ViewState::NORMAL: {</a>
<a name="ln503">                  if (gripFound)</a>
<a name="ln504">                        break;</a>
<a name="ln505">                  if (ev-&gt;button() == Qt::RightButton)   // context menu?</a>
<a name="ln506">                        break;</a>
<a name="ln507"> </a>
<a name="ln508">                  if (editData.element</a>
<a name="ln509">                      &amp;&amp; editData.element-&gt;isEditable()</a>
<a name="ln510">                      &amp;&amp; editData.element-&gt;isTextBase()</a>
<a name="ln511">                      &amp;&amp; !editData.element-&gt;canvasBoundingRect().contains(toLogical(ev-&gt;pos()))) {</a>
<a name="ln512">                        // mouse down OUTSIDE of textBase - clear priming -</a>
<a name="ln513">                        toTextBase(editData.element)-&gt;setPrimed(false);</a>
<a name="ln514">                        }</a>
<a name="ln515"> </a>
<a name="ln516">                  setEditElement(elementNear(editData.startMove));</a>
<a name="ln517">                  mousePressEventNormal(ev);</a>
<a name="ln518">                  }</a>
<a name="ln519">                  break;</a>
<a name="ln520"> </a>
<a name="ln521">            case ViewState::FOTO: {</a>
<a name="ln522">                  if (ev-&gt;buttons() &amp; Qt::RightButton)</a>
<a name="ln523">                        break;</a>
<a name="ln524">                  setEditElement(_foto);</a>
<a name="ln525"> </a>
<a name="ln526">                  if (gripFound)</a>
<a name="ln527">                        changeState(ViewState::FOTO_DRAG_EDIT);</a>
<a name="ln528">                  else if (_foto-&gt;canvasBoundingRect().contains(editData.startMove))</a>
<a name="ln529">                        changeState(ViewState::FOTO_DRAG_OBJECT);</a>
<a name="ln530">                  else if (ev-&gt;modifiers() &amp; Qt::ShiftModifier)</a>
<a name="ln531">                        changeState(ViewState::FOTO_LASSO);</a>
<a name="ln532">                  else</a>
<a name="ln533">                        changeState(ViewState::FOTO_DRAG);</a>
<a name="ln534">                  }</a>
<a name="ln535">                  break;</a>
<a name="ln536"> </a>
<a name="ln537">            case ViewState::NOTE_ENTRY: {</a>
<a name="ln538">                  _score-&gt;startCmd();</a>
<a name="ln539">                  bool restMode = _score-&gt;inputState().rest();</a>
<a name="ln540">                  if (ev-&gt;button() == Qt::RightButton)</a>
<a name="ln541">                        _score-&gt;inputState().setRest(!restMode);</a>
<a name="ln542">                  _score-&gt;putNote(editData.startMove, ev-&gt;modifiers() &amp; Qt::ShiftModifier, ev-&gt;modifiers() &amp; Qt::ControlModifier);</a>
<a name="ln543">                  if (ev-&gt;button() == Qt::RightButton)</a>
<a name="ln544">                        _score-&gt;inputState().setRest(restMode);</a>
<a name="ln545">                  _score-&gt;endCmd();</a>
<a name="ln546">                  if (_score-&gt;inputState().cr())</a>
<a name="ln547">                        adjustCanvasPosition(_score-&gt;inputState().cr(), false);</a>
<a name="ln548">                  shadowNote-&gt;setVisible(false);</a>
<a name="ln549">                  }</a>
<a name="ln550">                  break;</a>
<a name="ln551"> </a>
<a name="ln552">            case ViewState::EDIT: {</a>
<a name="ln553">                  if (gripFound)</a>
<a name="ln554">                        break;</a>
<a name="ln555">                  if (!editData.element-&gt;canvasBoundingRect().contains(editData.startMove)) {</a>
<a name="ln556">                        changeState(ViewState::NORMAL);</a>
<a name="ln557">                        // changeState may trigger layout and destroy some elements</a>
<a name="ln558">                        // so we should search elementNear after changeState.</a>
<a name="ln559">                        setEditElement(elementNear(editData.startMove));</a>
<a name="ln560">                        mousePressEventNormal(ev);</a>
<a name="ln561">                        }</a>
<a name="ln562">                  else {</a>
<a name="ln563">                        editData.element-&gt;mousePress(editData);</a>
<a name="ln564">                        score()-&gt;update();</a>
<a name="ln565">                        if (editData.element-&gt;isTextBase() &amp;&amp; mscore-&gt;textTools())</a>
<a name="ln566">                              mscore-&gt;textTools()-&gt;updateTools(editData);</a>
<a name="ln567">                        }</a>
<a name="ln568">                  }</a>
<a name="ln569">                  break;</a>
<a name="ln570"> </a>
<a name="ln571">            case ViewState::PLAY: {</a>
<a name="ln572">                  Element* e = elementNear(editData.startMove);</a>
<a name="ln573">                  if (seq &amp;&amp; e &amp;&amp; (e-&gt;isNote() || e-&gt;isRest())) {</a>
<a name="ln574">                        if (e-&gt;isNote())</a>
<a name="ln575">                              e = e-&gt;parent();</a>
<a name="ln576">                        ChordRest* cr = toChordRest(e);</a>
<a name="ln577">                        seq-&gt;seek(seq-&gt;score()-&gt;repeatList().tick2utick(cr-&gt;tick().ticks()));</a>
<a name="ln578">                        }</a>
<a name="ln579">                  }</a>
<a name="ln580">                  break;</a>
<a name="ln581"> </a>
<a name="ln582">            default:</a>
<a name="ln583">                  qDebug(&quot;mousePressEvent in state %d&quot;, int(state));</a>
<a name="ln584">                  break;</a>
<a name="ln585">            }</a>
<a name="ln586">      }</a>
<a name="ln587"> </a>
<a name="ln588">//---------------------------------------------------------</a>
<a name="ln589">//   adjustCursor</a>
<a name="ln590">//---------------------------------------------------------</a>
<a name="ln591">void ScoreView::adjustCursorForTextEditing(QMouseEvent* mouseEvent)</a>
<a name="ln592">      {</a>
<a name="ln593">      if (!editData.element)</a>
<a name="ln594">            return;</a>
<a name="ln595"> </a>
<a name="ln596">      if (!(state == ViewState::EDIT || state == ViewState::DRAG_EDIT))</a>
<a name="ln597">            return;</a>
<a name="ln598"> </a>
<a name="ln599">      if (!editData.element-&gt;isTextBase())</a>
<a name="ln600">            return;</a>
<a name="ln601"> </a>
<a name="ln602">      if (editData.element-&gt;canvasBoundingRect().contains(toLogical(mouseEvent-&gt;pos())))</a>
<a name="ln603">            setCursor(QCursor(Qt::IBeamCursor));</a>
<a name="ln604">      else</a>
<a name="ln605">            setCursor(QCursor(Qt::ArrowCursor));</a>
<a name="ln606">      }</a>
<a name="ln607"> </a>
<a name="ln608">//---------------------------------------------------------</a>
<a name="ln609">//   mouseMoveEvent</a>
<a name="ln610">//---------------------------------------------------------</a>
<a name="ln611"> </a>
<a name="ln612">void ScoreView::mouseMoveEvent(QMouseEvent* me)</a>
<a name="ln613">      {</a>
<a name="ln614">      adjustCursorForTextEditing(me);</a>
<a name="ln615"> </a>
<a name="ln616">      if (state != ViewState::NOTE_ENTRY &amp;&amp; editData.buttons == Qt::NoButton)</a>
<a name="ln617">            return;</a>
<a name="ln618"> </a>
<a name="ln619">      // start some drag operations after a minimum of movement:</a>
<a name="ln620">      bool drag = (me-&gt;pos() - editData.startMovePixel).manhattanLength() &gt; 4;</a>
<a name="ln621"> </a>
<a name="ln622">      switch (state) {</a>
<a name="ln623">            case ViewState::NORMAL:</a>
<a name="ln624">                  if (!drag)</a>
<a name="ln625">                        return;</a>
<a name="ln626">                  if (!editData.element &amp;&amp; (me-&gt;modifiers() &amp; Qt::ShiftModifier)) {</a>
<a name="ln627">                        changeState(ViewState::LASSO);</a>
<a name="ln628">                        break;</a>
<a name="ln629">                        }</a>
<a name="ln630">                  if (editData.element) {</a>
<a name="ln631">                        if (editData.element-&gt;normalModeEditBehavior() == Element::EditBehavior::Edit &amp;&amp; editData.curGrip != Grip::NO_GRIP) {</a>
<a name="ln632">                              score()-&gt;startCmd();</a>
<a name="ln633">                              editData.element-&gt;startEditDrag(editData);</a>
<a name="ln634">                              changeState(ViewState::DRAG_EDIT);</a>
<a name="ln635">                              break;</a>
<a name="ln636">                              }</a>
<a name="ln637">                        if (editData.element-&gt;isMovable()) {</a>
<a name="ln638">                              if (editData.element-&gt;normalModeEditBehavior() == Element::EditBehavior::Edit)</a>
<a name="ln639">                                    endEdit();</a>
<a name="ln640">                              changeState(ViewState::DRAG_OBJECT);</a>
<a name="ln641">                              break;</a>
<a name="ln642">                              }</a>
<a name="ln643">                        }</a>
<a name="ln644">                  changeState(ViewState::DRAG);</a>
<a name="ln645">                  modifySelection = false;</a>
<a name="ln646">                  break;</a>
<a name="ln647"> </a>
<a name="ln648">            case ViewState::NOTE_ENTRY: {</a>
<a name="ln649">                  QPointF p = toLogical(me-&gt;pos());</a>
<a name="ln650">                  QRectF r(shadowNote-&gt;canvasBoundingRect());</a>
<a name="ln651">                  setShadowNote(p);</a>
<a name="ln652">                  r |= shadowNote-&gt;canvasBoundingRect();</a>
<a name="ln653">                  update(toPhysical(r).adjusted(-2, -2, 2, 2));</a>
<a name="ln654">                  }</a>
<a name="ln655">                  break;</a>
<a name="ln656"> </a>
<a name="ln657">            case ViewState::DRAG:</a>
<a name="ln658">            case ViewState::FOTO_DRAG:</a>
<a name="ln659">                  dragScoreView(me);</a>
<a name="ln660">                  break;</a>
<a name="ln661"> </a>
<a name="ln662">            case ViewState::DRAG_OBJECT:</a>
<a name="ln663">            case ViewState::FOTO_DRAG_OBJECT:</a>
<a name="ln664">                  doDragElement(me);</a>
<a name="ln665">                  break;</a>
<a name="ln666"> </a>
<a name="ln667">            case ViewState::DRAG_EDIT:</a>
<a name="ln668">            case ViewState::FOTO_DRAG_EDIT:</a>
<a name="ln669">                  doDragEdit(me);</a>
<a name="ln670">                  break;</a>
<a name="ln671"> </a>
<a name="ln672">            case ViewState::LASSO:</a>
<a name="ln673">                  doDragLasso(me);</a>
<a name="ln674">                  break;</a>
<a name="ln675"> </a>
<a name="ln676">            case ViewState::EDIT:</a>
<a name="ln677">                  if (!drag)</a>
<a name="ln678">                        return;</a>
<a name="ln679">                  score()-&gt;startCmd();</a>
<a name="ln680">                  editData.element-&gt;startEditDrag(editData);</a>
<a name="ln681">                  changeState(ViewState::DRAG_EDIT);</a>
<a name="ln682">                  break;</a>
<a name="ln683"> </a>
<a name="ln684">            case ViewState::PLAY:</a>
<a name="ln685">                  if (drag)</a>
<a name="ln686">                        dragScoreView(me);</a>
<a name="ln687">                  break;</a>
<a name="ln688"> </a>
<a name="ln689">            case ViewState::FOTO_LASSO:</a>
<a name="ln690">                  doDragFoto(me);</a>
<a name="ln691">                  break;</a>
<a name="ln692"> </a>
<a name="ln693">            default:</a>
<a name="ln694">                  break;</a>
<a name="ln695">            }</a>
<a name="ln696">      update();</a>
<a name="ln697">      }</a>
<a name="ln698"> </a>
<a name="ln699">//---------------------------------------------------------</a>
<a name="ln700">//   tripleClickTimeOut</a>
<a name="ln701">//---------------------------------------------------------</a>
<a name="ln702"> </a>
<a name="ln703">void ScoreView::tripleClickTimeOut()</a>
<a name="ln704">      {</a>
<a name="ln705">      tripleClickPending = false;</a>
<a name="ln706">      }</a>
<a name="ln707"> </a>
<a name="ln708">//---------------------------------------------------------</a>
<a name="ln709">//   mouseDoubleClickEvent</a>
<a name="ln710">//---------------------------------------------------------</a>
<a name="ln711"> </a>
<a name="ln712">void ScoreView::mouseDoubleClickEvent(QMouseEvent* mouseEvent)</a>
<a name="ln713">      {</a>
<a name="ln714">      QTimer::singleShot(QApplication::doubleClickInterval(), this, SLOT(tripleClickTimeOut()));</a>
<a name="ln715">      tripleClickPending = true;</a>
<a name="ln716"> </a>
<a name="ln717">      if (textEditMode()) {</a>
<a name="ln718">            // double click on a textBase element that is being edited - select word</a>
<a name="ln719">            TextBase* textBase = toTextBase(editData.element);</a>
<a name="ln720">            textBase-&gt;multiClickSelect(editData, MultiClick::Double);</a>
<a name="ln721">            mscore-&gt;textTools()-&gt;updateTools(editData);</a>
<a name="ln722">            textBase-&gt;endHexState(editData);</a>
<a name="ln723">            update();</a>
<a name="ln724">            return;</a>
<a name="ln725">            }</a>
<a name="ln726"> </a>
<a name="ln727">      if (state != ViewState::NORMAL)</a>
<a name="ln728">            return;</a>
<a name="ln729"> </a>
<a name="ln730">      Element* clickedElement = elementNear(toLogical(mouseEvent-&gt;pos()));</a>
<a name="ln731"> </a>
<a name="ln732">      if (!(clickedElement &amp;&amp; clickedElement-&gt;isEditable()))</a>
<a name="ln733">            return;</a>
<a name="ln734"> </a>
<a name="ln735">      startEditMode(clickedElement);</a>
<a name="ln736"> </a>
<a name="ln737">      if (clickedElement-&gt;isTextBase()) {</a>
<a name="ln738">            setCursor(QCursor(Qt::IBeamCursor));</a>
<a name="ln739">            toTextBase(clickedElement)-&gt;setPrimed(false);</a>
<a name="ln740">            }</a>
<a name="ln741">      }</a>
<a name="ln742"> </a>
<a name="ln743">//---------------------------------------------------------</a>
<a name="ln744">//   ScoreViewCmdContext</a>
<a name="ln745">//---------------------------------------------------------</a>
<a name="ln746"> </a>
<a name="ln747">class ScoreViewCmdContext {</a>
<a name="ln748">      Score* s;</a>
<a name="ln749">      ScoreView* view;</a>
<a name="ln750">      bool _updateGrips = false;</a>
<a name="ln751"> </a>
<a name="ln752">   public:</a>
<a name="ln753">      ScoreViewCmdContext(ScoreView* v, bool updateGrips)</a>
<a name="ln754">         : s(v-&gt;score()), view(v), _updateGrips(updateGrips)</a>
<a name="ln755">            {</a>
<a name="ln756">            s-&gt;startCmd();</a>
<a name="ln757">            }</a>
<a name="ln758"> </a>
<a name="ln759">      ~ScoreViewCmdContext()</a>
<a name="ln760">            {</a>
<a name="ln761">            s-&gt;endCmd();</a>
<a name="ln762">            if (_updateGrips)</a>
<a name="ln763">                  view-&gt;updateGrips();</a>
<a name="ln764">            }</a>
<a name="ln765">      };</a>
<a name="ln766"> </a>
<a name="ln767">//---------------------------------------------------------</a>
<a name="ln768">//   keyPressEvent</a>
<a name="ln769">//---------------------------------------------------------</a>
<a name="ln770"> </a>
<a name="ln771">void ScoreView::keyPressEvent(QKeyEvent* ev)</a>
<a name="ln772">      {</a>
<a name="ln773">      editData.key       = ev-&gt;key();</a>
<a name="ln774">      editData.modifiers = ev-&gt;modifiers();</a>
<a name="ln775">      editData.s         = ev-&gt;text();</a>
<a name="ln776"> </a>
<a name="ln777">      if (state != ViewState::EDIT) {</a>
<a name="ln778">            const bool shiftModifier = ev-&gt;modifiers() &amp; Qt::ShiftModifier;</a>
<a name="ln779">            if (hasEditGrips() &amp;&amp; !(shiftModifier &amp;&amp; ev-&gt;key() == Qt::Key_Backtab)) {</a>
<a name="ln780">                  switch (ev-&gt;key()) {</a>
<a name="ln781">                        case Qt::Key_Left:</a>
<a name="ln782">                        case Qt::Key_Right:</a>
<a name="ln783">                        case Qt::Key_Up:</a>
<a name="ln784">                        case Qt::Key_Down:</a>
<a name="ln785">                              // Move focus to default grip if arrow keys are pressed and no grip is focused</a>
<a name="ln786">                              if (editData.curGrip == Grip::NO_GRIP)</a>
<a name="ln787">                                    editData.curGrip = editData.element-&gt;defaultGrip();</a>
<a name="ln788">                              break;</a>
<a name="ln789">                        default:</a>
<a name="ln790">                              break;</a>
<a name="ln791">                        }</a>
<a name="ln792"> </a>
<a name="ln793">                  ScoreViewCmdContext ctx(this, /* updateGrips */ true);</a>
<a name="ln794"> </a>
<a name="ln795">                  if (!editData.element-&gt;edit(editData))</a>
<a name="ln796">                        handleArrowKeyPress(ev);</a>
<a name="ln797">                  }</a>
<a name="ln798">            return;</a>
<a name="ln799">            }</a>
<a name="ln800"> </a>
<a name="ln801">      if (MScore::debugMode)</a>
<a name="ln802">            qDebug(&quot;keyPressEvent key 0x%02x(%c) mod 0x%04x &lt;%s&gt; nativeKey 0x%02x scancode %d&quot;,</a>
<a name="ln803">               editData.key, editData.key, int(editData.modifiers), qPrintable(editData.s), ev-&gt;nativeVirtualKey(), ev-&gt;nativeScanCode());</a>
<a name="ln804"> </a>
<a name="ln805">      if (editData.element-&gt;isLyrics()) {</a>
<a name="ln806">            if (editKeyLyrics())</a>
<a name="ln807">                  return;</a>
<a name="ln808">            }</a>
<a name="ln809">      else if (editData.element-&gt;isHarmony()) {</a>
<a name="ln810">            if (editData.key == Qt::Key_Space &amp;&amp; !(editData.modifiers &amp; CONTROL_MODIFIER)) {</a>
<a name="ln811">                  harmonyBeatsTab(true, editData.modifiers &amp; Qt::ShiftModifier);</a>
<a name="ln812">                  return;</a>
<a name="ln813">                  }</a>
<a name="ln814">            }</a>
<a name="ln815">      else if (editData.element-&gt;isFiguredBass()) {</a>
<a name="ln816">            if (editData.key == Qt::Key_Space &amp;&amp; !(editData.modifiers &amp; CONTROL_MODIFIER)) {</a>
<a name="ln817">                  figuredBassTab(false, editData.modifiers &amp; Qt::ShiftModifier);</a>
<a name="ln818">                  return;</a>
<a name="ln819">                  }</a>
<a name="ln820">            }</a>
<a name="ln821">      else if (editData.element-&gt;isSticking()) {</a>
<a name="ln822">            if (editKeySticking())</a>
<a name="ln823">                  return;</a>
<a name="ln824">            }</a>
<a name="ln825"> </a>
<a name="ln826">      ScoreViewCmdContext cc(this, hasEditGrips());</a>
<a name="ln827">      const bool textEdit = textEditMode();</a>
<a name="ln828"> </a>
<a name="ln829">#ifdef Q_OS_WIN // Japenese IME on Windows needs to know when Ctrl/Alt/Shift/CapsLock is pressed while in predit</a>
<a name="ln830">      if (textEdit) {</a>
<a name="ln831">            TextBase* text = toTextBase(editData.element);</a>
<a name="ln832">            if (text-&gt;cursor(editData)-&gt;format()-&gt;preedit() &amp;&amp; QGuiApplication::inputMethod()-&gt;locale().script() == QLocale::JapaneseScript &amp;&amp;</a>
<a name="ln833">                ((editData.key == Qt::Key_Control || (editData.modifiers &amp; Qt::ControlModifier)) ||</a>
<a name="ln834">                 (editData.key == Qt::Key_Alt     || (editData.modifiers &amp; Qt::AltModifier)) ||</a>
<a name="ln835">                 (editData.key == Qt::Key_Shift   || (editData.modifiers &amp; Qt::ShiftModifier)) ||</a>
<a name="ln836">                 (editData.key == Qt::Key_CapsLock))) {</a>
<a name="ln837">                  return; // musescore will ignore this key event so that the IME can handle it</a>
<a name="ln838">                  }</a>
<a name="ln839">            }</a>
<a name="ln840">#endif</a>
<a name="ln841"> </a>
<a name="ln842">      if (!((editData.modifiers &amp; Qt::ShiftModifier) &amp;&amp; (editData.key == Qt::Key_Backtab))) {</a>
<a name="ln843">            if (editData.element-&gt;edit(editData)) {</a>
<a name="ln844">                  if (state != ViewState::EDIT) {</a>
<a name="ln845">                        // textTab or other function may have terminated edit mode</a>
<a name="ln846">                        mscore-&gt;endCmd();</a>
<a name="ln847">                        return;</a>
<a name="ln848">                        }</a>
<a name="ln849">                  if (textEdit)</a>
<a name="ln850">                        mscore-&gt;textTools()-&gt;updateTools(editData);</a>
<a name="ln851">                  return;</a>
<a name="ln852">                  }</a>
<a name="ln853">            }</a>
<a name="ln854"> </a>
<a name="ln855">      const bool handled = handleArrowKeyPress(ev);</a>
<a name="ln856">      if (!handled)</a>
<a name="ln857">            ev-&gt;ignore();</a>
<a name="ln858">      }</a>
<a name="ln859"> </a>
<a name="ln860">//---------------------------------------------------------</a>
<a name="ln861">//   handleArrowKeysPress</a>
<a name="ln862">//---------------------------------------------------------</a>
<a name="ln863"> </a>
<a name="ln864">bool ScoreView::handleArrowKeyPress(const QKeyEvent* ev)</a>
<a name="ln865">      {</a>
<a name="ln866">      QPointF delta;</a>
<a name="ln867">      qreal _spatium = editData.element-&gt;spatium();</a>
<a name="ln868"> </a>
<a name="ln869">      qreal xval, yval;</a>
<a name="ln870">      if (editData.element-&gt;isBeam()) {</a>
<a name="ln871">            xval = 0.25 * _spatium;</a>
<a name="ln872">            if (editData.modifiers &amp; Qt::ControlModifier)</a>
<a name="ln873">                  xval = _spatium;</a>
<a name="ln874">            else if (editData.modifiers &amp; Qt::AltModifier)</a>
<a name="ln875">                  xval = 4 * _spatium;</a>
<a name="ln876">            }</a>
<a name="ln877">      else {</a>
<a name="ln878">            xval = MScore::nudgeStep * _spatium;</a>
<a name="ln879">            if (editData.modifiers &amp; Qt::ControlModifier)</a>
<a name="ln880">                  xval = MScore::nudgeStep10 * _spatium;</a>
<a name="ln881">            else if (editData.modifiers &amp; Qt::AltModifier)</a>
<a name="ln882">                  xval = MScore::nudgeStep50 * _spatium;</a>
<a name="ln883">            }</a>
<a name="ln884">      yval = xval;</a>
<a name="ln885"> </a>
<a name="ln886">      if (mscore-&gt;vRaster()) {</a>
<a name="ln887">            qreal vRaster = _spatium / MScore::vRaster();</a>
<a name="ln888">            if (yval &lt; vRaster)</a>
<a name="ln889">                  yval = vRaster;</a>
<a name="ln890">            }</a>
<a name="ln891">      if (mscore-&gt;hRaster()) {</a>
<a name="ln892">            qreal hRaster = _spatium / MScore::hRaster();</a>
<a name="ln893">            if (xval &lt; hRaster)</a>
<a name="ln894">                  xval = hRaster;</a>
<a name="ln895">            }</a>
<a name="ln896">      // TODO: if raster, then xval/yval should be multiple of raster</a>
<a name="ln897"> </a>
<a name="ln898">      switch (ev-&gt;key()) {</a>
<a name="ln899">            case Qt::Key_Left:</a>
<a name="ln900">                  delta = QPointF(-xval, 0);</a>
<a name="ln901">                  break;</a>
<a name="ln902">            case Qt::Key_Right:</a>
<a name="ln903">                  delta = QPointF(xval, 0);</a>
<a name="ln904">                  break;</a>
<a name="ln905">            case Qt::Key_Up:</a>
<a name="ln906">                  delta = QPointF(0, -yval);</a>
<a name="ln907">                  break;</a>
<a name="ln908">            case Qt::Key_Down:</a>
<a name="ln909">                  delta = QPointF(0, yval);</a>
<a name="ln910">                  break;</a>
<a name="ln911">            default:</a>
<a name="ln912">                  return false;</a>
<a name="ln913">            }</a>
<a name="ln914">      editData.delta   = delta;</a>
<a name="ln915">      editData.hRaster = mscore-&gt;hRaster();</a>
<a name="ln916">      editData.vRaster = mscore-&gt;vRaster();</a>
<a name="ln917">      if (editData.curGrip != Grip::NO_GRIP &amp;&amp; int(editData.curGrip) &lt; editData.grips)</a>
<a name="ln918">            editData.pos = editData.grip[int(editData.curGrip)].center() + delta;</a>
<a name="ln919">      editData.element-&gt;startEditDrag(editData);</a>
<a name="ln920">      editData.element-&gt;editDrag(editData);</a>
<a name="ln921">      editData.element-&gt;endEditDrag(editData);</a>
<a name="ln922">      return true;</a>
<a name="ln923">      }</a>
<a name="ln924"> </a>
<a name="ln925">//---------------------------------------------------------</a>
<a name="ln926">//   keyReleaseEvent</a>
<a name="ln927">//---------------------------------------------------------</a>
<a name="ln928"> </a>
<a name="ln929">void ScoreView::keyReleaseEvent(QKeyEvent* ev)</a>
<a name="ln930">      {</a>
<a name="ln931">      if (textEditMode()) {</a>
<a name="ln932">            auto modifiers = Qt::ControlModifier | Qt::ShiftModifier;</a>
<a name="ln933">            if ((ev-&gt;modifiers() &amp; modifiers) == 0) {</a>
<a name="ln934">                  TextBase* text = toTextBase(editData.element);</a>
<a name="ln935">                  text-&gt;endHexState(editData);</a>
<a name="ln936">                  ev-&gt;accept();</a>
<a name="ln937">                  update();</a>
<a name="ln938">                  }</a>
<a name="ln939">            }</a>
<a name="ln940">      }</a>
<a name="ln941"> </a>
<a name="ln942">//---------------------------------------------------------</a>
<a name="ln943">//   contextPopup</a>
<a name="ln944">//---------------------------------------------------------</a>
<a name="ln945"> </a>
<a name="ln946">void ScoreView::contextMenuEvent(QContextMenuEvent* ev)</a>
<a name="ln947">      {</a>
<a name="ln948">      if (state == ViewState::NOTE_ENTRY) {</a>
<a name="ln949">            // Do not show context menu in note input mode.</a>
<a name="ln950">            return;</a>
<a name="ln951">            }</a>
<a name="ln952">      if (state == ViewState::FOTO) {</a>
<a name="ln953">            fotoContextPopup(ev);</a>
<a name="ln954">            return;</a>
<a name="ln955">            }</a>
<a name="ln956">      QPoint gp          = ev-&gt;globalPos();</a>
<a name="ln957">      editData.startMove = toLogical(ev-&gt;pos());</a>
<a name="ln958">      editData.buttons   = Qt::NoButton;</a>
<a name="ln959">      Element* e         = nullptr;</a>
<a name="ln960">      if (ev-&gt;reason() == QContextMenuEvent::Keyboard)</a>
<a name="ln961">            e = score()-&gt;selection().element();</a>
<a name="ln962">      else</a>
<a name="ln963">            e = elementNear(editData.startMove);</a>
<a name="ln964">      if (e) {</a>
<a name="ln965">            if (!e-&gt;selected()) {</a>
<a name="ln966">                  // bool control = (ev-&gt;modifiers() &amp; Qt::ControlModifier) ? true : false;</a>
<a name="ln967">                  // _score-&gt;select(e, control ? SelectType::ADD : SelectType::SINGLE, 0);</a>
<a name="ln968">                  // editData.element = e;</a>
<a name="ln969">                  // select(ev);</a>
<a name="ln970">                  }</a>
<a name="ln971">            if (seq)</a>
<a name="ln972">                  seq-&gt;stopNotes();       // stop now because we don’t get a mouseRelease event</a>
<a name="ln973">            objectPopup(gp, e);</a>
<a name="ln974">            }</a>
<a name="ln975">      else {</a>
<a name="ln976">            int staffIdx;</a>
<a name="ln977">            Measure* m = nullptr;</a>
<a name="ln978">            if (ev-&gt;reason() == QContextMenuEvent::Keyboard) {</a>
<a name="ln979">                  // find measure based on selection</a>
<a name="ln980">                  m = score()-&gt;selection().findMeasure();</a>
<a name="ln981">                  }</a>
<a name="ln982">            else {</a>
<a name="ln983">                  // find nearest measure based on mouse pointer location</a>
<a name="ln984">                  m = _score-&gt;pos2measure(editData.startMove, &amp;staffIdx, 0, 0, 0);</a>
<a name="ln985">                  // but only use it if mouse pointer is within the staff</a>
<a name="ln986">                  if (m &amp;&amp; !m-&gt;staffLines(staffIdx)-&gt;canvasBoundingRect().contains(editData.startMove))</a>
<a name="ln987">                        m = nullptr;</a>
<a name="ln988">                  }</a>
<a name="ln989">            if (m)</a>
<a name="ln990">                  measurePopup(ev, m);</a>
<a name="ln991">            else {</a>
<a name="ln992">                  QMenu* popup = new QMenu();</a>
<a name="ln993">                  popup-&gt;addAction(getAction(&quot;edit-style&quot;));</a>
<a name="ln994">                  popup-&gt;addAction(getAction(&quot;page-settings&quot;));</a>
<a name="ln995">                  popup-&gt;addAction(getAction(&quot;load-style&quot;));</a>
<a name="ln996">                  _score-&gt;update();</a>
<a name="ln997">                  popup-&gt;popup(gp);</a>
<a name="ln998">                  }</a>
<a name="ln999">            }</a>
<a name="ln1000">      ev-&gt;accept();</a>
<a name="ln1001">      }</a>
<a name="ln1002"> </a>
<a name="ln1003">//---------------------------------------------------------</a>
<a name="ln1004">//   escapeCmd</a>
<a name="ln1005">//---------------------------------------------------------</a>
<a name="ln1006"> </a>
<a name="ln1007">void ScoreView::escapeCmd()</a>
<a name="ln1008">      {</a>
<a name="ln1009">      switch (state) {</a>
<a name="ln1010">            case ViewState::EDIT:</a>
<a name="ln1011">                  changeState(ViewState::NORMAL);</a>
<a name="ln1012">                  break;</a>
<a name="ln1013">            case ViewState::FOTO:</a>
<a name="ln1014">            case ViewState::NOTE_ENTRY:</a>
<a name="ln1015">            case ViewState::PLAY:</a>
<a name="ln1016">                  changeState(ViewState::NORMAL);</a>
<a name="ln1017">                  break;</a>
<a name="ln1018">            case ViewState::NORMAL:</a>
<a name="ln1019">                  _score-&gt;deselectAll();</a>
<a name="ln1020">                  update();</a>
<a name="ln1021">                  break;</a>
<a name="ln1022">            default:</a>
<a name="ln1023">                  break;</a>
<a name="ln1024">            }</a>
<a name="ln1025">      }</a>
<a name="ln1026"> </a>
<a name="ln1027">//---------------------------------------------------------</a>
<a name="ln1028">//   stateName</a>
<a name="ln1029">//---------------------------------------------------------</a>
<a name="ln1030"> </a>
<a name="ln1031">static const char* stateName(ViewState s)</a>
<a name="ln1032">      {</a>
<a name="ln1033">      switch (s) {</a>
<a name="ln1034">            case ViewState::NORMAL:             return &quot;NORMAL&quot;;</a>
<a name="ln1035">            case ViewState::DRAG:               return &quot;DRAG&quot;;</a>
<a name="ln1036">            case ViewState::DRAG_OBJECT:        return &quot;DRAG_OBJECT&quot;;</a>
<a name="ln1037">            case ViewState::EDIT:               return &quot;EDIT&quot;;</a>
<a name="ln1038">            case ViewState::DRAG_EDIT:          return &quot;DRAG_EDIT&quot;;</a>
<a name="ln1039">            case ViewState::LASSO:              return &quot;LASSO&quot;;</a>
<a name="ln1040">            case ViewState::NOTE_ENTRY:         return &quot;NOTE_ENTRY&quot;;</a>
<a name="ln1041">            case ViewState::PLAY:               return &quot;PLAY&quot;;</a>
<a name="ln1042">            case ViewState::ENTRY_PLAY:         return &quot;ENTRY_PLAY&quot;;</a>
<a name="ln1043">            case ViewState::FOTO:               return &quot;FOTO&quot;;</a>
<a name="ln1044">            case ViewState::FOTO_DRAG:          return &quot;FOTO_DRAG&quot;;</a>
<a name="ln1045">            case ViewState::FOTO_DRAG_EDIT:     return &quot;FOTO_DRAG_EDIT&quot;;</a>
<a name="ln1046">            case ViewState::FOTO_DRAG_OBJECT:   return &quot;FOTO_DRAG_OBJECT&quot;;</a>
<a name="ln1047">            case ViewState::FOTO_LASSO:         return &quot;FOTO_LASSO&quot;;</a>
<a name="ln1048">            }</a>
<a name="ln1049">      return &quot;&quot;;</a>
<a name="ln1050">      }</a>
<a name="ln1051"> </a>
<a name="ln1052">//---------------------------------------------------------</a>
<a name="ln1053">//   seqStopped</a>
<a name="ln1054">//---------------------------------------------------------</a>
<a name="ln1055"> </a>
<a name="ln1056">void ScoreView::seqStopped()</a>
<a name="ln1057">      {</a>
<a name="ln1058">      changeState(ViewState::NORMAL);</a>
<a name="ln1059">      }</a>
<a name="ln1060"> </a>
<a name="ln1061">//---------------------------------------------------------</a>
<a name="ln1062">//   changeState</a>
<a name="ln1063">//---------------------------------------------------------</a>
<a name="ln1064"> </a>
<a name="ln1065">void ScoreView::changeState(ViewState s)</a>
<a name="ln1066">      {</a>
<a name="ln1067">//      if (state == ViewState::EDIT &amp;&amp; s == ViewState::EDIT) {</a>
<a name="ln1068">//            startEdit();</a>
<a name="ln1069">//            return;</a>
<a name="ln1070">//            }</a>
<a name="ln1071">      if (s == ViewState::PLAY &amp;&amp; !seq)</a>
<a name="ln1072">            return;</a>
<a name="ln1073">      if (s == state)</a>
<a name="ln1074">            return;</a>
<a name="ln1075"> </a>
<a name="ln1076">      qDebug(&quot;changeState %s  -&gt; %s&quot;, stateName(state), stateName(s));</a>
<a name="ln1077">      //</a>
<a name="ln1078">      //    end current state</a>
<a name="ln1079">      //</a>
<a name="ln1080">      switch (state) {</a>
<a name="ln1081">            case ViewState::NOTE_ENTRY:</a>
<a name="ln1082">                  endNoteEntry();</a>
<a name="ln1083">                  break;</a>
<a name="ln1084">            case ViewState::DRAG:</a>
<a name="ln1085">                  break;</a>
<a name="ln1086">            case ViewState::FOTO_DRAG_OBJECT:</a>
<a name="ln1087">                  for (Element* e : _score-&gt;selection().elements()) {</a>
<a name="ln1088">                        e-&gt;endDrag(editData);</a>
<a name="ln1089">                        e-&gt;triggerLayout();</a>
<a name="ln1090">                        }</a>
<a name="ln1091">                  setDropTarget(0); // this also resets dropAnchor</a>
<a name="ln1092">                  _score-&gt;endCmd();</a>
<a name="ln1093">                  break;</a>
<a name="ln1094">            case ViewState::DRAG_OBJECT:</a>
<a name="ln1095">                  endDrag();</a>
<a name="ln1096">                  break;</a>
<a name="ln1097">            case ViewState::FOTO_DRAG_EDIT:</a>
<a name="ln1098">            case ViewState::DRAG_EDIT:</a>
<a name="ln1099">                  endDragEdit();</a>
<a name="ln1100">                  break;</a>
<a name="ln1101">            case ViewState::FOTO:</a>
<a name="ln1102">                  if (s != ViewState::FOTO_DRAG &amp;&amp; s != ViewState::FOTO_DRAG_EDIT &amp;&amp; s != ViewState::FOTO_DRAG_OBJECT)</a>
<a name="ln1103">                        stopFotomode();</a>
<a name="ln1104">                  break;</a>
<a name="ln1105">            case ViewState::LASSO:</a>
<a name="ln1106">                  endLasso();</a>
<a name="ln1107">                  break;</a>
<a name="ln1108">            case ViewState::FOTO_LASSO:</a>
<a name="ln1109">                  endFotoDrag();</a>
<a name="ln1110">                  break;</a>
<a name="ln1111">            case ViewState::PLAY:</a>
<a name="ln1112">                  seq-&gt;stop();</a>
<a name="ln1113">                  break;</a>
<a name="ln1114">            case ViewState::EDIT:</a>
<a name="ln1115">                  setMouseTracking(false);</a>
<a name="ln1116">                  break;</a>
<a name="ln1117">            default:</a>
<a name="ln1118">                  break;</a>
<a name="ln1119">            }</a>
<a name="ln1120">      //</a>
<a name="ln1121">      //    start new state</a>
<a name="ln1122">      //</a>
<a name="ln1123">      switch (s) {</a>
<a name="ln1124">            case ViewState::NORMAL:</a>
<a name="ln1125">                  if (state == ViewState::EDIT) {</a>
<a name="ln1126">                        _blockShowEdit = true;  // otherwise may jump on clicking outside the text element being edited</a>
<a name="ln1127">                        endEdit();</a>
<a name="ln1128">                        editData.element = nullptr; // editData.element will be determined by selection state in normal mode</a>
<a name="ln1129">                        _blockShowEdit = false;</a>
<a name="ln1130">                        }</a>
<a name="ln1131">                  setCursor(QCursor(Qt::ArrowCursor));</a>
<a name="ln1132">                  break;</a>
<a name="ln1133">            case ViewState::DRAG:</a>
<a name="ln1134">                  setCursor(QCursor(Qt::SizeAllCursor));</a>
<a name="ln1135">                  break;</a>
<a name="ln1136">            case ViewState::FOTO_DRAG_OBJECT:</a>
<a name="ln1137">                  _score-&gt;select(_foto);</a>
<a name="ln1138">                  // fall through</a>
<a name="ln1139">            case ViewState::DRAG_OBJECT:</a>
<a name="ln1140">                  setCursor(QCursor(Qt::ArrowCursor));</a>
<a name="ln1141">                  startDrag();</a>
<a name="ln1142">                  break;</a>
<a name="ln1143">            case ViewState::FOTO_DRAG:</a>
<a name="ln1144">                  setCursor(QCursor(Qt::SizeAllCursor));</a>
<a name="ln1145">                  break;</a>
<a name="ln1146">            case ViewState::NOTE_ENTRY:</a>
<a name="ln1147">                  setCursor(QCursor(Qt::ArrowCursor));</a>
<a name="ln1148">                  startNoteEntry();</a>
<a name="ln1149">                  break;</a>
<a name="ln1150">            case ViewState::DRAG_EDIT:</a>
<a name="ln1151">            case ViewState::FOTO_DRAG_EDIT:</a>
<a name="ln1152">                  setCursor(QCursor(Qt::ArrowCursor));</a>
<a name="ln1153">                  break;</a>
<a name="ln1154">            case ViewState::FOTO:</a>
<a name="ln1155">                  setCursor(QCursor(Qt::ArrowCursor));</a>
<a name="ln1156">                  if (state != ViewState::FOTO_DRAG &amp;&amp; state != ViewState::FOTO_DRAG_EDIT &amp;&amp; state != ViewState::FOTO_DRAG_OBJECT)</a>
<a name="ln1157">                        startFotomode();</a>
<a name="ln1158">                  if (state == ViewState::FOTO_DRAG_OBJECT)</a>
<a name="ln1159">                        startEdit();</a>
<a name="ln1160">                  break;</a>
<a name="ln1161">            case ViewState::EDIT:</a>
<a name="ln1162">                  if (state != ViewState::DRAG_EDIT)</a>
<a name="ln1163">                        startEdit();</a>
<a name="ln1164">                  break;</a>
<a name="ln1165">            case ViewState::LASSO:</a>
<a name="ln1166">                  break;</a>
<a name="ln1167">            case ViewState::PLAY:</a>
<a name="ln1168">                  seq-&gt;start();</a>
<a name="ln1169">                  break;</a>
<a name="ln1170">            case ViewState::ENTRY_PLAY:</a>
<a name="ln1171">                  break;</a>
<a name="ln1172">            case ViewState::FOTO_LASSO:</a>
<a name="ln1173">                  startFotoDrag();</a>
<a name="ln1174">                  break;</a>
<a name="ln1175">            }</a>
<a name="ln1176"> </a>
<a name="ln1177">      state = s;</a>
<a name="ln1178">      mscore-&gt;changeState(mscoreState());</a>
<a name="ln1179">      if (mscoreState() &amp; STATE_ALLTEXTUAL_EDIT)</a>
<a name="ln1180">            setMouseTracking(true);</a>
<a name="ln1181">      }</a>
<a name="ln1182"> </a>
<a name="ln1183">//---------------------------------------------------------</a>
<a name="ln1184">//   inputMethodEvent</a>
<a name="ln1185">//---------------------------------------------------------</a>
<a name="ln1186"> </a>
<a name="ln1187">void ScoreView::inputMethodEvent(QInputMethodEvent* event)</a>
<a name="ln1188">      {</a>
<a name="ln1189">      if (textEditMode())</a>
<a name="ln1190">            toTextBase(editData.element)-&gt;inputTransition(editData, event);</a>
<a name="ln1191">      }</a>
<a name="ln1192"> </a>
<a name="ln1193">}    // namespace Ms</a>
<a name="ln1194"> </a>

</code></pre>
<div class="balloon" rel="323"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 323, 344</p></div>
<div class="balloon" rel="1011"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 1011, 1016</p></div>
<div class="balloon" rel="1134"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 1134, 1144</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
