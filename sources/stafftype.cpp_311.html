
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>stafftype.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2010-2015 Werner Schweer &amp; others</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;stafftype.h&quot;</a>
<a name="ln14"> </a>
<a name="ln15">#include &quot;chord.h&quot;</a>
<a name="ln16">#include &quot;measure.h&quot;</a>
<a name="ln17">#include &quot;mscore.h&quot;</a>
<a name="ln18">#include &quot;navigate.h&quot;</a>
<a name="ln19">#include &quot;staff.h&quot;</a>
<a name="ln20">#include &quot;xml.h&quot;</a>
<a name="ln21">#include &quot;score.h&quot;</a>
<a name="ln22"> </a>
<a name="ln23">#define TAB_DEFAULT_LINE_SP   (1.5)</a>
<a name="ln24">#define TAB_RESTSYMBDISPL     2.0</a>
<a name="ln25"> </a>
<a name="ln26">namespace Ms {</a>
<a name="ln27"> </a>
<a name="ln28">//---------------------------------------------------------</a>
<a name="ln29">//   StaffTypeTablature</a>
<a name="ln30">//---------------------------------------------------------</a>
<a name="ln31"> </a>
<a name="ln32">#define TAB_DEFAULT_DUR_YOFFS (-1.0)</a>
<a name="ln33"> </a>
<a name="ln34">QList&lt;TablatureFretFont&gt;     StaffType::_fretFonts      = QList&lt;TablatureFretFont&gt;();</a>
<a name="ln35">QList&lt;TablatureDurationFont&gt; StaffType::_durationFonts  = QList&lt;TablatureDurationFont&gt;();</a>
<a name="ln36"> </a>
<a name="ln37">const char StaffType::groupNames[STAFF_GROUP_MAX][STAFF_GROUP_NAME_MAX_LENGTH] = {</a>
<a name="ln38">      QT_TRANSLATE_NOOP(&quot;Staff type group name&quot;, &quot;Standard&quot;),</a>
<a name="ln39">      QT_TRANSLATE_NOOP(&quot;Staff type group name&quot;, &quot;Percussion&quot;),</a>
<a name="ln40">      QT_TRANSLATE_NOOP(&quot;Staff type group name&quot;, &quot;Tablature&quot;)</a>
<a name="ln41">      };</a>
<a name="ln42"> </a>
<a name="ln43">const QString StaffType::fileGroupNames[STAFF_GROUP_MAX] = { &quot;pitched&quot;, &quot;percussion&quot;, &quot;tablature&quot; };</a>
<a name="ln44"> </a>
<a name="ln45">//---------------------------------------------------------</a>
<a name="ln46">//   StaffType</a>
<a name="ln47">//---------------------------------------------------------</a>
<a name="ln48"> </a>
<a name="ln49">StaffType::StaffType()</a>
<a name="ln50">      {</a>
<a name="ln51">      // set reasonable defaults for type-specific members */</a>
<a name="ln52">      _symRepeat = TablatureSymbolRepeat::NEVER;</a>
<a name="ln53">      setDurationFontName(_durationFonts[0].displayName);</a>
<a name="ln54">      setFretFontName(_fretFonts[0].displayName);</a>
<a name="ln55">      }</a>
<a name="ln56"> </a>
<a name="ln57">StaffType::StaffType(StaffGroup sg, const QString&amp; xml, const QString&amp; name, int lines, int stpOff, qreal lineDist,</a>
<a name="ln58">   bool genClef, bool showBarLines, bool stemless, bool genTimeSig, bool genKeySig, bool showLedgerLines) :</a>
<a name="ln59">   _group(sg), _xmlName(xml), _name(name),</a>
<a name="ln60">   _lines(lines),</a>
<a name="ln61">   _stepOffset(stpOff),</a>
<a name="ln62">   _lineDistance(Spatium(lineDist)),</a>
<a name="ln63">   _showBarlines(showBarLines),</a>
<a name="ln64">   _showLedgerLines(showLedgerLines),</a>
<a name="ln65">   _stemless(stemless),</a>
<a name="ln66">   _genClef(genClef),</a>
<a name="ln67">   _genTimesig(genTimeSig),</a>
<a name="ln68">   _genKeysig(genKeySig)</a>
<a name="ln69">      {</a>
<a name="ln70">      }</a>
<a name="ln71"> </a>
<a name="ln72">StaffType::StaffType(StaffGroup sg, const QString&amp; xml, const QString&amp; name, int lines, int stpOff, qreal lineDist,</a>
<a name="ln73">   bool genClef,</a>
<a name="ln74">   bool showBarLines, bool stemless, bool genTimesig,</a>
<a name="ln75">   const QString&amp; durFontName, qreal durFontSize, qreal durFontUserY, qreal genDur,</a>
<a name="ln76">   const QString&amp; fretFontName, qreal fretFontSize, qreal fretFontUserY,</a>
<a name="ln77">   TablatureSymbolRepeat symRepeat, bool linesThrough, TablatureMinimStyle minimStyle, bool onLines,</a>
<a name="ln78">   bool showRests, bool stemsDown, bool stemThrough, bool upsideDown, bool showTabFingering, bool useNumbers, bool showBackTied)</a>
<a name="ln79">      {</a>
<a name="ln80">      _group   = sg;</a>
<a name="ln81">      _xmlName = xml;</a>
<a name="ln82">      _name    = name;</a>
<a name="ln83">      setLines(lines);</a>
<a name="ln84">      setStepOffset(stpOff);</a>
<a name="ln85">      setLineDistance(Spatium(lineDist));</a>
<a name="ln86">      setGenClef(genClef);</a>
<a name="ln87">      setShowBarlines(showBarLines);</a>
<a name="ln88">      setStemless(stemless);</a>
<a name="ln89">      setGenTimesig(genTimesig);</a>
<a name="ln90">      setGenKeysig(sg != StaffGroup::TAB);</a>
<a name="ln91">      setDurationFontName(durFontName);</a>
<a name="ln92">      setDurationFontSize(durFontSize);</a>
<a name="ln93">      setDurationFontUserY(durFontUserY);</a>
<a name="ln94">      setGenDurations(genDur);</a>
<a name="ln95">      setFretFontName(fretFontName);</a>
<a name="ln96">      setFretFontSize(fretFontSize);</a>
<a name="ln97">      setFretFontUserY(fretFontUserY);</a>
<a name="ln98">      setSymbolRepeat(symRepeat);</a>
<a name="ln99">      setLinesThrough(linesThrough);</a>
<a name="ln100">      setMinimStyle(minimStyle);</a>
<a name="ln101">      setOnLines(onLines);</a>
<a name="ln102">      setShowRests(showRests);</a>
<a name="ln103">      setStemsDown(stemsDown);</a>
<a name="ln104">      setStemsThrough(stemThrough);</a>
<a name="ln105">      setUpsideDown(upsideDown);</a>
<a name="ln106">      setShowTabFingering(showTabFingering);</a>
<a name="ln107">      setUseNumbers(useNumbers);</a>
<a name="ln108">      setShowBackTied(showBackTied);</a>
<a name="ln109">      }</a>
<a name="ln110"> </a>
<a name="ln111"> </a>
<a name="ln112">//---------------------------------------------------------</a>
<a name="ln113">//   groupName</a>
<a name="ln114">//---------------------------------------------------------</a>
<a name="ln115"> </a>
<a name="ln116">const char* StaffType::groupName() const</a>
<a name="ln117">      {</a>
<a name="ln118">      return groupName(_group);</a>
<a name="ln119">      }</a>
<a name="ln120"> </a>
<a name="ln121">const char* StaffType::groupName(StaffGroup r)</a>
<a name="ln122">      {</a>
<a name="ln123">      if (r &lt; StaffGroup::STANDARD || (int)r &gt;= STAFF_GROUP_MAX)</a>
<a name="ln124">            r = StaffGroup::STANDARD;</a>
<a name="ln125">      return groupNames[(int)r];</a>
<a name="ln126">      }</a>
<a name="ln127"> </a>
<a name="ln128">//---------------------------------------------------------</a>
<a name="ln129">//   operator==</a>
<a name="ln130">//---------------------------------------------------------</a>
<a name="ln131"> </a>
<a name="ln132">bool StaffType::operator==(const StaffType&amp; st) const</a>
<a name="ln133">      {</a>
<a name="ln134">      if (!isSameStructure(st) || st._xmlName != _xmlName) {        // common to all type groups</a>
<a name="ln135">            return false;</a>
<a name="ln136">            }</a>
<a name="ln137">      if (_group == StaffGroup::TAB) {                      // TAB-specific</a>
<a name="ln138">            bool v = st._durationFontIdx  == _durationFontIdx</a>
<a name="ln139">               &amp;&amp; st._durationFontSize  == _durationFontSize</a>
<a name="ln140">               &amp;&amp; st._durationFontUserY == _durationFontUserY</a>
<a name="ln141">               &amp;&amp; st._fretFontIdx       == _fretFontIdx</a>
<a name="ln142">               &amp;&amp; st._fretFontSize      == _fretFontSize</a>
<a name="ln143">               &amp;&amp; st._fretFontUserY     == _fretFontUserY</a>
<a name="ln144">               ;</a>
<a name="ln145">            return v;</a>
<a name="ln146">            }</a>
<a name="ln147">      return true;</a>
<a name="ln148">      }</a>
<a name="ln149"> </a>
<a name="ln150">//---------------------------------------------------------</a>
<a name="ln151">//   isSameStructure</a>
<a name="ln152">//</a>
<a name="ln153">//    same as operator==, but ignores names and fonts</a>
<a name="ln154">//---------------------------------------------------------</a>
<a name="ln155"> </a>
<a name="ln156">bool StaffType::isSameStructure(const StaffType&amp; st) const</a>
<a name="ln157">      {</a>
<a name="ln158">      if (st.group()         != group()                     // common to all type groups</a>
<a name="ln159">         || st._lines        != _lines</a>
<a name="ln160">         || st._stepOffset   != _stepOffset</a>
<a name="ln161">         || st._lineDistance != _lineDistance</a>
<a name="ln162">         || st._genClef      != _genClef</a>
<a name="ln163">         || st._showBarlines != _showBarlines</a>
<a name="ln164">         || st._stemless     != _stemless</a>
<a name="ln165">         || st._genTimesig   != _genTimesig)</a>
<a name="ln166">            return false;</a>
<a name="ln167">      if (_group == StaffGroup::STANDARD)                   // standard specific</a>
<a name="ln168">            if (st._noteHeadScheme != _noteHeadScheme)</a>
<a name="ln169">                  return false;</a>
<a name="ln170">      if (_group != StaffGroup::TAB) {                      // common to pitched and percussion</a>
<a name="ln171">            return st._genKeysig      == _genKeysig</a>
<a name="ln172">               &amp;&amp; st._showLedgerLines == _showLedgerLines</a>
<a name="ln173">               ;</a>
<a name="ln174">            }</a>
<a name="ln175">      else {                                                // TAB-specific</a>
<a name="ln176">            return st._genDurations == _genDurations</a>
<a name="ln177">               &amp;&amp; st._symRepeat     == _symRepeat</a>
<a name="ln178">               &amp;&amp; st._linesThrough  == _linesThrough</a>
<a name="ln179">               &amp;&amp; st._minimStyle    == _minimStyle</a>
<a name="ln180">               &amp;&amp; st._onLines       == _onLines</a>
<a name="ln181">               &amp;&amp; st._showBackTied  == _showBackTied</a>
<a name="ln182">               &amp;&amp; st._showRests     == _showRests</a>
<a name="ln183">               &amp;&amp; st._stemsDown     == _stemsDown</a>
<a name="ln184">               &amp;&amp; st._stemsThrough  == _stemsThrough</a>
<a name="ln185">               &amp;&amp; st._upsideDown    == _upsideDown</a>
<a name="ln186">               &amp;&amp; st._showTabFingering    == _showTabFingering</a>
<a name="ln187">               &amp;&amp; st._useNumbers    == _useNumbers</a>
<a name="ln188">               ;</a>
<a name="ln189">            }</a>
<a name="ln190">      }</a>
<a name="ln191"> </a>
<a name="ln192">//---------------------------------------------------------</a>
<a name="ln193">//   write</a>
<a name="ln194">//---------------------------------------------------------</a>
<a name="ln195"> </a>
<a name="ln196">void StaffType::write(XmlWriter&amp; xml) const</a>
<a name="ln197">      {</a>
<a name="ln198">      xml.stag(QString(&quot;StaffType group=\&quot;%1\&quot;&quot;).arg(fileGroupNames[(int)_group]));</a>
<a name="ln199">      if (!_xmlName.isEmpty())</a>
<a name="ln200">            xml.tag(&quot;name&quot;, _xmlName);</a>
<a name="ln201">      if (_lines != 5)</a>
<a name="ln202">            xml.tag(&quot;lines&quot;, _lines);</a>
<a name="ln203">      if (_lineDistance.val() != 1.0)</a>
<a name="ln204">            xml.tag(&quot;lineDistance&quot;, _lineDistance.val());</a>
<a name="ln205">      if (_yoffset.val() != 0.0)</a>
<a name="ln206">            xml.tag(&quot;yoffset&quot;, _yoffset.val());</a>
<a name="ln207">      if (_userMag != 1.0)</a>
<a name="ln208">            xml.tag(&quot;mag&quot;, _userMag);</a>
<a name="ln209">      if (_small)</a>
<a name="ln210">            xml.tag(&quot;small&quot;, _small);</a>
<a name="ln211">      if (_stepOffset)</a>
<a name="ln212">            xml.tag(&quot;stepOffset&quot;, _stepOffset);</a>
<a name="ln213">      if (!_genClef)</a>
<a name="ln214">            xml.tag(&quot;clef&quot;, _genClef);</a>
<a name="ln215">      if (_stemless) {</a>
<a name="ln216">            xml.tag(&quot;slashStyle&quot;, _stemless); // for backwards compatibility</a>
<a name="ln217">            xml.tag(&quot;stemless&quot;, _stemless);</a>
<a name="ln218">            }</a>
<a name="ln219">      if (!_showBarlines)</a>
<a name="ln220">            xml.tag(&quot;barlines&quot;, _showBarlines);</a>
<a name="ln221">      if (!_genTimesig)</a>
<a name="ln222">            xml.tag(&quot;timesig&quot;, _genTimesig);</a>
<a name="ln223">      if (_group == StaffGroup::STANDARD) {</a>
<a name="ln224">            xml.tag(&quot;noteheadScheme&quot;, StaffType::scheme2name(_noteHeadScheme), StaffType::scheme2name(NoteHeadScheme::HEAD_NORMAL));</a>
<a name="ln225">            }</a>
<a name="ln226">      if (_group == StaffGroup::STANDARD || _group == StaffGroup::PERCUSSION) {</a>
<a name="ln227">            if (!_genKeysig)</a>
<a name="ln228">                  xml.tag(&quot;keysig&quot;, _genKeysig);</a>
<a name="ln229">            if (!_showLedgerLines)</a>
<a name="ln230">                  xml.tag(&quot;ledgerlines&quot;, _showLedgerLines);</a>
<a name="ln231">            }</a>
<a name="ln232">      else {</a>
<a name="ln233">            xml.tag(&quot;durations&quot;,        _genDurations);</a>
<a name="ln234">            xml.tag(&quot;durationFontName&quot;, _durationFonts[_durationFontIdx].displayName); // write font names anyway for backward compatibility</a>
<a name="ln235">            xml.tag(&quot;durationFontSize&quot;, _durationFontSize);</a>
<a name="ln236">            xml.tag(&quot;durationFontY&quot;,    _durationFontUserY);</a>
<a name="ln237">            xml.tag(&quot;fretFontName&quot;,     _fretFonts[_fretFontIdx].displayName);</a>
<a name="ln238">            xml.tag(&quot;fretFontSize&quot;,     _fretFontSize);</a>
<a name="ln239">            xml.tag(&quot;fretFontY&quot;,        _fretFontUserY);</a>
<a name="ln240">            if (_symRepeat != TablatureSymbolRepeat::NEVER)</a>
<a name="ln241">                  xml.tag(&quot;symbolRepeat&quot;, int(_symRepeat));</a>
<a name="ln242">            xml.tag(&quot;linesThrough&quot;,     _linesThrough);</a>
<a name="ln243">            xml.tag(&quot;minimStyle&quot;,       int(_minimStyle));</a>
<a name="ln244">            xml.tag(&quot;onLines&quot;,          _onLines);</a>
<a name="ln245">            xml.tag(&quot;showRests&quot;,        _showRests);</a>
<a name="ln246">            xml.tag(&quot;stemsDown&quot;,        _stemsDown);</a>
<a name="ln247">            xml.tag(&quot;stemsThrough&quot;,     _stemsThrough);</a>
<a name="ln248">            xml.tag(&quot;upsideDown&quot;,       _upsideDown);</a>
<a name="ln249">            xml.tag(&quot;showTabFingering&quot;, _showTabFingering, false);</a>
<a name="ln250">            xml.tag(&quot;useNumbers&quot;,       _useNumbers);</a>
<a name="ln251">            // only output &quot;showBackTied&quot; if different from !&quot;stemless&quot;</a>
<a name="ln252">            // to match the behaviour in 2.0.2 scores (or older)</a>
<a name="ln253">            if (_showBackTied != !_stemless)</a>
<a name="ln254">                  xml.tag(&quot;showBackTied&quot;,  _showBackTied);</a>
<a name="ln255">            }</a>
<a name="ln256">      xml.etag();</a>
<a name="ln257">      }</a>
<a name="ln258"> </a>
<a name="ln259">//---------------------------------------------------------</a>
<a name="ln260">//   read</a>
<a name="ln261">//---------------------------------------------------------</a>
<a name="ln262"> </a>
<a name="ln263">void StaffType::read(XmlReader&amp; e)</a>
<a name="ln264">      {</a>
<a name="ln265">      QString group = e.attribute(&quot;group&quot;, fileGroupNames[(int)StaffGroup::STANDARD]);</a>
<a name="ln266">      if (group == fileGroupNames[(int)StaffGroup::TAB])</a>
<a name="ln267">            _group = StaffGroup::TAB;</a>
<a name="ln268">      else if (group == fileGroupNames[(int)StaffGroup::PERCUSSION])</a>
<a name="ln269">            _group = StaffGroup::PERCUSSION;</a>
<a name="ln270">      else if (group == fileGroupNames[(int)StaffGroup::STANDARD])</a>
<a name="ln271">            _group = StaffGroup::STANDARD;</a>
<a name="ln272">      else {</a>
<a name="ln273">            qDebug(&quot;StaffType::read: unknown group: %s&quot;, qPrintable(group));</a>
<a name="ln274">            _group = StaffGroup::STANDARD;</a>
<a name="ln275">            }</a>
<a name="ln276"> </a>
<a name="ln277">      if (_group == StaffGroup::TAB)</a>
<a name="ln278">            setGenKeysig(false);</a>
<a name="ln279"> </a>
<a name="ln280">      while (e.readNextStartElement()) {</a>
<a name="ln281">            const QStringRef&amp; tag(e.name());</a>
<a name="ln282">            if (tag == &quot;name&quot;)</a>
<a name="ln283">                  setXmlName(e.readElementText());</a>
<a name="ln284">            else if (tag == &quot;lines&quot;)</a>
<a name="ln285">                  setLines(e.readInt());</a>
<a name="ln286">            else if (tag == &quot;lineDistance&quot;)</a>
<a name="ln287">                  setLineDistance(Spatium(e.readDouble()));</a>
<a name="ln288">            else if (tag == &quot;yoffset&quot;)</a>
<a name="ln289">                  _yoffset = Spatium(e.readDouble());</a>
<a name="ln290">            else if (tag == &quot;mag&quot;)</a>
<a name="ln291">                  _userMag = e.readDouble();</a>
<a name="ln292">            else if (tag == &quot;small&quot;)</a>
<a name="ln293">                  _small = e.readBool();</a>
<a name="ln294">            else if (tag == &quot;stepOffset&quot;)</a>
<a name="ln295">                  _stepOffset = e.readInt();</a>
<a name="ln296">            else if (tag == &quot;clef&quot;)</a>
<a name="ln297">                  setGenClef(e.readInt());</a>
<a name="ln298">            else if ((tag == &quot;slashStyle&quot;) || (tag == &quot;stemless&quot;)) {</a>
<a name="ln299">                  bool val = e.readInt() != 0;</a>
<a name="ln300">                  setStemless(val);</a>
<a name="ln301">                  setShowBackTied(!val);  // for compatibility with 2.0.2 scores where this prop</a>
<a name="ln302">                  }                       // was lacking and controlled by &quot;slashStyle&quot; instead</a>
<a name="ln303">            else if (tag == &quot;barlines&quot;)</a>
<a name="ln304">                  setShowBarlines(e.readInt());</a>
<a name="ln305">            else if (tag == &quot;timesig&quot;)</a>
<a name="ln306">                  setGenTimesig(e.readInt());</a>
<a name="ln307">            else if (tag == &quot;noteheadScheme&quot;)</a>
<a name="ln308">                  setNoteHeadScheme(StaffType::name2scheme(e.readElementText()));</a>
<a name="ln309">            else if (tag == &quot;keysig&quot;)</a>
<a name="ln310">                  _genKeysig = e.readInt();</a>
<a name="ln311">            else if (tag == &quot;ledgerlines&quot;)</a>
<a name="ln312">                  _showLedgerLines = e.readInt();</a>
<a name="ln313">            else if (tag == &quot;durations&quot;)</a>
<a name="ln314">                  setGenDurations(e.readBool());</a>
<a name="ln315">            else if (tag == &quot;durationFontName&quot;)</a>
<a name="ln316">                  setDurationFontName(e.readElementText());</a>
<a name="ln317">            else if (tag == &quot;durationFontSize&quot;)</a>
<a name="ln318">                  setDurationFontSize(e.readDouble());</a>
<a name="ln319">            else if (tag == &quot;durationFontY&quot;)</a>
<a name="ln320">                  setDurationFontUserY(e.readDouble());</a>
<a name="ln321">            else if (tag == &quot;fretFontName&quot;)</a>
<a name="ln322">                  setFretFontName(e.readElementText());</a>
<a name="ln323">            else if (tag == &quot;fretFontSize&quot;)</a>
<a name="ln324">                  setFretFontSize(e.readDouble());</a>
<a name="ln325">            else if (tag == &quot;fretFontY&quot;)</a>
<a name="ln326">                  setFretFontUserY(e.readDouble());</a>
<a name="ln327">            else if (tag == &quot;symbolRepeat&quot;)</a>
<a name="ln328">                  setSymbolRepeat( (TablatureSymbolRepeat) e.readInt() );</a>
<a name="ln329">            else if (tag == &quot;linesThrough&quot;)</a>
<a name="ln330">                  setLinesThrough(e.readBool());</a>
<a name="ln331">            else if (tag == &quot;minimStyle&quot;)</a>
<a name="ln332">                  setMinimStyle( (TablatureMinimStyle) e.readInt() );</a>
<a name="ln333">            else if (tag == &quot;onLines&quot;)</a>
<a name="ln334">                  setOnLines(e.readBool());</a>
<a name="ln335">            else if (tag == &quot;showRests&quot;)</a>
<a name="ln336">                  setShowRests(e.readBool());</a>
<a name="ln337">            else if (tag == &quot;stemsDown&quot;)</a>
<a name="ln338">                  setStemsDown(e.readBool());</a>
<a name="ln339">            else if (tag == &quot;stemsThrough&quot;)</a>
<a name="ln340">                  setStemsThrough(e.readBool());</a>
<a name="ln341">            else if (tag == &quot;upsideDown&quot;)</a>
<a name="ln342">                  setUpsideDown(e.readBool());</a>
<a name="ln343">            else if (tag == &quot;showTabFingering&quot;)</a>
<a name="ln344">                  setShowTabFingering(e.readBool());</a>
<a name="ln345">            else if (tag == &quot;useNumbers&quot;)</a>
<a name="ln346">                  setUseNumbers(e.readBool());</a>
<a name="ln347">            else if (tag == &quot;showBackTied&quot;)           // must be after reading &quot;slashStyle&quot;/&quot;stemless&quot; prop, as in older</a>
<a name="ln348">                  setShowBackTied(e.readBool());      // scores, this prop was lacking and controlled by &quot;slashStyle&quot;</a>
<a name="ln349">            else</a>
<a name="ln350">                  e.unknown();</a>
<a name="ln351">            }</a>
<a name="ln352">      }</a>
<a name="ln353"> </a>
<a name="ln354">//---------------------------------------------------------</a>
<a name="ln355">//   doty1</a>
<a name="ln356">//    get y dot position of first repeat barline dot</a>
<a name="ln357">//---------------------------------------------------------</a>
<a name="ln358"> </a>
<a name="ln359">qreal StaffType::doty1() const</a>
<a name="ln360">      {</a>
<a name="ln361">      return _lineDistance.val() * (static_cast&lt;qreal&gt;((_lines - 1)/2) - 0.5);</a>
<a name="ln362">      }</a>
<a name="ln363"> </a>
<a name="ln364">//---------------------------------------------------------</a>
<a name="ln365">//   doty2</a>
<a name="ln366">//    get y dot position of second repeat barline dot</a>
<a name="ln367">//---------------------------------------------------------</a>
<a name="ln368"> </a>
<a name="ln369">qreal StaffType::doty2() const</a>
<a name="ln370">      {</a>
<a name="ln371">      return _lineDistance.val() * (static_cast&lt;qreal&gt;(_lines/2) + 0.5);</a>
<a name="ln372">      }</a>
<a name="ln373"> </a>
<a name="ln374">//---------------------------------------------------------</a>
<a name="ln375">//   setOnLines</a>
<a name="ln376">//---------------------------------------------------------</a>
<a name="ln377"> </a>
<a name="ln378">void StaffType::setOnLines(bool val)</a>
<a name="ln379">      {</a>
<a name="ln380">      _onLines = val;</a>
<a name="ln381">      _durationMetricsValid = _fretMetricsValid = false;</a>
<a name="ln382">      }</a>
<a name="ln383"> </a>
<a name="ln384">//---------------------------------------------------------</a>
<a name="ln385">//   setDurationMetrics</a>
<a name="ln386">//    checks whether the internally computed metrics are is still valid and re-computes them, if not</a>
<a name="ln387">//---------------------------------------------------------</a>
<a name="ln388"> </a>
<a name="ln389">void StaffType::setDurationMetrics() const</a>
<a name="ln390">      {</a>
<a name="ln391">      if (_durationMetricsValid &amp;&amp; _refDPI == DPI)           // metrics are still valid</a>
<a name="ln392">            return;</a>
<a name="ln393"> </a>
<a name="ln394">// QFontMetrics[F]() returns results unreliably rounded to integral pixels;</a>
<a name="ln395">// use a scaled up font and then scale computed values down</a>
<a name="ln396">//      QFontMetricsF fm(durationFont());</a>
<a name="ln397">      QFont font(durationFont());</a>
<a name="ln398">      font.setPointSizeF(_durationFontSize);</a>
<a name="ln399">      QFontMetricsF fm(font, MScore::paintDevice());</a>
<a name="ln400">      QString txt(_durationFonts[_durationFontIdx].displayValue, int(TabVal::NUM_OF));</a>
<a name="ln401">      QRectF bb( fm.tightBoundingRect(txt) );</a>
<a name="ln402">      // raise symbols by a default margin and, if marks are above lines, by half the line distance</a>
<a name="ln403">      // (converted from spatium units to raster units)</a>
<a name="ln404">      _durationGridYOffset = ( TAB_DEFAULT_DUR_YOFFS - (_onLines ? 0.0 : lineDistance().val()*0.5) ) * SPATIUM20;</a>
<a name="ln405">      // this is the bottomest point of any duration sign</a>
<a name="ln406">      _durationYOffset        = _durationGridYOffset;</a>
<a name="ln407">      // move symbols so that the lowest margin 'sits' on the base line:</a>
<a name="ln408">      // move down by the whole part above (negative) the base line</a>
<a name="ln409">      // ( -bb.y() ) then up by the whole height ( -bb.height() )</a>
<a name="ln410">      _durationYOffset        -= (bb.height() + bb.y()) / 100.0;</a>
<a name="ln411">      _durationBoxH           = bb.height() / 100.0;</a>
<a name="ln412">      _durationBoxY           = _durationGridYOffset - bb.height() / 100.0;</a>
<a name="ln413">      // keep track of the conditions under which metrics have been computed</a>
<a name="ln414">      _refDPI = DPI;</a>
<a name="ln415">      _durationMetricsValid = true;</a>
<a name="ln416">      }</a>
<a name="ln417"> </a>
<a name="ln418">void StaffType::setFretMetrics() const</a>
<a name="ln419">      {</a>
<a name="ln420">      if (_fretMetricsValid &amp;&amp; _refDPI == DPI)</a>
<a name="ln421">            return;</a>
<a name="ln422"> </a>
<a name="ln423">      QFontMetricsF fm(fretFont(), MScore::paintDevice());</a>
<a name="ln424">      QRectF bb;</a>
<a name="ln425">      // compute vertical displacement</a>
<a name="ln426">      if (_useNumbers) {</a>
<a name="ln427">            // compute total height of used characters</a>
<a name="ln428">            QString txt = QString();</a>
<a name="ln429">            for (int idx = 0; idx &lt; 10; idx++)  // use only first 10 digits</a>
<a name="ln430">                  txt.append(_fretFonts[_fretFontIdx].displayDigit[idx]);</a>
<a name="ln431">            bb = fm.tightBoundingRect(txt);</a>
<a name="ln432">            // for numbers: centre on '0': move down by the whole part above (negative)</a>
<a name="ln433">            // the base line ( -bb.y() ) then up by half the whole height ( -bb.height()/2 )</a>
<a name="ln434">            QRectF bx( fm.tightBoundingRect(_fretFonts[_fretFontIdx].displayDigit[0]) );</a>
<a name="ln435">            _fretYOffset = -(bx.y() + bx.height()/2.0);</a>
<a name="ln436">            // _fretYOffset = -(bb.y() + bb.height()/2.0);  // &lt;- using bbox of all chars</a>
<a name="ln437">            }</a>
<a name="ln438">      else {</a>
<a name="ln439">            // compute total height of used characters</a>
<a name="ln440">            QString txt(_fretFonts[_fretFontIdx].displayLetter, NUM_OF_LETTERFRETS);</a>
<a name="ln441">            bb = fm.tightBoundingRect(txt);</a>
<a name="ln442">            // for letters: centre on the 'a' ascender, by moving down half of the part above the base line in bx</a>
<a name="ln443">            QRectF bx( fm.tightBoundingRect(_fretFonts[_fretFontIdx].displayLetter[0]) );</a>
<a name="ln444">            _fretYOffset = -bx.y() / 2.0;</a>
<a name="ln445">            }</a>
<a name="ln446">      // if on string, we are done; if between strings, raise by half line distance</a>
<a name="ln447">      if (!_onLines)</a>
<a name="ln448">            _fretYOffset -= lineDistance().val() * SPATIUM20 * 0.5;</a>
<a name="ln449"> </a>
<a name="ln450">      // from _fretYOffset, compute _fretBoxH and _fretBoxY</a>
<a name="ln451">      _fretBoxH = bb.height();</a>
<a name="ln452">      _fretBoxY = bb.y()  + _fretYOffset;</a>
<a name="ln453"> </a>
<a name="ln454">      // keep track of the conditions under which metrics have been computed</a>
<a name="ln455">      _refDPI = DPI;</a>
<a name="ln456">      _fretMetricsValid = true;</a>
<a name="ln457">      }</a>
<a name="ln458"> </a>
<a name="ln459">//---------------------------------------------------------</a>
<a name="ln460">//   setDurationFontName / setFretFontName</a>
<a name="ln461">//---------------------------------------------------------</a>
<a name="ln462"> </a>
<a name="ln463">void StaffType::setDurationFontName(const QString&amp; name)</a>
<a name="ln464">      {</a>
<a name="ln465">      int idx;</a>
<a name="ln466">      for (idx = 0; idx &lt; _durationFonts.size(); idx++)</a>
<a name="ln467">            if (_durationFonts[idx].displayName == name)</a>
<a name="ln468">                  break;</a>
<a name="ln469">      if (idx &gt;= _durationFonts.size())</a>
<a name="ln470">            idx = 0;          // if name not found, use first font</a>
<a name="ln471">      _durationFont.setFamily(_durationFonts[idx].family);</a>
<a name="ln472">      _durationFontIdx = idx;</a>
<a name="ln473">      _durationMetricsValid = false;</a>
<a name="ln474">      }</a>
<a name="ln475"> </a>
<a name="ln476">void StaffType::setFretFontName(const QString&amp; name)</a>
<a name="ln477">      {</a>
<a name="ln478">      int idx;</a>
<a name="ln479">      QString locName = name;</a>
<a name="ln480">      // convert old names for two built-in fonts which have changed of name</a>
<a name="ln481">      if (name == &quot;MuseScore Tab Late Renaiss&quot;)</a>
<a name="ln482">            locName = &quot;MuseScore Phal√®se&quot;;</a>
<a name="ln483">      for (idx = 0; idx &lt; _fretFonts.size(); idx++)</a>
<a name="ln484">            if (_fretFonts[idx].displayName == locName)</a>
<a name="ln485">                  break;</a>
<a name="ln486">      if (idx &gt;= _fretFonts.size())</a>
<a name="ln487">            idx = 0;          // if name not found, use first font</a>
<a name="ln488">      _fretFont.setFamily(_fretFonts[idx].family);</a>
<a name="ln489">      _fretFontIdx = idx;</a>
<a name="ln490">      _fretMetricsValid = false;</a>
<a name="ln491">      }</a>
<a name="ln492"> </a>
<a name="ln493">//---------------------------------------------------------</a>
<a name="ln494">//   durationBoxH / durationBoxY</a>
<a name="ln495">//---------------------------------------------------------</a>
<a name="ln496"> </a>
<a name="ln497">qreal StaffType::durationBoxH() const</a>
<a name="ln498">      {</a>
<a name="ln499">      if (!_genDurations &amp;&amp; !_stemless)</a>
<a name="ln500">            return 0.0;</a>
<a name="ln501">      setDurationMetrics();</a>
<a name="ln502">      return _durationBoxH;</a>
<a name="ln503">      }</a>
<a name="ln504"> </a>
<a name="ln505">qreal StaffType::durationBoxY() const</a>
<a name="ln506">      {</a>
<a name="ln507">      if (!_genDurations &amp;&amp; !_stemless)</a>
<a name="ln508">            return 0.0;</a>
<a name="ln509">      setDurationMetrics();</a>
<a name="ln510">      return _durationBoxY + _durationFontUserY * SPATIUM20;</a>
<a name="ln511">      }</a>
<a name="ln512"> </a>
<a name="ln513">//---------------------------------------------------------</a>
<a name="ln514">//   setDurationFontSize / setFretFontSize</a>
<a name="ln515">//---------------------------------------------------------</a>
<a name="ln516"> </a>
<a name="ln517">void StaffType::setDurationFontSize(qreal val)</a>
<a name="ln518">      {</a>
<a name="ln519">      _durationFontSize = val;</a>
<a name="ln520">      _durationFont.setPointSizeF(val);</a>
<a name="ln521">      _durationMetricsValid = false;</a>
<a name="ln522">      }</a>
<a name="ln523"> </a>
<a name="ln524">void StaffType::setFretFontSize(qreal val)</a>
<a name="ln525">      {</a>
<a name="ln526">      _fretFontSize = val;</a>
<a name="ln527">      _fretFont.setPointSizeF(val);</a>
<a name="ln528">      _fretMetricsValid = false;</a>
<a name="ln529">      }</a>
<a name="ln530"> </a>
<a name="ln531">//---------------------------------------------------------</a>
<a name="ln532">//   chordRestStemPosY / chordStemPos / chordStemPosBeam / chordStemLength</a>
<a name="ln533">//</a>
<a name="ln534">//    computes the stem data for the given chord, according to TAB settings</a>
<a name="ln535">//    NOTE: unit: spatium, position: relative to chord (DIFFERENT from Chord own functions)</a>
<a name="ln536">//</a>
<a name="ln537">//   chordRestStemPosY</a>
<a name="ln538">//          returns the vertical position of stem start point</a>
<a name="ln539">//---------------------------------------------------------</a>
<a name="ln540"> </a>
<a name="ln541">qreal StaffType::chordRestStemPosY(const ChordRest *chordRest) const</a>
<a name="ln542">      {</a>
<a name="ln543">      if (stemThrough())            // does not make sense for &quot;stems through staves&quot; setting; just return top line vert. position</a>
<a name="ln544">            return 0.0;</a>
<a name="ln545"> </a>
<a name="ln546">      // if stems beside staff, position are fixed, but take into account delta for half notes</a>
<a name="ln547">      qreal delta =                             // displacement for half note stems (if used)</a>
<a name="ln548">            // if half notes have not a short stem OR not a half note =&gt; 0</a>
<a name="ln549">            (minimStyle() != TablatureMinimStyle::SHORTER || chordRest-&gt;durationType().type() != TDuration::DurationType::V_HALF) ?</a>
<a name="ln550">                  0.0 :</a>
<a name="ln551">                  // if stem is up, displace of half stem length down (positive)</a>
<a name="ln552">                  // if stem is down, displace of half stem length up (negative)</a>
<a name="ln553">                  (chordRest-&gt;up() ?</a>
<a name="ln554">                        -STAFFTYPE_TAB_DEFAULTSTEMLEN_UP : STAFFTYPE_TAB_DEFAULTSTEMLEN_DN) * 0.5;</a>
<a name="ln555">      // if fret marks above lines and chordRest is up, move half a line distance up</a>
<a name="ln556">      if (!onLines() &amp;&amp; chordRest-&gt;up())</a>
<a name="ln557">            delta -= _lineDistance.val() *0.5;</a>
<a name="ln558">      qreal y = (chordRest-&gt;up() ? STAFFTYPE_TAB_DEFAULTSTEMPOSY_UP : (_lines-1)*_lineDistance.val() + STAFFTYPE_TAB_DEFAULTSTEMPOSY_DN)</a>
<a name="ln559">            + delta;</a>
<a name="ln560">      return y;</a>
<a name="ln561">      }</a>
<a name="ln562"> </a>
<a name="ln563">//---------------------------------------------------------</a>
<a name="ln564">//   chordStemPos</a>
<a name="ln565">//    return position of note at other side of beam</a>
<a name="ln566">//---------------------------------------------------------</a>
<a name="ln567"> </a>
<a name="ln568">QPointF StaffType::chordStemPos(const Chord* chord) const</a>
<a name="ln569">      {</a>
<a name="ln570">      qreal y;</a>
<a name="ln571">      if (stemThrough())</a>
<a name="ln572">            // if stems are through staff, stem goes from fartest note string</a>
<a name="ln573">            y = (chord-&gt;up() ? chord-&gt;downString() : chord-&gt;upString()) * _lineDistance.val();</a>
<a name="ln574">      else</a>
<a name="ln575">            // if stems are beside staff, stem start point has a fixed vertical position,</a>
<a name="ln576">            // according to TAB parameters and stem up/down</a>
<a name="ln577">            y = chordRestStemPosY(chord);</a>
<a name="ln578">      return QPointF(chordStemPosX(chord), y);</a>
<a name="ln579">      }</a>
<a name="ln580"> </a>
<a name="ln581">//---------------------------------------------------------</a>
<a name="ln582">//   chordStemPosBeam</a>
<a name="ln583">//          return position of note at beam side of stem</a>
<a name="ln584">//---------------------------------------------------------</a>
<a name="ln585"> </a>
<a name="ln586">QPointF StaffType::chordStemPosBeam(const Chord* chord) const</a>
<a name="ln587">      {</a>
<a name="ln588">      qreal y = ( stemsDown() ? chord-&gt;downString() : chord-&gt;upString() ) * _lineDistance.val();</a>
<a name="ln589"> </a>
<a name="ln590">      return QPointF(chordStemPosX(chord), y);</a>
<a name="ln591">      }</a>
<a name="ln592"> </a>
<a name="ln593">//---------------------------------------------------------</a>
<a name="ln594">//   chordStemLength</a>
<a name="ln595">//          return length of stem</a>
<a name="ln596">//---------------------------------------------------------</a>
<a name="ln597"> </a>
<a name="ln598">qreal StaffType::chordStemLength(const Chord* chord) const</a>
<a name="ln599">      {</a>
<a name="ln600">      qreal    stemLen;</a>
<a name="ln601">      // if stems are through staff, length should be computed by relevant chord algorithm;</a>
<a name="ln602">      // here, just return default length (= 1 'octave' = 3.5 line spaces)</a>
<a name="ln603">      if (stemThrough())</a>
<a name="ln604">            return STAFFTYPE_TAB_DEFAULTSTEMLEN_THRU * _lineDistance.val();</a>
<a name="ln605">      // if stems beside staff, length is fixed, but take into account shorter half note stems</a>
<a name="ln606">      else {</a>
<a name="ln607">            bool shrt = (minimStyle() == TablatureMinimStyle::SHORTER) &amp;&amp; (chord-&gt;durationType().type() == TDuration::DurationType::V_HALF);</a>
<a name="ln608">            stemLen = (stemsDown() ? STAFFTYPE_TAB_DEFAULTSTEMLEN_DN : STAFFTYPE_TAB_DEFAULTSTEMLEN_UP)</a>
<a name="ln609">                        * (shrt ? STAFFTYPE_TAB_SHORTSTEMRATIO : 1.0);</a>
<a name="ln610">            }</a>
<a name="ln611">      // scale length by scale of parent chord, but relative to scale of context staff</a>
<a name="ln612">      return stemLen * chord-&gt;mag() / chord-&gt;staff()-&gt;mag(chord-&gt;tick());</a>
<a name="ln613">      }</a>
<a name="ln614"> </a>
<a name="ln615">//---------------------------------------------------------</a>
<a name="ln616">//   fretString / durationString</a>
<a name="ln617">//</a>
<a name="ln618">//    construct the text string for a given fret / duration</a>
<a name="ln619">//---------------------------------------------------------</a>
<a name="ln620"> </a>
<a name="ln621">static const QString unknownFret = QString(&quot;?&quot;);</a>
<a name="ln622"> </a>
<a name="ln623">QString StaffType::fretString(int fret, int string, bool ghost) const</a>
<a name="ln624">      {</a>
<a name="ln625">      if (fret == FRET_NONE)</a>
<a name="ln626">            return unknownFret;</a>
<a name="ln627">      if (ghost)</a>
<a name="ln628">            return _fretFonts[_fretFontIdx].ghostChar;</a>
<a name="ln629">      else {</a>
<a name="ln630">            bool        hasFret;</a>
<a name="ln631">            QString     text  = tabBassStringPrefix(string, &amp;hasFret);</a>
<a name="ln632">            if (!hasFret)           // if the notation does not allow to fret this string,</a>
<a name="ln633">                  return text;      // return the prefix only</a>
<a name="ln634">            // otherwise, add to prefix the relevant digit/letter string</a>
<a name="ln635">            return text +</a>
<a name="ln636">                  (_useNumbers ?</a>
<a name="ln637">                        (fret &gt;= NUM_OF_DIGITFRETS  ? unknownFret : _fretFonts[_fretFontIdx].displayDigit[fret]) :</a>
<a name="ln638">                        (fret &gt;= NUM_OF_LETTERFRETS ? unknownFret : _fretFonts[_fretFontIdx].displayLetter[fret]) );</a>
<a name="ln639">           }</a>
<a name="ln640">      }</a>
<a name="ln641"> </a>
<a name="ln642">QString StaffType::durationString(TDuration::DurationType type, int dots) const</a>
<a name="ln643">      {</a>
<a name="ln644">      QString s = _durationFonts[_durationFontIdx].displayValue[int(type)];</a>
<a name="ln645">      for(int count=0; count &lt; dots; count++)</a>
<a name="ln646">            s.append(_durationFonts[_durationFontIdx].displayDot);</a>
<a name="ln647">      return s;</a>
<a name="ln648">      }</a>
<a name="ln649"> </a>
<a name="ln650">//---------------------------------------------------------</a>
<a name="ln651">//    tabBassStringPrefix</a>
<a name="ln652">//</a>
<a name="ln653">//    returns a QString (possibly empty) with the prefix identifying a bass string in TAB's;</a>
<a name="ln654">//    can deal with non-bass strings (i.e. regular TAB lines).</a>
<a name="ln655">//</a>
<a name="ln656">//    Implements the specifics of historic notations for bass lines (i.e. strings outside</a>
<a name="ln657">//    the lines of the tab), both Italian and French.</a>
<a name="ln658">//</a>
<a name="ln659">//    strg   the instrument physical string ordinal (0 = topmost string, may exceed the number</a>
<a name="ln660">//                of lines actually present in the TAB to reference a bass string)</a>
<a name="ln661">//    bool   pntr to a bool receiving the info if notation allows to express a fret number or not</a>
<a name="ln662">//                (this is potentially different from the fact that the instrument string itself can be fretted or not)</a>
<a name="ln663">//---------------------------------------------------------</a>
<a name="ln664"> </a>
<a name="ln665">QString StaffType::tabBassStringPrefix(int strg, bool* hasFret) const</a>
<a name="ln666">      {</a>
<a name="ln667">      *hasFret    = true;           // assume notation allows to fret this string</a>
<a name="ln668">      int bassStrgIdx  = (strg &gt;= _lines ? strg - _lines + 1 : 0);</a>
<a name="ln669">      if (_useNumbers) {</a>
<a name="ln670">            // if above the max bass string which can be fretted with number notation</a>
<a name="ln671">            // return a number with the string index</a>
<a name="ln672">            if (bassStrgIdx &gt; NUM_OF_BASSSTRINGS_WITH_NUMBER) {</a>
<a name="ln673">                  *hasFret    = false;</a>
<a name="ln674">                  return _fretFonts[_fretFontIdx].displayDigit[strg+1];</a>
<a name="ln675">                  }</a>
<a name="ln676">            // if a frettable bass string, return an empty string</a>
<a name="ln677">            return QString();</a>
<a name="ln678">            }</a>
<a name="ln679">     else {</a>
<a name="ln680">            // bass string notation</a>
<a name="ln681">            // if above the max bass string which can be fretted with letter notation</a>
<a name="ln682">            // return a number with the bass string index itself</a>
<a name="ln683">            if (bassStrgIdx &gt; NUM_OF_BASSSTRINGS_WITH_LETTER) {</a>
<a name="ln684">                  *hasFret    = false;</a>
<a name="ln685">                  return _fretFonts[_fretFontIdx].displayDigit[bassStrgIdx-1];</a>
<a name="ln686">                  }</a>
<a name="ln687">            // if a frettable bass string, return a character with the relevant num. of slashes;</a>
<a name="ln688">            // note that the number of slashes is bassStrgIdx-1 (1st bass has no slash)</a>
<a name="ln689">            // and slashChar[] is 0-based (slashChar[0] =&gt; 1 slash, ...), whence the -2</a>
<a name="ln690">            QString prefix    = bassStrgIdx &gt; 1 ?</a>
<a name="ln691">                        QString(_fretFonts[_fretFontIdx].slashChar[bassStrgIdx - 2]) : QString();</a>
<a name="ln692">            return prefix;</a>
<a name="ln693">            }</a>
<a name="ln694">      }</a>
<a name="ln695"> </a>
<a name="ln696">//---------------------------------------------------------</a>
<a name="ln697">//   drawInputStringMarks</a>
<a name="ln698">//</a>
<a name="ln699">//    in TAB's, draws the marks within the input 'blue cursor' required to identify the current target input string.</a>
<a name="ln700">//</a>
<a name="ln701">//    Implements the specific of historic TAB styles for instruments with more strings than TAB lines.</a>
<a name="ln702">//    For strings normally represented by TAB lines, no mark is required.</a>
<a name="ln703">//    For strings not represented by TAB lines (e.g. bass strings in lutes and similar),</a>
<a name="ln704">//    either a sequence of slashes OR some ledger line-like lines OR the ordinal of the string</a>
<a name="ln705">//    are used, according to the TAB style (French or Italian) and the string position.</a>
<a name="ln706">//</a>
<a name="ln707">//    Note: assumes the string parameter is within legal bounds, i.e.:</a>
<a name="ln708">//    0 &lt;= string &lt;= [instrument strings] - 1</a>
<a name="ln709">//</a>
<a name="ln710">//    p       the QPainter to draw into</a>
<a name="ln711">//    string  the instrument physical string for which to draw the mark (0 = top string)</a>
<a name="ln712">//    voice   the current input voice (affects mark colour)</a>
<a name="ln713">//    rect    the rect of the 'blue rectangle' showing the input position</a>
<a name="ln714">//---------------------------------------------------------</a>
<a name="ln715"> </a>
<a name="ln716">static const qreal      LEDGER_LINE_THICKNESS   = 0.15;     // in sp</a>
<a name="ln717">static const qreal      LEDGER_LINE_LEFTX       = 0.25;     // in % of cursor rectangle width</a>
<a name="ln718">static const qreal      LEDGER_LINE_RIGHTX      = 0.75;     // in % of cursor rectangle width</a>
<a name="ln719"> </a>
<a name="ln720">void StaffType::drawInputStringMarks(QPainter *p, int string, int voice, QRectF rect) const</a>
<a name="ln721">      {</a>
<a name="ln722">      if (_group != StaffGroup::TAB)</a>
<a name="ln723">            return;</a>
<a name="ln724">      qreal       spatium     = SPATIUM20;</a>
<a name="ln725">      qreal       lineDist    = _lineDistance.val() * spatium;</a>
<a name="ln726">      bool        hasFret;</a>
<a name="ln727">      QString     text        = tabBassStringPrefix(string, &amp;hasFret);</a>
<a name="ln728">//    qreal       lw          = point(score()-&gt;styleS(Sid::ledgerLineWidth));  // no access to score form here</a>
<a name="ln729">      qreal       lw          = LEDGER_LINE_THICKNESS * spatium;                    // use a fixed width</a>
<a name="ln730">      QPen        pen(MScore::selectColor[voice].lighter(SHADOW_NOTE_LIGHT), lw);</a>
<a name="ln731">      p-&gt;setPen(pen);</a>
<a name="ln732">      // draw conventional 'ledger lines', if required</a>
<a name="ln733">      int         numOfLedgerLines  = numOfTabLedgerLines(string);</a>
<a name="ln734">      qreal       x1                = rect.x() + rect.width() * LEDGER_LINE_LEFTX;</a>
<a name="ln735">      qreal       x2                = rect.x() + rect.width() * LEDGER_LINE_RIGHTX;</a>
<a name="ln736">      // cursor rect is 1 line dist. high, and it is:</a>
<a name="ln737">      // centred on the line for &quot;frets on strings&quot;    =&gt; lower top ledger line 1/2 line dist.</a>
<a name="ln738">      // sitting on the line for &quot;frets above strings&quot; =&gt; lower top ledger line 1 full line dist</a>
<a name="ln739">      qreal y     = rect.top() + lineDist * (_onLines ? 0.5 : 1.0);</a>
<a name="ln740">      for (int i = 0; i &lt; numOfLedgerLines; i++) {</a>
<a name="ln741">            p-&gt;drawLine(QLineF(x1, y, x2, y));</a>
<a name="ln742">            y += lineDist / numOfLedgerLines; // insert other lines between top line and tab body</a>
<a name="ln743">            }</a>
<a name="ln744">      // draw the text, if any</a>
<a name="ln745">      if (!text.isEmpty()) {</a>
<a name="ln746">            QFont f = fretFont();</a>
<a name="ln747">            f.setPointSizeF(f.pointSizeF() * MScore::pixelRatio);</a>
<a name="ln748">            p-&gt;setFont(f);</a>
<a name="ln749">            p-&gt;drawText(QPointF(rect.left(), rect.top() + lineDist), text);</a>
<a name="ln750">            }</a>
<a name="ln751">      }</a>
<a name="ln752"> </a>
<a name="ln753">//---------------------------------------------------------</a>
<a name="ln754">//   numOfLedgerLines</a>
<a name="ln755">//</a>
<a name="ln756">//    in TAB's, returns the number of ledgerlines needed by bass lines in some TAB styles.</a>
<a name="ln757">//</a>
<a name="ln758">//    Returns 0 if staff is not a TAB, if a TAB but style does not use ledger lines</a>
<a name="ln759">//    or ledger lines do not apply to the given string.</a>
<a name="ln760">//---------------------------------------------------------</a>
<a name="ln761"> </a>
<a name="ln762">int StaffType::numOfTabLedgerLines(int string) const</a>
<a name="ln763">      {</a>
<a name="ln764">      if (_group != StaffGroup::TAB || !_useNumbers)</a>
<a name="ln765">            return 0;</a>
<a name="ln766"> </a>
<a name="ln767">      int   numOfLedgers= string &lt; 0 ? -string : string - _lines + 1;</a>
<a name="ln768">      return (numOfLedgers &gt;= 1 &amp;&amp; numOfLedgers &lt;= NUM_OF_BASSSTRINGS_WITH_NUMBER ? numOfLedgers : 0);</a>
<a name="ln769">      }</a>
<a name="ln770"> </a>
<a name="ln771">//---------------------------------------------------------</a>
<a name="ln772">//   physStringToVisual / visualStringToPhys</a>
<a name="ln773">//</a>
<a name="ln774">//    returns the string ordinal in visual order (top to down) from a string ordinal in physical order</a>
<a name="ln775">//    or viceversa: manages upsideDown</a>
<a name="ln776">//---------------------------------------------------------</a>
<a name="ln777"> </a>
<a name="ln778">int StaffType::physStringToVisual(int strg) const</a>
<a name="ln779">      {</a>
<a name="ln780">      if (strg &lt; 0)                       // if above top string, return top string</a>
<a name="ln781">            strg = 0;</a>
<a name="ln782">//      // NO: bass strings may exist, which are in addition to tab string lines</a>
<a name="ln783">//      if (strg &gt;= _lines)                 // if physical string has no visual representation,</a>
<a name="ln784">//            strg = _lines - 1;            // reduce to nearest visual line</a>
<a name="ln785">      // if TAB upside down, flip around top line</a>
<a name="ln786">      return (_upsideDown ? _lines - 1 - strg : strg);</a>
<a name="ln787">      }</a>
<a name="ln788"> </a>
<a name="ln789">int StaffType::visualStringToPhys(int line) const</a>
<a name="ln790">      {</a>
<a name="ln791">      // if TAB upside down, reverse string number</a>
<a name="ln792">      line = (_upsideDown ? _lines - 1 - line : line);</a>
<a name="ln793"> </a>
<a name="ln794">      if (line &lt; 0)           // if above top string, reduce to top string</a>
<a name="ln795">            line = 0;</a>
<a name="ln796">// NO: bass strings may exist, which are in addition to tab string lines</a>
<a name="ln797">//      if (line &gt;= _lines)</a>
<a name="ln798">//            line = _lines - 1;</a>
<a name="ln799">      return line;</a>
<a name="ln800">      }</a>
<a name="ln801"> </a>
<a name="ln802">//---------------------------------------------------------</a>
<a name="ln803">//   physStringToYOffset</a>
<a name="ln804">//</a>
<a name="ln805">//    returns the string Y offset from a string ordinal in physical order:</a>
<a name="ln806">//    manages upsideDown and extra bass strings.</a>
<a name="ln807">//</a>
<a name="ln808">//    The returned values is in sp. and is relative to the staff top line.</a>
<a name="ln809">//</a>
<a name="ln810">//    Note: the difference with physStringToVisual() is that this function takes into account</a>
<a name="ln811">//          peculiarities of bass string notations.</a>
<a name="ln812">//---------------------------------------------------------</a>
<a name="ln813"> </a>
<a name="ln814">qreal StaffType::physStringToYOffset(int strg) const</a>
<a name="ln815">      {</a>
<a name="ln816">      qreal yOffset = strg;                     // the y offset of the visual string, as a multiple of line distance</a>
<a name="ln817">      if (yOffset &lt; 0)                          // if above top physical string, limit to top string</a>
<a name="ln818">            yOffset = 0;</a>
<a name="ln819">      if (yOffset &gt;= _lines) {                  // if physical string 'below' tab lines,</a>
<a name="ln820">            yOffset = _lines;                   // reduce to first string 'below' tab body</a>
<a name="ln821">            if (!_useNumbers)                   // with letters, add some space for the slashes ascender</a>
<a name="ln822">                  yOffset = _onLines ? _lines : _lines + STAFFTYPE_TAB_BASSSLASH_YOFFSET;</a>
<a name="ln823">            }</a>
<a name="ln824">      // if TAB upside down, flip around top line</a>
<a name="ln825">      yOffset = _upsideDown ? (qreal)(_lines - 1) - yOffset : yOffset;</a>
<a name="ln826">      return yOffset * _lineDistance.val();</a>
<a name="ln827">      }</a>
<a name="ln828"> </a>
<a name="ln829">//---------------------------------------------------------</a>
<a name="ln830">//   TabDurationSymbol</a>
<a name="ln831">//---------------------------------------------------------</a>
<a name="ln832"> </a>
<a name="ln833">TabDurationSymbol::TabDurationSymbol(Score* s)</a>
<a name="ln834">   : Element(s, ElementFlag::NOT_SELECTABLE)</a>
<a name="ln835">      {</a>
<a name="ln836">      setGenerated(true);</a>
<a name="ln837">      _beamGrid   = TabBeamGrid::NONE;</a>
<a name="ln838">      _beamLength = 0.0;</a>
<a name="ln839">      _tab        = 0;</a>
<a name="ln840">      _text       = QString();</a>
<a name="ln841">      }</a>
<a name="ln842"> </a>
<a name="ln843">TabDurationSymbol::TabDurationSymbol(Score* s, const StaffType* tab, TDuration::DurationType type, int dots)</a>
<a name="ln844">   : Element(s, ElementFlag::NOT_SELECTABLE)</a>
<a name="ln845">      {</a>
<a name="ln846">      setGenerated(true);</a>
<a name="ln847">      _beamGrid   = TabBeamGrid::NONE;</a>
<a name="ln848">      _beamLength = 0.0;</a>
<a name="ln849">      setDuration(type, dots, tab);</a>
<a name="ln850">      }</a>
<a name="ln851"> </a>
<a name="ln852">TabDurationSymbol::TabDurationSymbol(const TabDurationSymbol&amp; e)</a>
<a name="ln853">   : Element(e)</a>
<a name="ln854">      {</a>
<a name="ln855">      _tab = e._tab;</a>
<a name="ln856">      _text = e._text;</a>
<a name="ln857">      }</a>
<a name="ln858"> </a>
<a name="ln859">//---------------------------------------------------------</a>
<a name="ln860">//   layout</a>
<a name="ln861">//---------------------------------------------------------</a>
<a name="ln862"> </a>
<a name="ln863">void TabDurationSymbol::layout()</a>
<a name="ln864">      {</a>
<a name="ln865">      if(!_tab) {</a>
<a name="ln866">            setbbox(QRectF());</a>
<a name="ln867">            return;</a>
<a name="ln868">            }</a>
<a name="ln869">      qreal _spatium    = spatium();</a>
<a name="ln870">      qreal hbb, wbb, xbb, ybb;     // bbox sizes</a>
<a name="ln871">      qreal xpos, ypos;             // position coords</a>
<a name="ln872"> </a>
<a name="ln873">      _beamGrid = TabBeamGrid::NONE;</a>
<a name="ln874">      Chord* chord = parent() &amp;&amp; parent()-&gt;isChord() ? toChord(parent()) : nullptr;</a>
<a name="ln875">      // if no chord (shouldn't happens...) or not a special beam mode, layout regular symbol</a>
<a name="ln876">      if (!chord || !chord-&gt;isChord() ||</a>
<a name="ln877">            (chord-&gt;beamMode() != Beam::Mode::BEGIN &amp;&amp; chord-&gt;beamMode() != Beam::Mode::MID &amp;&amp;</a>
<a name="ln878">                  chord-&gt;beamMode() != Beam::Mode::END) ) {</a>
<a name="ln879">            QFontMetricsF fm(_tab-&gt;durationFont(), MScore::paintDevice());</a>
<a name="ln880">            hbb   = _tab-&gt;durationBoxH();</a>
<a name="ln881">            wbb   = fm.width(_text);</a>
<a name="ln882">            xbb   = 0.0;</a>
<a name="ln883">            xpos  = 0.0;</a>
<a name="ln884">            ypos  = _tab-&gt;durationFontYOffset();</a>
<a name="ln885">            ybb   = _tab-&gt;durationBoxY() - ypos;</a>
<a name="ln886">            // with rests, move symbol down by half its displacement from staff</a>
<a name="ln887">            if (parent() &amp;&amp; parent()-&gt;isRest()) {</a>
<a name="ln888">                  ybb  += TAB_RESTSYMBDISPL * _spatium;</a>
<a name="ln889">                  ypos += TAB_RESTSYMBDISPL * _spatium;</a>
<a name="ln890">                  }</a>
<a name="ln891">            }</a>
<a name="ln892">      // if on a chord with special beam mode, layout an 'English'-style duration grid</a>
<a name="ln893">      else {</a>
<a name="ln894">            TablatureDurationFont font = _tab-&gt;_durationFonts[_tab-&gt;_durationFontIdx];</a>
<a name="ln895">            hbb   = font.gridStemHeight * _spatium;         // bbox height is stem height</a>
<a name="ln896">            wbb   = font.gridStemWidth  * _spatium;         // bbox width is stem width</a>
<a name="ln897">            xbb   = -wbb * 0.5;                             // bbox is half at left and half at right of stem centre</a>
<a name="ln898">            ybb   = -hbb;                                   // bbox top is at top of stem height</a>
<a name="ln899">            xpos  = 0.75 * _spatium;                        // conventional centring of stem on fret marks</a>
<a name="ln900">            ypos  = _tab-&gt;durationGridYOffset();            // stem start is at bottom</a>
<a name="ln901">            if (chord-&gt;beamMode() == Beam::Mode::BEGIN) {</a>
<a name="ln902">                  _beamGrid   = TabBeamGrid::INITIAL;</a>
<a name="ln903">                  _beamLength = 0.0;</a>
<a name="ln904">                  }</a>
<a name="ln905">            else if (chord-&gt;beamMode() == Beam::Mode::MID || chord-&gt;beamMode() == Beam::Mode::END) {</a>
<a name="ln906">                  _beamLevel  = static_cast&lt;int&gt;(chord-&gt;durationType().type()) - static_cast&lt;int&gt;(font.zeroBeamLevel);</a>
<a name="ln907">                  _beamGrid   = (_beamLevel &lt; 1 ? TabBeamGrid::INITIAL : TabBeamGrid::MEDIALFINAL);</a>
<a name="ln908">                  // _beamLength and bbox x and width will be set in layout2(),</a>
<a name="ln909">                  // once horiz. positions of chords are known</a>
<a name="ln910">                  }</a>
<a name="ln911">            }</a>
<a name="ln912">      // set this' mag from parent chord mag (include staff mag)</a>
<a name="ln913">      qreal mag = chord != nullptr ? chord-&gt;mag() : 1.0;</a>
<a name="ln914">      setMag(mag);</a>
<a name="ln915">      mag = magS();           // local mag * score mag</a>
<a name="ln916">      // set magnified bbox and position</a>
<a name="ln917">      bbox().setRect(xbb * mag, ybb * mag, wbb * mag, hbb * mag);</a>
<a name="ln918">      setPos(xpos*mag, ypos*mag);</a>
<a name="ln919">      }</a>
<a name="ln920"> </a>
<a name="ln921">//---------------------------------------------------------</a>
<a name="ln922">//   layout2</a>
<a name="ln923">//</a>
<a name="ln924">//    Second step: after horizontal positions of elements involved are defined,</a>
<a name="ln925">//    compute width of 'grid beams'</a>
<a name="ln926">//---------------------------------------------------------</a>
<a name="ln927"> </a>
<a name="ln928">void TabDurationSymbol::layout2()</a>
<a name="ln929">      {</a>
<a name="ln930">      // if not within a TAB or not a MEDIALFINAL grid element, do nothing</a>
<a name="ln931">      if(!_tab || _beamGrid != TabBeamGrid::MEDIALFINAL)</a>
<a name="ln932">            return;</a>
<a name="ln933"> </a>
<a name="ln934">      // get 'grid' beam length from page positions of this' chord and previous chord</a>
<a name="ln935">      Chord*      chord       = toChord(parent());</a>
<a name="ln936">      ChordRest*  prevChord   = prevChordRest(chord, true);</a>
<a name="ln937">      if (chord == nullptr || prevChord == nullptr)</a>
<a name="ln938">            return;</a>
<a name="ln939">      qreal       mags        = magS();</a>
<a name="ln940">      qreal       beamLen     = prevChord-&gt;pagePos().x() - chord-&gt;pagePos().x();    // negative</a>
<a name="ln941">      // page pos. difference already includes any magnification in effect:</a>
<a name="ln942">      // scale it down, as it will be magnified again during drawing</a>
<a name="ln943">      _beamLength = beamLen / mags;</a>
<a name="ln944">      // update bbox x and w, but keep current y and h</a>
<a name="ln945">      bbox().setX(beamLen);</a>
<a name="ln946">      // set bbox width to half a stem width (magnified) plus beam length (already magnified)</a>
<a name="ln947">      bbox().setWidth(_tab-&gt;_durationFonts[_tab-&gt;_durationFontIdx].gridStemWidth * spatium() * 0.5 * mags - beamLen);</a>
<a name="ln948">      }</a>
<a name="ln949"> </a>
<a name="ln950">//---------------------------------------------------------</a>
<a name="ln951">//   draw</a>
<a name="ln952">//---------------------------------------------------------</a>
<a name="ln953"> </a>
<a name="ln954">void TabDurationSymbol::draw(QPainter* painter) const</a>
<a name="ln955">      {</a>
<a name="ln956">      if (!_tab)</a>
<a name="ln957">            return;</a>
<a name="ln958"> </a>
<a name="ln959">      if (_repeat &amp;&amp; (_tab-&gt;symRepeat() == TablatureSymbolRepeat::SYSTEM)) {</a>
<a name="ln960">            Chord* chord = toChord(parent());</a>
<a name="ln961">            ChordRest* prevCR = prevChordRest(chord);</a>
<a name="ln962">            if (prevCR &amp;&amp; (chord-&gt;measure()-&gt;system() == prevCR-&gt;measure()-&gt;system()))</a>
<a name="ln963">                  return;</a>
<a name="ln964">            }</a>
<a name="ln965"> </a>
<a name="ln966">      qreal mag = magS();</a>
<a name="ln967">      qreal imag = 1.0 / mag;</a>
<a name="ln968"> </a>
<a name="ln969">      QPen  pen(curColor());</a>
<a name="ln970">      painter-&gt;setPen(pen);</a>
<a name="ln971">      painter-&gt;scale(mag, mag);</a>
<a name="ln972">      if (_beamGrid == TabBeamGrid::NONE) {</a>
<a name="ln973">            // if no beam grid, draw symbol</a>
<a name="ln974">            QFont f(_tab-&gt;durationFont());</a>
<a name="ln975">            f.setPointSizeF(f.pointSizeF() * MScore::pixelRatio);</a>
<a name="ln976">            painter-&gt;setFont(f);</a>
<a name="ln977">            painter-&gt;drawText(QPointF(0.0, 0.0), _text);</a>
<a name="ln978">            }</a>
<a name="ln979">      else {</a>
<a name="ln980">            // if beam grid, draw stem line</a>
<a name="ln981">            TablatureDurationFont&amp; font = _tab-&gt;_durationFonts[_tab-&gt;_durationFontIdx];</a>
<a name="ln982">            qreal _spatium = spatium();</a>
<a name="ln983">            pen.setCapStyle(Qt::FlatCap);</a>
<a name="ln984">            pen.setWidthF(font.gridStemWidth * _spatium);</a>
<a name="ln985">            painter-&gt;setPen(pen);</a>
<a name="ln986">            // take stem height from bbox, but de-magnify it, as drawing is already magnified</a>
<a name="ln987">            qreal h     = bbox().y() / mag;</a>
<a name="ln988">            painter-&gt;drawLine(QPointF(0.0, h), QPointF(0.0, 0.0) );</a>
<a name="ln989">            // if beam grid is medial/final, draw beam lines too: lines go from mid of</a>
<a name="ln990">            // previous stem (delta x stored in _beamLength) to mid of this' stem (0.0)</a>
<a name="ln991">            if (_beamGrid == TabBeamGrid::MEDIALFINAL) {</a>
<a name="ln992">                  pen.setWidthF(font.gridBeamWidth * _spatium);</a>
<a name="ln993">                  painter-&gt;setPen(pen);</a>
<a name="ln994">                  // lower height available to beams by half a beam width,</a>
<a name="ln995">                  // so that top beam upper border aligns with stem top</a>
<a name="ln996">                  h += (font.gridBeamWidth * _spatium) * 0.5;</a>
<a name="ln997">                  // draw beams equally spaced within the stem height (this is</a>
<a name="ln998">                  // different from modern engraving, but common in historic prints)</a>
<a name="ln999">                  qreal step  = -h / _beamLevel;</a>
<a name="ln1000">                  qreal y     = h;</a>
<a name="ln1001">                  for (int i = 0; i &lt; _beamLevel; i++, y += step)</a>
<a name="ln1002">                        painter-&gt;drawLine(QPointF(_beamLength, y), QPointF(0.0, y) );</a>
<a name="ln1003">                  }</a>
<a name="ln1004">            }</a>
<a name="ln1005">      painter-&gt;scale(imag, imag);</a>
<a name="ln1006">      }</a>
<a name="ln1007"> </a>
<a name="ln1008">//---------------------------------------------------------</a>
<a name="ln1009">//   STATIC FUNCTIONS FOR FONT CONFIGURATION MANAGEMENT</a>
<a name="ln1010">//---------------------------------------------------------</a>
<a name="ln1011"> </a>
<a name="ln1012">bool TablatureFretFont::read(XmlReader&amp; e)</a>
<a name="ln1013">      {</a>
<a name="ln1014">      defPitch    = 9.0;</a>
<a name="ln1015">      defYOffset  = 0.0;</a>
<a name="ln1016">      while (e.readNextStartElement()) {</a>
<a name="ln1017">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1018"> </a>
<a name="ln1019">            int val = e.intAttribute(&quot;value&quot;);</a>
<a name="ln1020"> </a>
<a name="ln1021">            if (tag == &quot;family&quot;)</a>
<a name="ln1022">                  family = e.readElementText();</a>
<a name="ln1023">            else if (tag == &quot;displayName&quot;)</a>
<a name="ln1024">                  displayName = e.readElementText();</a>
<a name="ln1025">            else if (tag == &quot;defaultPitch&quot;)</a>
<a name="ln1026">                  defPitch = e.readDouble();</a>
<a name="ln1027">            else if (tag == &quot;defaultYOffset&quot;)</a>
<a name="ln1028">                  defYOffset = e.readDouble();</a>
<a name="ln1029">            else if (tag == &quot;mark&quot;) {</a>
<a name="ln1030">                  QString     sval = e.attribute(&quot;value&quot;);</a>
<a name="ln1031">                  int         num  = e.intAttribute(&quot;number&quot;, 1);</a>
<a name="ln1032">                  QString     txt(e.readElementText());</a>
<a name="ln1033">                  if (sval.size() &lt; 1)</a>
<a name="ln1034">                        return false;</a>
<a name="ln1035">                  if (sval == &quot;x&quot;)</a>
<a name="ln1036">                        xChar = txt[0];</a>
<a name="ln1037">                  else if (sval == &quot;ghost&quot;)</a>
<a name="ln1038">                        ghostChar = txt[0];</a>
<a name="ln1039">                  else if (sval == &quot;slash&quot;) {</a>
<a name="ln1040">                        // limit within legal range</a>
<a name="ln1041">                        if (num &lt; 1)</a>
<a name="ln1042">                              num = 1;</a>
<a name="ln1043">                        if (num &gt; NUM_OF_BASSSTRING_SLASHES)</a>
<a name="ln1044">                              num = NUM_OF_BASSSTRING_SLASHES;</a>
<a name="ln1045">                        slashChar[num-1] = txt;</a>
<a name="ln1046">                        }</a>
<a name="ln1047">                  }</a>
<a name="ln1048">            else if (tag == &quot;fret&quot;) {</a>
<a name="ln1049">                  bool bLetter = e.intAttribute(&quot;letter&quot;);</a>
<a name="ln1050">                  QString txt(e.readElementText());</a>
<a name="ln1051">                  if (bLetter) {</a>
<a name="ln1052">                        if (val &gt;= 0 &amp;&amp; val &lt; NUM_OF_LETTERFRETS)</a>
<a name="ln1053">                              displayLetter[val] = txt[0];</a>
<a name="ln1054">                        }</a>
<a name="ln1055">                  else {</a>
<a name="ln1056">                        if (val &gt;= 0 &amp;&amp; val &lt; NUM_OF_DIGITFRETS)</a>
<a name="ln1057">                              displayDigit[val] = txt;</a>
<a name="ln1058">                        }</a>
<a name="ln1059">                  }</a>
<a name="ln1060">            else {</a>
<a name="ln1061">                  e.unknown();</a>
<a name="ln1062">                  return false;</a>
<a name="ln1063">                  }</a>
<a name="ln1064">            }</a>
<a name="ln1065">      return true;</a>
<a name="ln1066">      }</a>
<a name="ln1067"> </a>
<a name="ln1068">bool TablatureDurationFont::read(XmlReader&amp; e)</a>
<a name="ln1069">      {</a>
<a name="ln1070">      while (e.readNextStartElement()) {</a>
<a name="ln1071">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1072"> </a>
<a name="ln1073">            if (tag == &quot;family&quot;)</a>
<a name="ln1074">                  family = e.readElementText();</a>
<a name="ln1075">            else if (tag == &quot;displayName&quot;)</a>
<a name="ln1076">                  displayName = e.readElementText();</a>
<a name="ln1077">            else if (tag == &quot;defaultPitch&quot;)</a>
<a name="ln1078">                  defPitch = e.readDouble();</a>
<a name="ln1079">            else if (tag == &quot;defaultYOffset&quot;)</a>
<a name="ln1080">                  defYOffset = e.readDouble();</a>
<a name="ln1081">            else if (tag == &quot;beamWidth&quot;)</a>
<a name="ln1082">                  gridBeamWidth = e.readDouble();</a>
<a name="ln1083">            else if (tag == &quot;stemHeight&quot;)</a>
<a name="ln1084">                  gridStemHeight = e.readDouble();</a>
<a name="ln1085">            else if (tag == &quot;stemWidth&quot;)</a>
<a name="ln1086">                  gridStemWidth = e.readDouble();</a>
<a name="ln1087">            else if (tag == &quot;zeroBeamValue&quot;) {</a>
<a name="ln1088">                  QString val(e.readElementText());</a>
<a name="ln1089">                  if (val == &quot;longa&quot;)</a>
<a name="ln1090">                        zeroBeamLevel = TDuration::DurationType::V_LONG;</a>
<a name="ln1091">                  else if (val == &quot;brevis&quot;)</a>
<a name="ln1092">                        zeroBeamLevel = TDuration::DurationType::V_BREVE;</a>
<a name="ln1093">                  else if (val == &quot;semibrevis&quot;)</a>
<a name="ln1094">                        zeroBeamLevel = TDuration::DurationType::V_WHOLE;</a>
<a name="ln1095">                  else if (val == &quot;minima&quot;)</a>
<a name="ln1096">                        zeroBeamLevel = TDuration::DurationType::V_HALF;</a>
<a name="ln1097">                  else if (val == &quot;semiminima&quot;)</a>
<a name="ln1098">                        zeroBeamLevel = TDuration::DurationType::V_QUARTER;</a>
<a name="ln1099">                  else if (val == &quot;fusa&quot;)</a>
<a name="ln1100">                        zeroBeamLevel = TDuration::DurationType::V_EIGHTH;</a>
<a name="ln1101">                  else if (val == &quot;semifusa&quot;)</a>
<a name="ln1102">                        zeroBeamLevel = TDuration::DurationType::V_16TH;</a>
<a name="ln1103">                  else if (val == &quot;32&quot;)</a>
<a name="ln1104">                        zeroBeamLevel = TDuration::DurationType::V_32ND;</a>
<a name="ln1105">                  else if (val == &quot;64&quot;)</a>
<a name="ln1106">                        zeroBeamLevel = TDuration::DurationType::V_64TH;</a>
<a name="ln1107">                  else if (val == &quot;128&quot;)</a>
<a name="ln1108">                        zeroBeamLevel = TDuration::DurationType::V_128TH;</a>
<a name="ln1109">                  else if (val == &quot;256&quot;)</a>
<a name="ln1110">                        zeroBeamLevel = TDuration::DurationType::V_256TH;</a>
<a name="ln1111">                  else</a>
<a name="ln1112">                        e.unknown();</a>
<a name="ln1113">                  }</a>
<a name="ln1114">            else if (tag == &quot;duration&quot;) {</a>
<a name="ln1115">                  QString val = e.attribute(&quot;value&quot;);</a>
<a name="ln1116">                  QString txt(e.readElementText());</a>
<a name="ln1117">                  QChar chr = txt[0];</a>
<a name="ln1118">                  if (val == &quot;longa&quot;)</a>
<a name="ln1119">                        displayValue[int(TabVal::VAL_LONGA)] = chr;</a>
<a name="ln1120">                  else if (val == &quot;brevis&quot;)</a>
<a name="ln1121">                        displayValue[int(TabVal::VAL_BREVIS)] = chr;</a>
<a name="ln1122">                  else if (val == &quot;semibrevis&quot;)</a>
<a name="ln1123">                        displayValue[int(TabVal::VAL_SEMIBREVIS)] = chr;</a>
<a name="ln1124">                  else if (val == &quot;minima&quot;)</a>
<a name="ln1125">                        displayValue[int(TabVal::VAL_MINIMA)] = chr;</a>
<a name="ln1126">                  else if (val == &quot;semiminima&quot;)</a>
<a name="ln1127">                        displayValue[int(TabVal::VAL_SEMIMINIMA)] = chr;</a>
<a name="ln1128">                  else if (val == &quot;fusa&quot;)</a>
<a name="ln1129">                        displayValue[int(TabVal::VAL_FUSA)] = chr;</a>
<a name="ln1130">                  else if (val == &quot;semifusa&quot;)</a>
<a name="ln1131">                        displayValue[int(TabVal::VAL_SEMIFUSA)] = chr;</a>
<a name="ln1132">                  else if (val == &quot;32&quot;)</a>
<a name="ln1133">                        displayValue[int(TabVal::VAL_32)] = chr;</a>
<a name="ln1134">                  else if (val == &quot;64&quot;)</a>
<a name="ln1135">                        displayValue[int(TabVal::VAL_64)] = chr;</a>
<a name="ln1136">                  else if (val == &quot;128&quot;)</a>
<a name="ln1137">                        displayValue[int(TabVal::VAL_128)] = chr;</a>
<a name="ln1138">                  else if (val == &quot;256&quot;)</a>
<a name="ln1139">                        displayValue[int(TabVal::VAL_256)] = chr;</a>
<a name="ln1140">                  else if (val == &quot;dot&quot;)</a>
<a name="ln1141">                        displayDot = chr;</a>
<a name="ln1142">                  else</a>
<a name="ln1143">                        e.unknown();</a>
<a name="ln1144">                  }</a>
<a name="ln1145">            else {</a>
<a name="ln1146">                  e.unknown();</a>
<a name="ln1147">                  return false;</a>
<a name="ln1148">                  }</a>
<a name="ln1149">            }</a>
<a name="ln1150">      return true;</a>
<a name="ln1151">      }</a>
<a name="ln1152"> </a>
<a name="ln1153">//---------------------------------------------------------</a>
<a name="ln1154">//   Read Configuration File</a>
<a name="ln1155">//</a>
<a name="ln1156">//    reads a configuration and appends read data to g_TABFonts</a>
<a name="ln1157">//    resets everything and reads the built-in config file if fileName is null or empty</a>
<a name="ln1158">//---------------------------------------------------------</a>
<a name="ln1159"> </a>
<a name="ln1160">bool StaffType::readConfigFile(const QString&amp; fileName)</a>
<a name="ln1161">      {</a>
<a name="ln1162">      QString path;</a>
<a name="ln1163"> </a>
<a name="ln1164">      if (fileName == 0 || fileName.isEmpty()) {       // defaults to built-in xml</a>
<a name="ln1165">#ifdef Q_OS_IOS</a>
<a name="ln1166">            {</a>
<a name="ln1167">            extern QString resourcePath();</a>
<a name="ln1168">            QString rpath = resourcePath();</a>
<a name="ln1169">            path = rpath + QString(&quot;/fonts_tablature.xml&quot;);</a>
<a name="ln1170">            }</a>
<a name="ln1171">#else</a>
<a name="ln1172">            path = &quot;:/fonts/fonts_tablature.xml&quot;;</a>
<a name="ln1173">#endif</a>
<a name="ln1174">            _durationFonts.clear();</a>
<a name="ln1175">            _fretFonts.clear();</a>
<a name="ln1176">            }</a>
<a name="ln1177">      else</a>
<a name="ln1178">            path = fileName;</a>
<a name="ln1179"> </a>
<a name="ln1180">      QFileInfo fi(path);</a>
<a name="ln1181">      QFile f(path);</a>
<a name="ln1182"> </a>
<a name="ln1183">      if (!fi.exists() || !f.open(QIODevice::ReadOnly)) {</a>
<a name="ln1184">            MScore::lastError = QObject::tr(&quot;Cannot open tablature font description:\n%1\n%2&quot;).arg(f.fileName()).arg(f.errorString());</a>
<a name="ln1185">            qDebug(&quot;StaffTypeTablature::readConfigFile failed: &lt;%s&gt;&quot;, qPrintable(path));</a>
<a name="ln1186">            return false;</a>
<a name="ln1187">            }</a>
<a name="ln1188"> </a>
<a name="ln1189">      XmlReader e(&amp;f);</a>
<a name="ln1190">      while (e.readNextStartElement()) {</a>
<a name="ln1191">            if (e.name() == &quot;museScore&quot;) {</a>
<a name="ln1192">                  while (e.readNextStartElement()) {</a>
<a name="ln1193">                        const QStringRef&amp; tag(e.name());</a>
<a name="ln1194">                        if (tag == &quot;fretFont&quot;) {</a>
<a name="ln1195">                              TablatureFretFont ff;</a>
<a name="ln1196">                              if (ff.read(e))</a>
<a name="ln1197">                                    _fretFonts.append(ff);</a>
<a name="ln1198">                              else</a>
<a name="ln1199">                                    continue;</a>
<a name="ln1200">                              }</a>
<a name="ln1201">                        else if (tag == &quot;durationFont&quot;) {</a>
<a name="ln1202">                              TablatureDurationFont df;</a>
<a name="ln1203">                              if (df.read(e))</a>
<a name="ln1204">                                    _durationFonts.append(df);</a>
<a name="ln1205">                              else</a>
<a name="ln1206">                                    continue;</a>
<a name="ln1207">                              }</a>
<a name="ln1208">                        else</a>
<a name="ln1209">                              e.unknown();</a>
<a name="ln1210">                        }</a>
<a name="ln1211">                  return true;</a>
<a name="ln1212">                  }</a>
<a name="ln1213">            }</a>
<a name="ln1214">      return false;</a>
<a name="ln1215">      }</a>
<a name="ln1216"> </a>
<a name="ln1217">//---------------------------------------------------------</a>
<a name="ln1218">//   fontNames</a>
<a name="ln1219">//</a>
<a name="ln1220">//    returns a list of display names for the fonts  configured to work with Tablatures;</a>
<a name="ln1221">//    the index of a name in the list can be used to retrieve the font data with fontData()</a>
<a name="ln1222">//---------------------------------------------------------</a>
<a name="ln1223"> </a>
<a name="ln1224">QList&lt;QString&gt; StaffType::fontNames(bool bDuration)</a>
<a name="ln1225">      {</a>
<a name="ln1226">      QList&lt;QString&gt; names;</a>
<a name="ln1227">      if(bDuration)</a>
<a name="ln1228">            foreach(const TablatureDurationFont&amp; f, _durationFonts)</a>
<a name="ln1229">                  names.append(f.displayName);</a>
<a name="ln1230">      else</a>
<a name="ln1231">            foreach(const TablatureFretFont&amp; f, _fretFonts)</a>
<a name="ln1232">                  names.append(f.displayName);</a>
<a name="ln1233">      return names;</a>
<a name="ln1234">      }</a>
<a name="ln1235"> </a>
<a name="ln1236">//---------------------------------------------------------</a>
<a name="ln1237">//   fontData</a>
<a name="ln1238">//</a>
<a name="ln1239">//    retrieves data about a Tablature font.</a>
<a name="ln1240">//    returns: true if idx is valid | false if it is not</a>
<a name="ln1241">// any of the pointer parameter can be null, if that datum is not needed</a>
<a name="ln1242">//---------------------------------------------------------</a>
<a name="ln1243"> </a>
<a name="ln1244">bool StaffType::fontData(bool bDuration, int nIdx, QString* pFamily, QString* pDisplayName,</a>
<a name="ln1245">   qreal* pSize, qreal* pYOff)</a>
<a name="ln1246">      {</a>
<a name="ln1247">      if (bDuration) {</a>
<a name="ln1248">            if (nIdx &gt;= 0 &amp;&amp; nIdx &lt; _durationFonts.size()) {</a>
<a name="ln1249">                  TablatureDurationFont f = _durationFonts.at(nIdx);</a>
<a name="ln1250">                  if (pFamily)      *pFamily          = f.family;</a>
<a name="ln1251">                  if (pDisplayName) *pDisplayName     = f.displayName;</a>
<a name="ln1252">                  if (pSize)        *pSize            = f.defPitch;</a>
<a name="ln1253">                  if (pYOff)        *pYOff            = f.defYOffset;</a>
<a name="ln1254">                  return true;</a>
<a name="ln1255">                  }</a>
<a name="ln1256">            }</a>
<a name="ln1257">      else {</a>
<a name="ln1258">            if (nIdx &gt;= 0 &amp;&amp; nIdx &lt; _fretFonts.size()) {</a>
<a name="ln1259">                  TablatureFretFont f = _fretFonts.at(nIdx);</a>
<a name="ln1260">                  if (pFamily)      *pFamily          = f.family;</a>
<a name="ln1261">                  if (pDisplayName) *pDisplayName     = f.displayName;</a>
<a name="ln1262">                  if (pSize)        *pSize            = f.defPitch;</a>
<a name="ln1263">                  if (pYOff)        *pYOff            = f.defYOffset;</a>
<a name="ln1264">                  return true;</a>
<a name="ln1265">                  }</a>
<a name="ln1266">            }</a>
<a name="ln1267">      return false;</a>
<a name="ln1268">      }</a>
<a name="ln1269"> </a>
<a name="ln1270">//=========================================================</a>
<a name="ln1271">//</a>
<a name="ln1272">//   BUILT-IN STAFF TYPES and STAFF TYPE PRESETS</a>
<a name="ln1273">//</a>
<a name="ln1274">//=========================================================</a>
<a name="ln1275"> </a>
<a name="ln1276">static const int _defaultPreset[STAFF_GROUP_MAX] =</a>
<a name="ln1277">      { 0,              // default pitched preset is &quot;stdNormal&quot;</a>
<a name="ln1278">        3,              // default percussion preset is &quot;perc5lines&quot;</a>
<a name="ln1279">        5               // default tab preset is &quot;tab6StrCommon&quot;</a>
<a name="ln1280">      };</a>
<a name="ln1281"> </a>
<a name="ln1282">static const QString _emptyString = QString();</a>
<a name="ln1283"> </a>
<a name="ln1284">//---------------------------------------------------------</a>
<a name="ln1285">//   Static functions for StaffType presets</a>
<a name="ln1286">//---------------------------------------------------------</a>
<a name="ln1287"> </a>
<a name="ln1288">const StaffType* StaffType::preset(StaffTypes idx)</a>
<a name="ln1289">      {</a>
<a name="ln1290">      if (int(idx) &lt; 0 || int(idx) &gt;= int(_presets.size()))</a>
<a name="ln1291">            return &amp;_presets[0];</a>
<a name="ln1292">      return &amp;_presets[int(idx)];</a>
<a name="ln1293">      }</a>
<a name="ln1294"> </a>
<a name="ln1295">const StaffType* StaffType::presetFromXmlName(QString&amp; xmlName)</a>
<a name="ln1296">      {</a>
<a name="ln1297">      for (size_t i = 0; i &lt; _presets.size(); ++i) {</a>
<a name="ln1298">            if (_presets[i].xmlName() == xmlName)</a>
<a name="ln1299">                  return &amp;_presets[i];</a>
<a name="ln1300">            }</a>
<a name="ln1301">      return 0;</a>
<a name="ln1302">      }</a>
<a name="ln1303">#if 0</a>
<a name="ln1304">const StaffType* StaffType::presetFromName(QString&amp; name)</a>
<a name="ln1305">      {</a>
<a name="ln1306">      for (size_t i = 0; i &lt; _presets.size(); ++i) {</a>
<a name="ln1307">            if (_presets[i].name() == name)</a>
<a name="ln1308">                  return &amp;_presets[i];</a>
<a name="ln1309">            }</a>
<a name="ln1310">      return 0;</a>
<a name="ln1311">      }</a>
<a name="ln1312">#endif</a>
<a name="ln1313">const StaffType* StaffType::getDefaultPreset(StaffGroup grp)</a>
<a name="ln1314">      {</a>
<a name="ln1315">      int _idx = _defaultPreset[int(grp)];</a>
<a name="ln1316">      return &amp;_presets[_idx];</a>
<a name="ln1317">      }</a>
<a name="ln1318"> </a>
<a name="ln1319">//---------------------------------------------------------</a>
<a name="ln1320">//   NoteHeadScheme utils</a>
<a name="ln1321">//---------------------------------------------------------</a>
<a name="ln1322"> </a>
<a name="ln1323">struct NoteHeadSchemeName {</a>
<a name="ln1324">      const char* name;</a>
<a name="ln1325">      const char* username;</a>
<a name="ln1326">      };</a>
<a name="ln1327"> </a>
<a name="ln1328">static NoteHeadSchemeName noteHeadSchemeNames[] = {</a>
<a name="ln1329">      {&quot;normal&quot;,              QT_TRANSLATE_NOOP(&quot;noteheadschemes&quot;, &quot;Normal&quot;) },</a>
<a name="ln1330">      {&quot;name-pitch&quot;,          QT_TRANSLATE_NOOP(&quot;noteheadschemes&quot;, &quot;Pitch Names&quot;) },</a>
<a name="ln1331">      {&quot;name-pitch-german&quot;,   QT_TRANSLATE_NOOP(&quot;noteheadschemes&quot;, &quot;German Pitch Names&quot;) },</a>
<a name="ln1332">      {&quot;solfege-movable&quot;,     QT_TRANSLATE_NOOP(&quot;noteheadschemes&quot;, &quot;Solf\u00e8ge Movable Do&quot;) }, // &amp;egrave;</a>
<a name="ln1333">      {&quot;solfege-fixed&quot;,       QT_TRANSLATE_NOOP(&quot;noteheadschemes&quot;, &quot;Solf\u00e8ge Fixed Do&quot;) },   // &amp;egrave;</a>
<a name="ln1334">      {&quot;shape-4&quot;,             QT_TRANSLATE_NOOP(&quot;noteheadschemes&quot;, &quot;4-shape (Walker)&quot;) },</a>
<a name="ln1335">      {&quot;shape-7-aikin&quot;,       QT_TRANSLATE_NOOP(&quot;noteheadschemes&quot;, &quot;7-shape (Aikin)&quot;) },</a>
<a name="ln1336">      {&quot;shape-7-funk&quot;,        QT_TRANSLATE_NOOP(&quot;noteheadschemes&quot;, &quot;7-shape (Funk)&quot;) },</a>
<a name="ln1337">      {&quot;shape-7-walker&quot;,      QT_TRANSLATE_NOOP(&quot;noteheadschemes&quot;, &quot;7-shape (Walker)&quot;) }</a>
<a name="ln1338">      };</a>
<a name="ln1339"> </a>
<a name="ln1340">QString StaffType::scheme2userName(NoteHeadScheme ns)</a>
<a name="ln1341">      {</a>
<a name="ln1342">      return qApp-&gt;translate(&quot;noteheadschemes&quot;, noteHeadSchemeNames[int(ns)].username);</a>
<a name="ln1343">      }</a>
<a name="ln1344"> </a>
<a name="ln1345">QString StaffType::scheme2name(NoteHeadScheme ns)</a>
<a name="ln1346">      {</a>
<a name="ln1347">      return noteHeadSchemeNames[int(ns)].name;</a>
<a name="ln1348">      }</a>
<a name="ln1349"> </a>
<a name="ln1350">NoteHeadScheme StaffType::name2scheme(QString name)</a>
<a name="ln1351">      {</a>
<a name="ln1352">      for (int i = 0; i &lt; int(NoteHeadScheme::HEAD_SCHEMES); ++i) {</a>
<a name="ln1353">            if (noteHeadSchemeNames[i].name == name)</a>
<a name="ln1354">                  return NoteHeadScheme(i);</a>
<a name="ln1355">            }</a>
<a name="ln1356">      return NoteHeadScheme::HEAD_NORMAL;</a>
<a name="ln1357">      }</a>
<a name="ln1358"> </a>
<a name="ln1359">//---------------------------------------------------------</a>
<a name="ln1360">//   initStaffTypes</a>
<a name="ln1361">//---------------------------------------------------------</a>
<a name="ln1362"> </a>
<a name="ln1363">std::vector&lt;StaffType&gt; StaffType::_presets;</a>
<a name="ln1364"> </a>
<a name="ln1365">void StaffType::initStaffTypes()</a>
<a name="ln1366">      {</a>
<a name="ln1367">      readConfigFile(0);          // get TAB font config, before initStaffTypes()</a>
<a name="ln1368"> </a>
<a name="ln1369">      // keep in sync with enum class StaffTypes</a>
<a name="ln1370">      _presets = {</a>
<a name="ln1371">//                       group,              xml-name,  human-readable-name,          lin stpOff  dist clef   bars stmless time  key    ledger</a>
<a name="ln1372">         StaffType(StaffGroup::STANDARD,   &quot;stdNormal&quot;, QObject::tr(&quot;Standard&quot;),        5, 0,     1,   true,  true, false, true, true,  true),</a>
<a name="ln1373">//       StaffType(StaffGroup::PERCUSSION, &quot;perc1Line&quot;, QObject::tr(&quot;Perc. 1 line&quot;),    1, -4,    1,   true,  true, false, true, false, true),</a>
<a name="ln1374">         StaffType(StaffGroup::PERCUSSION, &quot;perc1Line&quot;, QObject::tr(&quot;Perc. 1 line&quot;),    1, 0,     1,   true,  true, false, true, false, true),</a>
<a name="ln1375">         StaffType(StaffGroup::PERCUSSION, &quot;perc3Line&quot;, QObject::tr(&quot;Perc. 3 lines&quot;),   3, 0,     2,   true,  true, false, true, false, true),</a>
<a name="ln1376">         StaffType(StaffGroup::PERCUSSION, &quot;perc5Line&quot;, QObject::tr(&quot;Perc. 5 lines&quot;),   5, 0,     1,   true,  true, false, true, false, true),</a>
<a name="ln1377">//                 group            xml-name,     human-readable-name                  lin stpOff dist clef   bars stemless time      duration font     size off genDur     fret font          size off  duration symbol repeat      thru       minim style              onLin  rests  stmDn  stmThr upsDn  sTFing nums  bkTied</a>
<a name="ln1378">//       StaffType(StaffGroup::TAB, &quot;tab6StrSimple&quot;, QObject::tr(&quot;Tab. 6-str. simple&quot;), 6, 2,     1.5, true,  true, true,  false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Sans&quot;,    9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::NONE,   true,  false, true,  false, false, false, true, false),</a>
<a name="ln1379">//       StaffType(StaffGroup::TAB, &quot;tab6StrCommon&quot;, QObject::tr(&quot;Tab. 6-str. common&quot;), 6, 2,     1.5, true,  true, false, false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Serif&quot;,   9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::SHORTER,true,  false, true,  false, false, false, true, true),</a>
<a name="ln1380">//       StaffType(StaffGroup::TAB, &quot;tab6StrFull&quot;,   QObject::tr(&quot;Tab. 6-str. full&quot;),   6, 2,     1.5, true,  true, false, true,  &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Serif&quot;,   9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::SLASHED,true,  true,  true,  true,  false, false, true, true),</a>
<a name="ln1381">         StaffType(StaffGroup::TAB, &quot;tab6StrSimple&quot;, QObject::tr(&quot;Tab. 6-str. simple&quot;), 6, 0,     1.5, true,  true, true,  false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Sans&quot;,    9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::NONE,   true,  false, true,  false, false, false, true, false),</a>
<a name="ln1382">         StaffType(StaffGroup::TAB, &quot;tab6StrCommon&quot;, QObject::tr(&quot;Tab. 6-str. common&quot;), 6, 0,     1.5, true,  true, false, false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Serif&quot;,   9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::SHORTER,true,  false, true,  false, false, false, true, true),</a>
<a name="ln1383">         StaffType(StaffGroup::TAB, &quot;tab6StrFull&quot;,   QObject::tr(&quot;Tab. 6-str. full&quot;),   6, 0,     1.5, true,  true, false, true,  &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Serif&quot;,   9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::SLASHED,true,  true,  true,  true,  false, false, true, true),</a>
<a name="ln1384">         StaffType(StaffGroup::TAB, &quot;tab4StrSimple&quot;, QObject::tr(&quot;Tab. 4-str. simple&quot;), 4, 0,     1.5, true,  true, true,  false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Sans&quot;,    9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::NONE,   true,  false, true,  false, false, false, true, false),</a>
<a name="ln1385">         StaffType(StaffGroup::TAB, &quot;tab4StrCommon&quot;, QObject::tr(&quot;Tab. 4-str. common&quot;), 4, 0,     1.5, true,  true, false, false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Serif&quot;,   9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::SHORTER,true,  false, true,  false, false, false, true, true),</a>
<a name="ln1386">         StaffType(StaffGroup::TAB, &quot;tab4StrFull&quot;,   QObject::tr(&quot;Tab. 4-str. full&quot;),   4, 0,     1.5, true,  true, false, false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Serif&quot;,   9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::SLASHED,true,  true,  true,  true,  false, false, true, true),</a>
<a name="ln1387">         StaffType(StaffGroup::TAB, &quot;tab5StrSimple&quot;, QObject::tr(&quot;Tab. 5-str. simple&quot;), 5, 0,     1.5, true,  true, true,  false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Sans&quot;,    9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::NONE,   true,  false, true,  false, false, false, true, false),</a>
<a name="ln1388">         StaffType(StaffGroup::TAB, &quot;tab5StrCommon&quot;, QObject::tr(&quot;Tab. 5-str. common&quot;), 5, 0,     1.5, true,  true, false, false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Serif&quot;,   9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::SHORTER,true,  false, true,  false, false, false, true, true),</a>
<a name="ln1389">         StaffType(StaffGroup::TAB, &quot;tab5StrFull&quot;,   QObject::tr(&quot;Tab. 5-str. full&quot;),   5, 0,     1.5, true,  true, false, false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Serif&quot;,   9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::SLASHED,true,  true,  true,  true,  false, false, true, true),</a>
<a name="ln1390">         StaffType(StaffGroup::TAB, &quot;tabUkulele&quot;,    QObject::tr(&quot;Tab. ukulele&quot;),       4, 0,     1.5, true,  true, false, false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Serif&quot;,   9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::SHORTER,true,  true,  true,  false, false, false, true, true),</a>
<a name="ln1391">         StaffType(StaffGroup::TAB, &quot;tabBalajka&quot;,    QObject::tr(&quot;Tab. balalaika&quot;),     3, 0,     1.5, true,  true, false, false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Serif&quot;,   9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::SHORTER,true,  true,  true,  false, false, false, true, true),</a>
<a name="ln1392">//       StaffType(StaffGroup::TAB, &quot;tab6StrItalian&quot;,QObject::tr(&quot;Tab. 6-str. Italian&quot;),6, 2,     1.5, false, true, true,  true,  &quot;MuseScore Tab Italian&quot;,15, 0, true,  &quot;MuseScore Tab Renaiss&quot;,10, 0, TablatureSymbolRepeat::NEVER, true,  TablatureMinimStyle::NONE,   true,  true,  false, false, true,  false, true, false),</a>
<a name="ln1393">//       StaffType(StaffGroup::TAB, &quot;tab6StrFrench&quot;, QObject::tr(&quot;Tab. 6-str. French&quot;), 6, 2,     1.5, false, true, true,  true,  &quot;MuseScore Tab French&quot;, 15, 0, true,  &quot;MuseScore Tab Renaiss&quot;,10, 0, TablatureSymbolRepeat::NEVER, true,  TablatureMinimStyle::NONE,   false, false, false, false, false, false, false,false)</a>
<a name="ln1394">         StaffType(StaffGroup::TAB, &quot;tab6StrItalian&quot;,QObject::tr(&quot;Tab. 6-str. Italian&quot;),6, 0,     1.5, false, true, true,  true,  &quot;MuseScore Tab Italian&quot;,15, 0, true,  &quot;MuseScore Tab Renaiss&quot;,10, 0, TablatureSymbolRepeat::NEVER, true,  TablatureMinimStyle::NONE,   true,  true,  false, false, true,  false, true, false),</a>
<a name="ln1395">         StaffType(StaffGroup::TAB, &quot;tab6StrFrench&quot;, QObject::tr(&quot;Tab. 6-str. French&quot;), 6, 0,     1.5, false, true, true,  true,  &quot;MuseScore Tab French&quot;, 15, 0, true,  &quot;MuseScore Tab Renaiss&quot;,10, 0, TablatureSymbolRepeat::NEVER, true,  TablatureMinimStyle::NONE,   false, false, false, false, false, false, false,false),</a>
<a name="ln1396">         StaffType(StaffGroup::TAB, &quot;tab7StrCommon&quot;, QObject::tr(&quot;Tab. 7-str. common&quot;), 7, 0,     1.5, true,  true, false, false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Serif&quot;,   9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::SHORTER,true,  false, true,  false, false, false, true, true),</a>
<a name="ln1397">         StaffType(StaffGroup::TAB, &quot;tab8StrCommon&quot;, QObject::tr(&quot;Tab. 8-str. common&quot;), 8, 0,     1.5, true,  true, false, false, &quot;MuseScore Tab Modern&quot;, 15, 0, false, &quot;MuseScore Tab Serif&quot;,   9, 0, TablatureSymbolRepeat::NEVER, false, TablatureMinimStyle::SHORTER,true,  false, true,  false, false, false, true, true),</a>
<a name="ln1398">         };</a>
<a name="ln1399">      }</a>
<a name="ln1400"> </a>
<a name="ln1401">//---------------------------------------------------------</a>
<a name="ln1402">//   spatium</a>
<a name="ln1403">//---------------------------------------------------------</a>
<a name="ln1404"> </a>
<a name="ln1405">qreal StaffType::spatium(Score* score) const</a>
<a name="ln1406">      {</a>
<a name="ln1407">      return score-&gt;spatium() * (small() ? score-&gt;styleD(Sid::smallStaffMag) : 1.0) * userMag();</a>
<a name="ln1408">      }</a>
<a name="ln1409"> </a>
<a name="ln1410">} // namespace Ms</a>
<a name="ln1411"> </a>

</code></pre>
<div class="balloon" rel="273"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="1185"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="1381"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1382"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1383"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1384"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1385"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1386"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1387"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1388"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1389"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1390"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1391"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1394"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1395"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1396"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="1397"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> The bool type is implicitly cast to the double type. Inspect the 14th argument.</p></div>
<div class="balloon" rel="833"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: _beamLevel, _repeat.</p></div>
<div class="balloon" rel="843"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> It is possible that not all members of a class are initialized inside the constructor. Consider inspecting: _beamLevel, _repeat.</p></div>
<div class="balloon" rel="852"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: _beamLength, _beamLevel, _beamGrid, _repeat.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
