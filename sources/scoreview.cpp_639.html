
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>scoreview.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2017 Werner Schweer &amp; others</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;scoreview.h&quot;</a>
<a name="ln14"> </a>
<a name="ln15">#include &quot;breaksdialog.h&quot;</a>
<a name="ln16">#include &quot;continuouspanel.h&quot;</a>
<a name="ln17">#include &quot;drumroll.h&quot;</a>
<a name="ln18">#include &quot;editdrumset.h&quot;</a>
<a name="ln19">#include &quot;editstaff.h&quot;</a>
<a name="ln20">#include &quot;globals.h&quot;</a>
<a name="ln21">#include &quot;magbox.h&quot;</a>
<a name="ln22">#include &quot;measureproperties.h&quot;</a>
<a name="ln23">#include &quot;musescore.h&quot;</a>
<a name="ln24">#include &quot;navigator.h&quot;</a>
<a name="ln25">#include &quot;preferences.h&quot;</a>
<a name="ln26">#include &quot;scoreaccessibility.h&quot;</a>
<a name="ln27">#include &quot;scoretab.h&quot;</a>
<a name="ln28">#include &quot;seq.h&quot;</a>
<a name="ln29">#include &quot;splitstaff.h&quot;</a>
<a name="ln30">#include &quot;textcursor.h&quot;</a>
<a name="ln31">#include &quot;textpalette.h&quot;</a>
<a name="ln32">#include &quot;texttools.h&quot;</a>
<a name="ln33">#include &quot;fotomode.h&quot;</a>
<a name="ln34">#include &quot;tourhandler.h&quot;</a>
<a name="ln35"> </a>
<a name="ln36">#include &quot;inspector/inspector.h&quot;</a>
<a name="ln37"> </a>
<a name="ln38">#include &quot;libmscore/articulation.h&quot;</a>
<a name="ln39">#include &quot;libmscore/barline.h&quot;</a>
<a name="ln40">#include &quot;libmscore/box.h&quot;</a>
<a name="ln41">#include &quot;libmscore/chord.h&quot;</a>
<a name="ln42">#include &quot;libmscore/clef.h&quot;</a>
<a name="ln43">#include &quot;libmscore/dynamic.h&quot;</a>
<a name="ln44">#include &quot;libmscore/excerpt.h&quot;</a>
<a name="ln45">#include &quot;libmscore/figuredbass.h&quot;</a>
<a name="ln46">#include &quot;libmscore/fingering.h&quot;</a>
<a name="ln47">#include &quot;libmscore/hairpin.h&quot;</a>
<a name="ln48">#include &quot;libmscore/harmony.h&quot;</a>
<a name="ln49">#include &quot;libmscore/fret.h&quot;</a>
<a name="ln50">#include &quot;libmscore/icon.h&quot;</a>
<a name="ln51">#include &quot;libmscore/image.h&quot;</a>
<a name="ln52">#include &quot;libmscore/instrchange.h&quot;</a>
<a name="ln53">#include &quot;libmscore/keysig.h&quot;</a>
<a name="ln54">#include &quot;libmscore/lasso.h&quot;</a>
<a name="ln55">#include &quot;libmscore/lyrics.h&quot;</a>
<a name="ln56">#include &quot;libmscore/measure.h&quot;</a>
<a name="ln57">#include &quot;libmscore/navigate.h&quot;</a>
<a name="ln58">#include &quot;libmscore/notedot.h&quot;</a>
<a name="ln59">#include &quot;libmscore/note.h&quot;</a>
<a name="ln60">#include &quot;libmscore/noteline.h&quot;</a>
<a name="ln61">#include &quot;libmscore/ottava.h&quot;</a>
<a name="ln62">#include &quot;libmscore/page.h&quot;</a>
<a name="ln63">#include &quot;libmscore/part.h&quot;</a>
<a name="ln64">#include &quot;libmscore/pedal.h&quot;</a>
<a name="ln65">#include &quot;libmscore/pitchspelling.h&quot;</a>
<a name="ln66">#include &quot;libmscore/rehearsalmark.h&quot;</a>
<a name="ln67">#include &quot;libmscore/repeatlist.h&quot;</a>
<a name="ln68">#include &quot;libmscore/rest.h&quot;</a>
<a name="ln69">#include &quot;libmscore/score.h&quot;</a>
<a name="ln70">#include &quot;libmscore/segment.h&quot;</a>
<a name="ln71">#include &quot;libmscore/shadownote.h&quot;</a>
<a name="ln72">#include &quot;libmscore/slur.h&quot;</a>
<a name="ln73">#include &quot;libmscore/spanner.h&quot;</a>
<a name="ln74">#include &quot;libmscore/staff.h&quot;</a>
<a name="ln75">#include &quot;libmscore/stafflines.h&quot;</a>
<a name="ln76">#include &quot;libmscore/stafftext.h&quot;</a>
<a name="ln77">#include &quot;libmscore/stafftype.h&quot;</a>
<a name="ln78">#include &quot;libmscore/sticking.h&quot;</a>
<a name="ln79">#include &quot;libmscore/stringdata.h&quot;</a>
<a name="ln80">#include &quot;libmscore/sym.h&quot;</a>
<a name="ln81">#include &quot;libmscore/system.h&quot;</a>
<a name="ln82">#include &quot;libmscore/systemtext.h&quot;</a>
<a name="ln83">#include &quot;libmscore/textframe.h&quot;</a>
<a name="ln84">#include &quot;libmscore/text.h&quot;</a>
<a name="ln85">#include &quot;libmscore/timesig.h&quot;</a>
<a name="ln86">#include &quot;libmscore/trill.h&quot;</a>
<a name="ln87">#include &quot;libmscore/tuplet.h&quot;</a>
<a name="ln88">#include &quot;libmscore/undo.h&quot;</a>
<a name="ln89">#include &quot;libmscore/utils.h&quot;</a>
<a name="ln90">#include &quot;libmscore/volta.h&quot;</a>
<a name="ln91">#include &quot;libmscore/xml.h&quot;</a>
<a name="ln92">#include &quot;libmscore/textline.h&quot;</a>
<a name="ln93">#include &quot;libmscore/shape.h&quot;</a>
<a name="ln94"> </a>
<a name="ln95">namespace Ms {</a>
<a name="ln96"> </a>
<a name="ln97">extern QErrorMessage* errorMessage;</a>
<a name="ln98"> </a>
<a name="ln99">//---------------------------------------------------------</a>
<a name="ln100">//   ScoreView</a>
<a name="ln101">//---------------------------------------------------------</a>
<a name="ln102"> </a>
<a name="ln103">ScoreView::ScoreView(QWidget* parent)</a>
<a name="ln104">   : QWidget(parent), editData(this)</a>
<a name="ln105">      {</a>
<a name="ln106">      setObjectName(&quot;scoreview&quot;);</a>
<a name="ln107">      setStatusTip(&quot;scoreview&quot;);</a>
<a name="ln108">      setAcceptDrops(true);</a>
<a name="ln109">#ifndef Q_OS_MAC</a>
<a name="ln110">      setAttribute(Qt::WA_OpaquePaintEvent);</a>
<a name="ln111">#endif</a>
<a name="ln112">      setAttribute(Qt::WA_NoSystemBackground);</a>
<a name="ln113">      setFocusPolicy(Qt::StrongFocus);</a>
<a name="ln114">      setAttribute(Qt::WA_InputMethodEnabled);</a>
<a name="ln115">      setAttribute(Qt::WA_KeyCompression);</a>
<a name="ln116">      setAttribute(Qt::WA_StaticContents);</a>
<a name="ln117">      setAutoFillBackground(false);</a>
<a name="ln118"> </a>
<a name="ln119">      state       = ViewState::NORMAL;</a>
<a name="ln120">      _score      = 0;</a>
<a name="ln121">      _omrView    = 0;</a>
<a name="ln122">      dropTarget  = 0;</a>
<a name="ln123"> </a>
<a name="ln124">      realtimeTimer = new QTimer(this);</a>
<a name="ln125">      realtimeTimer-&gt;setTimerType(Qt::PreciseTimer);</a>
<a name="ln126">      connect(realtimeTimer, SIGNAL(timeout()), this, SLOT(triggerCmdRealtimeAdvance()));</a>
<a name="ln127">      extendNoteTimer = new QTimer(this);</a>
<a name="ln128">      extendNoteTimer-&gt;setTimerType(Qt::PreciseTimer);</a>
<a name="ln129">      extendNoteTimer-&gt;setSingleShot(true);</a>
<a name="ln130">      connect(extendNoteTimer, SIGNAL(timeout()), this, SLOT(extendCurrentNote()));</a>
<a name="ln131"> </a>
<a name="ln132">      setContextMenuPolicy(Qt::DefaultContextMenu);</a>
<a name="ln133"> </a>
<a name="ln134">      double mag  = preferences.getDouble(PREF_SCORE_MAGNIFICATION) * (mscore-&gt;physicalDotsPerInch() / DPI);</a>
<a name="ln135">      _matrix     = QTransform(mag, 0.0, 0.0, mag, 0.0, 0.0);</a>
<a name="ln136">      imatrix     = _matrix.inverted();</a>
<a name="ln137">      _magIdx     = preferences.getDouble(PREF_SCORE_MAGNIFICATION) == 1.0 ? MagIdx::MAG_100 : MagIdx::MAG_FREE;</a>
<a name="ln138">      focusFrame  = 0;</a>
<a name="ln139">      _bgColor    = Qt::darkBlue;</a>
<a name="ln140">      _fgColor    = Qt::white;</a>
<a name="ln141">      _fgPixmap    = 0;</a>
<a name="ln142">      _bgPixmap    = 0;</a>
<a name="ln143"> </a>
<a name="ln144">      editData.curGrip = Grip::NO_GRIP;</a>
<a name="ln145">      editData.grips   = 0;</a>
<a name="ln146">      editData.element = 0;</a>
<a name="ln147"> </a>
<a name="ln148">      lasso       = new Lasso(_score);</a>
<a name="ln149">      _foto       = 0;// new Lasso(_score);</a>
<a name="ln150"> </a>
<a name="ln151">      _cursor     = new PositionCursor(this);</a>
<a name="ln152">      _cursor-&gt;setType(CursorType::POS);</a>
<a name="ln153">      _continuousPanel = new ContinuousPanel(this);</a>
<a name="ln154">      _continuousPanel-&gt;setActive(true);</a>
<a name="ln155"> </a>
<a name="ln156">      shadowNote  = 0;</a>
<a name="ln157"> </a>
<a name="ln158">      _curLoopIn  = new PositionCursor(this);</a>
<a name="ln159">      _curLoopIn-&gt;setType(CursorType::LOOP_IN);</a>
<a name="ln160">      _curLoopOut = new PositionCursor(this);</a>
<a name="ln161">      _curLoopOut-&gt;setType(CursorType::LOOP_OUT);</a>
<a name="ln162"> </a>
<a name="ln163">      if (converterMode)      // HACK</a>
<a name="ln164">            return;</a>
<a name="ln165"> </a>
<a name="ln166">      grabGesture(Qt::PinchGesture);      // laptop pad (Mac) and touchscreen</a>
<a name="ln167"> </a>
<a name="ln168">      //-----------------------------------------------------------------------</a>
<a name="ln169"> </a>
<a name="ln170">      if (MScore::debugMode)</a>
<a name="ln171">            setMouseTracking(true);</a>
<a name="ln172"> </a>
<a name="ln173">      if (preferences.getBool(PREF_UI_CANVAS_BG_USECOLOR))</a>
<a name="ln174">            setBackground(MScore::bgColor);</a>
<a name="ln175">      else {</a>
<a name="ln176">            QPixmap* pm = new QPixmap(preferences.getString(PREF_UI_CANVAS_BG_WALLPAPER));</a>
<a name="ln177">            setBackground(pm);</a>
<a name="ln178">            }</a>
<a name="ln179">      if (preferences.getBool(PREF_UI_CANVAS_FG_USECOLOR))</a>
<a name="ln180">            setForeground(preferences.getColor(PREF_UI_CANVAS_FG_COLOR));</a>
<a name="ln181">      else {</a>
<a name="ln182">            QPixmap* pm = new QPixmap(preferences.getString(PREF_UI_CANVAS_FG_WALLPAPER));</a>
<a name="ln183">            if (pm == 0 || pm-&gt;isNull())</a>
<a name="ln184">                  qDebug(&quot;no valid pixmap %s&quot;, qPrintable(preferences.getString(PREF_UI_CANVAS_FG_WALLPAPER)));</a>
<a name="ln185">            setForeground(pm);</a>
<a name="ln186">            }</a>
<a name="ln187"> </a>
<a name="ln188">      connect(getAction(&quot;loop&quot;), SIGNAL(toggled(bool)), SLOT(loopToggled(bool)));</a>
<a name="ln189">      if (seq)</a>
<a name="ln190">            connect(seq, SIGNAL(stopped()), SLOT(seqStopped()));</a>
<a name="ln191">      }</a>
<a name="ln192"> </a>
<a name="ln193">//---------------------------------------------------------</a>
<a name="ln194">//   setScore</a>
<a name="ln195">//---------------------------------------------------------</a>
<a name="ln196"> </a>
<a name="ln197">void ScoreView::setScore(Score* s)</a>
<a name="ln198">      {</a>
<a name="ln199">      if (_score) {</a>
<a name="ln200">            if (_score-&gt;isMaster()) {</a>
<a name="ln201">                  MasterScore* ms = static_cast&lt;MasterScore*&gt;(s);</a>
<a name="ln202">                  for (MasterScore* _ms : *ms-&gt;movements()) {</a>
<a name="ln203">                        _ms-&gt;removeViewer(this);</a>
<a name="ln204">                        disconnect(s, SIGNAL(posChanged(POS, int)), this, SLOT(posChanged(POS,int)));</a>
<a name="ln205">                        }</a>
<a name="ln206">                  }</a>
<a name="ln207">            else {</a>
<a name="ln208">                  _score-&gt;removeViewer(this);</a>
<a name="ln209">                  disconnect(s, SIGNAL(posChanged(POS, int)), this, SLOT(posChanged(POS,int)));</a>
<a name="ln210">                  }</a>
<a name="ln211">            }</a>
<a name="ln212"> </a>
<a name="ln213">      _score = s;</a>
<a name="ln214">      if (_score) {</a>
<a name="ln215">            if (_score-&gt;isMaster()) {</a>
<a name="ln216">                  MasterScore* ms = static_cast&lt;MasterScore*&gt;(s);</a>
<a name="ln217">                  for (MasterScore* _ms : *ms-&gt;movements()) {</a>
<a name="ln218">                        _ms-&gt;addViewer(this);</a>
<a name="ln219">                        }</a>
<a name="ln220">                  }</a>
<a name="ln221">            else</a>
<a name="ln222">                  _score-&gt;addViewer(this);</a>
<a name="ln223">            }</a>
<a name="ln224"> </a>
<a name="ln225">      if (shadowNote == 0) {</a>
<a name="ln226">            shadowNote = new ShadowNote(_score);</a>
<a name="ln227">            shadowNote-&gt;setVisible(false);</a>
<a name="ln228">            }</a>
<a name="ln229">      else</a>
<a name="ln230">            shadowNote-&gt;setScore(_score);</a>
<a name="ln231">      lasso-&gt;setScore(s);</a>
<a name="ln232">      _continuousPanel-&gt;setScore(_score);</a>
<a name="ln233"> </a>
<a name="ln234">      if (_score) {</a>
<a name="ln235">            _curLoopIn-&gt;move(s-&gt;pos(POS::LEFT));</a>
<a name="ln236">            _curLoopOut-&gt;move(s-&gt;pos(POS::RIGHT));</a>
<a name="ln237">            loopToggled(getAction(&quot;loop&quot;)-&gt;isChecked());</a>
<a name="ln238"> </a>
<a name="ln239">            connect(s, SIGNAL(posChanged(POS,unsigned)), SLOT(posChanged(POS,unsigned)));</a>
<a name="ln240">            connect(this, SIGNAL(viewRectChanged()), this, SLOT(updateContinuousPanel()));</a>
<a name="ln241">            }</a>
<a name="ln242">      }</a>
<a name="ln243"> </a>
<a name="ln244">//---------------------------------------------------------</a>
<a name="ln245">//   ScoreView</a>
<a name="ln246">//---------------------------------------------------------</a>
<a name="ln247"> </a>
<a name="ln248">ScoreView::~ScoreView()</a>
<a name="ln249">      {</a>
<a name="ln250">      if (_score)</a>
<a name="ln251">            _score-&gt;removeViewer(this);</a>
<a name="ln252">      delete lasso;</a>
<a name="ln253">      delete _foto;</a>
<a name="ln254">      delete _cursor;</a>
<a name="ln255">      delete _continuousPanel;</a>
<a name="ln256">      delete _curLoopIn;</a>
<a name="ln257">      delete _curLoopOut;</a>
<a name="ln258">      delete _bgPixmap;</a>
<a name="ln259">      delete _fgPixmap;</a>
<a name="ln260">      delete shadowNote;</a>
<a name="ln261">      }</a>
<a name="ln262"> </a>
<a name="ln263">//---------------------------------------------------------</a>
<a name="ln264">//   objectPopup</a>
<a name="ln265">//    the menu can be extended by Elements with</a>
<a name="ln266">//      genPropertyMenu()/propertyAction() methods</a>
<a name="ln267">//---------------------------------------------------------</a>
<a name="ln268"> </a>
<a name="ln269">void ScoreView::objectPopup(const QPoint&amp; pos, Element* obj)</a>
<a name="ln270">      {</a>
<a name="ln271">      // show tuplet properties if number is clicked:</a>
<a name="ln272">      if (obj-&gt;isText() &amp;&amp; obj-&gt;parent() &amp;&amp; obj-&gt;parent()-&gt;isTuplet()) {</a>
<a name="ln273">            obj = obj-&gt;parent();</a>
<a name="ln274">            if (!obj-&gt;selected())</a>
<a name="ln275">                  obj-&gt;score()-&gt;select(obj, SelectType::SINGLE, 0);</a>
<a name="ln276">            }</a>
<a name="ln277"> </a>
<a name="ln278">      QMenu* popup = new QMenu(this);</a>
<a name="ln279">      popup-&gt;setSeparatorsCollapsible(false);</a>
<a name="ln280">      QAction* a = popup-&gt;addSeparator();</a>
<a name="ln281"> </a>
<a name="ln282">      // Set Slur or Tie according to the selected object</a>
<a name="ln283">      if (obj-&gt;type() != ElementType::SLUR_SEGMENT) {</a>
<a name="ln284">            if ((obj-&gt;type() == ElementType::STAFF_TEXT) &amp;&amp; (toStaffText(obj)-&gt;systemFlag()))</a>
<a name="ln285">                  a-&gt;setText(tr(&quot;System Text&quot;));</a>
<a name="ln286">            else</a>
<a name="ln287">                  a-&gt;setText(obj-&gt;userName());</a>
<a name="ln288">            }</a>
<a name="ln289">      else if (static_cast&lt;SlurSegment*&gt;(obj)-&gt;spanner()-&gt;type() == ElementType::SLUR)</a>
<a name="ln290">            a-&gt;setText(tr(&quot;Slur&quot;));</a>
<a name="ln291">      else if (static_cast&lt;SlurSegment*&gt;(obj)-&gt;spanner()-&gt;type() == ElementType::TIE)</a>
<a name="ln292">            a-&gt;setText(tr(&quot;Tie&quot;));</a>
<a name="ln293"> </a>
<a name="ln294">      popup-&gt;addAction(getAction(&quot;cut&quot;));</a>
<a name="ln295">      popup-&gt;addAction(getAction(&quot;copy&quot;));</a>
<a name="ln296">      popup-&gt;addAction(getAction(&quot;paste&quot;));</a>
<a name="ln297">      popup-&gt;addAction(getAction(&quot;swap&quot;));</a>
<a name="ln298">      popup-&gt;addAction(getAction(&quot;delete&quot;));</a>
<a name="ln299"> </a>
<a name="ln300">      QMenu* selMenu = popup-&gt;addMenu(tr(&quot;Select&quot;));</a>
<a name="ln301">      selMenu-&gt;addAction(getAction(&quot;select-similar&quot;));</a>
<a name="ln302">      selMenu-&gt;addAction(getAction(&quot;select-similar-staff&quot;));</a>
<a name="ln303">      selMenu-&gt;addAction(getAction(&quot;select-similar-range&quot;));</a>
<a name="ln304">      a = selMenu-&gt;addAction(tr(&quot;More…&quot;));</a>
<a name="ln305">      a-&gt;setData(&quot;select-dialog&quot;);</a>
<a name="ln306"> </a>
<a name="ln307">      popup-&gt;addSeparator();</a>
<a name="ln308">      a = getAction(&quot;edit-element&quot;);</a>
<a name="ln309">      popup-&gt;addAction(a);</a>
<a name="ln310">      a-&gt;setEnabled(obj-&gt;isEditable());</a>
<a name="ln311"> </a>
<a name="ln312">      createElementPropertyMenu(obj, popup);</a>
<a name="ln313"> </a>
<a name="ln314">      popup-&gt;addSeparator();</a>
<a name="ln315">      a = popup-&gt;addAction(tr(&quot;Help&quot;));</a>
<a name="ln316">      a-&gt;setData(&quot;help&quot;);</a>
<a name="ln317"> </a>
<a name="ln318">#ifndef NDEBUG</a>
<a name="ln319">      popup-&gt;addSeparator();</a>
<a name="ln320">      popup-&gt;addAction(&quot;Debugger&quot;)-&gt;setData(&quot;list&quot;);</a>
<a name="ln321">#endif</a>
<a name="ln322"> </a>
<a name="ln323">      popupActive = true;</a>
<a name="ln324">      a = popup-&gt;exec(pos);</a>
<a name="ln325">      popupActive = false;</a>
<a name="ln326">      if (a == 0)</a>
<a name="ln327">            return;</a>
<a name="ln328">      const QByteArray&amp; cmd(a-&gt;data().toByteArray());</a>
<a name="ln329">      if (cmd == &quot;cut&quot; || cmd ==&quot;copy&quot; || cmd == &quot;paste&quot; || cmd == &quot;swap&quot; || cmd == &quot;delete&quot;) {</a>
<a name="ln330">            // these actions are already activated</a>
<a name="ln331">            return;</a>
<a name="ln332">            }</a>
<a name="ln333">      if (cmd == &quot;list&quot;)</a>
<a name="ln334">            mscore-&gt;showElementContext(obj);</a>
<a name="ln335">      else if (cmd == &quot;help&quot;)</a>
<a name="ln336">            mscore-&gt;showHelp(QString(&quot;element:%1&quot;).arg(obj-&gt;name()));</a>
<a name="ln337">      else if (cmd == &quot;edit-element&quot;) {</a>
<a name="ln338">            if (obj-&gt;isEditable()) {</a>
<a name="ln339">                  if (obj-&gt;score())</a>
<a name="ln340">                        obj-&gt;score()-&gt;select(obj);</a>
<a name="ln341">                  startEditMode(obj);</a>
<a name="ln342">                  return;</a>
<a name="ln343">                  }</a>
<a name="ln344">            }</a>
<a name="ln345">      else if (cmd == &quot;select-similar&quot;)</a>
<a name="ln346">            mscore-&gt;selectSimilar(obj, false);</a>
<a name="ln347">      else if (cmd == &quot;select-similar-staff&quot;)</a>
<a name="ln348">            mscore-&gt;selectSimilar(obj, true);</a>
<a name="ln349">      else if (cmd == &quot;select-similar-range&quot;)</a>
<a name="ln350">            mscore-&gt;selectSimilarInRange(obj);</a>
<a name="ln351">      else if (cmd == &quot;select-dialog&quot;)</a>
<a name="ln352">            mscore-&gt;selectElementDialog(obj);</a>
<a name="ln353">      else {</a>
<a name="ln354">            _score-&gt;startCmd();</a>
<a name="ln355">            elementPropertyAction(cmd, obj);</a>
<a name="ln356">            if (score()-&gt;undoStack()-&gt;active())</a>
<a name="ln357">                  _score-&gt;endCmd();</a>
<a name="ln358">            }</a>
<a name="ln359">      }</a>
<a name="ln360"> </a>
<a name="ln361">//---------------------------------------------------------</a>
<a name="ln362">//   measurePopup</a>
<a name="ln363">//---------------------------------------------------------</a>
<a name="ln364"> </a>
<a name="ln365">void ScoreView::measurePopup(QContextMenuEvent* ev, Measure* obj)</a>
<a name="ln366">      {</a>
<a name="ln367">      int staffIdx;</a>
<a name="ln368">      int pitch;</a>
<a name="ln369">      Segment* seg;</a>
<a name="ln370"> </a>
<a name="ln371">      QPoint gpos = ev-&gt;globalPos();</a>
<a name="ln372"> </a>
<a name="ln373">      if (!_score-&gt;pos2measure(editData.startMove, &amp;staffIdx, &amp;pitch, &amp;seg, 0))</a>
<a name="ln374">            return;</a>
<a name="ln375">      if (staffIdx == -1) {</a>
<a name="ln376">            qDebug(&quot;ScoreView::measurePopup: staffIdx == -1!&quot;);</a>
<a name="ln377">            return;</a>
<a name="ln378">            }</a>
<a name="ln379"> </a>
<a name="ln380">      Staff* staff = _score-&gt;staff(staffIdx);</a>
<a name="ln381"> </a>
<a name="ln382">      QMenu* popup = new QMenu(this);</a>
<a name="ln383">      popup-&gt;setSeparatorsCollapsible(false);</a>
<a name="ln384"> </a>
<a name="ln385">      QAction* a = popup-&gt;addSeparator();</a>
<a name="ln386">      a-&gt;setText(tr(&quot;Staff&quot;));</a>
<a name="ln387">      a = popup-&gt;addAction(tr(&quot;Edit Drumset…&quot;));</a>
<a name="ln388">      a-&gt;setData(&quot;edit-drumset&quot;);</a>
<a name="ln389">      a-&gt;setEnabled(staff-&gt;part()-&gt;instrument()-&gt;drumset() != 0);</a>
<a name="ln390"> </a>
<a name="ln391">      a = popup-&gt;addAction(tr(&quot;Piano Roll Editor…&quot;));</a>
<a name="ln392">      a-&gt;setData(&quot;pianoroll&quot;);</a>
<a name="ln393"> </a>
<a name="ln394">      a = popup-&gt;addAction(tr(&quot;Staff/Part Properties…&quot;));</a>
<a name="ln395">      a-&gt;setData(&quot;staff-properties&quot;);</a>
<a name="ln396">      a = popup-&gt;addAction(tr(&quot;Split Staff…&quot;));</a>
<a name="ln397">      a-&gt;setData(&quot;staff-split&quot;);</a>
<a name="ln398"> </a>
<a name="ln399">      a = popup-&gt;addSeparator();</a>
<a name="ln400">      a-&gt;setText(tr(&quot;Measure&quot;));</a>
<a name="ln401">      popup-&gt;addAction(getAction(&quot;cut&quot;));</a>
<a name="ln402">      popup-&gt;addAction(getAction(&quot;copy&quot;));</a>
<a name="ln403">      popup-&gt;addAction(getAction(&quot;paste&quot;));</a>
<a name="ln404">      popup-&gt;addAction(getAction(&quot;swap&quot;));</a>
<a name="ln405">      popup-&gt;addAction(getAction(&quot;delete&quot;));</a>
<a name="ln406"> </a>
<a name="ln407">      QMenu* menuAdd = popup-&gt;addMenu(tr(&quot;Add&quot;));</a>
<a name="ln408">      menuAdd-&gt;addAction(getAction(&quot;insert-measure&quot;));</a>
<a name="ln409">      menuAdd-&gt;addAction(getAction(&quot;insert-measures&quot;));</a>
<a name="ln410">      menuAdd-&gt;addAction(getAction(&quot;insert-hbox&quot;));</a>
<a name="ln411">      menuAdd-&gt;addAction(getAction(&quot;insert-vbox&quot;));</a>
<a name="ln412">      menuAdd-&gt;addAction(getAction(&quot;insert-textframe&quot;));</a>
<a name="ln413"> </a>
<a name="ln414">      a = popup-&gt;addAction(tr(&quot;Remove Selected Measures&quot;));</a>
<a name="ln415">      a-&gt;setData(&quot;delete-selected-measures&quot;);</a>
<a name="ln416"> </a>
<a name="ln417">      popup-&gt;addSeparator();</a>
<a name="ln418"> </a>
<a name="ln419">      a = popup-&gt;addAction(tr(&quot;Measure Properties…&quot;));</a>
<a name="ln420">      a-&gt;setData(&quot;props&quot;);</a>
<a name="ln421">      a-&gt;setEnabled(!obj-&gt;isMMRest());</a>
<a name="ln422">      popup-&gt;addSeparator();</a>
<a name="ln423"> </a>
<a name="ln424">#ifndef NDEBUG</a>
<a name="ln425">      popup-&gt;addAction(&quot;Object Debugger&quot;)-&gt;setData(&quot;list&quot;);</a>
<a name="ln426">#endif</a>
<a name="ln427"> </a>
<a name="ln428">      a = popup-&gt;exec(gpos);</a>
<a name="ln429">      if (a == 0)</a>
<a name="ln430">            return;</a>
<a name="ln431">      QString cmd(a-&gt;data().toString());</a>
<a name="ln432">      if (cmd == &quot;cut&quot; || cmd ==&quot;copy&quot; || cmd == &quot;paste&quot; || cmd == &quot;swap&quot;</a>
<a name="ln433">         || cmd == &quot;insert-measure&quot; || cmd == &quot;select-similar&quot;</a>
<a name="ln434">         || cmd == &quot;delete&quot;) {</a>
<a name="ln435">            // these actions are already activated</a>
<a name="ln436">            return;</a>
<a name="ln437">            }</a>
<a name="ln438">      _score-&gt;startCmd();</a>
<a name="ln439">      if (cmd == &quot;list&quot;)</a>
<a name="ln440">            mscore-&gt;showElementContext(obj);</a>
<a name="ln441">      else if (cmd == &quot;color&quot;)</a>
<a name="ln442">            _score-&gt;colorItem(obj);</a>
<a name="ln443">      else if (cmd == &quot;edit&quot;) {</a>
<a name="ln444">            if (obj-&gt;isEditable()) {</a>
<a name="ln445">                  startEditMode(obj);</a>
<a name="ln446">                  return;</a>
<a name="ln447">                  }</a>
<a name="ln448">            }</a>
<a name="ln449">      else if (cmd == &quot;edit-drumset&quot;) {</a>
<a name="ln450">            EditDrumset drumsetEdit(staff-&gt;part()-&gt;instrument()-&gt;drumset(), this);</a>
<a name="ln451">            if (drumsetEdit.exec()) {</a>
<a name="ln452">                  _score-&gt;undo(new ChangeDrumset(staff-&gt;part()-&gt;instrument(), drumsetEdit.drumset()));</a>
<a name="ln453">                  mscore-&gt;updateDrumTools(drumsetEdit.drumset());</a>
<a name="ln454">                  }</a>
<a name="ln455">            }</a>
<a name="ln456">      else if (cmd == &quot;drumroll&quot;) {</a>
<a name="ln457">            _score-&gt;endCmd();</a>
<a name="ln458">            mscore-&gt;editInDrumroll(staff);</a>
<a name="ln459">            }</a>
<a name="ln460">      else if (cmd == &quot;pianoroll&quot;) {</a>
<a name="ln461">            _score-&gt;endCmd();</a>
<a name="ln462">            QPointF p = toLogical(ev-&gt;pos());</a>
<a name="ln463">            Position pp;</a>
<a name="ln464">            bool foundPos = _score-&gt;getPosition(&amp;pp, p, 0);</a>
<a name="ln465">            mscore-&gt;editInPianoroll(staff, foundPos ? &amp;pp : 0);</a>
<a name="ln466">            }</a>
<a name="ln467">      else if (cmd == &quot;staff-properties&quot;) {</a>
<a name="ln468">            Fraction tick = obj ? obj-&gt;tick() : Fraction(-1,1);</a>
<a name="ln469">            EditStaff editStaff(staff, tick, this);</a>
<a name="ln470">            connect(&amp;editStaff, SIGNAL(instrumentChanged()), mscore, SLOT(instrumentChanged()));</a>
<a name="ln471">            editStaff.exec();</a>
<a name="ln472">            }</a>
<a name="ln473">      else if (cmd == &quot;staff-split&quot;) {</a>
<a name="ln474">            SplitStaff splitStaff(this);</a>
<a name="ln475">            if (splitStaff.exec())</a>
<a name="ln476">                  _score-&gt;splitStaff(staffIdx, splitStaff.getSplitPoint());</a>
<a name="ln477">            }</a>
<a name="ln478">      else if (cmd == &quot;props&quot;) {</a>
<a name="ln479">            MeasureProperties im(obj);</a>
<a name="ln480">            im.exec();</a>
<a name="ln481">            }</a>
<a name="ln482">      else if (cmd == &quot;delete-selected-measures&quot;) {</a>
<a name="ln483">            _score-&gt;cmdTimeDelete();</a>
<a name="ln484">            }</a>
<a name="ln485">      if (_score-&gt;undoStack()-&gt;active())</a>
<a name="ln486">            _score-&gt;endCmd();</a>
<a name="ln487">      }</a>
<a name="ln488"> </a>
<a name="ln489">//---------------------------------------------------------</a>
<a name="ln490">//   setBackground</a>
<a name="ln491">//---------------------------------------------------------</a>
<a name="ln492"> </a>
<a name="ln493">void ScoreView::setBackground(QPixmap* pm)</a>
<a name="ln494">      {</a>
<a name="ln495">      delete _bgPixmap;</a>
<a name="ln496">      _bgPixmap = pm;</a>
<a name="ln497">      update();</a>
<a name="ln498">      }</a>
<a name="ln499"> </a>
<a name="ln500">void ScoreView::setBackground(const QColor&amp; color)</a>
<a name="ln501">      {</a>
<a name="ln502">      delete _bgPixmap;</a>
<a name="ln503">      _bgPixmap = 0;</a>
<a name="ln504">      _bgColor = color;</a>
<a name="ln505">      update();</a>
<a name="ln506">      }</a>
<a name="ln507"> </a>
<a name="ln508">//---------------------------------------------------------</a>
<a name="ln509">//   setForeground</a>
<a name="ln510">//---------------------------------------------------------</a>
<a name="ln511"> </a>
<a name="ln512">void ScoreView::setForeground(QPixmap* pm)</a>
<a name="ln513">      {</a>
<a name="ln514">      delete _fgPixmap;</a>
<a name="ln515">      _fgPixmap = pm;</a>
<a name="ln516">      update();</a>
<a name="ln517">      }</a>
<a name="ln518"> </a>
<a name="ln519">void ScoreView::setForeground(const QColor&amp; color)</a>
<a name="ln520">      {</a>
<a name="ln521">      delete _fgPixmap;</a>
<a name="ln522">      _fgPixmap = 0;</a>
<a name="ln523">      _fgColor = color;</a>
<a name="ln524">      update();</a>
<a name="ln525">      }</a>
<a name="ln526"> </a>
<a name="ln527">//---------------------------------------------------------</a>
<a name="ln528">//   dataChanged</a>
<a name="ln529">//---------------------------------------------------------</a>
<a name="ln530"> </a>
<a name="ln531">void ScoreView::dataChanged(const QRectF&amp; r)</a>
<a name="ln532">      {</a>
<a name="ln533">      update(_matrix.mapRect(r).toRect());  // generate paint event</a>
<a name="ln534">      }</a>
<a name="ln535"> </a>
<a name="ln536">//---------------------------------------------------------</a>
<a name="ln537">//   moveCursor</a>
<a name="ln538">//    move cursor during playback</a>
<a name="ln539">//---------------------------------------------------------</a>
<a name="ln540"> </a>
<a name="ln541">void ScoreView::moveCursor(const Fraction&amp; tick)</a>
<a name="ln542">      {</a>
<a name="ln543">      Measure* measure = score()-&gt;tick2measureMM(tick);</a>
<a name="ln544">      if (measure == 0)</a>
<a name="ln545">            return;</a>
<a name="ln546"> </a>
<a name="ln547">      qreal x = 0.0;</a>
<a name="ln548">      Segment* s;</a>
<a name="ln549">      for (s = measure-&gt;first(SegmentType::ChordRest); s;) {</a>
<a name="ln550">            Fraction t1 = s-&gt;tick();</a>
<a name="ln551">            int x1 = s-&gt;canvasPos().x();</a>
<a name="ln552">            qreal x2;</a>
<a name="ln553">            Fraction t2;</a>
<a name="ln554">            Segment* ns = s-&gt;next(SegmentType::ChordRest);</a>
<a name="ln555">            while (ns &amp;&amp; !ns-&gt;visible())</a>
<a name="ln556">                  ns = ns-&gt;next(SegmentType::ChordRest);</a>
<a name="ln557">            if (ns) {</a>
<a name="ln558">                  t2 = ns-&gt;tick();</a>
<a name="ln559">                  x2 = ns-&gt;canvasPos().x();</a>
<a name="ln560">                  }</a>
<a name="ln561">            else {</a>
<a name="ln562">                  t2 = measure-&gt;endTick();</a>
<a name="ln563">                  // measure-&gt;width is not good enough because of courtesy keysig, timesig</a>
<a name="ln564">                  Segment* seg = measure-&gt;findSegment(SegmentType::EndBarLine, measure-&gt;tick() + measure-&gt;ticks());</a>
<a name="ln565">                  if (seg)</a>
<a name="ln566">                        x2 = seg-&gt;canvasPos().x();</a>
<a name="ln567">                  else</a>
<a name="ln568">                        x2 = measure-&gt;canvasPos().x() + measure-&gt;width(); //safety, should not happen</a>
<a name="ln569">                  }</a>
<a name="ln570">            if (tick &gt;= t1 &amp;&amp; tick &lt; t2) {</a>
<a name="ln571">                  Fraction   dt = t2 - t1;</a>
<a name="ln572">                  qreal dx = x2 - x1;</a>
<a name="ln573">                  x = x1 + dx * (tick-t1).ticks() / dt.ticks();</a>
<a name="ln574">                  break;</a>
<a name="ln575">                  }</a>
<a name="ln576">            s = ns;</a>
<a name="ln577">            }</a>
<a name="ln578">      if (s == 0)</a>
<a name="ln579">            return;</a>
<a name="ln580"> </a>
<a name="ln581">      QColor c(MScore::selectColor[0]);</a>
<a name="ln582">      c.setAlpha(50);</a>
<a name="ln583">      _cursor-&gt;setColor(c);</a>
<a name="ln584">      _cursor-&gt;setTick(tick);</a>
<a name="ln585"> </a>
<a name="ln586">      System* system = measure-&gt;system();</a>
<a name="ln587">      if (system == 0)</a>
<a name="ln588">            return;</a>
<a name="ln589">      double y        = system-&gt;staffYpage(0) + system-&gt;page()-&gt;pos().y();</a>
<a name="ln590">      double _spatium = score()-&gt;spatium();</a>
<a name="ln591"> </a>
<a name="ln592">      update(_matrix.mapRect(_cursor-&gt;rect()).toRect().adjusted(-1,-1,1,1));</a>
<a name="ln593"> </a>
<a name="ln594">      qreal mag = _spatium / SPATIUM20;</a>
<a name="ln595">      double w  = _spatium * 2.0 + score()-&gt;scoreFont()-&gt;width(SymId::noteheadBlack, mag);</a>
<a name="ln596">      double h  = 6 * _spatium;</a>
<a name="ln597">      //</a>
<a name="ln598">      // set cursor height for whole system</a>
<a name="ln599">      //</a>
<a name="ln600">      double y2 = 0.0;</a>
<a name="ln601"> </a>
<a name="ln602">      for (int i = 0; i &lt; _score-&gt;nstaves(); ++i) {</a>
<a name="ln603">            SysStaff* ss = system-&gt;staff(i);</a>
<a name="ln604">            if (!ss-&gt;show() || !_score-&gt;staff(i)-&gt;show())</a>
<a name="ln605">                  continue;</a>
<a name="ln606">            y2 = ss-&gt;bbox().bottom();</a>
<a name="ln607">            }</a>
<a name="ln608">      h += y2;</a>
<a name="ln609">      x -= _spatium;</a>
<a name="ln610">      y -= 3 * _spatium;</a>
<a name="ln611"> </a>
<a name="ln612">      _cursor-&gt;setRect(QRectF(x, y, w, h));</a>
<a name="ln613">      update(_matrix.mapRect(_cursor-&gt;rect()).toRect().adjusted(-1,-1,1,1));</a>
<a name="ln614">      if (mscore-&gt;state() == ScoreState::STATE_PLAY &amp;&amp; mscore-&gt;panDuringPlayback())</a>
<a name="ln615">            adjustCanvasPosition(measure, true);</a>
<a name="ln616">      }</a>
<a name="ln617"> </a>
<a name="ln618">//---------------------------------------------------------</a>
<a name="ln619">//   moveCursor</a>
<a name="ln620">//    move cursor in note input mode</a>
<a name="ln621">//---------------------------------------------------------</a>
<a name="ln622"> </a>
<a name="ln623">void ScoreView::moveCursor()</a>
<a name="ln624">      {</a>
<a name="ln625">      const InputState&amp; is = _score-&gt;inputState();</a>
<a name="ln626">      Segment* segment = is.segment();</a>
<a name="ln627">      if (segment &amp;&amp; score()-&gt;styleB(Sid::createMultiMeasureRests) &amp;&amp; segment-&gt;measure()-&gt;hasMMRest()) {</a>
<a name="ln628">            Measure* m = segment-&gt;measure()-&gt;mmRest();</a>
<a name="ln629">            segment = m-&gt;findSegment(SegmentType::ChordRest, m-&gt;tick());</a>
<a name="ln630">            }</a>
<a name="ln631">      if (!segment)</a>
<a name="ln632">            return;</a>
<a name="ln633"> </a>
<a name="ln634">      int track    = is.track() == -1 ? 0 : is.track();</a>
<a name="ln635">      int voice    = track % VOICES;</a>
<a name="ln636">      int staffIdx = track / VOICES;</a>
<a name="ln637"> </a>
<a name="ln638">      QColor c(MScore::selectColor[voice]);</a>
<a name="ln639">      c.setAlpha(50);</a>
<a name="ln640">      _cursor-&gt;setColor(c);</a>
<a name="ln641">      _cursor-&gt;setTick(segment-&gt;tick());</a>
<a name="ln642"> </a>
<a name="ln643">      System* system = segment-&gt;measure()-&gt;system();</a>
<a name="ln644">      if (system == 0) {</a>
<a name="ln645">            // a new measure was appended but no layout took place</a>
<a name="ln646">            // or this measure was skipped by a multi measure rest</a>
<a name="ln647">            return;</a>
<a name="ln648">            }</a>
<a name="ln649">      double x        = segment-&gt;canvasPos().x();</a>
<a name="ln650">      double y        = system-&gt;staffYpage(staffIdx) + system-&gt;page()-&gt;pos().y();</a>
<a name="ln651">      double _spatium = score()-&gt;spatium();</a>
<a name="ln652">      x              -= qMin(segment-&gt;pos().x() - score()-&gt;styleP(Sid::barNoteDistance), 0.0);</a>
<a name="ln653"> </a>
<a name="ln654">      update(_matrix.mapRect(_cursor-&gt;rect()).toRect().adjusted(-1,-1,1,1));</a>
<a name="ln655"> </a>
<a name="ln656">      double h;</a>
<a name="ln657">      qreal mag               = _spatium / SPATIUM20;</a>
<a name="ln658">      double w                = _spatium * 2.0 + score()-&gt;scoreFont()-&gt;width(SymId::noteheadBlack, mag);</a>
<a name="ln659">      Staff* staff            = score()-&gt;staff(staffIdx);</a>
<a name="ln660">      const StaffType* staffType    = staff-&gt;staffType(is.tick());</a>
<a name="ln661">      double lineDist         = staffType-&gt;lineDistance().val() * _spatium;</a>
<a name="ln662">      int lines               = staffType-&gt;lines();</a>
<a name="ln663">      int strg                = is.string();          // strg refers to an instrument physical string</a>
<a name="ln664">      x                       -= _spatium;</a>
<a name="ln665">      int instrStrgs          = staff-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;strings();</a>
<a name="ln666">      // if on a TAB staff and InputState::_string makes sense,</a>
<a name="ln667">      // draw cursor around single string</a>
<a name="ln668">      if (staff-&gt;isTabStaff(is.tick()) &amp;&amp; strg &gt;= 0 &amp;&amp; strg &lt;= instrStrgs) {</a>
<a name="ln669">            h = lineDist;                 // cursor height is one full line distance</a>
<a name="ln670">            y += staffType-&gt;physStringToYOffset(strg) * _spatium;</a>
<a name="ln671">            // if frets are on lines, centre on string; if frets are above lines, 'sit' above string</a>
<a name="ln672">            y -= (staffType-&gt;onLines() ? lineDist * 0.5 : lineDist);</a>
<a name="ln673">            // look for a note on this string in this staff</a>
<a name="ln674">            // if found, it will be selected, to synchronize the 'new note input cursor' and the 'current note cursor'</a>
<a name="ln675">            // i.e. the point where a new note would be added and the existing note which receives any editing</a>
<a name="ln676">            // (like pitch change or articulation addition)</a>
<a name="ln677">            bool        done  = false;</a>
<a name="ln678">            Segment*    seg   = is.segment();</a>
<a name="ln679">            int         minTrack = (is.track() / VOICES) * VOICES;</a>
<a name="ln680">            int         maxTrack = minTrack + VOICES;</a>
<a name="ln681">            // get selected chord, if one exists and is in this segment</a>
<a name="ln682">            ChordRest* scr = _score-&gt;selection().cr();</a>
<a name="ln683">            if (scr &amp;&amp; (scr-&gt;type() != ElementType::CHORD || scr-&gt;segment() != seg))</a>
<a name="ln684">                  scr = nullptr;</a>
<a name="ln685">            // get the physical string corresponding to current visual string</a>
<a name="ln686">            for (int t = minTrack; t &lt; maxTrack; t++) {</a>
<a name="ln687">                  Element* e = seg-&gt;element(t);</a>
<a name="ln688">                  if (e != nullptr &amp;&amp; e-&gt;type() == ElementType::CHORD) {</a>
<a name="ln689">                        // if there is a selected chord in this segment on this track but it is not e</a>
<a name="ln690">                        // then the selected chord must be a grace note chord, and we should use it</a>
<a name="ln691">                        if (scr &amp;&amp; scr-&gt;track() == t &amp;&amp; scr != e)</a>
<a name="ln692">                              e = scr;</a>
<a name="ln693">                        // search notes looking for one on current string</a>
<a name="ln694">                        for (Note* n : static_cast&lt;Chord*&gt;(e)-&gt;notes())</a>
<a name="ln695">                              // if note found on this string, make it current</a>
<a name="ln696">                              if (n-&gt;string() == strg) {</a>
<a name="ln697">                                    if (!n-&gt;selected()) {</a>
<a name="ln698">                                          _score-&gt;select(n);</a>
<a name="ln699">                                          // restore input state after selection</a>
<a name="ln700">                                          _score-&gt;inputState().setTrack(track);</a>
<a name="ln701">                                          }</a>
<a name="ln702">#if 0</a>
<a name="ln703">                                    // if using this code, we can delete the setTrack() call above</a>
<a name="ln704">                                    // the code below forces input state &amp; cursor to match current note</a>
<a name="ln705">                                    _score-&gt;inputState().setTrack(t);</a>
<a name="ln706">                                    QColor c(MScore::selectColor[t % VOICES]);</a>
<a name="ln707">                                    c.setAlpha(50);</a>
<a name="ln708">                                    _cursor-&gt;setColor(c);</a>
<a name="ln709">#endif</a>
<a name="ln710">                                    done = true;</a>
<a name="ln711">                                    break;</a>
<a name="ln712">                                    }</a>
<a name="ln713">                        }</a>
<a name="ln714">                  if (done)</a>
<a name="ln715">                        break;</a>
<a name="ln716">                  }</a>
<a name="ln717">      }</a>
<a name="ln718">      // otherwise, draw cursor across whole staff</a>
<a name="ln719">      else {</a>
<a name="ln720">            h = (lines - 1) * lineDist + 4 * _spatium;</a>
<a name="ln721">            y -= 2.0 * _spatium;</a>
<a name="ln722">            }</a>
<a name="ln723">      _cursor-&gt;setRect(QRectF(x, y, w, h));</a>
<a name="ln724">      update(_matrix.mapRect(_cursor-&gt;rect()).toRect().adjusted(-1,-1,1,1));</a>
<a name="ln725">      if (is.cr())</a>
<a name="ln726">            adjustCanvasPosition(is.cr(), false);</a>
<a name="ln727">      }</a>
<a name="ln728"> </a>
<a name="ln729">//---------------------------------------------------------</a>
<a name="ln730">//   cursorTick</a>
<a name="ln731">//---------------------------------------------------------</a>
<a name="ln732"> </a>
<a name="ln733">Fraction ScoreView::cursorTick() const</a>
<a name="ln734">      {</a>
<a name="ln735">      return _cursor-&gt;tick();</a>
<a name="ln736">      }</a>
<a name="ln737"> </a>
<a name="ln738">//---------------------------------------------------------</a>
<a name="ln739">//   setCursorOn</a>
<a name="ln740">//---------------------------------------------------------</a>
<a name="ln741"> </a>
<a name="ln742">void ScoreView::setCursorOn(bool val)</a>
<a name="ln743">      {</a>
<a name="ln744">      if (_cursor &amp;&amp; (_cursor-&gt;visible() != val)) {</a>
<a name="ln745">            _cursor-&gt;setVisible(val);</a>
<a name="ln746">            update(_matrix.mapRect(_cursor-&gt;rect()).toRect().adjusted(-1,-1,1,1));</a>
<a name="ln747">            }</a>
<a name="ln748">      }</a>
<a name="ln749"> </a>
<a name="ln750">//---------------------------------------------------------</a>
<a name="ln751">//   setLoopCursor</a>
<a name="ln752">//    adjust the cursor shape and position to mark the loop</a>
<a name="ln753">//    isInPos is used to adjust the x position of In vs Out mark</a>
<a name="ln754">//---------------------------------------------------------</a>
<a name="ln755"> </a>
<a name="ln756">void ScoreView::setLoopCursor(PositionCursor *curLoop, const Fraction&amp; tick, bool isInPos)</a>
<a name="ln757">      {</a>
<a name="ln758">      //</a>
<a name="ln759">      // set mark height for whole system</a>
<a name="ln760">      //</a>
<a name="ln761">      Measure* measure = score()-&gt;tick2measure(tick);</a>
<a name="ln762">      if (measure == 0)</a>
<a name="ln763">            return;</a>
<a name="ln764">      qreal x = 0.0;</a>
<a name="ln765"> </a>
<a name="ln766">      Segment* s;</a>
<a name="ln767">      for (s = measure-&gt;first(SegmentType::ChordRest); s;) {</a>
<a name="ln768">            Fraction t1 = s-&gt;tick();</a>
<a name="ln769">            int x1 = s-&gt;canvasPos().x();</a>
<a name="ln770">            qreal x2;</a>
<a name="ln771">            Fraction t2;</a>
<a name="ln772">            Segment* ns = s-&gt;next(SegmentType::ChordRest);</a>
<a name="ln773">            if (ns) {</a>
<a name="ln774">                  t2 = ns-&gt;tick();</a>
<a name="ln775">                  x2 = ns-&gt;canvasPos().x();</a>
<a name="ln776">                  }</a>
<a name="ln777">            else {</a>
<a name="ln778">                  t2 = measure-&gt;endTick();</a>
<a name="ln779">                  x2 = measure-&gt;canvasPos().x() + measure-&gt;width();</a>
<a name="ln780">                  }</a>
<a name="ln781">            if (tick &gt;= t1 &amp;&amp; tick &lt; t2) {</a>
<a name="ln782">                  Fraction   dt = t2 - t1;</a>
<a name="ln783">                  qreal dx = x2 - x1;</a>
<a name="ln784">                  x = x1 + dx * (tick.ticks() - t1.ticks()) / dt.ticks();</a>
<a name="ln785">                  break;</a>
<a name="ln786">                  }</a>
<a name="ln787">            s = ns;</a>
<a name="ln788">            }</a>
<a name="ln789">      if (s == 0)</a>
<a name="ln790">            return;</a>
<a name="ln791"> </a>
<a name="ln792">      System* system = measure-&gt;system();</a>
<a name="ln793">      if (system == 0)</a>
<a name="ln794">            return;</a>
<a name="ln795">      double y        = system-&gt;staffYpage(0) + system-&gt;page()-&gt;pos().y();</a>
<a name="ln796">      double _spatium = score()-&gt;spatium();</a>
<a name="ln797"> </a>
<a name="ln798">      qreal mag = _spatium / SPATIUM20;</a>
<a name="ln799">      double w  = (_spatium * 2.0 + score()-&gt;scoreFont()-&gt;width(SymId::noteheadBlack, mag))/3;</a>
<a name="ln800">      double h  = 6 * _spatium;</a>
<a name="ln801">      //</a>
<a name="ln802">      // set cursor height for whole system</a>
<a name="ln803">      //</a>
<a name="ln804">      double y2 = 0.0;</a>
<a name="ln805"> </a>
<a name="ln806">      for (int i = 0; i &lt; _score-&gt;nstaves(); ++i) {</a>
<a name="ln807">            SysStaff* ss = system-&gt;staff(i);</a>
<a name="ln808">            if (!ss-&gt;show() || !_score-&gt;staff(i)-&gt;show())</a>
<a name="ln809">                  continue;</a>
<a name="ln810">            y2 = ss-&gt;y() + ss-&gt;bbox().height();</a>
<a name="ln811">            }</a>
<a name="ln812">      h += y2;</a>
<a name="ln813">      y -= 3 * _spatium;</a>
<a name="ln814"> </a>
<a name="ln815">      if (isInPos) {</a>
<a name="ln816">            x = x - _spatium + w/1.5;</a>
<a name="ln817">            }</a>
<a name="ln818">      else {</a>
<a name="ln819">            x = x - _spatium;</a>
<a name="ln820">            }</a>
<a name="ln821">      curLoop-&gt;setTick(tick);</a>
<a name="ln822">      update(_matrix.mapRect(curLoop-&gt;rect()).toRect().adjusted(-1,-1,1,1));</a>
<a name="ln823">      curLoop-&gt;setRect(QRectF(x, y, w, h));</a>
<a name="ln824">      update(_matrix.mapRect(curLoop-&gt;rect()).toRect().adjusted(-1,-1,1,1));</a>
<a name="ln825">      }</a>
<a name="ln826"> </a>
<a name="ln827">//---------------------------------------------------------</a>
<a name="ln828">//   setShadowNote</a>
<a name="ln829">//---------------------------------------------------------</a>
<a name="ln830"> </a>
<a name="ln831">void ScoreView::setShadowNote(const QPointF&amp; p)</a>
<a name="ln832">      {</a>
<a name="ln833">      const InputState&amp; is = _score-&gt;inputState();</a>
<a name="ln834">      Position pos;</a>
<a name="ln835">      if (!score()-&gt;getPosition(&amp;pos, p, is.voice())) {</a>
<a name="ln836">            shadowNote-&gt;setVisible(false);</a>
<a name="ln837">            return;</a>
<a name="ln838">            }</a>
<a name="ln839">      // in any empty measure, pos will be right next to barline</a>
<a name="ln840">      // so pad this by barNoteDistance</a>
<a name="ln841">      qreal mag     = score()-&gt;staff(pos.staffIdx)-&gt;mag(Fraction(0,1));</a>
<a name="ln842">      qreal relX    = pos.pos.x() - pos.segment-&gt;measure()-&gt;canvasPos().x();</a>
<a name="ln843">      pos.pos.rx() -= qMin(relX - score()-&gt;styleP(Sid::barNoteDistance) * mag, 0.0);</a>
<a name="ln844"> </a>
<a name="ln845">      shadowNote-&gt;setVisible(true);</a>
<a name="ln846">      Staff* staff = score()-&gt;staff(pos.staffIdx);</a>
<a name="ln847">      shadowNote-&gt;setMag(staff-&gt;mag(Fraction(0,1)));</a>
<a name="ln848">      const Instrument* instr       = staff-&gt;part()-&gt;instrument();</a>
<a name="ln849">      NoteHead::Group noteheadGroup = NoteHead::Group::HEAD_NORMAL;</a>
<a name="ln850">      int line                      = pos.line;</a>
<a name="ln851">      NoteHead::Type noteHead       = is.duration().headType();</a>
<a name="ln852"> </a>
<a name="ln853">      if (instr-&gt;useDrumset()) {</a>
<a name="ln854">            const Drumset* ds  = instr-&gt;drumset();</a>
<a name="ln855">            int pitch    = is.drumNote();</a>
<a name="ln856">            if (pitch &gt;= 0 &amp;&amp; ds-&gt;isValid(pitch)) {</a>
<a name="ln857">                  line     = ds-&gt;line(pitch);</a>
<a name="ln858">                  noteheadGroup = ds-&gt;noteHead(pitch);</a>
<a name="ln859">                  }</a>
<a name="ln860">            }</a>
<a name="ln861"> </a>
<a name="ln862">      shadowNote-&gt;setLine(line);</a>
<a name="ln863"> </a>
<a name="ln864">      int voice;</a>
<a name="ln865">      if (is.drumNote() != -1 &amp;&amp; is.drumset() &amp;&amp; is.drumset()-&gt;isValid(is.drumNote()))</a>
<a name="ln866">            voice = is.drumset()-&gt;voice(is.drumNote());</a>
<a name="ln867">      else</a>
<a name="ln868">            voice = is.voice();</a>
<a name="ln869"> </a>
<a name="ln870">      SymId symNotehead;</a>
<a name="ln871">      TDuration d(is.duration());</a>
<a name="ln872"> </a>
<a name="ln873">      if (is.rest()) {</a>
<a name="ln874">            int yo;</a>
<a name="ln875">            Rest rest(gscore, d.type());</a>
<a name="ln876">            rest.setTicks(d.fraction());</a>
<a name="ln877">            symNotehead = rest.getSymbol(is.duration().type(), 0, staff-&gt;lines(pos.segment-&gt;tick()), &amp;yo);</a>
<a name="ln878">            shadowNote-&gt;setState(symNotehead, voice, d, true);</a>
<a name="ln879">            }</a>
<a name="ln880">      else {</a>
<a name="ln881">            if (NoteHead::Group::HEAD_CUSTOM == noteheadGroup)</a>
<a name="ln882">                  symNotehead = instr-&gt;drumset()-&gt;noteHeads(is.drumNote(), noteHead);</a>
<a name="ln883">            else</a>
<a name="ln884">                  symNotehead = Note::noteHead(0, noteheadGroup, noteHead);</a>
<a name="ln885"> </a>
<a name="ln886">            shadowNote-&gt;setState(symNotehead, voice, d);</a>
<a name="ln887">            }</a>
<a name="ln888"> </a>
<a name="ln889">      shadowNote-&gt;layout();</a>
<a name="ln890">      shadowNote-&gt;setPos(pos.pos);</a>
<a name="ln891">      }</a>
<a name="ln892"> </a>
<a name="ln893">//---------------------------------------------------------</a>
<a name="ln894">//   paintEvent</a>
<a name="ln895">//    Note: desktop background and paper background are not</a>
<a name="ln896">//    scaled</a>
<a name="ln897">//---------------------------------------------------------</a>
<a name="ln898"> </a>
<a name="ln899">void ScoreView::paintEvent(QPaintEvent* ev)</a>
<a name="ln900">      {</a>
<a name="ln901">      if (!_score)</a>
<a name="ln902">            return;</a>
<a name="ln903">      QPainter vp(this);</a>
<a name="ln904">      vp.setRenderHint(QPainter::Antialiasing, preferences.getBool(PREF_UI_CANVAS_MISC_ANTIALIASEDDRAWING));</a>
<a name="ln905">      vp.setRenderHint(QPainter::TextAntialiasing, true);</a>
<a name="ln906"> </a>
<a name="ln907">      paint(ev-&gt;rect(), vp);</a>
<a name="ln908"> </a>
<a name="ln909">      vp.setTransform(_matrix);</a>
<a name="ln910">      vp.setClipping(false);</a>
<a name="ln911"> </a>
<a name="ln912">      _curLoopIn-&gt;paint(&amp;vp);</a>
<a name="ln913">      _curLoopOut-&gt;paint(&amp;vp);</a>
<a name="ln914">      _cursor-&gt;paint(&amp;vp);</a>
<a name="ln915"> </a>
<a name="ln916">      if (_score-&gt;layoutMode() == LayoutMode::LINE)</a>
<a name="ln917">            _continuousPanel-&gt;paint(ev-&gt;rect(), vp);</a>
<a name="ln918"> </a>
<a name="ln919">      if (!lasso-&gt;bbox().isEmpty())</a>
<a name="ln920">            lasso-&gt;draw(&amp;vp);</a>
<a name="ln921">      shadowNote-&gt;draw(&amp;vp);</a>
<a name="ln922"> </a>
<a name="ln923">      if (!dropAnchor.isNull()) {</a>
<a name="ln924">            const auto dropAnchorColor = preferences.getColor(PREF_UI_SCORE_VOICE4_COLOR);</a>
<a name="ln925">            QPen pen(QBrush(dropAnchorColor), 2.0 / vp.worldTransform().m11(), Qt::DotLine);</a>
<a name="ln926">            vp.setPen(pen);</a>
<a name="ln927">            vp.drawLine(dropAnchor);</a>
<a name="ln928"> </a>
<a name="ln929">            qreal d = 4.0 / vp.worldTransform().m11();</a>
<a name="ln930">            QRectF r(-d, -d, 2 * d, 2 * d);</a>
<a name="ln931"> </a>
<a name="ln932">            vp.setBrush(QBrush(dropAnchorColor));</a>
<a name="ln933">            vp.setPen(Qt::NoPen);</a>
<a name="ln934">            r.moveCenter(dropAnchor.p1());</a>
<a name="ln935">            vp.drawEllipse(r);</a>
<a name="ln936">            r.moveCenter(dropAnchor.p2());</a>
<a name="ln937">            vp.drawEllipse(r);</a>
<a name="ln938">            }</a>
<a name="ln939">      }</a>
<a name="ln940"> </a>
<a name="ln941">//---------------------------------------------------------</a>
<a name="ln942">//   drawBackground</a>
<a name="ln943">//---------------------------------------------------------</a>
<a name="ln944"> </a>
<a name="ln945">void ScoreView::drawBackground(QPainter* p, const QRectF&amp; r) const</a>
<a name="ln946">      {</a>
<a name="ln947">      if (score()-&gt;printing()) {</a>
<a name="ln948">            p-&gt;fillRect(r, Qt::white);</a>
<a name="ln949">            return;</a>
<a name="ln950">            }</a>
<a name="ln951">      if (_fgPixmap == 0 || _fgPixmap-&gt;isNull())</a>
<a name="ln952">            p-&gt;fillRect(r, _fgColor);</a>
<a name="ln953">      else {</a>
<a name="ln954">            p-&gt;drawTiledPixmap(r, *_fgPixmap, r.topLeft()</a>
<a name="ln955">               - QPoint(lrint(_matrix.dx()), lrint(_matrix.dy())));</a>
<a name="ln956">            }</a>
<a name="ln957">      }</a>
<a name="ln958"> </a>
<a name="ln959">//---------------------------------------------------------</a>
<a name="ln960">//   paintPageBorder</a>
<a name="ln961">//---------------------------------------------------------</a>
<a name="ln962"> </a>
<a name="ln963">void ScoreView::paintPageBorder(QPainter&amp; p, Page* page)</a>
<a name="ln964">      {</a>
<a name="ln965">      //add a black border to pages</a>
<a name="ln966">      QRectF r(page-&gt;canvasBoundingRect());</a>
<a name="ln967">      p.setBrush(Qt::NoBrush);</a>
<a name="ln968">      p.setPen(QPen(QColor(0,0,0,102), 1));</a>
<a name="ln969">      p.drawRect(r);</a>
<a name="ln970"> </a>
<a name="ln971">      if (_score-&gt;showPageborders()) {</a>
<a name="ln972">            // show page margins</a>
<a name="ln973">            p.setBrush(Qt::NoBrush);</a>
<a name="ln974">            p.setPen(MScore::frameMarginColor);</a>
<a name="ln975">            QRectF f(page-&gt;canvasBoundingRect());</a>
<a name="ln976">            f.adjust(page-&gt;lm(), page-&gt;tm(), -page-&gt;rm(), -page-&gt;bm());</a>
<a name="ln977">            p.drawRect(f);</a>
<a name="ln978">            if (!page-&gt;isOdd())</a>
<a name="ln979">                  p.drawLine(f.right(), 0.0, f.right(), f.bottom());</a>
<a name="ln980">            }</a>
<a name="ln981">      }</a>
<a name="ln982"> </a>
<a name="ln983">#ifndef NDEBUG</a>
<a name="ln984">//---------------------------------------------------------</a>
<a name="ln985">//   drawDebugInfo</a>
<a name="ln986">//---------------------------------------------------------</a>
<a name="ln987"> </a>
<a name="ln988">static void drawDebugInfo(QPainter&amp; p, const Element* _e)</a>
<a name="ln989">      {</a>
<a name="ln990">      if (!MScore::showBoundingRect)</a>
<a name="ln991">            return;</a>
<a name="ln992">      const Element* e = _e;</a>
<a name="ln993">      //</a>
<a name="ln994">      //  draw bounding box rectangle for all</a>
<a name="ln995">      //  selected Elements</a>
<a name="ln996">      //</a>
<a name="ln997">      QPointF pos(e-&gt;pagePos());</a>
<a name="ln998">      p.translate(pos);</a>
<a name="ln999">      p.setBrush(Qt::NoBrush);</a>
<a name="ln1000"> </a>
<a name="ln1001">      p.setPen(QPen(Qt::red, 0.0));</a>
<a name="ln1002">//      p.drawRect(e-&gt;bbox());</a>
<a name="ln1003">      e-&gt;shape().paint(p);</a>
<a name="ln1004"> </a>
<a name="ln1005">      p.setPen(QPen(Qt::red, 0.0));             // red x at 0,0 of bbox</a>
<a name="ln1006">      qreal w = 5.0 / p.matrix().m11();</a>
<a name="ln1007">      qreal h = w;</a>
<a name="ln1008">      qreal x = 0; // e-&gt;bbox().x();</a>
<a name="ln1009">      qreal y = 0; // e-&gt;bbox().y();</a>
<a name="ln1010">      p.drawLine(QLineF(x-w, y-h, x+w, y+h));</a>
<a name="ln1011">      p.drawLine(QLineF(x+w, y-h, x-w, y+h));</a>
<a name="ln1012"> </a>
<a name="ln1013">      p.translate(-pos);</a>
<a name="ln1014">      if (e-&gt;parent()) {</a>
<a name="ln1015">            const Element* ee = e-&gt;parent();</a>
<a name="ln1016">            if (e-&gt;isNote())</a>
<a name="ln1017">                  ee = toNote(e)-&gt;chord()-&gt;segment();</a>
<a name="ln1018">            else if (e-&gt;isClef())</a>
<a name="ln1019">                  ee = toClef(e)-&gt;segment();</a>
<a name="ln1020"> </a>
<a name="ln1021">            p.setPen(QPen(Qt::green, 0.0));</a>
<a name="ln1022"> </a>
<a name="ln1023">            p.drawRect(ee-&gt;pageBoundingRect());</a>
<a name="ln1024"> </a>
<a name="ln1025">            if (ee-&gt;isSegment()) {</a>
<a name="ln1026">                  QPointF pt = ee-&gt;pagePos();</a>
<a name="ln1027">                  p.setPen(QPen(Qt::blue, 0.0));</a>
<a name="ln1028">                  p.drawLine(QLineF(pt.x()-w, pt.y()-h, pt.x()+w, pt.y()+h));</a>
<a name="ln1029">                  p.drawLine(QLineF(pt.x()+w, pt.y()-h, pt.x()-w, pt.y()+h));</a>
<a name="ln1030">                  }</a>
<a name="ln1031">            }</a>
<a name="ln1032">      }</a>
<a name="ln1033">#endif</a>
<a name="ln1034"> </a>
<a name="ln1035">//---------------------------------------------------------</a>
<a name="ln1036">//   drawElements</a>
<a name="ln1037">//---------------------------------------------------------</a>
<a name="ln1038"> </a>
<a name="ln1039">void ScoreView::drawElements(QPainter&amp; painter, QList&lt;Element*&gt;&amp; el, Element* editElement)</a>
<a name="ln1040">      {</a>
<a name="ln1041">      qStableSort(el.begin(), el.end(), elementLessThan);</a>
<a name="ln1042">      for (const Element* e : el) {</a>
<a name="ln1043">            e-&gt;itemDiscovered = 0;</a>
<a name="ln1044"> </a>
<a name="ln1045">            // harmony element representation is different in edit mode, so don't</a>
<a name="ln1046">            // all normal draw(). Complete drawing is done in drawEditMode()</a>
<a name="ln1047">            if (e == editElement)</a>
<a name="ln1048">                  continue;</a>
<a name="ln1049"> </a>
<a name="ln1050">            if (!e-&gt;visible() &amp;&amp; (score()-&gt;printing() || !score()-&gt;showInvisible()))</a>
<a name="ln1051">                  continue;</a>
<a name="ln1052">            if (e-&gt;isRest() &amp;&amp; toRest(e)-&gt;isGap())</a>
<a name="ln1053">                  continue;</a>
<a name="ln1054">            QPointF pos(e-&gt;pagePos());</a>
<a name="ln1055">            painter.translate(pos);</a>
<a name="ln1056">            e-&gt;draw(&amp;painter);</a>
<a name="ln1057">            painter.translate(-pos);</a>
<a name="ln1058">#ifndef NDEBUG</a>
<a name="ln1059">            if (e-&gt;selected())</a>
<a name="ln1060">                  drawDebugInfo(painter, e);</a>
<a name="ln1061">#endif</a>
<a name="ln1062">            }</a>
<a name="ln1063">      }</a>
<a name="ln1064"> </a>
<a name="ln1065">//---------------------------------------------------------</a>
<a name="ln1066">//   paint</a>
<a name="ln1067">//---------------------------------------------------------</a>
<a name="ln1068"> </a>
<a name="ln1069">void ScoreView::paint(const QRect&amp; r, QPainter&amp; p)</a>
<a name="ln1070">      {</a>
<a name="ln1071">      p.save();</a>
<a name="ln1072">      if (_fgPixmap == 0 || _fgPixmap-&gt;isNull())</a>
<a name="ln1073">            p.fillRect(r, _fgColor);</a>
<a name="ln1074">      else {</a>
<a name="ln1075">            p.drawTiledPixmap(r, *_fgPixmap, r.topLeft()</a>
<a name="ln1076">               - QPoint(lrint(_matrix.dx()), lrint(_matrix.dy())));</a>
<a name="ln1077">            }</a>
<a name="ln1078"> </a>
<a name="ln1079">      p.setTransform(_matrix);</a>
<a name="ln1080">      QRectF fr = imatrix.mapRect(QRectF(r));</a>
<a name="ln1081"> </a>
<a name="ln1082">      Element* editElement = 0;</a>
<a name="ln1083">      Lasso* lassoToDraw = 0;</a>
<a name="ln1084">      if (editData.element) {</a>
<a name="ln1085">            switch (state) {</a>
<a name="ln1086">                  case ViewState::NORMAL:</a>
<a name="ln1087">                        if (editData.element-&gt;normalModeEditBehavior() == Element::EditBehavior::Edit)</a>
<a name="ln1088">                              editData.element-&gt;drawEditMode(&amp;p, editData);</a>
<a name="ln1089">                        break;</a>
<a name="ln1090">                  case ViewState::DRAG:</a>
<a name="ln1091">                  case ViewState::DRAG_OBJECT:</a>
<a name="ln1092">                  case ViewState::LASSO:</a>
<a name="ln1093">                  case ViewState::NOTE_ENTRY:</a>
<a name="ln1094">                  case ViewState::PLAY:</a>
<a name="ln1095">                  case ViewState::ENTRY_PLAY:</a>
<a name="ln1096">                        break;</a>
<a name="ln1097">                  case ViewState::EDIT:</a>
<a name="ln1098">                  case ViewState::DRAG_EDIT:</a>
<a name="ln1099">                  case ViewState::FOTO:</a>
<a name="ln1100">                  case ViewState::FOTO_DRAG:</a>
<a name="ln1101">                  case ViewState::FOTO_DRAG_EDIT:</a>
<a name="ln1102">                  case ViewState::FOTO_DRAG_OBJECT:</a>
<a name="ln1103">                  case ViewState::FOTO_LASSO:</a>
<a name="ln1104">                        if (editData.element-&gt;isLasso())</a>
<a name="ln1105">                              lassoToDraw = toLasso(editData.element);</a>
<a name="ln1106">                        else</a>
<a name="ln1107">                              editData.element-&gt;drawEditMode(&amp;p, editData);</a>
<a name="ln1108"> </a>
<a name="ln1109">                        if (editData.element-&gt;isHarmony())</a>
<a name="ln1110">                              editElement = editData.element;     // do not call paint() method</a>
<a name="ln1111">                        break;</a>
<a name="ln1112">                  }</a>
<a name="ln1113">            }</a>
<a name="ln1114"> </a>
<a name="ln1115">      QRegion r1(r);</a>
<a name="ln1116">      if ((_score-&gt;layoutMode() == LayoutMode::LINE) || (_score-&gt;layoutMode() == LayoutMode::SYSTEM)) {</a>
<a name="ln1117">            if (_score-&gt;pages().size() &gt; 0) {</a>
<a name="ln1118">                  Page* page = _score-&gt;pages().front();</a>
<a name="ln1119">                  QList&lt;Element*&gt; ell = page-&gt;items(fr);</a>
<a name="ln1120">                  drawElements(p, ell, editElement);</a>
<a name="ln1121">                  }</a>
<a name="ln1122">            }</a>
<a name="ln1123">      else {</a>
<a name="ln1124">            for (Page* page : _score-&gt;pages()) {</a>
<a name="ln1125">                  QRectF pr(page-&gt;abbox().translated(page-&gt;pos()));</a>
<a name="ln1126">                  if (pr.right() &lt; fr.left())</a>
<a name="ln1127">                        continue;</a>
<a name="ln1128">                  if (pr.left() &gt; fr.right())</a>
<a name="ln1129">                        break;</a>
<a name="ln1130"> </a>
<a name="ln1131">                  if (!score()-&gt;printing())</a>
<a name="ln1132">                        paintPageBorder(p, page);</a>
<a name="ln1133">                  QList&lt;Element*&gt; ell = page-&gt;items(fr.translated(-page-&gt;pos()));</a>
<a name="ln1134">                  QPointF pos(page-&gt;pos());</a>
<a name="ln1135">                  p.translate(pos);</a>
<a name="ln1136">                  drawElements(p, ell, editElement);</a>
<a name="ln1137"> </a>
<a name="ln1138">#ifndef NDEBUG</a>
<a name="ln1139">                  if (!score()-&gt;printing()) {</a>
<a name="ln1140">                        if (MScore::showSystemBoundingRect) {</a>
<a name="ln1141">                              for (const System* system : page-&gt;systems()) {</a>
<a name="ln1142">                                    QPointF pt(system-&gt;ipos());</a>
<a name="ln1143">                                    qreal h = system-&gt;height() + system-&gt;minBottom() + system-&gt;minTop();</a>
<a name="ln1144">                                    p.translate(pt);</a>
<a name="ln1145">                                    QRectF rect(0.0, -system-&gt;minTop(), system-&gt;width(), h);</a>
<a name="ln1146">                                    p.drawRect(rect);</a>
<a name="ln1147">                                    p.translate(-pt);</a>
<a name="ln1148">                                    }</a>
<a name="ln1149">                              }</a>
<a name="ln1150">                        if (MScore::showSegmentShapes) {</a>
<a name="ln1151">                              for (const System* system : page-&gt;systems()) {</a>
<a name="ln1152">                                    for (const MeasureBase* mb : system-&gt;measures()) {</a>
<a name="ln1153">                                          if (mb-&gt;type() == ElementType::MEASURE) {</a>
<a name="ln1154">                                                const Measure* m = static_cast&lt;const Measure*&gt;(mb);</a>
<a name="ln1155">                                                p.setBrush(Qt::NoBrush);</a>
<a name="ln1156">                                                p.setPen(QPen(QBrush(Qt::darkYellow), 0.5));</a>
<a name="ln1157">                                                for (const Segment* s = m-&gt;first(); s; s = s-&gt;next()) {</a>
<a name="ln1158">                                                      for (int i = 0; i &lt; score()-&gt;nstaves(); ++i) {</a>
<a name="ln1159">                                                            QPointF pt(s-&gt;pos().x() + m-&gt;pos().x() + system-&gt;pos().x(),</a>
<a name="ln1160">                                                               system-&gt;staffYpage(i));</a>
<a name="ln1161">                                                            p.translate(pt);</a>
<a name="ln1162">                                                            s-&gt;shapes().at(i).paint(p);</a>
<a name="ln1163">                                                            p.translate(-pt);</a>
<a name="ln1164">                                                            }</a>
<a name="ln1165">                                                      }</a>
<a name="ln1166">                                                }</a>
<a name="ln1167">                                          }</a>
<a name="ln1168">                                    }</a>
<a name="ln1169">                              }</a>
<a name="ln1170">                        if (MScore::showSkylines) {</a>
<a name="ln1171">                              for (const System* system : page-&gt;systems()) {</a>
<a name="ln1172">                                    for (SysStaff* ss : *system-&gt;staves()) {</a>
<a name="ln1173">                                          QPointF pt(system-&gt;ipos().x(), system-&gt;ipos().y() + ss-&gt;y());</a>
<a name="ln1174">                                          p.translate(pt);</a>
<a name="ln1175">                                          ss-&gt;skyline().paint(p);</a>
<a name="ln1176">                                          p.translate(-pt);</a>
<a name="ln1177">                                          }</a>
<a name="ln1178">                                    }</a>
<a name="ln1179">                              }</a>
<a name="ln1180">                        if (MScore::showCorruptedMeasures) {</a>
<a name="ln1181">                              double _spatium = score()-&gt;spatium();</a>
<a name="ln1182">                              QPen pen;</a>
<a name="ln1183">                              pen.setColor(Qt::red);</a>
<a name="ln1184">                              pen.setWidthF(4);</a>
<a name="ln1185">                              pen.setStyle(Qt::SolidLine);</a>
<a name="ln1186">                              p.setPen(pen);</a>
<a name="ln1187">                              p.setBrush(Qt::NoBrush);</a>
<a name="ln1188">                              for (const System* system : page-&gt;systems()) {</a>
<a name="ln1189">                                    for (const MeasureBase* mb : system-&gt;measures()) {</a>
<a name="ln1190">                                          if (mb-&gt;type() == ElementType::MEASURE) {</a>
<a name="ln1191">                                                const Measure* m = static_cast&lt;const Measure*&gt;(mb);</a>
<a name="ln1192">                                                for (int staffIdx = 0; staffIdx &lt; m-&gt;score()-&gt;nstaves(); staffIdx++) {</a>
<a name="ln1193">                                                      if (m-&gt;corrupted(staffIdx)) {</a>
<a name="ln1194">                                                            p.drawRect(m-&gt;staffabbox(staffIdx).adjusted(0, -_spatium, 0, _spatium));</a>
<a name="ln1195">                                                            }</a>
<a name="ln1196">                                                      }</a>
<a name="ln1197">                                                }</a>
<a name="ln1198">                                          }</a>
<a name="ln1199">                                    }</a>
<a name="ln1200">                              }</a>
<a name="ln1201">                        }</a>
<a name="ln1202">#endif</a>
<a name="ln1203"> </a>
<a name="ln1204">                  p.translate(-pos);</a>
<a name="ln1205">                  r1 -= _matrix.mapRect(pr).toAlignedRect();</a>
<a name="ln1206">                  }</a>
<a name="ln1207">            }</a>
<a name="ln1208">      if (dropRectangle.isValid())</a>
<a name="ln1209">            p.fillRect(dropRectangle, QColor(80, 0, 0, 80));</a>
<a name="ln1210"> </a>
<a name="ln1211">      const Selection&amp; sel = _score-&gt;selection();</a>
<a name="ln1212">      if (sel.isRange()) {</a>
<a name="ln1213">            Segment* ss = sel.startSegment();</a>
<a name="ln1214">            Segment* es = sel.endSegment();</a>
<a name="ln1215"> </a>
<a name="ln1216">            if (!ss)</a>
<a name="ln1217">                  return;</a>
<a name="ln1218"> </a>
<a name="ln1219">            if (!ss-&gt;enabled())</a>
<a name="ln1220">                  ss = ss-&gt;next1MMenabled();</a>
<a name="ln1221">            if (es &amp;&amp; !es-&gt;enabled())</a>
<a name="ln1222">                  es = es-&gt;next1MMenabled();</a>
<a name="ln1223">            if (es &amp;&amp; ss-&gt;tick() &gt; es-&gt;tick())  // start after end?</a>
<a name="ln1224">                  return;</a>
<a name="ln1225"> </a>
<a name="ln1226">            if (!ss-&gt;measure()-&gt;system()) {</a>
<a name="ln1227">                  // segment is in a measure that has not been laid out yet</a>
<a name="ln1228">                  // this can happen in mmrests</a>
<a name="ln1229">                  // first chordrest segment of mmrest instead</a>
<a name="ln1230">                  const Measure* mmr = ss-&gt;measure()-&gt;mmRest1();</a>
<a name="ln1231">                  if (mmr &amp;&amp; mmr-&gt;system())</a>
<a name="ln1232">                        ss = mmr-&gt;first(SegmentType::ChordRest);</a>
<a name="ln1233">                  else</a>
<a name="ln1234">                        return;                 // still no system?</a>
<a name="ln1235">                  if (!ss)</a>
<a name="ln1236">                        return;                 // no chordrest segment?</a>
<a name="ln1237">                  }</a>
<a name="ln1238"> </a>
<a name="ln1239">            p.setBrush(Qt::NoBrush);</a>
<a name="ln1240"> </a>
<a name="ln1241">            QPen pen;</a>
<a name="ln1242">            pen.setColor(MScore::selectColor[0]);</a>
<a name="ln1243">            pen.setWidthF(2.0 / p.matrix().m11());</a>
<a name="ln1244"> </a>
<a name="ln1245">            pen.setStyle(Qt::SolidLine);</a>
<a name="ln1246"> </a>
<a name="ln1247">            p.setPen(pen);</a>
<a name="ln1248">            double _spatium = score()-&gt;spatium();</a>
<a name="ln1249">            double x2      = ss-&gt;pagePos().x() - _spatium;</a>
<a name="ln1250">            int staffStart = sel.staffStart();</a>
<a name="ln1251">            int staffEnd   = sel.staffEnd();</a>
<a name="ln1252"> </a>
<a name="ln1253">            System* system2 = ss-&gt;measure()-&gt;system();</a>
<a name="ln1254">            QPointF pt      = ss-&gt;pagePos();</a>
<a name="ln1255">            double y        = pt.y();</a>
<a name="ln1256">            SysStaff* ss1   = system2-&gt;staff(staffStart);</a>
<a name="ln1257"> </a>
<a name="ln1258">            // find last visible staff:</a>
<a name="ln1259">            int lastStaff = 0;</a>
<a name="ln1260">            for (int i = staffEnd-1; i &gt;= 0; --i) {</a>
<a name="ln1261">                  if (score()-&gt;staff(i)-&gt;show()) {</a>
<a name="ln1262">                        lastStaff = i;</a>
<a name="ln1263">                        break;</a>
<a name="ln1264">                        }</a>
<a name="ln1265">                  }</a>
<a name="ln1266">            SysStaff* ss2 = system2-&gt;staff(lastStaff);</a>
<a name="ln1267"> </a>
<a name="ln1268">            double y1 = ss1-&gt;y() - 2 * score()-&gt;staff(staffStart)-&gt;spatium(Fraction(0,1)) + y;</a>
<a name="ln1269">            double y2 = ss2-&gt;y() + ss2-&gt;bbox().height() + 2 * score()-&gt;staff(lastStaff)-&gt;spatium(Fraction(0,1)) + y;</a>
<a name="ln1270"> </a>
<a name="ln1271">            // drag vertical start line</a>
<a name="ln1272">            p.drawLine(QLineF(x2, y1, x2, y2).translated(system2-&gt;page()-&gt;pos()));</a>
<a name="ln1273"> </a>
<a name="ln1274">            System* system1 = system2;</a>
<a name="ln1275">            double x1;</a>
<a name="ln1276"> </a>
<a name="ln1277">            for (Segment* s = ss; s &amp;&amp; (s != es); ) {</a>
<a name="ln1278">                  Segment* ns = s-&gt;next1MMenabled();</a>
<a name="ln1279">                  system1  = system2;</a>
<a name="ln1280">                  system2  = s-&gt;measure()-&gt;system();</a>
<a name="ln1281">                  if (!system2) {</a>
<a name="ln1282">                        // as before, use mmrest if necessary</a>
<a name="ln1283">                        const Measure* mmr = s-&gt;measure()-&gt;mmRest1();</a>
<a name="ln1284">                        if (mmr)</a>
<a name="ln1285">                              system2 = mmr-&gt;system();</a>
<a name="ln1286">                        if (!system2)</a>
<a name="ln1287">                              break;</a>
<a name="ln1288">                        // extend rectangle to end of mmrest</a>
<a name="ln1289">                        pt = mmr-&gt;last()-&gt;pagePos();</a>
<a name="ln1290">                        }</a>
<a name="ln1291">                  else</a>
<a name="ln1292">                        pt = s-&gt;pagePos();</a>
<a name="ln1293">                  x1  = x2;</a>
<a name="ln1294">                  x2  = pt.x() + _spatium * 2;</a>
<a name="ln1295"> </a>
<a name="ln1296">                  if (ns == 0 || ns == es) {    // last segment?</a>
<a name="ln1297">                        // if any staff in selection has measure rest or repeat measure in last measure,</a>
<a name="ln1298">                        // extend rectangle to bar line</a>
<a name="ln1299">                        Segment* fs = s-&gt;measure()-&gt;first(SegmentType::ChordRest);</a>
<a name="ln1300">                        if (fs) {</a>
<a name="ln1301">                              for (int i = staffStart; i &lt; staffEnd; ++i) {</a>
<a name="ln1302">                                    if (!score()-&gt;staff(i)-&gt;show())</a>
<a name="ln1303">                                          continue;</a>
<a name="ln1304">                                    ChordRest* cr = static_cast&lt;ChordRest*&gt;(fs-&gt;element(i * VOICES));</a>
<a name="ln1305">                                    if (cr &amp;&amp; (cr-&gt;type() == ElementType::REPEAT_MEASURE || cr-&gt;durationType() == TDuration::DurationType::V_MEASURE)) {</a>
<a name="ln1306">                                          x2 = s-&gt;measure()-&gt;abbox().right() - _spatium * 0.5;</a>
<a name="ln1307">                                          break;</a>
<a name="ln1308">                                          }</a>
<a name="ln1309">                                    }</a>
<a name="ln1310">                              }</a>
<a name="ln1311">                        }</a>
<a name="ln1312"> </a>
<a name="ln1313">                  if (system2 != system1)</a>
<a name="ln1314">                        x1  = x2 - 2 * _spatium;</a>
<a name="ln1315">                  y   = pt.y();</a>
<a name="ln1316">                  ss1 = system2-&gt;staff(staffStart);</a>
<a name="ln1317">                  ss2 = system2-&gt;staff(lastStaff);</a>
<a name="ln1318">                  y1  = ss1-&gt;y() - 2 * score()-&gt;staff(staffStart)-&gt;spatium(s-&gt;tick()) + y;</a>
<a name="ln1319">                  y2  = ss2-&gt;y() + ss2-&gt;bbox().height() + 2 * score()-&gt;staff(lastStaff)-&gt;spatium(s-&gt;tick()) + y;</a>
<a name="ln1320">                  p.drawLine(QLineF(x1, y1, x2, y1).translated(system2-&gt;page()-&gt;pos()));</a>
<a name="ln1321">                  p.drawLine(QLineF(x1, y2, x2, y2).translated(system2-&gt;page()-&gt;pos()));</a>
<a name="ln1322">                  s = ns;</a>
<a name="ln1323">                  }</a>
<a name="ln1324">            //</a>
<a name="ln1325">            // draw vertical end line</a>
<a name="ln1326">            //</a>
<a name="ln1327">            p.drawLine(QLineF(x2, y1, x2, y2).translated(system2-&gt;page()-&gt;pos()));</a>
<a name="ln1328">            }</a>
<a name="ln1329"> </a>
<a name="ln1330">      // Draw foto lasso to ensure that it is above everything else</a>
<a name="ln1331">      if (lassoToDraw)</a>
<a name="ln1332">            lassoToDraw-&gt;drawEditMode(&amp;p, editData);</a>
<a name="ln1333"> </a>
<a name="ln1334">      p.setWorldMatrixEnabled(false);</a>
<a name="ln1335">      if (_score-&gt;layoutMode() != LayoutMode::LINE &amp;&amp; _score-&gt;layoutMode() != LayoutMode::SYSTEM &amp;&amp; !r1.isEmpty()) {</a>
<a name="ln1336">            p.setClipRegion(r1);  // only background</a>
<a name="ln1337">            if (_bgPixmap == 0 || _bgPixmap-&gt;isNull())</a>
<a name="ln1338">                  p.fillRect(r, _bgColor);</a>
<a name="ln1339">            else</a>
<a name="ln1340">                  p.drawTiledPixmap(r, *_bgPixmap, r.topLeft() - QPoint(_matrix.m31(), _matrix.m32()));</a>
<a name="ln1341">            }</a>
<a name="ln1342">      p.restore();</a>
<a name="ln1343">      }</a>
<a name="ln1344"> </a>
<a name="ln1345">//---------------------------------------------------------</a>
<a name="ln1346">//   zoomStep: zoom in or out by some number of steps</a>
<a name="ln1347">//---------------------------------------------------------</a>
<a name="ln1348"> </a>
<a name="ln1349">void ScoreView::zoomStep(qreal step, const QPoint&amp; pos)</a>
<a name="ln1350">      {</a>
<a name="ln1351">      qreal _mag = lmag();</a>
<a name="ln1352"> </a>
<a name="ln1353">      _mag *= qPow(1.1, step);</a>
<a name="ln1354"> </a>
<a name="ln1355">      zoom(_mag, QPointF(pos));</a>
<a name="ln1356">      }</a>
<a name="ln1357"> </a>
<a name="ln1358">//---------------------------------------------------------</a>
<a name="ln1359">//   zoom: zoom to some absolute zoom level</a>
<a name="ln1360">//---------------------------------------------------------</a>
<a name="ln1361"> </a>
<a name="ln1362">void ScoreView::zoom(qreal _mag, const QPointF&amp; pos)</a>
<a name="ln1363">      {</a>
<a name="ln1364">      QPointF p1 = imatrix.map(pos);</a>
<a name="ln1365"> </a>
<a name="ln1366">      if (_mag &gt; 16.0)</a>
<a name="ln1367">            _mag = 16.0;</a>
<a name="ln1368">      else if (_mag &lt; 0.05)</a>
<a name="ln1369">            _mag = 0.05;</a>
<a name="ln1370"> </a>
<a name="ln1371">      mscore-&gt;setMag(_mag);</a>
<a name="ln1372"> </a>
<a name="ln1373">      double m = _mag * mscore-&gt;physicalDotsPerInch() / DPI;</a>
<a name="ln1374"> </a>
<a name="ln1375">      setMag(m);</a>
<a name="ln1376"> </a>
<a name="ln1377">      _magIdx    = MagIdx::MAG_FREE;</a>
<a name="ln1378">      QPointF p2 = imatrix.map(pos);</a>
<a name="ln1379">      QPointF p3 = p2 - p1;</a>
<a name="ln1380">      int dx     = lrint(p3.x() * m);</a>
<a name="ln1381">      int dy     = lrint(p3.y() * m);</a>
<a name="ln1382"> </a>
<a name="ln1383">      constraintCanvas(&amp;dx, &amp;dy);</a>
<a name="ln1384"> </a>
<a name="ln1385">      _matrix.setMatrix(_matrix.m11(), _matrix.m12(), _matrix.m13(), _matrix.m21(),</a>
<a name="ln1386">         _matrix.m22(), _matrix.m23(), _matrix.dx()+dx, _matrix.dy()+dy, _matrix.m33());</a>
<a name="ln1387">      imatrix = _matrix.inverted();</a>
<a name="ln1388">      scroll(dx, dy, QRect(0, 0, width(), height()));</a>
<a name="ln1389">      emit viewRectChanged();</a>
<a name="ln1390">      emit offsetChanged(_matrix.dx(), _matrix.dy());</a>
<a name="ln1391">      update();</a>
<a name="ln1392">      }</a>
<a name="ln1393"> </a>
<a name="ln1394">//-----------------------------------------------------------------------------</a>
<a name="ln1395">//   constraintCanvas</a>
<a name="ln1396">//-----------------------------------------------------------------------------</a>
<a name="ln1397"> </a>
<a name="ln1398">void ScoreView::constraintCanvas (int* dxx, int* dyy)</a>
<a name="ln1399">      {</a>
<a name="ln1400">      if (score()-&gt;layoutMode() == LayoutMode::SYSTEM)</a>
<a name="ln1401">            return;</a>
<a name="ln1402">      if (score()-&gt;pages().isEmpty())</a>
<a name="ln1403">            return;</a>
<a name="ln1404">      int dx = *dxx;</a>
<a name="ln1405">      int dy = *dyy;</a>
<a name="ln1406">      QRectF rect = QRectF(0, 0, width(), height());</a>
<a name="ln1407"> </a>
<a name="ln1408">      Page* firstPage = score()-&gt;pages().front();</a>
<a name="ln1409">      Page* lastPage  = score()-&gt;pages().back();</a>
<a name="ln1410"> </a>
<a name="ln1411">      if (firstPage &amp;&amp; lastPage) {</a>
<a name="ln1412">            QPointF offsetPt(xoffset(), yoffset());</a>
<a name="ln1413">            QRectF firstPageRect(firstPage-&gt;pos().x() * mag(),</a>
<a name="ln1414">                                      firstPage-&gt;pos().y() * mag(),</a>
<a name="ln1415">                                      firstPage-&gt;width() * mag(),</a>
<a name="ln1416">                                      firstPage-&gt;height() * mag());</a>
<a name="ln1417">            QRectF lastPageRect(lastPage-&gt;pos().x() * mag(),</a>
<a name="ln1418">                                         lastPage-&gt;pos().y() * mag(),</a>
<a name="ln1419">                                         lastPage-&gt;width() * mag(),</a>
<a name="ln1420">                                         lastPage-&gt;height() * mag());</a>
<a name="ln1421">            QRectF pagesRect     = firstPageRect.united(lastPageRect).translated(offsetPt);</a>
<a name="ln1422">            bool limitScrollArea = preferences.getBool(PREF_UI_CANVAS_SCROLL_LIMITSCROLLAREA);</a>
<a name="ln1423">            if (!limitScrollArea) {</a>
<a name="ln1424">                  qreal hmargin = this-&gt;width() * 0.75;</a>
<a name="ln1425">                  qreal vmargin = this-&gt;height() * 0.75;</a>
<a name="ln1426">                  pagesRect.adjust(-hmargin, -vmargin, hmargin, vmargin);</a>
<a name="ln1427">                  }</a>
<a name="ln1428">            QRectF toPagesRect = pagesRect.translated(dx, dy);</a>
<a name="ln1429"> </a>
<a name="ln1430">            if (limitScrollArea) {</a>
<a name="ln1431">                  if (pagesRect.width() &lt;= rect.width()) {</a>
<a name="ln1432">                        if (score()-&gt;layoutMode() == LayoutMode::LINE)</a>
<a name="ln1433">                              // keep score fixed in place horizontally</a>
<a name="ln1434">                              dx = 0;</a>
<a name="ln1435">                        else</a>
<a name="ln1436">                              // center horizontally on screen</a>
<a name="ln1437">                              dx = (rect.width() - pagesRect.width()) / 2 - pagesRect.left();</a>
<a name="ln1438">                        }</a>
<a name="ln1439">                  else if (toPagesRect.left() &gt; rect.left())</a>
<a name="ln1440">                        // get rid of the left margin</a>
<a name="ln1441">                        dx = rect.left() - pagesRect.left();</a>
<a name="ln1442">                  else if (toPagesRect.right() &lt; rect.right())</a>
<a name="ln1443">                        // get rid of the right margin</a>
<a name="ln1444">                        dx = rect.right() - pagesRect.right();</a>
<a name="ln1445">                  }</a>
<a name="ln1446">            else if (dx &gt; 0) { // move right</a>
<a name="ln1447">                  if (toPagesRect.right() &gt; rect.right() &amp;&amp; toPagesRect.left() &gt; rect.left()) {</a>
<a name="ln1448">                        if(pagesRect.width() &lt;= rect.width()) {</a>
<a name="ln1449">                              dx = rect.right() - pagesRect.right();</a>
<a name="ln1450">                              }</a>
<a name="ln1451">                        else {</a>
<a name="ln1452">                              dx = rect.left() - pagesRect.left();</a>
<a name="ln1453">                              }</a>
<a name="ln1454">                        }</a>
<a name="ln1455">                  }</a>
<a name="ln1456">            else { // move left, dx &lt; 0</a>
<a name="ln1457">                  if (toPagesRect.left() &lt; rect.left() &amp;&amp; toPagesRect.right() &lt; rect.right()) {</a>
<a name="ln1458">                        if (pagesRect.width() &lt;= rect.width()) {</a>
<a name="ln1459">                              dx = rect.left() - pagesRect.left();</a>
<a name="ln1460">                              }</a>
<a name="ln1461">                        else {</a>
<a name="ln1462">                              dx = rect.right() - pagesRect.right();</a>
<a name="ln1463">                              }</a>
<a name="ln1464">                        }</a>
<a name="ln1465">                  }</a>
<a name="ln1466"> </a>
<a name="ln1467">            if (limitScrollArea) {</a>
<a name="ln1468">                  if (pagesRect.height() &lt;= rect.height()) {</a>
<a name="ln1469">                        if (score()-&gt;layoutMode() == LayoutMode::LINE)</a>
<a name="ln1470">                              // keep score fixed in place vertically</a>
<a name="ln1471">                              dy = 0;</a>
<a name="ln1472">                        else</a>
<a name="ln1473">                              // center vertically on screen</a>
<a name="ln1474">                              dy = (rect.height() - pagesRect.height()) / 2 - pagesRect.top();</a>
<a name="ln1475">                        }</a>
<a name="ln1476">                  else if (toPagesRect.top() &gt; rect.top())</a>
<a name="ln1477">                        // get rid of the top margin</a>
<a name="ln1478">                        dy = rect.top() - pagesRect.top();</a>
<a name="ln1479">                  else if (toPagesRect.bottom() &lt; rect.bottom())</a>
<a name="ln1480">                        // get rid of the bottom margin</a>
<a name="ln1481">                        dy = rect.bottom() - pagesRect.bottom();</a>
<a name="ln1482">                  }</a>
<a name="ln1483">            else if (dy &gt; 0) { // move down</a>
<a name="ln1484">                  if (toPagesRect.bottom() &gt; rect.bottom() &amp;&amp; toPagesRect.top() &gt; rect.top()) {</a>
<a name="ln1485">                        if (pagesRect.height() &lt;= rect.height()) {</a>
<a name="ln1486">                              dy = rect.bottom() - pagesRect.bottom();</a>
<a name="ln1487">                              }</a>
<a name="ln1488">                        else {</a>
<a name="ln1489">                              dy = rect.top() - pagesRect.top();</a>
<a name="ln1490">                              }</a>
<a name="ln1491">                        }</a>
<a name="ln1492">                  }</a>
<a name="ln1493">            else { // move up, dy &lt; 0</a>
<a name="ln1494">                  if (toPagesRect.top() &lt; rect.top() &amp;&amp; toPagesRect.bottom() &lt; rect.bottom()) {</a>
<a name="ln1495">                        if (pagesRect.height() &lt;= rect.height()) {</a>
<a name="ln1496">                              dy = rect.top() - pagesRect.top();</a>
<a name="ln1497">                              }</a>
<a name="ln1498">                        else {</a>
<a name="ln1499">                              dy = rect.bottom() - pagesRect.bottom();</a>
<a name="ln1500">                              }</a>
<a name="ln1501">                        }</a>
<a name="ln1502">                  }</a>
<a name="ln1503">            }</a>
<a name="ln1504">      *dxx = dx;</a>
<a name="ln1505">      *dyy = dy;</a>
<a name="ln1506">      }</a>
<a name="ln1507"> </a>
<a name="ln1508">//---------------------------------------------------------</a>
<a name="ln1509">//   setMag</a>
<a name="ln1510">//    nmag - physical scale</a>
<a name="ln1511">//---------------------------------------------------------</a>
<a name="ln1512"> </a>
<a name="ln1513">void ScoreView::setMag(qreal nmag)</a>
<a name="ln1514">      {</a>
<a name="ln1515">      qreal m = _matrix.m11();</a>
<a name="ln1516"> </a>
<a name="ln1517">      if (nmag == m)</a>
<a name="ln1518">            return;</a>
<a name="ln1519">      double deltamag = nmag / m;</a>
<a name="ln1520"> </a>
<a name="ln1521">      _matrix.setMatrix(nmag, _matrix.m12(), _matrix.m13(), _matrix.m21(),</a>
<a name="ln1522">         nmag, _matrix.m23(), _matrix.dx()*deltamag, _matrix.dy()*deltamag, _matrix.m33());</a>
<a name="ln1523">      imatrix = _matrix.inverted();</a>
<a name="ln1524">      emit scaleChanged(nmag * score()-&gt;spatium());</a>
<a name="ln1525">      if (editData.grips) {</a>
<a name="ln1526">            qreal w = 8.0 / nmag;</a>
<a name="ln1527">            qreal h = 8.0 / nmag;</a>
<a name="ln1528">            QRectF r(-w*.5, -h*.5, w, h);</a>
<a name="ln1529">            for (int i = 0; i &lt; editData.grips; ++i) {</a>
<a name="ln1530">                  QPointF p(editData.grip[i].center());</a>
<a name="ln1531">                  editData.grip[i] = r.translated(p);</a>
<a name="ln1532">                  }</a>
<a name="ln1533">            }</a>
<a name="ln1534">      update();</a>
<a name="ln1535">      }</a>
<a name="ln1536"> </a>
<a name="ln1537">//---------------------------------------------------------</a>
<a name="ln1538">//   setMag</a>
<a name="ln1539">//    mag - logical scale</a>
<a name="ln1540">//---------------------------------------------------------</a>
<a name="ln1541"> </a>
<a name="ln1542">void ScoreView::setMag(MagIdx idx, double mag)</a>
<a name="ln1543">      {</a>
<a name="ln1544">      _magIdx = idx;</a>
<a name="ln1545">      setMag(mag * (mscore-&gt;physicalDotsPerInch() / DPI));</a>
<a name="ln1546">      int dx = 0, dy = 0;</a>
<a name="ln1547">      constraintCanvas(&amp;dx, &amp;dy);</a>
<a name="ln1548">      if (dx != 0 || dy != 0) {</a>
<a name="ln1549">            _matrix.setMatrix(_matrix.m11(), _matrix.m12(), _matrix.m13(), _matrix.m21(),</a>
<a name="ln1550">               _matrix.m22(), _matrix.m23(), _matrix.dx()+dx, _matrix.dy()+dy, _matrix.m33());</a>
<a name="ln1551">            imatrix = _matrix.inverted();</a>
<a name="ln1552">            scroll(dx, dy, QRect(0, 0, width(), height()));</a>
<a name="ln1553">            emit offsetChanged(_matrix.dx(), _matrix.dy());</a>
<a name="ln1554">            }</a>
<a name="ln1555">      emit viewRectChanged();</a>
<a name="ln1556">      update();</a>
<a name="ln1557">      }</a>
<a name="ln1558"> </a>
<a name="ln1559">//---------------------------------------------------------</a>
<a name="ln1560">//   setFocusRect</a>
<a name="ln1561">//---------------------------------------------------------</a>
<a name="ln1562"> </a>
<a name="ln1563">void ScoreView::setFocusRect()</a>
<a name="ln1564">      {</a>
<a name="ln1565">      if (mscore-&gt;splitScreen()) {</a>
<a name="ln1566">            if (!focusFrame) {</a>
<a name="ln1567">                  focusFrame = new QFocusFrame;</a>
<a name="ln1568">                  QPalette p(focusFrame-&gt;palette());</a>
<a name="ln1569">                  p.setColor(QPalette::WindowText, MScore::selectColor[0]);</a>
<a name="ln1570">                  focusFrame-&gt;setPalette(p);</a>
<a name="ln1571">                  }</a>
<a name="ln1572">            focusFrame-&gt;setWidget(static_cast&lt;QWidget*&gt;(this));</a>
<a name="ln1573">            focusFrame-&gt;show();</a>
<a name="ln1574">            }</a>
<a name="ln1575">      else {</a>
<a name="ln1576">            if (focusFrame)</a>
<a name="ln1577">                  focusFrame-&gt;setWidget(0);</a>
<a name="ln1578">            }</a>
<a name="ln1579">      }</a>
<a name="ln1580"> </a>
<a name="ln1581">//---------------------------------------------------------</a>
<a name="ln1582">//   editCopy</a>
<a name="ln1583">//---------------------------------------------------------</a>
<a name="ln1584"> </a>
<a name="ln1585">void ScoreView::editCopy()</a>
<a name="ln1586">      {</a>
<a name="ln1587">      if (editData.element)</a>
<a name="ln1588">            editData.element-&gt;editCopy(editData);</a>
<a name="ln1589">      }</a>
<a name="ln1590"> </a>
<a name="ln1591">//---------------------------------------------------------</a>
<a name="ln1592">//   editCut</a>
<a name="ln1593">//---------------------------------------------------------</a>
<a name="ln1594"> </a>
<a name="ln1595">void ScoreView::editCut()</a>
<a name="ln1596">      {</a>
<a name="ln1597">      _score-&gt;startCmd();</a>
<a name="ln1598">      if (editData.element)</a>
<a name="ln1599">            editData.element-&gt;editCut(editData);</a>
<a name="ln1600">      _score-&gt;endCmd();</a>
<a name="ln1601">      }</a>
<a name="ln1602"> </a>
<a name="ln1603">//---------------------------------------------------------</a>
<a name="ln1604">//   checkCopyOrCut</a>
<a name="ln1605">//---------------------------------------------------------</a>
<a name="ln1606"> </a>
<a name="ln1607">bool ScoreView::checkCopyOrCut()</a>
<a name="ln1608">      {</a>
<a name="ln1609">      if (!_score-&gt;selection().canCopy()) {</a>
<a name="ln1610">            QMessageBox::information(0, &quot;MuseScore&quot;,</a>
<a name="ln1611">               tr(&quot;Please select the complete tuplet/tremolo and retry the command&quot;),</a>
<a name="ln1612">               QMessageBox::Ok, QMessageBox::NoButton);</a>
<a name="ln1613">            return false;</a>
<a name="ln1614">            }</a>
<a name="ln1615">      return true;</a>
<a name="ln1616">      }</a>
<a name="ln1617"> </a>
<a name="ln1618">//---------------------------------------------------------</a>
<a name="ln1619">//   normalCopy</a>
<a name="ln1620">//---------------------------------------------------------</a>
<a name="ln1621"> </a>
<a name="ln1622">void ScoreView::normalCopy()</a>
<a name="ln1623">      {</a>
<a name="ln1624">      if (!checkCopyOrCut())</a>
<a name="ln1625">            return;</a>
<a name="ln1626">      QString mimeType = _score-&gt;selection().mimeType();</a>
<a name="ln1627">      if (!mimeType.isEmpty()) {</a>
<a name="ln1628">            QMimeData* mimeData = new QMimeData;</a>
<a name="ln1629">            mimeData-&gt;setData(mimeType, _score-&gt;selection().mimeData());</a>
<a name="ln1630">            if (MScore::debugMode)</a>
<a name="ln1631">                  qDebug(&quot;cmd copy: &lt;%s&gt;&quot;, mimeData-&gt;data(mimeType).data());</a>
<a name="ln1632">            QApplication::clipboard()-&gt;setMimeData(mimeData);</a>
<a name="ln1633">            }</a>
<a name="ln1634">      }</a>
<a name="ln1635"> </a>
<a name="ln1636">//---------------------------------------------------------</a>
<a name="ln1637">//   normalCut</a>
<a name="ln1638">//---------------------------------------------------------</a>
<a name="ln1639"> </a>
<a name="ln1640">void ScoreView::normalCut()</a>
<a name="ln1641">      {</a>
<a name="ln1642">      if (!checkCopyOrCut())</a>
<a name="ln1643">            return;</a>
<a name="ln1644">      _score-&gt;startCmd();</a>
<a name="ln1645">      normalCopy();</a>
<a name="ln1646">      _score-&gt;cmdDeleteSelection();</a>
<a name="ln1647">      _score-&gt;endCmd();</a>
<a name="ln1648">      }</a>
<a name="ln1649"> </a>
<a name="ln1650">//---------------------------------------------------------</a>
<a name="ln1651">//   editSwap</a>
<a name="ln1652">//---------------------------------------------------------</a>
<a name="ln1653"> </a>
<a name="ln1654">void ScoreView::editSwap()</a>
<a name="ln1655">      {</a>
<a name="ln1656">#if 0 // TODO</a>
<a name="ln1657">      if (editData.element &amp;&amp; editData.element-&gt;isText() &amp;&amp; !editData.element-&gt;isLyrics()) {</a>
<a name="ln1658">            Text* text = toText(editData.element);</a>
<a name="ln1659">            QString s = text-&gt;selectedText();</a>
<a name="ln1660">            text-&gt;paste(this);</a>
<a name="ln1661">            if (!s.isEmpty())</a>
<a name="ln1662">                  QApplication::clipboard()-&gt;setText(s, QClipboard::Clipboard);</a>
<a name="ln1663">            }</a>
<a name="ln1664">#endif</a>
<a name="ln1665">      }</a>
<a name="ln1666"> </a>
<a name="ln1667">//---------------------------------------------------------</a>
<a name="ln1668">//   editPaste</a>
<a name="ln1669">//---------------------------------------------------------</a>
<a name="ln1670"> </a>
<a name="ln1671">void ScoreView::editPaste()</a>
<a name="ln1672">      {</a>
<a name="ln1673">      if (textEditMode())</a>
<a name="ln1674">            toTextBase(editData.element)-&gt;paste(editData);</a>
<a name="ln1675">      }</a>
<a name="ln1676"> </a>
<a name="ln1677">//---------------------------------------------------------</a>
<a name="ln1678">//   normalSwap</a>
<a name="ln1679">//---------------------------------------------------------</a>
<a name="ln1680"> </a>
<a name="ln1681">void ScoreView::normalSwap()</a>
<a name="ln1682">      {</a>
<a name="ln1683">      if (!checkCopyOrCut())</a>
<a name="ln1684">            return;</a>
<a name="ln1685">      QString mimeType = _score-&gt;selection().mimeType();</a>
<a name="ln1686">      const QMimeData* ms = QApplication::clipboard()-&gt;mimeData();</a>
<a name="ln1687">      if (mimeType == mimeStaffListFormat) { // determine size of clipboard selection</a>
<a name="ln1688">            Fraction tickLen = Fraction(0,1);</a>
<a name="ln1689">            int staves = 0;</a>
<a name="ln1690">            QByteArray d(ms-&gt;data(mimeStaffListFormat));</a>
<a name="ln1691">            XmlReader e(d);</a>
<a name="ln1692">            e.readNextStartElement();</a>
<a name="ln1693">            if (e.name() == &quot;StaffList&quot;) {</a>
<a name="ln1694">                  tickLen = Fraction::fromTicks(e.intAttribute(&quot;len&quot;, 0));</a>
<a name="ln1695">                  staves  = e.intAttribute(&quot;staves&quot;, 0);</a>
<a name="ln1696">                  }</a>
<a name="ln1697">            if (tickLen &gt; Fraction(0,1)) { // attempt to extend selection to match clipboard size</a>
<a name="ln1698">                  Segment* seg = _score-&gt;selection().startSegment();</a>
<a name="ln1699">                  Fraction tick = _score-&gt;selection().tickStart() + tickLen;</a>
<a name="ln1700">                  Segment* segAfter = _score-&gt;tick2leftSegment(tick);</a>
<a name="ln1701">                  int staffIdx = _score-&gt;selection().staffStart() + staves - 1;</a>
<a name="ln1702">                  if (staffIdx &gt;= _score-&gt;nstaves())</a>
<a name="ln1703">                        staffIdx = _score-&gt;nstaves() - 1;</a>
<a name="ln1704">                  tick = _score-&gt;selection().tickStart();</a>
<a name="ln1705">                  Fraction  etick = tick + tickLen;</a>
<a name="ln1706">                  if (MScore::debugMode)</a>
<a name="ln1707">                        _score-&gt;selection().dump();</a>
<a name="ln1708">                  _score-&gt;selection().extendRangeSelection(seg, segAfter, staffIdx, tick, etick);</a>
<a name="ln1709">                  _score-&gt;selection().update();</a>
<a name="ln1710">                  if (MScore::debugMode)</a>
<a name="ln1711">                        _score-&gt;selection().dump();</a>
<a name="ln1712">                  if (!checkCopyOrCut())</a>
<a name="ln1713">                        return;</a>
<a name="ln1714">                  ms = QApplication::clipboard()-&gt;mimeData();</a>
<a name="ln1715">                  }</a>
<a name="ln1716">            }</a>
<a name="ln1717">      QByteArray d(_score-&gt;selection().mimeData());</a>
<a name="ln1718">      if (this-&gt;normalPaste()) {</a>
<a name="ln1719">            QMimeData* mimeData = new QMimeData;</a>
<a name="ln1720">            mimeData-&gt;setData(mimeType, d);</a>
<a name="ln1721">            QApplication::clipboard()-&gt;setMimeData(mimeData);</a>
<a name="ln1722">            }</a>
<a name="ln1723">      }</a>
<a name="ln1724"> </a>
<a name="ln1725">//---------------------------------------------------------</a>
<a name="ln1726">//   normalPaste</a>
<a name="ln1727">//---------------------------------------------------------</a>
<a name="ln1728"> </a>
<a name="ln1729">bool ScoreView::normalPaste(Fraction scale)</a>
<a name="ln1730">      {</a>
<a name="ln1731">      _score-&gt;startCmd();</a>
<a name="ln1732">      const QMimeData* ms = QApplication::clipboard()-&gt;mimeData();</a>
<a name="ln1733">      _score-&gt;cmdPaste(ms, this, scale);</a>
<a name="ln1734">      bool rv = MScore::_error == MS_NO_ERROR;</a>
<a name="ln1735">      _score-&gt;endCmd();</a>
<a name="ln1736">      return rv;</a>
<a name="ln1737">      }</a>
<a name="ln1738"> </a>
<a name="ln1739">//---------------------------------------------------------</a>
<a name="ln1740">//   cmdGotoElement</a>
<a name="ln1741">//---------------------------------------------------------</a>
<a name="ln1742"> </a>
<a name="ln1743">void ScoreView::cmdGotoElement(Element* e)</a>
<a name="ln1744">      {</a>
<a name="ln1745">      if (e) {</a>
<a name="ln1746">            if (e-&gt;type() == ElementType::NOTE)</a>
<a name="ln1747">                  score()-&gt;setPlayNote(true);</a>
<a name="ln1748">            score()-&gt;select(e, SelectType::SINGLE, 0);</a>
<a name="ln1749">            if (e)</a>
<a name="ln1750">                  adjustCanvasPosition(e, false);</a>
<a name="ln1751">            if (noteEntryMode())</a>
<a name="ln1752">                  moveCursor();</a>
<a name="ln1753">            updateAll();</a>
<a name="ln1754">            }</a>
<a name="ln1755">      }</a>
<a name="ln1756"> </a>
<a name="ln1757">//---------------------------------------------------------</a>
<a name="ln1758">//   ticksTab</a>
<a name="ln1759">//---------------------------------------------------------</a>
<a name="ln1760"> </a>
<a name="ln1761">void ScoreView::ticksTab(const Fraction&amp; ticks)</a>
<a name="ln1762">      {</a>
<a name="ln1763">      if (editData.element-&gt;isHarmony())</a>
<a name="ln1764">            harmonyTicksTab(ticks);</a>
<a name="ln1765">      else if (editData.element-&gt;isFiguredBass())</a>
<a name="ln1766">            figuredBassTicksTab(ticks);</a>
<a name="ln1767">      }</a>
<a name="ln1768"> </a>
<a name="ln1769">//---------------------------------------------------------</a>
<a name="ln1770">//   cmd</a>
<a name="ln1771">//---------------------------------------------------------</a>
<a name="ln1772"> </a>
<a name="ln1773">void ScoreView::cmd(const QAction* a)</a>
<a name="ln1774">      {</a>
<a name="ln1775">      const char* s = a ? a-&gt;data().toByteArray().constData() : &quot;&quot;;</a>
<a name="ln1776">      cmd(s);</a>
<a name="ln1777">      updateEditElement();</a>
<a name="ln1778">      }</a>
<a name="ln1779"> </a>
<a name="ln1780">void ScoreView::cmd(const char* s)</a>
<a name="ln1781">      {</a>
<a name="ln1782">      struct ScoreViewCmd {</a>
<a name="ln1783">            std::vector&lt;const char*&gt; commands;</a>
<a name="ln1784">            std::function&lt;void(ScoreView*, const QByteArray&amp; cmd)&gt; exec;</a>
<a name="ln1785">            };</a>
<a name="ln1786"> </a>
<a name="ln1787">      const QByteArray cmd(s);</a>
<a name="ln1788"> </a>
<a name="ln1789">      shadowNote-&gt;setVisible(false);</a>
<a name="ln1790">      if (MScore::debugMode)</a>
<a name="ln1791">            qDebug(&quot;ScoreView::cmd &lt;%s&gt;&quot;, s);</a>
<a name="ln1792"> </a>
<a name="ln1793">      static const std::vector&lt;ScoreViewCmd&gt; cmdList {</a>
<a name="ln1794">            {{&quot;escape&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1795">                  cv-&gt;escapeCmd();</a>
<a name="ln1796">                  }},</a>
<a name="ln1797">            {{&quot;note-input&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1798">                  if (cv-&gt;state == ViewState::NORMAL)</a>
<a name="ln1799">                        cv-&gt;changeState(ViewState::NOTE_ENTRY);</a>
<a name="ln1800">                  else if (cv-&gt;state == ViewState::NOTE_ENTRY)</a>
<a name="ln1801">                        cv-&gt;changeState(ViewState::NORMAL);</a>
<a name="ln1802">                  }},</a>
<a name="ln1803">            {{&quot;copy&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1804">                  if (cv-&gt;fotoMode())</a>
<a name="ln1805">                        cv-&gt;fotoModeCopy();</a>
<a name="ln1806">                  else if (cv-&gt;state == ViewState::NORMAL)</a>
<a name="ln1807">                        cv-&gt;normalCopy();</a>
<a name="ln1808">                  else if (cv-&gt;state == ViewState::EDIT)</a>
<a name="ln1809">                        cv-&gt;editCopy();</a>
<a name="ln1810">                  }},</a>
<a name="ln1811">            {{&quot;cut&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1812">                  if (cv-&gt;state == ViewState::NORMAL)</a>
<a name="ln1813">                        cv-&gt;normalCut();</a>
<a name="ln1814">                  else if (cv-&gt;state == ViewState::EDIT)</a>
<a name="ln1815">                        cv-&gt;editCut();</a>
<a name="ln1816">                  }},</a>
<a name="ln1817">            {{&quot;paste&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1818">                  if (cv-&gt;state == ViewState::NORMAL)</a>
<a name="ln1819">                        cv-&gt;normalPaste();</a>
<a name="ln1820">                  else if (cv-&gt;state == ViewState::EDIT)</a>
<a name="ln1821">                        cv-&gt;editPaste();</a>
<a name="ln1822">                  }},</a>
<a name="ln1823">            {{&quot;paste-half&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1824">                  cv-&gt;normalPaste(Fraction(1, 2));</a>
<a name="ln1825">                  }},</a>
<a name="ln1826">            {{&quot;paste-double&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1827">                  cv-&gt;normalPaste(Fraction(2, 1));</a>
<a name="ln1828">                  }},</a>
<a name="ln1829">            {{&quot;paste-special&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1830">                  Fraction scale = Fraction(1, 1);</a>
<a name="ln1831">                  Fraction duration = cv-&gt;score()-&gt;inputState().duration().fraction();</a>
<a name="ln1832">                  if (duration.isValid() &amp;&amp; !duration.isZero()) {</a>
<a name="ln1833">                        scale = duration * 4;</a>
<a name="ln1834">                        scale.reduce();</a>
<a name="ln1835">                        }</a>
<a name="ln1836">                  cv-&gt;normalPaste(scale);</a>
<a name="ln1837">                  }},</a>
<a name="ln1838">            {{&quot;swap&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1839">                  if (cv-&gt;state == ViewState::NORMAL)</a>
<a name="ln1840">                        cv-&gt;normalSwap();</a>
<a name="ln1841">                  else if (cv-&gt;state == ViewState::EDIT)</a>
<a name="ln1842">                        cv-&gt;editSwap();</a>
<a name="ln1843">                  }},</a>
<a name="ln1844">            {{&quot;lyrics&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1845">                  cv-&gt;score()-&gt;startCmd();</a>
<a name="ln1846">                  Lyrics* lyrics = cv-&gt;score()-&gt;addLyrics();</a>
<a name="ln1847">                  cv-&gt;score()-&gt;endCmd();</a>
<a name="ln1848">                  if (lyrics) {</a>
<a name="ln1849">                        cv-&gt;startEditMode(lyrics);</a>
<a name="ln1850">                        return;</a>
<a name="ln1851">                        }</a>
<a name="ln1852">                  }},</a>
<a name="ln1853">            {{&quot;figured-bass&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1854">                  FiguredBass* fb = cv-&gt;score()-&gt;addFiguredBass();</a>
<a name="ln1855">                  if (fb) {</a>
<a name="ln1856">                        cv-&gt;startEditMode(fb);</a>
<a name="ln1857">                        return;</a>
<a name="ln1858">                        }</a>
<a name="ln1859">                  }},</a>
<a name="ln1860">            {{&quot;mag&quot;}, /*[](ScoreView* cv, const QByteArray&amp;)*/ {</a>
<a name="ln1861">                  // ??</a>
<a name="ln1862">                  }},</a>
<a name="ln1863">            {{&quot;play&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1864">                  if (seq &amp;&amp; seq-&gt;canStart()) {</a>
<a name="ln1865">                        if (cv-&gt;state == ViewState::NORMAL || cv-&gt;state == ViewState::NOTE_ENTRY)</a>
<a name="ln1866">                              cv-&gt;changeState(ViewState::PLAY);</a>
<a name="ln1867">                        else if (cv-&gt;state == ViewState::PLAY)</a>
<a name="ln1868">                              cv-&gt;changeState(ViewState::NORMAL);</a>
<a name="ln1869">                        }</a>
<a name="ln1870">                  else</a>
<a name="ln1871">                        getAction(&quot;play&quot;)-&gt;setChecked(false);</a>
<a name="ln1872">                  }},</a>
<a name="ln1873">            {{&quot;fotomode&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1874">                  if (cv-&gt;state == ViewState::NORMAL)</a>
<a name="ln1875">                        cv-&gt;changeState(ViewState::FOTO);</a>
<a name="ln1876">                  else if (cv-&gt;fotoMode())</a>
<a name="ln1877">                        cv-&gt;changeState(ViewState::NORMAL);</a>
<a name="ln1878">                  }},</a>
<a name="ln1879">            {{&quot;add-slur&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1880">                  cv-&gt;cmdAddSlur();</a>
<a name="ln1881">                  }},</a>
<a name="ln1882">            {{&quot;add-hairpin&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1883">                  cv-&gt;cmdAddHairpin(HairpinType::CRESC_HAIRPIN);</a>
<a name="ln1884">                  }},</a>
<a name="ln1885">            {{&quot;add-hairpin-reverse&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1886">                  cv-&gt;cmdAddHairpin(HairpinType::DECRESC_HAIRPIN);</a>
<a name="ln1887">                  }},</a>
<a name="ln1888">            {{&quot;add-noteline&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1889">                  cv-&gt;cmdAddNoteLine();</a>
<a name="ln1890">                  }},</a>
<a name="ln1891">            {{&quot;chord-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1892">                  cv-&gt;changeState(ViewState::NORMAL);</a>
<a name="ln1893">                  cv-&gt;cmdAddChordName(HarmonyType::STANDARD);</a>
<a name="ln1894">                  }},</a>
<a name="ln1895">            {{&quot;roman-numeral-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1896">                  cv-&gt;changeState(ViewState::NORMAL);</a>
<a name="ln1897">                  cv-&gt;cmdAddChordName(HarmonyType::ROMAN);</a>
<a name="ln1898">                  }},</a>
<a name="ln1899">            {{&quot;nashville-number-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1900">                  cv-&gt;changeState(ViewState::NORMAL);</a>
<a name="ln1901">                  cv-&gt;cmdAddChordName(HarmonyType::NASHVILLE);</a>
<a name="ln1902">                  }},</a>
<a name="ln1903">            {{&quot;title-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1904">                  cv-&gt;cmdAddText(Tid::TITLE);</a>
<a name="ln1905">                  }},</a>
<a name="ln1906">            {{&quot;subtitle-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1907">                  cv-&gt;cmdAddText(Tid::SUBTITLE);</a>
<a name="ln1908">                  }},</a>
<a name="ln1909">            {{&quot;composer-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1910">                  cv-&gt;cmdAddText(Tid::COMPOSER);</a>
<a name="ln1911">                  }},</a>
<a name="ln1912">            {{&quot;poet-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1913">                  cv-&gt;cmdAddText(Tid::POET);</a>
<a name="ln1914">                  }},</a>
<a name="ln1915">            {{&quot;part-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1916">                  cv-&gt;cmdAddText(Tid::INSTRUMENT_EXCERPT);</a>
<a name="ln1917">                  }},</a>
<a name="ln1918">            {{&quot;system-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1919">                  cv-&gt;cmdAddText(Tid::SYSTEM);</a>
<a name="ln1920">                  }},</a>
<a name="ln1921">            {{&quot;staff-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1922">                  cv-&gt;cmdAddText(Tid::STAFF);</a>
<a name="ln1923">                  }},</a>
<a name="ln1924">            {{&quot;expression-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1925">                  cv-&gt;cmdAddText(Tid::EXPRESSION);</a>
<a name="ln1926">                  }},</a>
<a name="ln1927">            {{&quot;rehearsalmark-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1928">                  cv-&gt;cmdAddText(Tid::REHEARSAL_MARK);</a>
<a name="ln1929">                  }},</a>
<a name="ln1930">            {{&quot;instrument-change-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1931">                  cv-&gt;cmdAddText(Tid::INSTRUMENT_CHANGE);</a>
<a name="ln1932">                  }},</a>
<a name="ln1933">            {{&quot;fingering-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1934">                  cv-&gt;cmdAddText(Tid::FINGERING);</a>
<a name="ln1935">                  }},</a>
<a name="ln1936">            {{&quot;sticking-text&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1937">                  cv-&gt;cmdAddText(Tid::STICKING);</a>
<a name="ln1938">                  }},</a>
<a name="ln1939">            {{&quot;edit-element&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1940">                  Element* e = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln1941">                  if (e &amp;&amp; e-&gt;isEditable() &amp;&amp; !cv-&gt;popupActive) {</a>
<a name="ln1942">                        cv-&gt;startEditMode(e);</a>
<a name="ln1943">                        }</a>
<a name="ln1944">                  }},</a>
<a name="ln1945">            {{&quot;select-similar&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1946">                  if (cv-&gt;score()-&gt;selection().isSingle()) {</a>
<a name="ln1947">                        Element* e = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln1948">                        mscore-&gt;selectSimilar(e, false);</a>
<a name="ln1949">                        }</a>
<a name="ln1950">                  }},</a>
<a name="ln1951">            {{&quot;select-similar-staff&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1952">                  if (cv-&gt;score()-&gt;selection().isSingle()) {</a>
<a name="ln1953">                        Element* e = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln1954">                        mscore-&gt;selectSimilar(e, true);</a>
<a name="ln1955">                        }</a>
<a name="ln1956">                  }},</a>
<a name="ln1957">            {{&quot;select-dialog&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1958">                  if (cv-&gt;score()-&gt;selection().isSingle()) {</a>
<a name="ln1959">                        Element* e = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln1960">                        mscore-&gt;selectElementDialog(e);</a>
<a name="ln1961">                        }</a>
<a name="ln1962">                  }},</a>
<a name="ln1963">      //      {{&quot;find&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1964">      //            ; // TODO:state         sm-&gt;postEvent(new CommandEvent(cmd));</a>
<a name="ln1965">      //            }},</a>
<a name="ln1966">            {{&quot;scr-prev&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1967">                  cv-&gt;screenPrev();</a>
<a name="ln1968">                  }},</a>
<a name="ln1969">            {{&quot;scr-next&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1970">                  cv-&gt;screenNext();</a>
<a name="ln1971">                  }},</a>
<a name="ln1972">            {{&quot;page-prev&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1973">                  cv-&gt;pagePrev();</a>
<a name="ln1974">                  }},</a>
<a name="ln1975">            {{&quot;page-next&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1976">                  cv-&gt;pageNext();</a>
<a name="ln1977">                  }},</a>
<a name="ln1978">            {{&quot;page-top&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1979">                  cv-&gt;pageTop();</a>
<a name="ln1980">                  }},</a>
<a name="ln1981">            {{&quot;page-end&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln1982">                  cv-&gt;pageEnd();</a>
<a name="ln1983">                  }},</a>
<a name="ln1984">            {{&quot;select-next-chord&quot;,</a>
<a name="ln1985">              &quot;select-prev-chord&quot;,</a>
<a name="ln1986">              &quot;select-next-measure&quot;,</a>
<a name="ln1987">              &quot;select-prev-measure&quot;,</a>
<a name="ln1988">              &quot;select-begin-line&quot;,</a>
<a name="ln1989">              &quot;select-end-line&quot;,</a>
<a name="ln1990">              &quot;select-begin-score&quot;,</a>
<a name="ln1991">              &quot;select-end-score&quot;,</a>
<a name="ln1992">              &quot;select-staff-above&quot;,</a>
<a name="ln1993">              &quot;select-staff-below&quot;}, [](ScoreView* cv, const QByteArray&amp; cmd) {</a>
<a name="ln1994">                  Element* el = cv-&gt;score()-&gt;selectMove(cmd);</a>
<a name="ln1995">                  if (el)</a>
<a name="ln1996">                        cv-&gt;adjustCanvasPosition(el, false);</a>
<a name="ln1997">                  cv-&gt;score()-&gt;setPlayChord(true);</a>
<a name="ln1998">                  cv-&gt;updateAll();</a>
<a name="ln1999">                  }},</a>
<a name="ln2000">            {{&quot;next-chord&quot;,</a>
<a name="ln2001">              &quot;prev-chord&quot;,</a>
<a name="ln2002">              &quot;next-track&quot;,</a>
<a name="ln2003">              &quot;prev-track&quot;,</a>
<a name="ln2004">              &quot;next-measure&quot;,</a>
<a name="ln2005">              &quot;prev-measure&quot;}, [](ScoreView* cv, const QByteArray&amp; cmd) {</a>
<a name="ln2006">                  Element* el = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln2007">                  if (el &amp;&amp; (el-&gt;isTextBase())) {</a>
<a name="ln2008">                        cv-&gt;score()-&gt;startCmd();</a>
<a name="ln2009">                        const PropertyFlags pf = PropertyFlags::UNSTYLED;</a>
<a name="ln2010">                        if (cmd == &quot;prev-chord&quot;)</a>
<a name="ln2011">                              el-&gt;undoChangeProperty(Pid::OFFSET, el-&gt;offset() - QPointF (MScore::nudgeStep * el-&gt;spatium(), 0.0), pf);</a>
<a name="ln2012">                        else if (cmd == &quot;next-chord&quot;)</a>
<a name="ln2013">                              el-&gt;undoChangeProperty(Pid::OFFSET, el-&gt;offset() + QPointF (MScore::nudgeStep * el-&gt;spatium(), 0.0), pf);</a>
<a name="ln2014">                        else if (cmd == &quot;prev-measure&quot;)</a>
<a name="ln2015">                              el-&gt;undoChangeProperty(Pid::OFFSET, el-&gt;offset() - QPointF (MScore::nudgeStep10 * el-&gt;spatium(), 0.0), pf);</a>
<a name="ln2016">                        else if (cmd == &quot;next-measure&quot;)</a>
<a name="ln2017">                              el-&gt;undoChangeProperty(Pid::OFFSET, el-&gt;offset() + QPointF (MScore::nudgeStep10 * el-&gt;spatium(), 0.0), pf);</a>
<a name="ln2018">                        cv-&gt;score()-&gt;endCmd();</a>
<a name="ln2019">                        }</a>
<a name="ln2020">                  else {</a>
<a name="ln2021">                        Element* ele = cv-&gt;score()-&gt;move(cmd);</a>
<a name="ln2022">                        if (ele)</a>
<a name="ln2023">                              cv-&gt;adjustCanvasPosition(ele, false);</a>
<a name="ln2024">                        cv-&gt;score()-&gt;setPlayChord(true);</a>
<a name="ln2025">                        cv-&gt;updateAll();</a>
<a name="ln2026">                        }</a>
<a name="ln2027">                  }},</a>
<a name="ln2028">            {{&quot;pitch-up-diatonic&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2029">                  cv-&gt;score()-&gt;upDown(true, UpDownMode::DIATONIC);</a>
<a name="ln2030">                  }},</a>
<a name="ln2031">            {{&quot;pitch-down-diatonic&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2032">                  cv-&gt;score()-&gt;upDown(false, UpDownMode::DIATONIC);</a>
<a name="ln2033">                  }},</a>
<a name="ln2034">            {{&quot;move-up&quot;}, [](ScoreView* cv, const QByteArray) {</a>
<a name="ln2035">                  QList&lt;Element*&gt; el = cv-&gt;score()-&gt;selection().uniqueElements();</a>
<a name="ln2036">                  foreach (Element* e, el) {</a>
<a name="ln2037">                        ChordRest* cr = nullptr;</a>
<a name="ln2038">                        if (e-&gt;type() == ElementType::NOTE)</a>
<a name="ln2039">                              cr = static_cast&lt;Note*&gt;(e)-&gt;chord();</a>
<a name="ln2040">                        else if (e-&gt;type() == ElementType::REST)</a>
<a name="ln2041">                              cr = static_cast&lt;Rest*&gt;(e);</a>
<a name="ln2042">                        if (cr)</a>
<a name="ln2043">                              cv-&gt;score()-&gt;moveUp(cr);</a>
<a name="ln2044">                        }</a>
<a name="ln2045">                  }},</a>
<a name="ln2046">            {{&quot;move-down&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2047">                  QList&lt;Element*&gt; el = cv-&gt;score()-&gt;selection().uniqueElements();</a>
<a name="ln2048">                  foreach (Element* e, el) {</a>
<a name="ln2049">                        ChordRest* cr = nullptr;</a>
<a name="ln2050">                        if (e-&gt;type() == ElementType::NOTE)</a>
<a name="ln2051">                              cr = static_cast&lt;Note*&gt;(e)-&gt;chord();</a>
<a name="ln2052">                        else if (e-&gt;type() == ElementType::REST)</a>
<a name="ln2053">                              cr = static_cast&lt;Rest*&gt;(e);</a>
<a name="ln2054">                        if (cr)</a>
<a name="ln2055">                              cv-&gt;score()-&gt;moveDown(cr);</a>
<a name="ln2056">                        }</a>
<a name="ln2057">                  }},</a>
<a name="ln2058">            {{&quot;up-chord&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2059">                  Element* el = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln2060">                  Element* oel = el;</a>
<a name="ln2061">                  if (el &amp;&amp; (el-&gt;isNote() || el-&gt;isRest()))</a>
<a name="ln2062">                        cv-&gt;cmdGotoElement(cv-&gt;score()-&gt;upAlt(el));</a>
<a name="ln2063">                  el = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln2064">                  while (el &amp;&amp; el-&gt;isRest() &amp;&amp; toRest(el)-&gt;isGap()) {</a>
<a name="ln2065">                        if (cv-&gt;score()-&gt;upAlt(el) == el) {</a>
<a name="ln2066">                              cv-&gt;cmdGotoElement(oel);</a>
<a name="ln2067">                              break;</a>
<a name="ln2068">                              }</a>
<a name="ln2069">                        el = cv-&gt;score()-&gt;upAlt(el);</a>
<a name="ln2070">                        cv-&gt;cmdGotoElement(el);</a>
<a name="ln2071">                        }</a>
<a name="ln2072">                  }},</a>
<a name="ln2073">            {{&quot;down-chord&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2074">                  Element* el = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln2075">                  Element* oel = el;</a>
<a name="ln2076">                  if (el &amp;&amp; (el-&gt;isNote() || el-&gt;isRest()))</a>
<a name="ln2077">                        cv-&gt;cmdGotoElement(cv-&gt;score()-&gt;downAlt(el));</a>
<a name="ln2078">                  el = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln2079">                  while (el &amp;&amp; el-&gt;isRest() &amp;&amp; toRest(el)-&gt;isGap()) {</a>
<a name="ln2080">                        if (cv-&gt;score()-&gt;downAlt(el) == el) {</a>
<a name="ln2081">                              cv-&gt;cmdGotoElement(oel);</a>
<a name="ln2082">                              break;</a>
<a name="ln2083">                              }</a>
<a name="ln2084">                        el = cv-&gt;score()-&gt;downAlt(el);</a>
<a name="ln2085">                        cv-&gt;cmdGotoElement(el);</a>
<a name="ln2086">                        }</a>
<a name="ln2087">                  }},</a>
<a name="ln2088">            {{&quot;top-chord&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2089">                  Element* el = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln2090">                  if (el &amp;&amp; el-&gt;type() == ElementType::NOTE)</a>
<a name="ln2091">                        cv-&gt;cmdGotoElement(cv-&gt;score()-&gt;upAltCtrl(static_cast&lt;Note*&gt;(el)));</a>
<a name="ln2092">                  }},</a>
<a name="ln2093">            {{&quot;bottom-chord&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2094">                  Element* el = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln2095">                  if (el &amp;&amp; el-&gt;type() == ElementType::NOTE)</a>
<a name="ln2096">                        cv-&gt;cmdGotoElement(cv-&gt;score()-&gt;downAltCtrl(static_cast&lt;Note*&gt;(el)));</a>
<a name="ln2097">                  }},</a>
<a name="ln2098">            {{&quot;next-segment-element&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2099">                  Element* el = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln2100">                  if (!el &amp;&amp; !cv-&gt;score()-&gt;selection().elements().isEmpty() )</a>
<a name="ln2101">                      el = cv-&gt;score()-&gt;selection().elements().first();</a>
<a name="ln2102"> </a>
<a name="ln2103">                  if (el)</a>
<a name="ln2104">                        cv-&gt;cmdGotoElement(el-&gt;nextSegmentElement());</a>
<a name="ln2105">                  else</a>
<a name="ln2106">                        cv-&gt;cmdGotoElement(cv-&gt;score()-&gt;firstElement());</a>
<a name="ln2107">                  }},</a>
<a name="ln2108">            {{&quot;prev-segment-element&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2109">                  Element* el = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln2110">                  if (!el &amp;&amp; !cv-&gt;score()-&gt;selection().elements().isEmpty())</a>
<a name="ln2111">                      el = cv-&gt;score()-&gt;selection().elements().last();</a>
<a name="ln2112"> </a>
<a name="ln2113">                  if (el)</a>
<a name="ln2114">                        cv-&gt;cmdGotoElement(el-&gt;prevSegmentElement());</a>
<a name="ln2115">                  else</a>
<a name="ln2116">                        cv-&gt;cmdGotoElement(cv-&gt;score()-&gt;lastElement());</a>
<a name="ln2117">                  }},</a>
<a name="ln2118">            {{&quot;next-element&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2119">                  if (cv-&gt;editMode()) {</a>
<a name="ln2120">                        cv-&gt;textTab(false);</a>
<a name="ln2121">                        return;</a>
<a name="ln2122">                        }</a>
<a name="ln2123">                  Element* el = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln2124">                  if (!el &amp;&amp; !cv-&gt;score()-&gt;selection().elements().isEmpty() )</a>
<a name="ln2125">                      el = cv-&gt;score()-&gt;selection().elements().first();</a>
<a name="ln2126">                  if (!el) {</a>
<a name="ln2127">                        ChordRest* cr = cv-&gt;score()-&gt;selection().currentCR();</a>
<a name="ln2128">                        if (cr) {</a>
<a name="ln2129">                              if (cr-&gt;isChord())</a>
<a name="ln2130">                                    el = toChord(cr)-&gt;downNote();</a>
<a name="ln2131">                              else if (cr-&gt;isRest())</a>
<a name="ln2132">                                    el = cr;</a>
<a name="ln2133">                              cv-&gt;score()-&gt;select(el);</a>
<a name="ln2134">                              }</a>
<a name="ln2135">                        }</a>
<a name="ln2136"> </a>
<a name="ln2137">                  if (el)</a>
<a name="ln2138">                        cv-&gt;cmdGotoElement(cv-&gt;score()-&gt;nextElement());</a>
<a name="ln2139">                  else</a>
<a name="ln2140">                        cv-&gt;cmdGotoElement(cv-&gt;score()-&gt;firstElement());</a>
<a name="ln2141">                  }},</a>
<a name="ln2142">            {{&quot;prev-element&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2143">                  if (cv-&gt;editMode()) {</a>
<a name="ln2144">                        cv-&gt;textTab(true);</a>
<a name="ln2145">                        return;</a>
<a name="ln2146">                        }</a>
<a name="ln2147">                  Element* el = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln2148">                  if (!el &amp;&amp; !cv-&gt;score()-&gt;selection().elements().isEmpty())</a>
<a name="ln2149">                      el = cv-&gt;score()-&gt;selection().elements().last();</a>
<a name="ln2150">                  if (!el) {</a>
<a name="ln2151">                        ChordRest* cr = cv-&gt;score()-&gt;selection().currentCR();</a>
<a name="ln2152">                        if (cr) {</a>
<a name="ln2153">                              if (cr-&gt;isChord())</a>
<a name="ln2154">                                    el = toChord(cr)-&gt;upNote();</a>
<a name="ln2155">                              else if (cr-&gt;isRest())</a>
<a name="ln2156">                                    el = cr;</a>
<a name="ln2157">                              cv-&gt;score()-&gt;select(el);</a>
<a name="ln2158">                              }</a>
<a name="ln2159">                        }</a>
<a name="ln2160"> </a>
<a name="ln2161">                  if (el)</a>
<a name="ln2162">                        cv-&gt;cmdGotoElement(cv-&gt;score()-&gt;prevElement());</a>
<a name="ln2163">                  else</a>
<a name="ln2164">                        cv-&gt;cmdGotoElement(cv-&gt;score()-&gt;lastElement());</a>
<a name="ln2165">                  }},</a>
<a name="ln2166">            {{&quot;first-element&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2167">                  cv-&gt;cmdGotoElement(cv-&gt;score()-&gt;firstElement(false));</a>
<a name="ln2168">                  }},</a>
<a name="ln2169">            {{&quot;last-element&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2170">                  cv-&gt;cmdGotoElement(cv-&gt;score()-&gt;lastElement(false));</a>
<a name="ln2171">                  }},</a>
<a name="ln2172">            {{&quot;get-location&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2173">                  // get current selection</a>
<a name="ln2174">                  Element* e = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln2175">                  if (!e) {</a>
<a name="ln2176">                        // no current selection - restore lost selection</a>
<a name="ln2177">                        e = cv-&gt;score()-&gt;selection().currentCR();</a>
<a name="ln2178">                        if (e &amp;&amp; e-&gt;isChord())</a>
<a name="ln2179">                              e = toChord(e)-&gt;upNote();</a>
<a name="ln2180">                        }</a>
<a name="ln2181">                  if (!e) {</a>
<a name="ln2182">                        // no current or last selection - fall back to first element</a>
<a name="ln2183">                        e = cv-&gt;score()-&gt;firstElement(false);</a>
<a name="ln2184">                        }</a>
<a name="ln2185">                  // TODO: find &amp; read current key &amp; time signatures</a>
<a name="ln2186">                  if (e) {</a>
<a name="ln2187">                        ScoreAccessibility::instance()-&gt;clearAccessibilityInfo();</a>
<a name="ln2188">                        cv-&gt;cmdGotoElement(e);</a>
<a name="ln2189">                        }</a>
<a name="ln2190">                  }},</a>
<a name="ln2191">            {{&quot;rest&quot;, &quot;rest-TAB&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2192">                  cv-&gt;cmdEnterRest();</a>
<a name="ln2193">                  }},</a>
<a name="ln2194">            {{&quot;rest-1&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2195">                  cv-&gt;cmdEnterRest(TDuration(TDuration::DurationType::V_WHOLE));</a>
<a name="ln2196">                  }},</a>
<a name="ln2197">            {{&quot;rest-2&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2198">                  cv-&gt;cmdEnterRest(TDuration(TDuration::DurationType::V_HALF));</a>
<a name="ln2199">                  }},</a>
<a name="ln2200">            {{&quot;rest-4&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2201">                  cv-&gt;cmdEnterRest(TDuration(TDuration::DurationType::V_QUARTER));</a>
<a name="ln2202">                  }},</a>
<a name="ln2203">            {{&quot;rest-8&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2204">                  cv-&gt;cmdEnterRest(TDuration(TDuration::DurationType::V_EIGHTH));</a>
<a name="ln2205">                  }},</a>
<a name="ln2206">            {{&quot;interval1&quot;,</a>
<a name="ln2207">              &quot;interval2&quot;, &quot;interval-2&quot;,</a>
<a name="ln2208">              &quot;interval3&quot;, &quot;interval-3&quot;,</a>
<a name="ln2209">              &quot;interval4&quot;, &quot;interval-4&quot;,</a>
<a name="ln2210">              &quot;interval5&quot;, &quot;interval-5&quot;,</a>
<a name="ln2211">              &quot;interval6&quot;, &quot;interval-6&quot;,</a>
<a name="ln2212">              &quot;interval7&quot;, &quot;interval-7&quot;,</a>
<a name="ln2213">              &quot;interval8&quot;, &quot;interval-8&quot;,</a>
<a name="ln2214">              &quot;interval9&quot;, &quot;interval-9&quot;}, [](ScoreView* cv, const QByteArray&amp; cmd) {</a>
<a name="ln2215">                  int n = cmd.mid(8).toInt();</a>
<a name="ln2216">                  std::vector&lt;Note*&gt; nl = cv-&gt;score()-&gt;selection().noteList();</a>
<a name="ln2217">                  if (!nl.empty()) {</a>
<a name="ln2218">                        //if (!noteEntryMode())</a>
<a name="ln2219">                        //      ;     // TODO: state    sm-&gt;postEvent(new CommandEvent(&quot;note-input&quot;));</a>
<a name="ln2220">                        cv-&gt;score()-&gt;cmdAddInterval(n, nl);</a>
<a name="ln2221">                        }</a>
<a name="ln2222">                  }},</a>
<a name="ln2223">            {{&quot;tie&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2224">                  if (cv-&gt;noteEntryMode()) {</a>
<a name="ln2225">                        cv-&gt;score()-&gt;cmdAddTie();</a>
<a name="ln2226">                        cv-&gt;moveCursor();</a>
<a name="ln2227">                        }</a>
<a name="ln2228">                  else</a>
<a name="ln2229">                        cv-&gt;score()-&gt;cmdToggleTie();</a>
<a name="ln2230">                  }},</a>
<a name="ln2231">            {{&quot;chord-tie&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2232">                  cv-&gt;score()-&gt;cmdAddTie(true);</a>
<a name="ln2233">                  cv-&gt;moveCursor();</a>
<a name="ln2234">                  }},</a>
<a name="ln2235">            {{&quot;duplet&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2236">                  cv-&gt;cmdTuplet(2);</a>
<a name="ln2237">                  }},</a>
<a name="ln2238">            {{&quot;triplet&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2239">                  cv-&gt;cmdTuplet(3);</a>
<a name="ln2240">                  }},</a>
<a name="ln2241">            {{&quot;quadruplet&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2242">                  cv-&gt;cmdTuplet(4);</a>
<a name="ln2243">                  }},</a>
<a name="ln2244">            {{&quot;quintuplet&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2245">                  cv-&gt;cmdTuplet(5);</a>
<a name="ln2246">                  }},</a>
<a name="ln2247">            {{&quot;sextuplet&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2248">                  cv-&gt;cmdTuplet(6);</a>
<a name="ln2249">                  }},</a>
<a name="ln2250">            {{&quot;septuplet&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2251">                  cv-&gt;cmdTuplet(7);</a>
<a name="ln2252">                  }},</a>
<a name="ln2253">            {{&quot;octuplet&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2254">                  cv-&gt;cmdTuplet(8);</a>
<a name="ln2255">                  }},</a>
<a name="ln2256">            {{&quot;nonuplet&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2257">                  cv-&gt;cmdTuplet(9);</a>
<a name="ln2258">                  }},</a>
<a name="ln2259">            {{&quot;tuplet-dialog&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2260">                  cv-&gt;score()-&gt;startCmd();</a>
<a name="ln2261">                  Tuplet* tuplet = mscore-&gt;tupletDialog();</a>
<a name="ln2262">                  if (tuplet)</a>
<a name="ln2263">                        cv-&gt;cmdCreateTuplet(cv-&gt;score()-&gt;getSelectedChordRest(), tuplet);</a>
<a name="ln2264">                  cv-&gt;score()-&gt;endCmd();</a>
<a name="ln2265">                  cv-&gt;moveCursor();</a>
<a name="ln2266">                  }},</a>
<a name="ln2267">            {{&quot;repeat-sel&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2268">                  cv-&gt;cmdRepeatSelection();</a>
<a name="ln2269">                  }},</a>
<a name="ln2270">            {{&quot;voice-1&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2271">                  cv-&gt;changeVoice(0);</a>
<a name="ln2272">                  }},</a>
<a name="ln2273">            {{&quot;voice-2&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2274">                  cv-&gt;changeVoice(1);</a>
<a name="ln2275">                  }},</a>
<a name="ln2276">            {{&quot;voice-3&quot;}, [](ScoreView* cv, const QByteArray) {</a>
<a name="ln2277">                  cv-&gt;changeVoice(2);</a>
<a name="ln2278">                  }},</a>
<a name="ln2279">            {{&quot;voice-4&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2280">                  cv-&gt;changeVoice(3);</a>
<a name="ln2281">                  }},</a>
<a name="ln2282">            {{&quot;enh-both&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2283">                  cv-&gt;cmdChangeEnharmonic(true);</a>
<a name="ln2284">                  }},</a>
<a name="ln2285">            {{&quot;enh-current&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2286">                  cv-&gt;cmdChangeEnharmonic(false);</a>
<a name="ln2287">                  }},</a>
<a name="ln2288">            {{&quot;revision&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2289">                  Score* sc = cv-&gt;score()-&gt;masterScore();</a>
<a name="ln2290">                  sc-&gt;createRevision();</a>
<a name="ln2291">                  }},</a>
<a name="ln2292">            {{&quot;append-measure&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2293">                  cv-&gt;cmdAppendMeasures(1, ElementType::MEASURE);</a>
<a name="ln2294">                  }},</a>
<a name="ln2295">            {{&quot;insert-measure&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2296">                cv-&gt;cmdInsertMeasures(1, ElementType::MEASURE);</a>
<a name="ln2297">                }},</a>
<a name="ln2298">            {{&quot;insert-hbox&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2299">                cv-&gt;cmdInsertMeasures(1, ElementType::HBOX);</a>
<a name="ln2300">                }},</a>
<a name="ln2301">            {{&quot;insert-vbox&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2302">                cv-&gt;cmdInsertMeasures(1, ElementType::VBOX);</a>
<a name="ln2303">                }},</a>
<a name="ln2304">            {{&quot;append-hbox&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2305">                MeasureBase* mb = cv-&gt;appendMeasure(ElementType::HBOX);</a>
<a name="ln2306">                  cv-&gt;score()-&gt;select(mb, SelectType::SINGLE, 0);</a>
<a name="ln2307">                  }},</a>
<a name="ln2308">            {{&quot;append-vbox&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2309">                MeasureBase* mb = cv-&gt;appendMeasure(ElementType::VBOX);</a>
<a name="ln2310">                  cv-&gt;score()-&gt;select(mb, SelectType::SINGLE, 0);</a>
<a name="ln2311">                  }},</a>
<a name="ln2312">            {{&quot;insert-textframe&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2313">                  cv-&gt;cmdInsertMeasure(ElementType::TBOX);</a>
<a name="ln2314">                  }},</a>
<a name="ln2315">            {{&quot;append-textframe&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2316">                  MeasureBase* mb = cv-&gt;appendMeasure(ElementType::TBOX);</a>
<a name="ln2317">                  if (mb) {</a>
<a name="ln2318">                        TBox* tf = static_cast&lt;TBox*&gt;(mb);</a>
<a name="ln2319">                        Text* text = 0;</a>
<a name="ln2320">                        foreach(Element* e, tf-&gt;el()) {</a>
<a name="ln2321">                              if (e-&gt;type() == ElementType::TEXT) {</a>
<a name="ln2322">                                    text = static_cast&lt;Text*&gt;(e);</a>
<a name="ln2323">                                    break;</a>
<a name="ln2324">                                    }</a>
<a name="ln2325">                              }</a>
<a name="ln2326">                        if (text) {</a>
<a name="ln2327">                              cv-&gt;score()-&gt;select(text, SelectType::SINGLE, 0);</a>
<a name="ln2328">                              cv-&gt;startEditMode(text);</a>
<a name="ln2329">                              }</a>
<a name="ln2330">                        }</a>
<a name="ln2331">                  }},</a>
<a name="ln2332">            {{&quot;insert-fretframe&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2333">                  if (!enableExperimental)</a>
<a name="ln2334">                        return;</a>
<a name="ln2335">                  cv-&gt;cmdInsertMeasure(ElementType::FBOX);</a>
<a name="ln2336">                  }},</a>
<a name="ln2337">            {{&quot;move-left&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2338">                  cv-&gt;cmdMoveCR(true);</a>
<a name="ln2339">                  }},</a>
<a name="ln2340">            {{&quot;move-right&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2341">                  cv-&gt;cmdMoveCR(false);</a>
<a name="ln2342">                  }},</a>
<a name="ln2343">            {{&quot;reset&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2344">                  if (cv-&gt;editMode()) {</a>
<a name="ln2345">                        cv-&gt;editData.element-&gt;reset();</a>
<a name="ln2346">                        cv-&gt;score()-&gt;update();</a>
<a name="ln2347">                        }</a>
<a name="ln2348">                  else {</a>
<a name="ln2349">                        cv-&gt;score()-&gt;startCmd();</a>
<a name="ln2350">                        for (Element* e : cv-&gt;score()-&gt;selection().elements()) {</a>
<a name="ln2351">                              e-&gt;reset();</a>
<a name="ln2352">                              if (e-&gt;isSpanner()) {</a>
<a name="ln2353">                                    Spanner* sp = toSpanner(e);</a>
<a name="ln2354">                                    for (SpannerSegment* ss : sp-&gt;spannerSegments())</a>
<a name="ln2355">                                          ss-&gt;reset();</a>
<a name="ln2356">                                    }</a>
<a name="ln2357">                              }</a>
<a name="ln2358">                        cv-&gt;score()-&gt;endCmd();</a>
<a name="ln2359">                        }</a>
<a name="ln2360">                  cv-&gt;updateGrips();</a>
<a name="ln2361">                  }},</a>
<a name="ln2362">      #ifdef OMR</a>
<a name="ln2363">            {{&quot;show-omr&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2364">                  if (cv-&gt;score()-&gt;masterScore()-&gt;omr())</a>
<a name="ln2365">                        showOmr(!_score-&gt;masterScore()-&gt;showOmr());</a>
<a name="ln2366">                  }},</a>
<a name="ln2367">      #endif</a>
<a name="ln2368">            {{&quot;split-measure&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2369">                  Element* e = cv-&gt;score()-&gt;selection().element();</a>
<a name="ln2370">                  if (!(e &amp;&amp; (e-&gt;isNote() || e-&gt;isRest())))</a>
<a name="ln2371">                        MScore::setError(NO_CHORD_REST_SELECTED);</a>
<a name="ln2372">                  else {</a>
<a name="ln2373">                        if (e-&gt;isNote())</a>
<a name="ln2374">                              e = toNote(e)-&gt;chord();</a>
<a name="ln2375">                        ChordRest* cr = toChordRest(e);</a>
<a name="ln2376">                        cv-&gt;score()-&gt;cmdSplitMeasure(cr);</a>
<a name="ln2377">                        }</a>
<a name="ln2378">                  }},</a>
<a name="ln2379">            {{&quot;join-measures&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2380">                  Measure* m1;</a>
<a name="ln2381">                  Measure* m2;</a>
<a name="ln2382">                  if (!cv-&gt;score()-&gt;selection().measureRange(&amp;m1, &amp;m2) || m1 == m2) {</a>
<a name="ln2383">                        QMessageBox::warning(0, &quot;MuseScore&quot;,</a>
<a name="ln2384">                           tr(&quot;No measures selected:\n&quot;</a>
<a name="ln2385">                           &quot;Please select a range of measures to join and try again&quot;));</a>
<a name="ln2386">                        }</a>
<a name="ln2387">                  else {</a>
<a name="ln2388">                        cv-&gt;score()-&gt;cmdJoinMeasure(m1, m2);</a>
<a name="ln2389">                        }</a>
<a name="ln2390">                  }},</a>
<a name="ln2391">            {{&quot;next-lyric&quot;, &quot;prev-lyric&quot;}, [](ScoreView* cv, const QByteArray&amp; cmd) {</a>
<a name="ln2392">                  cv-&gt;editCmd(cmd);</a>
<a name="ln2393">                  }},</a>
<a name="ln2394">            {{&quot;add-remove-breaks&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2395">                  cv-&gt;cmdAddRemoveBreaks();</a>
<a name="ln2396">                  }},</a>
<a name="ln2397">            {{&quot;copy-lyrics-to-clipboard&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2398">                  cv-&gt;cmdCopyLyricsToClipboard();</a>
<a name="ln2399">                  }},</a>
<a name="ln2400"> </a>
<a name="ln2401">            // STATE_NOTE_ENTRY_REALTIME actions (auto or manual)</a>
<a name="ln2402"> </a>
<a name="ln2403">            {{&quot;realtime-advance&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2404">                  cv-&gt;realtimeAdvance(true);</a>
<a name="ln2405">                  }},</a>
<a name="ln2406"> </a>
<a name="ln2407">            // STATE_HARMONY_FIGBASS_EDIT actions</a>
<a name="ln2408"> </a>
<a name="ln2409">            {{&quot;advance-longa&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2410">                  cv-&gt;ticksTab(Fraction(4,1));</a>
<a name="ln2411">                  }},</a>
<a name="ln2412">            {{&quot;advance-breve&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2413">                  cv-&gt;ticksTab(Fraction(2,1));</a>
<a name="ln2414">                  }},</a>
<a name="ln2415">            {{&quot;advance-1&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2416">                  cv-&gt;ticksTab(Fraction(1,1));</a>
<a name="ln2417">                  }},</a>
<a name="ln2418">            {{&quot;advance-2&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2419">                  cv-&gt;ticksTab(Fraction(1,2));</a>
<a name="ln2420">                  }},</a>
<a name="ln2421">            {{&quot;advance-4&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2422">                  cv-&gt;ticksTab(Fraction(1,4));</a>
<a name="ln2423">                  }},</a>
<a name="ln2424">            {{&quot;advance-8&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2425">                  cv-&gt;ticksTab(Fraction(1,8));</a>
<a name="ln2426">                  }},</a>
<a name="ln2427">            {{&quot;advance-16&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2428">                  cv-&gt;ticksTab(Fraction(1,16));</a>
<a name="ln2429">                  }},</a>
<a name="ln2430">            {{&quot;advance-32&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2431">                  cv-&gt;ticksTab(Fraction(1,32));</a>
<a name="ln2432">                  }},</a>
<a name="ln2433">            {{&quot;advance-64&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2434">                  cv-&gt;ticksTab(Fraction(1,64));</a>
<a name="ln2435">                  }},</a>
<a name="ln2436">            {{&quot;prev-measure-TEXT&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2437">                  if (cv-&gt;editData.element-&gt;isHarmony())</a>
<a name="ln2438">                        cv-&gt;harmonyTab(true);</a>
<a name="ln2439">                  else if (cv-&gt;editData.element-&gt;isFiguredBass())</a>
<a name="ln2440">                        cv-&gt;figuredBassTab(true, true);</a>
<a name="ln2441">                  }},</a>
<a name="ln2442">            {{&quot;next-measure-TEXT&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2443">                  if (cv-&gt;editData.element-&gt;isHarmony())</a>
<a name="ln2444">                        cv-&gt;harmonyTab(false);</a>
<a name="ln2445">                  else if (cv-&gt;editData.element-&gt;isFiguredBass())</a>
<a name="ln2446">                        cv-&gt;figuredBassTab(true, false);</a>
<a name="ln2447">                  }},</a>
<a name="ln2448">            {{&quot;prev-beat-TEXT&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2449">                  if (cv-&gt;editData.element-&gt;isHarmony())</a>
<a name="ln2450">                        cv-&gt;harmonyBeatsTab(false, true);</a>
<a name="ln2451">                  }},</a>
<a name="ln2452">            {{&quot;next-beat-TEXT&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2453">                  if (cv-&gt;editData.element-&gt;isHarmony())</a>
<a name="ln2454">                        cv-&gt;harmonyBeatsTab(false, false);</a>
<a name="ln2455">                  }},</a>
<a name="ln2456"> </a>
<a name="ln2457">            // STATE_NOTE_ENTRY_TAB actions</a>
<a name="ln2458"> </a>
<a name="ln2459">            // move input state string up or down, within the number of strings of the instrument;</a>
<a name="ln2460">            // this may move the input state cursor outside of the tab line range to accommodate</a>
<a name="ln2461">            // instrument strings not represented in the tab (e.g.: lute bass strings):</a>
<a name="ln2462">            // the appropriate visual rendition of the input cursor in those cases will be managed by moveCursor()</a>
<a name="ln2463">            {{&quot;string-above&quot;,</a>
<a name="ln2464">              &quot;string-below&quot;}, [](ScoreView* cv, const QByteArray&amp; cmd) {</a>
<a name="ln2465">                  InputState&amp; is          = cv-&gt;score()-&gt;inputState();</a>
<a name="ln2466">                  Staff*      staff       = cv-&gt;score()-&gt;staff(is.track() / VOICES);</a>
<a name="ln2467">                  int         instrStrgs  = staff-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;strings();</a>
<a name="ln2468">                  // assume &quot;string-below&quot;: if tab is upside-down, 'below' means toward instrument top (-1)</a>
<a name="ln2469">                  // if not, 'below' means toward instrument bottom (+1)</a>
<a name="ln2470">                  int         delta       = (staff-&gt;staffType(is.tick())-&gt;upsideDown() ? -1 : +1);</a>
<a name="ln2471">                  if (cmd == &quot;string-above&quot;)                      // if &quot;above&quot;, reverse delta</a>
<a name="ln2472">                        delta = -delta;</a>
<a name="ln2473">                  int         strg        = is.string() + delta;  // dest. physical string</a>
<a name="ln2474">                  if (strg &gt;= 0 &amp;&amp; strg &lt; instrStrgs) {            // if dest. string within instrument limits</a>
<a name="ln2475">                        is.setString(strg);                       // update status</a>
<a name="ln2476">                        cv-&gt;moveCursor();</a>
<a name="ln2477">                        }</a>
<a name="ln2478">                  }},</a>
<a name="ln2479">            {{&quot;text-word-left&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2480">                  toTextBase(cv-&gt;editData.element)-&gt;movePosition(cv-&gt;editData, QTextCursor::WordLeft);</a>
<a name="ln2481">                  }},</a>
<a name="ln2482">            {{&quot;text-word-right&quot;}, [](ScoreView* cv, const QByteArray&amp;) {</a>
<a name="ln2483">                  toTextBase(cv-&gt;editData.element)-&gt;movePosition(cv-&gt;editData, QTextCursor::NextWord);</a>
<a name="ln2484">                  }},</a>
<a name="ln2485">            {{&quot;concert-pitch&quot;}, [](ScoreView* cv, const QByteArray&amp; cmd) {</a>
<a name="ln2486">                  QAction* a = getAction(cmd);</a>
<a name="ln2487">                  if (cv-&gt;score()-&gt;styleB(Sid::concertPitch) != a-&gt;isChecked()) {</a>
<a name="ln2488">                        cv-&gt;score()-&gt;startCmd();</a>
<a name="ln2489">                        cv-&gt;score()-&gt;cmdConcertPitchChanged(a-&gt;isChecked(), true);</a>
<a name="ln2490">                        cv-&gt;score()-&gt;endCmd();</a>
<a name="ln2491">                        }</a>
<a name="ln2492">                  }},</a>
<a name="ln2493">            };</a>
<a name="ln2494"> </a>
<a name="ln2495">      auto c = std::find_if(cmdList.begin(), cmdList.end(), [cmd](const ScoreViewCmd&amp; cc) {</a>
<a name="ln2496">            for (auto&amp; name : cc.commands) {</a>
<a name="ln2497">                  if (cmd == name)</a>
<a name="ln2498">                        return true;</a>
<a name="ln2499">                  }</a>
<a name="ln2500">            return false;</a>
<a name="ln2501">            });</a>
<a name="ln2502"> </a>
<a name="ln2503">      if (c != cmdList.end()) {</a>
<a name="ln2504">            c-&gt;exec(this, cmd);</a>
<a name="ln2505">            }</a>
<a name="ln2506">      else {</a>
<a name="ln2507">            editData.view = this;</a>
<a name="ln2508">            QAction* a = getAction(cmd);</a>
<a name="ln2509">            _score-&gt;cmd(a, editData);</a>
<a name="ln2510">            }</a>
<a name="ln2511">      if (_score-&gt;processMidiInput())</a>
<a name="ln2512">            mscore-&gt;endCmd();</a>
<a name="ln2513">      }</a>
<a name="ln2514"> </a>
<a name="ln2515">//---------------------------------------------------------</a>
<a name="ln2516">//   textTab</a>
<a name="ln2517">//---------------------------------------------------------</a>
<a name="ln2518"> </a>
<a name="ln2519">void ScoreView::textTab(bool back)</a>
<a name="ln2520">      {</a>
<a name="ln2521">      if (!editMode())</a>
<a name="ln2522">            return;</a>
<a name="ln2523">      Element* oe = editData.element;</a>
<a name="ln2524">      if (!oe || !oe-&gt;isTextBase())</a>
<a name="ln2525">            return;</a>
<a name="ln2526"> </a>
<a name="ln2527">      if (oe-&gt;isHarmony()) {</a>
<a name="ln2528">            harmonyBeatsTab(true, back);</a>
<a name="ln2529">            return;</a>
<a name="ln2530">            }</a>
<a name="ln2531">      else if (oe-&gt;isFiguredBass()) {</a>
<a name="ln2532">            figuredBassTab(false, back);</a>
<a name="ln2533">            return;</a>
<a name="ln2534">            }</a>
<a name="ln2535">      else if (oe-&gt;isLyrics()) {</a>
<a name="ln2536">            // not actually hit, left/right handled elsewhere</a>
<a name="ln2537">            lyricsTab(back, false, true);</a>
<a name="ln2538">            return;</a>
<a name="ln2539">            }</a>
<a name="ln2540"> </a>
<a name="ln2541">      Element* op = oe-&gt;parent();</a>
<a name="ln2542">      if (!(op-&gt;isSegment() || op-&gt;isNote()))</a>
<a name="ln2543">            return;</a>
<a name="ln2544"> </a>
<a name="ln2545">      TextBase* ot = toTextBase(oe);</a>
<a name="ln2546">      Tid defaultTid = Tid(ot-&gt;propertyDefault(Pid::SUB_STYLE).toInt());</a>
<a name="ln2547">      Tid tid = ot-&gt;tid();</a>
<a name="ln2548">      ElementType type = ot-&gt;type();</a>
<a name="ln2549">      int staffIdx = ot-&gt;staffIdx();</a>
<a name="ln2550"> </a>
<a name="ln2551">      // get prev/next element now, as current element may be deleted if empty</a>
<a name="ln2552">      Element* el = back ? score()-&gt;prevElement() : score()-&gt;nextElement();</a>
<a name="ln2553">      // end edit mode</a>
<a name="ln2554">      changeState(ViewState::NORMAL);</a>
<a name="ln2555"> </a>
<a name="ln2556">      // find new note to add text to</a>
<a name="ln2557">      bool here = false;      // prevent infinite loop (relevant if navigation is allowed to wrap around end of score)</a>
<a name="ln2558">      while (el) {</a>
<a name="ln2559">            if (el-&gt;isNote()) {</a>
<a name="ln2560">                  Note* n = toNote(el);</a>
<a name="ln2561">                  if (op-&gt;isNote() &amp;&amp; n != op)</a>
<a name="ln2562">                        break;</a>
<a name="ln2563">                  else if (op-&gt;isSegment() &amp;&amp; n-&gt;chord()-&gt;segment() != op)</a>
<a name="ln2564">                        break;</a>
<a name="ln2565">                  else if (here)</a>
<a name="ln2566">                        break;</a>
<a name="ln2567">                  here = true;</a>
<a name="ln2568">                  }</a>
<a name="ln2569">            else if (el-&gt;isRest() &amp;&amp; op-&gt;isSegment()) {</a>
<a name="ln2570">                  // skip rests, but still check for infinite loop</a>
<a name="ln2571">                  Rest* r = toRest(el);</a>
<a name="ln2572">                  if (r-&gt;segment() != op)</a>
<a name="ln2573">                        ;</a>
<a name="ln2574">                  else if (here)</a>
<a name="ln2575">                        break;</a>
<a name="ln2576">                  here = true;</a>
<a name="ln2577">                  }</a>
<a name="ln2578">            // get prev/next note</a>
<a name="ln2579">            score()-&gt;select(el);</a>
<a name="ln2580">            Element* el2 = back ? score()-&gt;prevElement() : score()-&gt;nextElement();</a>
<a name="ln2581">            // start/end of score reached</a>
<a name="ln2582">            if (el2 == el)</a>
<a name="ln2583">                  break;</a>
<a name="ln2584">            el = el2;</a>
<a name="ln2585">            }</a>
<a name="ln2586">      if (!el || !el-&gt;isNote()) {</a>
<a name="ln2587">            // nothing found, exit cleanly</a>
<a name="ln2588">            if (op-&gt;selectable())</a>
<a name="ln2589">                  score()-&gt;select(op);</a>
<a name="ln2590">            else</a>
<a name="ln2591">                  score()-&gt;deselectAll();</a>
<a name="ln2592">            return;</a>
<a name="ln2593">            }</a>
<a name="ln2594">      Note* nn = toNote(el);</a>
<a name="ln2595"> </a>
<a name="ln2596">      // go to note</a>
<a name="ln2597">      cmdGotoElement(nn);</a>
<a name="ln2598"> </a>
<a name="ln2599">      // get existing text to edit</a>
<a name="ln2600">      el = nullptr;</a>
<a name="ln2601">      if (op-&gt;isNote()) {</a>
<a name="ln2602">            // check element list of new note</a>
<a name="ln2603">            for (Element* e : nn-&gt;el()) {</a>
<a name="ln2604">                  if (e-&gt;type() != type)</a>
<a name="ln2605">                        continue;</a>
<a name="ln2606">                  TextBase* nt = toTextBase(e);</a>
<a name="ln2607">                  if (nt-&gt;tid() == tid) {</a>
<a name="ln2608">                        el = e;</a>
<a name="ln2609">                        break;</a>
<a name="ln2610">                        }</a>
<a name="ln2611">                  }</a>
<a name="ln2612">            }</a>
<a name="ln2613">      else if (op-&gt;isSegment()) {</a>
<a name="ln2614">            // check annotation list of new segment</a>
<a name="ln2615">            Segment* ns = nn-&gt;chord()-&gt;segment();</a>
<a name="ln2616">            for (Element* e : ns-&gt;annotations()) {</a>
<a name="ln2617">                  if (e-&gt;staffIdx() != staffIdx || e-&gt;type() != type)</a>
<a name="ln2618">                        continue;</a>
<a name="ln2619">                  TextBase* nt = toTextBase(e);</a>
<a name="ln2620">                  if (nt-&gt;tid() == tid) {</a>
<a name="ln2621">                        el = e;</a>
<a name="ln2622">                        break;</a>
<a name="ln2623">                        }</a>
<a name="ln2624">                  }</a>
<a name="ln2625">            }</a>
<a name="ln2626"> </a>
<a name="ln2627">      if (el) {</a>
<a name="ln2628">            // edit existing text</a>
<a name="ln2629">            score()-&gt;select(el);</a>
<a name="ln2630">            startEditMode(el);</a>
<a name="ln2631">            }</a>
<a name="ln2632">      else {</a>
<a name="ln2633">            // add new text if no existing element to edit</a>
<a name="ln2634">            // TODO: for tempo text, mscore-&gt;addTempo() could be called</a>
<a name="ln2635">            // but it pre-fills the text</a>
<a name="ln2636">            // would be better to create empty tempo element</a>
<a name="ln2637">            if (type != ElementType::TEMPO_TEXT)</a>
<a name="ln2638">                  cmdAddText(defaultTid, tid);</a>
<a name="ln2639">            }</a>
<a name="ln2640">      }</a>
<a name="ln2641"> </a>
<a name="ln2642">//---------------------------------------------------------</a>
<a name="ln2643">//   editKeySticking</a>
<a name="ln2644">//---------------------------------------------------------</a>
<a name="ln2645"> </a>
<a name="ln2646">bool ScoreView::editKeySticking()</a>
<a name="ln2647">      {</a>
<a name="ln2648">      Q_ASSERT(editData.element-&gt;isSticking());</a>
<a name="ln2649"> </a>
<a name="ln2650">      switch (editData.key) {</a>
<a name="ln2651">            case Qt::Key_Space:</a>
<a name="ln2652">                  textTab(editData.modifiers &amp; Qt::ShiftModifier);</a>
<a name="ln2653">                  return true;</a>
<a name="ln2654">            case Qt::Key_Left:</a>
<a name="ln2655">                  textTab(true);</a>
<a name="ln2656">                  return true;</a>
<a name="ln2657">            case Qt::Key_Right:</a>
<a name="ln2658">            case Qt::Key_Return:</a>
<a name="ln2659">                  textTab(false);</a>
<a name="ln2660">                  return true;</a>
<a name="ln2661">            default:</a>
<a name="ln2662">                  break;</a>
<a name="ln2663">            }</a>
<a name="ln2664"> </a>
<a name="ln2665">      return false;</a>
<a name="ln2666">      }</a>
<a name="ln2667"> </a>
<a name="ln2668">//---------------------------------------------------------</a>
<a name="ln2669">//   showOmr</a>
<a name="ln2670">//---------------------------------------------------------</a>
<a name="ln2671"> </a>
<a name="ln2672">void ScoreView::showOmr(bool flag)</a>
<a name="ln2673">      {</a>
<a name="ln2674">      _score-&gt;masterScore()-&gt;setShowOmr(flag);</a>
<a name="ln2675">      ScoreTab* t = mscore-&gt;getTab1();</a>
<a name="ln2676">      if (t-&gt;view() != this)</a>
<a name="ln2677">            t = mscore-&gt;getTab2();</a>
<a name="ln2678">      if (t-&gt;view() == this)</a>
<a name="ln2679">            t-&gt;setCurrentIndex(t-&gt;currentIndex());</a>
<a name="ln2680">      else</a>
<a name="ln2681">            qDebug(&quot;view not found&quot;);</a>
<a name="ln2682">      }</a>
<a name="ln2683"> </a>
<a name="ln2684">//---------------------------------------------------------</a>
<a name="ln2685">//   startNoteEntry</a>
<a name="ln2686">//---------------------------------------------------------</a>
<a name="ln2687"> </a>
<a name="ln2688">void ScoreView::startNoteEntry()</a>
<a name="ln2689">      {</a>
<a name="ln2690">      InputState&amp; is = _score-&gt;inputState();</a>
<a name="ln2691"> </a>
<a name="ln2692">      is.setSegment(0);</a>
<a name="ln2693">      Note* note  = 0;</a>
<a name="ln2694"> </a>
<a name="ln2695">      if (_score-&gt;selection().isNone()) {</a>
<a name="ln2696">            // no selection</a>
<a name="ln2697">            // choose page in current view (favor top left quadrant if possible)</a>
<a name="ln2698">            // select first (top/left) chordrest of that page in current view</a>
<a name="ln2699">            // or, CR at last selected position if that is in view</a>
<a name="ln2700">            Page* p = nullptr;</a>
<a name="ln2701">            QList&lt;QPointF&gt; points;</a>
<a name="ln2702">            points.append(toLogical(QPoint(width() * 0.25, height() * 0.25)));</a>
<a name="ln2703">            points.append(toLogical(QPoint(0.0, 0.0)));</a>
<a name="ln2704">            points.append(toLogical(QPoint(0.0, height())));</a>
<a name="ln2705">            points.append(toLogical(QPoint(width(), 0.0)));</a>
<a name="ln2706">            points.append(toLogical(QPoint(width(), height())));</a>
<a name="ln2707">            int i = 0;</a>
<a name="ln2708">            while (!p &amp;&amp; i &lt; points.size()) {</a>
<a name="ln2709">                  p = point2page(points[i]);</a>
<a name="ln2710">                  i++;</a>
<a name="ln2711">                  }</a>
<a name="ln2712">            if (p) {</a>
<a name="ln2713">                  ChordRest* topLeft = nullptr;</a>
<a name="ln2714">                  qreal tlY = 0.0;</a>
<a name="ln2715">                  Fraction tlTick = Fraction(0,1);</a>
<a name="ln2716">                  QRectF viewRect  = toLogical(QRectF(0.0, 0.0, width(), height()));</a>
<a name="ln2717">                  QRectF pageRect  = p-&gt;bbox().translated(p-&gt;x(), p-&gt;y());</a>
<a name="ln2718">                  QRectF intersect = viewRect &amp; pageRect;</a>
<a name="ln2719">                  intersect.translate(-p-&gt;x(), -p-&gt;y());</a>
<a name="ln2720">                  QList&lt;Element*&gt; el = p-&gt;items(intersect);</a>
<a name="ln2721">                  ChordRest* lastSelected = score()-&gt;selection().currentCR();</a>
<a name="ln2722">                  for (Element* e : el) {</a>
<a name="ln2723">                        // loop through visible elements</a>
<a name="ln2724">                        // looking for the CR in voice 1 with earliest tick and highest staff position</a>
<a name="ln2725">                        // but stop we find the last selected CR</a>
<a name="ln2726">                        ElementType et = e-&gt;type();</a>
<a name="ln2727">                        if (et == ElementType::NOTE || et == ElementType::REST) {</a>
<a name="ln2728">                              if (e-&gt;voice())</a>
<a name="ln2729">                                    continue;</a>
<a name="ln2730">                              ChordRest* cr;</a>
<a name="ln2731">                              if (et == ElementType::NOTE) {</a>
<a name="ln2732">                                    cr = static_cast&lt;ChordRest*&gt;(e-&gt;parent());</a>
<a name="ln2733">                                    if (!cr)</a>
<a name="ln2734">                                          continue;</a>
<a name="ln2735">                                    }</a>
<a name="ln2736">                              else {</a>
<a name="ln2737">                                    cr = static_cast&lt;ChordRest*&gt;(e);</a>
<a name="ln2738">                                    }</a>
<a name="ln2739">                              if (cr == lastSelected) {</a>
<a name="ln2740">                                    topLeft = cr;</a>
<a name="ln2741">                                    break;</a>
<a name="ln2742">                                    }</a>
<a name="ln2743">                              // compare ticks rather than x position</a>
<a name="ln2744">                              // to make sure we favor earlier rather than later systems</a>
<a name="ln2745">                              // even though later system might have note farther to left</a>
<a name="ln2746">                              Fraction crTick = Fraction(0,1);</a>
<a name="ln2747">                              if (cr-&gt;segment())</a>
<a name="ln2748">                                    crTick = cr-&gt;segment()-&gt;tick();</a>
<a name="ln2749">                              else</a>
<a name="ln2750">                                    continue;</a>
<a name="ln2751">                              // compare staff Y position rather than note Y position</a>
<a name="ln2752">                              // to be sure we do not reject earliest note</a>
<a name="ln2753">                              // just because it is lower in pitch than subsequent notes</a>
<a name="ln2754">                              qreal crY = 0.0;</a>
<a name="ln2755">                              if (cr-&gt;measure() &amp;&amp; cr-&gt;measure()-&gt;system())</a>
<a name="ln2756">                                    crY = cr-&gt;measure()-&gt;system()-&gt;staffYpage(cr-&gt;staffIdx());</a>
<a name="ln2757">                              else</a>
<a name="ln2758">                                    continue;</a>
<a name="ln2759">                              if (topLeft) {</a>
<a name="ln2760">                                    if (crTick &lt;= tlTick &amp;&amp; crY &lt;= tlY) {</a>
<a name="ln2761">                                          topLeft = cr;</a>
<a name="ln2762">                                          tlTick = crTick;</a>
<a name="ln2763">                                          tlY = crY;</a>
<a name="ln2764">                                          }</a>
<a name="ln2765">                                    }</a>
<a name="ln2766">                              else {</a>
<a name="ln2767">                                    topLeft = cr;</a>
<a name="ln2768">                                    tlTick = crTick;</a>
<a name="ln2769">                                    tlY = crY;</a>
<a name="ln2770">                                    }</a>
<a name="ln2771">                              }</a>
<a name="ln2772">                        }</a>
<a name="ln2773">                  if (topLeft)</a>
<a name="ln2774">                        _score-&gt;select(topLeft, SelectType::SINGLE);</a>
<a name="ln2775">                  }</a>
<a name="ln2776">            }</a>
<a name="ln2777"> </a>
<a name="ln2778">      Element* el = _score-&gt;selection().activeCR() ? _score-&gt;selection().activeCR() : _score-&gt;selection().element();</a>
<a name="ln2779">      if (!el)</a>
<a name="ln2780">            el = _score-&gt;selection().firstChordRest();</a>
<a name="ln2781">      if (el == 0 || (el-&gt;type() != ElementType::CHORD &amp;&amp; el-&gt;type() != ElementType::REST &amp;&amp; el-&gt;type() != ElementType::NOTE)) {</a>
<a name="ln2782">            // if no note/rest is selected, start with voice 0</a>
<a name="ln2783">            int track = is.track() == -1 ? 0 : (is.track() / VOICES) * VOICES;</a>
<a name="ln2784">            // try to find an appropriate measure to start in</a>
<a name="ln2785">            Fraction tick = el ? el-&gt;tick() : Fraction(0,1);</a>
<a name="ln2786">            el = _score-&gt;searchNote(tick, track);</a>
<a name="ln2787">            if (!el)</a>
<a name="ln2788">                  el = _score-&gt;searchNote(Fraction(0,1), track);</a>
<a name="ln2789">            }</a>
<a name="ln2790">      if (!el)</a>
<a name="ln2791">            return;</a>
<a name="ln2792">      if (el-&gt;type() == ElementType::CHORD) {</a>
<a name="ln2793">            Chord* c = static_cast&lt;Chord*&gt;(el);</a>
<a name="ln2794">            note = c-&gt;selectedNote();</a>
<a name="ln2795">            if (note == 0)</a>
<a name="ln2796">                  note = c-&gt;upNote();</a>
<a name="ln2797">            el = note;</a>
<a name="ln2798">            }</a>
<a name="ln2799">      TDuration d(is.duration());</a>
<a name="ln2800">      if (!d.isValid() || d.isZero() || d.type() == TDuration::DurationType::V_MEASURE)</a>
<a name="ln2801">            is.setDuration(TDuration(TDuration::DurationType::V_QUARTER));</a>
<a name="ln2802">      is.setAccidentalType(AccidentalType::NONE);</a>
<a name="ln2803"> </a>
<a name="ln2804">      _score-&gt;select(el, SelectType::SINGLE, 0);</a>
<a name="ln2805">      is.setRest(false);</a>
<a name="ln2806">      is.setNoteEntryMode(true);</a>
<a name="ln2807">      adjustCanvasPosition(el, false);</a>
<a name="ln2808"> </a>
<a name="ln2809">      getAction(&quot;pad-rest&quot;)-&gt;setChecked(false);</a>
<a name="ln2810">      setMouseTracking(true);</a>
<a name="ln2811">      shadowNote-&gt;setVisible(true);</a>
<a name="ln2812">      _score-&gt;setUpdateAll();</a>
<a name="ln2813">      _score-&gt;update();</a>
<a name="ln2814"> </a>
<a name="ln2815">      Staff* staff = _score-&gt;staff(is.track() / VOICES);</a>
<a name="ln2816">      switch (staff-&gt;staffType(is.tick())-&gt;group()) {</a>
<a name="ln2817">            case StaffGroup::STANDARD:</a>
<a name="ln2818">                  break;</a>
<a name="ln2819">            case StaffGroup::TAB: {</a>
<a name="ln2820">                  int strg = 0;                 // assume topmost string as current string</a>
<a name="ln2821">                  // if entering note entry with a note selected and the note has a string</a>
<a name="ln2822">                  // set InputState::_string to note physical string</a>
<a name="ln2823">                  if (el-&gt;type() == ElementType::NOTE) {</a>
<a name="ln2824">                        strg = (static_cast&lt;Note*&gt;(el))-&gt;string();</a>
<a name="ln2825">                        }</a>
<a name="ln2826">                  is.setString(strg);</a>
<a name="ln2827">                  break;</a>
<a name="ln2828">                  }</a>
<a name="ln2829">            case StaffGroup::PERCUSSION:</a>
<a name="ln2830">                  break;</a>
<a name="ln2831">            }</a>
<a name="ln2832">      // set cursor after setting the stafftype-dependent state</a>
<a name="ln2833">      moveCursor();</a>
<a name="ln2834">      mscore-&gt;updateInputState(_score);</a>
<a name="ln2835">      shadowNote-&gt;setVisible(false);</a>
<a name="ln2836">      setCursorOn(true);</a>
<a name="ln2837">      }</a>
<a name="ln2838"> </a>
<a name="ln2839">//---------------------------------------------------------</a>
<a name="ln2840">//   endNoteEntry</a>
<a name="ln2841">//---------------------------------------------------------</a>
<a name="ln2842"> </a>
<a name="ln2843">void ScoreView::endNoteEntry()</a>
<a name="ln2844">      {</a>
<a name="ln2845">      InputState&amp; is = _score-&gt;inputState();</a>
<a name="ln2846">      is.setNoteEntryMode(false);</a>
<a name="ln2847">      if (is.slur()) {</a>
<a name="ln2848">            const std::vector&lt;SpannerSegment*&gt;&amp; el = is.slur()-&gt;spannerSegments();</a>
<a name="ln2849">            if (!el.empty())</a>
<a name="ln2850">                  el.front()-&gt;setSelected(false);</a>
<a name="ln2851">            is.setSlur(0);</a>
<a name="ln2852">            }</a>
<a name="ln2853">      setMouseTracking(false);</a>
<a name="ln2854">      shadowNote-&gt;setVisible(false);</a>
<a name="ln2855">      setCursorOn(false);</a>
<a name="ln2856">      _score-&gt;setUpdateAll();</a>
<a name="ln2857">      _score-&gt;update();</a>
<a name="ln2858">      }</a>
<a name="ln2859"> </a>
<a name="ln2860">//---------------------------------------------------------</a>
<a name="ln2861">//   dragScoreView</a>
<a name="ln2862">//---------------------------------------------------------</a>
<a name="ln2863"> </a>
<a name="ln2864">void ScoreView::dragScoreView(QMouseEvent* ev)</a>
<a name="ln2865">      {</a>
<a name="ln2866">      QPoint d = ev-&gt;pos() - _matrix.map(editData.startMove).toPoint();</a>
<a name="ln2867">      int dx   = d.x();</a>
<a name="ln2868">      int dy   = d.y();</a>
<a name="ln2869"> </a>
<a name="ln2870">      if (dx == 0 &amp;&amp; dy == 0)</a>
<a name="ln2871">            return;</a>
<a name="ln2872"> </a>
<a name="ln2873">      constraintCanvas(&amp;dx, &amp;dy);</a>
<a name="ln2874"> </a>
<a name="ln2875">      TourHandler::startTour(&quot;navigate-tour&quot;);</a>
<a name="ln2876"> </a>
<a name="ln2877">      _matrix.setMatrix(_matrix.m11(), _matrix.m12(), _matrix.m13(), _matrix.m21(),</a>
<a name="ln2878">         _matrix.m22(), _matrix.m23(), _matrix.dx()+dx, _matrix.dy()+dy, _matrix.m33());</a>
<a name="ln2879">      imatrix = _matrix.inverted();</a>
<a name="ln2880">      scroll(dx, dy, QRect(0, 0, width(), height()));</a>
<a name="ln2881">      // scroll schedules an update which is probably too small</a>
<a name="ln2882">      // hack around:</a>
<a name="ln2883">      if (dx &gt; 0)</a>
<a name="ln2884">            update(-10, 0, dx + 50, height());</a>
<a name="ln2885">      else if (dx &lt; 0)</a>
<a name="ln2886">            update(width() - 50 + dx, 0, width() + 10, height());</a>
<a name="ln2887">      emit offsetChanged(_matrix.dx(), _matrix.dy());</a>
<a name="ln2888">      emit viewRectChanged();</a>
<a name="ln2889">      }</a>
<a name="ln2890"> </a>
<a name="ln2891">//---------------------------------------------------------</a>
<a name="ln2892">//   doDragLasso</a>
<a name="ln2893">//---------------------------------------------------------</a>
<a name="ln2894"> </a>
<a name="ln2895">void ScoreView::doDragLasso(QMouseEvent* ev)</a>
<a name="ln2896">      {</a>
<a name="ln2897">      TourHandler::startTour(&quot;select-tour&quot;);</a>
<a name="ln2898">      QPointF p = toLogical(ev-&gt;pos());</a>
<a name="ln2899">      _score-&gt;addRefresh(lasso-&gt;canvasBoundingRect());</a>
<a name="ln2900">      QRectF r;</a>
<a name="ln2901">      r.setCoords(editData.startMove.x(), editData.startMove.y(), p.x(), p.y());</a>
<a name="ln2902">      lasso-&gt;setbbox(r.normalized());</a>
<a name="ln2903">      QRectF _lassoRect(lasso-&gt;bbox());</a>
<a name="ln2904">      r = _matrix.mapRect(_lassoRect);</a>
<a name="ln2905">      QSize sz(r.size().toSize());</a>
<a name="ln2906">      mscore-&gt;statusBar()-&gt;showMessage(QString(&quot;%1 x %2&quot;).arg(sz.width()).arg(sz.height()), 3000);</a>
<a name="ln2907">      _score-&gt;addRefresh(lasso-&gt;canvasBoundingRect());</a>
<a name="ln2908">      _score-&gt;lassoSelect(lasso-&gt;bbox());</a>
<a name="ln2909">      _score-&gt;update();</a>
<a name="ln2910">      }</a>
<a name="ln2911"> </a>
<a name="ln2912">//---------------------------------------------------------</a>
<a name="ln2913">//   endLasso</a>
<a name="ln2914">//---------------------------------------------------------</a>
<a name="ln2915"> </a>
<a name="ln2916">void ScoreView::endLasso()</a>
<a name="ln2917">      {</a>
<a name="ln2918">      _score-&gt;addRefresh(lasso-&gt;canvasBoundingRect());</a>
<a name="ln2919">      lasso-&gt;setbbox(QRectF());</a>
<a name="ln2920">      _score-&gt;lassoSelectEnd();</a>
<a name="ln2921">      _score-&gt;update();</a>
<a name="ln2922">      mscore-&gt;endCmd();</a>
<a name="ln2923">      }</a>
<a name="ln2924"> </a>
<a name="ln2925">//---------------------------------------------------------</a>
<a name="ln2926">//   deselectAll</a>
<a name="ln2927">//---------------------------------------------------------</a>
<a name="ln2928"> </a>
<a name="ln2929">void ScoreView::deselectAll()</a>
<a name="ln2930">      {</a>
<a name="ln2931">      _score-&gt;deselectAll();</a>
<a name="ln2932">      _score-&gt;update();</a>
<a name="ln2933">      mscore-&gt;endCmd();</a>
<a name="ln2934">      }</a>
<a name="ln2935"> </a>
<a name="ln2936">//---------------------------------------------------------</a>
<a name="ln2937">//   inputMethodQuery</a>
<a name="ln2938">//---------------------------------------------------------</a>
<a name="ln2939"> </a>
<a name="ln2940">QVariant ScoreView::inputMethodQuery(Qt::InputMethodQuery query) const</a>
<a name="ln2941">      {</a>
<a name="ln2942">//      qDebug(&quot;0x%x  %s&quot;, int(query), editData.element ? editData.element-&gt;name() : &quot;-no element-&quot;);</a>
<a name="ln2943">      if (editData.element &amp;&amp; editData.element-&gt;isTextBase()) {</a>
<a name="ln2944">            TextBase* text = toTextBase(editData.element);</a>
<a name="ln2945">            switch (query) {</a>
<a name="ln2946">                  case Qt::ImCursorRectangle: {</a>
<a name="ln2947">                        QRectF r;</a>
<a name="ln2948">                        if (editMode()) {</a>
<a name="ln2949">                              TextCursor* cursor = text-&gt;cursor(editData);</a>
<a name="ln2950">                              r = toPhysical(cursor-&gt;cursorRect().translated(text-&gt;canvasPos()));</a>
<a name="ln2951">                              r.setWidth(1); // InputMethod doesn't display properly if width left at 0</a>
<a name="ln2952">                              }</a>
<a name="ln2953">                        else</a>
<a name="ln2954">                              r = toPhysical(text-&gt;canvasBoundingRect());</a>
<a name="ln2955">                        r.setHeight(r.height() + 10); // add a little margin under the cursor</a>
<a name="ln2956">                        qDebug(&quot;ScoreView::inputMethodQuery() updating cursorRect to: (%3f, %3f) + (%3f, %3f)&quot;, r.x(), r.y(), r.width(), r.height());</a>
<a name="ln2957">                        return QVariant(r);</a>
<a name="ln2958">                        }</a>
<a name="ln2959">                  case Qt::ImEnabled:</a>
<a name="ln2960">                        return true; // TextBase will always accept input method input</a>
<a name="ln2961">                  case Qt::ImHints:</a>
<a name="ln2962">                        return Qt::ImhNone; // No hints for now, but maybe in future will give hints</a>
<a name="ln2963">                  case Qt::ImInputItemClipRectangle: // maybe give clip rect hint in future, but for now use default parent clipping rect</a>
<a name="ln2964">                  default:</a>
<a name="ln2965">                        return QWidget::inputMethodQuery(query); // fall back to QWidget's version as default</a>
<a name="ln2966">                  }</a>
<a name="ln2967">            }</a>
<a name="ln2968">      QVariant d = QWidget::inputMethodQuery(query); // fall back to QWidget's version as default</a>
<a name="ln2969">//      qDebug() &lt;&lt; &quot;   &quot; &lt;&lt; d;</a>
<a name="ln2970">      return d;</a>
<a name="ln2971">      }</a>
<a name="ln2972"> </a>
<a name="ln2973">//---------------------------------------------------------</a>
<a name="ln2974">//   lmag</a>
<a name="ln2975">//---------------------------------------------------------</a>
<a name="ln2976"> </a>
<a name="ln2977">qreal ScoreView::lmag() const</a>
<a name="ln2978">      {</a>
<a name="ln2979">      return _matrix.m11() / (mscore-&gt;physicalDotsPerInch() / DPI);</a>
<a name="ln2980">      }</a>
<a name="ln2981"> </a>
<a name="ln2982">//---------------------------------------------------------</a>
<a name="ln2983">//   mag</a>
<a name="ln2984">//---------------------------------------------------------</a>
<a name="ln2985"> </a>
<a name="ln2986">qreal ScoreView::mag() const</a>
<a name="ln2987">      {</a>
<a name="ln2988">      return _matrix.m11();</a>
<a name="ln2989">      }</a>
<a name="ln2990"> </a>
<a name="ln2991">//---------------------------------------------------------</a>
<a name="ln2992">//   setOffset</a>
<a name="ln2993">//---------------------------------------------------------</a>
<a name="ln2994"> </a>
<a name="ln2995">void ScoreView::setOffset(qreal x, qreal y)</a>
<a name="ln2996">      {</a>
<a name="ln2997">      _matrix.setMatrix(_matrix.m11(), _matrix.m12(), _matrix.m13(), _matrix.m21(),</a>
<a name="ln2998">         _matrix.m22(), _matrix.m23(), x, y, _matrix.m33());</a>
<a name="ln2999">      imatrix = _matrix.inverted();</a>
<a name="ln3000">      emit viewRectChanged();</a>
<a name="ln3001">      emit offsetChanged(x, y);</a>
<a name="ln3002">      }</a>
<a name="ln3003"> </a>
<a name="ln3004">//---------------------------------------------------------</a>
<a name="ln3005">//   xoffset</a>
<a name="ln3006">//---------------------------------------------------------</a>
<a name="ln3007"> </a>
<a name="ln3008">qreal ScoreView::xoffset() const</a>
<a name="ln3009">      {</a>
<a name="ln3010">      return _matrix.dx();</a>
<a name="ln3011">      }</a>
<a name="ln3012"> </a>
<a name="ln3013">//---------------------------------------------------------</a>
<a name="ln3014">//   yoffset</a>
<a name="ln3015">//---------------------------------------------------------</a>
<a name="ln3016"> </a>
<a name="ln3017">qreal ScoreView::yoffset() const</a>
<a name="ln3018">      {</a>
<a name="ln3019">      return _matrix.dy();</a>
<a name="ln3020">      }</a>
<a name="ln3021"> </a>
<a name="ln3022">//---------------------------------------------------------</a>
<a name="ln3023">//   fsize</a>
<a name="ln3024">//---------------------------------------------------------</a>
<a name="ln3025"> </a>
<a name="ln3026">QSizeF ScoreView::fsize() const</a>
<a name="ln3027">      {</a>
<a name="ln3028">      QSize s = size();</a>
<a name="ln3029">      return QSizeF(s.width() * imatrix.m11(), s.height() * imatrix.m22());</a>
<a name="ln3030">      }</a>
<a name="ln3031"> </a>
<a name="ln3032">//---------------------------------------------------------</a>
<a name="ln3033">//   keyboard nav constants</a>
<a name="ln3034">//---------------------------------------------------------</a>
<a name="ln3035"> </a>
<a name="ln3036">constexpr qreal scrollStep   {   .8 };</a>
<a name="ln3037">constexpr qreal thinPadding  { 10.0 };</a>
<a name="ln3038">constexpr qreal thickPadding { 25.0 };</a>
<a name="ln3039"> </a>
<a name="ln3040">//---------------------------------------------------------</a>
<a name="ln3041">//   pageNext</a>
<a name="ln3042">//---------------------------------------------------------</a>
<a name="ln3043"> </a>
<a name="ln3044">void ScoreView::pageNext()</a>
<a name="ln3045">      {</a>
<a name="ln3046">      if (score()-&gt;pages().empty())</a>
<a name="ln3047">            return;</a>
<a name="ln3048">      if (score()-&gt;layoutMode() != LayoutMode::PAGE) {</a>
<a name="ln3049">            screenNext();</a>
<a name="ln3050">            return;</a>
<a name="ln3051">            }</a>
<a name="ln3052">      Page* page = score()-&gt;pages().back();</a>
<a name="ln3053">      qreal x, y;</a>
<a name="ln3054">      if (MScore::verticalOrientation()) {</a>
<a name="ln3055">            x        = thinPadding;</a>
<a name="ln3056">            y        = yoffset() - (page-&gt;height() + thickPadding) * mag();</a>
<a name="ln3057">            qreal ly = thinPadding - page-&gt;pos().y() * mag();</a>
<a name="ln3058">            if (y &lt;= ly - height() * scrollStep) {</a>
<a name="ln3059">                  pageEnd();</a>
<a name="ln3060">                  return;</a>
<a name="ln3061">                  }</a>
<a name="ln3062">            }</a>
<a name="ln3063">      else {</a>
<a name="ln3064">            y        = thinPadding;</a>
<a name="ln3065">            x        = xoffset() - (page-&gt;width() + thickPadding) * mag();</a>
<a name="ln3066">            qreal lx = thinPadding - page-&gt;pos().x() * mag();</a>
<a name="ln3067">            if (x &lt;= lx - width() * scrollStep) {</a>
<a name="ln3068">                  pageEnd();</a>
<a name="ln3069">                  return;</a>
<a name="ln3070">                  }</a>
<a name="ln3071">            }</a>
<a name="ln3072">      setOffset(x, y);</a>
<a name="ln3073">      update();</a>
<a name="ln3074">      }</a>
<a name="ln3075"> </a>
<a name="ln3076">//---------------------------------------------------------</a>
<a name="ln3077">//   screenNext</a>
<a name="ln3078">//---------------------------------------------------------</a>
<a name="ln3079"> </a>
<a name="ln3080">void ScoreView::screenNext()</a>
<a name="ln3081">      {</a>
<a name="ln3082">      if (score()-&gt;pages().empty())</a>
<a name="ln3083">            return;</a>
<a name="ln3084">      qreal x { xoffset() };</a>
<a name="ln3085">      qreal y { yoffset() };</a>
<a name="ln3086">      if (score()-&gt;layoutMode() == LayoutMode::LINE) {</a>
<a name="ln3087">            x -= width() * scrollStep;</a>
<a name="ln3088">            MeasureBase* lm = score()-&gt;lastMeasureMM();</a>
<a name="ln3089">            // Vertical frames aren't laid out in continuous view</a>
<a name="ln3090">            while (lm-&gt;isVBoxBase())</a>
<a name="ln3091">                  lm = lm-&gt;prev();</a>
<a name="ln3092">            qreal lx = (lm-&gt;pos().x() + lm-&gt;width()) * mag() - width() * scrollStep;</a>
<a name="ln3093">            if (x &lt; -lx)</a>
<a name="ln3094">                  x = -lx;</a>
<a name="ln3095">            }</a>
<a name="ln3096">      else {</a>
<a name="ln3097">            y -= height() * scrollStep;</a>
<a name="ln3098">            MeasureBase* lm { score()-&gt;lastMeasureMM() };</a>
<a name="ln3099">            qreal ly { (lm-&gt;canvasPos().y() + lm-&gt;height()) * mag() - height() * scrollStep };</a>
<a name="ln3100">            // Special case to jump to top of next page in horizontal view.</a>
<a name="ln3101">            if (score()-&gt;layoutMode() == LayoutMode::PAGE &amp;&amp; !MScore::verticalOrientation()</a>
<a name="ln3102">               &amp;&amp; y &lt;= -ly - height() * scrollStep) {</a>
<a name="ln3103">                  pageNext();</a>
<a name="ln3104">                  return;</a>
<a name="ln3105">                  }</a>
<a name="ln3106">            if (y &lt; -ly)</a>
<a name="ln3107">                  y = -ly;</a>
<a name="ln3108">            }</a>
<a name="ln3109">      setOffset(x, y);</a>
<a name="ln3110">      update();</a>
<a name="ln3111">      }</a>
<a name="ln3112"> </a>
<a name="ln3113">//---------------------------------------------------------</a>
<a name="ln3114">//   pagePrev</a>
<a name="ln3115">//---------------------------------------------------------</a>
<a name="ln3116"> </a>
<a name="ln3117">void ScoreView::pagePrev()</a>
<a name="ln3118">      {</a>
<a name="ln3119">      if (score()-&gt;pages().empty())</a>
<a name="ln3120">            return;</a>
<a name="ln3121">      if (score()-&gt;layoutMode() != LayoutMode::PAGE) {</a>
<a name="ln3122">            screenPrev();</a>
<a name="ln3123">            return;</a>
<a name="ln3124">            }</a>
<a name="ln3125">      Page* page = score()-&gt;pages().front();</a>
<a name="ln3126">      qreal x, y;</a>
<a name="ln3127">      if (MScore::verticalOrientation()) {</a>
<a name="ln3128">            x  = thinPadding;</a>
<a name="ln3129">            y  = yoffset() + (page-&gt;height() + thickPadding) * mag();</a>
<a name="ln3130">            if (y &gt; thinPadding)</a>
<a name="ln3131">                  y = thinPadding;</a>
<a name="ln3132">            }</a>
<a name="ln3133">      else {</a>
<a name="ln3134">            y  = thinPadding;</a>
<a name="ln3135">            x  = xoffset() + (page-&gt;width() + thickPadding) * mag();</a>
<a name="ln3136">            if (x &gt; thinPadding)</a>
<a name="ln3137">                  x = thinPadding;</a>
<a name="ln3138">            }</a>
<a name="ln3139">      setOffset(x, y);</a>
<a name="ln3140">      update();</a>
<a name="ln3141">      }</a>
<a name="ln3142"> </a>
<a name="ln3143">//---------------------------------------------------------</a>
<a name="ln3144">//   screenPrev</a>
<a name="ln3145">//---------------------------------------------------------</a>
<a name="ln3146"> </a>
<a name="ln3147">void ScoreView::screenPrev()</a>
<a name="ln3148">      {</a>
<a name="ln3149">      if (score()-&gt;pages().empty())</a>
<a name="ln3150">            return;</a>
<a name="ln3151">      qreal x { xoffset() };</a>
<a name="ln3152">      qreal y { yoffset() };</a>
<a name="ln3153">      if (score()-&gt;layoutMode() == LayoutMode::LINE) {</a>
<a name="ln3154">            x += width() * scrollStep;</a>
<a name="ln3155">            if (x &gt; thinPadding)</a>
<a name="ln3156">                  x = thinPadding;</a>
<a name="ln3157">            }</a>
<a name="ln3158">      else {</a>
<a name="ln3159">            y += height() * scrollStep;</a>
<a name="ln3160">            // Special casing for jumping to bottom of prev page in horizontal view</a>
<a name="ln3161">            if (score()-&gt;layoutMode() == LayoutMode::PAGE &amp;&amp; !MScore::verticalOrientation()</a>
<a name="ln3162">               &amp;&amp; y &gt;= thinPadding + height() * scrollStep) {</a>
<a name="ln3163">                  Page* page { score()-&gt;pages().front() };</a>
<a name="ln3164">                  x += (page-&gt;width() + thickPadding) * mag();</a>
<a name="ln3165">                  // The condition prevents jumping to the bottom of the</a>
<a name="ln3166">                  // first page after reaching the top</a>
<a name="ln3167">                  if (x &lt; thinPadding + (page-&gt;width() + thickPadding) * mag()) {</a>
<a name="ln3168">                        MeasureBase* lm { score()-&gt;lastMeasureMM() };</a>
<a name="ln3169">                        y = -(lm-&gt;canvasPos().y() + lm-&gt;height()) * mag() + height() * scrollStep;</a>
<a name="ln3170">                        }</a>
<a name="ln3171">                  if (x &gt; thinPadding)</a>
<a name="ln3172">                        x = thinPadding;</a>
<a name="ln3173">                  }</a>
<a name="ln3174">            if (y &gt; thinPadding)</a>
<a name="ln3175">                y = thinPadding;</a>
<a name="ln3176">            }</a>
<a name="ln3177">      setOffset(x, y);</a>
<a name="ln3178">      update();</a>
<a name="ln3179">      }</a>
<a name="ln3180"> </a>
<a name="ln3181">//---------------------------------------------------------</a>
<a name="ln3182">//   pageTop</a>
<a name="ln3183">//---------------------------------------------------------</a>
<a name="ln3184"> </a>
<a name="ln3185">void ScoreView::pageTop()</a>
<a name="ln3186">      {</a>
<a name="ln3187">      if (score()-&gt;layoutMode() == LayoutMode::LINE)</a>
<a name="ln3188">            setOffset(thinPadding, 0.0);</a>
<a name="ln3189">      else</a>
<a name="ln3190">            setOffset(thinPadding, thinPadding);</a>
<a name="ln3191">      update();</a>
<a name="ln3192">      }</a>
<a name="ln3193"> </a>
<a name="ln3194">//---------------------------------------------------------</a>
<a name="ln3195">//   pageEnd</a>
<a name="ln3196">//---------------------------------------------------------</a>
<a name="ln3197"> </a>
<a name="ln3198">void ScoreView::pageEnd()</a>
<a name="ln3199">      {</a>
<a name="ln3200">      if (score()-&gt;pages().empty())</a>
<a name="ln3201">            return;</a>
<a name="ln3202">      MeasureBase* lm = score()-&gt;lastMeasureMM();</a>
<a name="ln3203">      if (score()-&gt;layoutMode() == LayoutMode::LINE) {</a>
<a name="ln3204">            // Vertical frames aren't laid out in continuous view</a>
<a name="ln3205">            while (lm-&gt;isVBoxBase())</a>
<a name="ln3206">                  lm = lm-&gt;prev();</a>
<a name="ln3207">            qreal lx = (lm-&gt;pos().x() + lm-&gt;width()) * mag() - scrollStep * width();</a>
<a name="ln3208">            setOffset(-lx, yoffset());</a>
<a name="ln3209">            }</a>
<a name="ln3210">      else {</a>
<a name="ln3211">            qreal lx { -thinPadding };</a>
<a name="ln3212">            if (score()-&gt;layoutMode() == LayoutMode::PAGE &amp;&amp; !MScore::verticalOrientation()) {</a>
<a name="ln3213">                  for (int i { 0 }; i &lt; score()-&gt;npages() - 1; ++i)</a>
<a name="ln3214">                        lx += score()-&gt;pages().at(i)-&gt;width() * mag();</a>
<a name="ln3215">                  }</a>
<a name="ln3216">            if (lm-&gt;system() &amp;&amp; lm-&gt;system()-&gt;page()-&gt;width() * mag() &gt; width())</a>
<a name="ln3217">                  lx = (lm-&gt;canvasPos().x() + lm-&gt;width()) * mag() - width() * scrollStep;</a>
<a name="ln3218"> </a>
<a name="ln3219">            qreal ly { (lm-&gt;canvasPos().y() + lm-&gt;height()) * mag() - height() * scrollStep };</a>
<a name="ln3220">            setOffset(-lx, -ly);</a>
<a name="ln3221">            }</a>
<a name="ln3222">      update();</a>
<a name="ln3223">      }</a>
<a name="ln3224"> </a>
<a name="ln3225">//---------------------------------------------------------</a>
<a name="ln3226">//   adjustCanvasPosition</a>
<a name="ln3227">//---------------------------------------------------------</a>
<a name="ln3228"> </a>
<a name="ln3229">void ScoreView::adjustCanvasPosition(const Element* el, bool playBack, int staff )</a>
<a name="ln3230">      {</a>
<a name="ln3231">      if (this != mscore-&gt;currentScoreView() &amp;&amp; !_moveWhenInactive)</a>
<a name="ln3232">            return;</a>
<a name="ln3233">      // TODO: change icon, or add panning options</a>
<a name="ln3234">      if (!mscore-&gt;panDuringPlayback())</a>
<a name="ln3235">            return;</a>
<a name="ln3236"> </a>
<a name="ln3237">      if (score()-&gt;layoutMode() == LayoutMode::LINE) {</a>
<a name="ln3238"> </a>
<a name="ln3239">            if (!el)</a>
<a name="ln3240">                  return;</a>
<a name="ln3241"> </a>
<a name="ln3242">            /* Not used, because impossible to get panel width beforehand</a>
<a name="ln3243">            const MeasureBase* m = 0;</a>
<a name="ln3244">            if (el-&gt;type() == ElementType::MEASURE)</a>
<a name="ln3245">                  m = static_cast&lt;const MeasureBase*&gt;(el);</a>
<a name="ln3246">            else</a>
<a name="ln3247">                  m = static_cast&lt;const Measure*&gt;(el-&gt;parent()-&gt;findMeasure());</a>
<a name="ln3248">            */</a>
<a name="ln3249"> </a>
<a name="ln3250">            qreal xo = 0.0;  // new x offset</a>
<a name="ln3251">            QRectF curPos = playBack ? _cursor-&gt;rect() : el-&gt;canvasBoundingRect();</a>
<a name="ln3252">            // keep current note in view as well if applicable (note input mode)</a>
<a name="ln3253">            Element* current = nullptr;</a>
<a name="ln3254">            if (noteEntryMode()) {</a>
<a name="ln3255">                  current = score()-&gt;selection().cr();</a>
<a name="ln3256">                  if (current &amp;&amp; current != el)</a>
<a name="ln3257">                        curPos |= current-&gt;canvasBoundingRect();</a>
<a name="ln3258">                  }</a>
<a name="ln3259"> </a>
<a name="ln3260">            qreal curPosR = curPos.right();                    // Position on the canvas</a>
<a name="ln3261">            qreal curPosL = curPos.left();                     // Position on the canvas</a>
<a name="ln3262">            qreal curPosMagR = curPosR * mag() + xoffset(); // Position in the screen</a>
<a name="ln3263">            qreal curPosMagL = curPosL * mag() + xoffset(); // Position in the screen</a>
<a name="ln3264">            qreal marginLeft = width() * 0.05;</a>
<a name="ln3265">            qreal marginRight = width() * 0.05; // leaves 5% margin to the right</a>
<a name="ln3266"> </a>
<a name="ln3267">            if (_continuousPanel-&gt;active())</a>
<a name="ln3268">                  marginLeft += _continuousPanel-&gt;width() * mag();</a>
<a name="ln3269"> </a>
<a name="ln3270">            // this code implements &quot;continuous&quot; panning</a>
<a name="ln3271">            // it could potentially be enabled via more panning options</a>
<a name="ln3272">            //if (playBack &amp;&amp; _cursor) {</a>
<a name="ln3273">            //      // keep playback cursor pinned at 25%</a>
<a name="ln3274">            //      xo = -curPosL * mag() + marginLeft + width() * 0.2;</a>
<a name="ln3275">            //      }</a>
<a name="ln3276">            //else</a>
<a name="ln3277">            if (round(curPosMagR) &gt; round(width() - marginRight)) {</a>
<a name="ln3278">                  // focus in or beyond right margin</a>
<a name="ln3279">                  // pan to left margin in playback,</a>
<a name="ln3280">                  // most of the way left in note entry,</a>
<a name="ln3281">                  // otherwise just enforce right margin</a>
<a name="ln3282">                  if (playBack)</a>
<a name="ln3283">                        xo = -curPosL * mag() + marginLeft;</a>
<a name="ln3284">                  else if (noteEntryMode())</a>
<a name="ln3285">                        xo = -curPosL * mag() + marginLeft + width() * 0.2;</a>
<a name="ln3286">                  else</a>
<a name="ln3287">                        xo = -curPosR * mag() + width() - marginRight;</a>
<a name="ln3288">                  }</a>
<a name="ln3289">            else if (round(curPosMagL) &lt; round(marginLeft) ) {</a>
<a name="ln3290">                  // focus in or beyond left margin</a>
<a name="ln3291">                  // enforce left margin</a>
<a name="ln3292">                  // (previously we moved canvas all the way right,</a>
<a name="ln3293">                  // but this made sense only when navigating right-to-left)</a>
<a name="ln3294">                  xo = -curPosL * mag() + marginLeft;</a>
<a name="ln3295">                  }</a>
<a name="ln3296">            else {</a>
<a name="ln3297">                  // focus is within margins, so do nothing</a>
<a name="ln3298">                  return;</a>
<a name="ln3299">                  }</a>
<a name="ln3300">            // avoid empty space on either side of &quot;page&quot;</a>
<a name="ln3301">            qreal scoreEnd = score()-&gt;pages().front()-&gt;width() * mag() + xo;</a>
<a name="ln3302">            if (xo &gt; 10)</a>
<a name="ln3303">                  xo = 10;</a>
<a name="ln3304">            else if (scoreEnd &lt; width())</a>
<a name="ln3305">                  xo += width() - scoreEnd;</a>
<a name="ln3306"> </a>
<a name="ln3307">            setOffset(xo, yoffset());</a>
<a name="ln3308">            update();</a>
<a name="ln3309">            return;</a>
<a name="ln3310">            }</a>
<a name="ln3311"> </a>
<a name="ln3312">      const MeasureBase* m;</a>
<a name="ln3313">      if (!el)</a>
<a name="ln3314">            return;</a>
<a name="ln3315">      else if (el-&gt;type() == ElementType::NOTE)</a>
<a name="ln3316">            m = static_cast&lt;const Note*&gt;(el)-&gt;chord()-&gt;measure();</a>
<a name="ln3317">      else if (el-&gt;type() == ElementType::REST)</a>
<a name="ln3318">            m = static_cast&lt;const Rest*&gt;(el)-&gt;measure();</a>
<a name="ln3319">      else if (el-&gt;type() == ElementType::CHORD)</a>
<a name="ln3320">            m = static_cast&lt;const Chord*&gt;(el)-&gt;measure();</a>
<a name="ln3321">      else if (el-&gt;type() == ElementType::SEGMENT)</a>
<a name="ln3322">            m = static_cast&lt;const Segment*&gt;(el)-&gt;measure();</a>
<a name="ln3323">      else if (el-&gt;type() == ElementType::LYRICS)</a>
<a name="ln3324">            m = static_cast&lt;const Lyrics*&gt;(el)-&gt;measure();</a>
<a name="ln3325">      else if ( (el-&gt;type() == ElementType::HARMONY || el-&gt;type() == ElementType::FIGURED_BASS)</a>
<a name="ln3326">         &amp;&amp; el-&gt;parent()-&gt;type() == ElementType::SEGMENT)</a>
<a name="ln3327">            m = static_cast&lt;const Segment*&gt;(el-&gt;parent())-&gt;measure();</a>
<a name="ln3328">      else if (el-&gt;type() == ElementType::HARMONY &amp;&amp; el-&gt;parent()-&gt;type() == ElementType::FRET_DIAGRAM</a>
<a name="ln3329">         &amp;&amp; el-&gt;parent()-&gt;parent()-&gt;type() == ElementType::SEGMENT)</a>
<a name="ln3330">            m = static_cast&lt;const Segment*&gt;(el-&gt;parent()-&gt;parent())-&gt;measure();</a>
<a name="ln3331">      else if (el-&gt;isMeasureBase())</a>
<a name="ln3332">            m = static_cast&lt;const MeasureBase*&gt;(el);</a>
<a name="ln3333">      else if (el-&gt;isSpannerSegment()) {</a>
<a name="ln3334">            Element* se = static_cast&lt;const SpannerSegment*&gt;(el)-&gt;spanner()-&gt;startElement();</a>
<a name="ln3335">            m = static_cast&lt;Measure*&gt;(se-&gt;findMeasure());</a>
<a name="ln3336">            }</a>
<a name="ln3337">      else if (el-&gt;isSpanner()) {</a>
<a name="ln3338">            Element* se = static_cast&lt;const Spanner*&gt;(el)-&gt;startElement();</a>
<a name="ln3339">            m = static_cast&lt;Measure*&gt;(se-&gt;findMeasure());</a>
<a name="ln3340">            }</a>
<a name="ln3341">      else {</a>
<a name="ln3342">            // attempt to find measure</a>
<a name="ln3343">            Element* e = el-&gt;parent();</a>
<a name="ln3344">            while (e &amp;&amp; !e-&gt;isMeasureBase())</a>
<a name="ln3345">                  e = e-&gt;parent();</a>
<a name="ln3346">            if (e)</a>
<a name="ln3347">                  m = toMeasureBase(e);</a>
<a name="ln3348">            else</a>
<a name="ln3349">                  return;</a>
<a name="ln3350">            }</a>
<a name="ln3351">      if (!m)</a>
<a name="ln3352">            return;</a>
<a name="ln3353"> </a>
<a name="ln3354">      int staffIdx = el-&gt;staffIdx();</a>
<a name="ln3355">      System* sys = m-&gt;system();</a>
<a name="ln3356">      if (!sys)</a>
<a name="ln3357">            return;</a>
<a name="ln3358"> </a>
<a name="ln3359">      QPointF p(el-&gt;canvasPos());</a>
<a name="ln3360">      QRectF r(canvasViewport());</a>
<a name="ln3361">      QRectF mRect(m-&gt;canvasBoundingRect());</a>
<a name="ln3362">      QRectF sysRect;</a>
<a name="ln3363">      if (staffIdx == -1)</a>
<a name="ln3364">            sysRect = sys-&gt;canvasBoundingRect();</a>
<a name="ln3365">      else</a>
<a name="ln3366">            sysRect = sys-&gt;staff(staffIdx)-&gt;bbox();</a>
<a name="ln3367"> </a>
<a name="ln3368">      // only try to track measure if not during playback</a>
<a name="ln3369">      if (!playBack)</a>
<a name="ln3370">            sysRect = mRect;</a>
<a name="ln3371"> </a>
<a name="ln3372">      double _spatium    = score()-&gt;spatium();</a>
<a name="ln3373">      const qreal border = _spatium * 3;</a>
<a name="ln3374">      QRectF showRect;</a>
<a name="ln3375">      if (staff == -1) {</a>
<a name="ln3376">            showRect = QRectF(mRect.x(), sysRect.y(), mRect.width(), sysRect.height())</a>
<a name="ln3377">                        .adjusted(-border, -border, border, border);</a>
<a name="ln3378">            }</a>
<a name="ln3379">      else {</a>
<a name="ln3380">            // find a box for the individual stave in a system</a>
<a name="ln3381">            QRectF stave = QRectF(sys-&gt;canvasBoundingRect().left(),</a>
<a name="ln3382">                                  sys-&gt;staffCanvasYpage(staff),</a>
<a name="ln3383">                                  sys-&gt;width(),</a>
<a name="ln3384">                                  sys-&gt;staff(staff)-&gt;bbox().height());</a>
<a name="ln3385">            showRect = mRect.intersected(stave).adjusted(-border, -border, border, border);</a>
<a name="ln3386">            }</a>
<a name="ln3387"> </a>
<a name="ln3388">/*printf(&quot;%f %f %f %f   %f %f %f %f  %d\n&quot;,</a>
<a name="ln3389">   showRect.x(), showRect.y(), showRect.width(), showRect.height(),</a>
<a name="ln3390">   r.x(), r.y(), r.width(), r.height(),</a>
<a name="ln3391">   r.contains(showRect)</a>
<a name="ln3392">   );</a>
<a name="ln3393">*/</a>
<a name="ln3394">      // canvas is not as wide as measure, track note instead</a>
<a name="ln3395">      if (r.width() &lt; showRect.width()) {</a>
<a name="ln3396">            QRectF eRect(el-&gt;canvasBoundingRect());</a>
<a name="ln3397">            showRect.setX(eRect.x());</a>
<a name="ln3398">            showRect.setWidth(eRect.width());</a>
<a name="ln3399">            }</a>
<a name="ln3400"> </a>
<a name="ln3401">      // canvas is not as tall as system</a>
<a name="ln3402">      if (r.height() &lt; showRect.height()) {</a>
<a name="ln3403">            if (sys-&gt;staves()-&gt;size() == 1 || !playBack) {</a>
<a name="ln3404">                  // track note if single staff</a>
<a name="ln3405">                  showRect.setY(p.y());</a>
<a name="ln3406">                  showRect.setHeight(el-&gt;height());</a>
<a name="ln3407">                  }</a>
<a name="ln3408">            else if (sys-&gt;page()-&gt;systems().size() == 1) {</a>
<a name="ln3409">                  // otherwise, just keep current vertical position if possible</a>
<a name="ln3410">                  // see issue #7724</a>
<a name="ln3411">                  showRect.setY(r.y());</a>
<a name="ln3412">                  showRect.setHeight(r.height());</a>
<a name="ln3413">                  }</a>
<a name="ln3414">            }</a>
<a name="ln3415">      if (shadowNote-&gt;visible())</a>
<a name="ln3416">            setShadowNote(p);</a>
<a name="ln3417"> </a>
<a name="ln3418">      if (r.contains(showRect))</a>
<a name="ln3419">            return;</a>
<a name="ln3420"> </a>
<a name="ln3421">      qreal x   = - xoffset() / mag();</a>
<a name="ln3422">      qreal y   = - yoffset() / mag();</a>
<a name="ln3423"> </a>
<a name="ln3424">      qreal oldX = x, oldY = y;</a>
<a name="ln3425"> </a>
<a name="ln3426">      if (showRect.left() &lt; r.left())</a>
<a name="ln3427">            x = showRect.left() - border;</a>
<a name="ln3428">      else if (showRect.left() &gt; r.right())</a>
<a name="ln3429">            x = showRect.right() - width() / mag() + border;</a>
<a name="ln3430">      else if (r.width() &gt;= showRect.width() &amp;&amp; showRect.right() &gt; r.right())</a>
<a name="ln3431">            x = showRect.left() - border;</a>
<a name="ln3432">      if (showRect.top() &lt; r.top() &amp;&amp; showRect.bottom() &lt; r.bottom())</a>
<a name="ln3433">            y = showRect.top() - border;</a>
<a name="ln3434">      else if (showRect.top() &gt; r.bottom())</a>
<a name="ln3435">            y = showRect.bottom() - height() / mag() + border;</a>
<a name="ln3436">      else if (r.height() &gt;= showRect.height() &amp;&amp; showRect.bottom() &gt; r.bottom())</a>
<a name="ln3437">            y = showRect.top() - border;</a>
<a name="ln3438"> </a>
<a name="ln3439">      // align to page borders if extends beyond</a>
<a name="ln3440">      Page* page = sys-&gt;page();</a>
<a name="ln3441">      if (x &lt; page-&gt;x() || r.width() &gt;= page-&gt;width())</a>
<a name="ln3442">            x = page-&gt;x();</a>
<a name="ln3443">      else if (r.width() &lt; page-&gt;width() &amp;&amp; r.width() + x &gt; page-&gt;width() + page-&gt;x())</a>
<a name="ln3444">            x = (page-&gt;width() + page-&gt;x()) - r.width();</a>
<a name="ln3445">      if (y &lt; page-&gt;y() || r.height() &gt;= page-&gt;height())</a>
<a name="ln3446">            y = page-&gt;y();</a>
<a name="ln3447">      else if (r.height() &lt; page-&gt;height() &amp;&amp; r.height() + y &gt; page-&gt;height() + page-&gt;y())</a>
<a name="ln3448">            y = (page-&gt;height() + page-&gt;y()) - r.height();</a>
<a name="ln3449"> </a>
<a name="ln3450">      // hack: don't update if we haven't changed the offset</a>
<a name="ln3451">      if (oldX == x &amp;&amp; oldY == y)</a>
<a name="ln3452">            return;</a>
<a name="ln3453"> </a>
<a name="ln3454">      setOffset(-x * mag(), -y * mag());</a>
<a name="ln3455">      update();</a>
<a name="ln3456">      }</a>
<a name="ln3457"> </a>
<a name="ln3458">//---------------------------------------------------------</a>
<a name="ln3459">//   cmdEnterRest</a>
<a name="ln3460">//---------------------------------------------------------</a>
<a name="ln3461"> </a>
<a name="ln3462">void ScoreView::cmdEnterRest()</a>
<a name="ln3463">      {</a>
<a name="ln3464">      InputState&amp; is = _score-&gt;inputState();</a>
<a name="ln3465">      if (is.track() == -1 || is.segment() == 0)          // invalid state</a>
<a name="ln3466">            return;</a>
<a name="ln3467">      if (!is.duration().isValid() || is.duration().isZero() || is.duration().isMeasure())</a>
<a name="ln3468">            is.setDuration(TDuration::DurationType::V_QUARTER);</a>
<a name="ln3469">      cmdEnterRest(is.duration());</a>
<a name="ln3470">      }</a>
<a name="ln3471"> </a>
<a name="ln3472">//---------------------------------------------------------</a>
<a name="ln3473">//   cmdEnterRest</a>
<a name="ln3474">//---------------------------------------------------------</a>
<a name="ln3475"> </a>
<a name="ln3476">void ScoreView::cmdEnterRest(const TDuration&amp; d)</a>
<a name="ln3477">      {</a>
<a name="ln3478">      if (!noteEntryMode())</a>
<a name="ln3479">            cmd(&quot;note-input&quot;);</a>
<a name="ln3480">      if (_score-&gt;usingNoteEntryMethod(NoteEntryMethod::RHYTHM))</a>
<a name="ln3481">            _score-&gt;cmd(getAction(&quot;pad-rest&quot;), editData);</a>
<a name="ln3482">      else</a>
<a name="ln3483">            _score-&gt;cmdEnterRest(d);</a>
<a name="ln3484">#if 0</a>
<a name="ln3485">      expandVoice();</a>
<a name="ln3486">      if (_is.cr() == 0) {</a>
<a name="ln3487">            qDebug(&quot;cannot enter rest here&quot;);</a>
<a name="ln3488">            return;</a>
<a name="ln3489">            }</a>
<a name="ln3490"> </a>
<a name="ln3491">      int track = _is.track;</a>
<a name="ln3492">      Segment* seg  = setNoteRest(_is.cr(), track, -1, d.fraction(), 0, AUTO);</a>
<a name="ln3493">      ChordRest* cr = static_cast&lt;ChordRest*&gt;(seg-&gt;element(track));</a>
<a name="ln3494">      if (cr)</a>
<a name="ln3495">            nextInputPos(cr, false);</a>
<a name="ln3496">      _is.rest = false;  // continue with normal note entry</a>
<a name="ln3497">#endif</a>
<a name="ln3498">      }</a>
<a name="ln3499"> </a>
<a name="ln3500">//---------------------------------------------------------</a>
<a name="ln3501">//   mscoreState</a>
<a name="ln3502">//---------------------------------------------------------</a>
<a name="ln3503"> </a>
<a name="ln3504">ScoreState ScoreView::mscoreState() const</a>
<a name="ln3505">      {</a>
<a name="ln3506">      if (fotoMode())</a>
<a name="ln3507">            return STATE_FOTO;</a>
<a name="ln3508">      if (state == ViewState::NOTE_ENTRY) {</a>
<a name="ln3509">            const InputState is = _score-&gt;inputState();</a>
<a name="ln3510">            Staff* staff = _score-&gt;staff(is.track() / VOICES);</a>
<a name="ln3511">            switch( staff-&gt;staffType(is.tick())-&gt;group()) {</a>
<a name="ln3512">                  case StaffGroup::STANDARD:</a>
<a name="ln3513">                        return STATE_NOTE_ENTRY_STAFF_PITCHED;</a>
<a name="ln3514">                  case StaffGroup::TAB:</a>
<a name="ln3515">                        return STATE_NOTE_ENTRY_STAFF_TAB;</a>
<a name="ln3516">                  case StaffGroup::PERCUSSION:</a>
<a name="ln3517">                        return STATE_NOTE_ENTRY_STAFF_DRUM;</a>
<a name="ln3518">                  }</a>
<a name="ln3519">            }</a>
<a name="ln3520">      if (state == ViewState::EDIT || state == ViewState::DRAG_EDIT) {</a>
<a name="ln3521">            if (editData.element &amp;&amp; editData.element-&gt;isLyrics())</a>
<a name="ln3522">                  return STATE_LYRICS_EDIT;</a>
<a name="ln3523">            else if (editData.element &amp;&amp;</a>
<a name="ln3524">                  ( (editData.element-&gt;isHarmony()) || editData.element-&gt;isFiguredBass()) )</a>
<a name="ln3525">                  return STATE_HARMONY_FIGBASS_EDIT;</a>
<a name="ln3526">            else if (editData.element &amp;&amp; editData.element-&gt;isTextBase())</a>
<a name="ln3527">                  return STATE_TEXT_EDIT;</a>
<a name="ln3528">            return STATE_EDIT;</a>
<a name="ln3529">            }</a>
<a name="ln3530">      if (state == ViewState::PLAY)</a>
<a name="ln3531">            return STATE_PLAY;</a>
<a name="ln3532">      return STATE_NORMAL;</a>
<a name="ln3533">      }</a>
<a name="ln3534"> </a>
<a name="ln3535">//---------------------------------------------------------</a>
<a name="ln3536">//   startUndoRedo</a>
<a name="ln3537">//---------------------------------------------------------</a>
<a name="ln3538"> </a>
<a name="ln3539">void ScoreView::startUndoRedo(bool undo)</a>
<a name="ln3540">      {</a>
<a name="ln3541">      _score-&gt;undoRedo(undo, state == ViewState::EDIT ? &amp;editData : 0);</a>
<a name="ln3542"> </a>
<a name="ln3543">      if (_score-&gt;inputState().segment())</a>
<a name="ln3544">            mscore-&gt;setPos(_score-&gt;inputState().tick());</a>
<a name="ln3545">      if (_score-&gt;noteEntryMode() &amp;&amp; !noteEntryMode())</a>
<a name="ln3546">            cmd(&quot;note-input&quot;);    // enter note entry mode</a>
<a name="ln3547">      else if (!_score-&gt;noteEntryMode() &amp;&amp; noteEntryMode())</a>
<a name="ln3548">            cmd(&quot;escape&quot;);        // leave note entry mode</a>
<a name="ln3549"> </a>
<a name="ln3550">      updateEditElement();</a>
<a name="ln3551">      }</a>
<a name="ln3552"> </a>
<a name="ln3553">//---------------------------------------------------------</a>
<a name="ln3554">//   cmdAddSlur</a>
<a name="ln3555">//    command invoked, or icon double clicked</a>
<a name="ln3556">//---------------------------------------------------------</a>
<a name="ln3557"> </a>
<a name="ln3558">void ScoreView::cmdAddSlur(const Slur* slurTemplate)</a>
<a name="ln3559">      {</a>
<a name="ln3560">      InputState&amp; is = _score-&gt;inputState();</a>
<a name="ln3561">      if (noteEntryMode() &amp;&amp; is.slur()) {</a>
<a name="ln3562">            const std::vector&lt;SpannerSegment*&gt;&amp; el = is.slur()-&gt;spannerSegments();</a>
<a name="ln3563">            if (!el.empty()) {</a>
<a name="ln3564">                  el.front()-&gt;setSelected(false);</a>
<a name="ln3565">                  // Now make sure that the slur segment is redrawn so that it does not *look* selected</a>
<a name="ln3566">                  update();</a>
<a name="ln3567">                  }</a>
<a name="ln3568">            is.setSlur(nullptr);</a>
<a name="ln3569">            return;</a>
<a name="ln3570">            }</a>
<a name="ln3571"> </a>
<a name="ln3572">      _score-&gt;startCmd();</a>
<a name="ln3573"> </a>
<a name="ln3574">      ChordRest* cr1;</a>
<a name="ln3575">      ChordRest* cr2;</a>
<a name="ln3576">      const auto&amp; sel = _score-&gt;selection();</a>
<a name="ln3577">      auto el         = sel.uniqueElements();</a>
<a name="ln3578"> </a>
<a name="ln3579">      if (sel.isRange()) {</a>
<a name="ln3580">            int startTrack = sel.staffStart() * VOICES;</a>
<a name="ln3581">            int endTrack   = sel.staffEnd() * VOICES;</a>
<a name="ln3582">            for (int track = startTrack; track &lt; endTrack; ++track) {</a>
<a name="ln3583">                  cr1 = 0;</a>
<a name="ln3584">                  cr2 = 0;</a>
<a name="ln3585">                  for (Element* e : el) {</a>
<a name="ln3586">                        if (e-&gt;track() != track)</a>
<a name="ln3587">                              continue;</a>
<a name="ln3588">                        if (e-&gt;isNote())</a>
<a name="ln3589">                              e = toNote(e)-&gt;chord();</a>
<a name="ln3590">                        if (!e-&gt;isChord())</a>
<a name="ln3591">                              continue;</a>
<a name="ln3592">                        ChordRest* cr = toChordRest(e);</a>
<a name="ln3593">                        if (!cr1 || cr1-&gt;tick() &gt; cr-&gt;tick())</a>
<a name="ln3594">                              cr1 = cr;</a>
<a name="ln3595">                        if (!cr2 || cr2-&gt;tick() &lt; cr-&gt;tick())</a>
<a name="ln3596">                              cr2 = cr;</a>
<a name="ln3597">                        }</a>
<a name="ln3598">                  if (cr1 &amp;&amp; (cr1 != cr2))</a>
<a name="ln3599">                        addSlur(cr1, cr2, slurTemplate);</a>
<a name="ln3600">                  }</a>
<a name="ln3601">            }</a>
<a name="ln3602">      else {</a>
<a name="ln3603">            cr1 = 0;</a>
<a name="ln3604">            cr2 = 0;</a>
<a name="ln3605">            for (Element* e : el) {</a>
<a name="ln3606">                  if (e-&gt;isNote())</a>
<a name="ln3607">                        e = toNote(e)-&gt;chord();</a>
<a name="ln3608">                  if (!e-&gt;isChord())</a>
<a name="ln3609">                        continue;</a>
<a name="ln3610">                  ChordRest* cr = toChordRest(e);</a>
<a name="ln3611">                  if (!cr1 || cr-&gt;isBefore(cr1))</a>
<a name="ln3612">                        cr1 = cr;</a>
<a name="ln3613">                  if (!cr2 || cr2-&gt;isBefore(cr))</a>
<a name="ln3614">                        cr2 = cr;</a>
<a name="ln3615">                  }</a>
<a name="ln3616">            if (cr1 == cr2)</a>
<a name="ln3617">                  cr2 = 0;</a>
<a name="ln3618">            if (cr1)</a>
<a name="ln3619">                  addSlur(cr1, cr2, slurTemplate);</a>
<a name="ln3620">            }</a>
<a name="ln3621">      _score-&gt;endCmd();</a>
<a name="ln3622">      }</a>
<a name="ln3623"> </a>
<a name="ln3624">//---------------------------------------------------------</a>
<a name="ln3625">//   addSlur</a>
<a name="ln3626">//---------------------------------------------------------</a>
<a name="ln3627"> </a>
<a name="ln3628">void ScoreView::addSlur(ChordRest* cr1, ChordRest* cr2, const Slur* slurTemplate)</a>
<a name="ln3629">      {</a>
<a name="ln3630">      bool switchToSlur = false;</a>
<a name="ln3631">      if (cr2 == 0) {</a>
<a name="ln3632">            cr2 = nextChordRest(cr1);</a>
<a name="ln3633">            if (cr2 == 0)</a>
<a name="ln3634">                  cr2 = cr1;</a>
<a name="ln3635">            switchToSlur = true; // select slur for editing if last chord is not given</a>
<a name="ln3636">            }</a>
<a name="ln3637"> </a>
<a name="ln3638">      Slur* slur = slurTemplate ? slurTemplate-&gt;clone() : new Slur(cr1-&gt;score());</a>
<a name="ln3639">      slur-&gt;setScore(cr1-&gt;score());</a>
<a name="ln3640">      slur-&gt;setTick(cr1-&gt;tick());</a>
<a name="ln3641">      slur-&gt;setTick2(cr2-&gt;tick());</a>
<a name="ln3642">      slur-&gt;setTrack(cr1-&gt;track());</a>
<a name="ln3643">      if (cr2-&gt;staff()-&gt;part() == cr1-&gt;staff()-&gt;part() &amp;&amp; !cr2-&gt;staff()-&gt;isLinked(cr1-&gt;staff()))</a>
<a name="ln3644">            slur-&gt;setTrack2(cr2-&gt;track());</a>
<a name="ln3645">      else</a>
<a name="ln3646">            slur-&gt;setTrack2(cr1-&gt;track());</a>
<a name="ln3647">      slur-&gt;setStartElement(cr1);</a>
<a name="ln3648">      slur-&gt;setEndElement(cr2);</a>
<a name="ln3649"> </a>
<a name="ln3650">      cr1-&gt;score()-&gt;undoAddElement(slur);</a>
<a name="ln3651">      SlurSegment* ss = new SlurSegment(cr1-&gt;score());</a>
<a name="ln3652">      ss-&gt;setSpannerSegmentType(SpannerSegmentType::SINGLE);</a>
<a name="ln3653">      if (cr1 == cr2)</a>
<a name="ln3654">            ss-&gt;setSlurOffset(Grip::END, QPointF(3.0 * cr1-&gt;score()-&gt;spatium(), 0.0));</a>
<a name="ln3655">      slur-&gt;add(ss);</a>
<a name="ln3656"> </a>
<a name="ln3657">      if (noteEntryMode()) {</a>
<a name="ln3658">            _score-&gt;inputState().setSlur(slur);</a>
<a name="ln3659">            ss-&gt;setSelected(true);</a>
<a name="ln3660">            }</a>
<a name="ln3661">      else if (switchToSlur) {</a>
<a name="ln3662">            startEditMode(ss);</a>
<a name="ln3663">            }</a>
<a name="ln3664">      }</a>
<a name="ln3665"> </a>
<a name="ln3666">//---------------------------------------------------------</a>
<a name="ln3667">//   cmdAddHairpin</a>
<a name="ln3668">//    '&lt;' typed on keyboard</a>
<a name="ln3669">//---------------------------------------------------------</a>
<a name="ln3670"> </a>
<a name="ln3671">void ScoreView::cmdAddHairpin(HairpinType type)</a>
<a name="ln3672">      {</a>
<a name="ln3673">      const Selection&amp; selection = _score-&gt;selection();</a>
<a name="ln3674">      // special case for two selected chordrests on same staff</a>
<a name="ln3675">      bool twoNotesSameStaff = false;</a>
<a name="ln3676">      if (selection.isList() &amp;&amp; selection.elements().size() == 2) {</a>
<a name="ln3677">            ChordRest* cr1 = selection.firstChordRest();</a>
<a name="ln3678">            ChordRest* cr2 = selection.lastChordRest();</a>
<a name="ln3679">            if (cr1 &amp;&amp; cr2 &amp;&amp; cr1 != cr2 &amp;&amp; cr1-&gt;staffIdx() == cr2-&gt;staffIdx())</a>
<a name="ln3680">                  twoNotesSameStaff = true;</a>
<a name="ln3681">            }</a>
<a name="ln3682">      // add hairpin on each staff if possible</a>
<a name="ln3683">      if (selection.isRange() &amp;&amp; selection.staffStart() != selection.staffEnd() - 1) {</a>
<a name="ln3684">            _score-&gt;startCmd();</a>
<a name="ln3685">            for (int staffIdx = selection.staffStart() ; staffIdx &lt; selection.staffEnd(); ++staffIdx) {</a>
<a name="ln3686">                  ChordRest* cr1 = selection.firstChordRest(staffIdx * VOICES);</a>
<a name="ln3687">                  ChordRest* cr2 = selection.lastChordRest(staffIdx * VOICES);</a>
<a name="ln3688">                  _score-&gt;addHairpin(type, cr1, cr2, /* toCr2End */ true);</a>
<a name="ln3689">                  }</a>
<a name="ln3690">            _score-&gt;endCmd();</a>
<a name="ln3691">            }</a>
<a name="ln3692">      else if (selection.isRange() || selection.isSingle() || twoNotesSameStaff) {</a>
<a name="ln3693">            // for single staff range selection, or single selection,</a>
<a name="ln3694">            // find start &amp; end elements elements</a>
<a name="ln3695">            ChordRest* cr1;</a>
<a name="ln3696">            ChordRest* cr2;</a>
<a name="ln3697">            _score-&gt;getSelectedChordRest2(&amp;cr1, &amp;cr2);</a>
<a name="ln3698">            _score-&gt;startCmd();</a>
<a name="ln3699">            Hairpin* pin = _score-&gt;addHairpin(type, cr1, cr2, /* toCr2End */ !twoNotesSameStaff);</a>
<a name="ln3700">            _score-&gt;endCmd();</a>
<a name="ln3701">            if (!pin)</a>
<a name="ln3702">                  return;</a>
<a name="ln3703"> </a>
<a name="ln3704">            const std::vector&lt;SpannerSegment*&gt;&amp; el = pin-&gt;spannerSegments();</a>
<a name="ln3705">            if (!noteEntryMode()) {</a>
<a name="ln3706">                  if (!el.empty()) {</a>
<a name="ln3707">                        startEditMode(el.front());</a>
<a name="ln3708">                        }</a>
<a name="ln3709">                  }</a>
<a name="ln3710">            }</a>
<a name="ln3711">      else {</a>
<a name="ln3712">            // do not attempt for list selection</a>
<a name="ln3713">            // or we will keep adding hairpins to the same chordrests</a>
<a name="ln3714">            return;</a>
<a name="ln3715">            }</a>
<a name="ln3716">      }</a>
<a name="ln3717"> </a>
<a name="ln3718">//---------------------------------------------------------</a>
<a name="ln3719">//   cmdAddNoteLine</a>
<a name="ln3720">//---------------------------------------------------------</a>
<a name="ln3721"> </a>
<a name="ln3722">void ScoreView::cmdAddNoteLine()</a>
<a name="ln3723">      {</a>
<a name="ln3724">      Note* firstNote = 0;</a>
<a name="ln3725">      Note* lastNote  = 0;</a>
<a name="ln3726">      if (_score-&gt;selection().isRange()) {</a>
<a name="ln3727">            int startTrack = _score-&gt;selection().staffStart() * VOICES;</a>
<a name="ln3728">            int endTrack   = _score-&gt;selection().staffEnd() * VOICES;</a>
<a name="ln3729">            for (int track = startTrack; track &lt; endTrack; ++track) {</a>
<a name="ln3730">                  for (Note* n : _score-&gt;selection().noteList(track)) {</a>
<a name="ln3731">                        if (firstNote == 0 || firstNote-&gt;chord()-&gt;tick() &gt; n-&gt;chord()-&gt;tick())</a>
<a name="ln3732">                              firstNote = n;</a>
<a name="ln3733">                        if (lastNote == 0 || lastNote-&gt;chord()-&gt;tick() &lt; n-&gt;chord()-&gt;tick())</a>
<a name="ln3734">                              lastNote = n;</a>
<a name="ln3735">                        }</a>
<a name="ln3736">                  }</a>
<a name="ln3737">            }</a>
<a name="ln3738">      else {</a>
<a name="ln3739">            for (Note* n : _score-&gt;selection().noteList()) {</a>
<a name="ln3740">                  if (firstNote == 0 || firstNote-&gt;chord()-&gt;tick() &gt; n-&gt;chord()-&gt;tick())</a>
<a name="ln3741">                        firstNote = n;</a>
<a name="ln3742">                  if (lastNote == 0 || lastNote-&gt;chord()-&gt;tick() &lt; n-&gt;chord()-&gt;tick())</a>
<a name="ln3743">                        lastNote = n;</a>
<a name="ln3744">                  }</a>
<a name="ln3745">            }</a>
<a name="ln3746">      if (!firstNote || !lastNote) {</a>
<a name="ln3747">            qDebug(&quot;addNoteLine: no note %p %p&quot;, firstNote, lastNote);</a>
<a name="ln3748">            return;</a>
<a name="ln3749">            }</a>
<a name="ln3750">      if (firstNote == lastNote) {</a>
<a name="ln3751">           qDebug(&quot;addNoteLine: no support for note to same note line %p&quot;, firstNote);</a>
<a name="ln3752">           return;</a>
<a name="ln3753">           }</a>
<a name="ln3754">      TextLine* tl = new TextLine(_score);</a>
<a name="ln3755">      tl-&gt;setParent(firstNote);</a>
<a name="ln3756">      tl-&gt;setStartElement(firstNote);</a>
<a name="ln3757">      tl-&gt;setEndElement(lastNote);</a>
<a name="ln3758">      tl-&gt;setDiagonal(true);</a>
<a name="ln3759">      tl-&gt;setAnchor(Spanner::Anchor::NOTE);</a>
<a name="ln3760">      tl-&gt;setTick(firstNote-&gt;chord()-&gt;tick());</a>
<a name="ln3761">      _score-&gt;startCmd();</a>
<a name="ln3762">      _score-&gt;undoAddElement(tl);</a>
<a name="ln3763">      _score-&gt;endCmd();</a>
<a name="ln3764">      }</a>
<a name="ln3765"> </a>
<a name="ln3766">//---------------------------------------------------------</a>
<a name="ln3767">//   cmdChangeEnharmonic</a>
<a name="ln3768">//---------------------------------------------------------</a>
<a name="ln3769"> </a>
<a name="ln3770">void ScoreView::cmdChangeEnharmonic(bool both)</a>
<a name="ln3771">      {</a>
<a name="ln3772">      _score-&gt;startCmd();</a>
<a name="ln3773">      QList&lt;Note*&gt; notes = _score-&gt;selection().uniqueNotes();</a>
<a name="ln3774">      for (Note* n : notes) {</a>
<a name="ln3775">            Staff* staff = n-&gt;staff();</a>
<a name="ln3776">            if (staff-&gt;part()-&gt;instrument()-&gt;useDrumset())</a>
<a name="ln3777">                  continue;</a>
<a name="ln3778">            if (staff-&gt;isTabStaff(n-&gt;tick())) {</a>
<a name="ln3779">                  int string = n-&gt;line() + (both ? 1 : -1);</a>
<a name="ln3780">                  int fret   = staff-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;fret(n-&gt;pitch(), string, staff, n-&gt;chord()-&gt;tick());</a>
<a name="ln3781">                  if (fret != -1) {</a>
<a name="ln3782">                        n-&gt;undoChangeProperty(Pid::FRET, fret);</a>
<a name="ln3783">                        n-&gt;undoChangeProperty(Pid::STRING, string);</a>
<a name="ln3784">                        }</a>
<a name="ln3785">                  }</a>
<a name="ln3786">            else {</a>
<a name="ln3787">                  static const int tab[36] = {</a>
<a name="ln3788">                        26, 14,  2,  // 60  B#   C   Dbb</a>
<a name="ln3789">                        21, 21,  9,  // 61  C#   C#  Db</a>
<a name="ln3790">                        28, 16,  4,  // 62  C##  D   Ebb</a>
<a name="ln3791">                        23, 23, 11,  // 63  D#   D#  Eb</a>
<a name="ln3792">                        30, 18,  6,  // 64  D##  E   Fb</a>
<a name="ln3793">                        25, 13,  1,  // 65  E#   F   Gbb</a>
<a name="ln3794">                        20, 20,  8,  // 66  F#   F#  Gb</a>
<a name="ln3795">                        27, 15,  3,  // 67  F##  G   Abb</a>
<a name="ln3796">                        22, 22, 10,  // 68  G#   G#  Ab</a>
<a name="ln3797">                        29, 17,  5,  // 69  G##  A   Bbb</a>
<a name="ln3798">                        24, 24, 12,  // 70  A#   A#  Bb</a>
<a name="ln3799">                        31, 19,  7,  // 71  A##  B   Cb</a>
<a name="ln3800">                        };</a>
<a name="ln3801">                  int tpc = n-&gt;tpc();</a>
<a name="ln3802">                  int i;</a>
<a name="ln3803">                  for (i = 0; i &lt; 36; ++i) {</a>
<a name="ln3804">                        if (tab[i] == tpc) {</a>
<a name="ln3805">                              if ((i % 3) &lt; 2) {</a>
<a name="ln3806">                                    if (tab[i] == tab[i + 1])</a>
<a name="ln3807">                                          tpc = tab[i + 2];</a>
<a name="ln3808">                                    else</a>
<a name="ln3809">                                          tpc = tab[i + 1];</a>
<a name="ln3810">                                    }</a>
<a name="ln3811">                              else {</a>
<a name="ln3812">                                    tpc = tab[i - 2];</a>
<a name="ln3813">                                    }</a>
<a name="ln3814">                              break;</a>
<a name="ln3815">                              }</a>
<a name="ln3816">                        }</a>
<a name="ln3817">                  if (i == 36) {</a>
<a name="ln3818">                        qDebug(&quot;tpc %d not found&quot;, tpc);</a>
<a name="ln3819">                        }</a>
<a name="ln3820">                  else {</a>
<a name="ln3821">                        n-&gt;undoSetTpc(tpc);</a>
<a name="ln3822">                        if (both || staff-&gt;part()-&gt;instrument(n-&gt;chord()-&gt;tick())-&gt;transpose().isZero()) {</a>
<a name="ln3823">                              // change both spellings</a>
<a name="ln3824">                              int t = n-&gt;transposeTpc(tpc);</a>
<a name="ln3825">                              if (n-&gt;concertPitch())</a>
<a name="ln3826">                                    n-&gt;undoChangeProperty(Pid::TPC2, t);</a>
<a name="ln3827">                              else</a>
<a name="ln3828">                                    n-&gt;undoChangeProperty(Pid::TPC1, t);</a>
<a name="ln3829">                              }</a>
<a name="ln3830">                        }</a>
<a name="ln3831">                  }</a>
<a name="ln3832">            }</a>
<a name="ln3833"> </a>
<a name="ln3834">      Selection&amp; selection = _score-&gt;selection();</a>
<a name="ln3835">      selection.clear();</a>
<a name="ln3836">      for (Note* n : notes)</a>
<a name="ln3837">            selection.add(n);</a>
<a name="ln3838">      _score-&gt;endCmd();</a>
<a name="ln3839">      }</a>
<a name="ln3840"> </a>
<a name="ln3841">//---------------------------------------------------------</a>
<a name="ln3842">//   cloneElement</a>
<a name="ln3843">//---------------------------------------------------------</a>
<a name="ln3844"> </a>
<a name="ln3845">void ScoreView::cloneElement(Element* e)</a>
<a name="ln3846">      {</a>
<a name="ln3847">      if (e-&gt;isMeasure() || e-&gt;isNote() || e-&gt;isVBox())</a>
<a name="ln3848">            return;</a>
<a name="ln3849">      QDrag* drag = new QDrag(this);</a>
<a name="ln3850">      QMimeData* mimeData = new QMimeData;</a>
<a name="ln3851">      if (e-&gt;isSpannerSegment())</a>
<a name="ln3852">            e = toSpannerSegment(e)-&gt;spanner();</a>
<a name="ln3853">      mimeData-&gt;setData(mimeSymbolFormat, e-&gt;mimeData(QPointF()));</a>
<a name="ln3854">      drag-&gt;setMimeData(mimeData);</a>
<a name="ln3855">      static QPixmap pixmap = QPixmap(2, 2);    // null or 1x1 crashes on Linux under ChromeOS?!</a>
<a name="ln3856">      pixmap.fill(Qt::white);</a>
<a name="ln3857">      drag-&gt;setPixmap(pixmap);</a>
<a name="ln3858">      drag-&gt;exec(Qt::CopyAction);</a>
<a name="ln3859">      }</a>
<a name="ln3860"> </a>
<a name="ln3861">//---------------------------------------------------------</a>
<a name="ln3862">//   changeEditElement</a>
<a name="ln3863">//---------------------------------------------------------</a>
<a name="ln3864"> </a>
<a name="ln3865">void ScoreView::changeEditElement(Element* e)</a>
<a name="ln3866">      {</a>
<a name="ln3867">      Grip grip = editData.curGrip;</a>
<a name="ln3868">      endEdit();</a>
<a name="ln3869">      startEdit(e, grip);</a>
<a name="ln3870">      }</a>
<a name="ln3871"> </a>
<a name="ln3872">//---------------------------------------------------------</a>
<a name="ln3873">//   setCursorVisible</a>
<a name="ln3874">//---------------------------------------------------------</a>
<a name="ln3875"> </a>
<a name="ln3876">void ScoreView::setCursorVisible(bool v)</a>
<a name="ln3877">      {</a>
<a name="ln3878">      _cursor-&gt;setVisible(v);</a>
<a name="ln3879">      }</a>
<a name="ln3880"> </a>
<a name="ln3881">//---------------------------------------------------------</a>
<a name="ln3882">//   cmdTuplet</a>
<a name="ln3883">//---------------------------------------------------------</a>
<a name="ln3884"> </a>
<a name="ln3885">void ScoreView::cmdTuplet(int n, ChordRest* cr)</a>
<a name="ln3886">      {</a>
<a name="ln3887">      if (cr-&gt;durationType() &lt; TDuration(TDuration::DurationType::V_128TH) &amp;&amp; cr-&gt;durationType() != TDuration(TDuration::DurationType::V_MEASURE)) {</a>
<a name="ln3888">            mscore-&gt;noteTooShortForTupletDialog();</a>
<a name="ln3889">            return;</a>
<a name="ln3890">            }</a>
<a name="ln3891">      Measure* measure = cr-&gt;measure();</a>
<a name="ln3892">      if (measure &amp;&amp; measure-&gt;isMMRest())</a>
<a name="ln3893">            return;</a>
<a name="ln3894"> </a>
<a name="ln3895">      Fraction f(cr-&gt;ticks());</a>
<a name="ln3896">      Tuplet* ot  = cr-&gt;tuplet();</a>
<a name="ln3897"> </a>
<a name="ln3898">      f.reduce();       //measure duration might not be reduced</a>
<a name="ln3899">      Fraction ratio(n, f.numerator());</a>
<a name="ln3900">      Fraction fr(1, f.denominator());</a>
<a name="ln3901">      while (ratio.numerator() &gt;= ratio.denominator() * 2) {</a>
<a name="ln3902">            ratio.setDenominator(ratio.denominator() * 2);  // operator*= reduces, we don't want that here</a>
<a name="ln3903">            fr    *= Fraction(1,2);</a>
<a name="ln3904">            }</a>
<a name="ln3905"> </a>
<a name="ln3906">      Tuplet* tuplet = new Tuplet(_score);</a>
<a name="ln3907">      tuplet-&gt;setRatio(ratio);</a>
<a name="ln3908"> </a>
<a name="ln3909">      //</a>
<a name="ln3910">      // &quot;fr&quot; is the fraction value of one tuple element</a>
<a name="ln3911">      //</a>
<a name="ln3912">      // &quot;tuplet time&quot; is &quot;normal time&quot; / tuplet-&gt;ratio()</a>
<a name="ln3913">      //    Example: an 1/8 has 240 midi ticks, in an 1/8 triplet the note</a>
<a name="ln3914">      //             has a tick duration of 240 / (3/2) = 160 ticks</a>
<a name="ln3915">      //</a>
<a name="ln3916"> </a>
<a name="ln3917">      tuplet-&gt;setTicks(f);</a>
<a name="ln3918">      TDuration baseLen(fr);</a>
<a name="ln3919">      tuplet-&gt;setBaseLen(baseLen);</a>
<a name="ln3920"> </a>
<a name="ln3921">      tuplet-&gt;setTrack(cr-&gt;track());</a>
<a name="ln3922">      tuplet-&gt;setTick(cr-&gt;tick());</a>
<a name="ln3923">      tuplet-&gt;setParent(measure);</a>
<a name="ln3924"> </a>
<a name="ln3925">      if (ot)</a>
<a name="ln3926">            tuplet-&gt;setTuplet(ot);</a>
<a name="ln3927"> </a>
<a name="ln3928">      cmdCreateTuplet(cr, tuplet);</a>
<a name="ln3929">      }</a>
<a name="ln3930"> </a>
<a name="ln3931">//---------------------------------------------------------</a>
<a name="ln3932">//   cmdCreateTuplet</a>
<a name="ln3933">//---------------------------------------------------------</a>
<a name="ln3934"> </a>
<a name="ln3935">void ScoreView::cmdCreateTuplet(ChordRest* cr, Tuplet* tuplet)</a>
<a name="ln3936">      {</a>
<a name="ln3937">      _score-&gt;cmdCreateTuplet(cr, tuplet);</a>
<a name="ln3938"> </a>
<a name="ln3939">      const std::vector&lt;DurationElement*&gt;&amp; cl = tuplet-&gt;elements();</a>
<a name="ln3940">      size_t ne = cl.size();</a>
<a name="ln3941">      DurationElement* el = 0;</a>
<a name="ln3942">      if (ne &amp;&amp; cl[0]-&gt;type() == ElementType::REST)</a>
<a name="ln3943">            el  = cl[0];</a>
<a name="ln3944">      else if (ne &gt; 1)</a>
<a name="ln3945">            el = cl[1];</a>
<a name="ln3946">      if (el) {</a>
<a name="ln3947">            _score-&gt;select(el, SelectType::SINGLE, 0);</a>
<a name="ln3948">            _score-&gt;inputState().setDuration(tuplet-&gt;baseLen());</a>
<a name="ln3949">            changeState(ViewState::NOTE_ENTRY);</a>
<a name="ln3950">            }</a>
<a name="ln3951">      }</a>
<a name="ln3952"> </a>
<a name="ln3953">//---------------------------------------------------------</a>
<a name="ln3954">//   changeVoice</a>
<a name="ln3955">//---------------------------------------------------------</a>
<a name="ln3956"> </a>
<a name="ln3957">void ScoreView::changeVoice(int voice)</a>
<a name="ln3958">      {</a>
<a name="ln3959">      InputState* is = &amp;score()-&gt;inputState();</a>
<a name="ln3960">      int track = (is-&gt;track() / VOICES) * VOICES + voice;</a>
<a name="ln3961"> </a>
<a name="ln3962">      if (is-&gt;noteEntryMode()) {</a>
<a name="ln3963">            is-&gt;setTrack(track);</a>
<a name="ln3964">            if (is-&gt;segment()) { // can be null for eg repeatMeasure</a>
<a name="ln3965">                  is-&gt;setSegment(is-&gt;segment()-&gt;measure()-&gt;first(SegmentType::ChordRest));</a>
<a name="ln3966">                  moveCursor();</a>
<a name="ln3967">                  score()-&gt;setUpdateAll();</a>
<a name="ln3968">                  score()-&gt;update();</a>
<a name="ln3969">                  mscore-&gt;setPos(is-&gt;segment()-&gt;tick());</a>
<a name="ln3970">                  }</a>
<a name="ln3971">            }</a>
<a name="ln3972">      else {</a>
<a name="ln3973">            // treat as command to move notes to another voice</a>
<a name="ln3974">            score()-&gt;changeVoice(voice);</a>
<a name="ln3975">            // modify the input state only if the command was successful</a>
<a name="ln3976">            for (ChordRest* cr : score()-&gt;getSelectedChordRests())</a>
<a name="ln3977">                  if (cr-&gt;voice() == voice) {</a>
<a name="ln3978">                        is-&gt;setTrack(track);</a>
<a name="ln3979">                        break;</a>
<a name="ln3980">                        }</a>
<a name="ln3981">            }</a>
<a name="ln3982">      }</a>
<a name="ln3983"> </a>
<a name="ln3984">//---------------------------------------------------------</a>
<a name="ln3985">//   cmdTuplet</a>
<a name="ln3986">//---------------------------------------------------------</a>
<a name="ln3987"> </a>
<a name="ln3988">void ScoreView::cmdTuplet(int n)</a>
<a name="ln3989">      {</a>
<a name="ln3990">      _score-&gt;startCmd();</a>
<a name="ln3991">      if (noteEntryMode()) {</a>
<a name="ln3992">            _score-&gt;expandVoice();</a>
<a name="ln3993">            ChordRest* cr = _score-&gt;inputState().cr();</a>
<a name="ln3994">            if (cr) {</a>
<a name="ln3995">                  _score-&gt;changeCRlen(cr, _score-&gt;inputState().duration());</a>
<a name="ln3996">                  cmdTuplet(n, cr);</a>
<a name="ln3997">                  }</a>
<a name="ln3998">            }</a>
<a name="ln3999">      else {</a>
<a name="ln4000">            for (ChordRest* cr : _score-&gt;getSelectedChordRests()) {</a>
<a name="ln4001">                  if (!cr-&gt;isGrace()) {</a>
<a name="ln4002">                        cmdTuplet(n, cr);</a>
<a name="ln4003">                        }</a>
<a name="ln4004">                  }</a>
<a name="ln4005">            }</a>
<a name="ln4006">      _score-&gt;endCmd();</a>
<a name="ln4007">      moveCursor();     // do this after endCmd to make sure segment has been laid out</a>
<a name="ln4008">      }</a>
<a name="ln4009"> </a>
<a name="ln4010">//---------------------------------------------------------</a>
<a name="ln4011">//   midiNoteReceived</a>
<a name="ln4012">//---------------------------------------------------------</a>
<a name="ln4013"> </a>
<a name="ln4014">void ScoreView::midiNoteReceived(int pitch, bool chord, int velocity)</a>
<a name="ln4015">      {</a>
<a name="ln4016">      qDebug(&quot;midiNoteReceived: pitch %d, chord %d, velocity %d&quot;, pitch, chord, velocity);</a>
<a name="ln4017"> </a>
<a name="ln4018">      MidiInputEvent ev;</a>
<a name="ln4019">      ev.pitch = pitch;</a>
<a name="ln4020">      ev.chord = chord;</a>
<a name="ln4021">      ev.velocity = velocity;</a>
<a name="ln4022"> </a>
<a name="ln4023">      score()-&gt;masterScore()-&gt;enqueueMidiEvent(ev);</a>
<a name="ln4024"> </a>
<a name="ln4025">      if (!score()-&gt;undoStack()-&gt;active())</a>
<a name="ln4026">            cmd((const char*)0);</a>
<a name="ln4027"> </a>
<a name="ln4028">      if (!chord &amp;&amp; velocity &amp;&amp; !realtimeTimer-&gt;isActive() &amp;&amp; score()-&gt;usingNoteEntryMethod(NoteEntryMethod::REALTIME_AUTO)) {</a>
<a name="ln4029">            // First note pressed in automatic real-time mode.</a>
<a name="ln4030">            extendNoteTimer-&gt;start(preferences.getInt(PREF_IO_MIDI_REALTIMEDELAY)); // set timer to trigger repeatedly</a>
<a name="ln4031">            triggerCmdRealtimeAdvance(); // also trigger once immediately</a>
<a name="ln4032">            }</a>
<a name="ln4033"> </a>
<a name="ln4034">      }</a>
<a name="ln4035"> </a>
<a name="ln4036">//---------------------------------------------------------</a>
<a name="ln4037">//   extendCurrentNote</a>
<a name="ln4038">//    Called after user has held down a midi key for a while.</a>
<a name="ln4039">//    TODO: adapt to allow calling from StepTime mode.</a>
<a name="ln4040">//---------------------------------------------------------</a>
<a name="ln4041"> </a>
<a name="ln4042">void ScoreView::extendCurrentNote()</a>
<a name="ln4043">      {</a>
<a name="ln4044">      if (!noteEntryMode() || realtimeTimer-&gt;isActive())</a>
<a name="ln4045">            return;</a>
<a name="ln4046"> </a>
<a name="ln4047">      allowRealtimeRests = false;</a>
<a name="ln4048">      realtimeTimer-&gt;start(preferences.getInt(PREF_IO_MIDI_REALTIMEDELAY)); // set timer to trigger repeatedly</a>
<a name="ln4049">      triggerCmdRealtimeAdvance(); // also trigger once immediately</a>
<a name="ln4050">      }</a>
<a name="ln4051"> </a>
<a name="ln4052">//---------------------------------------------------------</a>
<a name="ln4053">//   realtimeAdvance</a>
<a name="ln4054">//---------------------------------------------------------</a>
<a name="ln4055"> </a>
<a name="ln4056">void ScoreView::realtimeAdvance(bool allowRests)</a>
<a name="ln4057">      {</a>
<a name="ln4058">      if (!noteEntryMode())</a>
<a name="ln4059">            return;</a>
<a name="ln4060">      InputState&amp; is = score()-&gt;inputState();</a>
<a name="ln4061">      switch (is.noteEntryMethod()) {</a>
<a name="ln4062">            case NoteEntryMethod::REALTIME_MANUAL:</a>
<a name="ln4063">                  allowRealtimeRests = allowRests;</a>
<a name="ln4064">                  triggerCmdRealtimeAdvance();</a>
<a name="ln4065">                  break;</a>
<a name="ln4066">            case NoteEntryMethod::REALTIME_AUTO:</a>
<a name="ln4067">                  if (realtimeTimer-&gt;isActive())</a>
<a name="ln4068">                        realtimeTimer-&gt;stop();</a>
<a name="ln4069">                  else {</a>
<a name="ln4070">                        allowRealtimeRests = allowRests;</a>
<a name="ln4071">                        realtimeTimer-&gt;start(preferences.getInt(PREF_IO_MIDI_REALTIMEDELAY));</a>
<a name="ln4072">                        }</a>
<a name="ln4073">                  break;</a>
<a name="ln4074">            default:</a>
<a name="ln4075">                  break;</a>
<a name="ln4076">            }</a>
<a name="ln4077">      }</a>
<a name="ln4078"> </a>
<a name="ln4079">//---------------------------------------------------------</a>
<a name="ln4080">//   triggerCmdRealtimeAdvance</a>
<a name="ln4081">//---------------------------------------------------------</a>
<a name="ln4082"> </a>
<a name="ln4083">void ScoreView::triggerCmdRealtimeAdvance()</a>
<a name="ln4084">      {</a>
<a name="ln4085">      InputState&amp; is = score()-&gt;inputState();</a>
<a name="ln4086">      bool realtime = is.usingNoteEntryMethod(NoteEntryMethod::REALTIME_AUTO) || is.usingNoteEntryMethod(NoteEntryMethod::REALTIME_MANUAL);</a>
<a name="ln4087">      if (!realtime || !noteEntryMode() || (!allowRealtimeRests &amp;&amp; score()-&gt;activeMidiPitches()-&gt;empty())) {</a>
<a name="ln4088">            if (realtimeTimer-&gt;isActive())</a>
<a name="ln4089">                  realtimeTimer-&gt;stop();</a>
<a name="ln4090">            allowRealtimeRests = true;</a>
<a name="ln4091">            return;</a>
<a name="ln4092">            }</a>
<a name="ln4093">      // give audible feedback immediately to indicate a beat, but don’t advance just yet.</a>
<a name="ln4094">      seq-&gt;playMetronomeBeat(_score-&gt;tick2beatType(is.tick()));</a>
<a name="ln4095">      // The user will want to press notes &quot;on the beat&quot; and not before the beat, so wait a</a>
<a name="ln4096">      // little in case midi input event is received just after realtime-advance was called.</a>
<a name="ln4097">      QTimer::singleShot(100, Qt::PreciseTimer, this, SLOT(cmdRealtimeAdvance()));</a>
<a name="ln4098">      }</a>
<a name="ln4099"> </a>
<a name="ln4100">//---------------------------------------------------------</a>
<a name="ln4101">//   cmdRealtimeAdvance</a>
<a name="ln4102">//    move input forwards and extend current chord/rest.</a>
<a name="ln4103">//---------------------------------------------------------</a>
<a name="ln4104"> </a>
<a name="ln4105">void ScoreView::cmdRealtimeAdvance()</a>
<a name="ln4106">      {</a>
<a name="ln4107">      InputState&amp; is = _score-&gt;inputState();</a>
<a name="ln4108">      if (!is.noteEntryMode())</a>
<a name="ln4109">            return;</a>
<a name="ln4110">      _score-&gt;startCmd();</a>
<a name="ln4111">      Fraction ticks2measureEnd = is.segment()-&gt;measure()-&gt;ticks() - is.segment()-&gt;rtick();</a>
<a name="ln4112">      if (!is.cr() || (is.cr()-&gt;ticks() != is.duration().fraction() &amp;&amp; is.duration() &lt; ticks2measureEnd))</a>
<a name="ln4113">            _score-&gt;setNoteRest(is.segment(), is.track(), NoteVal(), is.duration().fraction(), Direction::AUTO);</a>
<a name="ln4114">      ChordRest* prevCR = toChordRest(is.cr());</a>
<a name="ln4115">      is.moveToNextInputPos();</a>
<a name="ln4116">      if (_score-&gt;activeMidiPitches()-&gt;empty())</a>
<a name="ln4117">            _score-&gt;setNoteRest(is.segment(), is.track(), NoteVal(), is.duration().fraction(), Direction::AUTO);</a>
<a name="ln4118">      else {</a>
<a name="ln4119">            Chord* prevChord = prevCR-&gt;isChord() ? toChord(prevCR) : 0;</a>
<a name="ln4120">            bool partOfChord = false;</a>
<a name="ln4121">            for (const MidiInputEvent &amp;ev : *_score-&gt;activeMidiPitches()) {</a>
<a name="ln4122">                  _score-&gt;addTiedMidiPitch(ev.pitch, partOfChord, prevChord);</a>
<a name="ln4123">                  partOfChord = true;</a>
<a name="ln4124">                  }</a>
<a name="ln4125">            }</a>
<a name="ln4126">      if (prevCR-&gt;measure() != is.segment()-&gt;measure()) {</a>
<a name="ln4127">            // just advanced across barline. Now simplify tied notes.</a>
<a name="ln4128">            score()-&gt;regroupNotesAndRests(prevCR-&gt;measure()-&gt;tick(), is.segment()-&gt;measure()-&gt;tick(), is.track());</a>
<a name="ln4129">            }</a>
<a name="ln4130">      _score-&gt;endCmd();</a>
<a name="ln4131">      }</a>
<a name="ln4132"> </a>
<a name="ln4133">//---------------------------------------------------------</a>
<a name="ln4134">//   cmdAddChordName</a>
<a name="ln4135">//---------------------------------------------------------</a>
<a name="ln4136"> </a>
<a name="ln4137">void ScoreView::cmdAddChordName(HarmonyType ht)</a>
<a name="ln4138">      {</a>
<a name="ln4139">      if (!_score-&gt;checkHasMeasures())</a>
<a name="ln4140">            return;</a>
<a name="ln4141"> </a>
<a name="ln4142">      int track = -1;</a>
<a name="ln4143">      Element* newParent = nullptr;</a>
<a name="ln4144">      Element* el = _score-&gt;selection().element();</a>
<a name="ln4145">      if (el &amp;&amp; el-&gt;isFretDiagram()) {</a>
<a name="ln4146">            FretDiagram* fd = toFretDiagram(el);</a>
<a name="ln4147">            track = fd-&gt;track();</a>
<a name="ln4148">            newParent = fd;</a>
<a name="ln4149">            }</a>
<a name="ln4150">      else {</a>
<a name="ln4151">            ChordRest* cr = _score-&gt;getSelectedChordRest();</a>
<a name="ln4152">            if (cr) {</a>
<a name="ln4153">                  track = cr-&gt;track();</a>
<a name="ln4154">                  newParent = toElement(cr-&gt;segment());</a>
<a name="ln4155">                  }</a>
<a name="ln4156">            }</a>
<a name="ln4157">      if (track == -1 || !newParent)</a>
<a name="ln4158">            return;</a>
<a name="ln4159"> </a>
<a name="ln4160">      _score-&gt;startCmd();</a>
<a name="ln4161">      Harmony* harmony = new Harmony(_score);</a>
<a name="ln4162">      harmony-&gt;setTrack(track);</a>
<a name="ln4163">      harmony-&gt;setParent(newParent);</a>
<a name="ln4164">      harmony-&gt;setHarmonyType(ht);</a>
<a name="ln4165">      _score-&gt;undoAddElement(harmony);</a>
<a name="ln4166">      _score-&gt;endCmd();</a>
<a name="ln4167"> </a>
<a name="ln4168">      _score-&gt;select(harmony, SelectType::SINGLE, 0);</a>
<a name="ln4169">      startEditMode(harmony);</a>
<a name="ln4170">      _score-&gt;update();</a>
<a name="ln4171">      }</a>
<a name="ln4172"> </a>
<a name="ln4173">//---------------------------------------------------------</a>
<a name="ln4174">//   cmdAddText</a>
<a name="ln4175">//---------------------------------------------------------</a>
<a name="ln4176"> </a>
<a name="ln4177">void ScoreView::cmdAddText(Tid tid, Tid customTid)</a>
<a name="ln4178">      {</a>
<a name="ln4179">      if (!_score-&gt;checkHasMeasures())</a>
<a name="ln4180">            return;</a>
<a name="ln4181">      if (noteEntryMode())          // force out of entry mode</a>
<a name="ln4182">            changeState(ViewState::NORMAL);</a>
<a name="ln4183"> </a>
<a name="ln4184">      TextBase* s = 0;</a>
<a name="ln4185">      _score-&gt;startCmd();</a>
<a name="ln4186">      if (tid == Tid::STAFF &amp;&amp; customTid == Tid::EXPRESSION)</a>
<a name="ln4187">            tid = customTid;  // expression is not first class element, but treat as such</a>
<a name="ln4188">      switch (tid) {</a>
<a name="ln4189">            case Tid::TITLE:</a>
<a name="ln4190">            case Tid::SUBTITLE:</a>
<a name="ln4191">            case Tid::COMPOSER:</a>
<a name="ln4192">            case Tid::POET:</a>
<a name="ln4193">            case Tid::INSTRUMENT_EXCERPT:</a>
<a name="ln4194">                  {</a>
<a name="ln4195">                  MeasureBase* measure = _score-&gt;first();</a>
<a name="ln4196">                  if (!measure-&gt;isVBox()) {</a>
<a name="ln4197">                        _score-&gt;insertMeasure(ElementType::VBOX, measure);</a>
<a name="ln4198">                        measure = measure-&gt;prev();</a>
<a name="ln4199">                        }</a>
<a name="ln4200">                  s = new Text(_score, tid);</a>
<a name="ln4201">                  s-&gt;setParent(measure);</a>
<a name="ln4202">                  _score-&gt;undoAddElement(s);</a>
<a name="ln4203">                  }</a>
<a name="ln4204">                  break;</a>
<a name="ln4205"> </a>
<a name="ln4206">            case Tid::REHEARSAL_MARK:</a>
<a name="ln4207">                  {</a>
<a name="ln4208">                  ChordRest* cr = _score-&gt;getSelectedChordRest();</a>
<a name="ln4209">                  if (!cr)</a>
<a name="ln4210">                        break;</a>
<a name="ln4211">                  s = new RehearsalMark(_score);</a>
<a name="ln4212">                  cr-&gt;undoAddAnnotation(s);</a>
<a name="ln4213">                  }</a>
<a name="ln4214">                  break;</a>
<a name="ln4215">            case Tid::STAFF:</a>
<a name="ln4216">                  {</a>
<a name="ln4217">                  ChordRest* cr = _score-&gt;getSelectedChordRest();</a>
<a name="ln4218">                  if (!cr)</a>
<a name="ln4219">                        break;</a>
<a name="ln4220">                  s = new StaffText(_score, Tid::STAFF);</a>
<a name="ln4221">                  cr-&gt;undoAddAnnotation(s);</a>
<a name="ln4222">                  }</a>
<a name="ln4223">                  break;</a>
<a name="ln4224">            case Tid::SYSTEM:</a>
<a name="ln4225">                  {</a>
<a name="ln4226">                  ChordRest* cr = _score-&gt;getSelectedChordRest();</a>
<a name="ln4227">                  if (!cr)</a>
<a name="ln4228">                        break;</a>
<a name="ln4229">                  s = new SystemText(_score, Tid::SYSTEM);</a>
<a name="ln4230">                  cr-&gt;undoAddAnnotation(s);</a>
<a name="ln4231">                  }</a>
<a name="ln4232">                  break;</a>
<a name="ln4233">            case Tid::EXPRESSION:</a>
<a name="ln4234">                  {</a>
<a name="ln4235">                  ChordRest* cr = _score-&gt;getSelectedChordRest();</a>
<a name="ln4236">                  if (!cr)</a>
<a name="ln4237">                        break;</a>
<a name="ln4238">                  s = new StaffText(_score, Tid::EXPRESSION);</a>
<a name="ln4239">                  s-&gt;setPlacement(Placement::BELOW);</a>
<a name="ln4240">                  s-&gt;setPropertyFlags(Pid::PLACEMENT, PropertyFlags::UNSTYLED);</a>
<a name="ln4241">                  cr-&gt;undoAddAnnotation(s);</a>
<a name="ln4242">                  }</a>
<a name="ln4243">                  break;</a>
<a name="ln4244">            case Tid::INSTRUMENT_CHANGE:</a>
<a name="ln4245">                  {</a>
<a name="ln4246">                  ChordRest* cr = _score-&gt;getSelectedChordRest();</a>
<a name="ln4247">                  if (!cr)</a>
<a name="ln4248">                        break;</a>
<a name="ln4249">                  s = new InstrumentChange(_score);</a>
<a name="ln4250">                  cr-&gt;undoAddAnnotation(s);</a>
<a name="ln4251">                  }</a>
<a name="ln4252">                  break;</a>
<a name="ln4253">            case Tid::STICKING:</a>
<a name="ln4254">                  {</a>
<a name="ln4255">                  ChordRest* cr = _score-&gt;getSelectedChordRest();</a>
<a name="ln4256">                  if (!cr)</a>
<a name="ln4257">                        break;</a>
<a name="ln4258">                  s = new Sticking(_score);</a>
<a name="ln4259">                  cr-&gt;undoAddAnnotation(s);</a>
<a name="ln4260">                  }</a>
<a name="ln4261">                  break;</a>
<a name="ln4262">            case Tid::FINGERING:</a>
<a name="ln4263">            case Tid::LH_GUITAR_FINGERING:</a>
<a name="ln4264">            case Tid::RH_GUITAR_FINGERING:</a>
<a name="ln4265">            case Tid::STRING_NUMBER:</a>
<a name="ln4266">                  {</a>
<a name="ln4267">                  Element* e = _score-&gt;getSelectedElement();</a>
<a name="ln4268">                  if (!e || !e-&gt;isNote())</a>
<a name="ln4269">                        break;</a>
<a name="ln4270">                  bool isTablature = e-&gt;staff()-&gt;isTabStaff(e-&gt;tick());</a>
<a name="ln4271">                  bool tabFingering = e-&gt;staff()-&gt;staffType(e-&gt;tick())-&gt;showTabFingering();</a>
<a name="ln4272">                  if (isTablature &amp;&amp; !tabFingering)</a>
<a name="ln4273">                        break;</a>
<a name="ln4274">                  s = new Fingering(_score, tid);</a>
<a name="ln4275">                  s-&gt;setTrack(e-&gt;track());</a>
<a name="ln4276">                  s-&gt;setParent(e);</a>
<a name="ln4277">                  _score-&gt;undoAddElement(s);</a>
<a name="ln4278">                  }</a>
<a name="ln4279">                  break;</a>
<a name="ln4280">            default:</a>
<a name="ln4281">                  break;</a>
<a name="ln4282">            }</a>
<a name="ln4283"> </a>
<a name="ln4284">      if (s) {</a>
<a name="ln4285">            if (customTid != Tid::DEFAULT &amp;&amp; customTid != tid)</a>
<a name="ln4286">                  s-&gt;initTid(customTid);</a>
<a name="ln4287">            _score-&gt;select(s, SelectType::SINGLE, 0);</a>
<a name="ln4288">            _score-&gt;endCmd();</a>
<a name="ln4289">            Measure* m = s-&gt;findMeasure();</a>
<a name="ln4290">            if (m &amp;&amp; m-&gt;hasMMRest() &amp;&amp; s-&gt;links()) {</a>
<a name="ln4291">                  Measure* mmRest = m-&gt;mmRest();</a>
<a name="ln4292">                  for (ScoreElement* se : *s-&gt;links()) {</a>
<a name="ln4293">                        TextBase* s1 = toTextBase(se);</a>
<a name="ln4294">                        if (s != s1 &amp;&amp; s1-&gt;findMeasure() == mmRest) {</a>
<a name="ln4295">                              s = s1;</a>
<a name="ln4296">                              break;</a>
<a name="ln4297">                              }</a>
<a name="ln4298">                        }</a>
<a name="ln4299">                  }</a>
<a name="ln4300">            adjustCanvasPosition(s, false);</a>
<a name="ln4301">            startEditMode(s);</a>
<a name="ln4302">            }</a>
<a name="ln4303">      else</a>
<a name="ln4304">            _score-&gt;endCmd();</a>
<a name="ln4305">      }</a>
<a name="ln4306"> </a>
<a name="ln4307">//---------------------------------------------------------</a>
<a name="ln4308">//   cmdAppendMeasures</a>
<a name="ln4309">///   Append \a n measures.</a>
<a name="ln4310">///</a>
<a name="ln4311">///   Keyboard callback, called from pulldown menu.</a>
<a name="ln4312">//</a>
<a name="ln4313">//    - called from pulldown menu</a>
<a name="ln4314">//---------------------------------------------------------</a>
<a name="ln4315"> </a>
<a name="ln4316">void ScoreView::cmdAppendMeasures(int n, ElementType type)</a>
<a name="ln4317">      {</a>
<a name="ln4318">      _score-&gt;startCmd();</a>
<a name="ln4319">      appendMeasures(n, type);</a>
<a name="ln4320">      _score-&gt;endCmd();</a>
<a name="ln4321">      }</a>
<a name="ln4322"> </a>
<a name="ln4323">//---------------------------------------------------------</a>
<a name="ln4324">//   appendMeasure</a>
<a name="ln4325">//---------------------------------------------------------</a>
<a name="ln4326"> </a>
<a name="ln4327">MeasureBase* ScoreView::appendMeasure(ElementType type)</a>
<a name="ln4328">      {</a>
<a name="ln4329">      _score-&gt;startCmd();</a>
<a name="ln4330">      _score-&gt;insertMeasure(type, 0);</a>
<a name="ln4331">      MeasureBase* mb = _score-&gt;lastMeasureMM();</a>
<a name="ln4332">      _score-&gt;endCmd();</a>
<a name="ln4333">      return mb;</a>
<a name="ln4334">      }</a>
<a name="ln4335"> </a>
<a name="ln4336">//---------------------------------------------------------</a>
<a name="ln4337">//   appendMeasures</a>
<a name="ln4338">//---------------------------------------------------------</a>
<a name="ln4339"> </a>
<a name="ln4340">void ScoreView::appendMeasures(int n, ElementType type)</a>
<a name="ln4341">      {</a>
<a name="ln4342">      if (_score-&gt;noStaves()) {</a>
<a name="ln4343">            QMessageBox::warning(0, &quot;MuseScore&quot;,</a>
<a name="ln4344">               tr(&quot;No staves found:\n&quot;</a>
<a name="ln4345">                  &quot;please use the instruments dialog to\n&quot;</a>
<a name="ln4346">                  &quot;first create some staves&quot;));</a>
<a name="ln4347">            return;</a>
<a name="ln4348">            }</a>
<a name="ln4349">      for (int i = 0; i &lt; n; ++i)</a>
<a name="ln4350">            _score-&gt;insertMeasure(type, 0);</a>
<a name="ln4351">      }</a>
<a name="ln4352"> </a>
<a name="ln4353">//---------------------------------------------------------</a>
<a name="ln4354">//   cmdInsertMeasures</a>
<a name="ln4355">//---------------------------------------------------------</a>
<a name="ln4356"> </a>
<a name="ln4357">void ScoreView::cmdInsertMeasures(int n, ElementType type)</a>
<a name="ln4358">      {</a>
<a name="ln4359">      MeasureBase* mb = checkSelectionStateForInsertMeasure();</a>
<a name="ln4360">      if (!mb)</a>
<a name="ln4361">            return;</a>
<a name="ln4362">      _score-&gt;startCmd();</a>
<a name="ln4363">      for (int i = 0; i &lt; n; ++i)</a>
<a name="ln4364">            _score-&gt;insertMeasure(type, mb);</a>
<a name="ln4365">      _score-&gt;endCmd();</a>
<a name="ln4366"> </a>
<a name="ln4367">      if (mb-&gt;type() == ElementType::MEASURE) {</a>
<a name="ln4368">            // re-select the original measure (which may now be covered by an mmrest)</a>
<a name="ln4369">            // do this after the layout so mmrests are updated</a>
<a name="ln4370">            Measure* m = _score-&gt;tick2measureMM(mb-&gt;tick());</a>
<a name="ln4371">            _score-&gt;select(m, SelectType::SINGLE, 0);</a>
<a name="ln4372">            }</a>
<a name="ln4373">      else {</a>
<a name="ln4374">            // original selection was not a measure, just re-select it</a>
<a name="ln4375">            _score-&gt;select(mb, SelectType::SINGLE, 0);</a>
<a name="ln4376">            }</a>
<a name="ln4377">      }</a>
<a name="ln4378"> </a>
<a name="ln4379">//---------------------------------------------------------</a>
<a name="ln4380">//   cmdInsertMeasure</a>
<a name="ln4381">//---------------------------------------------------------</a>
<a name="ln4382"> </a>
<a name="ln4383">void ScoreView::cmdInsertMeasure(ElementType type)</a>
<a name="ln4384">      {</a>
<a name="ln4385">      MeasureBase* mb = checkSelectionStateForInsertMeasure();</a>
<a name="ln4386">      if (!mb)</a>
<a name="ln4387">            return;</a>
<a name="ln4388">      _score-&gt;startCmd();</a>
<a name="ln4389">      _score-&gt;insertMeasure(type, mb);</a>
<a name="ln4390">      mb = mb-&gt;prev();</a>
<a name="ln4391">      if (mb-&gt;type() == ElementType::TBOX) {</a>
<a name="ln4392">            TBox* tbox = static_cast&lt;TBox*&gt;(mb);</a>
<a name="ln4393">            Text* s = tbox-&gt;text();</a>
<a name="ln4394">            _score-&gt;select(s, SelectType::SINGLE, 0);</a>
<a name="ln4395">            _score-&gt;endCmd();</a>
<a name="ln4396">            startEditMode(s);</a>
<a name="ln4397">            return;</a>
<a name="ln4398">            }</a>
<a name="ln4399">      if (mb)</a>
<a name="ln4400">           _score-&gt;select(mb, SelectType::SINGLE, 0);</a>
<a name="ln4401">      _score-&gt;endCmd();</a>
<a name="ln4402">      }</a>
<a name="ln4403"> </a>
<a name="ln4404">//---------------------------------------------------------</a>
<a name="ln4405">//   checkSelectionStateForInsertMeasure</a>
<a name="ln4406">//---------------------------------------------------------</a>
<a name="ln4407"> </a>
<a name="ln4408">MeasureBase* ScoreView::checkSelectionStateForInsertMeasure()</a>
<a name="ln4409">      {</a>
<a name="ln4410">      MeasureBase* mb = 0;</a>
<a name="ln4411">      if (_score-&gt;selection().isRange()) {</a>
<a name="ln4412">            mb = _score-&gt;selection().startSegment()-&gt;measure();</a>
<a name="ln4413">            return mb;</a>
<a name="ln4414">            }</a>
<a name="ln4415"> </a>
<a name="ln4416">      mb = _score-&gt;selection().findMeasure();</a>
<a name="ln4417">      if (mb)</a>
<a name="ln4418">            return mb;</a>
<a name="ln4419"> </a>
<a name="ln4420">      Element* e = _score-&gt;selection().element();</a>
<a name="ln4421">      if (e) {</a>
<a name="ln4422">            if (e-&gt;type() == ElementType::VBOX || e-&gt;type() == ElementType::TBOX || e-&gt;type() == ElementType::HBOX)</a>
<a name="ln4423">                  return static_cast&lt;MeasureBase*&gt;(e);</a>
<a name="ln4424">            }</a>
<a name="ln4425">      QMessageBox::warning(0, &quot;MuseScore&quot;,</a>
<a name="ln4426">            tr(&quot;No measure selected:\n&quot; &quot;Please select a measure and try again&quot;));</a>
<a name="ln4427">      return 0;</a>
<a name="ln4428">      }</a>
<a name="ln4429"> </a>
<a name="ln4430">//---------------------------------------------------------</a>
<a name="ln4431">//   cmdRepeatSelection</a>
<a name="ln4432">//---------------------------------------------------------</a>
<a name="ln4433"> </a>
<a name="ln4434">void ScoreView::cmdRepeatSelection()</a>
<a name="ln4435">      {</a>
<a name="ln4436">      const Selection&amp; selection = _score-&gt;selection();</a>
<a name="ln4437"> </a>
<a name="ln4438">      if (noteEntryMode() &amp;&amp; selection.isSingle()) {</a>
<a name="ln4439">            Element* el = _score-&gt;selection().element();</a>
<a name="ln4440">            if (el &amp;&amp; el-&gt;type() == ElementType::NOTE) {</a>
<a name="ln4441">                  if (!_score-&gt;inputState().endOfScore()) {</a>
<a name="ln4442">                        _score-&gt;startCmd();</a>
<a name="ln4443">                        bool addTo = false;</a>
<a name="ln4444">                        Chord* c = static_cast&lt;Note*&gt;(el)-&gt;chord();</a>
<a name="ln4445">                        for (Note* note : c-&gt;notes()) {</a>
<a name="ln4446">                              NoteVal nval = note-&gt;noteVal();</a>
<a name="ln4447">                              _score-&gt;addPitch(nval, addTo);</a>
<a name="ln4448">                              addTo = true;</a>
<a name="ln4449">                              }</a>
<a name="ln4450">                        _score-&gt;endCmd();</a>
<a name="ln4451">                        }</a>
<a name="ln4452">                  }</a>
<a name="ln4453">            return;</a>
<a name="ln4454">            }</a>
<a name="ln4455">      if (!selection.isRange()) {</a>
<a name="ln4456">            qDebug(&quot;wrong selection type&quot;);</a>
<a name="ln4457">            return;</a>
<a name="ln4458">            }</a>
<a name="ln4459"> </a>
<a name="ln4460">      if (!checkCopyOrCut())</a>
<a name="ln4461">            return;</a>
<a name="ln4462"> </a>
<a name="ln4463">      QString mimeType = selection.mimeType();</a>
<a name="ln4464">      if (mimeType.isEmpty()) {</a>
<a name="ln4465">            qDebug(&quot;mime type is empty&quot;);</a>
<a name="ln4466">            return;</a>
<a name="ln4467">            }</a>
<a name="ln4468">      QMimeData* mimeData = new QMimeData;</a>
<a name="ln4469">      mimeData-&gt;setData(mimeType, selection.mimeData());</a>
<a name="ln4470">      if (MScore::debugMode)</a>
<a name="ln4471">            qDebug(&quot;cmdRepeatSelection: &lt;%s&gt;&quot;, mimeData-&gt;data(mimeType).data());</a>
<a name="ln4472">      QApplication::clipboard()-&gt;setMimeData(mimeData);</a>
<a name="ln4473"> </a>
<a name="ln4474">      QByteArray d(mimeData-&gt;data(mimeType));</a>
<a name="ln4475">      XmlReader xml(d);</a>
<a name="ln4476">      xml.setPasteMode(true);</a>
<a name="ln4477"> </a>
<a name="ln4478">      int dStaff = selection.staffStart();</a>
<a name="ln4479">      Segment* endSegment = selection.endSegment();</a>
<a name="ln4480"> </a>
<a name="ln4481">      if (endSegment &amp;&amp; endSegment-&gt;segmentType() != SegmentType::ChordRest)</a>
<a name="ln4482">            endSegment = endSegment-&gt;next1(SegmentType::ChordRest);</a>
<a name="ln4483">      if (endSegment &amp;&amp; endSegment-&gt;element(dStaff * VOICES)) {</a>
<a name="ln4484">            Element* e = endSegment-&gt;element(dStaff * VOICES);</a>
<a name="ln4485">            if (e) {</a>
<a name="ln4486">                  ChordRest* cr = toChordRest(e);</a>
<a name="ln4487">                  _score-&gt;startCmd();</a>
<a name="ln4488">                  _score-&gt;pasteStaff(xml, cr-&gt;segment(), cr-&gt;staffIdx());</a>
<a name="ln4489">                  _score-&gt;endCmd();</a>
<a name="ln4490">                  }</a>
<a name="ln4491">            else</a>
<a name="ln4492">                  qDebug(&quot;ScoreView::cmdRepeatSelection: cannot paste: %p &lt;%s&gt;&quot;, e, e ? e-&gt;name() : &quot;&quot;);</a>
<a name="ln4493">            }</a>
<a name="ln4494">      else {</a>
<a name="ln4495">            qDebug(&quot;cmdRepeatSelection: cannot paste: endSegment: %p dStaff %d&quot;, endSegment, dStaff);</a>
<a name="ln4496">            }</a>
<a name="ln4497">      }</a>
<a name="ln4498"> </a>
<a name="ln4499">//---------------------------------------------------------</a>
<a name="ln4500">//   searchPage</a>
<a name="ln4501">//---------------------------------------------------------</a>
<a name="ln4502"> </a>
<a name="ln4503">bool ScoreView::searchPage(int n)</a>
<a name="ln4504">      {</a>
<a name="ln4505">      bool result = true;</a>
<a name="ln4506">      n -= score()-&gt;pageNumberOffset();</a>
<a name="ln4507">      if (n &lt;= 0) {</a>
<a name="ln4508">            n = 1;</a>
<a name="ln4509">            result = false;</a>
<a name="ln4510">            }</a>
<a name="ln4511">      n--;</a>
<a name="ln4512">      if (n &gt;= _score-&gt;npages()) {</a>
<a name="ln4513">            result = false;</a>
<a name="ln4514">            n = _score-&gt;npages() - 1;</a>
<a name="ln4515">            }</a>
<a name="ln4516">      const Page* page = _score-&gt;pages()[n];</a>
<a name="ln4517">      foreach (System* s, page-&gt;systems()) {</a>
<a name="ln4518">            if (s-&gt;firstMeasure()) {</a>
<a name="ln4519">                  gotoMeasure(s-&gt;firstMeasure());</a>
<a name="ln4520">                  break;</a>
<a name="ln4521">                  }</a>
<a name="ln4522">            }</a>
<a name="ln4523">      return result;</a>
<a name="ln4524">      }</a>
<a name="ln4525"> </a>
<a name="ln4526">//---------------------------------------------------------</a>
<a name="ln4527">//   searchMeasure</a>
<a name="ln4528">//---------------------------------------------------------</a>
<a name="ln4529"> </a>
<a name="ln4530">bool ScoreView::searchMeasure(int n)</a>
<a name="ln4531">      {</a>
<a name="ln4532">      if (n &lt;= 0)</a>
<a name="ln4533">            return false;</a>
<a name="ln4534">      bool result = true;</a>
<a name="ln4535">      --n;</a>
<a name="ln4536">      int i = 0;</a>
<a name="ln4537">      Measure* measure;</a>
<a name="ln4538">      for (measure = _score-&gt;firstMeasureMM(); measure; measure = measure-&gt;nextMeasureMM()) {</a>
<a name="ln4539">            int nn = _score-&gt;styleB(Sid::createMultiMeasureRests) &amp;&amp; measure-&gt;isMMRest()</a>
<a name="ln4540">               ? measure-&gt;mmRestCount() : 1;</a>
<a name="ln4541">            if (n &gt;= i &amp;&amp; n &lt; (i+nn))</a>
<a name="ln4542">                  break;</a>
<a name="ln4543">            i += nn;</a>
<a name="ln4544">            }</a>
<a name="ln4545">      if (!measure) {</a>
<a name="ln4546">            measure = score()-&gt;lastMeasureMM();</a>
<a name="ln4547">            result = false;</a>
<a name="ln4548">            }</a>
<a name="ln4549">      gotoMeasure(measure);</a>
<a name="ln4550">      return result;</a>
<a name="ln4551">      }</a>
<a name="ln4552"> </a>
<a name="ln4553">//---------------------------------------------------------</a>
<a name="ln4554">//   searchRehearsalMark</a>
<a name="ln4555">//---------------------------------------------------------</a>
<a name="ln4556"> </a>
<a name="ln4557">bool ScoreView::searchRehearsalMark(const QString&amp; s)</a>
<a name="ln4558">      {</a>
<a name="ln4559">      //search rehearsal marks</a>
<a name="ln4560">      QString ss = s.toLower();</a>
<a name="ln4561">      bool found = false;</a>
<a name="ln4562">      for (Segment* seg = score()-&gt;firstSegment(SegmentType::ChordRest); seg; seg = seg-&gt;next1(SegmentType::ChordRest)) {</a>
<a name="ln4563">            for (Element* e : seg-&gt;annotations()){</a>
<a name="ln4564">                  if (e-&gt;type() == ElementType::REHEARSAL_MARK) {</a>
<a name="ln4565">                        RehearsalMark* rm = static_cast&lt;RehearsalMark*&gt;(e);</a>
<a name="ln4566">                        QString rms = rm-&gt;plainText().toLower();</a>
<a name="ln4567">                        if (rms.startsWith(ss)) {</a>
<a name="ln4568">                              gotoMeasure(seg-&gt;measure());</a>
<a name="ln4569">                              found = true;</a>
<a name="ln4570">                              break;</a>
<a name="ln4571">                              }</a>
<a name="ln4572">                        }</a>
<a name="ln4573">                  }</a>
<a name="ln4574">            if (found)</a>
<a name="ln4575">                  break;</a>
<a name="ln4576">            }</a>
<a name="ln4577">      return found;</a>
<a name="ln4578">      }</a>
<a name="ln4579"> </a>
<a name="ln4580">//---------------------------------------------------------</a>
<a name="ln4581">//   gotoMeasure</a>
<a name="ln4582">//---------------------------------------------------------</a>
<a name="ln4583"> </a>
<a name="ln4584">void ScoreView::gotoMeasure(Measure* measure)</a>
<a name="ln4585">      {</a>
<a name="ln4586">      adjustCanvasPosition(measure, state != ViewState::NORMAL);</a>
<a name="ln4587">      int tracks = _score-&gt;nstaves() * VOICES;</a>
<a name="ln4588">      for (Segment* segment = measure-&gt;first(); segment; segment = segment-&gt;next()) {</a>
<a name="ln4589">            if (segment-&gt;segmentType() != SegmentType::ChordRest)</a>
<a name="ln4590">                  continue;</a>
<a name="ln4591">            int track;</a>
<a name="ln4592">            for (track = 0; track &lt; tracks; ++track) {</a>
<a name="ln4593">                  ChordRest* cr = static_cast&lt;ChordRest*&gt;(segment-&gt;element(track));</a>
<a name="ln4594">                  if (cr) {</a>
<a name="ln4595">                        Element* e;</a>
<a name="ln4596">                        if (cr-&gt;type() == ElementType::CHORD)</a>
<a name="ln4597">                              e =  static_cast&lt;Chord*&gt;(cr)-&gt;upNote();</a>
<a name="ln4598">                        else //REST</a>
<a name="ln4599">                              e = cr;</a>
<a name="ln4600"> </a>
<a name="ln4601">                        _score-&gt;select(e, SelectType::SINGLE, 0);</a>
<a name="ln4602">                        break;</a>
<a name="ln4603">                        }</a>
<a name="ln4604">                  }</a>
<a name="ln4605">            if (track != tracks)</a>
<a name="ln4606">                  break;</a>
<a name="ln4607">            }</a>
<a name="ln4608">      _score-&gt;setUpdateAll();</a>
<a name="ln4609">      _score-&gt;update();</a>
<a name="ln4610">      }</a>
<a name="ln4611"> </a>
<a name="ln4612">//---------------------------------------------------------</a>
<a name="ln4613">//   layoutChanged</a>
<a name="ln4614">//---------------------------------------------------------</a>
<a name="ln4615"> </a>
<a name="ln4616">void ScoreView::layoutChanged()</a>
<a name="ln4617">      {</a>
<a name="ln4618">      if (mscore-&gt;navigator())</a>
<a name="ln4619">            mscore-&gt;navigator()-&gt;layoutChanged();</a>
<a name="ln4620">      _curLoopIn-&gt;move(_score-&gt;pos(POS::LEFT));</a>
<a name="ln4621">      Measure* lm = _score-&gt;lastMeasure();</a>
<a name="ln4622">      if (lm &amp;&amp; _score-&gt;pos(POS::RIGHT) &gt; lm-&gt;endTick())</a>
<a name="ln4623">            _score-&gt;setPos(POS::RIGHT, lm-&gt;endTick());</a>
<a name="ln4624">      _curLoopOut-&gt;move(_score-&gt;pos(POS::RIGHT));</a>
<a name="ln4625">      }</a>
<a name="ln4626"> </a>
<a name="ln4627">//---------------------------------------------------------</a>
<a name="ln4628">//   elementLower</a>
<a name="ln4629">//---------------------------------------------------------</a>
<a name="ln4630"> </a>
<a name="ln4631">static bool elementLower(const Element* e1, const Element* e2)</a>
<a name="ln4632">      {</a>
<a name="ln4633">      if (!e1-&gt;selectable())</a>
<a name="ln4634">            return false;</a>
<a name="ln4635">      if (!e2-&gt;selectable())</a>
<a name="ln4636">            return true;</a>
<a name="ln4637">      if (e1-&gt;isNote() &amp;&amp; e2-&gt;isStem())</a>
<a name="ln4638">            return true;</a>
<a name="ln4639">      if (e2-&gt;isNote() &amp;&amp; e1-&gt;isStem())</a>
<a name="ln4640">            return false;</a>
<a name="ln4641">      if (e1-&gt;z() == e2-&gt;z()) {</a>
<a name="ln4642">            // same stacking order, prefer non-hidden elements</a>
<a name="ln4643">            if (e1-&gt;type() == e2-&gt;type()) {</a>
<a name="ln4644">                  if (e1-&gt;type() == ElementType::NOTEDOT) {</a>
<a name="ln4645">                        const NoteDot* n1 = static_cast&lt;const NoteDot*&gt;(e1);</a>
<a name="ln4646">                        const NoteDot* n2 = static_cast&lt;const NoteDot*&gt;(e2);</a>
<a name="ln4647">                        if (n1-&gt;note() &amp;&amp; n1-&gt;note()-&gt;hidden())</a>
<a name="ln4648">                              return false;</a>
<a name="ln4649">                        else if (n2-&gt;note() &amp;&amp; n2-&gt;note()-&gt;hidden())</a>
<a name="ln4650">                              return true;</a>
<a name="ln4651">                        }</a>
<a name="ln4652">                  else if (e1-&gt;type() == ElementType::NOTE) {</a>
<a name="ln4653">                        const Note* n1 = static_cast&lt;const Note*&gt;(e1);</a>
<a name="ln4654">                        const Note* n2 = static_cast&lt;const Note*&gt;(e2);</a>
<a name="ln4655">                        if (n1-&gt;hidden())</a>
<a name="ln4656">                              return false;</a>
<a name="ln4657">                        else if (n2-&gt;hidden())</a>
<a name="ln4658">                              return true;</a>
<a name="ln4659">                        }</a>
<a name="ln4660">                  }</a>
<a name="ln4661">            // different types, or same type but nothing hidden - use track</a>
<a name="ln4662">            return e1-&gt;track() &lt;= e2-&gt;track();</a>
<a name="ln4663">            }</a>
<a name="ln4664"> </a>
<a name="ln4665">      // default case, use stacking order</a>
<a name="ln4666">      return e1-&gt;z() &lt;= e2-&gt;z();</a>
<a name="ln4667">      }</a>
<a name="ln4668"> </a>
<a name="ln4669">//---------------------------------------------------------</a>
<a name="ln4670">//   elementsNear</a>
<a name="ln4671">//---------------------------------------------------------</a>
<a name="ln4672"> </a>
<a name="ln4673">QList&lt;Element*&gt; ScoreView::elementsNear(QPointF p)</a>
<a name="ln4674">      {</a>
<a name="ln4675">      QList&lt;Element*&gt; ll;</a>
<a name="ln4676">      Page* page = point2page(p);</a>
<a name="ln4677">      if (!page)</a>
<a name="ln4678">            return ll;</a>
<a name="ln4679"> </a>
<a name="ln4680">      p       -= page-&gt;pos();</a>
<a name="ln4681">      double w = (preferences.getInt(PREF_UI_CANVAS_MISC_SELECTIONPROXIMITY) * .5) / matrix().m11();</a>
<a name="ln4682">      QRectF r(p.x() - w, p.y() - w, 3.0 * w, 3.0 * w);</a>
<a name="ln4683"> </a>
<a name="ln4684">      QList&lt;Element*&gt; el = page-&gt;items(r);</a>
<a name="ln4685">      for (Element* e : el) {</a>
<a name="ln4686">            e-&gt;itemDiscovered = 0;</a>
<a name="ln4687">            if (!e-&gt;selectable() || e-&gt;isPage())</a>
<a name="ln4688">                  continue;</a>
<a name="ln4689">            if (e-&gt;contains(p))</a>
<a name="ln4690">                  ll.append(e);</a>
<a name="ln4691">            }</a>
<a name="ln4692">      int n = ll.size();</a>
<a name="ln4693">      if ((n == 0) || ((n == 1) &amp;&amp; (ll[0]-&gt;isMeasure()))) {</a>
<a name="ln4694">            //</a>
<a name="ln4695">            // if no relevant element hit, look nearby</a>
<a name="ln4696">            //</a>
<a name="ln4697">            for (Element* e : el) {</a>
<a name="ln4698">                  if (e-&gt;isPage() || !e-&gt;selectable())</a>
<a name="ln4699">                        continue;</a>
<a name="ln4700">                  if (e-&gt;intersects(r))</a>
<a name="ln4701">                        ll.append(e);</a>
<a name="ln4702">                  }</a>
<a name="ln4703">            }</a>
<a name="ln4704">      if (!ll.empty())</a>
<a name="ln4705">            qSort(ll.begin(), ll.end(), elementLower);</a>
<a name="ln4706">      return ll;</a>
<a name="ln4707">      }</a>
<a name="ln4708"> </a>
<a name="ln4709">//---------------------------------------------------------</a>
<a name="ln4710">//   elementNear</a>
<a name="ln4711">//---------------------------------------------------------</a>
<a name="ln4712"> </a>
<a name="ln4713">Element* ScoreView::elementNear(QPointF p)</a>
<a name="ln4714">      {</a>
<a name="ln4715">      QList&lt;Element*&gt; ll = elementsNear(p);</a>
<a name="ln4716">      if (ll.empty()) {</a>
<a name="ln4717">            // qDebug(&quot;  nothing found&quot;);</a>
<a name="ln4718">            return 0;</a>
<a name="ln4719">            }</a>
<a name="ln4720">#if 0</a>
<a name="ln4721">      qDebug(&quot;==&quot;);</a>
<a name="ln4722">      for (const Element* e : ll)</a>
<a name="ln4723">            qDebug(&quot;  %s selected %d z %d&quot;, e-&gt;name(), e-&gt;selected(), e-&gt;z());</a>
<a name="ln4724">#endif</a>
<a name="ln4725">      Element* e = ll.at(0);</a>
<a name="ln4726">      return e;</a>
<a name="ln4727">      }</a>
<a name="ln4728"> </a>
<a name="ln4729">//---------------------------------------------------------</a>
<a name="ln4730">//   posChanged</a>
<a name="ln4731">//---------------------------------------------------------</a>
<a name="ln4732"> </a>
<a name="ln4733">void ScoreView::posChanged(POS pos, unsigned tick)</a>
<a name="ln4734">      {</a>
<a name="ln4735">      switch (pos) {</a>
<a name="ln4736">            case POS::CURRENT:</a>
<a name="ln4737">                  // draw playback cursor only in the currently active view</a>
<a name="ln4738">                  if (this != mscore-&gt;currentScoreView() &amp;&amp; !_moveWhenInactive)</a>
<a name="ln4739">                        return;</a>
<a name="ln4740">                  if (noteEntryMode())</a>
<a name="ln4741">                        moveCursor();     // update input cursor position</a>
<a name="ln4742">                  else</a>
<a name="ln4743">                        moveCursor(Fraction::fromTicks(tick)); // update play position</a>
<a name="ln4744">                  break;</a>
<a name="ln4745">            case POS::LEFT:</a>
<a name="ln4746">                  _curLoopIn-&gt;move(_score-&gt;pos(POS::LEFT));</a>
<a name="ln4747">                  break;</a>
<a name="ln4748">            case POS::RIGHT:</a>
<a name="ln4749">                  _curLoopOut-&gt;move(_score-&gt;pos(POS::RIGHT));</a>
<a name="ln4750">                  break;</a>
<a name="ln4751">            }</a>
<a name="ln4752">      }</a>
<a name="ln4753"> </a>
<a name="ln4754">//---------------------------------------------------------</a>
<a name="ln4755">//   loopToggled</a>
<a name="ln4756">//---------------------------------------------------------</a>
<a name="ln4757"> </a>
<a name="ln4758">void ScoreView::loopToggled(bool val)</a>
<a name="ln4759">      {</a>
<a name="ln4760">      if (_score-&gt;lastMeasure() == 0)</a>
<a name="ln4761">            return;</a>
<a name="ln4762">      if (_score-&gt;pos(POS::LEFT).isZero() &amp;&amp; _score-&gt;pos(POS::RIGHT).isZero())</a>
<a name="ln4763">            _score-&gt;setPos(POS::RIGHT, _score-&gt;lastMeasure()-&gt;endTick());</a>
<a name="ln4764">      _curLoopIn-&gt;move(_score-&gt;loopInTick());</a>
<a name="ln4765">      _curLoopOut-&gt;move(_score-&gt;loopOutTick());</a>
<a name="ln4766">      _curLoopIn-&gt;setVisible(val);</a>
<a name="ln4767">      _curLoopOut-&gt;setVisible(val);</a>
<a name="ln4768">      update();</a>
<a name="ln4769">      }</a>
<a name="ln4770"> </a>
<a name="ln4771">//---------------------------------------------------------</a>
<a name="ln4772">//   cmdMoveCR</a>
<a name="ln4773">//    swap selected cr with cr to the left or right</a>
<a name="ln4774">//      - not across measure boundaries</a>
<a name="ln4775">//---------------------------------------------------------</a>
<a name="ln4776"> </a>
<a name="ln4777">void ScoreView::cmdMoveCR(bool left)</a>
<a name="ln4778">      {</a>
<a name="ln4779">      Element* e = _score-&gt;getSelectedElement();</a>
<a name="ln4780">      if (e &amp;&amp; (e-&gt;type() == ElementType::NOTE || e-&gt;type() == ElementType::REST)) {</a>
<a name="ln4781">            if (e-&gt;type() == ElementType::NOTE)</a>
<a name="ln4782">                  e = e-&gt;parent();</a>
<a name="ln4783">            QList&lt;ChordRest*&gt; crl;</a>
<a name="ln4784">            if (e-&gt;links()) {</a>
<a name="ln4785">                  for (ScoreElement* cr : *e-&gt;links())</a>
<a name="ln4786">                        crl.append(static_cast&lt;ChordRest*&gt;(cr));</a>
<a name="ln4787">                  }</a>
<a name="ln4788">            else</a>
<a name="ln4789">                  crl.append(static_cast&lt;ChordRest*&gt;(e));</a>
<a name="ln4790"> </a>
<a name="ln4791">            bool cmdActive = false;</a>
<a name="ln4792">            for (ChordRest* cr1 : crl) {</a>
<a name="ln4793">                  if (cr1-&gt;type() == ElementType::REST) {</a>
<a name="ln4794">                        Rest* r = static_cast&lt;Rest*&gt;(cr1);</a>
<a name="ln4795">                        if (r-&gt;measure() &amp;&amp; r-&gt;measure()-&gt;isMMRest())</a>
<a name="ln4796">                              break;</a>
<a name="ln4797">                        }</a>
<a name="ln4798">                  ChordRest* cr2 = left ? prevChordRest(cr1) : nextChordRest(cr1);</a>
<a name="ln4799">                  if (cr2 &amp;&amp; cr1-&gt;measure() == cr2-&gt;measure() &amp;&amp; !cr1-&gt;tuplet() &amp;&amp; !cr2-&gt;tuplet()</a>
<a name="ln4800">                      &amp;&amp; cr1-&gt;durationType() == cr2-&gt;durationType() &amp;&amp; cr1-&gt;ticks() == cr2-&gt;ticks()) {</a>
<a name="ln4801">                        if (!cmdActive) {</a>
<a name="ln4802">                              _score-&gt;startCmd();</a>
<a name="ln4803">                              cmdActive = true;</a>
<a name="ln4804">                              }</a>
<a name="ln4805">                        _score-&gt;undo(new SwapCR(cr1, cr2));</a>
<a name="ln4806">                        }</a>
<a name="ln4807">                  }</a>
<a name="ln4808">            if (cmdActive)</a>
<a name="ln4809">                  _score-&gt;endCmd();</a>
<a name="ln4810">            }</a>
<a name="ln4811">      }</a>
<a name="ln4812"> </a>
<a name="ln4813">//---------------------------------------------------------</a>
<a name="ln4814">//   cmdAddRemoveBreaks</a>
<a name="ln4815">///   add or remove line breaks within a range selection</a>
<a name="ln4816">///   or, if nothing is selected, the entire score</a>
<a name="ln4817">//---------------------------------------------------------</a>
<a name="ln4818"> </a>
<a name="ln4819">void ScoreView::cmdAddRemoveBreaks()</a>
<a name="ln4820">      {</a>
<a name="ln4821">      bool noSelection = !_score-&gt;selection().isRange();</a>
<a name="ln4822"> </a>
<a name="ln4823">      if (noSelection)</a>
<a name="ln4824">            _score-&gt;cmdSelectAll();</a>
<a name="ln4825">      else if (!_score-&gt;selection().isRange())</a>
<a name="ln4826">            return;</a>
<a name="ln4827"> </a>
<a name="ln4828">      BreaksDialog bd;</a>
<a name="ln4829">      if (!bd.exec())</a>
<a name="ln4830">            return;</a>
<a name="ln4831"> </a>
<a name="ln4832">      int interval = bd.remove || bd.lock ? 0 : bd.interval;</a>
<a name="ln4833"> </a>
<a name="ln4834">      _score-&gt;addRemoveBreaks(interval, bd.lock);</a>
<a name="ln4835"> </a>
<a name="ln4836">      if (noSelection)</a>
<a name="ln4837">             _score-&gt;deselectAll();</a>
<a name="ln4838">      }</a>
<a name="ln4839"> </a>
<a name="ln4840">//---------------------------------------------------------</a>
<a name="ln4841">//   cmdCopyLyricsToClipboard</a>
<a name="ln4842">///   Copy the score lyrics into clipboard</a>
<a name="ln4843">//---------------------------------------------------------</a>
<a name="ln4844"> </a>
<a name="ln4845">void ScoreView::cmdCopyLyricsToClipboard()</a>
<a name="ln4846">      {</a>
<a name="ln4847">      QApplication::clipboard()-&gt;setText(_score-&gt;extractLyrics());</a>
<a name="ln4848">      }</a>
<a name="ln4849"> </a>
<a name="ln4850">//---------------------------------------------------------</a>
<a name="ln4851">//   updateContinuousPanel</a>
<a name="ln4852">//   slot triggered when moving around the score to keep the panel visible</a>
<a name="ln4853">//---------------------------------------------------------</a>
<a name="ln4854"> </a>
<a name="ln4855">void ScoreView::updateContinuousPanel()</a>
<a name="ln4856">      {</a>
<a name="ln4857">      if (_score-&gt;layoutMode() == LayoutMode::LINE)</a>
<a name="ln4858">            update();</a>
<a name="ln4859">      }</a>
<a name="ln4860"> </a>
<a name="ln4861">//---------------------------------------------------------</a>
<a name="ln4862">//   updateShadowNotes</a>
<a name="ln4863">//---------------------------------------------------------</a>
<a name="ln4864"> </a>
<a name="ln4865">void ScoreView::updateShadowNotes()</a>
<a name="ln4866">      {</a>
<a name="ln4867">      if (shadowNote-&gt;visible())</a>
<a name="ln4868">            setShadowNote(shadowNote-&gt;pos());</a>
<a name="ln4869">      }</a>
<a name="ln4870"> </a>
<a name="ln4871">//---------------------------------------------------------</a>
<a name="ln4872">//   getEditElement</a>
<a name="ln4873">//---------------------------------------------------------</a>
<a name="ln4874"> </a>
<a name="ln4875">Element* ScoreView::getEditElement()</a>
<a name="ln4876">      {</a>
<a name="ln4877">      return editData.element;</a>
<a name="ln4878">      }</a>
<a name="ln4879"> </a>
<a name="ln4880">//---------------------------------------------------------</a>
<a name="ln4881">//   onElementDestruction</a>
<a name="ln4882">//---------------------------------------------------------</a>
<a name="ln4883"> </a>
<a name="ln4884">void ScoreView::onElementDestruction(Element* e)</a>
<a name="ln4885">      {</a>
<a name="ln4886">      if (editData.element == e) {</a>
<a name="ln4887">            editData.element = nullptr;</a>
<a name="ln4888">            if (editMode())</a>
<a name="ln4889">                  changeState(ViewState::NORMAL);</a>
<a name="ln4890">            }</a>
<a name="ln4891">      }</a>
<a name="ln4892"> </a>
<a name="ln4893">//---------------------------------------------------------</a>
<a name="ln4894">//   startNoteEntryMode</a>
<a name="ln4895">//---------------------------------------------------------</a>
<a name="ln4896"> </a>
<a name="ln4897">void ScoreView::startNoteEntryMode()</a>
<a name="ln4898">      {</a>
<a name="ln4899">      changeState(ViewState::NOTE_ENTRY);</a>
<a name="ln4900">      }</a>
<a name="ln4901"> </a>
<a name="ln4902">//---------------------------------------------------------</a>
<a name="ln4903">//   fotoMode</a>
<a name="ln4904">//---------------------------------------------------------</a>
<a name="ln4905"> </a>
<a name="ln4906">bool ScoreView::fotoMode() const</a>
<a name="ln4907">      {</a>
<a name="ln4908">      switch (state) {</a>
<a name="ln4909">            case ViewState::NORMAL:</a>
<a name="ln4910">            case ViewState::DRAG:</a>
<a name="ln4911">            case ViewState::DRAG_OBJECT:</a>
<a name="ln4912">            case ViewState::EDIT:</a>
<a name="ln4913">            case ViewState::DRAG_EDIT:</a>
<a name="ln4914">            case ViewState::LASSO:</a>
<a name="ln4915">            case ViewState::NOTE_ENTRY:</a>
<a name="ln4916">            case ViewState::PLAY:</a>
<a name="ln4917">            case ViewState::ENTRY_PLAY:</a>
<a name="ln4918">                  break;</a>
<a name="ln4919"> </a>
<a name="ln4920">            case ViewState::FOTO:</a>
<a name="ln4921">            case ViewState::FOTO_DRAG:</a>
<a name="ln4922">            case ViewState::FOTO_DRAG_EDIT:</a>
<a name="ln4923">            case ViewState::FOTO_DRAG_OBJECT:</a>
<a name="ln4924">            case ViewState::FOTO_LASSO:</a>
<a name="ln4925">                  return true;</a>
<a name="ln4926">            }</a>
<a name="ln4927">      return false;</a>
<a name="ln4928">      }</a>
<a name="ln4929"> </a>
<a name="ln4930">//---------------------------------------------------------</a>
<a name="ln4931">//   setEditElement</a>
<a name="ln4932">//---------------------------------------------------------</a>
<a name="ln4933"> </a>
<a name="ln4934">void ScoreView::setEditElement(Element* e)</a>
<a name="ln4935">      {</a>
<a name="ln4936">      if (editData.element == e)</a>
<a name="ln4937">            return;</a>
<a name="ln4938"> </a>
<a name="ln4939">      const bool normalState = (state == ViewState::NORMAL);</a>
<a name="ln4940"> </a>
<a name="ln4941">      if (normalState &amp;&amp; editData.element &amp;&amp; editData.element-&gt;normalModeEditBehavior() == Element::EditBehavior::Edit)</a>
<a name="ln4942">            endEdit();</a>
<a name="ln4943"> </a>
<a name="ln4944">      editData.element = e;</a>
<a name="ln4945"> </a>
<a name="ln4946">      if (normalState &amp;&amp; e &amp;&amp; e-&gt;normalModeEditBehavior() == Element::EditBehavior::Edit)</a>
<a name="ln4947">            startEdit(/* editMode */ false);</a>
<a name="ln4948">      else if (editData.grips) {</a>
<a name="ln4949">            editData.grips = 0;</a>
<a name="ln4950">            editData.curGrip = Grip::NO_GRIP;</a>
<a name="ln4951">            }</a>
<a name="ln4952">      }</a>
<a name="ln4953"> </a>
<a name="ln4954">//---------------------------------------------------------</a>
<a name="ln4955">//   updateEditElement</a>
<a name="ln4956">//---------------------------------------------------------</a>
<a name="ln4957"> </a>
<a name="ln4958">void ScoreView::updateEditElement()</a>
<a name="ln4959">      {</a>
<a name="ln4960">      if (state != ViewState::NORMAL)</a>
<a name="ln4961">            return;</a>
<a name="ln4962"> </a>
<a name="ln4963">      if (!_score) {</a>
<a name="ln4964">            setEditElement(nullptr);</a>
<a name="ln4965">            return;</a>
<a name="ln4966">            }</a>
<a name="ln4967"> </a>
<a name="ln4968">      const Selection&amp; sel = _score-&gt;selection();</a>
<a name="ln4969"> </a>
<a name="ln4970">      switch (sel.state()) {</a>
<a name="ln4971">            case SelState::NONE:</a>
<a name="ln4972">            case SelState::RANGE:</a>
<a name="ln4973">                  setEditElement(nullptr);</a>
<a name="ln4974">                  break;</a>
<a name="ln4975">            case SelState::LIST:</a>
<a name="ln4976">                  if (Element* e = sel.element()) {</a>
<a name="ln4977">                        if (editData.element == e)</a>
<a name="ln4978">                              updateGrips();</a>
<a name="ln4979">                        else</a>
<a name="ln4980">                              setEditElement(e);</a>
<a name="ln4981">                        }</a>
<a name="ln4982">                  else {</a>
<a name="ln4983">                        setEditElement(nullptr);</a>
<a name="ln4984">                        }</a>
<a name="ln4985">                  break;</a>
<a name="ln4986">            }</a>
<a name="ln4987">      }</a>
<a name="ln4988"> </a>
<a name="ln4989">//---------------------------------------------------------</a>
<a name="ln4990">//   visibleElementInScore</a>
<a name="ln4991">//---------------------------------------------------------</a>
<a name="ln4992"> </a>
<a name="ln4993">static const Element* visibleElementInScore(const Element* orig, const Score* s)</a>
<a name="ln4994">      {</a>
<a name="ln4995">      if (!orig)</a>
<a name="ln4996">            return nullptr;</a>
<a name="ln4997">      if (orig-&gt;score() == s &amp;&amp; orig-&gt;bbox().isValid())</a>
<a name="ln4998">            return orig;</a>
<a name="ln4999"> </a>
<a name="ln5000">      for (const ScoreElement* se : orig-&gt;linkList()) {</a>
<a name="ln5001">            const Element* e = toElement(se);</a>
<a name="ln5002">            if (e-&gt;score() == s &amp;&amp; e-&gt;bbox().isValid()) // bbox check to ensure the element is indeed visible</a>
<a name="ln5003">                  return e;</a>
<a name="ln5004">            }</a>
<a name="ln5005"> </a>
<a name="ln5006">      return nullptr;</a>
<a name="ln5007">      }</a>
<a name="ln5008"> </a>
<a name="ln5009">//---------------------------------------------------------</a>
<a name="ln5010">//   needViewportMove</a>
<a name="ln5011">//---------------------------------------------------------</a>
<a name="ln5012"> </a>
<a name="ln5013">static bool needViewportMove(Score* cs, ScoreView* cv)</a>
<a name="ln5014">      {</a>
<a name="ln5015">      if (!cs || !cv)</a>
<a name="ln5016">            return false;</a>
<a name="ln5017"> </a>
<a name="ln5018">      const CmdState&amp; state = cs-&gt;cmdState();</a>
<a name="ln5019"> </a>
<a name="ln5020">      if (state.startTick() &lt; Fraction(0, 1))</a>
<a name="ln5021">            return false;</a>
<a name="ln5022"> </a>
<a name="ln5023">      const QRectF viewport = cv-&gt;canvasViewport(); // TODO: margins for intersection check?</a>
<a name="ln5024"> </a>
<a name="ln5025">      const Element* editElement = visibleElementInScore(state.element(), cs);</a>
<a name="ln5026">      if (editElement &amp;&amp; editElement-&gt;bbox().isValid() &amp;&amp; !editElement-&gt;isSpanner())</a>
<a name="ln5027">            return !viewport.intersects(editElement-&gt;canvasBoundingRect());</a>
<a name="ln5028"> </a>
<a name="ln5029">      if (state.startTick().isZero() &amp;&amp; state.endTick() == cs-&gt;endTick())</a>
<a name="ln5030">            return false; // TODO: adjust staff perhaps?</a>
<a name="ln5031"> </a>
<a name="ln5032">      // Is any part of the range visible?</a>
<a name="ln5033">      Measure* mStart = cs-&gt;tick2measureMM(state.startTick());</a>
<a name="ln5034">      Measure* mEnd = cs-&gt;tick2measureMM(state.endTick());</a>
<a name="ln5035">      mEnd = mEnd ? mEnd-&gt;nextMeasureMM() : nullptr;</a>
<a name="ln5036"> </a>
<a name="ln5037">      const bool isExcerpt = !cs-&gt;isMaster();</a>
<a name="ln5038">      const int startStaff = (isExcerpt || state.startStaff() &lt; 0) ? 0 : state.startStaff();</a>
<a name="ln5039">      const int endStaff = (isExcerpt || state.endStaff() &lt; 0) ? (cs-&gt;nstaves() - 1) : state.endStaff();</a>
<a name="ln5040"> </a>
<a name="ln5041">      for (Measure* m = mStart; m &amp;&amp; m != mEnd; m = m-&gt;nextMeasureMM()) {</a>
<a name="ln5042">            for (int st = startStaff; st &lt;= endStaff; ++st) {</a>
<a name="ln5043">                  const StaffLines* l = m-&gt;staffLines(st);</a>
<a name="ln5044">                  if (l) {</a>
<a name="ln5045">                        const QRectF r = l-&gt;bbox().translated(l-&gt;canvasPos());</a>
<a name="ln5046">                        if (viewport.intersects(r))</a>
<a name="ln5047">                              return false;</a>
<a name="ln5048">                        }</a>
<a name="ln5049">                  }</a>
<a name="ln5050">            }</a>
<a name="ln5051"> </a>
<a name="ln5052">      // maybe viewport is at least near the desired position?</a>
<a name="ln5053">      const QPointF p = viewport.center();</a>
<a name="ln5054">      int staffIdx = 0;</a>
<a name="ln5055">      const Measure* m = cs-&gt;pos2measure(p, &amp;staffIdx, nullptr, nullptr, nullptr);</a>
<a name="ln5056">      if (m &amp;&amp; m-&gt;tick() &gt;= state.startTick() &amp;&amp; m-&gt;tick() &lt;= state.endTick())</a>
<a name="ln5057">            return false;</a>
<a name="ln5058"> </a>
<a name="ln5059">      return true;</a>
<a name="ln5060">      }</a>
<a name="ln5061"> </a>
<a name="ln5062">//---------------------------------------------------------</a>
<a name="ln5063">//   moveViewportToLastEdit</a>
<a name="ln5064">//---------------------------------------------------------</a>
<a name="ln5065"> </a>
<a name="ln5066">void ScoreView::moveViewportToLastEdit()</a>
<a name="ln5067">      {</a>
<a name="ln5068">      if (_blockShowEdit)</a>
<a name="ln5069">            return;</a>
<a name="ln5070"> </a>
<a name="ln5071">      Score* sc = score();</a>
<a name="ln5072"> </a>
<a name="ln5073">      if (!needViewportMove(sc, this))</a>
<a name="ln5074">            return;</a>
<a name="ln5075"> </a>
<a name="ln5076">      const CmdState&amp; st = sc-&gt;cmdState();</a>
<a name="ln5077">      const Element* editElement = visibleElementInScore(st.element(), sc);</a>
<a name="ln5078"> </a>
<a name="ln5079">      const MeasureBase* mb = nullptr;</a>
<a name="ln5080">      if (editElement) {</a>
<a name="ln5081">            if (editElement-&gt;isSpannerSegment()) {</a>
<a name="ln5082">                  const SpannerSegment* s = toSpannerSegment(editElement);</a>
<a name="ln5083">                  Fraction tick = s-&gt;tick();</a>
<a name="ln5084">                  if (System* sys = s-&gt;system()) {</a>
<a name="ln5085">                        Measure* fm = sys-&gt;firstMeasure();</a>
<a name="ln5086">                        if (fm)</a>
<a name="ln5087">                              tick = std::max(tick, fm-&gt;tick());</a>
<a name="ln5088">                        }</a>
<a name="ln5089">                  mb = sc-&gt;tick2measureMM(tick);</a>
<a name="ln5090">                  }</a>
<a name="ln5091">            else {</a>
<a name="ln5092">                  mb = editElement-&gt;findMeasureBase();</a>
<a name="ln5093">                  }</a>
<a name="ln5094">            }</a>
<a name="ln5095">      if (!mb)</a>
<a name="ln5096">            mb = sc-&gt;tick2measureMM(st.startTick());</a>
<a name="ln5097"> </a>
<a name="ln5098">      const Element* viewportElement = (editElement &amp;&amp; editElement-&gt;bbox().isValid() &amp;&amp; !mb-&gt;isMeasure()) ? editElement : mb;</a>
<a name="ln5099"> </a>
<a name="ln5100">      const int staff = sc-&gt;isMaster() &amp;&amp; mb-&gt;isMeasure() ? st.startStaff() : -1; // TODO: choose the closest staff to the current viewport?</a>
<a name="ln5101">      adjustCanvasPosition(viewportElement, /* playback */ false, staff);</a>
<a name="ln5102">      }</a>
<a name="ln5103">}</a>

</code></pre>
<div class="balloon" rel="183"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v668/" target="_blank">V668</a> There is no sense in testing the 'pm' pointer against null, as the memory was allocated using the 'new' operator. The exception will be generated in the case of memory allocation error.</p></div>
<div class="balloon" rel="184"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="1289"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1004/" target="_blank">V1004</a> The 'mmr' pointer was used unsafely after it was verified against nullptr. Check lines: 1284, 1289.</p></div>
<div class="balloon" rel="1631"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="1749"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'e' is always true.</p></div>
<div class="balloon" rel="1791"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="2887"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v640/" target="_blank">V640</a> The code's operational logic does not correspond with its formatting. The statement is indented to the right, but it is always executed. It is possible that curly brackets are missing.</p></div>
<div class="balloon" rel="4391"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'mb' pointer was utilized before it was verified against nullptr. Check lines: 4391, 4399.</p></div>
<div class="balloon" rel="4471"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="4492"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'e' is always false.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
