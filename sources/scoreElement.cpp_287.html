
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>scoreElement.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2015 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;scoreElement.h&quot;</a>
<a name="ln14">#include &quot;score.h&quot;</a>
<a name="ln15">#include &quot;undo.h&quot;</a>
<a name="ln16">#include &quot;xml.h&quot;</a>
<a name="ln17">#include &quot;bracket.h&quot;</a>
<a name="ln18">#include &quot;bracketItem.h&quot;</a>
<a name="ln19">#include &quot;measure.h&quot;</a>
<a name="ln20">#include &quot;spanner.h&quot;</a>
<a name="ln21">#include &quot;musescoreCore.h&quot;</a>
<a name="ln22"> </a>
<a name="ln23">namespace Ms {</a>
<a name="ln24"> </a>
<a name="ln25">ElementStyle const ScoreElement::emptyStyle;</a>
<a name="ln26"> </a>
<a name="ln27">//</a>
<a name="ln28">// list has to be synchronized with ElementType enum</a>
<a name="ln29">//</a>
<a name="ln30">static const ElementName elementNames[] = {</a>
<a name="ln31">      { ElementType::INVALID,              &quot;invalid&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Invalid&quot;) },</a>
<a name="ln32">      { ElementType::BRACKET_ITEM,         &quot;BracketItem&quot;,          QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Bracket&quot;) },</a>
<a name="ln33">      { ElementType::PART,                 &quot;Part&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Part&quot;) },</a>
<a name="ln34">      { ElementType::STAFF,                &quot;Staff&quot;,                QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Staff&quot;) },</a>
<a name="ln35">      { ElementType::SCORE,                &quot;Score&quot;,                QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Score&quot;) },</a>
<a name="ln36">      { ElementType::SYMBOL,               &quot;Symbol&quot;,               QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Symbol&quot;) },</a>
<a name="ln37">      { ElementType::TEXT,                 &quot;Text&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Text&quot;) },</a>
<a name="ln38">      { ElementType::MEASURE_NUMBER,       &quot;MeasureNumber&quot;,        QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Measure Number&quot;) },</a>
<a name="ln39">      { ElementType::INSTRUMENT_NAME,      &quot;InstrumentName&quot;,       QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Instrument Name&quot;) },</a>
<a name="ln40">      { ElementType::SLUR_SEGMENT,         &quot;SlurSegment&quot;,          QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Slur Segment&quot;) },</a>
<a name="ln41">      { ElementType::TIE_SEGMENT,          &quot;TieSegment&quot;,           QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Tie Segment&quot;) },</a>
<a name="ln42">      { ElementType::BAR_LINE,             &quot;BarLine&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Barline&quot;) },</a>
<a name="ln43">      { ElementType::STAFF_LINES,          &quot;StaffLines&quot;,           QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Staff Lines&quot;) },</a>
<a name="ln44">      { ElementType::SYSTEM_DIVIDER,       &quot;SystemDivider&quot;,        QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;System Divider&quot;) },</a>
<a name="ln45">      { ElementType::STEM_SLASH,           &quot;StemSlash&quot;,            QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Stem Slash&quot;) },</a>
<a name="ln46">      { ElementType::ARPEGGIO,             &quot;Arpeggio&quot;,             QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Arpeggio&quot;) },</a>
<a name="ln47">      { ElementType::ACCIDENTAL,           &quot;Accidental&quot;,           QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Accidental&quot;) },</a>
<a name="ln48">      { ElementType::LEDGER_LINE,          &quot;LedgerLine&quot;,           QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Ledger Line&quot;) },</a>
<a name="ln49">      { ElementType::STEM,                 &quot;Stem&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Stem&quot;) },</a>
<a name="ln50">      { ElementType::NOTE,                 &quot;Note&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Note&quot;) },</a>
<a name="ln51">      { ElementType::CLEF,                 &quot;Clef&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Clef&quot;) },</a>
<a name="ln52">      { ElementType::KEYSIG,               &quot;KeySig&quot;,               QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Key Signature&quot;) },</a>
<a name="ln53">      { ElementType::AMBITUS,              &quot;Ambitus&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Ambitus&quot;) },</a>
<a name="ln54">      { ElementType::TIMESIG,              &quot;TimeSig&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Time Signature&quot;) },</a>
<a name="ln55">      { ElementType::REST,                 &quot;Rest&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Rest&quot;) },</a>
<a name="ln56">      { ElementType::BREATH,               &quot;Breath&quot;,               QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Breath&quot;) },</a>
<a name="ln57">      { ElementType::REPEAT_MEASURE,       &quot;RepeatMeasure&quot;,        QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Repeat Measure&quot;) },</a>
<a name="ln58">      { ElementType::TIE,                  &quot;Tie&quot;,                  QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Tie&quot;) },</a>
<a name="ln59">      { ElementType::ARTICULATION,         &quot;Articulation&quot;,         QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Articulation&quot;) },</a>
<a name="ln60">      { ElementType::FERMATA,              &quot;Fermata&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Fermata&quot;) },</a>
<a name="ln61">      { ElementType::CHORDLINE,            &quot;ChordLine&quot;,            QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Chord Line&quot;) },</a>
<a name="ln62">      { ElementType::DYNAMIC,              &quot;Dynamic&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Dynamic&quot;) },</a>
<a name="ln63">      { ElementType::BEAM,                 &quot;Beam&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Beam&quot;) },</a>
<a name="ln64">      { ElementType::HOOK,                 &quot;Hook&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Hook&quot;) },</a>
<a name="ln65">      { ElementType::LYRICS,               &quot;Lyrics&quot;,               QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Lyrics&quot;) },</a>
<a name="ln66">      { ElementType::FIGURED_BASS,         &quot;FiguredBass&quot;,          QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Figured Bass&quot;) },</a>
<a name="ln67">      { ElementType::MARKER,               &quot;Marker&quot;,               QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Marker&quot;) },</a>
<a name="ln68">      { ElementType::JUMP,                 &quot;Jump&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Jump&quot;) },</a>
<a name="ln69">      { ElementType::FINGERING,            &quot;Fingering&quot;,            QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Fingering&quot;) },</a>
<a name="ln70">      { ElementType::TUPLET,               &quot;Tuplet&quot;,               QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Tuplet&quot;) },</a>
<a name="ln71">      { ElementType::TEMPO_TEXT,           &quot;Tempo&quot;,                QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Tempo&quot;) },</a>
<a name="ln72">      { ElementType::STAFF_TEXT,           &quot;StaffText&quot;,            QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Staff Text&quot;) },</a>
<a name="ln73">      { ElementType::SYSTEM_TEXT,          &quot;SystemText&quot;,           QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;System Text&quot;) },</a>
<a name="ln74">      { ElementType::REHEARSAL_MARK,       &quot;RehearsalMark&quot;,        QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Rehearsal Mark&quot;) },</a>
<a name="ln75">      { ElementType::INSTRUMENT_CHANGE,    &quot;InstrumentChange&quot;,     QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Instrument Change&quot;) },</a>
<a name="ln76">      { ElementType::STAFFTYPE_CHANGE,     &quot;StaffTypeChange&quot;,      QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Staff Type Change&quot;) },</a>
<a name="ln77">      { ElementType::HARMONY,              &quot;Harmony&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Chord Symbol&quot;) },</a>
<a name="ln78">      { ElementType::FRET_DIAGRAM,         &quot;FretDiagram&quot;,          QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Fretboard Diagram&quot;) },</a>
<a name="ln79">      { ElementType::BEND,                 &quot;Bend&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Bend&quot;) },</a>
<a name="ln80">      { ElementType::TREMOLOBAR,           &quot;TremoloBar&quot;,           QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Tremolo Bar&quot;) },</a>
<a name="ln81">      { ElementType::VOLTA,                &quot;Volta&quot;,                QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Volta&quot;) },</a>
<a name="ln82">      { ElementType::HAIRPIN_SEGMENT,      &quot;HairpinSegment&quot;,       QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Hairpin Segment&quot;) },</a>
<a name="ln83">      { ElementType::OTTAVA_SEGMENT,       &quot;OttavaSegment&quot;,        QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Ottava Segment&quot;) },</a>
<a name="ln84">      { ElementType::TRILL_SEGMENT,        &quot;TrillSegment&quot;,         QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Trill Segment&quot;) },</a>
<a name="ln85">      { ElementType::LET_RING_SEGMENT,     &quot;LetRingSegment&quot;,       QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Let Ring Segment&quot;) },</a>
<a name="ln86">      { ElementType::VIBRATO_SEGMENT,      &quot;VibratoSegment&quot;,       QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Vibrato Segment&quot;) },</a>
<a name="ln87">      { ElementType::PALM_MUTE_SEGMENT,    &quot;PalmMuteSegment&quot;,      QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Palm Mute Segment&quot;) },</a>
<a name="ln88">      { ElementType::TEXTLINE_SEGMENT,     &quot;TextLineSegment&quot;,      QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Text Line Segment&quot;) },</a>
<a name="ln89">      { ElementType::VOLTA_SEGMENT,        &quot;VoltaSegment&quot;,         QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Volta Segment&quot;) },</a>
<a name="ln90">      { ElementType::PEDAL_SEGMENT,        &quot;PedalSegment&quot;,         QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Pedal Segment&quot;) },</a>
<a name="ln91">      { ElementType::LYRICSLINE_SEGMENT,   &quot;LyricsLineSegment&quot;,    QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Melisma Line Segment&quot;) },</a>
<a name="ln92">      { ElementType::GLISSANDO_SEGMENT,    &quot;GlissandoSegment&quot;,     QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Glissando Segment&quot;) },</a>
<a name="ln93">      { ElementType::LAYOUT_BREAK,         &quot;LayoutBreak&quot;,          QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Layout Break&quot;) },</a>
<a name="ln94">      { ElementType::SPACER,               &quot;Spacer&quot;,               QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Spacer&quot;) },</a>
<a name="ln95">      { ElementType::STAFF_STATE,          &quot;StaffState&quot;,           QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Staff State&quot;) },</a>
<a name="ln96">      { ElementType::NOTEHEAD,             &quot;NoteHead&quot;,             QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Notehead&quot;) },</a>
<a name="ln97">      { ElementType::NOTEDOT,              &quot;NoteDot&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Note Dot&quot;) },</a>
<a name="ln98">      { ElementType::TREMOLO,              &quot;Tremolo&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Tremolo&quot;) },</a>
<a name="ln99">      { ElementType::IMAGE,                &quot;Image&quot;,                QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Image&quot;) },</a>
<a name="ln100">      { ElementType::MEASURE,              &quot;Measure&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Measure&quot;) },</a>
<a name="ln101">      { ElementType::SELECTION,            &quot;Selection&quot;,            QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Selection&quot;) },</a>
<a name="ln102">      { ElementType::LASSO,                &quot;Lasso&quot;,                QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Lasso&quot;) },</a>
<a name="ln103">      { ElementType::SHADOW_NOTE,          &quot;ShadowNote&quot;,           QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Shadow Note&quot;) },</a>
<a name="ln104">      { ElementType::TAB_DURATION_SYMBOL,  &quot;TabDurationSymbol&quot;,    QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Tab Duration Symbol&quot;) },</a>
<a name="ln105">      { ElementType::FSYMBOL,              &quot;FSymbol&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Font Symbol&quot;) },</a>
<a name="ln106">      { ElementType::PAGE,                 &quot;Page&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Page&quot;) },</a>
<a name="ln107">      { ElementType::HAIRPIN,              &quot;HairPin&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Hairpin&quot;) },</a>
<a name="ln108">      { ElementType::OTTAVA,               &quot;Ottava&quot;,               QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Ottava&quot;) },</a>
<a name="ln109">      { ElementType::PEDAL,                &quot;Pedal&quot;,                QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Pedal&quot;) },</a>
<a name="ln110">      { ElementType::TRILL,                &quot;Trill&quot;,                QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Trill&quot;) },</a>
<a name="ln111">      { ElementType::LET_RING,             &quot;LetRing&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Let Ring&quot;) },</a>
<a name="ln112">      { ElementType::VIBRATO,              &quot;Vibrato&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Vibrato&quot;) },</a>
<a name="ln113">      { ElementType::PALM_MUTE,            &quot;PalmMute&quot;,             QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Palm Mute&quot;) },</a>
<a name="ln114">      { ElementType::TEXTLINE,             &quot;TextLine&quot;,             QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Text Line&quot;) },</a>
<a name="ln115">      { ElementType::TEXTLINE_BASE,        &quot;TextLineBase&quot;,         QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Text Line Base&quot;) },  // remove</a>
<a name="ln116">      { ElementType::NOTELINE,             &quot;NoteLine&quot;,             QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Note Line&quot;) },</a>
<a name="ln117">      { ElementType::LYRICSLINE,           &quot;LyricsLine&quot;,           QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Melisma Line&quot;) },</a>
<a name="ln118">      { ElementType::GLISSANDO,            &quot;Glissando&quot;,            QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Glissando&quot;) },</a>
<a name="ln119">      { ElementType::BRACKET,              &quot;Bracket&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Bracket&quot;) },</a>
<a name="ln120">      { ElementType::SEGMENT,              &quot;Segment&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Segment&quot;) },</a>
<a name="ln121">      { ElementType::SYSTEM,               &quot;System&quot;,               QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;System&quot;) },</a>
<a name="ln122">      { ElementType::COMPOUND,             &quot;Compound&quot;,             QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Compound&quot;) },</a>
<a name="ln123">      { ElementType::CHORD,                &quot;Chord&quot;,                QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Chord&quot;) },</a>
<a name="ln124">      { ElementType::SLUR,                 &quot;Slur&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Slur&quot;) },</a>
<a name="ln125">      { ElementType::ELEMENT,              &quot;Element&quot;,              QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Element&quot;) },</a>
<a name="ln126">      { ElementType::ELEMENT_LIST,         &quot;ElementList&quot;,          QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Element List&quot;) },</a>
<a name="ln127">      { ElementType::STAFF_LIST,           &quot;StaffList&quot;,            QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Staff List&quot;) },</a>
<a name="ln128">      { ElementType::MEASURE_LIST,         &quot;MeasureList&quot;,          QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Measure List&quot;) },</a>
<a name="ln129">      { ElementType::HBOX,                 &quot;HBox&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Horizontal Frame&quot;) },</a>
<a name="ln130">      { ElementType::VBOX,                 &quot;VBox&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Vertical Frame&quot;) },</a>
<a name="ln131">      { ElementType::TBOX,                 &quot;TBox&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Text Frame&quot;) },</a>
<a name="ln132">      { ElementType::FBOX,                 &quot;FBox&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Fretboard Diagram Frame&quot;) },</a>
<a name="ln133">      { ElementType::ICON,                 &quot;Icon&quot;,                 QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Icon&quot;) },</a>
<a name="ln134">      { ElementType::OSSIA,                &quot;Ossia&quot;,                QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Ossia&quot;) },</a>
<a name="ln135">      { ElementType::BAGPIPE_EMBELLISHMENT,&quot;BagpipeEmbellishment&quot;, QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Bagpipe Embellishment&quot;) },</a>
<a name="ln136">      { ElementType::STICKING,             &quot;Sticking&quot;,             QT_TRANSLATE_NOOP(&quot;elementName&quot;, &quot;Sticking&quot;) }</a>
<a name="ln137">      };</a>
<a name="ln138"> </a>
<a name="ln139">//---------------------------------------------------------</a>
<a name="ln140">//   ScoreElement</a>
<a name="ln141">//---------------------------------------------------------</a>
<a name="ln142"> </a>
<a name="ln143">ScoreElement::ScoreElement(const ScoreElement&amp; se)</a>
<a name="ln144">      {</a>
<a name="ln145">      _score        = se._score;</a>
<a name="ln146">      _elementStyle = se._elementStyle;</a>
<a name="ln147">      if (_elementStyle) {</a>
<a name="ln148">            size_t n = _elementStyle-&gt;size();</a>
<a name="ln149">            _propertyFlagsList = new PropertyFlags[n];</a>
<a name="ln150">            for (size_t i = 0; i &lt; n; ++i)</a>
<a name="ln151">                  _propertyFlagsList[i] = se._propertyFlagsList[i];</a>
<a name="ln152">            }</a>
<a name="ln153">      _links = 0;</a>
<a name="ln154">      }</a>
<a name="ln155"> </a>
<a name="ln156">//---------------------------------------------------------</a>
<a name="ln157">//   ~Element</a>
<a name="ln158">//---------------------------------------------------------</a>
<a name="ln159"> </a>
<a name="ln160">ScoreElement::~ScoreElement()</a>
<a name="ln161">      {</a>
<a name="ln162">      if (_links) {</a>
<a name="ln163">            _links-&gt;removeOne(this);</a>
<a name="ln164">            if (_links-&gt;empty()) {</a>
<a name="ln165">                  delete _links;</a>
<a name="ln166">                  _links = 0;</a>
<a name="ln167">                  }</a>
<a name="ln168">            }</a>
<a name="ln169">      delete[] _propertyFlagsList;</a>
<a name="ln170">      }</a>
<a name="ln171"> </a>
<a name="ln172">//---------------------------------------------------------</a>
<a name="ln173">//   propertyDefault</a>
<a name="ln174">//---------------------------------------------------------</a>
<a name="ln175"> </a>
<a name="ln176">QVariant ScoreElement::propertyDefault(Pid pid, Tid tid) const</a>
<a name="ln177">      {</a>
<a name="ln178">      for (const StyledProperty&amp; spp : *textStyle(tid)) {</a>
<a name="ln179">            if (spp.pid == pid)</a>
<a name="ln180">                  return styleValue(pid, spp.sid);</a>
<a name="ln181">            }</a>
<a name="ln182">      return QVariant();</a>
<a name="ln183">      }</a>
<a name="ln184"> </a>
<a name="ln185">//---------------------------------------------------------</a>
<a name="ln186">//   propertyDefault</a>
<a name="ln187">//---------------------------------------------------------</a>
<a name="ln188"> </a>
<a name="ln189">QVariant ScoreElement::propertyDefault(Pid pid) const</a>
<a name="ln190">      {</a>
<a name="ln191">      Sid sid = getPropertyStyle(pid);</a>
<a name="ln192">      if (sid != Sid::NOSTYLE)</a>
<a name="ln193">            return styleValue(pid, sid);</a>
<a name="ln194">//      qDebug(&quot;&lt;%s&gt;(%d) not found in &lt;%s&gt;&quot;, propertyQmlName(pid), int(pid), name());</a>
<a name="ln195">      return QVariant();</a>
<a name="ln196">      }</a>
<a name="ln197"> </a>
<a name="ln198">//---------------------------------------------------------</a>
<a name="ln199">//   initElementStyle</a>
<a name="ln200">//---------------------------------------------------------</a>
<a name="ln201"> </a>
<a name="ln202">void ScoreElement::initElementStyle(const ElementStyle* ss)</a>
<a name="ln203">      {</a>
<a name="ln204">      _elementStyle = ss;</a>
<a name="ln205">      size_t n      = _elementStyle-&gt;size();</a>
<a name="ln206">      delete[] _propertyFlagsList;</a>
<a name="ln207">      _propertyFlagsList = new PropertyFlags[n];</a>
<a name="ln208">      for (size_t i = 0; i &lt; n; ++i)</a>
<a name="ln209">            _propertyFlagsList[i] = PropertyFlags::STYLED;</a>
<a name="ln210">      for (const StyledProperty&amp; spp : *_elementStyle)</a>
<a name="ln211">//            setProperty(spp.pid, styleValue(spp.pid, spp.sid));</a>
<a name="ln212">            setProperty(spp.pid, styleValue(spp.pid, getPropertyStyle(spp.pid)));</a>
<a name="ln213">      }</a>
<a name="ln214"> </a>
<a name="ln215">//---------------------------------------------------------</a>
<a name="ln216">//   resetProperty</a>
<a name="ln217">//---------------------------------------------------------</a>
<a name="ln218"> </a>
<a name="ln219">void ScoreElement::resetProperty(Pid pid)</a>
<a name="ln220">      {</a>
<a name="ln221">      QVariant v = propertyDefault(pid);</a>
<a name="ln222">      if (v.isValid()) {</a>
<a name="ln223">            setProperty(pid, v);</a>
<a name="ln224">            PropertyFlags p = propertyFlags(pid);</a>
<a name="ln225">            if (p == PropertyFlags::UNSTYLED)</a>
<a name="ln226">                  setPropertyFlags(pid, PropertyFlags::STYLED);</a>
<a name="ln227">            }</a>
<a name="ln228">      }</a>
<a name="ln229"> </a>
<a name="ln230">//---------------------------------------------------------</a>
<a name="ln231">//   undoResetProperty</a>
<a name="ln232">//---------------------------------------------------------</a>
<a name="ln233"> </a>
<a name="ln234">void ScoreElement::undoResetProperty(Pid id)</a>
<a name="ln235">      {</a>
<a name="ln236">      PropertyFlags f = propertyFlags(id);</a>
<a name="ln237">      if (f == PropertyFlags::UNSTYLED)</a>
<a name="ln238">            f = PropertyFlags::STYLED;</a>
<a name="ln239">      undoChangeProperty(id, propertyDefault(id), f);</a>
<a name="ln240">      }</a>
<a name="ln241"> </a>
<a name="ln242">//---------------------------------------------------------</a>
<a name="ln243">//   isStyled</a>
<a name="ln244">//---------------------------------------------------------</a>
<a name="ln245"> </a>
<a name="ln246">bool ScoreElement::isStyled(Pid pid) const</a>
<a name="ln247">      {</a>
<a name="ln248">      PropertyFlags f = propertyFlags(pid);</a>
<a name="ln249">      return f == PropertyFlags::STYLED;</a>
<a name="ln250">      }</a>
<a name="ln251"> </a>
<a name="ln252">//---------------------------------------------------------</a>
<a name="ln253">//   changeProperty</a>
<a name="ln254">//---------------------------------------------------------</a>
<a name="ln255"> </a>
<a name="ln256">static void changeProperty(ScoreElement* e, Pid t, const QVariant&amp; st, PropertyFlags ps)</a>
<a name="ln257">      {</a>
<a name="ln258">      if (e-&gt;getProperty(t) != st || e-&gt;propertyFlags(t) != ps) {</a>
<a name="ln259">            if (e-&gt;isBracketItem()) {</a>
<a name="ln260">                  BracketItem* bi = toBracketItem(e);</a>
<a name="ln261">                  e-&gt;score()-&gt;undo(new ChangeBracketProperty(bi-&gt;staff(), bi-&gt;column(), t, st, ps));</a>
<a name="ln262">                  }</a>
<a name="ln263">            else</a>
<a name="ln264">                  e-&gt;score()-&gt;undo(new ChangeProperty(e, t, st, ps));</a>
<a name="ln265">            }</a>
<a name="ln266">      }</a>
<a name="ln267"> </a>
<a name="ln268">//---------------------------------------------------------</a>
<a name="ln269">//   changeProperties</a>
<a name="ln270">//---------------------------------------------------------</a>
<a name="ln271"> </a>
<a name="ln272">static void changeProperties(ScoreElement* e, Pid t, const QVariant&amp; st, PropertyFlags ps)</a>
<a name="ln273">      {</a>
<a name="ln274">      if (propertyLink(t)) {</a>
<a name="ln275">            for (ScoreElement* ee : e-&gt;linkList())</a>
<a name="ln276">                  changeProperty(ee, t, st, ps);</a>
<a name="ln277">            }</a>
<a name="ln278">      else</a>
<a name="ln279">            changeProperty(e, t, st, ps);</a>
<a name="ln280">      }</a>
<a name="ln281"> </a>
<a name="ln282">//---------------------------------------------------------</a>
<a name="ln283">//   undoChangeProperty</a>
<a name="ln284">//---------------------------------------------------------</a>
<a name="ln285"> </a>
<a name="ln286">void ScoreElement::undoChangeProperty(Pid id, const QVariant&amp; v)</a>
<a name="ln287">      {</a>
<a name="ln288">      undoChangeProperty(id, v, propertyFlags(id));</a>
<a name="ln289">      }</a>
<a name="ln290"> </a>
<a name="ln291">void ScoreElement::undoChangeProperty(Pid id, const QVariant&amp; v, PropertyFlags ps)</a>
<a name="ln292">      {</a>
<a name="ln293">      if ((getProperty(id) == v) &amp;&amp; (propertyFlags(id) == ps))</a>
<a name="ln294">            return;</a>
<a name="ln295">      bool doUpdateInspector = false;</a>
<a name="ln296">      if (id == Pid::PLACEMENT || id == Pid::HAIRPIN_TYPE) {</a>
<a name="ln297">            // first set property, then set offset for above/below if styled</a>
<a name="ln298">            changeProperties(this, id, v, ps);</a>
<a name="ln299"> </a>
<a name="ln300">            if (isStyled(Pid::OFFSET)) {</a>
<a name="ln301">                  // TODO: maybe it just makes more sense to do this in Element::undoChangeProperty,</a>
<a name="ln302">                  // but some of the overrides call ScoreElement explicitly</a>
<a name="ln303">                  qreal sp;</a>
<a name="ln304">                  if (isElement())</a>
<a name="ln305">                        sp = toElement(this)-&gt;spatium();</a>
<a name="ln306">                  else</a>
<a name="ln307">                        sp = score()-&gt;spatium();</a>
<a name="ln308">                  ScoreElement::undoChangeProperty(Pid::OFFSET, score()-&gt;styleV(getPropertyStyle(Pid::OFFSET)).toPointF() * sp);</a>
<a name="ln309">                  Element* e = toElement(this);</a>
<a name="ln310">                  e-&gt;setOffsetChanged(false);</a>
<a name="ln311">                  }</a>
<a name="ln312">            doUpdateInspector = true;</a>
<a name="ln313">            }</a>
<a name="ln314">      else if (id == Pid::SUB_STYLE) {</a>
<a name="ln315">            //</a>
<a name="ln316">            // change a list of properties</a>
<a name="ln317">            //</a>
<a name="ln318">            auto l = textStyle(Tid(v.toInt()));</a>
<a name="ln319">            // Change to ElementStyle defaults</a>
<a name="ln320">            for (const StyledProperty&amp; p : *l) {</a>
<a name="ln321">                  if (p.sid == Sid::NOSTYLE)</a>
<a name="ln322">                        break;</a>
<a name="ln323">                  changeProperties(this, p.pid, score()-&gt;styleV(p.sid), PropertyFlags::STYLED);</a>
<a name="ln324">                  }</a>
<a name="ln325">            }</a>
<a name="ln326">      else if (id == Pid::OFFSET) {</a>
<a name="ln327">            // TODO: do this in caller?</a>
<a name="ln328">            if (isElement()) {</a>
<a name="ln329">                  Element* e = toElement(this);</a>
<a name="ln330">                  if (e-&gt;offset().y() != v.toPointF().y())</a>
<a name="ln331">                        e-&gt;setOffsetChanged(true, false, v.toPointF() - e-&gt;offset());</a>
<a name="ln332">                  }</a>
<a name="ln333">            }</a>
<a name="ln334">      changeProperties(this, id, v, ps);</a>
<a name="ln335">      if (id == Pid::VISIBLE) {</a>
<a name="ln336">            if (isNote())</a>
<a name="ln337">                  toNote(this)-&gt;undoChangeDotsVisible(v.toBool());</a>
<a name="ln338">            else if (isRest())</a>
<a name="ln339">                  toRest(this)-&gt;undoChangeDotsVisible(v.toBool());</a>
<a name="ln340">            }</a>
<a name="ln341">      if (id != Pid::GENERATED)</a>
<a name="ln342">            changeProperties(this, Pid::GENERATED, QVariant(false), PropertyFlags::NOSTYLE);</a>
<a name="ln343">      if (doUpdateInspector)</a>
<a name="ln344">            MuseScoreCore::mscoreCore-&gt;updateInspector();</a>
<a name="ln345">      }</a>
<a name="ln346"> </a>
<a name="ln347">//---------------------------------------------------------</a>
<a name="ln348">//   undoPushProperty</a>
<a name="ln349">//---------------------------------------------------------</a>
<a name="ln350"> </a>
<a name="ln351">void ScoreElement::undoPushProperty(Pid id)</a>
<a name="ln352">      {</a>
<a name="ln353">      QVariant val = getProperty(id);</a>
<a name="ln354">      score()-&gt;undoStack()-&gt;push1(new ChangeProperty(this, id, val));</a>
<a name="ln355">      }</a>
<a name="ln356"> </a>
<a name="ln357">//---------------------------------------------------------</a>
<a name="ln358">//   readProperty</a>
<a name="ln359">//---------------------------------------------------------</a>
<a name="ln360"> </a>
<a name="ln361">void ScoreElement::readProperty(XmlReader&amp; e, Pid id)</a>
<a name="ln362">      {</a>
<a name="ln363">      QVariant v = Ms::readProperty(id, e);</a>
<a name="ln364">      switch (propertyType(id)) {</a>
<a name="ln365">            case P_TYPE::SP_REAL:</a>
<a name="ln366">                  v = v.toReal() * score()-&gt;spatium();</a>
<a name="ln367">                  break;</a>
<a name="ln368">            case P_TYPE::POINT_SP:</a>
<a name="ln369">                  v = v.toPointF() * score()-&gt;spatium();</a>
<a name="ln370">                  break;</a>
<a name="ln371">            case P_TYPE::POINT_SP_MM:</a>
<a name="ln372">                  if (sizeIsSpatiumDependent())</a>
<a name="ln373">                        v = v.toPointF() * score()-&gt;spatium();</a>
<a name="ln374">                  else</a>
<a name="ln375">                        v = v.toPointF() * DPMM;</a>
<a name="ln376">                  break;</a>
<a name="ln377">            default:</a>
<a name="ln378">                  break;</a>
<a name="ln379">            }</a>
<a name="ln380">      setProperty(id, v);</a>
<a name="ln381">      if (isStyled(id))</a>
<a name="ln382">            setPropertyFlags(id, PropertyFlags::UNSTYLED);</a>
<a name="ln383">      }</a>
<a name="ln384"> </a>
<a name="ln385">bool ScoreElement::readProperty(const QStringRef&amp; s, XmlReader&amp; e, Pid id)</a>
<a name="ln386">      {</a>
<a name="ln387">      if (s == propertyName(id)) {</a>
<a name="ln388">            readProperty(e, id);</a>
<a name="ln389">            return true;</a>
<a name="ln390">            }</a>
<a name="ln391">      return false;</a>
<a name="ln392">      }</a>
<a name="ln393"> </a>
<a name="ln394">//-----------------------------------------------------------------------------</a>
<a name="ln395">//   writeProperty</a>
<a name="ln396">//</a>
<a name="ln397">//    - styled properties are never written</a>
<a name="ln398">//    - unstyled properties are always written regardless of value,</a>
<a name="ln399">//    - properties without style are written if different from default value</a>
<a name="ln400">//-----------------------------------------------------------------------------</a>
<a name="ln401"> </a>
<a name="ln402">void ScoreElement::writeProperty(XmlWriter&amp; xml, Pid pid) const</a>
<a name="ln403">      {</a>
<a name="ln404">      if (isStyled(pid))</a>
<a name="ln405">            return;</a>
<a name="ln406">      QVariant p = getProperty(pid);</a>
<a name="ln407">      if (!p.isValid()) {</a>
<a name="ln408">            qDebug(&quot;%s invalid property %d &lt;%s&gt;&quot;, name(), int(pid), propertyName(pid));</a>
<a name="ln409">            return;</a>
<a name="ln410">            }</a>
<a name="ln411">      PropertyFlags f = propertyFlags(pid);</a>
<a name="ln412">      QVariant d = (f != PropertyFlags::STYLED) ? propertyDefault(pid) : QVariant();</a>
<a name="ln413"> </a>
<a name="ln414">      if (pid == Pid::FONT_STYLE) {</a>
<a name="ln415">            FontStyle ds = FontStyle(d.isValid() ? d.toInt() : 0);</a>
<a name="ln416">            FontStyle fs = FontStyle(p.toInt());</a>
<a name="ln417">            if ((fs &amp; FontStyle::Bold) != (ds &amp; FontStyle::Bold))</a>
<a name="ln418">                  xml.tag(&quot;bold&quot;, fs &amp; FontStyle::Bold);</a>
<a name="ln419">            if ((fs &amp; FontStyle::Italic) != (ds &amp; FontStyle::Italic))</a>
<a name="ln420">                  xml.tag(&quot;italic&quot;, fs &amp; FontStyle::Italic);</a>
<a name="ln421">            if ((fs &amp; FontStyle::Underline) != (ds &amp; FontStyle::Underline))</a>
<a name="ln422">                  xml.tag(&quot;underline&quot;, fs &amp; FontStyle::Underline);</a>
<a name="ln423">            return;</a>
<a name="ln424">            }</a>
<a name="ln425"> </a>
<a name="ln426">      if (propertyType(pid) == P_TYPE::SP_REAL) {</a>
<a name="ln427">            qreal f1 = p.toReal();</a>
<a name="ln428">            if (d.isValid() &amp;&amp; qAbs(f1 - d.toReal()) &lt; 0.0001)          // fuzzy compare</a>
<a name="ln429">                  return;</a>
<a name="ln430">            p = QVariant(f1/score()-&gt;spatium());</a>
<a name="ln431">            d = QVariant();</a>
<a name="ln432">            }</a>
<a name="ln433">      else if (propertyType(pid) == P_TYPE::POINT_SP) {</a>
<a name="ln434">            QPointF p1 = p.toPointF();</a>
<a name="ln435">            if (d.isValid()) {</a>
<a name="ln436">                  QPointF p2 = d.toPointF();</a>
<a name="ln437">                  if ( (qAbs(p1.x() - p2.x()) &lt; 0.0001) &amp;&amp; (qAbs(p1.y() - p2.y()) &lt; 0.0001))</a>
<a name="ln438">                        return;</a>
<a name="ln439">                  }</a>
<a name="ln440">            p = QVariant(p1/score()-&gt;spatium());</a>
<a name="ln441">            d = QVariant();</a>
<a name="ln442">            }</a>
<a name="ln443">      else if (propertyType(pid) == P_TYPE::POINT_SP_MM) {</a>
<a name="ln444">            QPointF p1 = p.toPointF();</a>
<a name="ln445">            if (d.isValid()) {</a>
<a name="ln446">                  QPointF p2 = d.toPointF();</a>
<a name="ln447">                  if ((qAbs(p1.x() - p2.x()) &lt; 0.0001) &amp;&amp; (qAbs(p1.y() - p2.y()) &lt; 0.0001))</a>
<a name="ln448">                        return;</a>
<a name="ln449">                  }</a>
<a name="ln450">            qreal q = sizeIsSpatiumDependent() ? score()-&gt;spatium() : DPMM;</a>
<a name="ln451">            p = QVariant(p1/q);</a>
<a name="ln452">            d = QVariant();</a>
<a name="ln453">            }</a>
<a name="ln454">      xml.tag(pid, p, d);</a>
<a name="ln455">      }</a>
<a name="ln456"> </a>
<a name="ln457">//---------------------------------------------------------</a>
<a name="ln458">//   propertyId</a>
<a name="ln459">//---------------------------------------------------------</a>
<a name="ln460"> </a>
<a name="ln461">Pid ScoreElement::propertyId(const QStringRef&amp; xmlName) const</a>
<a name="ln462">      {</a>
<a name="ln463">      return Ms::propertyId(xmlName);</a>
<a name="ln464">      }</a>
<a name="ln465"> </a>
<a name="ln466">//---------------------------------------------------------</a>
<a name="ln467">//   propertyUserValue</a>
<a name="ln468">//---------------------------------------------------------</a>
<a name="ln469"> </a>
<a name="ln470">QString ScoreElement::propertyUserValue(Pid id) const</a>
<a name="ln471">      {</a>
<a name="ln472">      QVariant val = getProperty(id);</a>
<a name="ln473">      switch (propertyType(id)) {</a>
<a name="ln474">            case P_TYPE::POINT_SP:</a>
<a name="ln475">                  {</a>
<a name="ln476">                  QPointF p = val.toPointF();</a>
<a name="ln477">                  return QString(&quot;(%1, %2)&quot;).arg(p.x()).arg(p.y());</a>
<a name="ln478">                  }</a>
<a name="ln479">            case P_TYPE::DIRECTION:</a>
<a name="ln480">                  return toUserString(val.value&lt;Direction&gt;());</a>
<a name="ln481">            case P_TYPE::SYMID:</a>
<a name="ln482">                  return Sym::id2userName(val.value&lt;SymId&gt;());</a>
<a name="ln483">            default:</a>
<a name="ln484">                  break;</a>
<a name="ln485">            }</a>
<a name="ln486">      return val.toString();</a>
<a name="ln487">      }</a>
<a name="ln488"> </a>
<a name="ln489">//---------------------------------------------------------</a>
<a name="ln490">//   readStyledProperty</a>
<a name="ln491">//---------------------------------------------------------</a>
<a name="ln492"> </a>
<a name="ln493">bool ScoreElement::readStyledProperty(XmlReader&amp; e, const QStringRef&amp; tag)</a>
<a name="ln494">      {</a>
<a name="ln495">      for (const StyledProperty&amp; spp : *styledProperties()) {</a>
<a name="ln496">            if (readProperty(tag, e, spp.pid))</a>
<a name="ln497">                  return true;</a>
<a name="ln498">            }</a>
<a name="ln499">      return false;</a>
<a name="ln500">      }</a>
<a name="ln501"> </a>
<a name="ln502">//---------------------------------------------------------</a>
<a name="ln503">//   writeStyledProperties</a>
<a name="ln504">//---------------------------------------------------------</a>
<a name="ln505"> </a>
<a name="ln506">void ScoreElement::writeStyledProperties(XmlWriter&amp; xml) const</a>
<a name="ln507">      {</a>
<a name="ln508">      for (const StyledProperty&amp; spp : *styledProperties())</a>
<a name="ln509">            writeProperty(xml, spp.pid);</a>
<a name="ln510">      }</a>
<a name="ln511"> </a>
<a name="ln512">//---------------------------------------------------------</a>
<a name="ln513">//   reset</a>
<a name="ln514">//---------------------------------------------------------</a>
<a name="ln515"> </a>
<a name="ln516">void ScoreElement::reset()</a>
<a name="ln517">      {</a>
<a name="ln518">      for (const StyledProperty&amp; spp : *styledProperties())</a>
<a name="ln519">            undoResetProperty(spp.pid);</a>
<a name="ln520">      }</a>
<a name="ln521"> </a>
<a name="ln522">//---------------------------------------------------------</a>
<a name="ln523">//   readAddConnector</a>
<a name="ln524">//---------------------------------------------------------</a>
<a name="ln525"> </a>
<a name="ln526">void ScoreElement::readAddConnector(ConnectorInfoReader* info, bool pasteMode)</a>
<a name="ln527">      {</a>
<a name="ln528">      Q_UNUSED(pasteMode);</a>
<a name="ln529">      qDebug(&quot;Cannot add connector %s to %s&quot;, info-&gt;connector()-&gt;name(), name());</a>
<a name="ln530">      }</a>
<a name="ln531"> </a>
<a name="ln532">//---------------------------------------------------------</a>
<a name="ln533">//   linkTo</a>
<a name="ln534">//    link this to element</a>
<a name="ln535">//---------------------------------------------------------</a>
<a name="ln536"> </a>
<a name="ln537">void ScoreElement::linkTo(ScoreElement* element)</a>
<a name="ln538">      {</a>
<a name="ln539">      Q_ASSERT(element != this);</a>
<a name="ln540">      Q_ASSERT(!_links);</a>
<a name="ln541"> </a>
<a name="ln542">      if (element-&gt;links()) {</a>
<a name="ln543">            _links = element-&gt;_links;</a>
<a name="ln544">            Q_ASSERT(_links-&gt;contains(element));</a>
<a name="ln545">            }</a>
<a name="ln546">      else {</a>
<a name="ln547">            if (isStaff())</a>
<a name="ln548">                  _links = new LinkedElements(score(), -1); // donâ€™t use lid</a>
<a name="ln549">            else</a>
<a name="ln550">                  _links = new LinkedElements(score());</a>
<a name="ln551">            _links-&gt;append(element);</a>
<a name="ln552">            element-&gt;_links = _links;</a>
<a name="ln553">            }</a>
<a name="ln554">      Q_ASSERT(!_links-&gt;contains(this));</a>
<a name="ln555">      _links-&gt;append(this);</a>
<a name="ln556">      }</a>
<a name="ln557"> </a>
<a name="ln558">//---------------------------------------------------------</a>
<a name="ln559">//   unlink</a>
<a name="ln560">//---------------------------------------------------------</a>
<a name="ln561"> </a>
<a name="ln562">void ScoreElement::unlink()</a>
<a name="ln563">      {</a>
<a name="ln564">      Q_ASSERT(_links);</a>
<a name="ln565">      Q_ASSERT(_links-&gt;contains(this));</a>
<a name="ln566">      _links-&gt;removeOne(this);</a>
<a name="ln567"> </a>
<a name="ln568">      // if link list is empty, remove list</a>
<a name="ln569">      if (_links-&gt;size() &lt;= 1) {</a>
<a name="ln570">            if (!_links-&gt;empty())</a>
<a name="ln571">                  _links-&gt;front()-&gt;_links = 0;</a>
<a name="ln572">            delete _links;</a>
<a name="ln573">            }</a>
<a name="ln574">      _links = 0; // this element is not linked anymore</a>
<a name="ln575">      }</a>
<a name="ln576"> </a>
<a name="ln577">//---------------------------------------------------------</a>
<a name="ln578">//   isLinked</a>
<a name="ln579">///  return true if se is different and</a>
<a name="ln580">///  linked to this element</a>
<a name="ln581">//---------------------------------------------------------</a>
<a name="ln582"> </a>
<a name="ln583">bool ScoreElement::isLinked(ScoreElement* se)</a>
<a name="ln584">      {</a>
<a name="ln585">      return se != this &amp;&amp; _links &amp;&amp; _links-&gt;contains(se);</a>
<a name="ln586">      }</a>
<a name="ln587"> </a>
<a name="ln588">//---------------------------------------------------------</a>
<a name="ln589">//   undoUnlink</a>
<a name="ln590">//---------------------------------------------------------</a>
<a name="ln591"> </a>
<a name="ln592">void ScoreElement::undoUnlink()</a>
<a name="ln593">      {</a>
<a name="ln594">      if (_links)</a>
<a name="ln595">            _score-&gt;undo(new Unlink(this));</a>
<a name="ln596">      }</a>
<a name="ln597"> </a>
<a name="ln598">//---------------------------------------------------------</a>
<a name="ln599">//   linkList</a>
<a name="ln600">//---------------------------------------------------------</a>
<a name="ln601"> </a>
<a name="ln602">QList&lt;ScoreElement*&gt; ScoreElement::linkList() const</a>
<a name="ln603">      {</a>
<a name="ln604">      QList&lt;ScoreElement*&gt; el;</a>
<a name="ln605">      if (_links)</a>
<a name="ln606">            el = *_links;</a>
<a name="ln607">      else</a>
<a name="ln608">            el.append(const_cast&lt;ScoreElement*&gt;(this));</a>
<a name="ln609">      return el;</a>
<a name="ln610">      }</a>
<a name="ln611"> </a>
<a name="ln612">//---------------------------------------------------------</a>
<a name="ln613">//   LinkedElements</a>
<a name="ln614">//---------------------------------------------------------</a>
<a name="ln615"> </a>
<a name="ln616">LinkedElements::LinkedElements(Score* score)</a>
<a name="ln617">      {</a>
<a name="ln618">      _lid = score-&gt;linkId(); // create new unique id</a>
<a name="ln619">      }</a>
<a name="ln620"> </a>
<a name="ln621">LinkedElements::LinkedElements(Score* score, int id)</a>
<a name="ln622">      {</a>
<a name="ln623">      _lid = id;</a>
<a name="ln624">      if (_lid != -1)</a>
<a name="ln625">            score-&gt;linkId(id);      // remember used id</a>
<a name="ln626">      }</a>
<a name="ln627"> </a>
<a name="ln628">//---------------------------------------------------------</a>
<a name="ln629">//   setLid</a>
<a name="ln630">//---------------------------------------------------------</a>
<a name="ln631"> </a>
<a name="ln632">void LinkedElements::setLid(Score* score, int id)</a>
<a name="ln633">      {</a>
<a name="ln634">      _lid = id;</a>
<a name="ln635">      score-&gt;linkId(id);</a>
<a name="ln636">      }</a>
<a name="ln637"> </a>
<a name="ln638">//---------------------------------------------------------</a>
<a name="ln639">//   mainElement</a>
<a name="ln640">//    Returns &quot;main&quot; linked element which is expected to</a>
<a name="ln641">//    be written to the file prior to others.</a>
<a name="ln642">//---------------------------------------------------------</a>
<a name="ln643"> </a>
<a name="ln644">ScoreElement* LinkedElements::mainElement()</a>
<a name="ln645">      {</a>
<a name="ln646">      if (isEmpty())</a>
<a name="ln647">            return nullptr;</a>
<a name="ln648">      MasterScore* ms = at(0)-&gt;masterScore();</a>
<a name="ln649">      const bool elements = at(0)-&gt;isElement();</a>
<a name="ln650">      const bool staves = at(0)-&gt;isStaff();</a>
<a name="ln651">      return *std::min_element(begin(), end(), [ms, elements, staves](ScoreElement* s1, ScoreElement* s2) {</a>
<a name="ln652">            if (s1-&gt;score() == ms &amp;&amp; s2-&gt;score() != ms)</a>
<a name="ln653">                  return true;</a>
<a name="ln654">            if (s1-&gt;score() != s2-&gt;score())</a>
<a name="ln655">                  return false;</a>
<a name="ln656">            if (staves)</a>
<a name="ln657">                  return toStaff(s1)-&gt;idx() &lt; toStaff(s2)-&gt;idx();</a>
<a name="ln658">            if (elements) {</a>
<a name="ln659">                  // Now we compare either two elements from master score</a>
<a name="ln660">                  // or two elements from excerpt.</a>
<a name="ln661">                  Element* e1 = toElement(s1);</a>
<a name="ln662">                  Element* e2 = toElement(s2);</a>
<a name="ln663">                  const int tr1 = e1-&gt;track();</a>
<a name="ln664">                  const int tr2 = e2-&gt;track();</a>
<a name="ln665">                  if (tr1 == tr2) {</a>
<a name="ln666">                        const Fraction tick1 = e1-&gt;tick();</a>
<a name="ln667">                        const Fraction tick2 = e2-&gt;tick();</a>
<a name="ln668">                        if (tick1 == tick2) {</a>
<a name="ln669">                              Measure* m1 = e1-&gt;findMeasure();</a>
<a name="ln670">                              Measure* m2 = e2-&gt;findMeasure();</a>
<a name="ln671">                              if (!m1 || !m2)</a>
<a name="ln672">                                    return false;</a>
<a name="ln673"> </a>
<a name="ln674">                              // MM rests are written to MSCX in the following order:</a>
<a name="ln675">                              // 1) first measure of MM rest (m-&gt;hasMMRest() == true);</a>
<a name="ln676">                              // 2) MM rest itself (m-&gt;isMMRest() == true);</a>
<a name="ln677">                              // 3) other measures of MM rest (m-&gt;hasMMRest() == false).</a>
<a name="ln678">                              //</a>
<a name="ln679">                              // As mainElement() must find the first element that</a>
<a name="ln680">                              // is going to be written to a file, MM rest writing</a>
<a name="ln681">                              // order should also be considered.</a>
<a name="ln682"> </a>
<a name="ln683">                              if (m1-&gt;isMMRest() == m2-&gt;isMMRest()) {</a>
<a name="ln684">                                    // no difference if both are MM rests or both are usual measures</a>
<a name="ln685">                                    return false;</a>
<a name="ln686">                                    }</a>
<a name="ln687"> </a>
<a name="ln688">                              // MM rests may be generated but not written (e.g. if</a>
<a name="ln689">                              // saving a file right after disabling MM rests)</a>
<a name="ln690">                              const bool mmRestsWritten = e1-&gt;score()-&gt;styleB(Sid::createMultiMeasureRests);</a>
<a name="ln691"> </a>
<a name="ln692">                              if (m1-&gt;isMMRest()) {</a>
<a name="ln693">                                    // m1 is earlier if m2 is *not* the first MM rest measure</a>
<a name="ln694">                                    return mmRestsWritten &amp;&amp; !m2-&gt;hasMMRest();</a>
<a name="ln695">                                    }</a>
<a name="ln696">                              if (m2-&gt;isMMRest()) {</a>
<a name="ln697">                                    // m1 is earlier if it *is* the first MM rest measure</a>
<a name="ln698">                                    return !mmRestsWritten || m1-&gt;hasMMRest();</a>
<a name="ln699">                                    }</a>
<a name="ln700">                              return false;</a>
<a name="ln701">                              }</a>
<a name="ln702">                        return tick1 &lt; tick2;</a>
<a name="ln703">                        }</a>
<a name="ln704">                  return tr1 &lt; tr2;</a>
<a name="ln705">                  }</a>
<a name="ln706">            return false;</a>
<a name="ln707">            });</a>
<a name="ln708">      }</a>
<a name="ln709"> </a>
<a name="ln710">//---------------------------------------------------------</a>
<a name="ln711">//   masterScore</a>
<a name="ln712">//---------------------------------------------------------</a>
<a name="ln713"> </a>
<a name="ln714">MasterScore* ScoreElement::masterScore() const</a>
<a name="ln715">      {</a>
<a name="ln716">      return _score-&gt;masterScore();</a>
<a name="ln717">      }</a>
<a name="ln718"> </a>
<a name="ln719">//---------------------------------------------------------</a>
<a name="ln720">//   getPropertyFlagsIdx</a>
<a name="ln721">//---------------------------------------------------------</a>
<a name="ln722"> </a>
<a name="ln723">int ScoreElement::getPropertyFlagsIdx(Pid id) const</a>
<a name="ln724">      {</a>
<a name="ln725">      int i = 0;</a>
<a name="ln726">      for (const StyledProperty&amp; p : *_elementStyle) {</a>
<a name="ln727">            if (p.pid == id)</a>
<a name="ln728">                  return i;</a>
<a name="ln729">            ++i;</a>
<a name="ln730">            }</a>
<a name="ln731">      return -1;</a>
<a name="ln732">      }</a>
<a name="ln733"> </a>
<a name="ln734">//---------------------------------------------------------</a>
<a name="ln735">//   propertyFlags</a>
<a name="ln736">//---------------------------------------------------------</a>
<a name="ln737"> </a>
<a name="ln738">PropertyFlags ScoreElement::propertyFlags(Pid id) const</a>
<a name="ln739">      {</a>
<a name="ln740">      static PropertyFlags f = PropertyFlags::NOSTYLE;</a>
<a name="ln741"> </a>
<a name="ln742">      int i = getPropertyFlagsIdx(id);</a>
<a name="ln743">      if (i == -1)</a>
<a name="ln744">            return f;</a>
<a name="ln745">      return _propertyFlagsList[i];</a>
<a name="ln746">      }</a>
<a name="ln747"> </a>
<a name="ln748">//---------------------------------------------------------</a>
<a name="ln749">//   setPropertyFlags</a>
<a name="ln750">//---------------------------------------------------------</a>
<a name="ln751"> </a>
<a name="ln752">void ScoreElement::setPropertyFlags(Pid id, PropertyFlags f)</a>
<a name="ln753">      {</a>
<a name="ln754">      int i = getPropertyFlagsIdx(id);</a>
<a name="ln755">      if (i == -1)</a>
<a name="ln756">            return;</a>
<a name="ln757">      _propertyFlagsList[i] = f;</a>
<a name="ln758">      }</a>
<a name="ln759"> </a>
<a name="ln760">//---------------------------------------------------------</a>
<a name="ln761">//   getPropertyStyle</a>
<a name="ln762">//---------------------------------------------------------</a>
<a name="ln763"> </a>
<a name="ln764">Sid ScoreElement::getPropertyStyle(Pid id) const</a>
<a name="ln765">      {</a>
<a name="ln766">      for (const StyledProperty&amp; p : *_elementStyle) {</a>
<a name="ln767">            if (p.pid == id)</a>
<a name="ln768">                  return p.sid;</a>
<a name="ln769">            }</a>
<a name="ln770">      return Sid::NOSTYLE;</a>
<a name="ln771">      }</a>
<a name="ln772"> </a>
<a name="ln773">//---------------------------------------------------------</a>
<a name="ln774">//   styleChanged</a>
<a name="ln775">//---------------------------------------------------------</a>
<a name="ln776"> </a>
<a name="ln777">void ScoreElement::styleChanged()</a>
<a name="ln778">      {</a>
<a name="ln779">      for (const StyledProperty&amp; spp : *_elementStyle) {</a>
<a name="ln780">            PropertyFlags f = propertyFlags(spp.pid);</a>
<a name="ln781">            if (f == PropertyFlags::STYLED)</a>
<a name="ln782">                  setProperty(spp.pid, styleValue(spp.pid, getPropertyStyle(spp.pid)));</a>
<a name="ln783">            }</a>
<a name="ln784">      }</a>
<a name="ln785"> </a>
<a name="ln786">//---------------------------------------------------------</a>
<a name="ln787">//   name</a>
<a name="ln788">//---------------------------------------------------------</a>
<a name="ln789"> </a>
<a name="ln790">const char* ScoreElement::name() const</a>
<a name="ln791">      {</a>
<a name="ln792">      return name(type());</a>
<a name="ln793">      }</a>
<a name="ln794"> </a>
<a name="ln795">//---------------------------------------------------------</a>
<a name="ln796">//   name</a>
<a name="ln797">//---------------------------------------------------------</a>
<a name="ln798"> </a>
<a name="ln799">const char* ScoreElement::name(ElementType type)</a>
<a name="ln800">      {</a>
<a name="ln801">      return elementNames[int(type)].name;</a>
<a name="ln802">      }</a>
<a name="ln803"> </a>
<a name="ln804">//---------------------------------------------------------</a>
<a name="ln805">//   userName</a>
<a name="ln806">//---------------------------------------------------------</a>
<a name="ln807"> </a>
<a name="ln808">QString ScoreElement::userName() const</a>
<a name="ln809">      {</a>
<a name="ln810">      return qApp-&gt;translate(&quot;elementName&quot;, elementNames[int(type())].userName);</a>
<a name="ln811">      }</a>
<a name="ln812"> </a>
<a name="ln813">//---------------------------------------------------------</a>
<a name="ln814">//   name2type</a>
<a name="ln815">//---------------------------------------------------------</a>
<a name="ln816"> </a>
<a name="ln817">ElementType ScoreElement::name2type(const QStringRef&amp; s, bool silent)</a>
<a name="ln818">      {</a>
<a name="ln819">      for (int i = 0; i &lt; int(ElementType::MAXTYPE); ++i) {</a>
<a name="ln820">            if (s == elementNames[i].name)</a>
<a name="ln821">                  return ElementType(i);</a>
<a name="ln822">            }</a>
<a name="ln823">      if (!silent)</a>
<a name="ln824">            qDebug(&quot;unknown type &lt;%s&gt;&quot;, qPrintable(s.toString()));</a>
<a name="ln825">      return ElementType::INVALID;</a>
<a name="ln826">      }</a>
<a name="ln827"> </a>
<a name="ln828">//---------------------------------------------------------</a>
<a name="ln829">//   isSLineSegment</a>
<a name="ln830">//---------------------------------------------------------</a>
<a name="ln831"> </a>
<a name="ln832">bool ScoreElement::isSLineSegment() const</a>
<a name="ln833">      {</a>
<a name="ln834">      return isHairpinSegment() || isOttavaSegment() || isPedalSegment()</a>
<a name="ln835">         || isTrillSegment() || isVoltaSegment() || isTextLineSegment()</a>
<a name="ln836">         || isGlissandoSegment() || isLetRingSegment() || isVibratoSegment() || isPalmMuteSegment();</a>
<a name="ln837">      }</a>
<a name="ln838"> </a>
<a name="ln839">//---------------------------------------------------------</a>
<a name="ln840">//   isText</a>
<a name="ln841">//---------------------------------------------------------</a>
<a name="ln842"> </a>
<a name="ln843">bool ScoreElement::isTextBase() const</a>
<a name="ln844">      {</a>
<a name="ln845">      return type()  == ElementType::TEXT</a>
<a name="ln846">         || type() == ElementType::LYRICS</a>
<a name="ln847">         || type() == ElementType::DYNAMIC</a>
<a name="ln848">         || type() == ElementType::FINGERING</a>
<a name="ln849">         || type() == ElementType::HARMONY</a>
<a name="ln850">         || type() == ElementType::MARKER</a>
<a name="ln851">         || type() == ElementType::JUMP</a>
<a name="ln852">         || type() == ElementType::STAFF_TEXT</a>
<a name="ln853">         || type() == ElementType::SYSTEM_TEXT</a>
<a name="ln854">         || type() == ElementType::REHEARSAL_MARK</a>
<a name="ln855">         || type() == ElementType::INSTRUMENT_CHANGE</a>
<a name="ln856">         || type() == ElementType::FIGURED_BASS</a>
<a name="ln857">         || type() == ElementType::TEMPO_TEXT</a>
<a name="ln858">         || type() == ElementType::INSTRUMENT_NAME</a>
<a name="ln859">         || type() == ElementType::MEASURE_NUMBER</a>
<a name="ln860">         || type() == ElementType::STICKING</a>
<a name="ln861">         ;</a>
<a name="ln862">      }</a>
<a name="ln863"> </a>
<a name="ln864">//---------------------------------------------------------</a>
<a name="ln865">//   styleValue</a>
<a name="ln866">//---------------------------------------------------------</a>
<a name="ln867"> </a>
<a name="ln868">QVariant ScoreElement::styleValue(Pid pid, Sid sid) const</a>
<a name="ln869">      {</a>
<a name="ln870">      switch (propertyType(pid)) {</a>
<a name="ln871">            case P_TYPE::SP_REAL:</a>
<a name="ln872">                  return score()-&gt;styleP(sid);</a>
<a name="ln873">            case P_TYPE::POINT_SP: {</a>
<a name="ln874">                  QPointF val = score()-&gt;styleV(sid).toPointF() * score()-&gt;spatium();</a>
<a name="ln875">                  if (isElement()) {</a>
<a name="ln876">                        const Element* e = toElement(this);</a>
<a name="ln877">                        if (e-&gt;staff() &amp;&amp; !e-&gt;systemFlag())</a>
<a name="ln878">                              val *= e-&gt;staff()-&gt;mag(e-&gt;tick());</a>
<a name="ln879">                        }</a>
<a name="ln880">                  return val;</a>
<a name="ln881">                  }</a>
<a name="ln882">            case P_TYPE::POINT_SP_MM: {</a>
<a name="ln883">                  QPointF val = score()-&gt;styleV(sid).toPointF();</a>
<a name="ln884">                  if (sizeIsSpatiumDependent()) {</a>
<a name="ln885">                        val *= score()-&gt;spatium();</a>
<a name="ln886">                        if (isElement()) {</a>
<a name="ln887">                              const Element* e = toElement(this);</a>
<a name="ln888">                              if (e-&gt;staff() &amp;&amp; !e-&gt;systemFlag())</a>
<a name="ln889">                                    val *= e-&gt;staff()-&gt;mag(e-&gt;tick());</a>
<a name="ln890">                              }</a>
<a name="ln891">                        }</a>
<a name="ln892">                  else {</a>
<a name="ln893">                        val *= DPMM;</a>
<a name="ln894">                        }</a>
<a name="ln895">                  return val;</a>
<a name="ln896">                  }</a>
<a name="ln897">            default:</a>
<a name="ln898">                  return score()-&gt;styleV(sid);</a>
<a name="ln899">            }</a>
<a name="ln900">      }</a>
<a name="ln901">}</a>
<a name="ln902"> </a>

</code></pre>
<div class="balloon" rel="824"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
