
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>musedata.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Linux Music Score Editor</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2007 Werner Schweer and others</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2.</a>
<a name="ln9">//</a>
<a name="ln10">//  This program is distributed in the hope that it will be useful,</a>
<a name="ln11">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">//  GNU General Public License for more details.</a>
<a name="ln14">//</a>
<a name="ln15">//  You should have received a copy of the GNU General Public License</a>
<a name="ln16">//  along with this program; if not, write to the Free Software</a>
<a name="ln17">//  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</a>
<a name="ln18">//=============================================================================</a>
<a name="ln19"> </a>
<a name="ln20">#include &quot;musedata.h&quot;</a>
<a name="ln21">#include &quot;libmscore/score.h&quot;</a>
<a name="ln22">#include &quot;libmscore/part.h&quot;</a>
<a name="ln23">#include &quot;libmscore/staff.h&quot;</a>
<a name="ln24">#include &quot;libmscore/barline.h&quot;</a>
<a name="ln25">#include &quot;libmscore/clef.h&quot;</a>
<a name="ln26">#include &quot;libmscore/key.h&quot;</a>
<a name="ln27">#include &quot;libmscore/note.h&quot;</a>
<a name="ln28">#include &quot;libmscore/chord.h&quot;</a>
<a name="ln29">#include &quot;libmscore/rest.h&quot;</a>
<a name="ln30">#include &quot;libmscore/text.h&quot;</a>
<a name="ln31">#include &quot;libmscore/bracket.h&quot;</a>
<a name="ln32">#include &quot;libmscore/tuplet.h&quot;</a>
<a name="ln33">#include &quot;libmscore/slur.h&quot;</a>
<a name="ln34">#include &quot;libmscore/dynamic.h&quot;</a>
<a name="ln35">#include &quot;libmscore/lyrics.h&quot;</a>
<a name="ln36">#include &quot;libmscore/articulation.h&quot;</a>
<a name="ln37">#include &quot;libmscore/sig.h&quot;</a>
<a name="ln38">#include &quot;libmscore/measure.h&quot;</a>
<a name="ln39">#include &quot;libmscore/timesig.h&quot;</a>
<a name="ln40">#include &quot;libmscore/segment.h&quot;</a>
<a name="ln41">#include &quot;libmscore/sym.h&quot;</a>
<a name="ln42"> </a>
<a name="ln43">namespace Ms {</a>
<a name="ln44"> </a>
<a name="ln45">//---------------------------------------------------------</a>
<a name="ln46">//   musicalAttribute</a>
<a name="ln47">//---------------------------------------------------------</a>
<a name="ln48"> </a>
<a name="ln49">void MuseData::musicalAttribute(QString s, Part* part)</a>
<a name="ln50">      {</a>
<a name="ln51">      QStringList al = s.mid(3).split(&quot; &quot;, QString::SkipEmptyParts);</a>
<a name="ln52">      foreach(QString item, al) {</a>
<a name="ln53">            if (item.startsWith(&quot;K:&quot;)) {</a>
<a name="ln54">                  int key = item.mid(2).toInt();</a>
<a name="ln55">                  KeySigEvent ke;</a>
<a name="ln56">                  ke.setKey(Key(key));</a>
<a name="ln57">                  for (Staff* staff : *(part-&gt;staves()))</a>
<a name="ln58">                        staff-&gt;setKey(curTick, ke);</a>
<a name="ln59">                  }</a>
<a name="ln60">            else if (item.startsWith(&quot;Q:&quot;)) {</a>
<a name="ln61">                  _division = item.mid(2).toInt();</a>
<a name="ln62">                  }</a>
<a name="ln63">            else if (item.startsWith(&quot;T:&quot;)) {</a>
<a name="ln64">                  QStringList tl = item.mid(2).split(&quot;/&quot;);</a>
<a name="ln65">                  if (tl.size() != 2) {</a>
<a name="ln66">                        qDebug(&quot;bad time sig &lt;%s&gt;&quot;, qPrintable(item));</a>
<a name="ln67">                        continue;</a>
<a name="ln68">                        }</a>
<a name="ln69">                  int z = tl[0].toInt();</a>
<a name="ln70">                  int n = tl[1].toInt();</a>
<a name="ln71">                  if ((z &gt; 0) &amp;&amp; (n &gt; 0)) {</a>
<a name="ln72">//TODO                        score-&gt;sigmap()-&gt;add(curTick, Fraction(z, n));</a>
<a name="ln73">                        TimeSig* ts = new TimeSig(score);</a>
<a name="ln74">                        Staff* staff = part-&gt;staff(0);</a>
<a name="ln75">                        ts-&gt;setTrack(staff-&gt;idx() * VOICES);</a>
<a name="ln76">                        Measure* mes = score-&gt;tick2measure(curTick);</a>
<a name="ln77">                        Segment* seg = mes-&gt;getSegment(SegmentType::TimeSig, curTick);</a>
<a name="ln78">                        seg-&gt;add(ts);</a>
<a name="ln79">                        }</a>
<a name="ln80">                  }</a>
<a name="ln81">            else if (item.startsWith(&quot;X:&quot;))</a>
<a name="ln82">                  ;</a>
<a name="ln83">            else if (item[0] == 'C') {</a>
<a name="ln84">                  int staffIdx = 1;</a>
<a name="ln85">//                  int col = 2;</a>
<a name="ln86">                  if (item[1].isDigit()) {</a>
<a name="ln87">                        staffIdx = item.mid(1,1).toInt();</a>
<a name="ln88">//                        col = 3;</a>
<a name="ln89">                        }</a>
<a name="ln90">                  staffIdx -= 1;</a>
<a name="ln91">/*                  int clef = item.mid(col).toInt();</a>
<a name="ln92">                  ClefType mscoreClef = ClefType::G;</a>
<a name="ln93">                  switch(clef) {</a>
<a name="ln94">                        case 4:  mscoreClef = ClefType::G; break;</a>
<a name="ln95">                        case 22: mscoreClef = ClefType::F; break;</a>
<a name="ln96">                        case 13: mscoreClef = ClefType::C3; break;</a>
<a name="ln97">                        case 14: mscoreClef = ClefType::C2; break;</a>
<a name="ln98">                        case 15: mscoreClef = ClefType::C1; break;</a>
<a name="ln99">                        default:</a>
<a name="ln100">                              qDebug(&quot;unknown clef %d&quot;, clef);</a>
<a name="ln101">                              break;</a>
<a name="ln102">                        }</a>
<a name="ln103">                  */</a>
<a name="ln104">//                  Staff* staff = part-&gt;staff(staffIdx);</a>
<a name="ln105">//                  staff-&gt;setClef(curTick, mscoreClef);</a>
<a name="ln106">                  }</a>
<a name="ln107">            else</a>
<a name="ln108">                  qDebug(&quot;unknown $key &lt;%s&gt;&quot;, qPrintable(item));</a>
<a name="ln109">            }</a>
<a name="ln110">      }</a>
<a name="ln111"> </a>
<a name="ln112">//---------------------------------------------------------</a>
<a name="ln113">//   readChord</a>
<a name="ln114">//---------------------------------------------------------</a>
<a name="ln115"> </a>
<a name="ln116">void MuseData::readChord(Part*, const QString&amp; s)</a>
<a name="ln117">      {</a>
<a name="ln118">      //                       a  b   c  d  e  f  g</a>
<a name="ln119">      static int table[7]  = { 9, 11, 0, 2, 4, 5, 7 };</a>
<a name="ln120"> </a>
<a name="ln121">      int step  = s[1].toLatin1() - 'A';</a>
<a name="ln122">      int alter = 0;</a>
<a name="ln123">      int octave = 0;</a>
<a name="ln124">      for (int i = 2; i &lt; 4; ++i) {</a>
<a name="ln125">            if (s[i] == '#')</a>
<a name="ln126">                  alter += 1;</a>
<a name="ln127">            else if (s[i] == 'f')</a>
<a name="ln128">                  alter -= 1;</a>
<a name="ln129">            else if (s[i].isDigit()) {</a>
<a name="ln130">                  octave = s.mid(i,1).toInt();</a>
<a name="ln131">                  break;</a>
<a name="ln132">                  }</a>
<a name="ln133">            }</a>
<a name="ln134">      int staffIdx = 0;</a>
<a name="ln135">      if (s.size() &gt;= 24) {</a>
<a name="ln136">            if (s[23].isDigit())</a>
<a name="ln137">                  staffIdx = s.mid(23,1).toInt() - 1;</a>
<a name="ln138">            }</a>
<a name="ln139">      int pitch = table[step] + alter + (octave + 1) * 12;</a>
<a name="ln140">      if (pitch &lt; 0)</a>
<a name="ln141">            pitch = 0;</a>
<a name="ln142">      if (pitch &gt; 127)</a>
<a name="ln143">            pitch = 127;</a>
<a name="ln144"> </a>
<a name="ln145">      Chord* chord = (Chord*)chordRest;</a>
<a name="ln146">      Note* note = new Note(score);</a>
<a name="ln147">      note-&gt;setPitch(pitch);</a>
<a name="ln148">      note-&gt;setTpcFromPitch();</a>
<a name="ln149">      note-&gt;setTrack(staffIdx * VOICES + voice);</a>
<a name="ln150">      chord-&gt;add(note);</a>
<a name="ln151">      }</a>
<a name="ln152"> </a>
<a name="ln153">//---------------------------------------------------------</a>
<a name="ln154">//   openSlur</a>
<a name="ln155">//---------------------------------------------------------</a>
<a name="ln156"> </a>
<a name="ln157">void MuseData::openSlur(int idx, const Fraction&amp; tick, Staff* staff, int voc)</a>
<a name="ln158">      {</a>
<a name="ln159">      int staffIdx = staff-&gt;idx();</a>
<a name="ln160">      if (slur[idx]) {</a>
<a name="ln161">            qDebug(&quot;%06d: slur %d already open&quot;, tick.ticks(), idx+1);</a>
<a name="ln162">            return;</a>
<a name="ln163">            }</a>
<a name="ln164">      slur[idx] = new Slur(score);</a>
<a name="ln165">      slur[idx]-&gt;setTick(tick);</a>
<a name="ln166">      slur[idx]-&gt;setTrack(staffIdx * VOICES + voc);</a>
<a name="ln167">      score-&gt;addElement(slur[idx]);</a>
<a name="ln168">      }</a>
<a name="ln169"> </a>
<a name="ln170">//---------------------------------------------------------</a>
<a name="ln171">//   closeSlur</a>
<a name="ln172">//---------------------------------------------------------</a>
<a name="ln173"> </a>
<a name="ln174">void MuseData::closeSlur(int idx, const Fraction&amp; tick, Staff* staff, int voc)</a>
<a name="ln175">      {</a>
<a name="ln176">      int staffIdx = staff-&gt;idx();</a>
<a name="ln177">      if (slur[idx]) {</a>
<a name="ln178">            slur[idx]-&gt;setTick2(tick);</a>
<a name="ln179">            slur[idx]-&gt;setTrack2(staffIdx * VOICES + voc);</a>
<a name="ln180">            slur[idx] = 0;</a>
<a name="ln181">            }</a>
<a name="ln182">      else</a>
<a name="ln183">            qDebug(&quot;%06d: slur %d not open&quot;, tick.ticks(), idx+1);</a>
<a name="ln184">      }</a>
<a name="ln185"> </a>
<a name="ln186">//---------------------------------------------------------</a>
<a name="ln187">//   readNote</a>
<a name="ln188">//---------------------------------------------------------</a>
<a name="ln189"> </a>
<a name="ln190">void MuseData::readNote(Part* part, const QString&amp; s)</a>
<a name="ln191">      {</a>
<a name="ln192">      //                       a  b   c  d  e  f  g</a>
<a name="ln193">      static int table[7]  = { 9, 11, 0, 2, 4, 5, 7 };</a>
<a name="ln194"> </a>
<a name="ln195">      int step  = s[0].toLatin1() - 'A';</a>
<a name="ln196">      int alter = 0;</a>
<a name="ln197">      int octave = 0;</a>
<a name="ln198">      for (int i = 1; i &lt; 3; ++i) {</a>
<a name="ln199">            if (s[i] == '#')</a>
<a name="ln200">                  alter += 1;</a>
<a name="ln201">            else if (s[i] == 'f')</a>
<a name="ln202">                  alter -= 1;</a>
<a name="ln203">            else if (s[i].isDigit()) {</a>
<a name="ln204">                  octave = s.mid(i,1).toInt();</a>
<a name="ln205">                  break;</a>
<a name="ln206">                  }</a>
<a name="ln207">            }</a>
<a name="ln208">      Direction dir = Direction::AUTO;</a>
<a name="ln209">      if (s.size() &gt;= 23) {</a>
<a name="ln210">            if (s[22] == 'u')</a>
<a name="ln211">                  dir = Direction::UP;</a>
<a name="ln212">            else if (s[22] == 'd')</a>
<a name="ln213">                  dir = Direction::DOWN;</a>
<a name="ln214">            }</a>
<a name="ln215"> </a>
<a name="ln216">      int staffIdx = 0;</a>
<a name="ln217">      if (s.size() &gt;= 24) {</a>
<a name="ln218">            if (s[23].isDigit())</a>
<a name="ln219">                  staffIdx = s.mid(23,1).toInt() - 1;</a>
<a name="ln220">            }</a>
<a name="ln221">      Staff* staff = part-&gt;staff(staffIdx);</a>
<a name="ln222">      int gstaff   = staff-&gt;idx();</a>
<a name="ln223"> </a>
<a name="ln224">      int pitch = table[step] + alter + (octave + 1) * 12;</a>
<a name="ln225">      if (pitch &lt; 0)</a>
<a name="ln226">            pitch = 0;</a>
<a name="ln227">      if (pitch &gt; 127)</a>
<a name="ln228">            pitch = 127;</a>
<a name="ln229">      Fraction ticks = Fraction::fromTicks((s.mid(5, 3).toInt() * MScore::division + _division/2) / _division);</a>
<a name="ln230">      Fraction tick  = curTick;</a>
<a name="ln231">      curTick  += ticks;</a>
<a name="ln232"> </a>
<a name="ln233">      Tuplet* tuplet = 0;</a>
<a name="ln234">      if (s.size() &gt;= 22) {</a>
<a name="ln235">            int a = 1;</a>
<a name="ln236">            int b = 1;</a>
<a name="ln237">            if (s[19] != ' ') {</a>
<a name="ln238">                  a = s[19].toLatin1() - '0';</a>
<a name="ln239">                  if (a == 3 &amp;&amp; s[20] != ':')</a>
<a name="ln240">                        b = 2;</a>
<a name="ln241">                  else {</a>
<a name="ln242">                        b = s[21].toLatin1() - '0';</a>
<a name="ln243">                        }</a>
<a name="ln244">                  }</a>
<a name="ln245">            if (a == 3 &amp;&amp; b == 2) {       // triplet</a>
<a name="ln246">                  if (chordRest &amp;&amp; chordRest-&gt;tuplet() &amp;&amp; ntuplet) {</a>
<a name="ln247">                        tuplet = chordRest-&gt;tuplet();</a>
<a name="ln248">                        }</a>
<a name="ln249">                  else {</a>
<a name="ln250">                        tuplet = new Tuplet(score);</a>
<a name="ln251">                        tuplet-&gt;setTrack(gstaff * VOICES);</a>
<a name="ln252">                        tuplet-&gt;setTick(tick);</a>
<a name="ln253">                        ntuplet = a;</a>
<a name="ln254">                        tuplet-&gt;setRatio(Fraction(a, b));</a>
<a name="ln255">                        measure-&gt;add(tuplet);</a>
<a name="ln256">                        }</a>
<a name="ln257">                  }</a>
<a name="ln258">            else if (a == 1 &amp;&amp; b == 1)</a>
<a name="ln259">                  ;</a>
<a name="ln260">            else</a>
<a name="ln261">                  qDebug(&quot;unsupported tuple %d/%d&quot;, a, b);</a>
<a name="ln262">            }</a>
<a name="ln263"> </a>
<a name="ln264">      Chord* chord = new Chord(score);</a>
<a name="ln265">      chordRest = chord;</a>
<a name="ln266">      chord-&gt;setTrack(gstaff * VOICES);</a>
<a name="ln267">      chord-&gt;setStemDirection(dir);</a>
<a name="ln268">      if (tuplet) {</a>
<a name="ln269">            chord-&gt;setTuplet(tuplet);</a>
<a name="ln270">            tuplet-&gt;add(chord);</a>
<a name="ln271">            --ntuplet;</a>
<a name="ln272">            }</a>
<a name="ln273">      TDuration d;</a>
<a name="ln274">      d.setVal(ticks.ticks());</a>
<a name="ln275">      chord-&gt;setDurationType(d);</a>
<a name="ln276"> </a>
<a name="ln277">      Segment* segment = measure-&gt;getSegment(SegmentType::ChordRest, tick);</a>
<a name="ln278"> </a>
<a name="ln279">      voice = 0;</a>
<a name="ln280">      for (; voice &lt; VOICES; ++voice) {</a>
<a name="ln281">            Element* e = segment-&gt;element(gstaff * VOICES + voice);</a>
<a name="ln282">            if (e == 0) {</a>
<a name="ln283">                  chord-&gt;setTrack(gstaff * VOICES + voice);</a>
<a name="ln284">                  segment-&gt;add(chord);</a>
<a name="ln285">                  break;</a>
<a name="ln286">                  }</a>
<a name="ln287">            }</a>
<a name="ln288">      if (voice == VOICES) {</a>
<a name="ln289">            qDebug(&quot;cannot allocate voice&quot;);</a>
<a name="ln290">            delete chord;</a>
<a name="ln291">            return;</a>
<a name="ln292">            }</a>
<a name="ln293">      Note* note = new Note(score);</a>
<a name="ln294">      note-&gt;setPitch(pitch);</a>
<a name="ln295">      note-&gt;setTpcFromPitch();</a>
<a name="ln296">      note-&gt;setTrack(gstaff * VOICES + voice);</a>
<a name="ln297">      chord-&gt;add(note);</a>
<a name="ln298"> </a>
<a name="ln299">      QString dynamics;</a>
<a name="ln300">      QString an = s.mid(31, 11);</a>
<a name="ln301">      for (int i = 0; i &lt; an.size(); ++i) {</a>
<a name="ln302">            if (an[i] == '(')</a>
<a name="ln303">                  openSlur(0, tick, staff, voice);</a>
<a name="ln304">            else if (an[i] == ')')</a>
<a name="ln305">                  closeSlur(0, tick, staff, voice);</a>
<a name="ln306">            else if (an[i] == '[')</a>
<a name="ln307">                  openSlur(1, tick, staff, voice);</a>
<a name="ln308">            else if (an[i] == ']')</a>
<a name="ln309">                  closeSlur(1, tick, staff, voice);</a>
<a name="ln310">            else if (an[i] == '{')</a>
<a name="ln311">                  openSlur(2, tick, staff, voice);</a>
<a name="ln312">            else if (an[i] == '}')</a>
<a name="ln313">                  closeSlur(2, tick, staff, voice);</a>
<a name="ln314">            else if (an[i] == 'z')</a>
<a name="ln315">                  openSlur(3, tick, staff, voice);</a>
<a name="ln316">            else if (an[i] == 'x')</a>
<a name="ln317">                  closeSlur(3, tick, staff, voice);</a>
<a name="ln318">            else if (an[i] == '.') {</a>
<a name="ln319">                  Articulation* atr = new Articulation(score);</a>
<a name="ln320">                  atr-&gt;setSymId(SymId::articStaccatoAbove);</a>
<a name="ln321">                  chord-&gt;add(atr);</a>
<a name="ln322">                  }</a>
<a name="ln323">            else if (an[i] == '_') {</a>
<a name="ln324">                  Articulation* atr = new Articulation(score);</a>
<a name="ln325">                  atr-&gt;setSymId(SymId::articTenutoAbove);</a>
<a name="ln326">                  chord-&gt;add(atr);</a>
<a name="ln327">                  }</a>
<a name="ln328">            else if (an[i] == 'v') {</a>
<a name="ln329">                  Articulation* atr = new Articulation(score);</a>
<a name="ln330">                  atr-&gt;setSymId(SymId::stringsUpBow);</a>
<a name="ln331">                  chord-&gt;add(atr);</a>
<a name="ln332">                  }</a>
<a name="ln333">            else if (an[i] == 'n') {</a>
<a name="ln334">                  Articulation* atr = new Articulation(score);</a>
<a name="ln335">                  atr-&gt;setSymId(SymId::stringsDownBow);</a>
<a name="ln336">                  chord-&gt;add(atr);</a>
<a name="ln337">                  }</a>
<a name="ln338">            else if (an[i] == 't') {</a>
<a name="ln339">                  Articulation* atr = new Articulation(score);</a>
<a name="ln340">                  atr-&gt;setSymId(SymId::ornamentTrill);</a>
<a name="ln341">                  chord-&gt;add(atr);</a>
<a name="ln342">                  }</a>
<a name="ln343">            else if (an[i] == 'F') {</a>
<a name="ln344">                  Articulation* atr = new Articulation(score);</a>
<a name="ln345">                  atr-&gt;setUp(true);</a>
<a name="ln346">                  atr-&gt;setSymId(SymId::fermataAbove);</a>
<a name="ln347">                  chord-&gt;add(atr);</a>
<a name="ln348">                  }</a>
<a name="ln349">            else if (an[i] == 'E') {</a>
<a name="ln350">                  Articulation* atr = new Articulation(score);</a>
<a name="ln351">                  atr-&gt;setUp(false);</a>
<a name="ln352">                  atr-&gt;setSymId(SymId::fermataBelow);</a>
<a name="ln353">                  chord-&gt;add(atr);</a>
<a name="ln354">                  }</a>
<a name="ln355">            else if (an[i] == 'O') {</a>
<a name="ln356">                  // Articulation* atr = new Articulation(score);</a>
<a name="ln357">                  // atr-&gt;setArticulationType(ArticulationType::Downbow);</a>
<a name="ln358">                  // chord-&gt;add(atr);</a>
<a name="ln359">                  qDebug(&quot;%06d: open string '%c' not implemented&quot;, tick.ticks(), an[i].toLatin1());</a>
<a name="ln360">                  }</a>
<a name="ln361">            else if (an[i] == '&amp;') {</a>
<a name="ln362">                  // skip editorial level</a>
<a name="ln363">                  if (i &lt;= an.size() &amp;&amp; an[i+1].isDigit())</a>
<a name="ln364">                        ++i;</a>
<a name="ln365">                  }</a>
<a name="ln366">            else if (an[i] == 'p')</a>
<a name="ln367">                  dynamics += &quot;p&quot;;</a>
<a name="ln368">            else if (an[i] == 'm')</a>
<a name="ln369">                  dynamics += &quot;m&quot;;</a>
<a name="ln370">            else if (an[i] == 'f')</a>
<a name="ln371">                  dynamics += &quot;f&quot;;</a>
<a name="ln372">            else if (an[i] == '-')        // tie</a>
<a name="ln373">                  ;</a>
<a name="ln374">            else if (an[i] == '*')        // start tuplet</a>
<a name="ln375">                  ;</a>
<a name="ln376">            else if (an[i] == '!')        // stop tuplet</a>
<a name="ln377">                  ;</a>
<a name="ln378">            else if (an[i] == '+')        // cautionary accidental</a>
<a name="ln379">                  ;</a>
<a name="ln380">            else if (an[i] == 'X')        // ???</a>
<a name="ln381">                  ;</a>
<a name="ln382">            else if (an[i] == ' ')</a>
<a name="ln383">                  ;</a>
<a name="ln384">            else {</a>
<a name="ln385">                  qDebug(&quot;%06d: notation '%c' not implemented&quot;, tick.ticks(), an[i].toLatin1());</a>
<a name="ln386">                  }</a>
<a name="ln387">            }</a>
<a name="ln388">      if (!dynamics.isEmpty()) {</a>
<a name="ln389">            Dynamic* dyn = new Dynamic(score);</a>
<a name="ln390">            dyn-&gt;setDynamicType(dynamics);</a>
<a name="ln391">            dyn-&gt;setTrack(gstaff * VOICES);</a>
<a name="ln392">            Segment* seg = measure-&gt;getSegment(SegmentType::ChordRest, tick);</a>
<a name="ln393">            seg-&gt;add(dyn);</a>
<a name="ln394">            }</a>
<a name="ln395"> </a>
<a name="ln396">      QString txt = s.mid(43, 36);</a>
<a name="ln397">      if (!txt.isEmpty()) {</a>
<a name="ln398">            QStringList sl = txt.split(&quot;|&quot;);</a>
<a name="ln399">            int no = 0;</a>
<a name="ln400">            foreach(QString w, sl) {</a>
<a name="ln401">                  w = diacritical(w);</a>
<a name="ln402">                  Lyrics* l = new Lyrics(score);</a>
<a name="ln403">                  l-&gt;setPlainText(w);</a>
<a name="ln404">                  l-&gt;setNo(no++);</a>
<a name="ln405">                  l-&gt;setTrack(gstaff * VOICES);</a>
<a name="ln406">                  Segment* seg = measure-&gt;tick2segment(tick);</a>
<a name="ln407">                  seg-&gt;add(l);</a>
<a name="ln408">                  }</a>
<a name="ln409">            }</a>
<a name="ln410">      }</a>
<a name="ln411"> </a>
<a name="ln412">//---------------------------------------------------------</a>
<a name="ln413">//   diacritical</a>
<a name="ln414">// TODO: not complete</a>
<a name="ln415">//---------------------------------------------------------</a>
<a name="ln416"> </a>
<a name="ln417">QString MuseData::diacritical(QString s)</a>
<a name="ln418">      {</a>
<a name="ln419">      struct TAB {</a>
<a name="ln420">            const char* a;</a>
<a name="ln421">            const char* b;</a>
<a name="ln422">            } tab[] = {</a>
<a name="ln423">            { &quot;\\\\&quot;, &quot;\\&quot; },</a>
<a name="ln424">            { &quot;\\2s&quot;, &quot;ß&quot; },</a>
<a name="ln425">            { &quot;\\3a&quot;, &quot;ä&quot; },</a>
<a name="ln426">            { &quot;\\3o&quot;, &quot;ö&quot; },</a>
<a name="ln427">            { &quot;\\3u&quot;, &quot;ü&quot; },</a>
<a name="ln428"> </a>
<a name="ln429">            { &quot;\\s2&quot;, &quot;ß&quot; },</a>
<a name="ln430">            { &quot;\\a3&quot;, &quot;ä&quot; },</a>
<a name="ln431">            { &quot;\\o3&quot;, &quot;ö&quot; },</a>
<a name="ln432">            { &quot;\\u3&quot;, &quot;ü&quot; },</a>
<a name="ln433">            };</a>
<a name="ln434">      for (unsigned int i = 0; i &lt; sizeof(tab)/sizeof(*tab); ++i) {</a>
<a name="ln435">            s = s.replace(tab[i].a, QString::fromUtf8(tab[i].b));</a>
<a name="ln436">            }</a>
<a name="ln437">      return s;</a>
<a name="ln438">      }</a>
<a name="ln439"> </a>
<a name="ln440">//---------------------------------------------------------</a>
<a name="ln441">//   readRest</a>
<a name="ln442">//---------------------------------------------------------</a>
<a name="ln443"> </a>
<a name="ln444">void MuseData::readRest(Part* part, const QString&amp; s)</a>
<a name="ln445">      {</a>
<a name="ln446">      Fraction ticks = Fraction::fromTicks((s.mid(5, 3).toInt() * MScore::division + _division/2) / _division);</a>
<a name="ln447"> </a>
<a name="ln448">      Fraction tick  = curTick;</a>
<a name="ln449">      curTick  += ticks;</a>
<a name="ln450"> </a>
<a name="ln451">      int staffIdx = 0;</a>
<a name="ln452">      if (s.size() &gt;= 24) {</a>
<a name="ln453">            if (s[23].isDigit())</a>
<a name="ln454">                  staffIdx = s.mid(23,1).toInt() - 1;</a>
<a name="ln455">            }</a>
<a name="ln456">      Staff* staff = part-&gt;staff(staffIdx);</a>
<a name="ln457">      int gstaff   = staff-&gt;idx();</a>
<a name="ln458"> </a>
<a name="ln459">      TDuration d;</a>
<a name="ln460">      d.setVal(ticks.ticks());</a>
<a name="ln461">      Rest* rest = new Rest(score, d);</a>
<a name="ln462">      rest-&gt;setTicks(d.fraction());</a>
<a name="ln463">      chordRest  = rest;</a>
<a name="ln464">      rest-&gt;setTrack(gstaff * VOICES);</a>
<a name="ln465">      Segment* segment = measure-&gt;getSegment(SegmentType::ChordRest, tick);</a>
<a name="ln466"> </a>
<a name="ln467">      voice = 0;</a>
<a name="ln468">      for (; voice &lt; VOICES; ++voice) {</a>
<a name="ln469">            Element* e = segment-&gt;element(gstaff * VOICES + voice);</a>
<a name="ln470">            if (e == 0) {</a>
<a name="ln471">                  rest-&gt;setTrack(gstaff * VOICES + voice);</a>
<a name="ln472">                  segment-&gt;add(rest);</a>
<a name="ln473">                  break;</a>
<a name="ln474">                  }</a>
<a name="ln475">            }</a>
<a name="ln476">      if (voice == VOICES) {</a>
<a name="ln477">            qDebug(&quot;cannot allocate voice&quot;);</a>
<a name="ln478">            delete rest;</a>
<a name="ln479">            return;</a>
<a name="ln480">            }</a>
<a name="ln481">      }</a>
<a name="ln482"> </a>
<a name="ln483">//---------------------------------------------------------</a>
<a name="ln484">//   readBackup</a>
<a name="ln485">//---------------------------------------------------------</a>
<a name="ln486"> </a>
<a name="ln487">void MuseData::readBackup(const QString&amp; s)</a>
<a name="ln488">      {</a>
<a name="ln489">      Fraction ticks = Fraction::fromTicks((s.mid(5, 3).toInt() * MScore::division + _division/2) / _division);</a>
<a name="ln490">      if (s[0] == 'b')</a>
<a name="ln491">            curTick  -= ticks;</a>
<a name="ln492">      else</a>
<a name="ln493">            curTick += ticks;</a>
<a name="ln494">      }</a>
<a name="ln495"> </a>
<a name="ln496">//---------------------------------------------------------</a>
<a name="ln497">//   createMeasure</a>
<a name="ln498">//---------------------------------------------------------</a>
<a name="ln499"> </a>
<a name="ln500">Measure* MuseData::createMeasure()</a>
<a name="ln501">      {</a>
<a name="ln502">      for (MeasureBase* mb = score-&gt;first(); mb; mb = mb-&gt;next()) {</a>
<a name="ln503">            if (mb-&gt;type() != ElementType::MEASURE)</a>
<a name="ln504">                  continue;</a>
<a name="ln505">            Measure* m = (Measure*)mb;</a>
<a name="ln506">            Fraction st = m-&gt;tick();</a>
<a name="ln507">            Fraction l  = m-&gt;ticks();</a>
<a name="ln508">            if (curTick == st)</a>
<a name="ln509">                  return m;</a>
<a name="ln510">            if (curTick &gt; st &amp;&amp; curTick &lt; (st+l)) {</a>
<a name="ln511">                  // irregular measure</a>
<a name="ln512">#if 0 // TODO</a>
<a name="ln513">                  Fraction f = score-&gt;sigmap()-&gt;timesig(st).fraction();</a>
<a name="ln514">                  score-&gt;sigmap()-&gt;add(st, curTick - st, f);</a>
<a name="ln515">                  score-&gt;sigmap()-&gt;add(curTick, f);</a>
<a name="ln516">#endif</a>
<a name="ln517">                  break;</a>
<a name="ln518">                  }</a>
<a name="ln519">            if (curTick &lt; st + l) {</a>
<a name="ln520">                  qDebug(&quot;cannot create measure at %d&quot;, curTick.ticks());</a>
<a name="ln521">                  return 0;</a>
<a name="ln522">                  }</a>
<a name="ln523">            }</a>
<a name="ln524">      Measure* mes  = new Measure(score);</a>
<a name="ln525">      mes-&gt;setTick(curTick);</a>
<a name="ln526"> </a>
<a name="ln527">#if 0</a>
<a name="ln528">      foreach(Staff* s, score-&gt;staves()) {</a>
<a name="ln529">            if (s-&gt;isTop()) {</a>
<a name="ln530">                  BarLine* barLine = new BarLine(score);</a>
<a name="ln531">                  barLine-&gt;setStaff(s);</a>
<a name="ln532">                  mes-&gt;setEndBarLine(barLine);</a>
<a name="ln533">                  }</a>
<a name="ln534">            }</a>
<a name="ln535">#endif</a>
<a name="ln536">      score-&gt;measures()-&gt;add(mes);</a>
<a name="ln537">      return mes;</a>
<a name="ln538">      }</a>
<a name="ln539"> </a>
<a name="ln540">//---------------------------------------------------------</a>
<a name="ln541">//   readPart</a>
<a name="ln542">//---------------------------------------------------------</a>
<a name="ln543"> </a>
<a name="ln544">void MuseData::readPart(QStringList sl, Part* part)</a>
<a name="ln545">      {</a>
<a name="ln546">      int line = 10;</a>
<a name="ln547">      QString s;</a>
<a name="ln548">      for (; line &lt; sl.size(); ++line) {</a>
<a name="ln549">            s = sl[line];</a>
<a name="ln550">            if (!s.isEmpty() &amp;&amp; s[0] == '$')</a>
<a name="ln551">                  break;</a>
<a name="ln552">            }</a>
<a name="ln553">      if (line &gt;= sl.size()) {</a>
<a name="ln554">            qDebug(&quot; $ not found in part&quot;);</a>
<a name="ln555">            return;</a>
<a name="ln556">            }</a>
<a name="ln557">      curTick = Fraction(0,1);</a>
<a name="ln558">      slur[0] = 0;</a>
<a name="ln559">      slur[1] = 0;</a>
<a name="ln560">      slur[2] = 0;</a>
<a name="ln561">      slur[3] = 0;</a>
<a name="ln562">      measure = 0;</a>
<a name="ln563">      measure = createMeasure();</a>
<a name="ln564">      for (; line &lt; sl.size(); ++line) {</a>
<a name="ln565">            s = sl[line];</a>
<a name="ln566">// qDebug(&quot;%6d: &lt;%s&gt;&quot;, curTick.ticks(), qPrintable(s));</a>
<a name="ln567">            char c = s[0].toLatin1();</a>
<a name="ln568">            switch(c) {</a>
<a name="ln569">                  case 'A':</a>
<a name="ln570">                  case 'B':</a>
<a name="ln571">                  case 'C':</a>
<a name="ln572">                  case 'D':</a>
<a name="ln573">                  case 'E':</a>
<a name="ln574">                  case 'F':</a>
<a name="ln575">                  case 'G':</a>
<a name="ln576">                        readNote(part, s);</a>
<a name="ln577">                        break;</a>
<a name="ln578">                  case ' ':         // chord</a>
<a name="ln579">                        readChord(part, s);</a>
<a name="ln580">                        break;</a>
<a name="ln581">                  case 'r':</a>
<a name="ln582">                        readRest(part, s);</a>
<a name="ln583">                        break;</a>
<a name="ln584">                  case 'g':         // grace note</a>
<a name="ln585">                  case 'c':         // cue note</a>
<a name="ln586">                  case 'f':         // basso continuo</a>
<a name="ln587">                        break;</a>
<a name="ln588">                  case 'b':         // backspace</a>
<a name="ln589">                  case 'i':         // forward space</a>
<a name="ln590">                        readBackup(s);</a>
<a name="ln591">                        break;</a>
<a name="ln592">                  case 'm':         // measure line / bar line</a>
<a name="ln593">                        measure = createMeasure();</a>
<a name="ln594">                        break;</a>
<a name="ln595">                  case '*':         // musical direction</a>
<a name="ln596">                        break;</a>
<a name="ln597">                  case 'P':         // print suggestion</a>
<a name="ln598">                        break;</a>
<a name="ln599">                  case 'S':         // sound record</a>
<a name="ln600">                        break;</a>
<a name="ln601">                  case '$':</a>
<a name="ln602">                        musicalAttribute(s, part);</a>
<a name="ln603">                        break;</a>
<a name="ln604">                  default:</a>
<a name="ln605">                        qDebug(&quot;unknown record &lt;%s&gt;&quot;, qPrintable(s));</a>
<a name="ln606">                        break;</a>
<a name="ln607">                  }</a>
<a name="ln608">            }</a>
<a name="ln609">      }</a>
<a name="ln610"> </a>
<a name="ln611">//---------------------------------------------------------</a>
<a name="ln612">//   countStaves</a>
<a name="ln613">//---------------------------------------------------------</a>
<a name="ln614"> </a>
<a name="ln615">int MuseData::countStaves(const QStringList&amp; sl)</a>
<a name="ln616">      {</a>
<a name="ln617">      int staves = 1;</a>
<a name="ln618">      for (int i = 10; i &lt; sl.size(); ++i) {</a>
<a name="ln619">            QString s = sl[i];</a>
<a name="ln620">            char c = s[0].toLatin1();</a>
<a name="ln621">            switch(c) {</a>
<a name="ln622">                  case 'A':</a>
<a name="ln623">                  case 'B':</a>
<a name="ln624">                  case 'C':</a>
<a name="ln625">                  case 'D':</a>
<a name="ln626">                  case 'E':</a>
<a name="ln627">                  case 'F':</a>
<a name="ln628">                  case 'G':</a>
<a name="ln629">                  case 'r':</a>
<a name="ln630">                        {</a>
<a name="ln631">                        int staffIdx = 1;</a>
<a name="ln632">                        if (s.size() &gt;= 24) {</a>
<a name="ln633">                              if (s[23].isDigit())</a>
<a name="ln634">                                    staffIdx = s.mid(23,1).toInt();</a>
<a name="ln635">                              }</a>
<a name="ln636">                        if (staffIdx &gt; staves)</a>
<a name="ln637">                              staves = staffIdx;</a>
<a name="ln638">                        }</a>
<a name="ln639">                        break;</a>
<a name="ln640">                  }</a>
<a name="ln641">            }</a>
<a name="ln642">      return staves;</a>
<a name="ln643">      }</a>
<a name="ln644"> </a>
<a name="ln645">//---------------------------------------------------------</a>
<a name="ln646">//   read</a>
<a name="ln647">//    return false on error</a>
<a name="ln648">//---------------------------------------------------------</a>
<a name="ln649"> </a>
<a name="ln650">bool MuseData::read(const QString&amp; name)</a>
<a name="ln651">      {</a>
<a name="ln652">      QFile fp(name);</a>
<a name="ln653">      if (!fp.open(QIODevice::ReadOnly)) {</a>
<a name="ln654">            qDebug(&quot;Cannot open file &lt;%s&gt;&quot;, qPrintable(name));</a>
<a name="ln655">            return false;</a>
<a name="ln656">            }</a>
<a name="ln657">      QTextStream ts(&amp;fp);</a>
<a name="ln658">      QStringList part;</a>
<a name="ln659">      bool commentMode = false;</a>
<a name="ln660">      for (;;) {</a>
<a name="ln661">            QString s(ts.readLine());</a>
<a name="ln662">            if (s.isNull())</a>
<a name="ln663">                  break;</a>
<a name="ln664">            if (s.isEmpty()) {</a>
<a name="ln665">                  if (!commentMode)</a>
<a name="ln666">                        part.append(QString(&quot;&quot;));</a>
<a name="ln667">                  continue;</a>
<a name="ln668">                  }</a>
<a name="ln669">            if (s[0] == '&amp;') {</a>
<a name="ln670">                  commentMode = !commentMode;</a>
<a name="ln671">                  continue;</a>
<a name="ln672">                  }</a>
<a name="ln673">            if (commentMode)</a>
<a name="ln674">                  continue;</a>
<a name="ln675">            if (s[0] == '@')</a>
<a name="ln676">                  continue;</a>
<a name="ln677">            if (s[0] == '/') {</a>
<a name="ln678">                  parts.append(part);</a>
<a name="ln679"> </a>
<a name="ln680">                  Part* mpart = new Part(score);</a>
<a name="ln681">                  int staves  = countStaves(part);</a>
<a name="ln682">                  for (int i = 0; i &lt; staves; ++i) {</a>
<a name="ln683">                        Staff* staff = new Staff(score);</a>
<a name="ln684">                        staff-&gt;setPart(mpart);</a>
<a name="ln685">                        mpart-&gt;insertStaff(staff, i);</a>
<a name="ln686">                        score-&gt;staves().push_back(staff);</a>
<a name="ln687">                        if ((staves == 2) &amp;&amp; (i == 0)) {</a>
<a name="ln688">                              staff-&gt;setBracketType(0, BracketType::BRACE);</a>
<a name="ln689">                              staff-&gt;setBracketSpan(0, 2);</a>
<a name="ln690">                              }</a>
<a name="ln691">                        }</a>
<a name="ln692">                  score-&gt;appendPart(mpart);</a>
<a name="ln693">                  if(part.size() &gt; 8)</a>
<a name="ln694">                        mpart-&gt;setPlainLongName(part[8]);</a>
<a name="ln695">                  part.clear();</a>
<a name="ln696">                  continue;</a>
<a name="ln697">                  }</a>
<a name="ln698">            if (s[0] == 'a') {</a>
<a name="ln699">                  part.back().append(s.mid(1));</a>
<a name="ln700">                  continue;</a>
<a name="ln701">                  }</a>
<a name="ln702">            part.append(s);</a>
<a name="ln703">            }</a>
<a name="ln704">      fp.close();</a>
<a name="ln705">      return true;</a>
<a name="ln706">      }</a>
<a name="ln707"> </a>
<a name="ln708">//---------------------------------------------------------</a>
<a name="ln709">//   convert</a>
<a name="ln710">//---------------------------------------------------------</a>
<a name="ln711"> </a>
<a name="ln712">void MuseData::convert()</a>
<a name="ln713">      {</a>
<a name="ln714">      for (int pn = 0; pn &lt; parts.size(); ++pn) {</a>
<a name="ln715">            Part* part = (score-&gt;parts())[pn];</a>
<a name="ln716">            readPart(parts[pn], part);</a>
<a name="ln717">            }</a>
<a name="ln718">#if 0</a>
<a name="ln719">      // crash if system does not fit on page (too many instruments)</a>
<a name="ln720"> </a>
<a name="ln721">      Measure* measure = score-&gt;tick2measure(0);</a>
<a name="ln722">      if (measure) {</a>
<a name="ln723">            Text* text = new Text(score);</a>
<a name="ln724">            text-&gt;setSubtype(TEXT_TITLE);</a>
<a name="ln725">            text-&gt;setText(parts[0][6]);</a>
<a name="ln726">            text-&gt;setText(&quot;mops&quot;);</a>
<a name="ln727">            measure-&gt;add(text);</a>
<a name="ln728">            text = new Text(score);</a>
<a name="ln729">            text-&gt;setSubtype(TEXT_SUBTITLE);</a>
<a name="ln730">            text-&gt;setText(parts[0][6]);</a>
<a name="ln731">            measure-&gt;add(text);</a>
<a name="ln732">            }</a>
<a name="ln733">#endif</a>
<a name="ln734">      }</a>
<a name="ln735"> </a>
<a name="ln736">//---------------------------------------------------------</a>
<a name="ln737">//   importMuseData</a>
<a name="ln738">//    return true on success</a>
<a name="ln739">//---------------------------------------------------------</a>
<a name="ln740"> </a>
<a name="ln741">Score::FileError importMuseData(MasterScore* score, const QString&amp; name)</a>
<a name="ln742">      {</a>
<a name="ln743">      if(!QFileInfo(name).exists())</a>
<a name="ln744">            return Score::FileError::FILE_NOT_FOUND;</a>
<a name="ln745">      MuseData md(score);</a>
<a name="ln746">      if (!md.read(name))</a>
<a name="ln747">            return Score::FileError::FILE_ERROR;</a>
<a name="ln748">      md.convert();</a>
<a name="ln749">      return Score::FileError::FILE_NO_ERROR;</a>
<a name="ln750">      }</a>
<a name="ln751">}</a>
<a name="ln752"> </a>

</code></pre>
<div class="balloon" rel="66"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="108"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="605"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="654"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
