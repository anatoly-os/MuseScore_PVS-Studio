
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>paletteworkspace.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2019 Werner Schweer and others</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2.</a>
<a name="ln9">//</a>
<a name="ln10">//  This program is distributed in the hope that it will be useful,</a>
<a name="ln11">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">//  GNU General Public License for more details.</a>
<a name="ln14">//</a>
<a name="ln15">//  You should have received a copy of the GNU General Public License</a>
<a name="ln16">//  along with this program; if not, write to the Free Software</a>
<a name="ln17">//  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</a>
<a name="ln18">//=============================================================================</a>
<a name="ln19"> </a>
<a name="ln20">#include &quot;paletteworkspace.h&quot;</a>
<a name="ln21"> </a>
<a name="ln22">#include &quot;libmscore/keysig.h&quot;</a>
<a name="ln23">#include &quot;libmscore/timesig.h&quot;</a>
<a name="ln24"> </a>
<a name="ln25">#include &quot;createpalettedialog.h&quot;</a>
<a name="ln26">#include &quot;keyedit.h&quot;</a>
<a name="ln27">#include &quot;musescore.h&quot;</a>
<a name="ln28">#include &quot;palette.h&quot; // applyPaletteElement</a>
<a name="ln29">#include &quot;palettedialog.h&quot;</a>
<a name="ln30">#include &quot;palettecelldialog.h&quot;</a>
<a name="ln31">#include &quot;palettewidget.h&quot;</a>
<a name="ln32">#include &quot;timedialog.h&quot;</a>
<a name="ln33"> </a>
<a name="ln34">namespace Ms {</a>
<a name="ln35"> </a>
<a name="ln36">//---------------------------------------------------------</a>
<a name="ln37">//   PaletteElementEditor::valid</a>
<a name="ln38">//---------------------------------------------------------</a>
<a name="ln39"> </a>
<a name="ln40">bool PaletteElementEditor::valid() const</a>
<a name="ln41">      {</a>
<a name="ln42">      using Type = PalettePanel::Type;</a>
<a name="ln43">      switch (_type) {</a>
<a name="ln44">            case Type::KeySig:</a>
<a name="ln45">            case Type::TimeSig:</a>
<a name="ln46">                  return true;</a>
<a name="ln47">            default:</a>
<a name="ln48">                  break;</a>
<a name="ln49">            }</a>
<a name="ln50">      return false;</a>
<a name="ln51">      }</a>
<a name="ln52"> </a>
<a name="ln53">//---------------------------------------------------------</a>
<a name="ln54">//   PaletteElementEditor::actionName</a>
<a name="ln55">//---------------------------------------------------------</a>
<a name="ln56"> </a>
<a name="ln57">QString PaletteElementEditor::actionName() const</a>
<a name="ln58">      {</a>
<a name="ln59">      using Type = PalettePanel::Type;</a>
<a name="ln60">      switch (_type) {</a>
<a name="ln61">            case Type::KeySig:</a>
<a name="ln62">                  return tr(&quot;Create Key Signature&quot;);</a>
<a name="ln63">            case Type::TimeSig:</a>
<a name="ln64">                  return tr(&quot;Create Time Signature&quot;);</a>
<a name="ln65">            default:</a>
<a name="ln66">                  break;</a>
<a name="ln67">            }</a>
<a name="ln68">      return QString();</a>
<a name="ln69">      }</a>
<a name="ln70"> </a>
<a name="ln71">//---------------------------------------------------------</a>
<a name="ln72">//   PaletteElementEditor::onElementAdded</a>
<a name="ln73">//---------------------------------------------------------</a>
<a name="ln74"> </a>
<a name="ln75">void PaletteElementEditor::onElementAdded(const Element* el)</a>
<a name="ln76">      {</a>
<a name="ln77">      if (!_paletteIndex.isValid()</a>
<a name="ln78">         || !_paletteIndex.data(PaletteTreeModel::VisibleRole).toBool()) {</a>
<a name="ln79">            QMessageBox::information(mscore, &quot;&quot;, tr(&quot;The palette was hidden or changed&quot;));</a>
<a name="ln80">            return;</a>
<a name="ln81">            }</a>
<a name="ln82">      QVariantMap mimeData;</a>
<a name="ln83">      mimeData[mimeSymbolFormat] = el-&gt;mimeData(QPointF());</a>
<a name="ln84">      _controller-&gt;insert(_paletteIndex, -1, mimeData, Qt::CopyAction);</a>
<a name="ln85">      }</a>
<a name="ln86"> </a>
<a name="ln87">//---------------------------------------------------------</a>
<a name="ln88">//   PaletteElementEditor::open</a>
<a name="ln89">//---------------------------------------------------------</a>
<a name="ln90"> </a>
<a name="ln91">void PaletteElementEditor::open()</a>
<a name="ln92">      {</a>
<a name="ln93">      if (!_paletteIndex.isValid())</a>
<a name="ln94">            return;</a>
<a name="ln95"> </a>
<a name="ln96">      QWidget* editor = nullptr;</a>
<a name="ln97"> </a>
<a name="ln98">      using Type = PalettePanel::Type;</a>
<a name="ln99">      switch (_type) {</a>
<a name="ln100">            case Type::KeySig: {</a>
<a name="ln101">                  KeyEditor* keyEditor = new KeyEditor(mscore);</a>
<a name="ln102">                  keyEditor-&gt;showKeyPalette(false);</a>
<a name="ln103">                  connect(keyEditor, &amp;KeyEditor::keySigAdded, this, &amp;PaletteElementEditor::onElementAdded);</a>
<a name="ln104">                  editor = keyEditor;</a>
<a name="ln105">                  }</a>
<a name="ln106">                  break;</a>
<a name="ln107">            case Type::TimeSig: {</a>
<a name="ln108">                  TimeDialog* timeEditor = new TimeDialog(mscore);</a>
<a name="ln109">                  timeEditor-&gt;showTimePalette(false);</a>
<a name="ln110">                  connect(timeEditor, &amp;TimeDialog::timeSigAdded, this, &amp;PaletteElementEditor::onElementAdded);</a>
<a name="ln111">                  editor = timeEditor;</a>
<a name="ln112">                  }</a>
<a name="ln113">                  break;</a>
<a name="ln114">            default:</a>
<a name="ln115">                  break;</a>
<a name="ln116">            }</a>
<a name="ln117"> </a>
<a name="ln118">      if (!editor)</a>
<a name="ln119">            return;</a>
<a name="ln120"> </a>
<a name="ln121">      mscore-&gt;stackUnder(editor);</a>
<a name="ln122">      editor-&gt;setAttribute(Qt::WA_DeleteOnClose);</a>
<a name="ln123"> </a>
<a name="ln124">      editor-&gt;show();</a>
<a name="ln125">      }</a>
<a name="ln126"> </a>
<a name="ln127">//---------------------------------------------------------</a>
<a name="ln128">//   findPaletteIndex</a>
<a name="ln129">//---------------------------------------------------------</a>
<a name="ln130"> </a>
<a name="ln131">static QModelIndex findPaletteIndex(const QAbstractItemModel* model, PalettePanel::Type type)</a>
<a name="ln132">      {</a>
<a name="ln133">      constexpr int role = PaletteTreeModel::PaletteTypeRole;</a>
<a name="ln134">      const QModelIndex start = model-&gt;index(0, 0);</a>
<a name="ln135">      const QModelIndexList foundIndexList = model-&gt;match(start, role, QVariant::fromValue(type));</a>
<a name="ln136"> </a>
<a name="ln137">      if (!foundIndexList.empty())</a>
<a name="ln138">            return foundIndexList[0];</a>
<a name="ln139">      return QModelIndex();</a>
<a name="ln140">      }</a>
<a name="ln141"> </a>
<a name="ln142">//---------------------------------------------------------</a>
<a name="ln143">//   convertIndex</a>
<a name="ln144">//---------------------------------------------------------</a>
<a name="ln145"> </a>
<a name="ln146">static QModelIndex convertIndex(const QModelIndex&amp; index, const QAbstractItemModel* targetModel)</a>
<a name="ln147">      {</a>
<a name="ln148">      if (index.model() == targetModel || !index.isValid())</a>
<a name="ln149">            return index;</a>
<a name="ln150"> </a>
<a name="ln151">      constexpr int typeRole = PaletteTreeModel::PaletteTypeRole;</a>
<a name="ln152">      const auto type = index.model()-&gt;data(index, typeRole).value&lt;PalettePanel::Type&gt;();</a>
<a name="ln153"> </a>
<a name="ln154">      return findPaletteIndex(targetModel, type);</a>
<a name="ln155">      }</a>
<a name="ln156"> </a>
<a name="ln157">//---------------------------------------------------------</a>
<a name="ln158">//   convertProxyIndex</a>
<a name="ln159">//---------------------------------------------------------</a>
<a name="ln160"> </a>
<a name="ln161">static QModelIndex convertProxyIndex(const QModelIndex&amp; srcIndex, const QAbstractItemModel* targetModel)</a>
<a name="ln162">      {</a>
<a name="ln163">      QModelIndex index = srcIndex;</a>
<a name="ln164">      while (index.model() != targetModel) {</a>
<a name="ln165">            if (auto m = qobject_cast&lt;const QAbstractProxyModel*&gt;(index.model()))</a>
<a name="ln166">                  index = m-&gt;mapToSource(index);</a>
<a name="ln167">            else</a>
<a name="ln168">                  break;</a>
<a name="ln169">            }</a>
<a name="ln170"> </a>
<a name="ln171">      if (targetModel &amp;&amp; index.model() != targetModel)</a>
<a name="ln172">            return QModelIndex();</a>
<a name="ln173">      return index;</a>
<a name="ln174">      }</a>
<a name="ln175"> </a>
<a name="ln176">//---------------------------------------------------------</a>
<a name="ln177">//   AbstractPaletteController::elementEditor</a>
<a name="ln178">//---------------------------------------------------------</a>
<a name="ln179"> </a>
<a name="ln180">PaletteElementEditor* AbstractPaletteController::elementEditor(const QModelIndex&amp; paletteIndex)</a>
<a name="ln181">      {</a>
<a name="ln182">      PaletteElementEditor* ed = new PaletteElementEditor(this, paletteIndex, paletteIndex.data(PaletteTreeModel::PaletteTypeRole).value&lt;PalettePanel::Type&gt;(), this);</a>
<a name="ln183">      QQmlEngine::setObjectOwnership(ed, QQmlEngine::JavaScriptOwnership);</a>
<a name="ln184">      return ed;</a>
<a name="ln185">      }</a>
<a name="ln186"> </a>
<a name="ln187">//---------------------------------------------------------</a>
<a name="ln188">//   UserPaletteController::dropAction</a>
<a name="ln189">//---------------------------------------------------------</a>
<a name="ln190"> </a>
<a name="ln191">Qt::DropAction UserPaletteController::dropAction(const QVariantMap&amp; mimeData, Qt::DropAction proposedAction, const QModelIndex&amp; parent, bool internal) const</a>
<a name="ln192">      {</a>
<a name="ln193">      if (internal &amp;&amp; !userEditable())</a>
<a name="ln194">            return Qt::IgnoreAction;</a>
<a name="ln195">      const bool parentEditingEnabled = model()-&gt;data(parent, PaletteTreeModel::EditableRole).toBool();</a>
<a name="ln196">      if (!parentEditingEnabled)</a>
<a name="ln197">            return Qt::IgnoreAction;</a>
<a name="ln198"> </a>
<a name="ln199">      if (mimeData.contains(PaletteCell::mimeDataFormat) &amp;&amp; proposedAction == Qt::MoveAction) {</a>
<a name="ln200">            const auto cell = PaletteCell::readMimeData(mimeData[PaletteCell::mimeDataFormat].toByteArray());</a>
<a name="ln201">            if (!cell)</a>
<a name="ln202">                  return Qt::IgnoreAction;</a>
<a name="ln203">            if (_filterCustom &amp;&amp; cell-&gt;custom != _custom)</a>
<a name="ln204">                  return Qt::IgnoreAction;</a>
<a name="ln205">            return Qt::MoveAction;</a>
<a name="ln206">            }</a>
<a name="ln207">      if (mimeData.contains(mimeSymbolFormat) &amp;&amp; proposedAction == Qt::CopyAction) {</a>
<a name="ln208">            if (_filterCustom &amp;&amp; !_custom)</a>
<a name="ln209">                  return Qt::IgnoreAction;</a>
<a name="ln210">            return Qt::CopyAction;</a>
<a name="ln211">            }</a>
<a name="ln212">      return Qt::IgnoreAction;</a>
<a name="ln213">      }</a>
<a name="ln214"> </a>
<a name="ln215">//---------------------------------------------------------</a>
<a name="ln216">//   UserPaletteController::insert</a>
<a name="ln217">//---------------------------------------------------------</a>
<a name="ln218"> </a>
<a name="ln219">bool UserPaletteController::insert(const QModelIndex&amp; parent, int row, const QVariantMap&amp; mimeData, Qt::DropAction action)</a>
<a name="ln220">      {</a>
<a name="ln221">      if (dropAction(mimeData, action, parent, false) == Qt::IgnoreAction)</a>
<a name="ln222">            return false;</a>
<a name="ln223"> </a>
<a name="ln224">      if (row &lt; 0)</a>
<a name="ln225">            row = parent.model()-&gt;rowCount(parent);</a>
<a name="ln226"> </a>
<a name="ln227">      PaletteCellPtr cell;</a>
<a name="ln228"> </a>
<a name="ln229">      if (mimeData.contains(PaletteCell::mimeDataFormat)) {</a>
<a name="ln230">            cell = PaletteCell::readMimeData(mimeData[PaletteCell::mimeDataFormat].toByteArray());</a>
<a name="ln231"> </a>
<a name="ln232">            if (!cell)</a>
<a name="ln233">                  return false;</a>
<a name="ln234">            if (_filterCustom &amp;&amp; cell-&gt;custom != _custom)</a>
<a name="ln235">                  return false;</a>
<a name="ln236"> </a>
<a name="ln237">            if (action == Qt::MoveAction) {</a>
<a name="ln238">                  const QModelIndex visiblePaletteParentIndex = convertIndex(parent, _userPalette);</a>
<a name="ln239">                  const QModelIndex foundIndex(_userPalette-&gt;findPaletteCell(*cell, visiblePaletteParentIndex));</a>
<a name="ln240">                  if (foundIndex.isValid())</a>
<a name="ln241">                        return _userPalette-&gt;setData(foundIndex, _visible, PaletteTreeModel::VisibleRole);</a>
<a name="ln242">                  else if (!userEditable())</a>
<a name="ln243">                        return false;</a>
<a name="ln244">                  }</a>
<a name="ln245">            }</a>
<a name="ln246">      else if (mimeData.contains(mimeSymbolFormat) &amp;&amp; (action == Qt::CopyAction))</a>
<a name="ln247">            cell = PaletteCell::readElementMimeData(mimeData[mimeSymbolFormat].toByteArray());</a>
<a name="ln248"> </a>
<a name="ln249">      if (!cell)</a>
<a name="ln250">            return false;</a>
<a name="ln251"> </a>
<a name="ln252">      if (_filterCustom) {</a>
<a name="ln253">            if (!_custom)</a>
<a name="ln254">                  return false; // can only move non-custom cells</a>
<a name="ln255">            cell-&gt;custom = _custom;</a>
<a name="ln256">            }</a>
<a name="ln257">      cell-&gt;visible = _visible;</a>
<a name="ln258"> </a>
<a name="ln259">      QMimeData data;</a>
<a name="ln260">      data.setData(PaletteCell::mimeDataFormat, cell-&gt;mimeData());</a>
<a name="ln261">      constexpr int column = 0;</a>
<a name="ln262">      return model()-&gt;dropMimeData(&amp;data, action, row, column, parent);</a>
<a name="ln263">      }</a>
<a name="ln264"> </a>
<a name="ln265">//---------------------------------------------------------</a>
<a name="ln266">//   UserPaletteController::insertNewItem</a>
<a name="ln267">//---------------------------------------------------------</a>
<a name="ln268"> </a>
<a name="ln269">bool UserPaletteController::insertNewItem(const QModelIndex&amp; parent, int row)</a>
<a name="ln270">      {</a>
<a name="ln271">      if (!canEdit(parent))</a>
<a name="ln272">            return false;</a>
<a name="ln273"> </a>
<a name="ln274">      const bool newItemIsPalette = !parent.isValid();</a>
<a name="ln275"> </a>
<a name="ln276">      if (newItemIsPalette) {</a>
<a name="ln277">            CreatePaletteDialog dlg(mscore);</a>
<a name="ln278">            const int result = dlg.exec();</a>
<a name="ln279">            if (result == QDialog::Rejected || dlg.paletteName().isEmpty())</a>
<a name="ln280">                  return false;</a>
<a name="ln281"> </a>
<a name="ln282">            if (!model()-&gt;insertRow(row, parent))</a>
<a name="ln283">                  return false;</a>
<a name="ln284">            model()-&gt;setData(model()-&gt;index(row, 0, parent), dlg.paletteName(), Qt::DisplayRole);</a>
<a name="ln285">            return true;</a>
<a name="ln286">            }</a>
<a name="ln287"> </a>
<a name="ln288">      return model()-&gt;insertRow(row, parent);</a>
<a name="ln289">      }</a>
<a name="ln290"> </a>
<a name="ln291">//---------------------------------------------------------</a>
<a name="ln292">//   UserPaletteController::move</a>
<a name="ln293">//---------------------------------------------------------</a>
<a name="ln294"> </a>
<a name="ln295">bool UserPaletteController::move(const QModelIndex&amp; sourceParent, int sourceRow, const QModelIndex&amp; destinationParent, int destinationChild)</a>
<a name="ln296">      {</a>
<a name="ln297">      if (!canEdit(sourceParent) || !canEdit(destinationParent))</a>
<a name="ln298">            return false;</a>
<a name="ln299">      if (sourceParent == destinationParent &amp;&amp; (sourceParent.model() == model() || !sourceParent.isValid())) {</a>
<a name="ln300">            const QModelIndex srcIndex = convertProxyIndex(model()-&gt;index(sourceRow, 0, sourceParent), _userPalette);</a>
<a name="ln301">            const QModelIndex destIndex = convertProxyIndex(model()-&gt;index(destinationChild, 0, destinationParent), _userPalette);</a>
<a name="ln302">            return _userPalette-&gt;moveRow(srcIndex.parent(), srcIndex.row(), destIndex.parent(), destIndex.row());</a>
<a name="ln303">            }</a>
<a name="ln304">      return false;</a>
<a name="ln305">      }</a>
<a name="ln306"> </a>
<a name="ln307">//---------------------------------------------------------</a>
<a name="ln308">//   UserPaletteController::showHideOrDeleteDialog</a>
<a name="ln309">//---------------------------------------------------------</a>
<a name="ln310"> </a>
<a name="ln311">void UserPaletteController::showHideOrDeleteDialog(const QString&amp; question, std::function&lt;void(AbstractPaletteController::RemoveAction)&gt; resultHandler) const</a>
<a name="ln312">      {</a>
<a name="ln313">      QMessageBox* msg = new QMessageBox(mscore);</a>
<a name="ln314">      msg-&gt;setIcon(QMessageBox::Question);</a>
<a name="ln315">      msg-&gt;setText(question);</a>
<a name="ln316">      msg-&gt;setTextFormat(Qt::PlainText);</a>
<a name="ln317">      QPushButton* deleteButton = msg-&gt;addButton(tr(&quot;Delete permanently&quot;), QMessageBox::DestructiveRole);</a>
<a name="ln318">      QPushButton* hideButton = msg-&gt;addButton(tr(&quot;Hide&quot;), QMessageBox::AcceptRole);</a>
<a name="ln319">      msg-&gt;addButton(QMessageBox::Cancel);</a>
<a name="ln320">      msg-&gt;setDefaultButton(hideButton);</a>
<a name="ln321"> </a>
<a name="ln322">      connect(msg, &amp;QDialog::finished, this, [=]() {</a>
<a name="ln323">            RemoveAction action = RemoveAction::NoAction;</a>
<a name="ln324"> </a>
<a name="ln325">            const QAbstractButton* btn = msg-&gt;clickedButton();</a>
<a name="ln326">            if (btn == deleteButton)</a>
<a name="ln327">                  action = RemoveAction::DeletePermanently;</a>
<a name="ln328">            else if (btn == hideButton)</a>
<a name="ln329">                  action = RemoveAction::Hide;</a>
<a name="ln330"> </a>
<a name="ln331">            resultHandler(action);</a>
<a name="ln332">            });</a>
<a name="ln333"> </a>
<a name="ln334">      msg-&gt;setWindowModality(Qt::ApplicationModal);</a>
<a name="ln335">      msg-&gt;setAttribute(Qt::WA_DeleteOnClose);</a>
<a name="ln336">      msg-&gt;open();</a>
<a name="ln337">      }</a>
<a name="ln338"> </a>
<a name="ln339">//---------------------------------------------------------</a>
<a name="ln340">//   UserPaletteController::queryRemove</a>
<a name="ln341">//---------------------------------------------------------</a>
<a name="ln342"> </a>
<a name="ln343">void UserPaletteController::queryRemove(const QModelIndexList&amp; removeIndices, int customCount)</a>
<a name="ln344">      {</a>
<a name="ln345">      using RemoveAction = AbstractPaletteController::RemoveAction;</a>
<a name="ln346"> </a>
<a name="ln347">      if (removeIndices.empty() || !canEdit(removeIndices[0].parent()))</a>
<a name="ln348">            return;</a>
<a name="ln349"> </a>
<a name="ln350">      if (!customCount) {</a>
<a name="ln351">            remove(removeIndices, RemoveAction::AutoAction);</a>
<a name="ln352">            return;</a>
<a name="ln353">            }</a>
<a name="ln354"> </a>
<a name="ln355">      // these parameters should not depend on exact index as all they should have the same parent in palette tree</a>
<a name="ln356">      const bool visible = removeIndices[0].data(PaletteTreeModel::VisibleRole).toBool();</a>
<a name="ln357">      const bool isCell = bool(removeIndices[0].data(PaletteTreeModel::PaletteCellRole).value&lt;const PaletteCell*&gt;());</a>
<a name="ln358"> </a>
<a name="ln359">      RemoveAction action = RemoveAction::AutoAction;</a>
<a name="ln360"> </a>
<a name="ln361">      if (isCell) {</a>
<a name="ln362">            if (visible) {</a>
<a name="ln363">                  showHideOrDeleteDialog(</a>
<a name="ln364">                     customCount == 1 ? tr(&quot;Do you want to hide this custom palette cell or permanently delete it?&quot;) : tr(&quot;Do you want to hide these custom palette cells or permanently delete them?&quot;),</a>
<a name="ln365">                     [=](RemoveAction action) { remove(removeIndices, action); }</a>
<a name="ln366">                     );</a>
<a name="ln367">                  return;</a>
<a name="ln368">                  }</a>
<a name="ln369">            else {</a>
<a name="ln370">                  QMessageBox* msg = new QMessageBox(</a>
<a name="ln371">                     QMessageBox::Question,</a>
<a name="ln372">                     &quot;&quot;,</a>
<a name="ln373">                     customCount == 1 ? tr(&quot;Do you want to permanently delete this custom palette cell?&quot;) : tr(&quot;Do you want to permanently delete these custom palette cells?&quot;),</a>
<a name="ln374">                     QMessageBox::Yes | QMessageBox::No,</a>
<a name="ln375">                     mscore</a>
<a name="ln376">                     );</a>
<a name="ln377"> </a>
<a name="ln378">                  connect(msg, &amp;QDialog::finished, this, [=]() {</a>
<a name="ln379">                        const auto result = msg-&gt;standardButton(msg-&gt;clickedButton());</a>
<a name="ln380">                        if (result == QMessageBox::Yes)</a>
<a name="ln381">                              remove(removeIndices, RemoveAction::DeletePermanently);</a>
<a name="ln382">                        });</a>
<a name="ln383"> </a>
<a name="ln384">                  msg-&gt;setWindowModality(Qt::ApplicationModal);</a>
<a name="ln385">                  msg-&gt;setAttribute(Qt::WA_DeleteOnClose);</a>
<a name="ln386">                  msg-&gt;open();</a>
<a name="ln387">                  return;</a>
<a name="ln388">                  }</a>
<a name="ln389">            }</a>
<a name="ln390">      else {</a>
<a name="ln391">            if (visible) {</a>
<a name="ln392">                  showHideOrDeleteDialog(</a>
<a name="ln393">                     customCount == 1 ? tr(&quot;Do you want to hide this custom palette or permanently delete it?&quot;) : tr(&quot;Do you want to hide these custom palettes or permanently delete them?&quot;),</a>
<a name="ln394">                     [=](RemoveAction action) { remove(removeIndices, action); }</a>
<a name="ln395">                     );</a>
<a name="ln396">                  return;</a>
<a name="ln397">                  }</a>
<a name="ln398">            else</a>
<a name="ln399">                  action = RemoveAction::Hide;</a>
<a name="ln400">            }</a>
<a name="ln401"> </a>
<a name="ln402">      remove(removeIndices, action);</a>
<a name="ln403">      }</a>
<a name="ln404"> </a>
<a name="ln405">//---------------------------------------------------------</a>
<a name="ln406">//   UserPaletteController::remove</a>
<a name="ln407">//---------------------------------------------------------</a>
<a name="ln408"> </a>
<a name="ln409">void UserPaletteController::remove(const QModelIndexList&amp; unsortedRemoveIndices, AbstractPaletteController::RemoveAction action)</a>
<a name="ln410">      {</a>
<a name="ln411">      using RemoveAction = AbstractPaletteController::RemoveAction;</a>
<a name="ln412"> </a>
<a name="ln413">      if (action == RemoveAction::NoAction)</a>
<a name="ln414">            return;</a>
<a name="ln415"> </a>
<a name="ln416">      QModelIndexList removeIndices = unsortedRemoveIndices;</a>
<a name="ln417">      std::sort(removeIndices.begin(), removeIndices.end(), [](const QModelIndex&amp; a, const QModelIndex&amp; b) { return a.row() &lt; b.row(); });</a>
<a name="ln418"> </a>
<a name="ln419">      // remove in reversed order to leave the previous model indices in the list valid</a>
<a name="ln420">      for (auto i = removeIndices.rbegin(); i != removeIndices.rend(); ++i) {</a>
<a name="ln421">            const QModelIndex&amp; index = *i;</a>
<a name="ln422"> </a>
<a name="ln423">            RemoveAction indexAction = action;</a>
<a name="ln424">            const bool custom = model()-&gt;data(index, PaletteTreeModel::CustomRole).toBool();</a>
<a name="ln425"> </a>
<a name="ln426">            if (!custom || indexAction == RemoveAction::AutoAction) {</a>
<a name="ln427">                  const bool isCell = bool(model()-&gt;data(index, PaletteTreeModel::PaletteCellRole).value&lt;const PaletteCell*&gt;());</a>
<a name="ln428">                  indexAction = custom ? RemoveAction::NoAction : (isCell ? RemoveAction::DeletePermanently : RemoveAction::Hide);</a>
<a name="ln429">                  }</a>
<a name="ln430"> </a>
<a name="ln431">            switch (indexAction) {</a>
<a name="ln432">                  case RemoveAction::NoAction:</a>
<a name="ln433">                        break;</a>
<a name="ln434">                  case RemoveAction::Hide:</a>
<a name="ln435">                        model()-&gt;setData(index, false, PaletteTreeModel::VisibleRole);</a>
<a name="ln436">                        break;</a>
<a name="ln437">                  case RemoveAction::DeletePermanently:</a>
<a name="ln438">                        model()-&gt;removeRow(index.row(), index.parent());</a>
<a name="ln439">                        break;</a>
<a name="ln440">                  case RemoveAction::AutoAction:</a>
<a name="ln441">                        // impossible, we have just assigned another action for that case</a>
<a name="ln442">                        Q_ASSERT(false);</a>
<a name="ln443">                        break;</a>
<a name="ln444">                  }</a>
<a name="ln445">            }</a>
<a name="ln446">      }</a>
<a name="ln447"> </a>
<a name="ln448">//---------------------------------------------------------</a>
<a name="ln449">//   UserPaletteController::remove</a>
<a name="ln450">//---------------------------------------------------------</a>
<a name="ln451"> </a>
<a name="ln452">void UserPaletteController::remove(const QModelIndex&amp; index)</a>
<a name="ln453">      {</a>
<a name="ln454">      if (!canEdit(index.parent()))</a>
<a name="ln455">            return;</a>
<a name="ln456"> </a>
<a name="ln457">      const bool customItem = index.data(PaletteTreeModel::CustomRole).toBool();</a>
<a name="ln458">      queryRemove({ index }, customItem ? 1 : 0);</a>
<a name="ln459">      }</a>
<a name="ln460"> </a>
<a name="ln461">//---------------------------------------------------------</a>
<a name="ln462">//   UserPaletteController::removeSelection</a>
<a name="ln463">//---------------------------------------------------------</a>
<a name="ln464"> </a>
<a name="ln465">void UserPaletteController::removeSelection(const QModelIndexList&amp; selectedIndexes, const QModelIndex&amp; parent)</a>
<a name="ln466">      {</a>
<a name="ln467">      if (!canEdit(parent))</a>
<a name="ln468">            return;</a>
<a name="ln469"> </a>
<a name="ln470">      QModelIndexList removeIndices;</a>
<a name="ln471">      int customItemsCount = 0;</a>
<a name="ln472"> </a>
<a name="ln473">      for (const QModelIndex&amp; idx : selectedIndexes) {</a>
<a name="ln474">            if (idx.parent() == parent) {</a>
<a name="ln475">                  removeIndices.push_back(idx);</a>
<a name="ln476">                  const bool custom = idx.data(PaletteTreeModel::CustomRole).toBool();</a>
<a name="ln477">                  if (custom)</a>
<a name="ln478">                        ++customItemsCount;</a>
<a name="ln479">                  }</a>
<a name="ln480">            }</a>
<a name="ln481"> </a>
<a name="ln482">      queryRemove(removeIndices, customItemsCount);</a>
<a name="ln483">      }</a>
<a name="ln484"> </a>
<a name="ln485">//---------------------------------------------------------</a>
<a name="ln486">//   UserPaletteController::editPaletteProperties</a>
<a name="ln487">//---------------------------------------------------------</a>
<a name="ln488"> </a>
<a name="ln489">void UserPaletteController::editPaletteProperties(const QModelIndex&amp; index)</a>
<a name="ln490">      {</a>
<a name="ln491">      if (!canEdit(index))</a>
<a name="ln492">            return;</a>
<a name="ln493"> </a>
<a name="ln494">      const QModelIndex srcIndex = convertProxyIndex(index, _userPalette);</a>
<a name="ln495">      PalettePanel* p = _userPalette-&gt;findPalettePanel(srcIndex);</a>
<a name="ln496">      if (!p)</a>
<a name="ln497">            return;</a>
<a name="ln498"> </a>
<a name="ln499">      PaletteTreeModel* m = _userPalette;</a>
<a name="ln500">      PalettePropertiesDialog* d = new PalettePropertiesDialog(p, mscore);</a>
<a name="ln501"> </a>
<a name="ln502">      const bool treeChangedWasBlocked = m-&gt;blockTreeChanged(true);</a>
<a name="ln503">      const bool paletteChangedState = m-&gt;paletteTreeChanged();</a>
<a name="ln504"> </a>
<a name="ln505">      connect(d, &amp;QDialog::accepted, m, [m, treeChangedWasBlocked]() {</a>
<a name="ln506">            m-&gt;blockTreeChanged(treeChangedWasBlocked);</a>
<a name="ln507">      });</a>
<a name="ln508">      connect(d, &amp;QDialog::rejected, m, [m, srcIndex, paletteChangedState, treeChangedWasBlocked]() {</a>
<a name="ln509">            m-&gt;itemDataChanged(srcIndex);</a>
<a name="ln510">            paletteChangedState ? m-&gt;setTreeChanged() : m-&gt;setTreeUnchanged();</a>
<a name="ln511">            m-&gt;blockTreeChanged(treeChangedWasBlocked);</a>
<a name="ln512">      });</a>
<a name="ln513">      connect(d, &amp;PalettePropertiesDialog::changed, m, [m, srcIndex]() {</a>
<a name="ln514">            m-&gt;itemDataChanged(srcIndex);</a>
<a name="ln515">      });</a>
<a name="ln516">      </a>
<a name="ln517">      d-&gt;setModal(true);</a>
<a name="ln518">      d-&gt;setAttribute(Qt::WA_DeleteOnClose);</a>
<a name="ln519">      d-&gt;open();</a>
<a name="ln520">      }</a>
<a name="ln521"> </a>
<a name="ln522">//---------------------------------------------------------</a>
<a name="ln523">//   UserPaletteController::editCellProperties</a>
<a name="ln524">//---------------------------------------------------------</a>
<a name="ln525"> </a>
<a name="ln526">void UserPaletteController::editCellProperties(const QModelIndex&amp; index)</a>
<a name="ln527">      {</a>
<a name="ln528">      if (!canEdit(index))</a>
<a name="ln529">            return;</a>
<a name="ln530"> </a>
<a name="ln531">      const QModelIndex srcIndex = convertProxyIndex(index, _userPalette);</a>
<a name="ln532">      PaletteCellPtr cell = _userPalette-&gt;findCell(srcIndex);</a>
<a name="ln533">      if (!cell)</a>
<a name="ln534">            return;</a>
<a name="ln535"> </a>
<a name="ln536">      PaletteCellPropertiesDialog* d = new PaletteCellPropertiesDialog(cell.get(), mscore);</a>
<a name="ln537">      PaletteTreeModel* m = _userPalette;</a>
<a name="ln538"> </a>
<a name="ln539">      const bool treeChangedWasBlocked = m-&gt;blockTreeChanged(true);</a>
<a name="ln540">      const bool paletteChangedState = m-&gt;paletteTreeChanged();</a>
<a name="ln541"> </a>
<a name="ln542">      connect(d, &amp;QDialog::accepted, m, [m, treeChangedWasBlocked]() {</a>
<a name="ln543">            m-&gt;blockTreeChanged(treeChangedWasBlocked);</a>
<a name="ln544">      });</a>
<a name="ln545">      connect(d, &amp;QDialog::rejected, m, [m, srcIndex, paletteChangedState, treeChangedWasBlocked]() {</a>
<a name="ln546">            m-&gt;itemDataChanged(srcIndex);</a>
<a name="ln547">            paletteChangedState ? m-&gt;setTreeChanged() : m-&gt;setTreeUnchanged();</a>
<a name="ln548">            m-&gt;blockTreeChanged(treeChangedWasBlocked);</a>
<a name="ln549">      });</a>
<a name="ln550">      connect(d, &amp;PaletteCellPropertiesDialog::changed, m, [m, srcIndex]() {</a>
<a name="ln551">            m-&gt;itemDataChanged(srcIndex);</a>
<a name="ln552">      });</a>
<a name="ln553"> </a>
<a name="ln554">      d-&gt;setModal(true);</a>
<a name="ln555">      d-&gt;setAttribute(Qt::WA_DeleteOnClose);</a>
<a name="ln556">      d-&gt;open();</a>
<a name="ln557">      }</a>
<a name="ln558"> </a>
<a name="ln559">//---------------------------------------------------------</a>
<a name="ln560">//   UserPaletteController::canEdit</a>
<a name="ln561">//---------------------------------------------------------</a>
<a name="ln562"> </a>
<a name="ln563">bool UserPaletteController::canEdit(const QModelIndex&amp; index) const</a>
<a name="ln564">      {</a>
<a name="ln565">      if (!userEditable())</a>
<a name="ln566">            return false;</a>
<a name="ln567"> </a>
<a name="ln568">      return model()-&gt;data(index, PaletteTreeModel::EditableRole).toBool();</a>
<a name="ln569">      }</a>
<a name="ln570"> </a>
<a name="ln571">//---------------------------------------------------------</a>
<a name="ln572">//   UserPaletteController::applyPaletteElement</a>
<a name="ln573">//---------------------------------------------------------</a>
<a name="ln574"> </a>
<a name="ln575">bool UserPaletteController::applyPaletteElement(const QModelIndex&amp; index, Qt::KeyboardModifiers modifiers)</a>
<a name="ln576">      {</a>
<a name="ln577">      const PaletteCell* cell = model()-&gt;data(index, PaletteTreeModel::PaletteCellRole).value&lt;const PaletteCell*&gt;();</a>
<a name="ln578">      if (cell &amp;&amp; cell-&gt;element)</a>
<a name="ln579">            return Palette::applyPaletteElement(cell-&gt;element.get(), modifiers);</a>
<a name="ln580">      return false;</a>
<a name="ln581">      }</a>
<a name="ln582"> </a>
<a name="ln583">//---------------------------------------------------------</a>
<a name="ln584">//   PaletteWorkspace</a>
<a name="ln585">//---------------------------------------------------------</a>
<a name="ln586"> </a>
<a name="ln587">PaletteWorkspace::PaletteWorkspace(PaletteTreeModel* user, PaletteTreeModel* master, QObject* parent)</a>
<a name="ln588">   : QObject(parent), userPalette(user), masterPalette(master), defaultPalette(nullptr)</a>
<a name="ln589">      {</a>
<a name="ln590">      if (userPalette)</a>
<a name="ln591">            connect(userPalette, &amp;PaletteTreeModel::treeChanged, this, &amp;PaletteWorkspace::userPaletteChanged);</a>
<a name="ln592">      }</a>
<a name="ln593"> </a>
<a name="ln594">//---------------------------------------------------------</a>
<a name="ln595">//   PaletteWorkspace::masterPaletteModel</a>
<a name="ln596">//---------------------------------------------------------</a>
<a name="ln597"> </a>
<a name="ln598">QAbstractItemModel* PaletteWorkspace::mainPaletteModel()</a>
<a name="ln599">      {</a>
<a name="ln600">      if (!mainPalette) {</a>
<a name="ln601">//             PaletteCellFilter* filter = new VisibilityCellFilter(/* acceptedValue */ true);</a>
<a name="ln602">//             mainPalette = new FilterPaletteTreeModel(filter, userPalette, this);</a>
<a name="ln603">            QSortFilterProxyModel* visFilterModel = new QSortFilterProxyModel(this);</a>
<a name="ln604">            visFilterModel-&gt;setFilterRole(PaletteTreeModel::VisibleRole);</a>
<a name="ln605">            visFilterModel-&gt;setFilterFixedString(&quot;true&quot;);</a>
<a name="ln606">            visFilterModel-&gt;setSourceModel(userPalette);</a>
<a name="ln607"> </a>
<a name="ln608">            // Wrap it into another proxy model to enable filtering by palette cell name</a>
<a name="ln609">            QSortFilterProxyModel* textFilterModel = new PaletteCellFilterProxyModel(this);</a>
<a name="ln610">            textFilterModel-&gt;setFilterCaseSensitivity(Qt::CaseInsensitive);</a>
<a name="ln611">            textFilterModel-&gt;setSourceModel(visFilterModel);</a>
<a name="ln612">            visFilterModel-&gt;setParent(textFilterModel);</a>
<a name="ln613"> </a>
<a name="ln614">            mainPalette = textFilterModel;</a>
<a name="ln615">            }</a>
<a name="ln616">      return mainPalette;</a>
<a name="ln617">      }</a>
<a name="ln618"> </a>
<a name="ln619">//---------------------------------------------------------</a>
<a name="ln620">//   PaletteWorkspace::masterPaletteModel</a>
<a name="ln621">//---------------------------------------------------------</a>
<a name="ln622"> </a>
<a name="ln623">AbstractPaletteController* PaletteWorkspace::getMainPaletteController()</a>
<a name="ln624">      {</a>
<a name="ln625">      if (!mainPaletteController)</a>
<a name="ln626">            mainPaletteController = new UserPaletteController(mainPaletteModel(), userPalette, this);</a>
<a name="ln627">//             mainPaletteController = new PaletteController(mainPaletteModel(), this, this);</a>
<a name="ln628">      return mainPaletteController;</a>
<a name="ln629">      }</a>
<a name="ln630"> </a>
<a name="ln631">//---------------------------------------------------------</a>
<a name="ln632">//   PaletteWorkspace::customPaletteIndex</a>
<a name="ln633">//---------------------------------------------------------</a>
<a name="ln634"> </a>
<a name="ln635">QModelIndex PaletteWorkspace::customElementsPaletteIndex(const QModelIndex&amp; index)</a>
<a name="ln636">      {</a>
<a name="ln637">      const QAbstractItemModel* model = customElementsPaletteModel();</a>
<a name="ln638">      if (index.model() == mainPalette &amp;&amp; index.parent() == QModelIndex()) {</a>
<a name="ln639">            const int row = convertProxyIndex(index, userPalette).row();</a>
<a name="ln640">            return model-&gt;index(row, 0);</a>
<a name="ln641">            }</a>
<a name="ln642">      return convertIndex(index, model);</a>
<a name="ln643">      }</a>
<a name="ln644"> </a>
<a name="ln645">//---------------------------------------------------------</a>
<a name="ln646">//   PaletteWorkspace::customElementsPaletteModel</a>
<a name="ln647">//---------------------------------------------------------</a>
<a name="ln648"> </a>
<a name="ln649">FilterPaletteTreeModel* PaletteWorkspace::customElementsPaletteModel()</a>
<a name="ln650">      {</a>
<a name="ln651">      if (!customPoolPalette) {</a>
<a name="ln652">            PaletteCellFilter* filter = new VisibilityCellFilter(/* acceptedValue */ false);</a>
<a name="ln653">            filter-&gt;addChainedFilter(new CustomizedCellFilter(/* acceptedValue */ true));</a>
<a name="ln654">            customPoolPalette = new FilterPaletteTreeModel(filter, userPalette, this);</a>
<a name="ln655">            }</a>
<a name="ln656">      return customPoolPalette;</a>
<a name="ln657">      }</a>
<a name="ln658"> </a>
<a name="ln659">//---------------------------------------------------------</a>
<a name="ln660">//   PaletteWorkspace::getCustomElementsPaletteController</a>
<a name="ln661">//---------------------------------------------------------</a>
<a name="ln662"> </a>
<a name="ln663">AbstractPaletteController* PaletteWorkspace::getCustomElementsPaletteController()</a>
<a name="ln664">      {</a>
<a name="ln665">      if (!customElementsPaletteController) {</a>
<a name="ln666">            customElementsPaletteController = new UserPaletteController(customElementsPaletteModel(), userPalette, this);</a>
<a name="ln667">            customElementsPaletteController-&gt;setVisible(false);</a>
<a name="ln668">            customElementsPaletteController-&gt;setCustom(true);</a>
<a name="ln669">            }</a>
<a name="ln670">//             customElementsPaletteController = new CustomPaletteController(customElementsPaletteModel(), this, this);</a>
<a name="ln671">      return customElementsPaletteController;</a>
<a name="ln672">      }</a>
<a name="ln673"> </a>
<a name="ln674">//---------------------------------------------------------</a>
<a name="ln675">//   PaletteWorkspace::poolPaletteIndex</a>
<a name="ln676">//---------------------------------------------------------</a>
<a name="ln677"> </a>
<a name="ln678">QModelIndex PaletteWorkspace::poolPaletteIndex(const QModelIndex&amp; index, Ms::FilterPaletteTreeModel* poolPalette)</a>
<a name="ln679">      {</a>
<a name="ln680">      const QModelIndex poolPaletteIndex = convertIndex(index, poolPalette);</a>
<a name="ln681">      if (poolPaletteIndex.isValid())</a>
<a name="ln682">            return poolPaletteIndex;</a>
<a name="ln683">      const auto contentType = index.data(PaletteTreeModel::PaletteContentTypeRole).value&lt;PalettePanel::Type&gt;();</a>
<a name="ln684">      return findPaletteIndex(poolPalette, contentType);</a>
<a name="ln685">      }</a>
<a name="ln686"> </a>
<a name="ln687">//---------------------------------------------------------</a>
<a name="ln688">//   PaletteWorkspace::masterPaletteModel</a>
<a name="ln689">//---------------------------------------------------------</a>
<a name="ln690"> </a>
<a name="ln691">FilterPaletteTreeModel* PaletteWorkspace::poolPaletteModel(const QModelIndex&amp; index)</a>
<a name="ln692">      {</a>
<a name="ln693">      const QModelIndex filterIndex = convertProxyIndex(index, userPalette);</a>
<a name="ln694">      PaletteCellFilter* filter = userPalette-&gt;getFilter(filterIndex); // TODO: or mainPalette?</a>
<a name="ln695">      if (!filter)</a>
<a name="ln696">            return nullptr;</a>
<a name="ln697"> </a>
<a name="ln698">      FilterPaletteTreeModel* m = new FilterPaletteTreeModel(filter, masterPalette);</a>
<a name="ln699">      QQmlEngine::setObjectOwnership(m, QQmlEngine::JavaScriptOwnership);</a>
<a name="ln700">      return m;</a>
<a name="ln701">      }</a>
<a name="ln702"> </a>
<a name="ln703">//---------------------------------------------------------</a>
<a name="ln704">//   PaletteWorkspace::masterPaletteController</a>
<a name="ln705">//---------------------------------------------------------</a>
<a name="ln706"> </a>
<a name="ln707">AbstractPaletteController* PaletteWorkspace::poolPaletteController(FilterPaletteTreeModel* poolPaletteModel, const QModelIndex&amp; rootIndex)</a>
<a name="ln708">      {</a>
<a name="ln709">      Q_UNUSED(rootIndex);</a>
<a name="ln710">      UserPaletteController* c = new UserPaletteController(poolPaletteModel, userPalette);</a>
<a name="ln711">      c-&gt;setVisible(false);</a>
<a name="ln712">      c-&gt;setCustom(false);</a>
<a name="ln713">      c-&gt;setUserEditable(false);</a>
<a name="ln714">//       AbstractPaletteController* c = new MasterPaletteController(poolPaletteModel, userPalette, this);</a>
<a name="ln715">      QQmlEngine::setObjectOwnership(c, QQmlEngine::JavaScriptOwnership);</a>
<a name="ln716">      return c;</a>
<a name="ln717">      }</a>
<a name="ln718"> </a>
<a name="ln719">//---------------------------------------------------------</a>
<a name="ln720">//   PaletteWorkspace::availableExtraPalettePanelsModel</a>
<a name="ln721">//---------------------------------------------------------</a>
<a name="ln722"> </a>
<a name="ln723">QAbstractItemModel* PaletteWorkspace::availableExtraPalettesModel()</a>
<a name="ln724">      {</a>
<a name="ln725">      QStandardItemModel* m = new QStandardItemModel;</a>
<a name="ln726"> </a>
<a name="ln727">      {</a>
<a name="ln728">      auto roleNames = m-&gt;roleNames();</a>
<a name="ln729">      roleNames[CustomRole] = &quot;custom&quot;;</a>
<a name="ln730">      roleNames[PaletteIndexRole] = &quot;paletteIndex&quot;;</a>
<a name="ln731">      m-&gt;setItemRoleNames(roleNames);</a>
<a name="ln732">      }</a>
<a name="ln733"> </a>
<a name="ln734">      QStandardItem* root = m-&gt;invisibleRootItem();</a>
<a name="ln735"> </a>
<a name="ln736">      const int masterRows = masterPalette-&gt;rowCount();</a>
<a name="ln737">      for (int row = 0; row &lt; masterRows; ++row) {</a>
<a name="ln738">            const QModelIndex idx = masterPalette-&gt;index(row, 0);</a>
<a name="ln739">            // add everything that cannot be found in user palette</a>
<a name="ln740">            if (!convertIndex(idx, userPalette).isValid()) {</a>
<a name="ln741">                  const QString name = masterPalette-&gt;data(idx, Qt::DisplayRole).toString();</a>
<a name="ln742">                  QStandardItem* item = new QStandardItem(name);</a>
<a name="ln743">                  item-&gt;setData(false, CustomRole); // this palette is from master palette, hence not custom</a>
<a name="ln744">                  item-&gt;setData(QPersistentModelIndex(idx), PaletteIndexRole);</a>
<a name="ln745">                  root-&gt;appendRow(item);</a>
<a name="ln746">                  }</a>
<a name="ln747">            }</a>
<a name="ln748"> </a>
<a name="ln749">      const int userRows = userPalette-&gt;rowCount();</a>
<a name="ln750">      for (int row = 0; row &lt; userRows; ++row) {</a>
<a name="ln751">            const QModelIndex idx = userPalette-&gt;index(row, 0);</a>
<a name="ln752">            // add invisible custom palettes</a>
<a name="ln753">            const bool visible = userPalette-&gt;data(idx, PaletteTreeModel::VisibleRole).toBool();</a>
<a name="ln754">            const bool custom = userPalette-&gt;data(idx, PaletteTreeModel::CustomRole).toBool();</a>
<a name="ln755">            if (!visible) {</a>
<a name="ln756">                  const QString name = userPalette-&gt;data(idx, Qt::DisplayRole).toString();</a>
<a name="ln757">                  QStandardItem* item = new QStandardItem(name);</a>
<a name="ln758">                  item-&gt;setData(custom, CustomRole);</a>
<a name="ln759">                  item-&gt;setData(QPersistentModelIndex(idx), PaletteIndexRole);</a>
<a name="ln760">                  root-&gt;appendRow(item);</a>
<a name="ln761">                  }</a>
<a name="ln762">            }</a>
<a name="ln763"> </a>
<a name="ln764">      QQmlEngine::setObjectOwnership(m, QQmlEngine::JavaScriptOwnership);</a>
<a name="ln765">      return m;</a>
<a name="ln766">      }</a>
<a name="ln767"> </a>
<a name="ln768">//---------------------------------------------------------</a>
<a name="ln769">//   PaletteWorkspace::addPalette</a>
<a name="ln770">//---------------------------------------------------------</a>
<a name="ln771"> </a>
<a name="ln772">bool PaletteWorkspace::addPalette(const QPersistentModelIndex&amp; index)</a>
<a name="ln773">      {</a>
<a name="ln774">      if (!index.isValid())</a>
<a name="ln775">            return false;</a>
<a name="ln776"> </a>
<a name="ln777">      if (index.model() == userPalette) {</a>
<a name="ln778">            const bool ok = userPalette-&gt;setData(index, true, PaletteTreeModel::VisibleRole);</a>
<a name="ln779">            if (!ok)</a>
<a name="ln780">                  return false;</a>
<a name="ln781">            const QModelIndex parent = index.parent();</a>
<a name="ln782">            userPalette-&gt;moveRow(parent, index.row(), parent, 0);</a>
<a name="ln783">            return true;</a>
<a name="ln784">            }</a>
<a name="ln785"> </a>
<a name="ln786">      if (index.model() == masterPalette) {</a>
<a name="ln787">            QMimeData* data = masterPalette-&gt;mimeData({ QModelIndex(index) });</a>
<a name="ln788">            const bool success = userPalette-&gt;dropMimeData(data, Qt::CopyAction, 0, 0, QModelIndex());</a>
<a name="ln789">            data-&gt;deleteLater();</a>
<a name="ln790">            return success;</a>
<a name="ln791">            }</a>
<a name="ln792"> </a>
<a name="ln793">      return false;</a>
<a name="ln794">      }</a>
<a name="ln795"> </a>
<a name="ln796">//---------------------------------------------------------</a>
<a name="ln797">//   PaletteWorkspace::removeCustomPalette</a>
<a name="ln798">//---------------------------------------------------------</a>
<a name="ln799"> </a>
<a name="ln800">bool PaletteWorkspace::removeCustomPalette(const QPersistentModelIndex&amp; index)</a>
<a name="ln801">      {</a>
<a name="ln802">      if (!index.isValid())</a>
<a name="ln803">            return false;</a>
<a name="ln804"> </a>
<a name="ln805"> </a>
<a name="ln806">      if (index.model() == userPalette) {</a>
<a name="ln807">            const bool custom = index.data(PaletteTreeModel::CustomRole).toBool();</a>
<a name="ln808">            if (!custom)</a>
<a name="ln809">                  return false;</a>
<a name="ln810"> </a>
<a name="ln811">            const auto answer = QMessageBox::question(</a>
<a name="ln812">                  nullptr,</a>
<a name="ln813">                  &quot;&quot;,</a>
<a name="ln814">                  tr(&quot;Do you want to permanently delete this custom palette?&quot;),</a>
<a name="ln815">                  QMessageBox::Yes | QMessageBox::No</a>
<a name="ln816">                  );</a>
<a name="ln817"> </a>
<a name="ln818">            if (answer == QMessageBox::Yes)</a>
<a name="ln819">                  return userPalette-&gt;removeRow(index.row(), index.parent());</a>
<a name="ln820">            return false;</a>
<a name="ln821">            }</a>
<a name="ln822"> </a>
<a name="ln823">      return false;</a>
<a name="ln824">      }</a>
<a name="ln825"> </a>
<a name="ln826">//---------------------------------------------------------</a>
<a name="ln827">//   PaletteWorkspace::resetPalette</a>
<a name="ln828">//---------------------------------------------------------</a>
<a name="ln829"> </a>
<a name="ln830">bool PaletteWorkspace::resetPalette(const QModelIndex&amp; index)</a>
<a name="ln831">      {</a>
<a name="ln832">      if (!index.isValid())</a>
<a name="ln833">            return false;</a>
<a name="ln834"> </a>
<a name="ln835">      const auto answer =</a>
<a name="ln836">         (MScore::noGui &amp;&amp; MScore::testMode)</a>
<a name="ln837">         ? QMessageBox::Yes</a>
<a name="ln838">         : QMessageBox::question(</a>
<a name="ln839">            nullptr,</a>
<a name="ln840">            &quot;&quot;,</a>
<a name="ln841">            tr(&quot;Do you want to restore this palette to its default state? All changes to this palette will be lost.&quot;),</a>
<a name="ln842">            QMessageBox::Yes | QMessageBox::No</a>
<a name="ln843">            );</a>
<a name="ln844"> </a>
<a name="ln845">      if (answer != QMessageBox::Yes)</a>
<a name="ln846">            return false;</a>
<a name="ln847"> </a>
<a name="ln848">      Q_ASSERT(defaultPalette != userPalette);</a>
<a name="ln849"> </a>
<a name="ln850">      QAbstractItemModel* resetModel = nullptr;</a>
<a name="ln851">      QModelIndex resetIndex;</a>
<a name="ln852"> </a>
<a name="ln853">      if (defaultPalette) {</a>
<a name="ln854">            resetModel = defaultPalette;</a>
<a name="ln855">            resetIndex = convertIndex(index, defaultPalette);</a>
<a name="ln856">            }</a>
<a name="ln857"> </a>
<a name="ln858">      if (!resetIndex.isValid()) {</a>
<a name="ln859">            resetModel = masterPalette;</a>
<a name="ln860">            resetIndex = convertIndex(index, masterPalette);</a>
<a name="ln861">            }</a>
<a name="ln862"> </a>
<a name="ln863">      const QModelIndex userPaletteIndex = convertProxyIndex(index, userPalette);</a>
<a name="ln864">      const QModelIndex parent = userPaletteIndex.parent();</a>
<a name="ln865">      const int row = userPaletteIndex.row();</a>
<a name="ln866">      const int column = userPaletteIndex.column();</a>
<a name="ln867"> </a>
<a name="ln868">      // restore visibility and expanded state of the palette after restoring its state</a>
<a name="ln869">      const bool wasVisible = index.data(PaletteTreeModel::VisibleRole).toBool();</a>
<a name="ln870">      const bool wasExpanded = index.data(PaletteTreeModel::PaletteExpandedRole).toBool();</a>
<a name="ln871"> </a>
<a name="ln872">      if (!userPalette-&gt;removeRow(row, parent))</a>
<a name="ln873">            return false;</a>
<a name="ln874"> </a>
<a name="ln875">      if (resetIndex.isValid()) {</a>
<a name="ln876">            QMimeData* data = resetModel-&gt;mimeData({ resetIndex });</a>
<a name="ln877">            userPalette-&gt;dropMimeData(data, Qt::CopyAction, row, column, parent);</a>
<a name="ln878">            data-&gt;deleteLater();</a>
<a name="ln879">            }</a>
<a name="ln880">      else</a>
<a name="ln881">            userPalette-&gt;insertRow(row, parent);</a>
<a name="ln882"> </a>
<a name="ln883">      const QModelIndex newIndex = userPalette-&gt;index(row, column, parent);</a>
<a name="ln884">      userPalette-&gt;setData(newIndex, wasVisible, PaletteTreeModel::VisibleRole);</a>
<a name="ln885">      userPalette-&gt;setData(newIndex, wasExpanded, PaletteTreeModel::PaletteExpandedRole);</a>
<a name="ln886"> </a>
<a name="ln887">      return true;</a>
<a name="ln888">      }</a>
<a name="ln889"> </a>
<a name="ln890">//---------------------------------------------------------</a>
<a name="ln891">//   PaletteWorkspace::savePalette</a>
<a name="ln892">//---------------------------------------------------------</a>
<a name="ln893"> </a>
<a name="ln894">bool PaletteWorkspace::savePalette(const QModelIndex&amp; index)</a>
<a name="ln895">      {</a>
<a name="ln896">      const QModelIndex srcIndex = convertProxyIndex(index, userPalette);</a>
<a name="ln897">      const PalettePanel* pp = userPalette-&gt;findPalettePanel(srcIndex);</a>
<a name="ln898">      if (!pp)</a>
<a name="ln899">            return false;</a>
<a name="ln900"> </a>
<a name="ln901">      const QString path = mscore-&gt;getPaletteFilename(/* load? */ false, pp-&gt;translatedName());</a>
<a name="ln902"> </a>
<a name="ln903">      if (path.isEmpty())</a>
<a name="ln904">            return false;</a>
<a name="ln905">      return pp-&gt;writeToFile(path);</a>
<a name="ln906">      }</a>
<a name="ln907"> </a>
<a name="ln908">//---------------------------------------------------------</a>
<a name="ln909">//   PaletteWorkspace::loadPalette</a>
<a name="ln910">//---------------------------------------------------------</a>
<a name="ln911"> </a>
<a name="ln912">bool PaletteWorkspace::loadPalette(const QModelIndex&amp; index)</a>
<a name="ln913">      {</a>
<a name="ln914">      const QString path = mscore-&gt;getPaletteFilename(/* load? */ true);</a>
<a name="ln915">      if (path.isEmpty())</a>
<a name="ln916">            return false;</a>
<a name="ln917"> </a>
<a name="ln918">      std::unique_ptr&lt;PalettePanel&gt; pp(new PalettePanel);</a>
<a name="ln919">      if (!pp-&gt;readFromFile(path))</a>
<a name="ln920">            return false;</a>
<a name="ln921">      pp-&gt;setType(PalettePanel::Type::Custom); // mark the loaded palette custom</a>
<a name="ln922"> </a>
<a name="ln923">      const QModelIndex srcIndex = convertProxyIndex(index, userPalette);</a>
<a name="ln924"> </a>
<a name="ln925">      const int row = srcIndex.row();</a>
<a name="ln926">      const QModelIndex parent = srcIndex.parent();</a>
<a name="ln927"> </a>
<a name="ln928">      return userPalette-&gt;insertPalettePanel(std::move(pp), row, parent);</a>
<a name="ln929">      }</a>
<a name="ln930"> </a>
<a name="ln931">//---------------------------------------------------------</a>
<a name="ln932">//   PaletteWorkspace::setUserPaletteTree</a>
<a name="ln933">//---------------------------------------------------------</a>
<a name="ln934"> </a>
<a name="ln935">void PaletteWorkspace::setUserPaletteTree(std::unique_ptr&lt;PaletteTree&gt; tree)</a>
<a name="ln936">      {</a>
<a name="ln937">      if (userPalette) {</a>
<a name="ln938">            disconnect(userPalette, &amp;PaletteTreeModel::treeChanged, this, &amp;PaletteWorkspace::userPaletteChanged);</a>
<a name="ln939">            userPalette-&gt;setPaletteTree(std::move(tree));</a>
<a name="ln940">            connect(userPalette, &amp;PaletteTreeModel::treeChanged, this, &amp;PaletteWorkspace::userPaletteChanged);</a>
<a name="ln941">            }</a>
<a name="ln942">      else {</a>
<a name="ln943">            userPalette = new PaletteTreeModel(std::move(tree), /* parent */ this);</a>
<a name="ln944">            connect(userPalette, &amp;PaletteTreeModel::treeChanged, this, &amp;PaletteWorkspace::userPaletteChanged);</a>
<a name="ln945">            }</a>
<a name="ln946">      }</a>
<a name="ln947"> </a>
<a name="ln948">void PaletteWorkspace::setDefaultPaletteTree(std::unique_ptr&lt;PaletteTree&gt; tree)</a>
<a name="ln949">      {</a>
<a name="ln950">      if (defaultPalette)</a>
<a name="ln951">            defaultPalette-&gt;setPaletteTree(std::move(tree));</a>
<a name="ln952">      else</a>
<a name="ln953">            defaultPalette = new PaletteTreeModel(std::move(tree), /* parent */ this);</a>
<a name="ln954">      }</a>
<a name="ln955"> </a>
<a name="ln956">//---------------------------------------------------------</a>
<a name="ln957">//   PaletteWorkspace::write</a>
<a name="ln958">//---------------------------------------------------------</a>
<a name="ln959"> </a>
<a name="ln960">void PaletteWorkspace::write(XmlWriter&amp; xml) const</a>
<a name="ln961">      {</a>
<a name="ln962">      if (!userPalette)</a>
<a name="ln963">            return;</a>
<a name="ln964">      if (const PaletteTree* tree = userPalette-&gt;paletteTree())</a>
<a name="ln965">            tree-&gt;write(xml);</a>
<a name="ln966">      }</a>
<a name="ln967"> </a>
<a name="ln968">//---------------------------------------------------------</a>
<a name="ln969">//   PaletteWorkspace::read</a>
<a name="ln970">//---------------------------------------------------------</a>
<a name="ln971"> </a>
<a name="ln972">bool PaletteWorkspace::read(XmlReader&amp; e)</a>
<a name="ln973">      {</a>
<a name="ln974">      std::unique_ptr&lt;PaletteTree&gt; tree(new PaletteTree);</a>
<a name="ln975">      if (!tree-&gt;read(e))</a>
<a name="ln976">            return false;</a>
<a name="ln977"> </a>
<a name="ln978">      setUserPaletteTree(std::move(tree));</a>
<a name="ln979"> </a>
<a name="ln980">      return true;</a>
<a name="ln981">      }</a>
<a name="ln982">} // namespace Ms</a>

</code></pre>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
