
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>read114.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2011 Werner Schweer and others</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENSE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;score.h&quot;</a>
<a name="ln14">#include &quot;slur.h&quot;</a>
<a name="ln15">#include &quot;staff.h&quot;</a>
<a name="ln16">#include &quot;excerpt.h&quot;</a>
<a name="ln17">#include &quot;chord.h&quot;</a>
<a name="ln18">#include &quot;rest.h&quot;</a>
<a name="ln19">#include &quot;keysig.h&quot;</a>
<a name="ln20">#include &quot;volta.h&quot;</a>
<a name="ln21">#include &quot;measure.h&quot;</a>
<a name="ln22">#include &quot;beam.h&quot;</a>
<a name="ln23">#include &quot;segment.h&quot;</a>
<a name="ln24">#include &quot;ottava.h&quot;</a>
<a name="ln25">#include &quot;stafftype.h&quot;</a>
<a name="ln26">#include &quot;text.h&quot;</a>
<a name="ln27">#include &quot;measurenumber.h&quot;</a>
<a name="ln28">#include &quot;part.h&quot;</a>
<a name="ln29">#include &quot;sig.h&quot;</a>
<a name="ln30">#include &quot;box.h&quot;</a>
<a name="ln31">#include &quot;dynamic.h&quot;</a>
<a name="ln32">#include &quot;drumset.h&quot;</a>
<a name="ln33">#include &quot;style.h&quot;</a>
<a name="ln34">#include &quot;sym.h&quot;</a>
<a name="ln35">#include &quot;xml.h&quot;</a>
<a name="ln36">#include &quot;stringdata.h&quot;</a>
<a name="ln37">#include &quot;tempo.h&quot;</a>
<a name="ln38">#include &quot;tempotext.h&quot;</a>
<a name="ln39">#include &quot;clef.h&quot;</a>
<a name="ln40">#include &quot;barline.h&quot;</a>
<a name="ln41">#include &quot;timesig.h&quot;</a>
<a name="ln42">#include &quot;tuplet.h&quot;</a>
<a name="ln43">#include &quot;spacer.h&quot;</a>
<a name="ln44">#include &quot;stafftext.h&quot;</a>
<a name="ln45">#include &quot;repeat.h&quot;</a>
<a name="ln46">#include &quot;breath.h&quot;</a>
<a name="ln47">#include &quot;tremolo.h&quot;</a>
<a name="ln48">#include &quot;utils.h&quot;</a>
<a name="ln49">#include &quot;accidental.h&quot;</a>
<a name="ln50">#include &quot;fingering.h&quot;</a>
<a name="ln51">#include &quot;marker.h&quot;</a>
<a name="ln52">#include &quot;read206.h&quot;</a>
<a name="ln53">#include &quot;bracketItem.h&quot;</a>
<a name="ln54">#include &quot;harmony.h&quot;</a>
<a name="ln55">#include &quot;lyrics.h&quot;</a>
<a name="ln56">#include &quot;image.h&quot;</a>
<a name="ln57">#include &quot;textframe.h&quot;</a>
<a name="ln58">#include &quot;jump.h&quot;</a>
<a name="ln59">#include &quot;textline.h&quot;</a>
<a name="ln60">#include &quot;pedal.h&quot;</a>
<a name="ln61"> </a>
<a name="ln62">namespace Ms {</a>
<a name="ln63"> </a>
<a name="ln64">static int g_guitarStrings[] = {40,45,50,55,59,64};</a>
<a name="ln65">static int g_bassStrings[]   = {28,33,38,43};</a>
<a name="ln66">static int g_violinStrings[] = {55,62,69,76};</a>
<a name="ln67">static int g_violaStrings[]  = {48,55,62,69};</a>
<a name="ln68">static int g_celloStrings[]  = {36,43,50,57};</a>
<a name="ln69"> </a>
<a name="ln70">//---------------------------------------------------------</a>
<a name="ln71">//   StyleVal114</a>
<a name="ln72">//---------------------------------------------------------</a>
<a name="ln73"> </a>
<a name="ln74">struct StyleVal2 {</a>
<a name="ln75">      Sid sid;</a>
<a name="ln76">      QVariant val;</a>
<a name="ln77">      };</a>
<a name="ln78"> </a>
<a name="ln79">static const StyleVal2 style114[] = {</a>
<a name="ln80">//      { Sid::lyricsMinBottomDistance,      Spatium(2) },</a>
<a name="ln81">      { Sid::lyricsDashForce,              QVariant(false) },</a>
<a name="ln82">      { Sid::frameSystemDistance,          Spatium(1.0) },</a>
<a name="ln83">      { Sid::minMeasureWidth,              Spatium(4.0) },</a>
<a name="ln84">//      { Sid::endBarDistance,               Spatium(0.30) },</a>
<a name="ln85"> </a>
<a name="ln86">      { Sid::repeatBarTips,                QVariant(false) },</a>
<a name="ln87">      { Sid::startBarlineSingle,           QVariant(false) },</a>
<a name="ln88">      { Sid::startBarlineMultiple,         QVariant(true) },</a>
<a name="ln89">      { Sid::bracketWidth,                 QVariant(0.35) },</a>
<a name="ln90">      { Sid::bracketDistance,              QVariant(0.25) },</a>
<a name="ln91">      { Sid::clefLeftMargin,               QVariant(0.5) },</a>
<a name="ln92">      { Sid::keysigLeftMargin,             QVariant(0.5) },</a>
<a name="ln93">      { Sid::timesigLeftMargin,            QVariant(0.5) },</a>
<a name="ln94">      { Sid::clefKeyRightMargin,           QVariant(1.75) },</a>
<a name="ln95">      { Sid::clefBarlineDistance,          QVariant(0.18) },</a>
<a name="ln96">      { Sid::stemWidth,                    QVariant(0.13) },</a>
<a name="ln97">      { Sid::shortenStem,                  QVariant(true) },</a>
<a name="ln98">      { Sid::shortStemProgression,         QVariant(0.25) },</a>
<a name="ln99">      { Sid::shortestStem,                 QVariant(2.25) },</a>
<a name="ln100">      { Sid::beginRepeatLeftMargin,        QVariant(1.0) },</a>
<a name="ln101">      { Sid::minNoteDistance,              QVariant(0.4) },</a>
<a name="ln102">      { Sid::barNoteDistance,              QVariant(1.2) },</a>
<a name="ln103">      { Sid::noteBarDistance,              QVariant(1.0) },</a>
<a name="ln104">      { Sid::measureSpacing,               QVariant(1.2) },</a>
<a name="ln105">      { Sid::staffLineWidth,               QVariant(0.08) },</a>
<a name="ln106">      { Sid::ledgerLineWidth,              QVariant(0.12) },</a>
<a name="ln107">      { Sid::akkoladeWidth,                QVariant(1.6) },</a>
<a name="ln108">      { Sid::accidentalDistance,           QVariant(0.22) },</a>
<a name="ln109">      { Sid::accidentalNoteDistance,       QVariant(0.22) },</a>
<a name="ln110">      { Sid::beamWidth,                    QVariant(0.48) },</a>
<a name="ln111">      { Sid::beamDistance,                 QVariant(0.5) },</a>
<a name="ln112">      { Sid::beamMinLen,                   QVariant(1.25) },</a>
<a name="ln113">      { Sid::dotNoteDistance,              QVariant(0.35) },</a>
<a name="ln114">      { Sid::dotRestDistance,              QVariant(0.25) },</a>
<a name="ln115">      { Sid::dotDotDistance,               QVariant(0.5) },</a>
<a name="ln116">      { Sid::propertyDistanceHead,         QVariant(1.0) },</a>
<a name="ln117">      { Sid::propertyDistanceStem,         QVariant(0.5) },</a>
<a name="ln118">      { Sid::propertyDistance,             QVariant(1.0) },</a>
<a name="ln119">      { Sid::articulationMag,              QVariant(qreal(1.0)) },</a>
<a name="ln120">      { Sid::lastSystemFillLimit,          QVariant(0.3) },</a>
<a name="ln121">      { Sid::hairpinHeight,                QVariant(1.2) },</a>
<a name="ln122">      { Sid::hairpinContHeight,            QVariant(0.5) },</a>
<a name="ln123">      { Sid::hairpinLineWidth,             QVariant(0.13) },</a>
<a name="ln124">      { Sid::showPageNumber,               QVariant(true) },</a>
<a name="ln125">      { Sid::showPageNumberOne,            QVariant(false) },</a>
<a name="ln126">      { Sid::pageNumberOddEven,            QVariant(true) },</a>
<a name="ln127">      { Sid::showMeasureNumber,            QVariant(true) },</a>
<a name="ln128">      { Sid::showMeasureNumberOne,         QVariant(false) },</a>
<a name="ln129">      { Sid::measureNumberInterval,        QVariant(5) },</a>
<a name="ln130">      { Sid::measureNumberSystem,          QVariant(true) },</a>
<a name="ln131">      { Sid::measureNumberAllStaffs,       QVariant(false) },</a>
<a name="ln132">      { Sid::smallNoteMag,                 QVariant(qreal(0.7)) },</a>
<a name="ln133">      { Sid::graceNoteMag,                 QVariant(qreal(0.7)) },</a>
<a name="ln134">      { Sid::smallStaffMag,                QVariant(qreal(0.7)) },</a>
<a name="ln135">      { Sid::smallClefMag,                 QVariant(qreal(0.8)) },</a>
<a name="ln136">      { Sid::genClef,                      QVariant(true) },</a>
<a name="ln137">      { Sid::genKeysig,                    QVariant(true) },</a>
<a name="ln138">      { Sid::genCourtesyTimesig,           QVariant(true) },</a>
<a name="ln139">      { Sid::genCourtesyKeysig,            QVariant(true) },</a>
<a name="ln140">      { Sid::useStandardNoteNames,         QVariant(true) },</a>
<a name="ln141">      { Sid::useGermanNoteNames,           QVariant(false) },</a>
<a name="ln142">      { Sid::useFullGermanNoteNames,       QVariant(false) },</a>
<a name="ln143">      { Sid::useSolfeggioNoteNames,        QVariant(false) },</a>
<a name="ln144">      { Sid::useFrenchNoteNames,           QVariant(false) },</a>
<a name="ln145">      { Sid::chordDescriptionFile,         QVariant(QString(&quot;stdchords.xml&quot;)) },</a>
<a name="ln146">      { Sid::chordStyle,                   QVariant(QString(&quot;custom&quot;)) },</a>
<a name="ln147">      { Sid::chordsXmlFile,                QVariant(true) },</a>
<a name="ln148">//      { Sid::harmonyY,                     QVariant(0.0) },</a>
<a name="ln149">      { Sid::concertPitch,                 QVariant(false) },</a>
<a name="ln150">      { Sid::createMultiMeasureRests,      QVariant(false) },</a>
<a name="ln151">      { Sid::minEmptyMeasures,             QVariant(2) },</a>
<a name="ln152">      { Sid::minMMRestWidth,               QVariant(4.0) },</a>
<a name="ln153">      { Sid::hideEmptyStaves,              QVariant(false) },</a>
<a name="ln154">      { Sid::gateTime,                     QVariant(100) },</a>
<a name="ln155">      { Sid::tenutoGateTime,               QVariant(100) },</a>
<a name="ln156">      { Sid::staccatoGateTime,             QVariant(50) },</a>
<a name="ln157">      { Sid::slurGateTime,                 QVariant(100) },</a>
<a name="ln158">      { Sid::ArpeggioNoteDistance,         QVariant(.5) },</a>
<a name="ln159">      { Sid::ArpeggioLineWidth,            QVariant(.18) },</a>
<a name="ln160">      { Sid::ArpeggioHookLen,              QVariant(.8) },</a>
<a name="ln161">      { Sid::keySigNaturals,               QVariant(int(KeySigNatural::BEFORE)) },</a>
<a name="ln162">      { Sid::tupletMaxSlope,               QVariant(qreal(0.5)) },</a>
<a name="ln163">      { Sid::tupletOufOfStaff,             QVariant(false) },</a>
<a name="ln164">      { Sid::tupletVHeadDistance,          QVariant(.5) },</a>
<a name="ln165">      { Sid::tupletVStemDistance,          QVariant(.25) },</a>
<a name="ln166">      { Sid::tupletStemLeftDistance,       QVariant(.5) },</a>
<a name="ln167">      { Sid::tupletStemRightDistance,      QVariant(.5) },</a>
<a name="ln168">      { Sid::tupletNoteLeftDistance,       QVariant(0.0) },</a>
<a name="ln169">      { Sid::tupletNoteRightDistance,      QVariant(0.0) },</a>
<a name="ln170">      { Sid::hideInstrumentNameIfOneInstrument, QVariant(false) },</a>
<a name="ln171">      };</a>
<a name="ln172"> </a>
<a name="ln173">#define MM(x) ((x)/INCH)</a>
<a name="ln174"> </a>
<a name="ln175">//---------------------------------------------------------</a>
<a name="ln176">//   PaperSize</a>
<a name="ln177">//---------------------------------------------------------</a>
<a name="ln178"> </a>
<a name="ln179">struct PaperSize {</a>
<a name="ln180">      const char* name;</a>
<a name="ln181">      qreal w, h;            // size in inch</a>
<a name="ln182">      PaperSize(const char* n, qreal wi, qreal hi)</a>
<a name="ln183">         : name(n), w(wi), h(hi) {}</a>
<a name="ln184">      };</a>
<a name="ln185"> </a>
<a name="ln186">static const PaperSize paperSizes114[] = {</a>
<a name="ln187">      PaperSize(&quot;Custom&quot;,    MM(1),    MM(1)),</a>
<a name="ln188">      PaperSize(&quot;A4&quot;,        MM(210),  MM(297)),</a>
<a name="ln189">      PaperSize(&quot;B5&quot;,        MM(176),  MM(250)),</a>
<a name="ln190">      PaperSize(&quot;Letter&quot;,    8.5,      11),</a>
<a name="ln191">      PaperSize(&quot;Legal&quot;,     8.5,      14),</a>
<a name="ln192">      PaperSize(&quot;Executive&quot;, 7.5,      10),</a>
<a name="ln193">      PaperSize(&quot;A0&quot;,        MM(841),  MM(1189)),</a>
<a name="ln194">      PaperSize(&quot;A1&quot;,        MM(594),  MM(841)),</a>
<a name="ln195">      PaperSize(&quot;A2&quot;,        MM(420),  MM(594)),</a>
<a name="ln196">      PaperSize(&quot;A3&quot;,        MM(297),  MM(420)),</a>
<a name="ln197">      PaperSize(&quot;A5&quot;,        MM(148),  MM(210)),</a>
<a name="ln198">      PaperSize(&quot;A6&quot;,        MM(105),  MM(148)),</a>
<a name="ln199">      PaperSize(&quot;A7&quot;,        MM(74),   MM(105)),</a>
<a name="ln200">      PaperSize(&quot;A8&quot;,        MM(52),   MM(74)),</a>
<a name="ln201">      PaperSize(&quot;A9&quot;,        MM(37),   MM(52)),</a>
<a name="ln202">      PaperSize(&quot;A10&quot;,       MM(26),   MM(37)),</a>
<a name="ln203">      PaperSize(&quot;B0&quot;,        MM(1000), MM(1414)),</a>
<a name="ln204">      PaperSize(&quot;B1&quot;,        MM(707),  MM(1000)),</a>
<a name="ln205">      PaperSize(&quot;B2&quot;,        MM(500),  MM(707)),</a>
<a name="ln206">      PaperSize(&quot;B3&quot;,        MM(353),  MM(500)),</a>
<a name="ln207">      PaperSize(&quot;B4&quot;,        MM(250),  MM(353)),</a>
<a name="ln208">      PaperSize(&quot;B6&quot;,        MM(125),  MM(176)),</a>
<a name="ln209">      PaperSize(&quot;B7&quot;,        MM(88),   MM(125)),</a>
<a name="ln210">      PaperSize(&quot;B8&quot;,        MM(62),   MM(88)),</a>
<a name="ln211">      PaperSize(&quot;B9&quot;,        MM(44),   MM(62)),</a>
<a name="ln212">      PaperSize(&quot;B10&quot;,       MM(31),   MM(44)),</a>
<a name="ln213">      PaperSize(&quot;Comm10E&quot;,   MM(105),  MM(241)),</a>
<a name="ln214">      PaperSize(&quot;DLE&quot;,       MM(110),  MM(220)),</a>
<a name="ln215">      PaperSize(&quot;Folio&quot;,     MM(210),  MM(330)),</a>
<a name="ln216">      PaperSize(&quot;Ledger&quot;,    MM(432),  MM(279)),</a>
<a name="ln217">      PaperSize(&quot;Tabloid&quot;,   MM(279),  MM(432)),</a>
<a name="ln218">      PaperSize(0,           MM(1),    MM(1))   // mark end of list</a>
<a name="ln219">      };</a>
<a name="ln220"> </a>
<a name="ln221"> </a>
<a name="ln222">//---------------------------------------------------------</a>
<a name="ln223">//   getPaperSize</a>
<a name="ln224">//---------------------------------------------------------</a>
<a name="ln225"> </a>
<a name="ln226">static const PaperSize* getPaperSize114(const QString&amp; name)</a>
<a name="ln227">      {</a>
<a name="ln228">      for (int i = 0; paperSizes114[i].name; ++i) {</a>
<a name="ln229">            if (name == paperSizes114[i].name)</a>
<a name="ln230">                  return &amp;paperSizes114[i];</a>
<a name="ln231">            }</a>
<a name="ln232">      qDebug(&quot;unknown paper size&quot;);</a>
<a name="ln233">      return &amp;paperSizes114[0];</a>
<a name="ln234">      }</a>
<a name="ln235"> </a>
<a name="ln236">//---------------------------------------------------------</a>
<a name="ln237">//   convertFromHtml</a>
<a name="ln238">//---------------------------------------------------------</a>
<a name="ln239"> </a>
<a name="ln240">QString convertFromHtml(TextBase* t, const QString&amp; ss)</a>
<a name="ln241">      {</a>
<a name="ln242">      QTextDocument doc;</a>
<a name="ln243">      doc.setHtml(ss.trimmed());</a>
<a name="ln244"> </a>
<a name="ln245">      QString s;</a>
<a name="ln246">      qreal size     = t-&gt;size();   // textStyle().size();</a>
<a name="ln247">      QString family = t-&gt;family(); // textStyle().family();</a>
<a name="ln248"> </a>
<a name="ln249">      for (auto b = doc.firstBlock(); b.isValid() ; b = b.next()) {</a>
<a name="ln250">            if (!s.isEmpty())</a>
<a name="ln251">                  s += &quot;\n&quot;;</a>
<a name="ln252">            for (auto it = b.begin(); !it.atEnd(); ++it) {</a>
<a name="ln253">                  QTextFragment f = it.fragment();</a>
<a name="ln254">                  if (f.isValid()) {</a>
<a name="ln255">                        QTextCharFormat tf = f.charFormat();</a>
<a name="ln256">                        QFont font = tf.font();</a>
<a name="ln257">                        qreal htmlSize = font.pointSizeF();</a>
<a name="ln258">                        // html font sizes may have spatium adjustments; need to undo this</a>
<a name="ln259">                        if (t-&gt;sizeIsSpatiumDependent())</a>
<a name="ln260">                              htmlSize *= SPATIUM20 / t-&gt;spatium();</a>
<a name="ln261">                        if (fabs(size - htmlSize) &gt; 0.1) {</a>
<a name="ln262">                              size = htmlSize;</a>
<a name="ln263">                              s += QString(&quot;&lt;font size=\&quot;%1\&quot;/&gt;&quot;).arg(size);</a>
<a name="ln264">                              }</a>
<a name="ln265">                        if (family != font.family()) {</a>
<a name="ln266">                              family = font.family();</a>
<a name="ln267">                              s += QString(&quot;&lt;font face=\&quot;%1\&quot;/&gt;&quot;).arg(family);</a>
<a name="ln268">                              }</a>
<a name="ln269">                        if (font.bold())</a>
<a name="ln270">                              s += &quot;&lt;b&gt;&quot;;</a>
<a name="ln271">                        if (font.italic())</a>
<a name="ln272">                              s += &quot;&lt;i&gt;&quot;;</a>
<a name="ln273">                        if (font.underline())</a>
<a name="ln274">                              s += &quot;&lt;u&gt;&quot;;</a>
<a name="ln275">                        s += f.text().toHtmlEscaped();</a>
<a name="ln276">                        if (font.underline())</a>
<a name="ln277">                              s += &quot;&lt;/u&gt;&quot;;</a>
<a name="ln278">                        if (font.italic())</a>
<a name="ln279">                              s += &quot;&lt;/i&gt;&quot;;</a>
<a name="ln280">                        if (font.bold())</a>
<a name="ln281">                              s += &quot;&lt;/b&gt;&quot;;</a>
<a name="ln282">                        }</a>
<a name="ln283">                  }</a>
<a name="ln284">            }</a>
<a name="ln285"> </a>
<a name="ln286">      s.replace(QChar(0xe10e), QString(&quot;&lt;sym&gt;accidentalNatural&lt;/sym&gt;&quot;));  //natural</a>
<a name="ln287">      s.replace(QChar(0xe10c), QString(&quot;&lt;sym&gt;accidentalSharp&lt;/sym&gt;&quot;));    // sharp</a>
<a name="ln288">      s.replace(QChar(0xe10d), QString(&quot;&lt;sym&gt;accidentalFlat&lt;/sym&gt;&quot;));     // flat</a>
<a name="ln289">      s.replace(QChar(0xe104), QString(&quot;&lt;sym&gt;metNoteHalfUp&lt;/sym&gt;&quot;)),      // note2_Sym</a>
<a name="ln290">      s.replace(QChar(0xe105), QString(&quot;&lt;sym&gt;metNoteQuarterUp&lt;/sym&gt;&quot;));   // note4_Sym</a>
<a name="ln291">      s.replace(QChar(0xe106), QString(&quot;&lt;sym&gt;metNote8thUp&lt;/sym&gt;&quot;));       // note8_Sym</a>
<a name="ln292">      s.replace(QChar(0xe107), QString(&quot;&lt;sym&gt;metNote16thUp&lt;/sym&gt;&quot;));      // note16_Sym</a>
<a name="ln293">      s.replace(QChar(0xe108), QString(&quot;&lt;sym&gt;metNote32ndUp&lt;/sym&gt;&quot;));      // note32_Sym</a>
<a name="ln294">      s.replace(QChar(0xe109), QString(&quot;&lt;sym&gt;metNote64thUp&lt;/sym&gt;&quot;));      // note64_Sym</a>
<a name="ln295">      s.replace(QChar(0xe10a), QString(&quot;&lt;sym&gt;metAugmentationDot&lt;/sym&gt;&quot;)); // dot</a>
<a name="ln296">      s.replace(QChar(0xe10b), QString(&quot;&lt;sym&gt;metAugmentationDot&lt;/sym&gt;&lt;sym&gt;space&lt;/sym&gt;&lt;sym&gt;metAugmentationDot&lt;/sym&gt;&quot;));    // dotdot</a>
<a name="ln297">      s.replace(QChar(0xe167), QString(&quot;&lt;sym&gt;segno&lt;/sym&gt;&quot;));              // segno</a>
<a name="ln298">      s.replace(QChar(0xe168), QString(&quot;&lt;sym&gt;coda&lt;/sym&gt;&quot;));               // coda</a>
<a name="ln299">      s.replace(QChar(0xe169), QString(&quot;&lt;sym&gt;codaSquare&lt;/sym&gt;&quot;));         // varcoda</a>
<a name="ln300">      return s;</a>
<a name="ln301">      }</a>
<a name="ln302"> </a>
<a name="ln303"> </a>
<a name="ln304">//---------------------------------------------------------</a>
<a name="ln305">//   readTextProperties</a>
<a name="ln306">//---------------------------------------------------------</a>
<a name="ln307"> </a>
<a name="ln308">static bool readTextProperties(XmlReader&amp; e, TextBase* t, Element*)</a>
<a name="ln309">      {</a>
<a name="ln310">      const QStringRef&amp; tag(e.name());</a>
<a name="ln311">      if (tag == &quot;style&quot;) {</a>
<a name="ln312">            int i = e.readInt();</a>
<a name="ln313">            Tid ss = Tid::DEFAULT;</a>
<a name="ln314">            switch (i) {</a>
<a name="ln315">                  case 2:  ss = Tid::TITLE;     break;</a>
<a name="ln316">                  case 3:  ss = Tid::SUBTITLE;  break;</a>
<a name="ln317">                  case 4:  ss = Tid::COMPOSER;  break;</a>
<a name="ln318">                  case 5:  ss = Tid::POET;      break;</a>
<a name="ln319"> </a>
<a name="ln320">                  case 6:  ss = Tid::LYRICS_ODD;    break;</a>
<a name="ln321">                  case 7:  ss = Tid::LYRICS_EVEN;    break;</a>
<a name="ln322"> </a>
<a name="ln323">                  case 8:  ss = Tid::FINGERING; break;</a>
<a name="ln324">                  case 9:  ss = Tid::INSTRUMENT_LONG;    break;</a>
<a name="ln325">                  case 10: ss = Tid::INSTRUMENT_SHORT;   break;</a>
<a name="ln326">                  case 11: ss = Tid::INSTRUMENT_EXCERPT; break;</a>
<a name="ln327"> </a>
<a name="ln328">                  case 12: ss = Tid::DYNAMICS;  break;</a>
<a name="ln329">                  case 13: ss = Tid::EXPRESSION;   break;</a>
<a name="ln330">                  case 14: ss = Tid::TEMPO;     break;</a>
<a name="ln331">                  case 15: ss = Tid::METRONOME; break;</a>
<a name="ln332">                  case 16: ss = Tid::FOOTER;    break;  // TextStyleType::COPYRIGHT</a>
<a name="ln333">                  case 17: ss = Tid::MEASURE_NUMBER; break;</a>
<a name="ln334">                  case 18: ss = Tid::FOOTER; break;    // TextStyleType::PAGE_NUMBER_ODD</a>
<a name="ln335">                  case 19: ss = Tid::FOOTER; break;    // TextStyleType::PAGE_NUMBER_EVEN</a>
<a name="ln336">                  case 20: ss = Tid::TRANSLATOR; break;</a>
<a name="ln337">                  case 21: ss = Tid::TUPLET;     break;</a>
<a name="ln338"> </a>
<a name="ln339">                  case 22: ss = Tid::SYSTEM;         break;</a>
<a name="ln340">                  case 23: ss = Tid::STAFF;          break;</a>
<a name="ln341">                  case 24: ss = Tid::HARMONY_A;        break;</a>
<a name="ln342">                  case 25: ss = Tid::REHEARSAL_MARK; break;</a>
<a name="ln343">                  case 26: ss = Tid::REPEAT_LEFT;         break;</a>
<a name="ln344">                  case 27: ss = Tid::VOLTA;          break;</a>
<a name="ln345">                  case 28: ss = Tid::FRAME;          break;</a>
<a name="ln346">                  case 29: ss = Tid::TEXTLINE;       break;</a>
<a name="ln347">                  case 30: ss = Tid::GLISSANDO;      break;</a>
<a name="ln348">                  case 31: ss = Tid::STRING_NUMBER;  break;</a>
<a name="ln349"> </a>
<a name="ln350">                  case 32: ss = Tid::OTTAVA;  break;</a>
<a name="ln351">//??                  case 33: ss = Tid::BENCH;   break;</a>
<a name="ln352">                  case 34: ss = Tid::HEADER;  break;</a>
<a name="ln353">                  case 35: ss = Tid::FOOTER;  break;</a>
<a name="ln354">                  case 0:</a>
<a name="ln355">                  default:</a>
<a name="ln356">                        qDebug(&quot;style %d invalid&quot;, i);</a>
<a name="ln357">                        ss = Tid::DEFAULT;</a>
<a name="ln358">                        break;</a>
<a name="ln359">                  }</a>
<a name="ln360">            t-&gt;initTid(ss);</a>
<a name="ln361">            }</a>
<a name="ln362">      else if (tag == &quot;subtype&quot;)</a>
<a name="ln363">            e.skipCurrentElement();</a>
<a name="ln364">      else if (tag == &quot;html-data&quot;) {</a>
<a name="ln365">            QString ss = e.readXml();</a>
<a name="ln366">            QString s  = convertFromHtml(t, ss);</a>
<a name="ln367">// qDebug(&quot;html-data &lt;%s&gt;&quot;, qPrintable(s));</a>
<a name="ln368">            t-&gt;setXmlText(s);</a>
<a name="ln369">            }</a>
<a name="ln370">      else if (tag == &quot;foregroundColor&quot;)  // same as &quot;color&quot; ?</a>
<a name="ln371">            e.skipCurrentElement();</a>
<a name="ln372">      else if (tag == &quot;frame&quot;) {</a>
<a name="ln373">            t-&gt;setFrameType(e.readBool() ? FrameType::SQUARE : FrameType::NO_FRAME);</a>
<a name="ln374">            t-&gt;setPropertyFlags(Pid::FRAME_TYPE, PropertyFlags::UNSTYLED);</a>
<a name="ln375">            }</a>
<a name="ln376">      else if (tag == &quot;halign&quot;) {</a>
<a name="ln377">            Align align = Align(int(t-&gt;align()) &amp; int(~Align::HMASK));</a>
<a name="ln378">            const QString&amp; val(e.readElementText());</a>
<a name="ln379">            if (val == &quot;center&quot;)</a>
<a name="ln380">                  align = align | Align::HCENTER;</a>
<a name="ln381">            else if (val == &quot;right&quot;)</a>
<a name="ln382">                  align = align | Align::RIGHT;</a>
<a name="ln383">            else if (val == &quot;left&quot;)</a>
<a name="ln384">                  ;</a>
<a name="ln385">            else</a>
<a name="ln386">                  qDebug(&quot;readText: unknown alignment: &lt;%s&gt;&quot;, qPrintable(val));</a>
<a name="ln387">            t-&gt;setAlign(align);</a>
<a name="ln388">            t-&gt;setPropertyFlags(Pid::ALIGN, PropertyFlags::UNSTYLED);</a>
<a name="ln389">            }</a>
<a name="ln390">      else if (tag == &quot;valign&quot;) {</a>
<a name="ln391">            Align align = Align(int(t-&gt;align()) &amp; int(~Align::VMASK));</a>
<a name="ln392">            const QString&amp; val(e.readElementText());</a>
<a name="ln393">            if (val == &quot;bottom&quot;)</a>
<a name="ln394">                  align = align | Align::BOTTOM;</a>
<a name="ln395">            else if (val == &quot;top&quot;)</a>
<a name="ln396">                  ;</a>
<a name="ln397">            else if (val == &quot;vcenter&quot;)</a>
<a name="ln398">                  align = align | Align::VCENTER;</a>
<a name="ln399">            else if (val == &quot;baseline&quot;)</a>
<a name="ln400">                  align = align | Align::BASELINE;</a>
<a name="ln401">            else</a>
<a name="ln402">                  qDebug(&quot;readText: unknown alignment: &lt;%s&gt;&quot;, qPrintable(val));</a>
<a name="ln403">            t-&gt;setAlign(align);</a>
<a name="ln404">            t-&gt;setPropertyFlags(Pid::ALIGN, PropertyFlags::UNSTYLED);</a>
<a name="ln405">            }</a>
<a name="ln406">      else if (tag == &quot;rxoffset&quot;) {       // TODO</a>
<a name="ln407">            e.readElementText();</a>
<a name="ln408">            }</a>
<a name="ln409">      else if (tag == &quot;ryoffset&quot;) {       // TODO</a>
<a name="ln410">            e.readElementText();</a>
<a name="ln411">            }</a>
<a name="ln412">      else if (tag == &quot;yoffset&quot;) {       // TODO</a>
<a name="ln413">            e.readElementText();</a>
<a name="ln414">            }</a>
<a name="ln415">      else if (tag == &quot;systemFlag&quot;) {       // TODO</a>
<a name="ln416">            e.readElementText();</a>
<a name="ln417">            }</a>
<a name="ln418">      else if (!t-&gt;readProperties(e))</a>
<a name="ln419">            return false;</a>
<a name="ln420">      t-&gt;setOffset(QPointF());     // ignore user offsets</a>
<a name="ln421">      t-&gt;setAutoplace(true);</a>
<a name="ln422">      return true;</a>
<a name="ln423">      }</a>
<a name="ln424"> </a>
<a name="ln425">//---------------------------------------------------------</a>
<a name="ln426">//   readText114</a>
<a name="ln427">//---------------------------------------------------------</a>
<a name="ln428"> </a>
<a name="ln429">static void readText114(XmlReader&amp; e, TextBase* t, Element* be)</a>
<a name="ln430">      {</a>
<a name="ln431">      while (e.readNextStartElement()) {</a>
<a name="ln432">            if (!readTextProperties(e, t, be))</a>
<a name="ln433">                  e.unknown();</a>
<a name="ln434">            }</a>
<a name="ln435">      }</a>
<a name="ln436"> </a>
<a name="ln437">//---------------------------------------------------------</a>
<a name="ln438">//   readAccidental</a>
<a name="ln439">//---------------------------------------------------------</a>
<a name="ln440"> </a>
<a name="ln441">static void readAccidental(Accidental* a, XmlReader&amp; e)</a>
<a name="ln442">      {</a>
<a name="ln443">      while (e.readNextStartElement()) {</a>
<a name="ln444">            const QStringRef&amp; tag(e.name());</a>
<a name="ln445">            if (tag == &quot;bracket&quot;) {</a>
<a name="ln446">                  int i = e.readInt();</a>
<a name="ln447">                  if (i == 0 || i == 1)</a>
<a name="ln448">                        a-&gt;setBracket(AccidentalBracket(i));</a>
<a name="ln449">                  }</a>
<a name="ln450">            else if (tag == &quot;subtype&quot;) {</a>
<a name="ln451">                  QString text(e.readElementText());</a>
<a name="ln452">                  bool isInt;</a>
<a name="ln453">                  int i = text.toInt(&amp;isInt);</a>
<a name="ln454">                  if (isInt) {</a>
<a name="ln455">                        a-&gt;setBracket(i &amp; 0x8000 ? AccidentalBracket::PARENTHESIS : AccidentalBracket::BRACKET);</a>
<a name="ln456">                        i &amp;= ~0x8000;</a>
<a name="ln457">                        AccidentalType at;</a>
<a name="ln458">                        switch (i) {</a>
<a name="ln459">                              case 0:</a>
<a name="ln460">                                    at = AccidentalType::NONE;</a>
<a name="ln461">                                    break;</a>
<a name="ln462">                              case 6:</a>
<a name="ln463">                                    a-&gt;setBracket(AccidentalBracket::PARENTHESIS);</a>
<a name="ln464">                                    // fall through</a>
<a name="ln465">                              case 1:</a>
<a name="ln466">                              case 11:</a>
<a name="ln467">                                    at = AccidentalType::SHARP;</a>
<a name="ln468">                                    break;</a>
<a name="ln469">                              case 7:</a>
<a name="ln470">                                    a-&gt;setBracket(AccidentalBracket::PARENTHESIS);</a>
<a name="ln471">                                    // fall through</a>
<a name="ln472">                              case 2:</a>
<a name="ln473">                              case 12:</a>
<a name="ln474">                                    at = AccidentalType::FLAT;</a>
<a name="ln475">                                    break;</a>
<a name="ln476">                              case 8:</a>
<a name="ln477">                                    a-&gt;setBracket(AccidentalBracket::PARENTHESIS);</a>
<a name="ln478">                                    // fall through</a>
<a name="ln479">                              case 3:</a>
<a name="ln480">                              case 13:</a>
<a name="ln481">                                    at = AccidentalType::SHARP2;</a>
<a name="ln482">                                    break;</a>
<a name="ln483">                              case 9:</a>
<a name="ln484">                                    a-&gt;setBracket(AccidentalBracket::PARENTHESIS);</a>
<a name="ln485">                                    // fall through</a>
<a name="ln486">                              case 4:</a>
<a name="ln487">                              case 14:</a>
<a name="ln488">                                    at = AccidentalType::FLAT2;</a>
<a name="ln489">                                    break;</a>
<a name="ln490">                              case 10:</a>
<a name="ln491">                                    a-&gt;setBracket(AccidentalBracket::PARENTHESIS);</a>
<a name="ln492">                                    // fall through</a>
<a name="ln493">                              case 5:</a>
<a name="ln494">                              case 15:</a>
<a name="ln495">                                    at = AccidentalType::NATURAL;</a>
<a name="ln496">                                    break;</a>
<a name="ln497">                              case 16:</a>
<a name="ln498">                                    at = AccidentalType::FLAT_SLASH;</a>
<a name="ln499">                                    break;</a>
<a name="ln500">                              case 17:</a>
<a name="ln501">                                    at = AccidentalType::FLAT_SLASH2;</a>
<a name="ln502">                                    break;</a>
<a name="ln503">                              case 18:</a>
<a name="ln504">                                    at = AccidentalType::MIRRORED_FLAT2;</a>
<a name="ln505">                                    break;</a>
<a name="ln506">                              case 19:</a>
<a name="ln507">                                    at = AccidentalType::MIRRORED_FLAT;</a>
<a name="ln508">                                    break;</a>
<a name="ln509">                              case 20:</a>
<a name="ln510">                                    at = AccidentalType::NONE;//AccidentalType::MIRRORED_FLAT_SLASH;</a>
<a name="ln511">                                    break;</a>
<a name="ln512">                              case 21:</a>
<a name="ln513">                                    at = AccidentalType::NONE;//AccidentalType::FLAT_FLAT_SLASH;</a>
<a name="ln514">                                    break;</a>
<a name="ln515">                              case 22:</a>
<a name="ln516">                                    at = AccidentalType::SHARP_SLASH;</a>
<a name="ln517">                                    break;</a>
<a name="ln518">                              case 23:</a>
<a name="ln519">                                    at = AccidentalType::SHARP_SLASH2;</a>
<a name="ln520">                                    break;</a>
<a name="ln521">                              case 24:</a>
<a name="ln522">                                    at = AccidentalType::SHARP_SLASH3;</a>
<a name="ln523">                                    break;</a>
<a name="ln524">                              case 25:</a>
<a name="ln525">                                    at = AccidentalType::SHARP_SLASH4;</a>
<a name="ln526">                                    break;</a>
<a name="ln527">                              case 26:</a>
<a name="ln528">                                    at = AccidentalType::SHARP_ARROW_UP;</a>
<a name="ln529">                                    break;</a>
<a name="ln530">                              case 27:</a>
<a name="ln531">                                    at = AccidentalType::SHARP_ARROW_DOWN;</a>
<a name="ln532">                                    break;</a>
<a name="ln533">                              case 28:</a>
<a name="ln534">                                    at = AccidentalType::NONE;//AccidentalType::SHARP_ARROW_BOTH;</a>
<a name="ln535">                                    break;</a>
<a name="ln536">                              case 29:</a>
<a name="ln537">                                    at = AccidentalType::FLAT_ARROW_UP;</a>
<a name="ln538">                                    break;</a>
<a name="ln539">                              case 30:</a>
<a name="ln540">                                    at = AccidentalType::FLAT_ARROW_DOWN;</a>
<a name="ln541">                                    break;</a>
<a name="ln542">                              case 31:</a>
<a name="ln543">                                    at = AccidentalType::NONE;//AccidentalType::FLAT_ARROW_BOTH;</a>
<a name="ln544">                                    break;</a>
<a name="ln545">                              case 32:</a>
<a name="ln546">                                    at = AccidentalType::NATURAL_ARROW_UP;</a>
<a name="ln547">                                    break;</a>
<a name="ln548">                              case 33:</a>
<a name="ln549">                                    at = AccidentalType::NATURAL_ARROW_DOWN;</a>
<a name="ln550">                                    break;</a>
<a name="ln551">                              case 34:</a>
<a name="ln552">                                    at = AccidentalType::NONE;//AccidentalType::NATURAL_ARROW_BOTH;</a>
<a name="ln553">                                    break;</a>
<a name="ln554">                              default:</a>
<a name="ln555">                                    at = AccidentalType::NONE;</a>
<a name="ln556">                                    break;</a>
<a name="ln557">                              }</a>
<a name="ln558">                        a-&gt;setAccidentalType(at);</a>
<a name="ln559">                        }</a>
<a name="ln560">                  else {</a>
<a name="ln561">                        const static std::map&lt;QString, AccidentalType&gt; accMap = {</a>
<a name="ln562">                           {&quot;none&quot;, AccidentalType::NONE}, {&quot;sharp&quot;, AccidentalType::SHARP},</a>
<a name="ln563">                           {&quot;flat&quot;, AccidentalType::FLAT}, {&quot;natural&quot;, AccidentalType::NATURAL},</a>
<a name="ln564">                           {&quot;double sharp&quot;, AccidentalType::SHARP2}, {&quot;double flat&quot;, AccidentalType::FLAT2},</a>
<a name="ln565">                           {&quot;flat-slash&quot;, AccidentalType::FLAT_SLASH}, {&quot;flat-slash2&quot;, AccidentalType::FLAT_SLASH2},</a>
<a name="ln566">                           {&quot;mirrored-flat2&quot;, AccidentalType::MIRRORED_FLAT2}, {&quot;mirrored-flat&quot;, AccidentalType::MIRRORED_FLAT},</a>
<a name="ln567">                           {&quot;sharp-slash&quot;, AccidentalType::SHARP_SLASH}, {&quot;sharp-slash2&quot;, AccidentalType::SHARP_SLASH2},</a>
<a name="ln568">                           {&quot;sharp-slash3&quot;, AccidentalType::SHARP_SLASH3}, {&quot;sharp-slash4&quot;, AccidentalType::SHARP_SLASH4},</a>
<a name="ln569">                           {&quot;sharp arrow up&quot;, AccidentalType::SHARP_ARROW_UP}, {&quot;sharp arrow down&quot;, AccidentalType::SHARP_ARROW_DOWN},</a>
<a name="ln570">                           {&quot;flat arrow up&quot;, AccidentalType::FLAT_ARROW_UP}, {&quot;flat arrow down&quot;, AccidentalType::FLAT_ARROW_DOWN},</a>
<a name="ln571">                           {&quot;natural arrow up&quot;, AccidentalType::NATURAL_ARROW_UP}, {&quot;natural arrow down&quot;, AccidentalType::NATURAL_ARROW_DOWN},</a>
<a name="ln572">                           {&quot;sori&quot;, AccidentalType::SORI}, {&quot;koron&quot;, AccidentalType::KORON}</a>
<a name="ln573">                        };</a>
<a name="ln574">                        auto it = accMap.find(text);</a>
<a name="ln575">                        if (it == accMap.end()) {</a>
<a name="ln576">                              qDebug(&quot;invalid type %s&quot;, qPrintable(text));</a>
<a name="ln577">                              a-&gt;setAccidentalType(AccidentalType::NONE);</a>
<a name="ln578">                              }</a>
<a name="ln579">                        else</a>
<a name="ln580">                              a-&gt;setAccidentalType(it-&gt;second);</a>
<a name="ln581">                        }</a>
<a name="ln582">                  }</a>
<a name="ln583">            else if (tag == &quot;role&quot;) {</a>
<a name="ln584">                  AccidentalRole r = AccidentalRole(e.readInt());</a>
<a name="ln585">                  if (r == AccidentalRole::AUTO || r == AccidentalRole::USER)</a>
<a name="ln586">                        a-&gt;setRole(r);</a>
<a name="ln587">                  }</a>
<a name="ln588">            else if (tag == &quot;small&quot;)</a>
<a name="ln589">                  a-&gt;setSmall(e.readInt());</a>
<a name="ln590">            else if (tag == &quot;offset&quot;)</a>
<a name="ln591">                  e.skipCurrentElement(); // ignore manual layout in older scores</a>
<a name="ln592">            else if (a-&gt;Element::readProperties(e))</a>
<a name="ln593">                  ;</a>
<a name="ln594">            else</a>
<a name="ln595">                  e.unknown();</a>
<a name="ln596">            }</a>
<a name="ln597">      }</a>
<a name="ln598"> </a>
<a name="ln599">//---------------------------------------------------------</a>
<a name="ln600">//   convertHeadGroup</a>
<a name="ln601">//---------------------------------------------------------</a>
<a name="ln602"> </a>
<a name="ln603">static NoteHead::Group convertHeadGroup(int i)</a>
<a name="ln604">      {</a>
<a name="ln605">      NoteHead::Group val;</a>
<a name="ln606">      switch (i) {</a>
<a name="ln607">            case 1:</a>
<a name="ln608">                  val = NoteHead::Group::HEAD_CROSS;</a>
<a name="ln609">                  break;</a>
<a name="ln610">            case 2:</a>
<a name="ln611">                  val = NoteHead::Group::HEAD_DIAMOND;</a>
<a name="ln612">                  break;</a>
<a name="ln613">            case 3:</a>
<a name="ln614">                  val = NoteHead::Group::HEAD_TRIANGLE_DOWN;</a>
<a name="ln615">                  break;</a>
<a name="ln616">            case 4:</a>
<a name="ln617">                  val = NoteHead::Group::HEAD_MI;</a>
<a name="ln618">                  break;</a>
<a name="ln619">            case 5:</a>
<a name="ln620">                  val = NoteHead::Group::HEAD_SLASH;</a>
<a name="ln621">                  break;</a>
<a name="ln622">            case 6:</a>
<a name="ln623">                  val = NoteHead::Group::HEAD_XCIRCLE;</a>
<a name="ln624">                  break;</a>
<a name="ln625">            case 7:</a>
<a name="ln626">                  val = NoteHead::Group::HEAD_DO;</a>
<a name="ln627">                  break;</a>
<a name="ln628">            case 8:</a>
<a name="ln629">                  val = NoteHead::Group::HEAD_RE;</a>
<a name="ln630">                  break;</a>
<a name="ln631">            case 9:</a>
<a name="ln632">                  val = NoteHead::Group::HEAD_FA;</a>
<a name="ln633">                  break;</a>
<a name="ln634">            case 10:</a>
<a name="ln635">                  val = NoteHead::Group::HEAD_LA;</a>
<a name="ln636">                  break;</a>
<a name="ln637">            case 11:</a>
<a name="ln638">                  val = NoteHead::Group::HEAD_TI;</a>
<a name="ln639">                  break;</a>
<a name="ln640">            case 12:</a>
<a name="ln641">                  val = NoteHead::Group::HEAD_SOL;</a>
<a name="ln642">                  break;</a>
<a name="ln643">            case 13:</a>
<a name="ln644">                  val = NoteHead::Group::HEAD_BREVIS_ALT;</a>
<a name="ln645">                  break;</a>
<a name="ln646">            default:</a>
<a name="ln647">                  val = NoteHead::Group::HEAD_NORMAL;</a>
<a name="ln648">            }</a>
<a name="ln649">      return val;</a>
<a name="ln650">      }</a>
<a name="ln651"> </a>
<a name="ln652"> </a>
<a name="ln653">//---------------------------------------------------------</a>
<a name="ln654">//   readFingering114</a>
<a name="ln655">//---------------------------------------------------------</a>
<a name="ln656"> </a>
<a name="ln657">static void readFingering114(XmlReader&amp; e, Fingering* fing)</a>
<a name="ln658">      {</a>
<a name="ln659">      bool isStringNumber = false;</a>
<a name="ln660">      while (e.readNextStartElement()) {</a>
<a name="ln661">            const QStringRef&amp; tag(e.name());</a>
<a name="ln662"> </a>
<a name="ln663">            if (tag == &quot;html-data&quot;) {</a>
<a name="ln664">                  auto htmlDdata = QTextDocumentFragment::fromHtml(e.readXml()).toPlainText();</a>
<a name="ln665">                  htmlDdata.replace(&quot; &quot;, &quot;&quot;);</a>
<a name="ln666">                  fing-&gt;setPlainText(htmlDdata);</a>
<a name="ln667">                  }</a>
<a name="ln668">            else if (tag == &quot;subtype&quot;) {</a>
<a name="ln669">                  auto subtype = e.readElementText();</a>
<a name="ln670">                  if (subtype == &quot;StringNumber&quot;) {</a>
<a name="ln671">                        isStringNumber = true;</a>
<a name="ln672">                        fing-&gt;setProperty(Pid::SUB_STYLE, QVariant(10));</a>
<a name="ln673">                        fing-&gt;setPropertyFlags(Pid::SUB_STYLE, PropertyFlags::UNSTYLED);</a>
<a name="ln674">                        }</a>
<a name="ln675">                  }</a>
<a name="ln676">            else if (tag == &quot;frame&quot;) {</a>
<a name="ln677">                  auto frame = e.readInt();</a>
<a name="ln678">                  if (frame)</a>
<a name="ln679">                        if (isStringNumber) //default value is circle for stringnumber, square is set in tag circle</a>
<a name="ln680">                              fing-&gt;setFrameType(FrameType::CIRCLE);</a>
<a name="ln681">                        else //default value is square for stringnumber, circle is set in tag circle</a>
<a name="ln682">                              fing-&gt;setFrameType(FrameType::SQUARE);</a>
<a name="ln683">                  else</a>
<a name="ln684">                        fing-&gt;setFrameType(FrameType::NO_FRAME);</a>
<a name="ln685">                  }</a>
<a name="ln686">            else if (tag == &quot;circle&quot;) {</a>
<a name="ln687">                  auto circle = e.readInt();</a>
<a name="ln688">                  if (circle)</a>
<a name="ln689">                        fing-&gt;setFrameType(FrameType::CIRCLE);</a>
<a name="ln690">                  else</a>
<a name="ln691">                        fing-&gt;setFrameType(FrameType::SQUARE);</a>
<a name="ln692">                  }</a>
<a name="ln693">            else {</a>
<a name="ln694">                  e.skipCurrentElement();</a>
<a name="ln695">                  }</a>
<a name="ln696">            }</a>
<a name="ln697">      }</a>
<a name="ln698"> </a>
<a name="ln699">//---------------------------------------------------------</a>
<a name="ln700">//   readNote</a>
<a name="ln701">//---------------------------------------------------------</a>
<a name="ln702"> </a>
<a name="ln703">static void readNote(Note* note, XmlReader&amp; e)</a>
<a name="ln704">      {</a>
<a name="ln705">      e.hasAccidental = false;                     // used for userAccidental backward compatibility</a>
<a name="ln706"> </a>
<a name="ln707">      note-&gt;setTpc1(Tpc::TPC_INVALID);</a>
<a name="ln708">      note-&gt;setTpc2(Tpc::TPC_INVALID);</a>
<a name="ln709"> </a>
<a name="ln710">      if (e.hasAttribute(&quot;pitch&quot;))                   // obsolete</a>
<a name="ln711">            note-&gt;setPitch(e.intAttribute(&quot;pitch&quot;));</a>
<a name="ln712">      if (e.hasAttribute(&quot;tpc&quot;))                     // obsolete</a>
<a name="ln713">            note-&gt;setTpc1(e.intAttribute(&quot;tpc&quot;));</a>
<a name="ln714"> </a>
<a name="ln715">      while (e.readNextStartElement()) {</a>
<a name="ln716">            const QStringRef&amp; tag(e.name());</a>
<a name="ln717">            if (tag == &quot;Accidental&quot;) {</a>
<a name="ln718">                  // on older scores, a note could have both a &lt;userAccidental&gt; tag and an &lt;Accidental&gt; tag</a>
<a name="ln719">                  // if a userAccidental has some other property set (like for instance offset)</a>
<a name="ln720">                  Accidental* a;</a>
<a name="ln721">                  if (e.hasAccidental)            // if the other tag has already been read,</a>
<a name="ln722">                        a = note-&gt;accidental();        // re-use the accidental it constructed</a>
<a name="ln723">                  else</a>
<a name="ln724">                        a = new Accidental(note-&gt;score());</a>
<a name="ln725">                  // the accidental needs to know the properties of the</a>
<a name="ln726">                  // track it belongs to (??)</a>
<a name="ln727">                  a-&gt;setTrack(note-&gt;track());</a>
<a name="ln728">                  readAccidental(a, e);</a>
<a name="ln729">                  if (!e.hasAccidental)          // only the new accidental, if it has been added previously</a>
<a name="ln730">                        note-&gt;add(a);</a>
<a name="ln731">                  e.hasAccidental = true;   // we now have an accidental</a>
<a name="ln732">                  }</a>
<a name="ln733">            else if (tag == &quot;Text&quot;) {</a>
<a name="ln734">                  Fingering* f = new Fingering(note-&gt;score());</a>
<a name="ln735">                  readFingering114(e, f);</a>
<a name="ln736">                  note-&gt;add(f);</a>
<a name="ln737">                  }</a>
<a name="ln738">            else if (tag == &quot;onTimeType&quot;) {</a>
<a name="ln739">                  if (e.readElementText() == &quot;offset&quot;)</a>
<a name="ln740">                        note-&gt;setOnTimeType(2);</a>
<a name="ln741">                  else</a>
<a name="ln742">                        note-&gt;setOnTimeType(1);</a>
<a name="ln743">                  }</a>
<a name="ln744">            else if (tag == &quot;offTimeType&quot;) {</a>
<a name="ln745">                  if (e.readElementText() == &quot;offset&quot;)</a>
<a name="ln746">                        note-&gt;setOffTimeType(2);</a>
<a name="ln747">                  else</a>
<a name="ln748">                        note-&gt;setOffTimeType(1);</a>
<a name="ln749">                  }</a>
<a name="ln750">            else if (tag == &quot;onTimeOffset&quot;) {</a>
<a name="ln751">                  if (note-&gt;onTimeType() == 1)</a>
<a name="ln752">                        note-&gt;setOnTimeOffset(e.readInt() * 1000 / note-&gt;chord()-&gt;actualTicks().ticks());</a>
<a name="ln753">                  else</a>
<a name="ln754">                        note-&gt;setOnTimeOffset(e.readInt() * 10);</a>
<a name="ln755">                  }</a>
<a name="ln756">            else if (tag == &quot;offTimeOffset&quot;) {</a>
<a name="ln757">                  if (note-&gt;offTimeType() == 1)</a>
<a name="ln758">                        note-&gt;setOffTimeOffset(1000 + (e.readInt() * 1000 / note-&gt;chord()-&gt;actualTicks().ticks()));</a>
<a name="ln759">                  else</a>
<a name="ln760">                        note-&gt;setOffTimeOffset(1000 + (e.readInt() * 10));</a>
<a name="ln761">                  }</a>
<a name="ln762">            else if (tag == &quot;userAccidental&quot;) {</a>
<a name="ln763">                  QString val(e.readElementText());</a>
<a name="ln764">                  bool ok;</a>
<a name="ln765">                  int k = val.toInt(&amp;ok);</a>
<a name="ln766">                  if (ok) {</a>
<a name="ln767">                        // on older scores, a note could have both a &lt;userAccidental&gt; tag and an &lt;Accidental&gt; tag</a>
<a name="ln768">                        // if a userAccidental has some other property set (like for instance offset)</a>
<a name="ln769">                        // only construct a new accidental, if the other tag has not been read yet</a>
<a name="ln770">                        // (&lt;userAccidental&gt; tag is only used in older scores: no need to check the score mscVersion)</a>
<a name="ln771">                        if (!e.hasAccidental) {</a>
<a name="ln772">                              Accidental* a = new Accidental(note-&gt;score());</a>
<a name="ln773">                              note-&gt;add(a);</a>
<a name="ln774">                              }</a>
<a name="ln775">                        // TODO: for backward compatibility</a>
<a name="ln776">                        bool bracket = k &amp; 0x8000;</a>
<a name="ln777">                        k &amp;= 0xfff;</a>
<a name="ln778">                        AccidentalType at = AccidentalType::NONE;</a>
<a name="ln779">                        switch(k) {</a>
<a name="ln780">                              case 0: at = AccidentalType::NONE; break;</a>
<a name="ln781">                              case 1: at = AccidentalType::SHARP; break;</a>
<a name="ln782">                              case 2: at = AccidentalType::FLAT; break;</a>
<a name="ln783">                              case 3: at = AccidentalType::SHARP2; break;</a>
<a name="ln784">                              case 4: at = AccidentalType::FLAT2; break;</a>
<a name="ln785">                              case 5: at = AccidentalType::NATURAL; break;</a>
<a name="ln786"> </a>
<a name="ln787">                              case 6: at = AccidentalType::FLAT_SLASH; break;</a>
<a name="ln788">                              case 7: at = AccidentalType::FLAT_SLASH2; break;</a>
<a name="ln789">                              case 8: at = AccidentalType::MIRRORED_FLAT2; break;</a>
<a name="ln790">                              case 9: at = AccidentalType::MIRRORED_FLAT; break;</a>
<a name="ln791">                              case 10: at = AccidentalType::NONE; break; // AccidentalType::MIRRORED_FLAT_SLASH</a>
<a name="ln792">                              case 11: at = AccidentalType::NONE; break; // AccidentalType::FLAT_FLAT_SLASH</a>
<a name="ln793"> </a>
<a name="ln794">                              case 12: at = AccidentalType::SHARP_SLASH; break;</a>
<a name="ln795">                              case 13: at = AccidentalType::SHARP_SLASH2; break;</a>
<a name="ln796">                              case 14: at = AccidentalType::SHARP_SLASH3; break;</a>
<a name="ln797">                              case 15: at = AccidentalType::SHARP_SLASH4; break;</a>
<a name="ln798"> </a>
<a name="ln799">                              case 16: at = AccidentalType::SHARP_ARROW_UP; break;</a>
<a name="ln800">                              case 17: at = AccidentalType::SHARP_ARROW_DOWN; break;</a>
<a name="ln801">                              case 18: at = AccidentalType::NONE; break; // AccidentalType::SHARP_ARROW_BOTH</a>
<a name="ln802">                              case 19: at = AccidentalType::FLAT_ARROW_UP; break;</a>
<a name="ln803">                              case 20: at = AccidentalType::FLAT_ARROW_DOWN; break;</a>
<a name="ln804">                              case 21: at = AccidentalType::NONE; break; // AccidentalType::FLAT_ARROW_BOTH</a>
<a name="ln805">                              case 22: at = AccidentalType::NATURAL_ARROW_UP; break;</a>
<a name="ln806">                              case 23: at = AccidentalType::NATURAL_ARROW_DOWN; break;</a>
<a name="ln807">                              case 24: at = AccidentalType::NONE; break; // AccidentalType::NATURAL_ARROW_BOTH</a>
<a name="ln808">                              case 25: at = AccidentalType::SORI; break;</a>
<a name="ln809">                              case 26: at = AccidentalType::KORON; break;</a>
<a name="ln810">                              }</a>
<a name="ln811">                        note-&gt;accidental()-&gt;setAccidentalType(at);</a>
<a name="ln812"> </a>
<a name="ln813">                        note-&gt;accidental()-&gt;setBracket(AccidentalBracket(bracket));</a>
<a name="ln814"> </a>
<a name="ln815">                        note-&gt;accidental()-&gt;setRole(AccidentalRole::USER);</a>
<a name="ln816">                        e.hasAccidental = true;   // we now have an accidental</a>
<a name="ln817">                        }</a>
<a name="ln818">                  }</a>
<a name="ln819">            else if (tag == &quot;offset&quot;)</a>
<a name="ln820">                  e.skipCurrentElement(); // ignore manual layout in older scores</a>
<a name="ln821">            else if (tag == &quot;move&quot;)</a>
<a name="ln822">                  note-&gt;chord()-&gt;setStaffMove(e.readInt());</a>
<a name="ln823">            else if (tag == &quot;head&quot;) {</a>
<a name="ln824">                  int i = e.readInt();</a>
<a name="ln825">                  NoteHead::Group val = convertHeadGroup(i);</a>
<a name="ln826">                  note-&gt;setHeadGroup(val);</a>
<a name="ln827">                  }</a>
<a name="ln828">            else if (tag == &quot;headType&quot;) {</a>
<a name="ln829">                  int i = e.readInt();</a>
<a name="ln830">                  NoteHead::Type val;</a>
<a name="ln831">                  switch (i) {</a>
<a name="ln832">                        case 1:</a>
<a name="ln833">                              val = NoteHead::Type::HEAD_WHOLE;</a>
<a name="ln834">                              break;</a>
<a name="ln835">                        case 2:</a>
<a name="ln836">                              val = NoteHead::Type::HEAD_HALF;</a>
<a name="ln837">                              break;</a>
<a name="ln838">                        case 3:</a>
<a name="ln839">                              val = NoteHead::Type::HEAD_QUARTER;</a>
<a name="ln840">                              break;</a>
<a name="ln841">                        case 4:</a>
<a name="ln842">                              val = NoteHead::Type::HEAD_BREVIS;</a>
<a name="ln843">                              break;</a>
<a name="ln844">                        default:</a>
<a name="ln845">                              val = NoteHead::Type::HEAD_AUTO;</a>
<a name="ln846">                        }</a>
<a name="ln847">                  note-&gt;setHeadType(val);</a>
<a name="ln848">                  }</a>
<a name="ln849">            else if (readNoteProperties206(note, e))</a>
<a name="ln850">                  ;</a>
<a name="ln851">            else</a>
<a name="ln852">                  e.unknown();</a>
<a name="ln853">            }</a>
<a name="ln854">      // ensure sane values:</a>
<a name="ln855">      note-&gt;setPitch(limit(note-&gt;pitch(), 0, 127));</a>
<a name="ln856"> </a>
<a name="ln857">      if (note-&gt;concertPitch())</a>
<a name="ln858">            note-&gt;setTpc2(Tpc::TPC_INVALID);</a>
<a name="ln859">      else {</a>
<a name="ln860">            note-&gt;setPitch(note-&gt;pitch() + note-&gt;transposition());</a>
<a name="ln861">            note-&gt;setTpc2(note-&gt;tpc1());</a>
<a name="ln862">            note-&gt;setTpc1(Tpc::TPC_INVALID);</a>
<a name="ln863">            }</a>
<a name="ln864">      if (!tpcIsValid(note-&gt;tpc1()) &amp;&amp; !tpcIsValid(note-&gt;tpc2())) {</a>
<a name="ln865">            Key key = (note-&gt;staff() &amp;&amp; note-&gt;chord()) ? note-&gt;staff()-&gt;key(note-&gt;chord()-&gt;tick()) : Key::C;</a>
<a name="ln866">            int tpc = pitch2tpc(note-&gt;pitch(), key, Prefer::NEAREST);</a>
<a name="ln867">            if (note-&gt;concertPitch())</a>
<a name="ln868">                  note-&gt;setTpc1(tpc);</a>
<a name="ln869">            else</a>
<a name="ln870">                  note-&gt;setTpc2(tpc);</a>
<a name="ln871">            }</a>
<a name="ln872">      if (!(tpcIsValid(note-&gt;tpc1()) &amp;&amp; tpcIsValid(note-&gt;tpc2()))) {</a>
<a name="ln873">            Fraction tick = note-&gt;chord() ? note-&gt;chord()-&gt;tick() : Fraction(-1,1);</a>
<a name="ln874">            Interval v = note-&gt;staff() ? note-&gt;part()-&gt;instrument(tick)-&gt;transpose() : Interval();</a>
<a name="ln875">            if (tpcIsValid(note-&gt;tpc1())) {</a>
<a name="ln876">                  v.flip();</a>
<a name="ln877">                  if (v.isZero())</a>
<a name="ln878">                        note-&gt;setTpc2(note-&gt;tpc1());</a>
<a name="ln879">                  else</a>
<a name="ln880">                        note-&gt;setTpc2(Ms::transposeTpc(note-&gt;tpc1(), v, true));</a>
<a name="ln881">                  }</a>
<a name="ln882">            else {</a>
<a name="ln883">                  if (v.isZero())</a>
<a name="ln884">                        note-&gt;setTpc1(note-&gt;tpc2());</a>
<a name="ln885">                  else</a>
<a name="ln886">                        note-&gt;setTpc1(Ms::transposeTpc(note-&gt;tpc2(), v, true));</a>
<a name="ln887">                  }</a>
<a name="ln888">            }</a>
<a name="ln889"> </a>
<a name="ln890">      // check consistency of pitch, tpc1, tpc2, and transposition</a>
<a name="ln891">      // see note in InstrumentChange::read() about a known case of tpc corruption produced in 2.0.x</a>
<a name="ln892">      // but since there are other causes of tpc corruption (eg, https://musescore.org/en/node/74746)</a>
<a name="ln893">      // including perhaps some we don't know about yet,</a>
<a name="ln894">      // we will attempt to fix some problems here regardless of version</a>
<a name="ln895"> </a>
<a name="ln896">      if (!e.pasteMode() &amp;&amp; !MScore::testMode) {</a>
<a name="ln897">            int tpc1Pitch = (tpc2pitch(note-&gt;tpc1()) + 12) % 12;</a>
<a name="ln898">            int tpc2Pitch = (tpc2pitch(note-&gt;tpc2()) + 12) % 12;</a>
<a name="ln899">            int concertPitch = note-&gt;pitch() % 12;</a>
<a name="ln900">            if (tpc1Pitch != concertPitch) {</a>
<a name="ln901">                  qDebug(&quot;bad tpc1 - concertPitch = %d, tpc1 = %d&quot;, concertPitch, tpc1Pitch);</a>
<a name="ln902">                  note-&gt;setPitch(note-&gt;pitch() + tpc1Pitch - concertPitch);</a>
<a name="ln903">                  }</a>
<a name="ln904">            Interval v = note-&gt;staff()-&gt;part()-&gt;instrument(e.tick())-&gt;transpose();</a>
<a name="ln905">            int transposedPitch = (note-&gt;pitch() - v.chromatic) % 12;</a>
<a name="ln906">            if (tpc2Pitch != transposedPitch) {</a>
<a name="ln907">                  qDebug(&quot;bad tpc2 - transposedPitch = %d, tpc2 = %d&quot;, transposedPitch, tpc2Pitch);</a>
<a name="ln908">                  // just in case the staff transposition info is not reliable here,</a>
<a name="ln909">                  v.flip();</a>
<a name="ln910">                  note-&gt;setTpc2(Ms::transposeTpc(note-&gt;tpc1(), v, true));</a>
<a name="ln911">                  }</a>
<a name="ln912">            }</a>
<a name="ln913">      }</a>
<a name="ln914"> </a>
<a name="ln915">//---------------------------------------------------------</a>
<a name="ln916">//   readClefType</a>
<a name="ln917">//---------------------------------------------------------</a>
<a name="ln918"> </a>
<a name="ln919">static ClefType readClefType(const QString&amp; s)</a>
<a name="ln920">      {</a>
<a name="ln921">      ClefType ct = ClefType::G;</a>
<a name="ln922">      bool ok;</a>
<a name="ln923">      int i = s.toInt(&amp;ok);</a>
<a name="ln924">      if (ok) {</a>
<a name="ln925">            // convert obsolete old coding</a>
<a name="ln926">            switch (i) {</a>
<a name="ln927">                  default:</a>
<a name="ln928">                  case  0: ct = ClefType::G; break;</a>
<a name="ln929">                  case  1: ct = ClefType::G8_VA; break;</a>
<a name="ln930">                  case  2: ct = ClefType::G15_MA; break;</a>
<a name="ln931">                  case  3: ct = ClefType::G8_VB; break;</a>
<a name="ln932">                  case  4: ct = ClefType::F; break;</a>
<a name="ln933">                  case  5: ct = ClefType::F8_VB; break;</a>
<a name="ln934">                  case  6: ct = ClefType::F15_MB; break;</a>
<a name="ln935">                  case  7: ct = ClefType::F_B; break;</a>
<a name="ln936">                  case  8: ct = ClefType::F_C; break;</a>
<a name="ln937">                  case  9: ct = ClefType::C1; break;</a>
<a name="ln938">                  case 10: ct = ClefType::C2; break;</a>
<a name="ln939">                  case 11: ct = ClefType::C3; break;</a>
<a name="ln940">                  case 12: ct = ClefType::C4; break;</a>
<a name="ln941">                  case 13: ct = ClefType::TAB; break;</a>
<a name="ln942">                  case 14: ct = ClefType::PERC; break;</a>
<a name="ln943">                  case 15: ct = ClefType::C5; break;</a>
<a name="ln944">                  case 16: ct = ClefType::G_1; break;</a>
<a name="ln945">                  case 17: ct = ClefType::F_8VA; break;</a>
<a name="ln946">                  case 18: ct = ClefType::F_15MA; break;</a>
<a name="ln947">                  case 19: ct = ClefType::PERC; break;      // PERC2 no longer supported</a>
<a name="ln948">                  case 20: ct = ClefType::TAB_SERIF; break;</a>
<a name="ln949">                  }</a>
<a name="ln950">            }</a>
<a name="ln951">      return ct;</a>
<a name="ln952">      }</a>
<a name="ln953"> </a>
<a name="ln954">//---------------------------------------------------------</a>
<a name="ln955">//   readClef</a>
<a name="ln956">//---------------------------------------------------------</a>
<a name="ln957"> </a>
<a name="ln958">static void readClef(Clef* clef, XmlReader&amp; e)</a>
<a name="ln959">      {</a>
<a name="ln960">      while (e.readNextStartElement()) {</a>
<a name="ln961">            const QStringRef&amp; tag(e.name());</a>
<a name="ln962">            if (tag == &quot;subtype&quot;)</a>
<a name="ln963">                  clef-&gt;setClefType(readClefType(e.readElementText()));</a>
<a name="ln964">            else if (!clef-&gt;readProperties(e))</a>
<a name="ln965">                  e.unknown();</a>
<a name="ln966">            }</a>
<a name="ln967">      if (clef-&gt;clefType() == ClefType::INVALID)</a>
<a name="ln968">            clef-&gt;setClefType(ClefType::G);</a>
<a name="ln969">      }</a>
<a name="ln970"> </a>
<a name="ln971">//---------------------------------------------------------</a>
<a name="ln972">//   readTuplet</a>
<a name="ln973">//---------------------------------------------------------</a>
<a name="ln974"> </a>
<a name="ln975">static void readTuplet(Tuplet* tuplet, XmlReader&amp; e)</a>
<a name="ln976">      {</a>
<a name="ln977">      int bl = -1;</a>
<a name="ln978">      tuplet-&gt;setId(e.intAttribute(&quot;id&quot;, 0));</a>
<a name="ln979"> </a>
<a name="ln980">      while (e.readNextStartElement()) {</a>
<a name="ln981">            const QStringRef&amp; tag(e.name());</a>
<a name="ln982">            if (tag == &quot;subtype&quot;)    // obsolete</a>
<a name="ln983">                  e.skipCurrentElement();</a>
<a name="ln984">            else if (tag == &quot;hasNumber&quot;)  // obsolete even in 1.3</a>
<a name="ln985">                  tuplet-&gt;setNumberType(e.readInt() ? TupletNumberType::SHOW_NUMBER : TupletNumberType::NO_TEXT);</a>
<a name="ln986">            else if (tag == &quot;hasLine&quot;) {  // obsolete even in 1.3</a>
<a name="ln987">                  tuplet-&gt;setHasBracket(e.readInt());</a>
<a name="ln988">                  tuplet-&gt;setBracketType(TupletBracketType::AUTO_BRACKET);</a>
<a name="ln989">                  }</a>
<a name="ln990">            else if (tag == &quot;baseLen&quot;)    // obsolete even in 1.3</a>
<a name="ln991">                  bl = e.readInt();</a>
<a name="ln992">            else if (tag == &quot;tick&quot;)</a>
<a name="ln993">                  tuplet-&gt;setTick(Fraction::fromTicks(e.readInt()));</a>
<a name="ln994">            else if (!readTupletProperties206(e, tuplet))</a>
<a name="ln995">                  e.unknown();</a>
<a name="ln996">            }</a>
<a name="ln997">      Fraction r = (tuplet-&gt;ratio() == Fraction(1,1)) ? tuplet-&gt;ratio() : tuplet-&gt;ratio().reduced();</a>
<a name="ln998">      // this may be wrong, but at this stage it is kept for compatibility. It will be corrected afterwards</a>
<a name="ln999">      // during &quot;sanitize&quot; step</a>
<a name="ln1000">      Fraction f(r.denominator(), tuplet-&gt;baseLen().fraction().denominator());</a>
<a name="ln1001">      tuplet-&gt;setTicks(f.reduced());</a>
<a name="ln1002">      if (bl != -1) {         // obsolete, even in 1.3</a>
<a name="ln1003">            TDuration d;</a>
<a name="ln1004">            d.setVal(bl);</a>
<a name="ln1005">            tuplet-&gt;setBaseLen(d);</a>
<a name="ln1006">            d.setVal(bl * tuplet-&gt;ratio().denominator());</a>
<a name="ln1007">            tuplet-&gt;setTicks(d.fraction());</a>
<a name="ln1008">            }</a>
<a name="ln1009">      }</a>
<a name="ln1010"> </a>
<a name="ln1011">//---------------------------------------------------------</a>
<a name="ln1012">//   readTremolo</a>
<a name="ln1013">//---------------------------------------------------------</a>
<a name="ln1014"> </a>
<a name="ln1015">static void readTremolo(Tremolo* tremolo, XmlReader&amp; e)</a>
<a name="ln1016">      {</a>
<a name="ln1017">      enum class OldTremoloType : char {</a>
<a name="ln1018">            OLD_R8 = 0,</a>
<a name="ln1019">            OLD_R16,</a>
<a name="ln1020">            OLD_R32,</a>
<a name="ln1021">            OLD_C8,</a>
<a name="ln1022">            OLD_C16,</a>
<a name="ln1023">            OLD_C32</a>
<a name="ln1024">            };</a>
<a name="ln1025">      while (e.readNextStartElement()) {</a>
<a name="ln1026">            if (e.name() == &quot;subtype&quot;) {</a>
<a name="ln1027">                  OldTremoloType sti = OldTremoloType(e.readElementText().toInt());</a>
<a name="ln1028">                  TremoloType st;</a>
<a name="ln1029">                  switch (sti) {</a>
<a name="ln1030">                        default:</a>
<a name="ln1031">                        case OldTremoloType::OLD_R8:  st = TremoloType::R8;  break;</a>
<a name="ln1032">                        case OldTremoloType::OLD_R16: st = TremoloType::R16; break;</a>
<a name="ln1033">                        case OldTremoloType::OLD_R32: st = TremoloType::R32; break;</a>
<a name="ln1034">                        case OldTremoloType::OLD_C8:  st = TremoloType::C8;  break;</a>
<a name="ln1035">                        case OldTremoloType::OLD_C16: st = TremoloType::C16; break;</a>
<a name="ln1036">                        case OldTremoloType::OLD_C32: st = TremoloType::C32; break;</a>
<a name="ln1037">                        }</a>
<a name="ln1038">                  tremolo-&gt;setTremoloType(st);</a>
<a name="ln1039">                  }</a>
<a name="ln1040">            else if (!tremolo-&gt;Element::readProperties(e))</a>
<a name="ln1041">                  e.unknown();</a>
<a name="ln1042">            }</a>
<a name="ln1043">      }</a>
<a name="ln1044"> </a>
<a name="ln1045">//---------------------------------------------------------</a>
<a name="ln1046">//   readChord</a>
<a name="ln1047">//---------------------------------------------------------</a>
<a name="ln1048"> </a>
<a name="ln1049">static void readChord(Measure* m, Chord* chord, XmlReader&amp; e)</a>
<a name="ln1050">      {</a>
<a name="ln1051">      while (e.readNextStartElement()) {</a>
<a name="ln1052">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1053">            if (tag == &quot;Note&quot;) {</a>
<a name="ln1054">                  Note* note = new Note(chord-&gt;score());</a>
<a name="ln1055">                  // the note needs to know the properties of the track it belongs to</a>
<a name="ln1056">                  note-&gt;setTrack(chord-&gt;track());</a>
<a name="ln1057">                  note-&gt;setChord(chord);</a>
<a name="ln1058">                  readNote(note, e);</a>
<a name="ln1059">                  chord-&gt;add(note);</a>
<a name="ln1060">                  }</a>
<a name="ln1061">            else if (tag == &quot;Attribute&quot; || tag == &quot;Articulation&quot;) {</a>
<a name="ln1062">                  Element* el = readArticulation(chord, e);</a>
<a name="ln1063">                  if (el-&gt;isFermata()) {</a>
<a name="ln1064">                        if (!chord-&gt;segment())</a>
<a name="ln1065">                              chord-&gt;setParent(m-&gt;getSegment(SegmentType::ChordRest, e.tick()));</a>
<a name="ln1066">                        chord-&gt;segment()-&gt;add(el);</a>
<a name="ln1067">                        }</a>
<a name="ln1068">                  else</a>
<a name="ln1069">                        chord-&gt;add(el);</a>
<a name="ln1070">                  }</a>
<a name="ln1071">            else if (tag == &quot;Tremolo&quot;) {</a>
<a name="ln1072">                  Tremolo* tremolo = new Tremolo(chord-&gt;score());</a>
<a name="ln1073">                  tremolo-&gt;setDurationType(chord-&gt;durationType());</a>
<a name="ln1074">                  chord-&gt;setTremolo(tremolo);</a>
<a name="ln1075">                  tremolo-&gt;setTrack(chord-&gt;track());</a>
<a name="ln1076">                  readTremolo(tremolo, e);</a>
<a name="ln1077">                  tremolo-&gt;setParent(chord);</a>
<a name="ln1078">                  }</a>
<a name="ln1079">            else if (readChordProperties206(e, chord))</a>
<a name="ln1080">                  ;</a>
<a name="ln1081">            else</a>
<a name="ln1082">                  e.unknown();</a>
<a name="ln1083">            }</a>
<a name="ln1084">      }</a>
<a name="ln1085"> </a>
<a name="ln1086">//---------------------------------------------------------</a>
<a name="ln1087">//   readRest</a>
<a name="ln1088">//---------------------------------------------------------</a>
<a name="ln1089"> </a>
<a name="ln1090">static void readRest(Measure* m, Rest* rest, XmlReader&amp; e)</a>
<a name="ln1091">      {</a>
<a name="ln1092">      while (e.readNextStartElement()) {</a>
<a name="ln1093">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1094">            if (tag == &quot;Attribute&quot; || tag == &quot;Articulation&quot;) {</a>
<a name="ln1095">                  Element* el = readArticulation(rest, e);</a>
<a name="ln1096">                  if (el-&gt;isFermata()) {</a>
<a name="ln1097">                        if (!rest-&gt;segment())</a>
<a name="ln1098">                              rest-&gt;setParent(m-&gt;getSegment(SegmentType::ChordRest, e.tick()));</a>
<a name="ln1099">                        rest-&gt;segment()-&gt;add(el);</a>
<a name="ln1100">                        }</a>
<a name="ln1101">                  else</a>
<a name="ln1102">                        rest-&gt;add(el);</a>
<a name="ln1103">                  }</a>
<a name="ln1104">            else if (readChordRestProperties206(e, rest))</a>
<a name="ln1105">                  ;</a>
<a name="ln1106">            else</a>
<a name="ln1107">                  e.unknown();</a>
<a name="ln1108">            }</a>
<a name="ln1109">      }</a>
<a name="ln1110"> </a>
<a name="ln1111">//---------------------------------------------------------</a>
<a name="ln1112">//   readTempoText</a>
<a name="ln1113">//---------------------------------------------------------</a>
<a name="ln1114"> </a>
<a name="ln1115">void readTempoText(TempoText* t, XmlReader&amp; e)</a>
<a name="ln1116">      {</a>
<a name="ln1117">      while (e.readNextStartElement()) {</a>
<a name="ln1118">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1119">            if (tag == &quot;tempo&quot;)</a>
<a name="ln1120">                  t-&gt;setTempo(e.readDouble());</a>
<a name="ln1121">            else if (!readTextProperties(e, t, t))</a>
<a name="ln1122">                  e.unknown();</a>
<a name="ln1123">            }</a>
<a name="ln1124">      }</a>
<a name="ln1125"> </a>
<a name="ln1126">//---------------------------------------------------------</a>
<a name="ln1127">//   readStaffText</a>
<a name="ln1128">//---------------------------------------------------------</a>
<a name="ln1129"> </a>
<a name="ln1130">void readStaffText(StaffText* t, XmlReader&amp; e)</a>
<a name="ln1131">      {</a>
<a name="ln1132">      while (e.readNextStartElement()) {</a>
<a name="ln1133">            if (!readTextProperties(e, t, t))</a>
<a name="ln1134">                  e.unknown();</a>
<a name="ln1135">            }</a>
<a name="ln1136">      }</a>
<a name="ln1137"> </a>
<a name="ln1138">//---------------------------------------------------------</a>
<a name="ln1139">//   readLineSegment114</a>
<a name="ln1140">//---------------------------------------------------------</a>
<a name="ln1141"> </a>
<a name="ln1142">static void readLineSegment114(XmlReader&amp; e, LineSegment* ls)</a>
<a name="ln1143">      {</a>
<a name="ln1144">      while (e.readNextStartElement()) {</a>
<a name="ln1145">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1146">            if (tag == &quot;off1&quot;)</a>
<a name="ln1147">                  ls-&gt;setOffset(e.readPoint() * ls-&gt;spatium());</a>
<a name="ln1148">            else</a>
<a name="ln1149">                  ls-&gt;readProperties(e);</a>
<a name="ln1150">            }</a>
<a name="ln1151">      }</a>
<a name="ln1152"> </a>
<a name="ln1153">//---------------------------------------------------------</a>
<a name="ln1154">//   readTextLineProperties114</a>
<a name="ln1155">//---------------------------------------------------------</a>
<a name="ln1156"> </a>
<a name="ln1157">static bool readTextLineProperties114(XmlReader&amp; e, TextLineBase* tl)</a>
<a name="ln1158">      {</a>
<a name="ln1159">      const QStringRef&amp; tag(e.name());</a>
<a name="ln1160"> </a>
<a name="ln1161">      if (tag == &quot;beginText&quot;) {</a>
<a name="ln1162">            Text* text = new Text(tl-&gt;score());</a>
<a name="ln1163">            readText114(e, text, tl);</a>
<a name="ln1164">            tl-&gt;setBeginText(text-&gt;xmlText());</a>
<a name="ln1165">            tl-&gt;setPropertyFlags(Pid::BEGIN_TEXT, PropertyFlags::UNSTYLED);</a>
<a name="ln1166">            delete text;</a>
<a name="ln1167">            }</a>
<a name="ln1168">      else if (tag == &quot;continueText&quot;) {</a>
<a name="ln1169">            Text* text = new Text(tl-&gt;score());</a>
<a name="ln1170">            readText114(e, text, tl);</a>
<a name="ln1171">            tl-&gt;setContinueText(text-&gt;xmlText());</a>
<a name="ln1172">            tl-&gt;setPropertyFlags(Pid::CONTINUE_TEXT, PropertyFlags::UNSTYLED);</a>
<a name="ln1173">            delete text;</a>
<a name="ln1174">            }</a>
<a name="ln1175">      else if (tag == &quot;endText&quot;) {</a>
<a name="ln1176">            Text* text = new Text(tl-&gt;score());</a>
<a name="ln1177">            readText114(e, text, tl);</a>
<a name="ln1178">            tl-&gt;setEndText(text-&gt;xmlText());</a>
<a name="ln1179">            tl-&gt;setPropertyFlags(Pid::END_TEXT, PropertyFlags::UNSTYLED);</a>
<a name="ln1180">            delete text;</a>
<a name="ln1181">            }</a>
<a name="ln1182">      else if (tag == &quot;beginHook&quot;)</a>
<a name="ln1183">            tl-&gt;setBeginHookType(e.readBool() ? HookType::HOOK_90 : HookType::NONE);</a>
<a name="ln1184">      else if (tag == &quot;endHook&quot;)</a>
<a name="ln1185">            tl-&gt;setEndHookType(e.readBool() ? HookType::HOOK_90 : HookType::NONE);</a>
<a name="ln1186">      else if (tag == &quot;beginHookType&quot;)</a>
<a name="ln1187">            tl-&gt;setBeginHookType(e.readInt() == 0 ? HookType::HOOK_90 : HookType::HOOK_45);</a>
<a name="ln1188">      else if (tag == &quot;endHookType&quot;)</a>
<a name="ln1189">            tl-&gt;setEndHookType(e.readInt() == 0 ? HookType::HOOK_90 : HookType::HOOK_45);</a>
<a name="ln1190">      else if (tag == &quot;Segment&quot;) {</a>
<a name="ln1191">            LineSegment* ls = tl-&gt;createLineSegment();</a>
<a name="ln1192">            ls-&gt;setTrack(tl-&gt;track()); // needed in read to get the right staff mag</a>
<a name="ln1193">            readLineSegment114(e, ls);</a>
<a name="ln1194">            // in v1.x &quot;visible&quot; is a property of the segment only;</a>
<a name="ln1195">            // we must ensure that it propagates also to the parent element.</a>
<a name="ln1196">            // That's why the visibility is set after adding the segment</a>
<a name="ln1197">            // to the corresponding spanner</a>
<a name="ln1198">            ls-&gt;setVisible(ls-&gt;visible());</a>
<a name="ln1199">            ls-&gt;setOffset(QPointF());        // ignore offsets</a>
<a name="ln1200">            ls-&gt;setAutoplace(true);</a>
<a name="ln1201">            tl-&gt;add(ls);</a>
<a name="ln1202">            }</a>
<a name="ln1203">      else if (tl-&gt;readProperties(e))</a>
<a name="ln1204">            return true;</a>
<a name="ln1205">      return true;</a>
<a name="ln1206">      }</a>
<a name="ln1207"> </a>
<a name="ln1208">//---------------------------------------------------------</a>
<a name="ln1209">//   readVolta114</a>
<a name="ln1210">//---------------------------------------------------------</a>
<a name="ln1211"> </a>
<a name="ln1212">static void readVolta114(XmlReader&amp; e, Volta* volta)</a>
<a name="ln1213">      {</a>
<a name="ln1214">      while (e.readNextStartElement()) {</a>
<a name="ln1215">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1216">            if (tag == &quot;endings&quot;) {</a>
<a name="ln1217">                  QString s = e.readElementText();</a>
<a name="ln1218">                  QStringList sl = s.split(&quot;,&quot;, QString::SkipEmptyParts);</a>
<a name="ln1219">                  volta-&gt;endings().clear();</a>
<a name="ln1220">                  for (const QString&amp; l : sl) {</a>
<a name="ln1221">                        int i = l.simplified().toInt();</a>
<a name="ln1222">                        volta-&gt;endings().append(i);</a>
<a name="ln1223">                        }</a>
<a name="ln1224">                  }</a>
<a name="ln1225">            else if (tag == &quot;subtype&quot;) {</a>
<a name="ln1226">                  e.readInt();    // TODO</a>
<a name="ln1227">                  }</a>
<a name="ln1228">            else if (tag == &quot;lineWidth&quot;) {</a>
<a name="ln1229">                  volta-&gt;setLineWidth(e.readDouble() * volta-&gt;spatium());</a>
<a name="ln1230">                  volta-&gt;setPropertyFlags(Pid::LINE_WIDTH, PropertyFlags::UNSTYLED);</a>
<a name="ln1231">                  }</a>
<a name="ln1232">            else if (!readTextLineProperties114(e, volta))</a>
<a name="ln1233">                  e.unknown();</a>
<a name="ln1234">            }</a>
<a name="ln1235">      volta-&gt;setOffset(QPointF());        // ignore offsets</a>
<a name="ln1236">      volta-&gt;setAutoplace(true);</a>
<a name="ln1237">      }</a>
<a name="ln1238"> </a>
<a name="ln1239">//---------------------------------------------------------</a>
<a name="ln1240">//   readOttava114</a>
<a name="ln1241">//---------------------------------------------------------</a>
<a name="ln1242"> </a>
<a name="ln1243">static void readOttava114(XmlReader&amp; e, Ottava* ottava)</a>
<a name="ln1244">      {</a>
<a name="ln1245">      while (e.readNextStartElement()) {</a>
<a name="ln1246">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1247">            if (tag == &quot;subtype&quot;) {</a>
<a name="ln1248">                  QString s = e.readElementText();</a>
<a name="ln1249">                  bool ok;</a>
<a name="ln1250">                  int idx = s.toInt(&amp;ok);</a>
<a name="ln1251">                  if (!ok) {</a>
<a name="ln1252">                        idx = int(OttavaType::OTTAVA_8VA);</a>
<a name="ln1253">                        for (unsigned i = 0; i &lt; sizeof(ottavaDefault)/sizeof(*ottavaDefault); ++i) {</a>
<a name="ln1254">                              if (s == ottavaDefault[i].name) {</a>
<a name="ln1255">                                    idx = i;</a>
<a name="ln1256">                                    break;</a>
<a name="ln1257">                                    }</a>
<a name="ln1258">                              }</a>
<a name="ln1259">                        }</a>
<a name="ln1260">                  //subtype are now in a different order...</a>
<a name="ln1261">                  if (idx == 1)</a>
<a name="ln1262">                        idx = 2;</a>
<a name="ln1263">                  else if (idx == 2)</a>
<a name="ln1264">                        idx = 1;</a>
<a name="ln1265">                  ottava-&gt;setOttavaType(OttavaType(idx));</a>
<a name="ln1266">                  }</a>
<a name="ln1267">            else if (tag == &quot;numbersOnly&quot;)</a>
<a name="ln1268">                  ottava-&gt;setNumbersOnly(e.readInt());</a>
<a name="ln1269">            else if (tag == &quot;lineWidth&quot;)</a>
<a name="ln1270">                  ottava-&gt;readProperty(e, Pid::LINE_WIDTH);</a>
<a name="ln1271">            else if (tag == &quot;lineStyle&quot;)</a>
<a name="ln1272">                  ottava-&gt;readProperty(e, Pid::LINE_STYLE);</a>
<a name="ln1273">            else if (tag == &quot;beginSymbol&quot;) {                      // obsolete</a>
<a name="ln1274">                  }</a>
<a name="ln1275">            else if (tag == &quot;continueSymbol&quot;) {                   // obsolete</a>
<a name="ln1276">                  }</a>
<a name="ln1277">            else if (!readTextLineProperties114(e, ottava))</a>
<a name="ln1278">                  e.unknown();</a>
<a name="ln1279">            }</a>
<a name="ln1280">      }</a>
<a name="ln1281"> </a>
<a name="ln1282">//---------------------------------------------------------</a>
<a name="ln1283">//   resolveSymCompatibility</a>
<a name="ln1284">//---------------------------------------------------------</a>
<a name="ln1285"> </a>
<a name="ln1286">static QString resolveSymCompatibility(SymId i, QString programVersion)</a>
<a name="ln1287">      {</a>
<a name="ln1288">      if (!programVersion.isEmpty() &amp;&amp; programVersion &lt; &quot;1.1&quot;)</a>
<a name="ln1289">            i = SymId(int(i) + 5);</a>
<a name="ln1290">      switch (int(i)) {</a>
<a name="ln1291">            case 197:</a>
<a name="ln1292">                  return &quot;keyboardPedalPed&quot;;</a>
<a name="ln1293">            case 191:</a>
<a name="ln1294">                  return &quot;keyboardPedalUp&quot;;</a>
<a name="ln1295">            case 193:</a>
<a name="ln1296">                  return &quot;noSym&quot;; //SymId(pedaldotSym);</a>
<a name="ln1297">            case 192:</a>
<a name="ln1298">                  return &quot;noSym&quot;; //SymId(pedaldashSym);</a>
<a name="ln1299">            case 139:</a>
<a name="ln1300">                  return &quot;ornamentTrill&quot;;</a>
<a name="ln1301">            default:</a>
<a name="ln1302">                  return &quot;noSym&quot;;</a>
<a name="ln1303">          }</a>
<a name="ln1304">      }</a>
<a name="ln1305"> </a>
<a name="ln1306">//---------------------------------------------------------</a>
<a name="ln1307">//   readTextLine114</a>
<a name="ln1308">//---------------------------------------------------------</a>
<a name="ln1309"> </a>
<a name="ln1310">static void readTextLine114(XmlReader&amp; e, TextLine* textLine)</a>
<a name="ln1311">      {</a>
<a name="ln1312">      while (e.readNextStartElement()) {</a>
<a name="ln1313">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1314"> </a>
<a name="ln1315">            if (tag == &quot;lineVisible&quot;)</a>
<a name="ln1316">                  textLine-&gt;setLineVisible(e.readBool());</a>
<a name="ln1317">            else if (tag == &quot;beginHookHeight&quot;) {</a>
<a name="ln1318">                  textLine-&gt;setBeginHookHeight(Spatium(e.readDouble()));</a>
<a name="ln1319">                  }</a>
<a name="ln1320">            else if (tag == &quot;endHookHeight&quot; || tag == &quot;hookHeight&quot;) { // hookHeight is obsolete</a>
<a name="ln1321">                  textLine-&gt;setEndHookHeight(Spatium(e.readDouble()));</a>
<a name="ln1322">                  textLine-&gt;setPropertyFlags(Pid::END_HOOK_HEIGHT, PropertyFlags::UNSTYLED);</a>
<a name="ln1323">                  }</a>
<a name="ln1324">            else if (tag == &quot;hookUp&quot;) // obsolete</a>
<a name="ln1325">                  textLine-&gt;setEndHookHeight(Spatium(qreal(-1.0)));</a>
<a name="ln1326">            else if (tag == &quot;beginSymbol&quot; || tag == &quot;symbol&quot;) { // &quot;symbol&quot; is obsolete</a>
<a name="ln1327">                  QString text(e.readElementText());</a>
<a name="ln1328">                  textLine-&gt;setBeginText(QString(&quot;&lt;sym&gt;%1&lt;/sym&gt;&quot;).arg(</a>
<a name="ln1329">                        text[0].isNumber()</a>
<a name="ln1330">                              ? resolveSymCompatibility(SymId(text.toInt()), textLine-&gt;score()-&gt;mscoreVersion())</a>
<a name="ln1331">                              : text));</a>
<a name="ln1332">                  }</a>
<a name="ln1333">            else if (tag == &quot;continueSymbol&quot;) {</a>
<a name="ln1334">                  QString text(e.readElementText());</a>
<a name="ln1335">                  textLine-&gt;setContinueText(QString(&quot;&lt;sym&gt;%1&lt;/sym&gt;&quot;).arg(</a>
<a name="ln1336">                        text[0].isNumber()</a>
<a name="ln1337">                              ? resolveSymCompatibility(SymId(text.toInt()), textLine-&gt;score()-&gt;mscoreVersion())</a>
<a name="ln1338">                              : text));</a>
<a name="ln1339">                  }</a>
<a name="ln1340">            else if (tag == &quot;endSymbol&quot;) {</a>
<a name="ln1341">                  QString text(e.readElementText());</a>
<a name="ln1342">                  textLine-&gt;setEndText(QString(&quot;&lt;sym&gt;%1&lt;/sym&gt;&quot;).arg(</a>
<a name="ln1343">                        text[0].isNumber()</a>
<a name="ln1344">                              ? resolveSymCompatibility(SymId(text.toInt()), textLine-&gt;score()-&gt;mscoreVersion())</a>
<a name="ln1345">                              : text));</a>
<a name="ln1346">                  }</a>
<a name="ln1347">            else if (tag == &quot;beginSymbolOffset&quot;) // obsolete</a>
<a name="ln1348">                  e.readPoint();</a>
<a name="ln1349">            else if (tag == &quot;continueSymbolOffset&quot;) // obsolete</a>
<a name="ln1350">                  e.readPoint();</a>
<a name="ln1351">            else if (tag == &quot;endSymbolOffset&quot;) // obsolete</a>
<a name="ln1352">                  e.readPoint();</a>
<a name="ln1353">            else if (tag == &quot;beginTextPlace&quot;)</a>
<a name="ln1354">                  textLine-&gt;setBeginTextPlace(readPlacement(e));</a>
<a name="ln1355">            else if (tag == &quot;continueTextPlace&quot;)</a>
<a name="ln1356">                  textLine-&gt;setContinueTextPlace(readPlacement(e));</a>
<a name="ln1357">            else if (tag == &quot;endTextPlace&quot;)</a>
<a name="ln1358">                  textLine-&gt;setEndTextPlace(readPlacement(e));</a>
<a name="ln1359">            else if (!readTextLineProperties114(e, textLine))</a>
<a name="ln1360">                e.unknown();</a>
<a name="ln1361">            }</a>
<a name="ln1362">      }</a>
<a name="ln1363"> </a>
<a name="ln1364">//---------------------------------------------------------</a>
<a name="ln1365">//   readPedal114</a>
<a name="ln1366">//---------------------------------------------------------</a>
<a name="ln1367"> </a>
<a name="ln1368">static void readPedal114(XmlReader&amp; e, Pedal* pedal)</a>
<a name="ln1369">      {</a>
<a name="ln1370">      while (e.readNextStartElement()) {</a>
<a name="ln1371">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1372">            if (tag == &quot;beginSymbol&quot;</a>
<a name="ln1373">                  || tag == &quot;beginSymbolOffset&quot;</a>
<a name="ln1374">                  || tag == &quot;endSymbol&quot;</a>
<a name="ln1375">                  || tag == &quot;endSymbolOffset&quot;</a>
<a name="ln1376">                  || tag == &quot;subtype&quot;</a>
<a name="ln1377">                  )</a>
<a name="ln1378">                  e.skipCurrentElement();</a>
<a name="ln1379">            else if (tag == &quot;endHookHeight&quot; || tag == &quot;hookHeight&quot;) { // hookHeight is obsolete</a>
<a name="ln1380">                  pedal-&gt;setEndHookHeight(Spatium(e.readDouble()));</a>
<a name="ln1381">                  pedal-&gt;setPropertyFlags(Pid::END_HOOK_HEIGHT, PropertyFlags::UNSTYLED);</a>
<a name="ln1382">                  }</a>
<a name="ln1383">            else if (tag == &quot;lineWidth&quot;) {</a>
<a name="ln1384">                  pedal-&gt;setLineWidth(qreal(e.readDouble()));</a>
<a name="ln1385">                  pedal-&gt;setPropertyFlags(Pid::LINE_WIDTH, PropertyFlags::UNSTYLED);</a>
<a name="ln1386">                  }</a>
<a name="ln1387">            else if (tag == &quot;lineStyle&quot;) {</a>
<a name="ln1388">                  pedal-&gt;setLineStyle(Qt::PenStyle(e.readInt()));</a>
<a name="ln1389">                  pedal-&gt;setPropertyFlags(Pid::LINE_STYLE, PropertyFlags::UNSTYLED);</a>
<a name="ln1390">                  }</a>
<a name="ln1391">            else if (!readTextLineProperties114(e, pedal))</a>
<a name="ln1392">                  e.unknown();</a>
<a name="ln1393">            }</a>
<a name="ln1394">      pedal-&gt;setBeginText(&quot;&lt;sym&gt;keyboardPedalPed&lt;/sym&gt;&quot;);</a>
<a name="ln1395">      }</a>
<a name="ln1396"> </a>
<a name="ln1397">//---------------------------------------------------------</a>
<a name="ln1398">//   readHarmony114</a>
<a name="ln1399">//---------------------------------------------------------</a>
<a name="ln1400"> </a>
<a name="ln1401">static void readHarmony114(XmlReader&amp; e, Harmony* h)</a>
<a name="ln1402">      {</a>
<a name="ln1403">      // convert table to tpc values</a>
<a name="ln1404">      static const int table[] = {</a>
<a name="ln1405">            14, 9, 16, 11, 18, 13, 8, 15, 10, 17, 12, 19</a>
<a name="ln1406">            };</a>
<a name="ln1407"> </a>
<a name="ln1408">      while (e.readNextStartElement()) {</a>
<a name="ln1409">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1410">            if (tag == &quot;base&quot;) {</a>
<a name="ln1411">                  if (h-&gt;score()-&gt;mscVersion() &gt;= 106)</a>
<a name="ln1412">                        h-&gt;setBaseTpc(e.readInt());</a>
<a name="ln1413">                  else</a>
<a name="ln1414">                        h-&gt;setBaseTpc(table[e.readInt()-1]);</a>
<a name="ln1415">                  }</a>
<a name="ln1416">            else if (tag == &quot;baseCase&quot;)</a>
<a name="ln1417">                  h-&gt;setBaseCase(static_cast&lt;NoteCaseType&gt;(e.readInt()));</a>
<a name="ln1418">            else if (tag == &quot;extension&quot;)</a>
<a name="ln1419">                  h-&gt;setId(e.readInt());</a>
<a name="ln1420">            else if (tag == &quot;name&quot;)</a>
<a name="ln1421">                  h-&gt;setTextName(e.readElementText());</a>
<a name="ln1422">            else if (tag == &quot;root&quot;) {</a>
<a name="ln1423">                  if (h-&gt;score()-&gt;mscVersion() &gt;= 106)</a>
<a name="ln1424">                        h-&gt;setRootTpc(e.readInt());</a>
<a name="ln1425">                  else</a>
<a name="ln1426">                        h-&gt;setRootTpc(table[e.readInt()-1]);</a>
<a name="ln1427">                  }</a>
<a name="ln1428">            else if (tag == &quot;rootCase&quot;)</a>
<a name="ln1429">                  h-&gt;setRootCase(static_cast&lt;NoteCaseType&gt;(e.readInt()));</a>
<a name="ln1430">            else if (tag == &quot;degree&quot;) {</a>
<a name="ln1431">                  int degreeValue = 0;</a>
<a name="ln1432">                  int degreeAlter = 0;</a>
<a name="ln1433">                  QString degreeType = &quot;&quot;;</a>
<a name="ln1434">                  while (e.readNextStartElement()) {</a>
<a name="ln1435">                        const QStringRef&amp; t(e.name());</a>
<a name="ln1436">                        if (t == &quot;degree-value&quot;)</a>
<a name="ln1437">                              degreeValue = e.readInt();</a>
<a name="ln1438">                        else if (t == &quot;degree-alter&quot;)</a>
<a name="ln1439">                              degreeAlter = e.readInt();</a>
<a name="ln1440">                        else if (t == &quot;degree-type&quot;)</a>
<a name="ln1441">                              degreeType = e.readElementText();</a>
<a name="ln1442">                        else</a>
<a name="ln1443">                              e.unknown();</a>
<a name="ln1444">                        }</a>
<a name="ln1445">                  if (degreeValue &lt;= 0 || degreeValue &gt; 13</a>
<a name="ln1446">                      || degreeAlter &lt; -2 || degreeAlter &gt; 2</a>
<a name="ln1447">                      || (degreeType != &quot;add&quot; &amp;&amp; degreeType != &quot;alter&quot; &amp;&amp; degreeType != &quot;subtract&quot;)) {</a>
<a name="ln1448">                        qDebug(&quot;incorrect degree: degreeValue=%d degreeAlter=%d degreeType=%s&quot;,</a>
<a name="ln1449">                               degreeValue, degreeAlter, qPrintable(degreeType));</a>
<a name="ln1450">                        }</a>
<a name="ln1451">                  else {</a>
<a name="ln1452">                        if (degreeType == &quot;add&quot;)</a>
<a name="ln1453">                              h-&gt;addDegree(HDegree(degreeValue, degreeAlter, HDegreeType::ADD));</a>
<a name="ln1454">                        else if (degreeType == &quot;alter&quot;)</a>
<a name="ln1455">                              h-&gt;addDegree(HDegree(degreeValue, degreeAlter, HDegreeType::ALTER));</a>
<a name="ln1456">                        else if (degreeType == &quot;subtract&quot;)</a>
<a name="ln1457">                              h-&gt;addDegree(HDegree(degreeValue, degreeAlter, HDegreeType::SUBTRACT));</a>
<a name="ln1458">                        }</a>
<a name="ln1459">                  }</a>
<a name="ln1460">            else if (tag == &quot;leftParen&quot;) {</a>
<a name="ln1461">                  h-&gt;setLeftParen(true);</a>
<a name="ln1462">                  e.readNext();</a>
<a name="ln1463">                  }</a>
<a name="ln1464">            else if (tag == &quot;rightParen&quot;) {</a>
<a name="ln1465">                  h-&gt;setRightParen(true);</a>
<a name="ln1466">                  e.readNext();</a>
<a name="ln1467">                  }</a>
<a name="ln1468">            else if (!readTextProperties(e, h, h))</a>
<a name="ln1469">                  e.unknown();</a>
<a name="ln1470">            }</a>
<a name="ln1471"> </a>
<a name="ln1472">      // TODO: now that we can render arbitrary chords,</a>
<a name="ln1473">      // we could try to construct a full representation from a degree list.</a>
<a name="ln1474">      // These will typically only exist for chords imported from MusicXML prior to MuseScore 2.0</a>
<a name="ln1475">      // or constructed in the Chord Symbol Properties dialog.</a>
<a name="ln1476"> </a>
<a name="ln1477">      if (h-&gt;rootTpc() != Tpc::TPC_INVALID) {</a>
<a name="ln1478">            if (h-&gt;id() &gt; 0) {</a>
<a name="ln1479">                  // positive id will happen only for scores that were created with explicit chord lists</a>
<a name="ln1480">                  // lookup id in chord list and generate new description if necessary</a>
<a name="ln1481">                  h-&gt;getDescription();</a>
<a name="ln1482">                  }</a>
<a name="ln1483">            else</a>
<a name="ln1484">                  {</a>
<a name="ln1485">                  // default case: look up by name</a>
<a name="ln1486">                  // description will be found for any chord already read in this score</a>
<a name="ln1487">                  // and we will generate a new one if necessary</a>
<a name="ln1488">                  h-&gt;getDescription(h-&gt;hTextName());</a>
<a name="ln1489">                  }</a>
<a name="ln1490">            }</a>
<a name="ln1491">      else if (h-&gt;hTextName() == &quot;&quot;) {</a>
<a name="ln1492">            // unrecognized chords prior to 2.0 were stored as text with markup</a>
<a name="ln1493">            // we need to strip away the markup</a>
<a name="ln1494">            // this removes any user-applied formatting,</a>
<a name="ln1495">            // but we no longer support user-applied formatting for chord symbols anyhow</a>
<a name="ln1496">            // with any luck, the resulting text will be parseable now, so give it a shot</a>
<a name="ln1497">//            h-&gt;createLayout();</a>
<a name="ln1498">            QString s = h-&gt;plainText();</a>
<a name="ln1499">            if (!s.isEmpty()) {</a>
<a name="ln1500">                  h-&gt;setHarmony(s);</a>
<a name="ln1501">                  return;</a>
<a name="ln1502">                  }</a>
<a name="ln1503">            // empty text could also indicate a root-less slash chord (&quot;/E&quot;)</a>
<a name="ln1504">            // we'll fall through and render it normally</a>
<a name="ln1505">            }</a>
<a name="ln1506"> </a>
<a name="ln1507">      // render chord from description (or _textName)</a>
<a name="ln1508">      h-&gt;render();</a>
<a name="ln1509">      }</a>
<a name="ln1510"> </a>
<a name="ln1511">//---------------------------------------------------------</a>
<a name="ln1512">//   readMeasure</a>
<a name="ln1513">//---------------------------------------------------------</a>
<a name="ln1514"> </a>
<a name="ln1515">static void readMeasure(Measure* m, int staffIdx, XmlReader&amp; e)</a>
<a name="ln1516">      {</a>
<a name="ln1517">      Segment* segment = 0;</a>
<a name="ln1518">      qreal _spatium = m-&gt;spatium();</a>
<a name="ln1519"> </a>
<a name="ln1520">      QList&lt;Chord*&gt; graceNotes;</a>
<a name="ln1521"> </a>
<a name="ln1522">      //sort tuplet elements. needed for nested tuplets #22537</a>
<a name="ln1523">      for (Tuplet* t : e.tuplets())</a>
<a name="ln1524">            t-&gt;sortElements();</a>
<a name="ln1525">      e.tuplets().clear();</a>
<a name="ln1526">      e.setTrack(staffIdx * VOICES);</a>
<a name="ln1527"> </a>
<a name="ln1528">      m-&gt;createStaves(staffIdx);</a>
<a name="ln1529"> </a>
<a name="ln1530">      // tick is obsolete</a>
<a name="ln1531">      if (e.hasAttribute(&quot;tick&quot;))</a>
<a name="ln1532">            e.setTick(Fraction::fromTicks(m-&gt;score()-&gt;fileDivision(e.intAttribute(&quot;tick&quot;))));</a>
<a name="ln1533"> </a>
<a name="ln1534">      if (e.hasAttribute(&quot;len&quot;)) {</a>
<a name="ln1535">            QStringList sl = e.attribute(&quot;len&quot;).split('/');</a>
<a name="ln1536">            if (sl.size() == 2)</a>
<a name="ln1537">                  m-&gt;setTicks(Fraction(sl[0].toInt(), sl[1].toInt()));</a>
<a name="ln1538">            else</a>
<a name="ln1539">                  qDebug(&quot;illegal measure size &lt;%s&gt;&quot;, qPrintable(e.attribute(&quot;len&quot;)));</a>
<a name="ln1540">            m-&gt;score()-&gt;sigmap()-&gt;add(m-&gt;tick().ticks(), SigEvent(m-&gt;ticks(), m-&gt;timesig()));</a>
<a name="ln1541">            m-&gt;score()-&gt;sigmap()-&gt;add(m-&gt;endTick().ticks(), SigEvent(m-&gt;timesig()));</a>
<a name="ln1542">            }</a>
<a name="ln1543"> </a>
<a name="ln1544">      Staff* staff = m-&gt;score()-&gt;staff(staffIdx);</a>
<a name="ln1545">      Fraction timeStretch(staff-&gt;timeStretch(m-&gt;tick()));</a>
<a name="ln1546"> </a>
<a name="ln1547">      // keep track of tick of previous element</a>
<a name="ln1548">      // this allows markings that need to apply to previous element to do so</a>
<a name="ln1549">      // even though we may have already advanced to next tick position</a>
<a name="ln1550">      Fraction lastTick = e.tick();</a>
<a name="ln1551"> </a>
<a name="ln1552">      while (e.readNextStartElement()) {</a>
<a name="ln1553">            const QStringRef&amp; tag(e.name());</a>
<a name="ln1554"> </a>
<a name="ln1555">            if (tag == &quot;move&quot;)</a>
<a name="ln1556">                  e.setTick(e.readFraction() + m-&gt;tick());</a>
<a name="ln1557">            else if (tag == &quot;tick&quot;) {</a>
<a name="ln1558">                  e.setTick(Fraction::fromTicks(m-&gt;score()-&gt;fileDivision(e.readInt())));</a>
<a name="ln1559">                  lastTick = e.tick();</a>
<a name="ln1560">                  }</a>
<a name="ln1561">            else if (tag == &quot;BarLine&quot;) {</a>
<a name="ln1562">                  BarLine* barLine = new BarLine(m-&gt;score());</a>
<a name="ln1563">                  barLine-&gt;setTrack(e.track());</a>
<a name="ln1564">                  barLine-&gt;resetProperty(Pid::BARLINE_SPAN);</a>
<a name="ln1565">                  barLine-&gt;resetProperty(Pid::BARLINE_SPAN_FROM);</a>
<a name="ln1566">                  barLine-&gt;resetProperty(Pid::BARLINE_SPAN_TO);</a>
<a name="ln1567"> </a>
<a name="ln1568">                  while (e.readNextStartElement()) {</a>
<a name="ln1569">                        const QStringRef&amp; tg(e.name());</a>
<a name="ln1570">                        if (tg == &quot;subtype&quot;) {</a>
<a name="ln1571">                              BarLineType t = BarLineType::NORMAL;</a>
<a name="ln1572">                              switch (e.readInt()) {</a>
<a name="ln1573">                                    default:</a>
<a name="ln1574">                                    case 0:</a>
<a name="ln1575">                                          t = BarLineType::NORMAL;</a>
<a name="ln1576">                                          break;</a>
<a name="ln1577">                                    case 1:</a>
<a name="ln1578">                                          t = BarLineType::DOUBLE;</a>
<a name="ln1579">                                          break;</a>
<a name="ln1580">                                    case 2:</a>
<a name="ln1581">                                          t = BarLineType::START_REPEAT;</a>
<a name="ln1582">                                          break;</a>
<a name="ln1583">                                    case 3:</a>
<a name="ln1584">                                          t = BarLineType::END_REPEAT;</a>
<a name="ln1585">                                          break;</a>
<a name="ln1586">                                    case 4:</a>
<a name="ln1587">                                          t = BarLineType::BROKEN;</a>
<a name="ln1588">                                          break;</a>
<a name="ln1589">                                    case 5:</a>
<a name="ln1590">                                          t = BarLineType::END;</a>
<a name="ln1591">                                          break;</a>
<a name="ln1592">                                    case 6:</a>
<a name="ln1593">                                          t = BarLineType::END_START_REPEAT;</a>
<a name="ln1594">                                          break;</a>
<a name="ln1595">                                    }</a>
<a name="ln1596">                              barLine-&gt;setBarLineType(t);</a>
<a name="ln1597">                              }</a>
<a name="ln1598">                        else if (!barLine-&gt;Element::readProperties(e))</a>
<a name="ln1599">                              e.unknown();</a>
<a name="ln1600">                        }</a>
<a name="ln1601"> </a>
<a name="ln1602">                  //</a>
<a name="ln1603">                  //  StartRepeatBarLine: always at the beginning tick of a measure, always BarLineType::START_REPEAT</a>
<a name="ln1604">                  //  BarLine:            in the middle of a measure, has no semantic</a>
<a name="ln1605">                  //  EndBarLine:         at the end tick of a measure</a>
<a name="ln1606">                  //  BeginBarLine:       first segment of a measure</a>
<a name="ln1607"> </a>
<a name="ln1608">                  SegmentType st;</a>
<a name="ln1609">                  if ((e.tick() != m-&gt;tick()) &amp;&amp; (e.tick() != m-&gt;endTick()))</a>
<a name="ln1610">                        st = SegmentType::BarLine;</a>
<a name="ln1611">                  else if (barLine-&gt;barLineType() == BarLineType::START_REPEAT &amp;&amp; e.tick() == m-&gt;tick())</a>
<a name="ln1612">                        st = SegmentType::StartRepeatBarLine;</a>
<a name="ln1613">                  else if (e.tick() == m-&gt;tick() &amp;&amp; segment == 0)</a>
<a name="ln1614">                        st = SegmentType::BeginBarLine;</a>
<a name="ln1615">                  else</a>
<a name="ln1616">                        st = SegmentType::EndBarLine;</a>
<a name="ln1617">                  segment = m-&gt;getSegment(st, e.tick());</a>
<a name="ln1618">                  segment-&gt;add(barLine);</a>
<a name="ln1619">                  }</a>
<a name="ln1620">            else if (tag == &quot;Chord&quot;) {</a>
<a name="ln1621">                  Chord* chord = new Chord(m-&gt;score());</a>
<a name="ln1622">                  chord-&gt;setTrack(e.track());</a>
<a name="ln1623">                  readChord(m, chord, e);</a>
<a name="ln1624">                  if (!chord-&gt;segment())</a>
<a name="ln1625">                        chord-&gt;setParent(m-&gt;getSegment(SegmentType::ChordRest, e.tick()));</a>
<a name="ln1626">                  segment = chord-&gt;segment();</a>
<a name="ln1627">                  if (chord-&gt;noteType() != NoteType::NORMAL) {</a>
<a name="ln1628">                        graceNotes.push_back(chord);</a>
<a name="ln1629">                        }</a>
<a name="ln1630">                  else {</a>
<a name="ln1631">                        segment-&gt;add(chord);</a>
<a name="ln1632">                        Q_ASSERT(segment-&gt;segmentType() == SegmentType::ChordRest);</a>
<a name="ln1633"> </a>
<a name="ln1634">                        for (int i = 0; i &lt; graceNotes.size(); ++i) {</a>
<a name="ln1635">                              Chord* gc = graceNotes[i];</a>
<a name="ln1636">                              gc-&gt;setGraceIndex(i);</a>
<a name="ln1637">                              chord-&gt;add(gc);</a>
<a name="ln1638">                              }</a>
<a name="ln1639">                        graceNotes.clear();</a>
<a name="ln1640">                        Fraction crticks = chord-&gt;actualTicks();</a>
<a name="ln1641"> </a>
<a name="ln1642">                        if (chord-&gt;tremolo()) {</a>
<a name="ln1643">                              Tremolo* tremolo = chord-&gt;tremolo();</a>
<a name="ln1644">                              if (tremolo-&gt;twoNotes()) {</a>
<a name="ln1645">                                    int track = chord-&gt;track();</a>
<a name="ln1646">                                    Segment* ss = 0;</a>
<a name="ln1647">                                    for (Segment* ps = m-&gt;first(SegmentType::ChordRest); ps; ps = ps-&gt;next(SegmentType::ChordRest)) {</a>
<a name="ln1648">                                          if (ps-&gt;tick() &gt;= e.tick())</a>
<a name="ln1649">                                                break;</a>
<a name="ln1650">                                          if (ps-&gt;element(track))</a>
<a name="ln1651">                                                ss = ps;</a>
<a name="ln1652">                                          }</a>
<a name="ln1653">                                    Chord* pch = 0;       // previous chord</a>
<a name="ln1654">                                    if (ss) {</a>
<a name="ln1655">                                          ChordRest* cr = toChordRest(ss-&gt;element(track));</a>
<a name="ln1656">                                          if (cr &amp;&amp; cr-&gt;type() == ElementType::CHORD)</a>
<a name="ln1657">                                                pch = toChord(cr);</a>
<a name="ln1658">                                          }</a>
<a name="ln1659">                                    if (pch) {</a>
<a name="ln1660">                                          tremolo-&gt;setParent(pch);</a>
<a name="ln1661">                                          pch-&gt;setTremolo(tremolo);</a>
<a name="ln1662">                                          chord-&gt;setTremolo(0);</a>
<a name="ln1663">                                          // force duration to half</a>
<a name="ln1664">                                          Fraction pts(timeStretch * pch-&gt;globalTicks());</a>
<a name="ln1665">                                          pch-&gt;setTicks(pts * Fraction(1,2));</a>
<a name="ln1666">                                          chord-&gt;setTicks(crticks * Fraction(1,2));</a>
<a name="ln1667">                                          }</a>
<a name="ln1668">                                    else {</a>
<a name="ln1669">                                          qDebug(&quot;tremolo: first note not found&quot;);</a>
<a name="ln1670">                                          }</a>
<a name="ln1671">                                    crticks = crticks * Fraction(1,2);</a>
<a name="ln1672">                                    }</a>
<a name="ln1673">                              else {</a>
<a name="ln1674">                                    tremolo-&gt;setParent(chord);</a>
<a name="ln1675">                                    }</a>
<a name="ln1676">                              }</a>
<a name="ln1677">                        lastTick = e.tick();</a>
<a name="ln1678">                        e.incTick(crticks);</a>
<a name="ln1679">                        }</a>
<a name="ln1680">                  }</a>
<a name="ln1681">            else if (tag == &quot;Rest&quot;) {</a>
<a name="ln1682">                  Rest* rest = new Rest(m-&gt;score());</a>
<a name="ln1683">                  rest-&gt;setDurationType(TDuration::DurationType::V_MEASURE);</a>
<a name="ln1684">                  rest-&gt;setTicks(m-&gt;timesig()/timeStretch);</a>
<a name="ln1685">                  rest-&gt;setTrack(e.track());</a>
<a name="ln1686">                  readRest(m, rest, e);</a>
<a name="ln1687">                  if (!rest-&gt;segment())</a>
<a name="ln1688">                        rest-&gt;setParent(m-&gt;getSegment(SegmentType::ChordRest, e.tick()));</a>
<a name="ln1689">                  segment = rest-&gt;segment();</a>
<a name="ln1690">                  segment-&gt;add(rest);</a>
<a name="ln1691"> </a>
<a name="ln1692">                  if (!rest-&gt;ticks().isValid())     // hack</a>
<a name="ln1693">                        rest-&gt;setTicks(m-&gt;timesig()/timeStretch);</a>
<a name="ln1694"> </a>
<a name="ln1695">                  lastTick = e.tick();</a>
<a name="ln1696">                  e.incTick(rest-&gt;actualTicks());</a>
<a name="ln1697">                  }</a>
<a name="ln1698">            else if (tag == &quot;Breath&quot;) {</a>
<a name="ln1699">                  Breath* breath = new Breath(m-&gt;score());</a>
<a name="ln1700">                  breath-&gt;setTrack(e.track());</a>
<a name="ln1701">                  Fraction tick = e.tick();</a>
<a name="ln1702">                  breath-&gt;read(e);</a>
<a name="ln1703">                  // older scores placed the breath segment right after the chord to which it applies</a>
<a name="ln1704">                  // rather than before the next chordrest segment with an element for the staff</a>
<a name="ln1705">                  // result would be layout too far left if there are other segments due to notes in other staves</a>
<a name="ln1706">                  // we need to find tick of chord to which this applies, and add its duration</a>
<a name="ln1707">                  Fraction prevTick;</a>
<a name="ln1708">                  if (e.tick() &lt; tick)</a>
<a name="ln1709">                        prevTick = e.tick();    // use our own tick if we explicitly reset to earlier position</a>
<a name="ln1710">                  else</a>
<a name="ln1711">                        prevTick = lastTick;    // otherwise use tick of previous tick/chord/rest tag</a>
<a name="ln1712">                  // find segment</a>
<a name="ln1713">                  Segment* prev = m-&gt;findSegment(SegmentType::ChordRest, prevTick);</a>
<a name="ln1714">                  if (prev) {</a>
<a name="ln1715">                        // find chordrest</a>
<a name="ln1716">                        ChordRest* lastCR = toChordRest(prev-&gt;element(e.track()));</a>
<a name="ln1717">                        if (lastCR)</a>
<a name="ln1718">                              tick = prevTick + lastCR-&gt;actualTicks();</a>
<a name="ln1719">                        }</a>
<a name="ln1720">                  segment = m-&gt;getSegment(SegmentType::Breath, tick);</a>
<a name="ln1721">                  segment-&gt;add(breath);</a>
<a name="ln1722">                  }</a>
<a name="ln1723">            else if (tag == &quot;endSpanner&quot;) {</a>
<a name="ln1724">                  int id = e.attribute(&quot;id&quot;).toInt();</a>
<a name="ln1725">                  Spanner* spanner = e.findSpanner(id);</a>
<a name="ln1726">                  if (spanner) {</a>
<a name="ln1727">                        spanner-&gt;setTicks(e.tick() - spanner-&gt;tick());</a>
<a name="ln1728">                        // if (spanner-&gt;track2() == -1)</a>
<a name="ln1729">                              // the absence of a track tag [?] means the</a>
<a name="ln1730">                              // track is the same as the beginning of the slur</a>
<a name="ln1731">                        if (spanner-&gt;track2() == -1)</a>
<a name="ln1732">                              spanner-&gt;setTrack2(spanner-&gt;track() ? spanner-&gt;track() : e.track());</a>
<a name="ln1733">                        }</a>
<a name="ln1734">                  else {</a>
<a name="ln1735">                        // remember &quot;endSpanner&quot; values</a>
<a name="ln1736">                        SpannerValues sv;</a>
<a name="ln1737">                        sv.spannerId = id;</a>
<a name="ln1738">                        sv.track2    = e.track();</a>
<a name="ln1739">                        sv.tick2     = e.tick();</a>
<a name="ln1740">                        e.addSpannerValues(sv);</a>
<a name="ln1741">                        }</a>
<a name="ln1742">                  e.readNext();</a>
<a name="ln1743">                  }</a>
<a name="ln1744">            else if (tag == &quot;Slur&quot;) {</a>
<a name="ln1745">                  Slur *sl = new Slur(m-&gt;score());</a>
<a name="ln1746">                  sl-&gt;setTick(e.tick());</a>
<a name="ln1747">                  readSlur206(e, sl);</a>
<a name="ln1748">                  //</a>
<a name="ln1749">                  // check if we already saw &quot;endSpanner&quot;</a>
<a name="ln1750">                  //</a>
<a name="ln1751">                  int id = e.spannerId(sl);</a>
<a name="ln1752">                  const SpannerValues* sv = e.spannerValues(id);</a>
<a name="ln1753">                  if (sv) {</a>
<a name="ln1754">                        sl-&gt;setTick2(sv-&gt;tick2);</a>
<a name="ln1755">                        sl-&gt;setTrack2(sv-&gt;track2);</a>
<a name="ln1756">                        }</a>
<a name="ln1757">                  m-&gt;score()-&gt;addSpanner(sl);</a>
<a name="ln1758">                  }</a>
<a name="ln1759">            else if (tag == &quot;HairPin&quot;</a>
<a name="ln1760">               || tag == &quot;Pedal&quot;</a>
<a name="ln1761">               || tag == &quot;Ottava&quot;</a>
<a name="ln1762">               || tag == &quot;Trill&quot;</a>
<a name="ln1763">               || tag == &quot;TextLine&quot;</a>
<a name="ln1764">               || tag == &quot;Volta&quot;) {</a>
<a name="ln1765">                  Spanner* sp = toSpanner(Element::name2Element(tag, m-&gt;score()));</a>
<a name="ln1766">                  sp-&gt;setTrack(e.track());</a>
<a name="ln1767">                  sp-&gt;setTick(e.tick());</a>
<a name="ln1768">                  // ?? sp-&gt;setAnchor(Spanner::Anchor::SEGMENT);</a>
<a name="ln1769">                  if (tag == &quot;Volta&quot;)</a>
<a name="ln1770">                        readVolta114(e, toVolta(sp));</a>
<a name="ln1771">                  else</a>
<a name="ln1772">                        readTextLine206(e, toTextLineBase(sp));</a>
<a name="ln1773">                  m-&gt;score()-&gt;addSpanner(sp);</a>
<a name="ln1774">                  //</a>
<a name="ln1775">                  // check if we already saw &quot;endSpanner&quot;</a>
<a name="ln1776">                  //</a>
<a name="ln1777">                  int id = e.spannerId(sp);</a>
<a name="ln1778">                  const SpannerValues* sv = e.spannerValues(id);</a>
<a name="ln1779">                  if (sv) {</a>
<a name="ln1780">                        sp-&gt;setTicks(sv-&gt;tick2 - sp-&gt;tick());</a>
<a name="ln1781">                        sp-&gt;setTrack2(sv-&gt;track2);</a>
<a name="ln1782">                        }</a>
<a name="ln1783">                  }</a>
<a name="ln1784">            else if (tag == &quot;RepeatMeasure&quot;) {</a>
<a name="ln1785">                  RepeatMeasure* rm = new RepeatMeasure(m-&gt;score());</a>
<a name="ln1786">                  rm-&gt;setTrack(e.track());</a>
<a name="ln1787">                  readRest(m, rm, e);</a>
<a name="ln1788">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln1789">                  segment-&gt;add(rm);</a>
<a name="ln1790">                  if (rm-&gt;actualTicks().isZero()) // might happen with 1.3 scores</a>
<a name="ln1791">                        rm-&gt;setTicks(m-&gt;ticks());</a>
<a name="ln1792">                  lastTick = e.tick();</a>
<a name="ln1793">                  e.incTick(m-&gt;ticks());</a>
<a name="ln1794">                  }</a>
<a name="ln1795">            else if (tag == &quot;Clef&quot;) {</a>
<a name="ln1796">                  Clef* clef = new Clef(m-&gt;score());</a>
<a name="ln1797">                  clef-&gt;setTrack(e.track());</a>
<a name="ln1798">                  readClef(clef, e);</a>
<a name="ln1799">                  if (m-&gt;score()-&gt;mscVersion() &lt; 113)</a>
<a name="ln1800">                        clef-&gt;setOffset(QPointF());</a>
<a name="ln1801">                  clef-&gt;setGenerated(false);</a>
<a name="ln1802">                  // MS3 doesn't support wrong clef for staff type: Default to G</a>
<a name="ln1803">                  bool isDrumStaff = staff-&gt;isDrumStaff(e.tick());</a>
<a name="ln1804">                  if (clef-&gt;clefType() == ClefType::TAB</a>
<a name="ln1805">                      || (clef-&gt;clefType() == ClefType::PERC &amp;&amp; !isDrumStaff)</a>
<a name="ln1806">                      || (clef-&gt;clefType() != ClefType::PERC &amp;&amp; isDrumStaff)) {</a>
<a name="ln1807">                        clef-&gt;setClefType(ClefType::G);</a>
<a name="ln1808">                        staff-&gt;clefList().erase(e.tick().ticks());</a>
<a name="ln1809">                        staff-&gt;clefList().insert(std::pair&lt;int,ClefType&gt;(e.tick().ticks(), ClefType::G));</a>
<a name="ln1810">                        }</a>
<a name="ln1811"> </a>
<a name="ln1812">                  // there may be more than one clef segment for same tick position</a>
<a name="ln1813">                  // the first clef may be missing and is added later in layout</a>
<a name="ln1814"> </a>
<a name="ln1815">                  bool header;</a>
<a name="ln1816">                  if (e.tick() != m-&gt;tick())</a>
<a name="ln1817">                        header = false;</a>
<a name="ln1818">                  else if (!segment)</a>
<a name="ln1819">                        header = true;</a>
<a name="ln1820">                  else {</a>
<a name="ln1821">                        header = true;</a>
<a name="ln1822">                        for (Segment* s = m-&gt;segments().first(); s &amp;&amp; s-&gt;rtick().isZero(); s = s-&gt;next()) {</a>
<a name="ln1823">                              if (s-&gt;isKeySigType() || s-&gt;isTimeSigType()) {</a>
<a name="ln1824">                                    // hack: there may be other segment types which should</a>
<a name="ln1825">                                    // generate a clef at current position</a>
<a name="ln1826">                                    header = false;</a>
<a name="ln1827">                                    break;</a>
<a name="ln1828">                                    }</a>
<a name="ln1829">                              }</a>
<a name="ln1830">                        }</a>
<a name="ln1831">                  segment = m-&gt;getSegment(header ? SegmentType::HeaderClef : SegmentType::Clef, e.tick());</a>
<a name="ln1832">                  segment-&gt;add(clef);</a>
<a name="ln1833">                  }</a>
<a name="ln1834">            else if (tag == &quot;TimeSig&quot;) {</a>
<a name="ln1835">                  TimeSig* ts = new TimeSig(m-&gt;score());</a>
<a name="ln1836">                  ts-&gt;setTrack(e.track());</a>
<a name="ln1837">                  ts-&gt;read(e);</a>
<a name="ln1838">                  // if time sig not at beginning of measure =&gt; courtesy time sig</a>
<a name="ln1839">                  Fraction currTick = e.tick();</a>
<a name="ln1840">                  bool courtesySig = (currTick &gt; m-&gt;tick());</a>
<a name="ln1841">                  if (courtesySig) {</a>
<a name="ln1842">                        // if courtesy sig., just add it without map processing</a>
<a name="ln1843">                        segment = m-&gt;getSegment(SegmentType::TimeSigAnnounce, currTick);</a>
<a name="ln1844">                        segment-&gt;add(ts);</a>
<a name="ln1845">                        }</a>
<a name="ln1846">                  else {</a>
<a name="ln1847">                        // if 'real' time sig., do full process</a>
<a name="ln1848">                        segment = m-&gt;getSegment(SegmentType::TimeSig, currTick);</a>
<a name="ln1849">                        segment-&gt;add(ts);</a>
<a name="ln1850"> </a>
<a name="ln1851">                        timeStretch = ts-&gt;stretch().reduced();</a>
<a name="ln1852">                        m-&gt;setTimesig(ts-&gt;sig() / timeStretch);</a>
<a name="ln1853">                        }</a>
<a name="ln1854">                  }</a>
<a name="ln1855">            else if (tag == &quot;KeySig&quot;) {</a>
<a name="ln1856">                  KeySig* ks = new KeySig(m-&gt;score());</a>
<a name="ln1857">                  ks-&gt;setTrack(e.track());</a>
<a name="ln1858">                  ks-&gt;read(e);</a>
<a name="ln1859">                  Fraction curTick = e.tick();</a>
<a name="ln1860">                  if (!ks-&gt;isCustom() &amp;&amp; !ks-&gt;isAtonal() &amp;&amp; ks-&gt;key() == Key::C &amp;&amp; curTick.isZero()) {</a>
<a name="ln1861">                        // ignore empty key signature</a>
<a name="ln1862">                        qDebug(&quot;remove keysig c at tick 0&quot;);</a>
<a name="ln1863">                        if (ks-&gt;links()) {</a>
<a name="ln1864">                              if (ks-&gt;links()-&gt;size() == 1)</a>
<a name="ln1865">                                    e.linkIds().remove(ks-&gt;links()-&gt;lid());</a>
<a name="ln1866">                              }</a>
<a name="ln1867">                        }</a>
<a name="ln1868">                  else {</a>
<a name="ln1869">                        // if key sig not at beginning of measure =&gt; courtesy key sig</a>
<a name="ln1870">                        bool courtesySig = (curTick == m-&gt;endTick());</a>
<a name="ln1871">                        segment = m-&gt;getSegment(courtesySig ? SegmentType::KeySigAnnounce : SegmentType::KeySig, curTick);</a>
<a name="ln1872">                        segment-&gt;add(ks);</a>
<a name="ln1873">                        if (!courtesySig)</a>
<a name="ln1874">                              staff-&gt;setKey(curTick, ks-&gt;keySigEvent());</a>
<a name="ln1875">                        }</a>
<a name="ln1876">                  }</a>
<a name="ln1877">            else if (tag == &quot;Lyrics&quot;) {</a>
<a name="ln1878">                  Lyrics* l = new Lyrics(m-&gt;score());</a>
<a name="ln1879">                  l-&gt;setTrack(e.track());</a>
<a name="ln1880"> </a>
<a name="ln1881">                  int iEndTick = 0;           // used for backward compatibility</a>
<a name="ln1882">                  Text* _verseNumber = 0;</a>
<a name="ln1883"> </a>
<a name="ln1884">                  while (e.readNextStartElement()) {</a>
<a name="ln1885">                        const QStringRef&amp; t(e.name());</a>
<a name="ln1886">                        if (t == &quot;no&quot;)</a>
<a name="ln1887">                              l-&gt;setNo(e.readInt());</a>
<a name="ln1888">                        else if (t == &quot;syllabic&quot;) {</a>
<a name="ln1889">                              QString val(e.readElementText());</a>
<a name="ln1890">                              if (val == &quot;single&quot;)</a>
<a name="ln1891">                                    l-&gt;setSyllabic(Lyrics::Syllabic::SINGLE);</a>
<a name="ln1892">                              else if (val == &quot;begin&quot;)</a>
<a name="ln1893">                                    l-&gt;setSyllabic(Lyrics::Syllabic::BEGIN);</a>
<a name="ln1894">                              else if (val == &quot;end&quot;)</a>
<a name="ln1895">                                    l-&gt;setSyllabic(Lyrics::Syllabic::END);</a>
<a name="ln1896">                              else if (val == &quot;middle&quot;)</a>
<a name="ln1897">                                    l-&gt;setSyllabic(Lyrics::Syllabic::MIDDLE);</a>
<a name="ln1898">                              else</a>
<a name="ln1899">                                    qDebug(&quot;bad syllabic property&quot;);</a>
<a name="ln1900">                              }</a>
<a name="ln1901">                        else if (t == &quot;endTick&quot;) {          // obsolete</a>
<a name="ln1902">                              // store &lt;endTick&gt; tag value until a &lt;ticks&gt; tag has been read</a>
<a name="ln1903">                              // which positions this lyrics element in the score</a>
<a name="ln1904">                              iEndTick = e.readInt();</a>
<a name="ln1905">                              }</a>
<a name="ln1906">                        else if (t == &quot;ticks&quot;)</a>
<a name="ln1907">                              l-&gt;setTicks(Fraction::fromTicks(e.readInt()));</a>
<a name="ln1908">                        else if (t == &quot;Number&quot;) {                           // obsolete</a>
<a name="ln1909">                              _verseNumber = new Text(l-&gt;score());</a>
<a name="ln1910">                              readText114(e, _verseNumber, l);</a>
<a name="ln1911">                              _verseNumber-&gt;setParent(l);</a>
<a name="ln1912">                              }</a>
<a name="ln1913">                        else if (!readTextProperties(e, l, l))</a>
<a name="ln1914">                              e.unknown();</a>
<a name="ln1915">                        }</a>
<a name="ln1916">                  // if any endTick, make it relative to current tick</a>
<a name="ln1917">                  if (iEndTick) {</a>
<a name="ln1918">                        l-&gt;setTicks(Fraction::fromTicks(iEndTick - e.tick().ticks()));</a>
<a name="ln1919">                        // qDebug(&quot;Lyrics::endTick: %d  ticks %d&quot;, iEndTick, _ticks);</a>
<a name="ln1920">                        }</a>
<a name="ln1921">                  if (_verseNumber) {</a>
<a name="ln1922">                        // TODO: add text to main text</a>
<a name="ln1923">                        }</a>
<a name="ln1924"> </a>
<a name="ln1925">                  delete _verseNumber;</a>
<a name="ln1926"> </a>
<a name="ln1927">                  segment       = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln1928">                  ChordRest* cr = toChordRest(segment-&gt;element(l-&gt;track()));</a>
<a name="ln1929">                  if (!cr)</a>
<a name="ln1930">                        cr = toChordRest(segment-&gt;element(e.track())); // in case lyric itself has bad track info</a>
<a name="ln1931">                  if (!cr)</a>
<a name="ln1932">                        qDebug(&quot;Internal error: no chord/rest for lyrics&quot;);</a>
<a name="ln1933">                  else</a>
<a name="ln1934">                        cr-&gt;add(l);</a>
<a name="ln1935">                  }</a>
<a name="ln1936">            else if (tag == &quot;Text&quot;) {</a>
<a name="ln1937">                  StaffText* t = new StaffText(m-&gt;score());</a>
<a name="ln1938">                  t-&gt;setTrack(e.track());</a>
<a name="ln1939">                  readStaffText(t, e);</a>
<a name="ln1940">                  if (t-&gt;empty()) {</a>
<a name="ln1941">                        qDebug(&quot;reading empty text: deleted&quot;);</a>
<a name="ln1942">                        delete t;</a>
<a name="ln1943">                        }</a>
<a name="ln1944">                  else {</a>
<a name="ln1945">                        segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln1946">                        segment-&gt;add(t);</a>
<a name="ln1947">                        }</a>
<a name="ln1948">                  }</a>
<a name="ln1949">            else if (tag == &quot;Dynamic&quot;) {</a>
<a name="ln1950">                  Dynamic* dyn = new Dynamic(m-&gt;score());</a>
<a name="ln1951">                  dyn-&gt;setTrack(e.track());</a>
<a name="ln1952">                  dyn-&gt;read(e);</a>
<a name="ln1953">                  dyn-&gt;setDynamicType(dyn-&gt;xmlText());</a>
<a name="ln1954">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln1955">                  segment-&gt;add(dyn);</a>
<a name="ln1956">                  }</a>
<a name="ln1957">            else if (tag == &quot;Tempo&quot;) {</a>
<a name="ln1958">                  TempoText* t = new TempoText(m-&gt;score());</a>
<a name="ln1959">                  t-&gt;setTrack(e.track());</a>
<a name="ln1960">                  readTempoText(t, e);</a>
<a name="ln1961">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln1962">                  segment-&gt;add(t);</a>
<a name="ln1963">                  }</a>
<a name="ln1964">            else if (tag == &quot;StaffText&quot;) {</a>
<a name="ln1965">                  StaffText* t = new StaffText(m-&gt;score());</a>
<a name="ln1966">                  t-&gt;setTrack(e.track());</a>
<a name="ln1967">                  readStaffText(t, e);</a>
<a name="ln1968">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln1969">                  segment-&gt;add(t);</a>
<a name="ln1970">                  }</a>
<a name="ln1971">            else if (tag == &quot;Harmony&quot;) {</a>
<a name="ln1972">                  Harmony* h = new Harmony(m-&gt;score());</a>
<a name="ln1973">                  h-&gt;setTrack(e.track());</a>
<a name="ln1974">                  readHarmony114(e, h);</a>
<a name="ln1975">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln1976">                  segment-&gt;add(h);</a>
<a name="ln1977">                  }</a>
<a name="ln1978">            else if (tag == &quot;Harmony&quot;</a>
<a name="ln1979">               || tag == &quot;FretDiagram&quot;</a>
<a name="ln1980">               || tag == &quot;TremoloBar&quot;</a>
<a name="ln1981">               || tag == &quot;Symbol&quot;</a>
<a name="ln1982">               || tag == &quot;StaffText&quot;</a>
<a name="ln1983">               || tag == &quot;RehearsalMark&quot;</a>
<a name="ln1984">               || tag == &quot;InstrumentChange&quot;</a>
<a name="ln1985">               || tag == &quot;StaffState&quot;</a>
<a name="ln1986">               ) {</a>
<a name="ln1987">                  Element* el = Element::name2Element(tag, m-&gt;score());</a>
<a name="ln1988">                  // hack - needed because tick tags are unreliable in 1.3 scores</a>
<a name="ln1989">                  // for symbols attached to anything but a measure</a>
<a name="ln1990">                  if (el-&gt;type() == ElementType::SYMBOL)</a>
<a name="ln1991">                        el-&gt;setParent(m);    // this will get reset when adding to segment</a>
<a name="ln1992">                  el-&gt;setTrack(e.track());</a>
<a name="ln1993">                  el-&gt;read(e);</a>
<a name="ln1994">                  segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln1995">                  segment-&gt;add(el);</a>
<a name="ln1996">                  }</a>
<a name="ln1997">            else if (tag == &quot;Jump&quot;) {</a>
<a name="ln1998">                  Jump* j = new Jump(m-&gt;score());</a>
<a name="ln1999">                  j-&gt;setTrack(e.track());</a>
<a name="ln2000">                  while (e.readNextStartElement()) {</a>
<a name="ln2001">                        const QStringRef&amp; t(e.name());</a>
<a name="ln2002">                        if (t == &quot;jumpTo&quot;)</a>
<a name="ln2003">                              j-&gt;setJumpTo(e.readElementText());</a>
<a name="ln2004">                        else if (t == &quot;playUntil&quot;)</a>
<a name="ln2005">                              j-&gt;setPlayUntil(e.readElementText());</a>
<a name="ln2006">                        else if (t == &quot;continueAt&quot;)</a>
<a name="ln2007">                              j-&gt;setContinueAt(e.readElementText());</a>
<a name="ln2008">                        else if (t == &quot;playRepeats&quot;)</a>
<a name="ln2009">                              j-&gt;setPlayRepeats(e.readBool());</a>
<a name="ln2010">                        else if (t == &quot;subtype&quot;)</a>
<a name="ln2011">                              e.readInt();</a>
<a name="ln2012">                        else if (!j-&gt;TextBase::readProperties(e))</a>
<a name="ln2013">                              e.unknown();</a>
<a name="ln2014">                        }</a>
<a name="ln2015">                  m-&gt;add(j);</a>
<a name="ln2016">                  }</a>
<a name="ln2017">            else if (tag == &quot;Marker&quot;) {</a>
<a name="ln2018">                  Marker* a = new Marker(m-&gt;score());</a>
<a name="ln2019">                  a-&gt;setTrack(e.track());</a>
<a name="ln2020"> </a>
<a name="ln2021">                  Marker::Type mt = Marker::Type::SEGNO;</a>
<a name="ln2022">                  while (e.readNextStartElement()) {</a>
<a name="ln2023">                        const QStringRef&amp; t(e.name());</a>
<a name="ln2024">                        if (t == &quot;subtype&quot;) {</a>
<a name="ln2025">                              QString s(e.readElementText());</a>
<a name="ln2026">                              a-&gt;setLabel(s);</a>
<a name="ln2027">                              mt = a-&gt;markerType(s);</a>
<a name="ln2028">                              }</a>
<a name="ln2029">                        else if (!a-&gt;TextBase::readProperties(e))</a>
<a name="ln2030">                              e.unknown();</a>
<a name="ln2031">                        }</a>
<a name="ln2032">                  a-&gt;setMarkerType(mt);</a>
<a name="ln2033"> </a>
<a name="ln2034">                  if (a-&gt;markerType() == Marker::Type::SEGNO || a-&gt;markerType() == Marker::Type::CODA  ||</a>
<a name="ln2035">                      a-&gt;markerType() == Marker::Type::VARCODA || a-&gt;markerType() == Marker::Type::CODETTA) {</a>
<a name="ln2036">                        // force the marker type for correct display</a>
<a name="ln2037">                        a-&gt;setXmlText(&quot;&quot;);</a>
<a name="ln2038">                        a-&gt;setMarkerType(a-&gt;markerType());</a>
<a name="ln2039">//TODO::ws                        a-&gt;initElementStyle(Tid::REPEAT_LEFT);</a>
<a name="ln2040">                        }</a>
<a name="ln2041">                  m-&gt;add(a);</a>
<a name="ln2042">                  }</a>
<a name="ln2043">            else if (tag == &quot;Image&quot;) {</a>
<a name="ln2044">                  if (MScore::noImages)</a>
<a name="ln2045">                        e.skipCurrentElement();</a>
<a name="ln2046">                  else {</a>
<a name="ln2047">                        Element* el = Element::name2Element(tag, m-&gt;score());</a>
<a name="ln2048">                        el-&gt;setTrack(e.track());</a>
<a name="ln2049">                        el-&gt;read(e);</a>
<a name="ln2050">                        segment = m-&gt;getSegment(SegmentType::ChordRest, e.tick());</a>
<a name="ln2051">                        segment-&gt;add(el);</a>
<a name="ln2052">                        }</a>
<a name="ln2053">                  }</a>
<a name="ln2054">            else if (tag == &quot;stretch&quot;) {</a>
<a name="ln2055">                  double val = e.readDouble();</a>
<a name="ln2056">                  if (val &lt; 0.0)</a>
<a name="ln2057">                        val = 0;</a>
<a name="ln2058">                  m-&gt;setUserStretch(val);</a>
<a name="ln2059">                  }</a>
<a name="ln2060">            else if (tag == &quot;noOffset&quot;)</a>
<a name="ln2061">                  m-&gt;setNoOffset(e.readInt());</a>
<a name="ln2062">            else if (tag == &quot;measureNumberMode&quot;)</a>
<a name="ln2063">                  m-&gt;setMeasureNumberMode(MeasureNumberMode(e.readInt()));</a>
<a name="ln2064">            else if (tag == &quot;irregular&quot;)</a>
<a name="ln2065">                  m-&gt;setIrregular(e.readBool());</a>
<a name="ln2066">            else if (tag == &quot;breakMultiMeasureRest&quot;)</a>
<a name="ln2067">                  m-&gt;setBreakMultiMeasureRest(e.readBool());</a>
<a name="ln2068">            else if (tag == &quot;sysInitBarLineType&quot;) {</a>
<a name="ln2069">                  const QString&amp; val(e.readElementText());</a>
<a name="ln2070">                  BarLine* barLine = new BarLine(m-&gt;score());</a>
<a name="ln2071">                  barLine-&gt;setTrack(e.track());</a>
<a name="ln2072">                  barLine-&gt;setBarLineType(val);</a>
<a name="ln2073">                  segment = m-&gt;getSegment(SegmentType::BeginBarLine, m-&gt;tick());</a>
<a name="ln2074">                  segment-&gt;add(barLine);</a>
<a name="ln2075">                  }</a>
<a name="ln2076">            else if (tag == &quot;Tuplet&quot;) {</a>
<a name="ln2077">                  Tuplet* tuplet = new Tuplet(m-&gt;score());</a>
<a name="ln2078">                  tuplet-&gt;setTrack(e.track());</a>
<a name="ln2079">                  tuplet-&gt;setTick(e.tick());</a>
<a name="ln2080">                  tuplet-&gt;setParent(m);</a>
<a name="ln2081">                  readTuplet(tuplet, e);</a>
<a name="ln2082">                  e.addTuplet(tuplet);</a>
<a name="ln2083">                  }</a>
<a name="ln2084">            else if (tag == &quot;startRepeat&quot;) {</a>
<a name="ln2085">                  m-&gt;setRepeatStart(true);</a>
<a name="ln2086">                  e.readNext();</a>
<a name="ln2087">                  }</a>
<a name="ln2088">            else if (tag == &quot;endRepeat&quot;) {</a>
<a name="ln2089">                  m-&gt;setRepeatCount(e.readInt());</a>
<a name="ln2090">                  m-&gt;setRepeatEnd(true);</a>
<a name="ln2091">                  }</a>
<a name="ln2092">            else if (tag == &quot;vspacer&quot; || tag == &quot;vspacerDown&quot;) {</a>
<a name="ln2093">                  if (!m-&gt;vspacerDown(staffIdx)) {</a>
<a name="ln2094">                        Spacer* spacer = new Spacer(m-&gt;score());</a>
<a name="ln2095">                        spacer-&gt;setSpacerType(SpacerType::DOWN);</a>
<a name="ln2096">                        spacer-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln2097">                        m-&gt;add(spacer);</a>
<a name="ln2098">                        }</a>
<a name="ln2099">                  m-&gt;vspacerDown(staffIdx)-&gt;setGap(e.readDouble() * _spatium);</a>
<a name="ln2100">                  }</a>
<a name="ln2101">            else if (tag == &quot;vspacer&quot; || tag == &quot;vspacerUp&quot;) {</a>
<a name="ln2102">                  if (!m-&gt;vspacerUp(staffIdx)) {</a>
<a name="ln2103">                        Spacer* spacer = new Spacer(m-&gt;score());</a>
<a name="ln2104">                        spacer-&gt;setSpacerType(SpacerType::UP);</a>
<a name="ln2105">                        spacer-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln2106">                        m-&gt;add(spacer);</a>
<a name="ln2107">                        }</a>
<a name="ln2108">                  m-&gt;vspacerUp(staffIdx)-&gt;setGap(e.readDouble() * _spatium);</a>
<a name="ln2109">                  }</a>
<a name="ln2110">            else if (tag == &quot;visible&quot;)</a>
<a name="ln2111">                  m-&gt;setStaffVisible(staffIdx, e.readInt());</a>
<a name="ln2112">            else if (tag == &quot;slashStyle&quot;)</a>
<a name="ln2113">                  m-&gt;setStaffStemless(staffIdx, e.readInt());</a>
<a name="ln2114">            else if (tag == &quot;Beam&quot;) {</a>
<a name="ln2115">                  Beam* beam = new Beam(m-&gt;score());</a>
<a name="ln2116">                  beam-&gt;setTrack(e.track());</a>
<a name="ln2117">                  beam-&gt;read(e);</a>
<a name="ln2118">                  beam-&gt;setParent(0);</a>
<a name="ln2119">                  e.addBeam(beam);</a>
<a name="ln2120">                  }</a>
<a name="ln2121">            else if (tag == &quot;Segment&quot;) {</a>
<a name="ln2122">                  segment-&gt;read(e);</a>
<a name="ln2123">                  while (e.readNextStartElement()) {</a>
<a name="ln2124">                        const QStringRef&amp; t(e.name());</a>
<a name="ln2125">                        if (t == &quot;off1&quot;) {</a>
<a name="ln2126">                              qreal o = e.readDouble();</a>
<a name="ln2127">                              qDebug(&quot;TODO: off1 %f&quot;, o);</a>
<a name="ln2128">                              }</a>
<a name="ln2129">                        else</a>
<a name="ln2130">                              e.unknown();</a>
<a name="ln2131">                        }</a>
<a name="ln2132">                  }</a>
<a name="ln2133">            else if (tag == &quot;MeasureNumber&quot;) {</a>
<a name="ln2134">                  MeasureNumber* noText = new MeasureNumber(m-&gt;score());</a>
<a name="ln2135">                  readText114(e, noText, m);</a>
<a name="ln2136">                  noText-&gt;setTrack(e.track());</a>
<a name="ln2137">                  noText-&gt;setParent(m);</a>
<a name="ln2138">                  m-&gt;setNoText(noText-&gt;staffIdx(), noText);</a>
<a name="ln2139">                  }</a>
<a name="ln2140">            else if (tag == &quot;multiMeasureRest&quot;) {</a>
<a name="ln2141">                  m-&gt;setMMRestCount(e.readInt());</a>
<a name="ln2142">                  // set tick to previous measure</a>
<a name="ln2143">                  m-&gt;setTick(e.lastMeasure()-&gt;tick());</a>
<a name="ln2144">                  e.setTick(e.lastMeasure()-&gt;tick());</a>
<a name="ln2145">                  }</a>
<a name="ln2146">            else if (m-&gt;MeasureBase::readProperties(e))</a>
<a name="ln2147">                  ;</a>
<a name="ln2148">            else</a>
<a name="ln2149">                  e.unknown();</a>
<a name="ln2150">            }</a>
<a name="ln2151">      // For nested tuplets created with MuseScore 1.3 tuplet dialog (i.e. &quot;Other...&quot; dialog),</a>
<a name="ln2152">      // the parent tuplet was not set. Try to infere if the tuplet was actually a nested tuplet</a>
<a name="ln2153">      for (Tuplet* tuplet : e.tuplets()) {</a>
<a name="ln2154">            Fraction tupletTick = tuplet-&gt;tick();</a>
<a name="ln2155">            Fraction tupletDuration = tuplet-&gt;actualTicks() - Fraction::fromTicks(1);</a>
<a name="ln2156">            std::vector&lt;DurationElement*&gt; tElements = tuplet-&gt;elements();</a>
<a name="ln2157">            for (Tuplet* tuplet2 : e.tuplets()) {</a>
<a name="ln2158">                  if ((tuplet2-&gt;tuplet()) || (tuplet2-&gt;voice() != tuplet-&gt;voice())) // already a nested tuplet or in a different voice</a>
<a name="ln2159">                        continue;</a>
<a name="ln2160">                  // int possibleDuration = tuplet2-&gt;duration().ticks() * tuplet-&gt;ratio().denominator() / tuplet-&gt;ratio().numerator() - 1;</a>
<a name="ln2161">                  Fraction possibleDuration = tuplet2-&gt;ticks() * Fraction(tuplet-&gt;ratio().denominator(), (tuplet-&gt;ratio().numerator()-1));</a>
<a name="ln2162"> </a>
<a name="ln2163">                  if ((tuplet2 != tuplet) &amp;&amp; (tuplet2-&gt;tick() &gt;= tupletTick) &amp;&amp; (tuplet2-&gt;tick() &lt; tupletTick + tupletDuration) &amp;&amp; (tuplet2-&gt;tick() + possibleDuration &lt; tupletTick + tupletDuration)) {</a>
<a name="ln2164">                        bool found = false;</a>
<a name="ln2165">                        for (DurationElement* de : tElements) {</a>
<a name="ln2166">                              if (de == tuplet2)</a>
<a name="ln2167">                                    found = true;</a>
<a name="ln2168">                              }</a>
<a name="ln2169">                        if (!found) {</a>
<a name="ln2170">                              qDebug(&quot;Adding tuplet %p as nested tuplet to tuplet %p&quot;,tuplet2,tuplet);</a>
<a name="ln2171">                              tuplet2-&gt;setTuplet(tuplet);</a>
<a name="ln2172">                              tuplet-&gt;add(tuplet2);</a>
<a name="ln2173">                              }</a>
<a name="ln2174">                        }</a>
<a name="ln2175">                  }</a>
<a name="ln2176">            }</a>
<a name="ln2177">      e.checkTuplets();</a>
<a name="ln2178">      m-&gt;connectTremolo();</a>
<a name="ln2179">      }</a>
<a name="ln2180"> </a>
<a name="ln2181">//---------------------------------------------------------</a>
<a name="ln2182">//   readBoxProperties</a>
<a name="ln2183">//---------------------------------------------------------</a>
<a name="ln2184"> </a>
<a name="ln2185">static void readBox(XmlReader&amp; e, Box* b);</a>
<a name="ln2186"> </a>
<a name="ln2187">static bool readBoxProperties(XmlReader&amp; e, Box* b)</a>
<a name="ln2188">      {</a>
<a name="ln2189">      const QStringRef&amp; tag(e.name());</a>
<a name="ln2190">      if (tag == &quot;height&quot;)</a>
<a name="ln2191">            b-&gt;setBoxHeight(Spatium(e.readDouble()));</a>
<a name="ln2192">      else if (tag == &quot;width&quot;)</a>
<a name="ln2193">            b-&gt;setBoxWidth(Spatium(e.readDouble()));</a>
<a name="ln2194">      else if (tag == &quot;topGap&quot;)</a>
<a name="ln2195">            b-&gt;readProperty(e, Pid::TOP_GAP);</a>
<a name="ln2196">      else if (tag == &quot;bottomGap&quot;) {</a>
<a name="ln2197">            b-&gt;readProperty(e, Pid::BOTTOM_GAP);</a>
<a name="ln2198">            }</a>
<a name="ln2199">      else if (tag == &quot;leftMargin&quot;)</a>
<a name="ln2200">            b-&gt;setLeftMargin(e.readDouble());</a>
<a name="ln2201">      else if (tag == &quot;rightMargin&quot;)</a>
<a name="ln2202">            b-&gt;setRightMargin(e.readDouble());</a>
<a name="ln2203">      else if (tag == &quot;topMargin&quot;)</a>
<a name="ln2204">            b-&gt;setTopMargin(e.readDouble());</a>
<a name="ln2205">      else if (tag == &quot;bottomMargin&quot;)</a>
<a name="ln2206">            b-&gt;setBottomMargin(e.readDouble());</a>
<a name="ln2207">      else if (tag == &quot;offset&quot;)</a>
<a name="ln2208">            b-&gt;setOffset(e.readPoint() * b-&gt;spatium());</a>
<a name="ln2209">      else if (tag == &quot;pos&quot;)        // ignore</a>
<a name="ln2210">            e.readPoint();</a>
<a name="ln2211">      else if (tag == &quot;Text&quot;) {</a>
<a name="ln2212">            Text* t;</a>
<a name="ln2213">            if (b-&gt;isTBox()) {</a>
<a name="ln2214">                  t = toTBox(b)-&gt;text();</a>
<a name="ln2215">                  readText114(e, t, t);</a>
<a name="ln2216">                  }</a>
<a name="ln2217">            else {</a>
<a name="ln2218">                  t = new Text(b-&gt;score());</a>
<a name="ln2219">                  readText114(e, t, t);</a>
<a name="ln2220">                  if (t-&gt;empty())</a>
<a name="ln2221">                        qDebug(&quot;read empty text&quot;);</a>
<a name="ln2222">                  else</a>
<a name="ln2223">                        b-&gt;add(t);</a>
<a name="ln2224">                  }</a>
<a name="ln2225">            }</a>
<a name="ln2226">      else if (tag == &quot;Symbol&quot;) {</a>
<a name="ln2227">            Symbol* s = new Symbol(b-&gt;score());</a>
<a name="ln2228">            s-&gt;read(e);</a>
<a name="ln2229">            b-&gt;add(s);</a>
<a name="ln2230">            }</a>
<a name="ln2231">      else if (tag == &quot;Image&quot;) {</a>
<a name="ln2232">            if (MScore::noImages)</a>
<a name="ln2233">                  e.skipCurrentElement();</a>
<a name="ln2234">            else {</a>
<a name="ln2235">                  Image* image = new Image(b-&gt;score());</a>
<a name="ln2236">                  image-&gt;setTrack(e.track());</a>
<a name="ln2237">                  image-&gt;read(e);</a>
<a name="ln2238">                  b-&gt;add(image);</a>
<a name="ln2239">                  }</a>
<a name="ln2240">            }</a>
<a name="ln2241">      else if (tag == &quot;HBox&quot;) {</a>
<a name="ln2242">            HBox* hb = new HBox(b-&gt;score());</a>
<a name="ln2243">            readBox(e, hb);</a>
<a name="ln2244">            b-&gt;add(hb);</a>
<a name="ln2245">            }</a>
<a name="ln2246">      else if (tag == &quot;VBox&quot;) {</a>
<a name="ln2247">            VBox* vb = new VBox(b-&gt;score());</a>
<a name="ln2248">            readBox(e, vb);</a>
<a name="ln2249">            b-&gt;add(vb);</a>
<a name="ln2250">            }</a>
<a name="ln2251">//      else if (MeasureBase::readProperties(e))</a>
<a name="ln2252">//            ;</a>
<a name="ln2253">      else</a>
<a name="ln2254">            return false;</a>
<a name="ln2255">      return true;</a>
<a name="ln2256">      }</a>
<a name="ln2257"> </a>
<a name="ln2258">//---------------------------------------------------------</a>
<a name="ln2259">//   readBox</a>
<a name="ln2260">//---------------------------------------------------------</a>
<a name="ln2261"> </a>
<a name="ln2262">static void readBox(XmlReader&amp; e, Box* b)</a>
<a name="ln2263">      {</a>
<a name="ln2264">      b-&gt;setLeftMargin(0.0);</a>
<a name="ln2265">      b-&gt;setRightMargin(0.0);</a>
<a name="ln2266">      b-&gt;setTopMargin(0.0);</a>
<a name="ln2267">      b-&gt;setBottomMargin(0.0);</a>
<a name="ln2268">      b-&gt;setBoxHeight(Spatium(0));     // override default set in constructor</a>
<a name="ln2269">      b-&gt;setBoxWidth(Spatium(0));</a>
<a name="ln2270"> </a>
<a name="ln2271">      while (e.readNextStartElement()) {</a>
<a name="ln2272">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2273">            if (tag == &quot;HBox&quot;) {</a>
<a name="ln2274">                  HBox* hb = new HBox(b-&gt;score());</a>
<a name="ln2275">                  readBox(e, hb);</a>
<a name="ln2276">                  b-&gt;add(hb);</a>
<a name="ln2277">                  }</a>
<a name="ln2278">            else if (tag == &quot;VBox&quot;) {</a>
<a name="ln2279">                  VBox* vb = new VBox(b-&gt;score());</a>
<a name="ln2280">                  readBox(e, vb);</a>
<a name="ln2281">                  b-&gt;add(vb);</a>
<a name="ln2282">                  }</a>
<a name="ln2283">            else if (!readBoxProperties(e, b))</a>
<a name="ln2284">                  e.unknown();</a>
<a name="ln2285">            }</a>
<a name="ln2286">      }</a>
<a name="ln2287"> </a>
<a name="ln2288">//---------------------------------------------------------</a>
<a name="ln2289">//   readStaffContent</a>
<a name="ln2290">//---------------------------------------------------------</a>
<a name="ln2291"> </a>
<a name="ln2292">static void readStaffContent(Score* score, XmlReader&amp; e)</a>
<a name="ln2293">      {</a>
<a name="ln2294">      int staff = e.intAttribute(&quot;id&quot;, 1) - 1;</a>
<a name="ln2295">      e.setTick(Fraction(0,1));</a>
<a name="ln2296">      e.setTrack(staff * VOICES);</a>
<a name="ln2297"> </a>
<a name="ln2298">      Measure* measure = score-&gt;firstMeasure();</a>
<a name="ln2299">      while (e.readNextStartElement()) {</a>
<a name="ln2300">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2301"> </a>
<a name="ln2302">            if (tag == &quot;Measure&quot;) {</a>
<a name="ln2303">                  if (staff == 0) {</a>
<a name="ln2304">                        measure = new Measure(score);</a>
<a name="ln2305">                        measure-&gt;setTick(e.tick());</a>
<a name="ln2306">                        const SigEvent&amp; ev = score-&gt;sigmap()-&gt;timesig(measure-&gt;tick());</a>
<a name="ln2307">                        measure-&gt;setTicks(ev.timesig());</a>
<a name="ln2308">                        measure-&gt;setTimesig(ev.nominal());</a>
<a name="ln2309"> </a>
<a name="ln2310">                        readMeasure(measure, staff, e);</a>
<a name="ln2311">                        measure-&gt;checkMeasure(staff);</a>
<a name="ln2312"> </a>
<a name="ln2313">                        if (!measure-&gt;isMMRest()) {</a>
<a name="ln2314">                              score-&gt;measures()-&gt;add(measure);</a>
<a name="ln2315">                              e.setLastMeasure(measure);</a>
<a name="ln2316">                              e.setTick(measure-&gt;tick() + measure-&gt;ticks());</a>
<a name="ln2317">                              }</a>
<a name="ln2318">                        else {</a>
<a name="ln2319">                              // this is a multi measure rest</a>
<a name="ln2320">                              // always preceded by the first measure it replaces</a>
<a name="ln2321">                              Measure* m = e.lastMeasure();</a>
<a name="ln2322"> </a>
<a name="ln2323">                              if (m) {</a>
<a name="ln2324">                                    m-&gt;setMMRest(measure);</a>
<a name="ln2325">                                    measure-&gt;setTick(m-&gt;tick());</a>
<a name="ln2326">                                    }</a>
<a name="ln2327">                              }</a>
<a name="ln2328">                         }</a>
<a name="ln2329">                  else {</a>
<a name="ln2330">                        if (measure == 0) {</a>
<a name="ln2331">                              qDebug(&quot;Score::readStaff(): missing measure!&quot;);</a>
<a name="ln2332">                              measure = new Measure(score);</a>
<a name="ln2333">                              measure-&gt;setTick(e.tick());</a>
<a name="ln2334">                              score-&gt;measures()-&gt;add(measure);</a>
<a name="ln2335">                              }</a>
<a name="ln2336">                        e.setTick(measure-&gt;tick());</a>
<a name="ln2337"> </a>
<a name="ln2338">                        readMeasure(measure, staff, e);</a>
<a name="ln2339">                        measure-&gt;checkMeasure(staff);</a>
<a name="ln2340"> </a>
<a name="ln2341">                        if (measure-&gt;isMMRest())</a>
<a name="ln2342">                              measure = e.lastMeasure()-&gt;nextMeasure();</a>
<a name="ln2343">                        else {</a>
<a name="ln2344">                              e.setLastMeasure(measure);</a>
<a name="ln2345">                              if (measure-&gt;mmRest())</a>
<a name="ln2346">                                    measure = measure-&gt;mmRest();</a>
<a name="ln2347">                              else</a>
<a name="ln2348">                                    measure = measure-&gt;nextMeasure();</a>
<a name="ln2349">                              }</a>
<a name="ln2350">                        }</a>
<a name="ln2351">                  }</a>
<a name="ln2352">            else if (tag == &quot;HBox&quot; || tag == &quot;VBox&quot; || tag == &quot;TBox&quot; || tag == &quot;FBox&quot;) {</a>
<a name="ln2353">                  Box* mb = toBox(Element::name2Element(tag, score));</a>
<a name="ln2354">                  readBox(e, mb);</a>
<a name="ln2355">                  mb-&gt;setTick(e.tick());</a>
<a name="ln2356">                  score-&gt;measures()-&gt;add(mb);</a>
<a name="ln2357">                  }</a>
<a name="ln2358">            else if (tag == &quot;tick&quot;)</a>
<a name="ln2359">                  e.setTick(Fraction::fromTicks(score-&gt;fileDivision(e.readInt())));</a>
<a name="ln2360">            else</a>
<a name="ln2361">                  e.unknown();</a>
<a name="ln2362">            }</a>
<a name="ln2363">      }</a>
<a name="ln2364"> </a>
<a name="ln2365">//---------------------------------------------------------</a>
<a name="ln2366">//   readStaff</a>
<a name="ln2367">//---------------------------------------------------------</a>
<a name="ln2368"> </a>
<a name="ln2369">static void readStaff(Staff* staff, XmlReader&amp; e)</a>
<a name="ln2370">      {</a>
<a name="ln2371">      Score* _score = staff-&gt;score();</a>
<a name="ln2372">      while (e.readNextStartElement()) {</a>
<a name="ln2373">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2374">            if (tag == &quot;lines&quot;) {</a>
<a name="ln2375">                  int lines = e.readInt();</a>
<a name="ln2376">                  staff-&gt;setLines(Fraction(0,1), lines);</a>
<a name="ln2377">                  if (lines != 5) {</a>
<a name="ln2378">                        staff-&gt;setBarLineFrom(lines == 1 ? BARLINE_SPAN_1LINESTAFF_FROM : 0);</a>
<a name="ln2379">                        staff-&gt;setBarLineTo(lines == 1 ? BARLINE_SPAN_1LINESTAFF_TO   : (lines - 1) * 2);</a>
<a name="ln2380">                        }</a>
<a name="ln2381">                  }</a>
<a name="ln2382">            else if (tag == &quot;small&quot;)</a>
<a name="ln2383">                  staff-&gt;setSmall(Fraction(0,1), e.readInt());</a>
<a name="ln2384">            else if (tag == &quot;invisible&quot;)</a>
<a name="ln2385">                  staff-&gt;setInvisible(e.readInt());</a>
<a name="ln2386">            else if (tag == &quot;slashStyle&quot;)</a>
<a name="ln2387">                  e.skipCurrentElement();</a>
<a name="ln2388">            else if (tag == &quot;cleflist&quot;) {</a>
<a name="ln2389">                  // QList&lt;std::pair&lt;int, ClefType&gt;&gt;&amp; cl = e.clefs(idx());</a>
<a name="ln2390">                  staff-&gt;clefList().clear();</a>
<a name="ln2391">                  while (e.readNextStartElement()) {</a>
<a name="ln2392">                        if (e.name() == &quot;clef&quot;) {</a>
<a name="ln2393">                              int tick    = e.intAttribute(&quot;tick&quot;, 0);</a>
<a name="ln2394">                              ClefType ct = readClefType(e.attribute(&quot;idx&quot;, &quot;0&quot;));</a>
<a name="ln2395">                              staff-&gt;clefList().insert(std::pair&lt;int,ClefType&gt;(_score-&gt;fileDivision(tick), ct));</a>
<a name="ln2396">                              e.readNext();</a>
<a name="ln2397">                              }</a>
<a name="ln2398">                        else</a>
<a name="ln2399">                              e.unknown();</a>
<a name="ln2400">                        }</a>
<a name="ln2401">                  if (staff-&gt;clefList().empty())</a>
<a name="ln2402">                        staff-&gt;clefList().insert(std::pair&lt;int,ClefType&gt;(0, ClefType::G));</a>
<a name="ln2403">                  }</a>
<a name="ln2404">            else if (tag == &quot;keylist&quot;)</a>
<a name="ln2405">                  staff-&gt;keyList()-&gt;read(e, _score);</a>
<a name="ln2406">            else if (tag == &quot;bracket&quot;) {</a>
<a name="ln2407">                  int col = staff-&gt;brackets().size();</a>
<a name="ln2408">                  staff-&gt;setBracketType(col, BracketType(e.intAttribute(&quot;type&quot;, -1)));</a>
<a name="ln2409">                  staff-&gt;setBracketSpan(col, e.intAttribute(&quot;span&quot;, 0));</a>
<a name="ln2410">                  e.readNext();</a>
<a name="ln2411">                  }</a>
<a name="ln2412">            else if (tag == &quot;barLineSpan&quot;)</a>
<a name="ln2413">                  staff-&gt;setBarLineSpan(e.readInt());</a>
<a name="ln2414">            else</a>
<a name="ln2415">                  e.unknown();</a>
<a name="ln2416">            }</a>
<a name="ln2417">      }</a>
<a name="ln2418"> </a>
<a name="ln2419">//---------------------------------------------------------</a>
<a name="ln2420">//   readDrumset</a>
<a name="ln2421">//---------------------------------------------------------</a>
<a name="ln2422"> </a>
<a name="ln2423">static void readDrumset(Drumset* ds, XmlReader&amp; e)</a>
<a name="ln2424">      {</a>
<a name="ln2425">      int pitch = e.intAttribute(&quot;pitch&quot;, -1);</a>
<a name="ln2426">      if (pitch &lt; 0 || pitch &gt; 127) {</a>
<a name="ln2427">            qDebug(&quot;load drumset: invalid pitch %d&quot;, pitch);</a>
<a name="ln2428">            return;</a>
<a name="ln2429">            }</a>
<a name="ln2430">      while (e.readNextStartElement()) {</a>
<a name="ln2431">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2432">            if (tag == &quot;head&quot;)</a>
<a name="ln2433">                  ds-&gt;drum(pitch).notehead = convertHeadGroup(e.readInt());</a>
<a name="ln2434">            else if (ds-&gt;readProperties(e, pitch))</a>
<a name="ln2435">                  ;</a>
<a name="ln2436">            else</a>
<a name="ln2437">                  e.unknown();</a>
<a name="ln2438">            }</a>
<a name="ln2439">      }</a>
<a name="ln2440"> </a>
<a name="ln2441">//---------------------------------------------------------</a>
<a name="ln2442">//   readInstrument</a>
<a name="ln2443">//---------------------------------------------------------</a>
<a name="ln2444"> </a>
<a name="ln2445">static void readInstrument(Instrument *i, Part* p, XmlReader&amp; e)</a>
<a name="ln2446">      {</a>
<a name="ln2447">      int program = -1;</a>
<a name="ln2448">      int bank    = 0;</a>
<a name="ln2449">      int chorus  = 30;</a>
<a name="ln2450">      int reverb  = 30;</a>
<a name="ln2451">      int volume  = 100;</a>
<a name="ln2452">      int pan     = 60;</a>
<a name="ln2453">      bool customDrumset = false;</a>
<a name="ln2454">      i-&gt;clearChannels();       // remove default channel</a>
<a name="ln2455">      while (e.readNextStartElement()) {</a>
<a name="ln2456">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2457">            if (tag == &quot;chorus&quot;)</a>
<a name="ln2458">                  chorus = e.readInt();</a>
<a name="ln2459">            else if (tag == &quot;reverb&quot;)</a>
<a name="ln2460">                  reverb = e.readInt();</a>
<a name="ln2461">            else if (tag == &quot;midiProgram&quot;)</a>
<a name="ln2462">                  program = e.readInt();</a>
<a name="ln2463">            else if (tag == &quot;volume&quot;)</a>
<a name="ln2464">                  volume = e.readInt();</a>
<a name="ln2465">            else if (tag == &quot;pan&quot;)</a>
<a name="ln2466">                  pan = e.readInt();</a>
<a name="ln2467">            else if (tag == &quot;midiChannel&quot;)</a>
<a name="ln2468">                  e.skipCurrentElement();</a>
<a name="ln2469">            else if (tag == &quot;Drum&quot;) {</a>
<a name="ln2470">                  // if we see one of this tags, a custom drumset will</a>
<a name="ln2471">                  // be created</a>
<a name="ln2472">                  if (!i-&gt;drumset())</a>
<a name="ln2473">                        i-&gt;setDrumset(new Drumset(*smDrumset));</a>
<a name="ln2474">                  if (!customDrumset) {</a>
<a name="ln2475">                        i-&gt;drumset()-&gt;clear();</a>
<a name="ln2476">                        customDrumset = true;</a>
<a name="ln2477">                        }</a>
<a name="ln2478">                  readDrumset(i-&gt;drumset(), e);</a>
<a name="ln2479">                  }</a>
<a name="ln2480"> </a>
<a name="ln2481">            else if (i-&gt;readProperties(e, p, &amp;customDrumset))</a>
<a name="ln2482">                  ;</a>
<a name="ln2483">            else</a>
<a name="ln2484">                 e.unknown();</a>
<a name="ln2485">            }</a>
<a name="ln2486"> </a>
<a name="ln2487">      if (i-&gt;channel().empty()) {      // for backward compatibility</a>
<a name="ln2488">            Channel* a = new Channel;</a>
<a name="ln2489">            a-&gt;setName(Channel::DEFAULT_NAME);</a>
<a name="ln2490">            a-&gt;setProgram(program);</a>
<a name="ln2491">            a-&gt;setBank(bank);</a>
<a name="ln2492">            a-&gt;setVolume(volume);</a>
<a name="ln2493">            a-&gt;setPan(pan);</a>
<a name="ln2494">            a-&gt;setReverb(reverb);</a>
<a name="ln2495">            a-&gt;setChorus(chorus);</a>
<a name="ln2496">            i-&gt;appendChannel(a);</a>
<a name="ln2497">            }</a>
<a name="ln2498">      if (i-&gt;useDrumset()) {</a>
<a name="ln2499">            if (i-&gt;channel()[0]-&gt;bank() == 0)</a>
<a name="ln2500">                  i-&gt;channel()[0]-&gt;setBank(128);</a>
<a name="ln2501">            }</a>
<a name="ln2502"> </a>
<a name="ln2503">      // Fix user bank controller read</a>
<a name="ln2504">      for (Channel* c : i-&gt;channel()) {</a>
<a name="ln2505">            if (c-&gt;bank() == 0)</a>
<a name="ln2506">                  c-&gt;setUserBankController(false);</a>
<a name="ln2507">            }</a>
<a name="ln2508"> </a>
<a name="ln2509">      // Read single-note dynamics from template</a>
<a name="ln2510">      i-&gt;setSingleNoteDynamicsFromTemplate();</a>
<a name="ln2511">      }</a>
<a name="ln2512"> </a>
<a name="ln2513">//---------------------------------------------------------</a>
<a name="ln2514">//   readPart</a>
<a name="ln2515">//---------------------------------------------------------</a>
<a name="ln2516"> </a>
<a name="ln2517">static void readPart(Part* part, XmlReader&amp; e)</a>
<a name="ln2518">      {</a>
<a name="ln2519">      Score* _score = part-&gt;score();</a>
<a name="ln2520">      while (e.readNextStartElement()) {</a>
<a name="ln2521">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2522">            if (tag == &quot;Staff&quot;) {</a>
<a name="ln2523">                  Staff* staff = new Staff(_score);</a>
<a name="ln2524">                  staff-&gt;setPart(part);</a>
<a name="ln2525">                  staff-&gt;setStaffType(Fraction(0,1), StaffType()); // will reset later if needed</a>
<a name="ln2526">                  _score-&gt;staves().push_back(staff);</a>
<a name="ln2527">                  part-&gt;staves()-&gt;push_back(staff);</a>
<a name="ln2528">                  readStaff(staff, e);</a>
<a name="ln2529">                  }</a>
<a name="ln2530">            else if (tag == &quot;Instrument&quot;) {</a>
<a name="ln2531">                  Instrument* i = part-&gt;instrument();</a>
<a name="ln2532">                  readInstrument(i, part, e);</a>
<a name="ln2533">                  // add string data from MIDI program number, if possible</a>
<a name="ln2534">                  if (i-&gt;stringData()-&gt;strings() == 0</a>
<a name="ln2535">                     &amp;&amp; i-&gt;channel().count() &gt; 0</a>
<a name="ln2536">                     &amp;&amp; i-&gt;drumset() == nullptr) {</a>
<a name="ln2537">                        int program = i-&gt;channel(0)-&gt;program();</a>
<a name="ln2538">                        if (program &gt;= 24 &amp;&amp; program &lt;= 30)       // guitars</a>
<a name="ln2539">                              i-&gt;setStringData(StringData(19, 6, g_guitarStrings));</a>
<a name="ln2540">                        else if ( (program &gt;= 32 &amp;&amp; program &lt;= 39) || program == 43)      // bass / double-bass</a>
<a name="ln2541">                              i-&gt;setStringData(StringData(24, 4, g_bassStrings));</a>
<a name="ln2542">                        else if (program == 40)                   // violin and other treble string instr.</a>
<a name="ln2543">                              i-&gt;setStringData(StringData(24, 4, g_violinStrings));</a>
<a name="ln2544">                        else if (program == 41)                   // viola and other alto string instr.</a>
<a name="ln2545">                              i-&gt;setStringData(StringData(24, 4, g_violaStrings));</a>
<a name="ln2546">                        else if (program == 42)                   // cello and other bass string instr.</a>
<a name="ln2547">                              i-&gt;setStringData(StringData(24, 4, g_celloStrings));</a>
<a name="ln2548">                        }</a>
<a name="ln2549">                  Drumset* d = i-&gt;drumset();</a>
<a name="ln2550">                  Staff*   st = part-&gt;staff(0);</a>
<a name="ln2551">                  if (d &amp;&amp; st &amp;&amp; st-&gt;lines(Fraction(0,1)) != 5) {</a>
<a name="ln2552">                        int n = 0;</a>
<a name="ln2553">                        if (st-&gt;lines(Fraction(0,1)) == 1)</a>
<a name="ln2554">                              n = 4;</a>
<a name="ln2555">                        for (int  j = 0; j &lt; DRUM_INSTRUMENTS; ++j)</a>
<a name="ln2556">                              d-&gt;drum(j).line -= n;</a>
<a name="ln2557">                        }</a>
<a name="ln2558">                  }</a>
<a name="ln2559">            else if (tag == &quot;name&quot;) {</a>
<a name="ln2560">                  Text* t = new Text(_score);</a>
<a name="ln2561">                  readText114(e, t, t);</a>
<a name="ln2562">                  part-&gt;instrument()-&gt;setLongName(t-&gt;xmlText());</a>
<a name="ln2563">                  delete t;</a>
<a name="ln2564">                  }</a>
<a name="ln2565">            else if (tag == &quot;shortName&quot;) {</a>
<a name="ln2566">                  Text* t = new Text(_score);</a>
<a name="ln2567">                  readText114(e, t, t);</a>
<a name="ln2568">                  part-&gt;instrument()-&gt;setShortName(t-&gt;xmlText());</a>
<a name="ln2569">                  delete t;</a>
<a name="ln2570">                  }</a>
<a name="ln2571">            else if (tag == &quot;trackName&quot;)</a>
<a name="ln2572">                  part-&gt;setPartName(e.readElementText());</a>
<a name="ln2573">            else if (tag == &quot;show&quot;)</a>
<a name="ln2574">                  part-&gt;setShow(e.readInt());</a>
<a name="ln2575">            else</a>
<a name="ln2576">                  e.unknown();</a>
<a name="ln2577">            }</a>
<a name="ln2578">      if (part-&gt;partName().isEmpty())</a>
<a name="ln2579">            part-&gt;setPartName(part-&gt;instrument()-&gt;trackName());</a>
<a name="ln2580"> </a>
<a name="ln2581">      if (part-&gt;instrument()-&gt;useDrumset()) {</a>
<a name="ln2582">            for (Staff* staff : *part-&gt;staves()) {</a>
<a name="ln2583">                  int lines = staff-&gt;lines(Fraction(0,1));</a>
<a name="ln2584">                  int bf    = staff-&gt;barLineFrom();</a>
<a name="ln2585">                  int bt    = staff-&gt;barLineTo();</a>
<a name="ln2586">                  staff-&gt;setStaffType(Fraction(0,1), *StaffType::getDefaultPreset(StaffGroup::PERCUSSION));</a>
<a name="ln2587"> </a>
<a name="ln2588">                  // this allows 2/3-line percussion staves to keep the double spacing they had in 1.3</a>
<a name="ln2589"> </a>
<a name="ln2590">                  if (lines == 2 || lines == 3)</a>
<a name="ln2591">                        ((StaffType*)(staff-&gt;staffType(Fraction(0,1))))-&gt;setLineDistance(Spatium(2.0));</a>
<a name="ln2592"> </a>
<a name="ln2593">                  staff-&gt;setLines(Fraction(0,1), lines);       // this also sets stepOffset</a>
<a name="ln2594">                  staff-&gt;setBarLineFrom(bf);</a>
<a name="ln2595">                  staff-&gt;setBarLineTo(bt);</a>
<a name="ln2596">                  }</a>
<a name="ln2597">            }</a>
<a name="ln2598">      //set default articulations</a>
<a name="ln2599">      QList&lt;MidiArticulation&gt; articulations;</a>
<a name="ln2600">      articulations.append(MidiArticulation(&quot;&quot;, &quot;&quot;, 100, 100));</a>
<a name="ln2601">      articulations.append(MidiArticulation(&quot;staccato&quot;, &quot;&quot;, 100, 50));</a>
<a name="ln2602">      articulations.append(MidiArticulation(&quot;tenuto&quot;, &quot;&quot;, 100, 100));</a>
<a name="ln2603">      articulations.append(MidiArticulation(&quot;sforzato&quot;, &quot;&quot;, 120, 100));</a>
<a name="ln2604">      part-&gt;instrument()-&gt;setArticulation(articulations);</a>
<a name="ln2605">      }</a>
<a name="ln2606"> </a>
<a name="ln2607">//---------------------------------------------------------</a>
<a name="ln2608">//   readPageFormat</a>
<a name="ln2609">//---------------------------------------------------------</a>
<a name="ln2610"> </a>
<a name="ln2611">static void readPageFormat(PageFormat* pf, XmlReader&amp; e)</a>
<a name="ln2612">      {</a>
<a name="ln2613">      qreal _oddRightMargin  = 0.0;</a>
<a name="ln2614">      qreal _evenRightMargin = 0.0;</a>
<a name="ln2615">      bool landscape         = false;</a>
<a name="ln2616">      QString type;</a>
<a name="ln2617"> </a>
<a name="ln2618">      while (e.readNextStartElement()) {</a>
<a name="ln2619">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2620">            if (tag == &quot;landscape&quot;)</a>
<a name="ln2621">                  landscape = e.readInt();</a>
<a name="ln2622">            else if (tag == &quot;page-margins&quot;) {</a>
<a name="ln2623">                  type = e.attribute(&quot;type&quot;,&quot;both&quot;);</a>
<a name="ln2624">                  qreal lm = 0.0, rm = 0.0, tm = 0.0, bm = 0.0;</a>
<a name="ln2625">                  while (e.readNextStartElement()) {</a>
<a name="ln2626">                        const QStringRef&amp; t(e.name());</a>
<a name="ln2627">                        qreal val = e.readDouble() * 0.5 / PPI;</a>
<a name="ln2628">                        if (t == &quot;left-margin&quot;)</a>
<a name="ln2629">                              lm = val;</a>
<a name="ln2630">                        else if (t == &quot;right-margin&quot;)</a>
<a name="ln2631">                              rm = val;</a>
<a name="ln2632">                        else if (t == &quot;top-margin&quot;)</a>
<a name="ln2633">                              tm = val;</a>
<a name="ln2634">                        else if (t == &quot;bottom-margin&quot;)</a>
<a name="ln2635">                              bm = val;</a>
<a name="ln2636">                        else</a>
<a name="ln2637">                              e.unknown();</a>
<a name="ln2638">                        }</a>
<a name="ln2639">                  pf-&gt;setTwosided(type == &quot;odd&quot; || type == &quot;even&quot;);</a>
<a name="ln2640">                  if (type == &quot;odd&quot; || type == &quot;both&quot;) {</a>
<a name="ln2641">                        pf-&gt;setOddLeftMargin(lm);</a>
<a name="ln2642">                        _oddRightMargin = rm;</a>
<a name="ln2643">                        pf-&gt;setOddTopMargin(tm);</a>
<a name="ln2644">                        pf-&gt;setOddBottomMargin(bm);</a>
<a name="ln2645">                        }</a>
<a name="ln2646">                  if (type == &quot;even&quot; || type == &quot;both&quot;) {</a>
<a name="ln2647">                        pf-&gt;setEvenLeftMargin(lm);</a>
<a name="ln2648">                        _evenRightMargin = rm;</a>
<a name="ln2649">                        pf-&gt;setEvenTopMargin(tm);</a>
<a name="ln2650">                        pf-&gt;setEvenBottomMargin(bm);</a>
<a name="ln2651">                        }</a>
<a name="ln2652">                  }</a>
<a name="ln2653">            else if (tag == &quot;page-height&quot;)</a>
<a name="ln2654">                  pf-&gt;setSize(QSizeF(pf-&gt;size().width(), e.readDouble() * 0.5 / PPI));</a>
<a name="ln2655">            else if (tag == &quot;page-width&quot;)</a>
<a name="ln2656">                  pf-&gt;setSize(QSizeF(e.readDouble() * 0.5 / PPI, pf-&gt;size().height()));</a>
<a name="ln2657">            else if (tag == &quot;pageFormat&quot;) {</a>
<a name="ln2658">                  const PaperSize* s = getPaperSize114(e.readElementText());</a>
<a name="ln2659">                  pf-&gt;setSize(QSizeF(s-&gt;w, s-&gt;h));</a>
<a name="ln2660">                  }</a>
<a name="ln2661">            else if (tag == &quot;page-offset&quot;) {</a>
<a name="ln2662">                  e.readInt();</a>
<a name="ln2663">                  }</a>
<a name="ln2664">            else</a>
<a name="ln2665">                  e.unknown();</a>
<a name="ln2666">            }</a>
<a name="ln2667">      if (landscape)</a>
<a name="ln2668">            pf-&gt;setSize(pf-&gt;size().transposed());</a>
<a name="ln2669">      qreal w1 = pf-&gt;size().width() - pf-&gt;oddLeftMargin() - _oddRightMargin;</a>
<a name="ln2670">      qreal w2 = pf-&gt;size().width() - pf-&gt;evenLeftMargin() - _evenRightMargin;</a>
<a name="ln2671">      pf-&gt;setPrintableWidth(qMin(w1, w2));     // silently adjust right margins</a>
<a name="ln2672">      }</a>
<a name="ln2673"> </a>
<a name="ln2674">//---------------------------------------------------------</a>
<a name="ln2675">//   readStyle</a>
<a name="ln2676">//---------------------------------------------------------</a>
<a name="ln2677"> </a>
<a name="ln2678">static void readStyle(MStyle* style, XmlReader&amp; e)</a>
<a name="ln2679">      {</a>
<a name="ln2680">      QString oldChordDescriptionFile = style-&gt;value(Sid::chordDescriptionFile).toString();</a>
<a name="ln2681">      bool chordListTag = false;</a>
<a name="ln2682">      while (e.readNextStartElement()) {</a>
<a name="ln2683">            QString tag = e.name().toString();</a>
<a name="ln2684"> </a>
<a name="ln2685">            if (tag == &quot;lyricsDistance&quot;)        // was renamed</a>
<a name="ln2686">                  tag = &quot;lyricsPosBelow&quot;;</a>
<a name="ln2687"> </a>
<a name="ln2688">            if (tag == &quot;TextStyle&quot;) {</a>
<a name="ln2689">//                  TextStyle s;</a>
<a name="ln2690">//TODO                  s.read(e);</a>
<a name="ln2691">//                  style-&gt;setTextStyle(s);</a>
<a name="ln2692">                  e.skipCurrentElement();</a>
<a name="ln2693">                  }</a>
<a name="ln2694">            else if (tag == &quot;lyricsMinBottomDistance&quot;) {</a>
<a name="ln2695">                  // no longer meaningful since it is now measured from skyline rather than staff</a>
<a name="ln2696">                  //style-&gt;set(Sid::lyricsMinBottomDistance, QPointF(0.0, y));</a>
<a name="ln2697">                  e.skipCurrentElement();</a>
<a name="ln2698">                  }</a>
<a name="ln2699">            else if (tag == &quot;Spatium&quot;)</a>
<a name="ln2700">                  style-&gt;set(Sid::spatium, e.readDouble() * DPMM);</a>
<a name="ln2701">            else if (tag == &quot;page-layout&quot;) {</a>
<a name="ln2702">                  PageFormat pf;</a>
<a name="ln2703">                  initPageFormat(style, &amp;pf);</a>
<a name="ln2704">                  pf.read(e);</a>
<a name="ln2705">                  setPageFormat(style, pf);</a>
<a name="ln2706">                  }</a>
<a name="ln2707">            else if (tag == &quot;displayInConcertPitch&quot;)</a>
<a name="ln2708">                  style-&gt;set(Sid::concertPitch, QVariant(bool(e.readInt())));</a>
<a name="ln2709">            else if (tag == &quot;ChordList&quot;) {</a>
<a name="ln2710">                  style-&gt;chordList()-&gt;clear();</a>
<a name="ln2711">                  style-&gt;chordList()-&gt;read(e);</a>
<a name="ln2712">                  for (ChordFont f : style-&gt;chordList()-&gt;fonts) {</a>
<a name="ln2713">                        if (f.family == &quot;MuseJazz&quot;) {</a>
<a name="ln2714">                              f.family = &quot;MuseJazz Text&quot;;</a>
<a name="ln2715">                              }</a>
<a name="ln2716">                        }</a>
<a name="ln2717">                  style-&gt;setCustomChordList(true);</a>
<a name="ln2718">                  chordListTag = true;</a>
<a name="ln2719">                  }</a>
<a name="ln2720">            else if (tag == &quot;pageFillLimit&quot; || tag == &quot;genTimesig&quot; || tag == &quot;FixMeasureNumbers&quot; || tag == &quot;FixMeasureWidth&quot;)   // obsolete</a>
<a name="ln2721">                  e.skipCurrentElement();</a>
<a name="ln2722">            else if (tag == &quot;systemDistance&quot;)  // obsolete</a>
<a name="ln2723">                  style-&gt;set(Sid::minSystemDistance, QVariant(e.readDouble()));</a>
<a name="ln2724">            else if (tag == &quot;stemDir&quot;) {</a>
<a name="ln2725">                  int voice = e.attribute(&quot;voice&quot;, &quot;1&quot;).toInt() - 1;</a>
<a name="ln2726">                  switch(voice) {</a>
<a name="ln2727">                        case 0: tag = &quot;StemDir1&quot;; break;</a>
<a name="ln2728">                        case 1: tag = &quot;StemDir2&quot;; break;</a>
<a name="ln2729">                        case 2: tag = &quot;StemDir3&quot;; break;</a>
<a name="ln2730">                        case 3: tag = &quot;StemDir4&quot;; break;</a>
<a name="ln2731">                        }</a>
<a name="ln2732">                  }</a>
<a name="ln2733">            // for compatibility:</a>
<a name="ln2734">            else if (tag == &quot;oddHeader&quot; || tag == &quot;evenHeader&quot; || tag == &quot;oddFooter&quot; || tag == &quot;evenFooter&quot;)</a>
<a name="ln2735">                  tag += &quot;C&quot;;</a>
<a name="ln2736">#if 0 // TODO-ws</a>
<a name="ln2737">                  int idx2;</a>
<a name="ln2738">                  for (idx2 = 0; idx2 &lt; int(ArticulationType::ARTICULATIONS); ++idx2) {</a>
<a name="ln2739">                        ArticulationInfo&amp; ai =  Articulation::articulationList[idx2];</a>
<a name="ln2740">                        // deal with obsolete tags from 1.14 format</a>
<a name="ln2741">                        if (tag == &quot;SforzatoaccentAnchor&quot;)</a>
<a name="ln2742">                              tag = &quot;SforzatoAnchor&quot;;</a>
<a name="ln2743">                        if (tag == &quot;SnappizzicatorAnchor&quot;)</a>
<a name="ln2744">                              tag = &quot;SnappizzicatoAnchor&quot;;</a>
<a name="ln2745">                        else if (tag == &quot;EspressivoAnchor&quot;)</a>
<a name="ln2746">                              continue;</a>
<a name="ln2747">                        if (QString::compare(tag, QString(ai.name).append(&quot;Anchor&quot;),  Qt::CaseInsensitive) == 0</a>
<a name="ln2748">                              || QString::compare(tag, QString(&quot;U&quot;).append(ai.name).append(&quot;Anchor&quot;), Qt::CaseInsensitive) == 0</a>
<a name="ln2749">                              || QString::compare(tag, QString(&quot;D&quot;).append(ai.name).append(&quot;Anchor&quot;), Qt::CaseInsensitive) == 0</a>
<a name="ln2750">                              ) {</a>
<a name="ln2751">                              Sid si = MStyle::styleIdx(QString(ai.name).append(&quot;Anchor&quot;));</a>
<a name="ln2752">                              if (si != Sid::NOSTYLE) {</a>
<a name="ln2753">                                    QString val(e.readElementText());</a>
<a name="ln2754">                                    style-&gt;set(si, val.toInt());</a>
<a name="ln2755">                                    break;</a>
<a name="ln2756">                                    }</a>
<a name="ln2757">                              }</a>
<a name="ln2758">                        }</a>
<a name="ln2759">                  if (idx2 &lt; int(ArticulationType::ARTICULATIONS))</a>
<a name="ln2760">                        continue;</a>
<a name="ln2761">#endif</a>
<a name="ln2762">            else {</a>
<a name="ln2763">                  if (!style-&gt;readProperties(e)) {</a>
<a name="ln2764">                        e.skipCurrentElement();</a>
<a name="ln2765">                        }</a>
<a name="ln2766">                  }</a>
<a name="ln2767">//TODO                  style-&gt;convertToUnit(tag, val);</a>
<a name="ln2768">            }</a>
<a name="ln2769"> </a>
<a name="ln2770">      // if we just specified a new chord description file</a>
<a name="ln2771">      // and didn't encounter a ChordList tag</a>
<a name="ln2772">      // then load the chord description file</a>
<a name="ln2773"> </a>
<a name="ln2774">      QString newChordDescriptionFile = style-&gt;value(Sid::chordDescriptionFile).toString();</a>
<a name="ln2775">      if (newChordDescriptionFile != oldChordDescriptionFile &amp;&amp; !chordListTag) {</a>
<a name="ln2776">            if (!newChordDescriptionFile.startsWith(&quot;chords_&quot;) &amp;&amp; style-&gt;value(Sid::chordStyle).toString() == &quot;std&quot;) {</a>
<a name="ln2777">                  // should not normally happen,</a>
<a name="ln2778">                  // but treat as &quot;old&quot; (114) score just in case</a>
<a name="ln2779">                  style-&gt;set(Sid::chordStyle, QVariant(QString(&quot;custom&quot;)));</a>
<a name="ln2780">                  style-&gt;set(Sid::chordsXmlFile, QVariant(true));</a>
<a name="ln2781">                  qDebug(&quot;StyleData::load: custom chord description file %s with chordStyle == std&quot;, qPrintable(newChordDescriptionFile));</a>
<a name="ln2782">                  }</a>
<a name="ln2783">            if (style-&gt;value(Sid::chordStyle).toString() == &quot;custom&quot;)</a>
<a name="ln2784">                  style-&gt;setCustomChordList(true);</a>
<a name="ln2785">            else</a>
<a name="ln2786">                  style-&gt;setCustomChordList(false);</a>
<a name="ln2787">            style-&gt;chordList()-&gt;unload();</a>
<a name="ln2788">            }</a>
<a name="ln2789"> </a>
<a name="ln2790">      // make sure we have a chordlist</a>
<a name="ln2791">      if (!chordListTag)</a>
<a name="ln2792">            style-&gt;checkChordList();</a>
<a name="ln2793">#if 0 // TODO</a>
<a name="ln2794">      //</a>
<a name="ln2795">      //  Compatibility with old scores/styles:</a>
<a name="ln2796">      //  translate old frameWidthMM and paddingWidthMM</a>
<a name="ln2797">      //  into spatium units</a>
<a name="ln2798">      //</a>
<a name="ln2799">      int n = style-&gt;textStyles().size();</a>
<a name="ln2800">      qreal _spatium = style-&gt;value(Sid::spatium).toDouble();</a>
<a name="ln2801">      qreal spMM = _spatium / DPMM;</a>
<a name="ln2802">      for (int i = 0; i &lt; n; ++i) {</a>
<a name="ln2803">            TextStyle* s = &amp;style-&gt;textStyle(StyledPropertyListIdx(i));</a>
<a name="ln2804">            if (s-&gt;frameWidthMM() != 0.0)</a>
<a name="ln2805">                  s-&gt;setFrameWidth(Spatium(s-&gt;frameWidthMM() / spMM));</a>
<a name="ln2806">            if (s-&gt;paddingWidthMM() != 0.0)</a>
<a name="ln2807">                  s-&gt;setPaddingWidth(Spatium(s-&gt;paddingWidthMM() / spMM));</a>
<a name="ln2808">            }</a>
<a name="ln2809">#endif</a>
<a name="ln2810">      }</a>
<a name="ln2811"> </a>
<a name="ln2812">//---------------------------------------------------------</a>
<a name="ln2813">//   read114</a>
<a name="ln2814">//    import old version &lt;= 1.3 files</a>
<a name="ln2815">//---------------------------------------------------------</a>
<a name="ln2816"> </a>
<a name="ln2817">Score::FileError MasterScore::read114(XmlReader&amp; e)</a>
<a name="ln2818">      {</a>
<a name="ln2819">      for (unsigned int i = 0; i &lt; sizeof(style114)/sizeof(*style114); ++i)</a>
<a name="ln2820">            style().set(style114[i].sid, style114[i].val);</a>
<a name="ln2821">#if 0</a>
<a name="ln2822">      // old text style defaults</a>
<a name="ln2823">      TextStyle ts = style().textStyle(&quot;Chord Symbol&quot;);</a>
<a name="ln2824">      ts.setYoff(-4.0);</a>
<a name="ln2825">      style().setTextStyle(ts);</a>
<a name="ln2826">      ts = style().textStyle(&quot;Rehearsal Mark&quot;);</a>
<a name="ln2827">      ts.setSquare(false);</a>
<a name="ln2828">      ts.setFrameRound(20);</a>
<a name="ln2829">      style().setTextStyle(ts);</a>
<a name="ln2830">      ts = style().textStyle(&quot;Dynamics&quot;);</a>
<a name="ln2831">      ts.setItalic(false);</a>
<a name="ln2832">      style().setTextStyle(ts);</a>
<a name="ln2833">#endif</a>
<a name="ln2834">      TempoMap tm;</a>
<a name="ln2835">      while (e.readNextStartElement()) {</a>
<a name="ln2836">            e.setTrack(-1);</a>
<a name="ln2837">            const QStringRef&amp; tag(e.name());</a>
<a name="ln2838">            if (tag == &quot;Staff&quot;)</a>
<a name="ln2839">                  readStaffContent(this, e);</a>
<a name="ln2840">            else if (tag == &quot;KeySig&quot;) {               // not supported</a>
<a name="ln2841">                  KeySig* ks = new KeySig(this);</a>
<a name="ln2842">                  ks-&gt;read(e);</a>
<a name="ln2843">                  delete ks;</a>
<a name="ln2844">                  }</a>
<a name="ln2845">            else if (tag == &quot;siglist&quot;)</a>
<a name="ln2846">                  _sigmap-&gt;read(e, _fileDivision);</a>
<a name="ln2847">            else if (tag == &quot;programVersion&quot;) {</a>
<a name="ln2848">                  setMscoreVersion(e.readElementText());</a>
<a name="ln2849">                  parseVersion(mscoreVersion());</a>
<a name="ln2850">                  }</a>
<a name="ln2851">            else if (tag == &quot;programRevision&quot;)</a>
<a name="ln2852">                  setMscoreRevision(e.readInt());</a>
<a name="ln2853">            else if (tag == &quot;Mag&quot;</a>
<a name="ln2854">               || tag == &quot;MagIdx&quot;</a>
<a name="ln2855">               || tag == &quot;xoff&quot;</a>
<a name="ln2856">               || tag == &quot;Symbols&quot;</a>
<a name="ln2857">               || tag == &quot;cursorTrack&quot;</a>
<a name="ln2858">               || tag == &quot;yoff&quot;)</a>
<a name="ln2859">                  e.skipCurrentElement();       // obsolete</a>
<a name="ln2860">            else if (tag == &quot;tempolist&quot;) {</a>
<a name="ln2861">                  // store the tempo list to create invisible tempo text later</a>
<a name="ln2862">                  qreal tempo = e.attribute(&quot;fix&quot;,&quot;2.0&quot;).toDouble();</a>
<a name="ln2863">                  tm.setRelTempo(tempo);</a>
<a name="ln2864">                  while (e.readNextStartElement()) {</a>
<a name="ln2865">                        if (e.name() == &quot;tempo&quot;) {</a>
<a name="ln2866">                              int tick   = e.attribute(&quot;tick&quot;).toInt();</a>
<a name="ln2867">                              double tmp = e.readElementText().toDouble();</a>
<a name="ln2868">                              tick       = (tick * MScore::division + _fileDivision/2) / _fileDivision;</a>
<a name="ln2869">                              auto pos   = tm.find(tick);</a>
<a name="ln2870">                              if (pos != tm.end())</a>
<a name="ln2871">                                    tm.erase(pos);</a>
<a name="ln2872">                              tm.setTempo(tick, tmp);</a>
<a name="ln2873">                        }</a>
<a name="ln2874">                        else if (e.name() == &quot;relTempo&quot;)</a>
<a name="ln2875">                              e.readElementText();</a>
<a name="ln2876">                        else</a>
<a name="ln2877">                              e.unknown();</a>
<a name="ln2878">                  }</a>
<a name="ln2879">            }</a>
<a name="ln2880">            else if (tag == &quot;playMode&quot;)</a>
<a name="ln2881">                  setPlayMode(PlayMode(e.readInt()));</a>
<a name="ln2882">            else if (tag == &quot;SyntiSettings&quot;)</a>
<a name="ln2883">                  _synthesizerState.read(e);</a>
<a name="ln2884">            else if (tag == &quot;Spatium&quot;)</a>
<a name="ln2885">                  setSpatium (e.readDouble() * DPMM);</a>
<a name="ln2886">            else if (tag == &quot;Division&quot;)</a>
<a name="ln2887">                  _fileDivision = e.readInt();</a>
<a name="ln2888">            else if (tag == &quot;showInvisible&quot;)</a>
<a name="ln2889">                  setShowInvisible(e.readInt());</a>
<a name="ln2890">            else if (tag == &quot;showFrames&quot;)</a>
<a name="ln2891">                  setShowFrames(e.readInt());</a>
<a name="ln2892">            else if (tag == &quot;showMargins&quot;)</a>
<a name="ln2893">                  setShowPageborders(e.readInt());</a>
<a name="ln2894">            else if (tag == &quot;Style&quot;) {</a>
<a name="ln2895">                  qreal sp = spatium();</a>
<a name="ln2896">                  readStyle(&amp;style(), e);</a>
<a name="ln2897">                  //style()-&gt;load(e);</a>
<a name="ln2898">                  // adjust this now so chords render properly on read</a>
<a name="ln2899">                  // other style adjustments can wait until reading is finished</a>
<a name="ln2900">                  if (styleB(Sid::useGermanNoteNames))</a>
<a name="ln2901">                        style().set(Sid::useStandardNoteNames, false);</a>
<a name="ln2902">                  if (_layoutMode == LayoutMode::FLOAT) {</a>
<a name="ln2903">                        // style should not change spatium in</a>
<a name="ln2904">                        // float mode</a>
<a name="ln2905">                        setSpatium(sp);</a>
<a name="ln2906">                        }</a>
<a name="ln2907">                  }</a>
<a name="ln2908">            else if (tag == &quot;TextStyle&quot;) {</a>
<a name="ln2909">                  e.skipCurrentElement();</a>
<a name="ln2910">#if 0 // TODO</a>
<a name="ln2911">                  TextStyle s;</a>
<a name="ln2912">                  s.read(e);</a>
<a name="ln2913"> </a>
<a name="ln2914">                  qreal spMM = spatium() / DPMM;</a>
<a name="ln2915">                  if (s.frameWidthMM() != 0.0)</a>
<a name="ln2916">                        s.setFrameWidth(Spatium(s.frameWidthMM() / spMM));</a>
<a name="ln2917">                  if (s.paddingWidthMM() != 0.0)</a>
<a name="ln2918">                        s.setPaddingWidth(Spatium(s.paddingWidthMM() / spMM));</a>
<a name="ln2919"> </a>
<a name="ln2920">                  // convert 1.2 text styles</a>
<a name="ln2921">                  s.setName(convertOldTextStyleNames(s.name()));</a>
<a name="ln2922">                  if (s.family() == &quot;MuseJazz&quot;)</a>
<a name="ln2923">                        s.setFamily(&quot;MuseJazz Text&quot;);</a>
<a name="ln2924"> </a>
<a name="ln2925">                  if (s.name() == &quot;Lyrics Odd Lines&quot; || s.name() == &quot;Lyrics Even Lines&quot;)</a>
<a name="ln2926">                        s.setAlign(Align(int(s.align()) &amp; int(~Align::VMASK)) | Align::BASELINE);</a>
<a name="ln2927"> </a>
<a name="ln2928">                  style().setTextStyle(s);</a>
<a name="ln2929">#endif</a>
<a name="ln2930">                  }</a>
<a name="ln2931">            else if (tag == &quot;page-layout&quot;) {</a>
<a name="ln2932">                  PageFormat pf;</a>
<a name="ln2933">                  readPageFormat(&amp;pf, e);</a>
<a name="ln2934">                  }</a>
<a name="ln2935">            else if (tag == &quot;copyright&quot; || tag == &quot;rights&quot;) {</a>
<a name="ln2936">                  Text* text = new Text(this);</a>
<a name="ln2937">                  readText114(e, text, text);</a>
<a name="ln2938">                  setMetaTag(&quot;copyright&quot;, text-&gt;plainText());</a>
<a name="ln2939">                  delete text;</a>
<a name="ln2940">                  }</a>
<a name="ln2941">            else if (tag == &quot;movement-number&quot;)</a>
<a name="ln2942">                  setMetaTag(&quot;movementNumber&quot;, e.readElementText());</a>
<a name="ln2943">            else if (tag == &quot;movement-title&quot;)</a>
<a name="ln2944">                  setMetaTag(&quot;movementTitle&quot;, e.readElementText());</a>
<a name="ln2945">            else if (tag == &quot;work-number&quot;)</a>
<a name="ln2946">                  setMetaTag(&quot;workNumber&quot;, e.readElementText());</a>
<a name="ln2947">            else if (tag == &quot;work-title&quot;)</a>
<a name="ln2948">                  setMetaTag(&quot;workTitle&quot;, e.readElementText());</a>
<a name="ln2949">            else if (tag == &quot;source&quot;)</a>
<a name="ln2950">                  setMetaTag(&quot;source&quot;, e.readElementText());</a>
<a name="ln2951">            else if (tag == &quot;metaTag&quot;) {</a>
<a name="ln2952">                  QString name = e.attribute(&quot;name&quot;);</a>
<a name="ln2953">                  setMetaTag(name, e.readElementText());</a>
<a name="ln2954">                  }</a>
<a name="ln2955">            else if (tag == &quot;Part&quot;) {</a>
<a name="ln2956">                  Part* part = new Part(this);</a>
<a name="ln2957">                  readPart(part, e);</a>
<a name="ln2958">                  parts().push_back(part);</a>
<a name="ln2959">                  }</a>
<a name="ln2960">            else if (tag == &quot;Slur&quot;) {</a>
<a name="ln2961">                  Slur* slur = new Slur(this);</a>
<a name="ln2962">                  readSlur206(e, slur);</a>
<a name="ln2963">                  addSpanner(slur);</a>
<a name="ln2964">                  }</a>
<a name="ln2965">            else if ((tag == &quot;HairPin&quot;)</a>
<a name="ln2966">                || (tag == &quot;Ottava&quot;)</a>
<a name="ln2967">                || (tag == &quot;TextLine&quot;)</a>
<a name="ln2968">                || (tag == &quot;Volta&quot;)</a>
<a name="ln2969">                || (tag == &quot;Trill&quot;)</a>
<a name="ln2970">                || (tag == &quot;Pedal&quot;)) {</a>
<a name="ln2971">                  Spanner* s = toSpanner(Element::name2Element(tag, this));</a>
<a name="ln2972">                  if (tag == &quot;Volta&quot;)</a>
<a name="ln2973">                        readVolta114(e, toVolta(s));</a>
<a name="ln2974">                  else if (tag == &quot;Ottava&quot;)</a>
<a name="ln2975">                        readOttava114(e, toOttava(s));</a>
<a name="ln2976">                  else if (tag == &quot;TextLine&quot;)</a>
<a name="ln2977">                        readTextLine114(e, toTextLine(s));</a>
<a name="ln2978">                  else if (tag == &quot;Pedal&quot;)</a>
<a name="ln2979">                         readPedal114(e, toPedal(s));</a>
<a name="ln2980">                  else if (tag == &quot;Trill&quot;)</a>
<a name="ln2981">                        readTrill206(e, toTrill(s));</a>
<a name="ln2982">                  else {</a>
<a name="ln2983">                        Q_ASSERT(tag == &quot;HairPin&quot;);</a>
<a name="ln2984">                        readHairpin206(e, toHairpin(s));</a>
<a name="ln2985">                        }</a>
<a name="ln2986">                  if (s-&gt;track() == -1)</a>
<a name="ln2987">                        s-&gt;setTrack(e.track());</a>
<a name="ln2988">                  else</a>
<a name="ln2989">                        e.setTrack(s-&gt;track());       // update current track</a>
<a name="ln2990">                  if (s-&gt;tick() == Fraction(-1,1))</a>
<a name="ln2991">                        s-&gt;setTick(e.tick());</a>
<a name="ln2992">                  else</a>
<a name="ln2993">                        e.setTick(s-&gt;tick());      // update current tick</a>
<a name="ln2994">                  if (s-&gt;track2() == -1)</a>
<a name="ln2995">                        s-&gt;setTrack2(s-&gt;track());</a>
<a name="ln2996">                  if (s-&gt;ticks().isZero()) {</a>
<a name="ln2997">                        qDebug(&quot;zero spanner %s ticks: %d&quot;, s-&gt;name(), s-&gt;ticks().ticks());</a>
<a name="ln2998">                        delete s;</a>
<a name="ln2999">                        }</a>
<a name="ln3000">                  else {</a>
<a name="ln3001">                        addSpanner(s);</a>
<a name="ln3002">                        }</a>
<a name="ln3003">                  }</a>
<a name="ln3004">            else if (tag == &quot;Excerpt&quot;) {</a>
<a name="ln3005">                  if (MScore::noExcerpts)</a>
<a name="ln3006">                        e.skipCurrentElement();</a>
<a name="ln3007">                  else {</a>
<a name="ln3008">                        Excerpt* ex = new Excerpt(this);</a>
<a name="ln3009">                        ex-&gt;read(e);</a>
<a name="ln3010">                        _excerpts.append(ex);</a>
<a name="ln3011">                        }</a>
<a name="ln3012">                  }</a>
<a name="ln3013">            else if (tag == &quot;Beam&quot;) {</a>
<a name="ln3014">                  Beam* beam = new Beam(this);</a>
<a name="ln3015">                  beam-&gt;read(e);</a>
<a name="ln3016">                  beam-&gt;setParent(0);</a>
<a name="ln3017">                  // _beams.append(beam);</a>
<a name="ln3018">                  }</a>
<a name="ln3019">            else if (tag == &quot;name&quot;)</a>
<a name="ln3020">                  setName(e.readElementText());</a>
<a name="ln3021">            else</a>
<a name="ln3022">                  e.unknown();</a>
<a name="ln3023">            }</a>
<a name="ln3024"> </a>
<a name="ln3025">      if (e.error() != QXmlStreamReader::NoError) {</a>
<a name="ln3026">            qDebug(&quot;%lld %lld: %s &quot;, e.lineNumber(), e.columnNumber(), qPrintable(e.errorString()));</a>
<a name="ln3027">            return FileError::FILE_BAD_FORMAT;</a>
<a name="ln3028">            }</a>
<a name="ln3029"> </a>
<a name="ln3030">      for (Staff* s : staves()) {</a>
<a name="ln3031">            int idx   = s-&gt;idx();</a>
<a name="ln3032">            int track = idx * VOICES;</a>
<a name="ln3033"> </a>
<a name="ln3034">            // check barLineSpan</a>
<a name="ln3035">            if (s-&gt;barLineSpan() &gt; (nstaves() - idx)) {</a>
<a name="ln3036">                  qDebug(&quot;read114: invalid barline span %d (max %d)&quot;,</a>
<a name="ln3037">                     s-&gt;barLineSpan(), nstaves() - idx);</a>
<a name="ln3038">                  s-&gt;setBarLineSpan(nstaves() - idx);</a>
<a name="ln3039">                  }</a>
<a name="ln3040">            for (auto i : s-&gt;clefList()) {</a>
<a name="ln3041">                  Fraction tick   = Fraction::fromTicks(i.first);</a>
<a name="ln3042">                  ClefType clefId = i.second._concertClef;</a>
<a name="ln3043">                  Measure* m      = tick2measure(tick);</a>
<a name="ln3044">                  if (!m)</a>
<a name="ln3045">                        continue;</a>
<a name="ln3046">                  SegmentType st = SegmentType::Clef;</a>
<a name="ln3047">                  if (tick == m-&gt;tick()) {</a>
<a name="ln3048">                       if (m-&gt;prevMeasure())</a>
<a name="ln3049">                              m = m-&gt;prevMeasure();</a>
<a name="ln3050">                        else</a>
<a name="ln3051">                              st = SegmentType::HeaderClef;</a>
<a name="ln3052">                        }</a>
<a name="ln3053">                  Segment* seg = m-&gt;getSegment(st, tick);</a>
<a name="ln3054">                  if (seg-&gt;element(track))</a>
<a name="ln3055">                        seg-&gt;element(track)-&gt;setGenerated(false);</a>
<a name="ln3056">                  else {</a>
<a name="ln3057">                        Clef* clef = new Clef(this);</a>
<a name="ln3058">                        clef-&gt;setClefType(clefId);</a>
<a name="ln3059">                        clef-&gt;setTrack(track);</a>
<a name="ln3060">                        clef-&gt;setParent(seg);</a>
<a name="ln3061">                        clef-&gt;setGenerated(false);</a>
<a name="ln3062">                        seg-&gt;add(clef);</a>
<a name="ln3063">                        }</a>
<a name="ln3064">                  }</a>
<a name="ln3065"> </a>
<a name="ln3066">            // create missing KeySig</a>
<a name="ln3067">            KeyList* km = s-&gt;keyList();</a>
<a name="ln3068">            for (auto i = km-&gt;begin(); i != km-&gt;end(); ++i) {</a>
<a name="ln3069">                  Fraction tick = Fraction::fromTicks(i-&gt;first);</a>
<a name="ln3070">                  if (tick &lt; Fraction(0,1)) {</a>
<a name="ln3071">                        qDebug(&quot;read114: Key tick %d&quot;, tick.ticks());</a>
<a name="ln3072">                        continue;</a>
<a name="ln3073">                        }</a>
<a name="ln3074">                  if (tick.isZero() &amp;&amp; i-&gt;second.key() == Key::C)</a>
<a name="ln3075">                        continue;</a>
<a name="ln3076">                  Measure* m = tick2measure(tick);</a>
<a name="ln3077">                  if (!m)           //empty score</a>
<a name="ln3078">                        break;</a>
<a name="ln3079">                  Segment* seg = m-&gt;getSegment(SegmentType::KeySig, tick);</a>
<a name="ln3080">                  if (seg-&gt;element(track))</a>
<a name="ln3081">                        toKeySig(seg-&gt;element(track))-&gt;setGenerated(false);</a>
<a name="ln3082">                  else {</a>
<a name="ln3083">                        KeySigEvent ke = i-&gt;second;</a>
<a name="ln3084">                        KeySig* ks = new KeySig(this);</a>
<a name="ln3085">                        ks-&gt;setKeySigEvent(ke);</a>
<a name="ln3086">                        ks-&gt;setParent(seg);</a>
<a name="ln3087">                        ks-&gt;setTrack(track);</a>
<a name="ln3088">                        ks-&gt;setGenerated(false);</a>
<a name="ln3089">                        seg-&gt;add(ks);</a>
<a name="ln3090">                        }</a>
<a name="ln3091">                  }</a>
<a name="ln3092">            }</a>
<a name="ln3093"> </a>
<a name="ln3094">      for (std::pair&lt;int,Spanner*&gt; p : spanner()) {</a>
<a name="ln3095">            Spanner* s = p.second;</a>
<a name="ln3096">            if (!s-&gt;isSlur()) {</a>
<a name="ln3097">                  if (s-&gt;isVolta()) {</a>
<a name="ln3098">                        Volta* volta = toVolta(s);</a>
<a name="ln3099">                        volta-&gt;setAnchor(Spanner::Anchor::MEASURE);</a>
<a name="ln3100">                        }</a>
<a name="ln3101">                  }</a>
<a name="ln3102"> </a>
<a name="ln3103">            if (s-&gt;isOttava() || s-&gt;isPedal() || s-&gt;isTrill() || s-&gt;isTextLine()) {</a>
<a name="ln3104">                  qreal yo = 0;</a>
<a name="ln3105">                  if (s-&gt;isOttava()) {</a>
<a name="ln3106">                      // fix ottava position</a>
<a name="ln3107">                      yo = styleValue(Pid::OFFSET, Sid::ottavaPosAbove).toPointF().y();</a>
<a name="ln3108">                      if (s-&gt;placeBelow())</a>
<a name="ln3109">                            yo = -yo + s-&gt;staff()-&gt;height();</a>
<a name="ln3110">                      }</a>
<a name="ln3111">                  else if (s-&gt;isPedal()) {</a>
<a name="ln3112">                        yo = styleValue(Pid::OFFSET, Sid::pedalPosBelow).toPointF().y();</a>
<a name="ln3113">                        }</a>
<a name="ln3114">                  else if (s-&gt;isTrill()) {</a>
<a name="ln3115">                        yo = styleValue(Pid::OFFSET, Sid::trillPosAbove).toPointF().y();</a>
<a name="ln3116">                        }</a>
<a name="ln3117">                  else if (s-&gt;isTextLine()) {</a>
<a name="ln3118">                        yo = -5.0 * spatium();</a>
<a name="ln3119">                  }</a>
<a name="ln3120">                  if (!s-&gt;spannerSegments().empty()) {</a>
<a name="ln3121">                        for (SpannerSegment* seg : s-&gt;spannerSegments()) {</a>
<a name="ln3122">                              if (!seg-&gt;offset().isNull())</a>
<a name="ln3123">                                    seg-&gt;ryoffset() = seg-&gt;offset().y() - yo;</a>
<a name="ln3124">                              }</a>
<a name="ln3125">                        }</a>
<a name="ln3126">                  else {</a>
<a name="ln3127">                        s-&gt;ryoffset() = -yo;</a>
<a name="ln3128">                        }</a>
<a name="ln3129">                  }</a>
<a name="ln3130">            }</a>
<a name="ln3131"> </a>
<a name="ln3132">      connectTies();</a>
<a name="ln3133"> </a>
<a name="ln3134">      //</a>
<a name="ln3135">      // remove &quot;middle beam&quot; flags from first ChordRest in</a>
<a name="ln3136">      // measure</a>
<a name="ln3137">      //</a>
<a name="ln3138">      for (Measure* m = firstMeasure(); m; m = m-&gt;nextMeasure()) {</a>
<a name="ln3139">            int tracks = nstaves() * VOICES;</a>
<a name="ln3140">            bool first = true;</a>
<a name="ln3141">            for (int track = 0; track &lt; tracks; ++track) {</a>
<a name="ln3142">                  for (Segment* s = m-&gt;first(); s; s = s-&gt;next()) {</a>
<a name="ln3143">                        if (s-&gt;segmentType() != SegmentType::ChordRest)</a>
<a name="ln3144">                              continue;</a>
<a name="ln3145">                        ChordRest* cr = toChordRest(s-&gt;element(track));</a>
<a name="ln3146">                        if (cr) {</a>
<a name="ln3147">#if 0 // TODO</a>
<a name="ln3148">                              if (cr-&gt;isRest()) {</a>
<a name="ln3149">                                    Rest* r = toRest(cr);</a>
<a name="ln3150">                                    if (!r-&gt;offset().isNull()) {</a>
<a name="ln3151">                                          int lineOffset = r-&gt;computeLineOffset();</a>
<a name="ln3152">                                          qreal lineDist = r-&gt;staff() ? r-&gt;staff()-&gt;staffType(cr-&gt;tick())-&gt;lineDistance().val() : 1.0;</a>
<a name="ln3153">                                          r-&gt;rUserYoffset() -= (lineOffset * .5 * lineDist * r-&gt;spatium());</a>
<a name="ln3154">                                          }</a>
<a name="ln3155">                                    }</a>
<a name="ln3156">#endif</a>
<a name="ln3157">                              if (!first) {</a>
<a name="ln3158">                                    switch (cr-&gt;beamMode()) {</a>
<a name="ln3159">                                          case Beam::Mode::AUTO:</a>
<a name="ln3160">                                          case Beam::Mode::BEGIN:</a>
<a name="ln3161">                                          case Beam::Mode::END:</a>
<a name="ln3162">                                          case Beam::Mode::NONE:</a>
<a name="ln3163">                                                break;</a>
<a name="ln3164">                                          case Beam::Mode::MID:</a>
<a name="ln3165">                                          case Beam::Mode::BEGIN32:</a>
<a name="ln3166">                                          case Beam::Mode::BEGIN64:</a>
<a name="ln3167">                                                cr-&gt;setBeamMode(Beam::Mode::BEGIN);</a>
<a name="ln3168">                                                break;</a>
<a name="ln3169">                                          case Beam::Mode::INVALID:</a>
<a name="ln3170">                                                if (cr-&gt;isChord())</a>
<a name="ln3171">                                                      cr-&gt;setBeamMode(Beam::Mode::AUTO);</a>
<a name="ln3172">                                                else</a>
<a name="ln3173">                                                      cr-&gt;setBeamMode(Beam::Mode::NONE);</a>
<a name="ln3174">                                                break;</a>
<a name="ln3175">                                          }</a>
<a name="ln3176">                                    first = false;</a>
<a name="ln3177">                                    }</a>
<a name="ln3178">                              }</a>
<a name="ln3179">                        }</a>
<a name="ln3180">                  }</a>
<a name="ln3181">            }</a>
<a name="ln3182">      for (MeasureBase* mb = first(); mb; mb = mb-&gt;next()) {</a>
<a name="ln3183">            if (mb-&gt;isVBox()) {</a>
<a name="ln3184">                  VBox* b  = toVBox(mb);</a>
<a name="ln3185">                  qreal y = styleP(Sid::staffUpperBorder);</a>
<a name="ln3186">                  b-&gt;setBottomGap(y);</a>
<a name="ln3187">                  }</a>
<a name="ln3188">            }</a>
<a name="ln3189"> </a>
<a name="ln3190">      _fileDivision = MScore::division;</a>
<a name="ln3191"> </a>
<a name="ln3192">      //</a>
<a name="ln3193">      //    sanity check for barLineSpan and update ottavas</a>
<a name="ln3194">      //</a>
<a name="ln3195">      for (Staff* staff : staves()) {</a>
<a name="ln3196">            int barLineSpan = staff-&gt;barLineSpan();</a>
<a name="ln3197">            int idx = staff-&gt;idx();</a>
<a name="ln3198">            int n = nstaves();</a>
<a name="ln3199">            if (idx + barLineSpan &gt; n) {</a>
<a name="ln3200">                  qDebug(&quot;bad span: idx %d  span %d staves %d&quot;, idx, barLineSpan, n);</a>
<a name="ln3201">                  staff-&gt;setBarLineSpan(n - idx);</a>
<a name="ln3202">                  }</a>
<a name="ln3203">            staff-&gt;updateOttava();</a>
<a name="ln3204">            }</a>
<a name="ln3205"> </a>
<a name="ln3206">      // adjust some styles</a>
<a name="ln3207">      if (styleB(Sid::hideEmptyStaves))        // http://musescore.org/en/node/16228</a>
<a name="ln3208">            style().set(Sid::dontHideStavesInFirstSystem, false);</a>
<a name="ln3209">      if (styleB(Sid::showPageNumberOne)) {    // http://musescore.org/en/node/21207</a>
<a name="ln3210">            style().set(Sid::evenFooterL, QString(&quot;$P&quot;));</a>
<a name="ln3211">            style().set(Sid::oddFooterR, QString(&quot;$P&quot;));</a>
<a name="ln3212">            }</a>
<a name="ln3213">      if (styleI(Sid::minEmptyMeasures) == 0)</a>
<a name="ln3214">            style().set(Sid::minEmptyMeasures, 1);</a>
<a name="ln3215">      style().set(Sid::frameSystemDistance, styleS(Sid::frameSystemDistance) + Spatium(6.0));</a>
<a name="ln3216">      // hack: net overall effect of layout changes has been for things to take slightly more room</a>
<a name="ln3217">      qreal adjustedSpacing = qMax(styleD(Sid::measureSpacing) * 0.95, 1.0);</a>
<a name="ln3218">      style().set(Sid::measureSpacing, adjustedSpacing);</a>
<a name="ln3219"> </a>
<a name="ln3220">      _showOmr = false;</a>
<a name="ln3221"> </a>
<a name="ln3222">      // add invisible tempo text if necessary</a>
<a name="ln3223">      // some 1.3 scores have tempolist but no tempo text</a>
<a name="ln3224">      fixTicks();</a>
<a name="ln3225">      for (auto i : tm) {</a>
<a name="ln3226">            Fraction tick = Fraction::fromTicks(i.first);</a>
<a name="ln3227">            qreal tempo   = i.second.tempo;</a>
<a name="ln3228">            if (tempomap()-&gt;tempo(tick.ticks()) != tempo) {</a>
<a name="ln3229">                  TempoText* tt = new TempoText(this);</a>
<a name="ln3230">                  tt-&gt;setXmlText(QString(&quot;&lt;sym&gt;metNoteQuarterUp&lt;/sym&gt; = %1&quot;).arg(qRound(tempo*60)));</a>
<a name="ln3231">                  tt-&gt;setTempo(tempo);</a>
<a name="ln3232">                  tt-&gt;setTrack(0);</a>
<a name="ln3233">                  tt-&gt;setVisible(false);</a>
<a name="ln3234">                  Measure* m = tick2measure(tick);</a>
<a name="ln3235">                  if (m) {</a>
<a name="ln3236">                        Segment* seg = m-&gt;getSegment(SegmentType::ChordRest, tick);</a>
<a name="ln3237">                        seg-&gt;add(tt);</a>
<a name="ln3238">                        setTempo(tick, tempo);</a>
<a name="ln3239">                        }</a>
<a name="ln3240">                  else</a>
<a name="ln3241">                        delete tt;</a>
<a name="ln3242">                  }</a>
<a name="ln3243">            }</a>
<a name="ln3244"> </a>
<a name="ln3245">      // create excerpts</a>
<a name="ln3246"> </a>
<a name="ln3247">      QList&lt;Excerpt*&gt; readExcerpts;</a>
<a name="ln3248">      readExcerpts.swap(_excerpts);</a>
<a name="ln3249">      for (Excerpt* excerpt : readExcerpts) {</a>
<a name="ln3250">            if (excerpt-&gt;parts().isEmpty())           // ignore empty parts</a>
<a name="ln3251">                  continue;</a>
<a name="ln3252">            if (!excerpt-&gt;parts().isEmpty()) {</a>
<a name="ln3253">                  _excerpts.push_back(excerpt);</a>
<a name="ln3254">                  Score* nscore = new Score(this);</a>
<a name="ln3255">                  excerpt-&gt;setPartScore(nscore);</a>
<a name="ln3256">                  nscore-&gt;style().set(Sid::createMultiMeasureRests, true);</a>
<a name="ln3257">                  Excerpt::createExcerpt(excerpt);</a>
<a name="ln3258">                  }</a>
<a name="ln3259">            }</a>
<a name="ln3260"> </a>
<a name="ln3261">      // volta offsets in older scores are hardcoded to be relative to a voltaY of -2.0sp</a>
<a name="ln3262">      // we'll force this and live with it for the score</a>
<a name="ln3263">      // but we wait until now to do it so parts don't have this issue</a>
<a name="ln3264"> </a>
<a name="ln3265">      if (styleV(Sid::voltaPosAbove) == MScore::baseStyle().value(Sid::voltaPosAbove))</a>
<a name="ln3266">            style().set(Sid::voltaPosAbove, QPointF(0.0, -2.0f));</a>
<a name="ln3267"> </a>
<a name="ln3268">      fixTicks();</a>
<a name="ln3269">      rebuildMidiMapping();</a>
<a name="ln3270">      updateChannel();</a>
<a name="ln3271"> </a>
<a name="ln3272">      // treat reading a 1.14 file as import</a>
<a name="ln3273">      // on save warn if old file will be overwritten</a>
<a name="ln3274">      setCreated(true);</a>
<a name="ln3275">      // don't autosave (as long as there's no change to the score)</a>
<a name="ln3276">      setAutosaveDirty(false);</a>
<a name="ln3277"> </a>
<a name="ln3278">      return FileError::FILE_NO_ERROR;</a>
<a name="ln3279">      }</a>
<a name="ln3280"> </a>
<a name="ln3281">}</a>
<a name="ln3282"> </a>

</code></pre>
<div class="balloon" rel="386"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="402"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="576"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="1539"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="2122"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> Dereferencing of the null pointer 'segment' might take place.</p></div>
<div class="balloon" rel="2781"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="3018"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> Visibility scope of the 'beam' pointer was exited without releasing the memory. A memory leak is possible.</p></div>
<div class="balloon" rel="3176"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1048/" target="_blank">V1048</a> The 'first' variable was assigned the same value.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
