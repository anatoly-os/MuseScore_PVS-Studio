
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>pianoview.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2009-2013 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13"> </a>
<a name="ln14">#include &quot;pianoview.h&quot;</a>
<a name="ln15">#include &quot;pianoruler.h&quot;</a>
<a name="ln16">#include &quot;pianokeyboard.h&quot;</a>
<a name="ln17">#include &quot;shortcut.h&quot;</a>
<a name="ln18">#include &quot;musescore.h&quot;</a>
<a name="ln19">#include &quot;scoreview.h&quot;</a>
<a name="ln20">#include &quot;preferences.h&quot;</a>
<a name="ln21">#include &quot;libmscore/part.h&quot;</a>
<a name="ln22">#include &quot;libmscore/staff.h&quot;</a>
<a name="ln23">#include &quot;libmscore/measure.h&quot;</a>
<a name="ln24">#include &quot;libmscore/chord.h&quot;</a>
<a name="ln25">#include &quot;libmscore/rest.h&quot;</a>
<a name="ln26">#include &quot;libmscore/score.h&quot;</a>
<a name="ln27">#include &quot;libmscore/note.h&quot;</a>
<a name="ln28">#include &quot;libmscore/slur.h&quot;</a>
<a name="ln29">#include &quot;libmscore/tie.h&quot;</a>
<a name="ln30">#include &quot;libmscore/tuplet.h&quot;</a>
<a name="ln31">#include &quot;libmscore/segment.h&quot;</a>
<a name="ln32">#include &quot;libmscore/noteevent.h&quot;</a>
<a name="ln33"> </a>
<a name="ln34">namespace Ms {</a>
<a name="ln35"> </a>
<a name="ln36">extern MuseScore* mscore;</a>
<a name="ln37"> </a>
<a name="ln38">static const qreal MIN_DRAG_DIST_SQ = 9;</a>
<a name="ln39"> </a>
<a name="ln40">const BarPattern PianoView::barPatterns[] = {</a>
<a name="ln41">      {&quot;C maj/A min&quot;,   {1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 0, 1}},</a>
<a name="ln42">      {&quot;Db maj/Bb min&quot;, {1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 0}},</a>
<a name="ln43">      {&quot;D maj/B min&quot;,   {0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1}},</a>
<a name="ln44">      {&quot;Eb maj/C min&quot;,  {1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 0}},</a>
<a name="ln45">      {&quot;E maj/Db min&quot;,  {0, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1}},</a>
<a name="ln46">      {&quot;F maj/D min&quot;,   {1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0}},</a>
<a name="ln47">      {&quot;Gb maj/Eb min&quot;, {0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 1}},</a>
<a name="ln48">      {&quot;G maj/E min&quot;,   {1, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1}},</a>
<a name="ln49">      {&quot;Ab maj/F min&quot;,  {1, 1, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0}},</a>
<a name="ln50">      {&quot;A maj/Gb min&quot;,  {0, 1, 1, 0, 1, 0, 1, 0, 1, 1, 0, 1}},</a>
<a name="ln51">      {&quot;Bb maj/G min&quot;,  {1, 0, 1, 1, 0, 1, 0, 1, 0, 1, 1, 0}},</a>
<a name="ln52">      {&quot;B maj/Ab min&quot;,  {0, 1, 0, 1, 1, 0, 1, 0, 1, 0, 1, 1}},</a>
<a name="ln53">      {&quot;C Diminished&quot;,  {1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0}},</a>
<a name="ln54">      {&quot;Db Diminished&quot;, {0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0}},</a>
<a name="ln55">      {&quot;D Diminished&quot;,  {0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1}},</a>
<a name="ln56">      {&quot;C Half/Whole&quot;,  {1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0}},</a>
<a name="ln57">      {&quot;Db Half/Whole&quot;, {0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1}},</a>
<a name="ln58">      {&quot;D Half/Whole&quot;,  {1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1}},</a>
<a name="ln59">      {&quot;C Whole tone&quot;,  {1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0}},</a>
<a name="ln60">      {&quot;Db Whole tone&quot;, {0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1}},</a>
<a name="ln61">      {&quot;C Augmented&quot;,   {1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0}},</a>
<a name="ln62">      {&quot;Db Augmented&quot;,  {0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0}},</a>
<a name="ln63">      {&quot;D Augmented&quot;,   {0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0}},</a>
<a name="ln64">      {&quot;Eb Augmented&quot;,  {0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1}},</a>
<a name="ln65">      {&quot;&quot;,              {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}}</a>
<a name="ln66">};</a>
<a name="ln67"> </a>
<a name="ln68">//---------------------------------------------------------</a>
<a name="ln69">//   PianoItem</a>
<a name="ln70">//---------------------------------------------------------</a>
<a name="ln71"> </a>
<a name="ln72">PianoItem::PianoItem(Note* n, PianoView* pianoView)</a>
<a name="ln73">   : _note(n), _pianoView(pianoView)</a>
<a name="ln74">      {</a>
<a name="ln75">      }</a>
<a name="ln76"> </a>
<a name="ln77"> </a>
<a name="ln78">//---------------------------------------------------------</a>
<a name="ln79">//   boundingRectTicks</a>
<a name="ln80">//---------------------------------------------------------</a>
<a name="ln81"> </a>
<a name="ln82">QRect PianoItem::boundingRectTicks(NoteEvent* evt)</a>
<a name="ln83">      {</a>
<a name="ln84">      Chord* chord = _note-&gt;chord();</a>
<a name="ln85">      int ticks = chord-&gt;ticks().ticks();</a>
<a name="ln86">      int tieLen = _note-&gt;playTicks() - ticks;</a>
<a name="ln87">      int pitch = _note-&gt;pitch() + (evt ? evt-&gt;pitch() : 0);</a>
<a name="ln88">      int len = (evt ? ticks * evt-&gt;len() / 1000 : ticks) + tieLen;</a>
<a name="ln89"> </a>
<a name="ln90">      int x1 = _note-&gt;chord()-&gt;tick().ticks()</a>
<a name="ln91">            + (evt ? evt-&gt;ontime() * ticks / 1000 : 0);</a>
<a name="ln92">      qreal y1 = pitch;</a>
<a name="ln93"> </a>
<a name="ln94">      QRect rect;</a>
<a name="ln95">      rect.setRect(x1, y1, len, 1);</a>
<a name="ln96">      return rect;</a>
<a name="ln97">      }</a>
<a name="ln98"> </a>
<a name="ln99">//---------------------------------------------------------</a>
<a name="ln100">//   boundingRectPixels</a>
<a name="ln101">//---------------------------------------------------------</a>
<a name="ln102"> </a>
<a name="ln103">QRect PianoItem::boundingRectPixels(NoteEvent* evt)</a>
<a name="ln104">      {</a>
<a name="ln105">      QRect rect = boundingRectTicks(evt);</a>
<a name="ln106"> </a>
<a name="ln107">      qreal tix2pix = _pianoView-&gt;xZoom();</a>
<a name="ln108">      int noteHeight = _pianoView-&gt;noteHeight();</a>
<a name="ln109"> </a>
<a name="ln110">      rect.setRect(_pianoView-&gt;tickToPixelX(rect.x()),</a>
<a name="ln111">              (127 - rect.y()) * noteHeight,</a>
<a name="ln112">              rect.width() * tix2pix,</a>
<a name="ln113">              rect.height() * noteHeight</a>
<a name="ln114">              );</a>
<a name="ln115"> </a>
<a name="ln116">      return rect;</a>
<a name="ln117">      }</a>
<a name="ln118"> </a>
<a name="ln119">//---------------------------------------------------------</a>
<a name="ln120">//   boundingRect</a>
<a name="ln121">//---------------------------------------------------------</a>
<a name="ln122"> </a>
<a name="ln123">QRect PianoItem::boundingRect() {</a>
<a name="ln124">      Chord* chord = _note-&gt;chord();</a>
<a name="ln125">      int ticks = chord-&gt;ticks().ticks();</a>
<a name="ln126">      int tieLen = _note-&gt;playTicks() - ticks;</a>
<a name="ln127">      int len = ticks + tieLen;</a>
<a name="ln128">      int pitch = _note-&gt;pitch();</a>
<a name="ln129"> </a>
<a name="ln130">      qreal tix2pix = _pianoView-&gt;xZoom();</a>
<a name="ln131">      int noteHeight = _pianoView-&gt;noteHeight();</a>
<a name="ln132"> </a>
<a name="ln133">      qreal x1 = _pianoView-&gt;tickToPixelX(_note-&gt;chord()-&gt;tick().ticks());</a>
<a name="ln134">      qreal y1 = (127 - pitch) * noteHeight;</a>
<a name="ln135"> </a>
<a name="ln136">      QRect rect;</a>
<a name="ln137">      rect.setRect(x1, y1, len * tix2pix, noteHeight);</a>
<a name="ln138">      return rect;</a>
<a name="ln139">      }</a>
<a name="ln140"> </a>
<a name="ln141"> </a>
<a name="ln142"> </a>
<a name="ln143">//---------------------------------------------------------</a>
<a name="ln144">//   intersects</a>
<a name="ln145">//---------------------------------------------------------</a>
<a name="ln146"> </a>
<a name="ln147">bool PianoItem::intersectsBlock(int startTick, int endTick, int highPitch, int lowPitch, NoteEvent* evt)</a>
<a name="ln148">      {</a>
<a name="ln149">      QRect r = boundingRectTicks(evt);</a>
<a name="ln150">      int pitch = r.y();</a>
<a name="ln151"> </a>
<a name="ln152">      return r.right() &gt;= startTick &amp;&amp; r.left() &lt;= endTick</a>
<a name="ln153">            &amp;&amp; pitch &gt;= lowPitch &amp;&amp; pitch &lt;= highPitch;</a>
<a name="ln154">      }</a>
<a name="ln155"> </a>
<a name="ln156">//---------------------------------------------------------</a>
<a name="ln157">//   intersects</a>
<a name="ln158">//---------------------------------------------------------</a>
<a name="ln159"> </a>
<a name="ln160">bool PianoItem::intersects(int startTick, int endTick, int highPitch, int lowPitch)</a>
<a name="ln161">      {</a>
<a name="ln162">      if (_pianoView-&gt;playEventsView()) {</a>
<a name="ln163">            for (NoteEvent&amp; e : _note-&gt;playEvents())</a>
<a name="ln164">                  if (intersectsBlock(startTick, endTick, highPitch, lowPitch, &amp;e))</a>
<a name="ln165">                        return true;</a>
<a name="ln166">            return false;</a>
<a name="ln167">            }</a>
<a name="ln168">      else</a>
<a name="ln169">            return intersectsBlock(startTick, endTick, highPitch, lowPitch, 0);</a>
<a name="ln170"> </a>
<a name="ln171">      }</a>
<a name="ln172"> </a>
<a name="ln173"> </a>
<a name="ln174">//---------------------------------------------------------</a>
<a name="ln175">//   getTweakNoteEvent</a>
<a name="ln176">//---------------------------------------------------------</a>
<a name="ln177"> </a>
<a name="ln178">NoteEvent* PianoItem::getTweakNoteEvent()</a>
<a name="ln179">      {</a>
<a name="ln180">      //Get topmost play event for note</a>
<a name="ln181">      if (_note-&gt;playEvents().size() &gt; 0)</a>
<a name="ln182">            return &amp;(_note-&gt;playEvents()[_note-&gt;playEvents().size() - 1]);</a>
<a name="ln183"> </a>
<a name="ln184">      return 0;</a>
<a name="ln185">      }</a>
<a name="ln186"> </a>
<a name="ln187"> </a>
<a name="ln188">//---------------------------------------------------------</a>
<a name="ln189">//   paintNoteBlock</a>
<a name="ln190">//---------------------------------------------------------</a>
<a name="ln191"> </a>
<a name="ln192">void PianoItem::paintNoteBlock(QPainter* painter, NoteEvent* evt)</a>
<a name="ln193">      {</a>
<a name="ln194">      int roundRadius = 3;</a>
<a name="ln195"> </a>
<a name="ln196">      QColor noteDeselected;</a>
<a name="ln197">      QColor noteSelected;</a>
<a name="ln198"> </a>
<a name="ln199">      switch (preferences.globalStyle()) {</a>
<a name="ln200">            case MuseScoreStyleType::DARK_FUSION:</a>
<a name="ln201">                  noteDeselected = QColor(preferences.getColor(PREF_UI_PIANOROLL_DARK_NOTE_UNSEL_COLOR));</a>
<a name="ln202">                  noteSelected = QColor(preferences.getColor(PREF_UI_PIANOROLL_DARK_NOTE_SEL_COLOR));</a>
<a name="ln203">                  break;</a>
<a name="ln204">            default:</a>
<a name="ln205">                  noteDeselected = QColor(preferences.getColor(PREF_UI_PIANOROLL_LIGHT_NOTE_UNSEL_COLOR));</a>
<a name="ln206">                  noteSelected = QColor(preferences.getColor(PREF_UI_PIANOROLL_LIGHT_NOTE_SEL_COLOR));</a>
<a name="ln207">                  break;</a>
<a name="ln208">            }</a>
<a name="ln209"> </a>
<a name="ln210">      QColor noteColor = _note-&gt;selected() ? noteSelected : noteDeselected;</a>
<a name="ln211">      painter-&gt;setBrush(noteColor);</a>
<a name="ln212"> </a>
<a name="ln213">      painter-&gt;setPen(QPen(noteColor.darker(250)));</a>
<a name="ln214">      QRectF bounds = boundingRectPixels(evt);</a>
<a name="ln215">      painter-&gt;drawRoundedRect(bounds, roundRadius, roundRadius);</a>
<a name="ln216"> </a>
<a name="ln217">      //Pitch name</a>
<a name="ln218">      if (bounds.width() &gt;= 20 &amp;&amp; bounds.height() &gt;= 12) {</a>
<a name="ln219">            QRectF textRect(bounds.x() + 2, bounds.y(), bounds.width() - 6, bounds.height() + 1);</a>
<a name="ln220">            QRectF textHiliteRect(bounds.x() + 3, bounds.y() + 1, bounds.width() - 6, bounds.height());</a>
<a name="ln221"> </a>
<a name="ln222">            QFont f(&quot;FreeSans&quot;, 8);</a>
<a name="ln223">            painter-&gt;setFont(f);</a>
<a name="ln224"> </a>
<a name="ln225">            //Note name</a>
<a name="ln226">            QString name = tpc2name(_note-&gt;tpc(), NoteSpellingType::STANDARD, NoteCaseType::AUTO, false);</a>
<a name="ln227">            painter-&gt;setPen(QPen(noteColor.lighter(130)));</a>
<a name="ln228">            painter-&gt;drawText(textHiliteRect,</a>
<a name="ln229">                  Qt::AlignLeft | Qt::AlignTop, name);</a>
<a name="ln230"> </a>
<a name="ln231">            painter-&gt;setPen(QPen(noteColor.darker(180)));</a>
<a name="ln232">            painter-&gt;drawText(textRect,</a>
<a name="ln233">                  Qt::AlignLeft | Qt::AlignTop, name);</a>
<a name="ln234"> </a>
<a name="ln235">            //Voice number</a>
<a name="ln236">            if (bounds.width() &gt;= 26) {</a>
<a name="ln237">                  painter-&gt;setPen(QPen(noteColor.lighter(130)));</a>
<a name="ln238">                  painter-&gt;drawText(textHiliteRect,</a>
<a name="ln239">                        Qt::AlignRight | Qt::AlignTop, QString::number(_note-&gt;voice() + 1));</a>
<a name="ln240"> </a>
<a name="ln241">                  painter-&gt;setPen(QPen(noteColor.darker(180)));</a>
<a name="ln242">                  painter-&gt;drawText(textRect,</a>
<a name="ln243">                        Qt::AlignRight | Qt::AlignTop, QString::number(_note-&gt;voice() + 1));</a>
<a name="ln244">                  }</a>
<a name="ln245">            }</a>
<a name="ln246">      }</a>
<a name="ln247"> </a>
<a name="ln248">//---------------------------------------------------------</a>
<a name="ln249">//   paint</a>
<a name="ln250">//---------------------------------------------------------</a>
<a name="ln251"> </a>
<a name="ln252">void PianoItem::paint(QPainter* painter)</a>
<a name="ln253">      {</a>
<a name="ln254">      painter-&gt;setRenderHints(QPainter::Antialiasing | QPainter::SmoothPixmapTransform | QPainter::TextAntialiasing);</a>
<a name="ln255"> </a>
<a name="ln256">      if (_pianoView-&gt;playEventsView()) {</a>
<a name="ln257">            for (NoteEvent&amp; e : _note-&gt;playEvents())</a>
<a name="ln258">                  paintNoteBlock(painter, &amp;e);</a>
<a name="ln259">            }</a>
<a name="ln260">      else</a>
<a name="ln261">            paintNoteBlock(painter, 0);</a>
<a name="ln262">      }</a>
<a name="ln263"> </a>
<a name="ln264"> </a>
<a name="ln265">//---------------------------------------------------------</a>
<a name="ln266">//   PianoView</a>
<a name="ln267">//---------------------------------------------------------</a>
<a name="ln268"> </a>
<a name="ln269">PianoView::PianoView()</a>
<a name="ln270">   : QGraphicsView()</a>
<a name="ln271">      {</a>
<a name="ln272">      setFrameStyle(QFrame::NoFrame);</a>
<a name="ln273">      setLineWidth(0);</a>
<a name="ln274">      setMidLineWidth(0);</a>
<a name="ln275">      setScene(new QGraphicsScene);</a>
<a name="ln276">      setTransformationAnchor(QGraphicsView::AnchorUnderMouse);</a>
<a name="ln277">      setResizeAnchor(QGraphicsView::AnchorUnderMouse);</a>
<a name="ln278">      setMouseTracking(true);</a>
<a name="ln279">      _timeType = TType::TICKS;</a>
<a name="ln280">      _playEventsView = true;</a>
<a name="ln281">      _staff = 0;</a>
<a name="ln282">      chord = 0;</a>
<a name="ln283">      _barPattern = 0;</a>
<a name="ln284">      _tuplet = 1;</a>
<a name="ln285">      _subdiv = 0;</a>
<a name="ln286">      _noteHeight = DEFAULT_KEY_HEIGHT;</a>
<a name="ln287">      _xZoom = X_ZOOM_INITIAL;</a>
<a name="ln288">      dragStarted = false;</a>
<a name="ln289">      mouseDown = false;</a>
<a name="ln290">      dragStyle = DragStyle::NONE;</a>
<a name="ln291">      inProgressUndoEvent = false;</a>
<a name="ln292">      }</a>
<a name="ln293"> </a>
<a name="ln294">//---------------------------------------------------------</a>
<a name="ln295">//   ~PianoView</a>
<a name="ln296">//---------------------------------------------------------</a>
<a name="ln297"> </a>
<a name="ln298">PianoView::~PianoView()</a>
<a name="ln299">      {</a>
<a name="ln300">      clearNoteData();</a>
<a name="ln301">      }</a>
<a name="ln302"> </a>
<a name="ln303">//---------------------------------------------------------</a>
<a name="ln304">//   drawBackground</a>
<a name="ln305">//---------------------------------------------------------</a>
<a name="ln306"> </a>
<a name="ln307">void PianoView::drawBackground(QPainter* p, const QRectF&amp; r)</a>
<a name="ln308">      {</a>
<a name="ln309">      if (_staff == 0)</a>
<a name="ln310">            return;</a>
<a name="ln311">      Score* _score = _staff-&gt;score();</a>
<a name="ln312">      setFrameShape(QFrame::NoFrame);</a>
<a name="ln313"> </a>
<a name="ln314">      QColor colSelectionBox;</a>
<a name="ln315"> </a>
<a name="ln316">      QColor colWhiteKeyBg;</a>
<a name="ln317">      QColor colGutter;</a>
<a name="ln318">      QColor colBlackKeyBg;</a>
<a name="ln319"> </a>
<a name="ln320">      QColor colGridLine;</a>
<a name="ln321"> </a>
<a name="ln322">      switch (preferences.globalStyle()) {</a>
<a name="ln323">            case MuseScoreStyleType::DARK_FUSION:</a>
<a name="ln324">                  colSelectionBox = QColor(preferences.getColor(PREF_UI_PIANOROLL_DARK_SELECTION_BOX_COLOR));</a>
<a name="ln325"> </a>
<a name="ln326">                  colWhiteKeyBg = QColor(preferences.getColor(PREF_UI_PIANOROLL_DARK_BG_KEY_WHITE_COLOR));</a>
<a name="ln327">                  colGutter = QColor(preferences.getColor(PREF_UI_PIANOROLL_DARK_BG_BASE_COLOR));</a>
<a name="ln328">                  colBlackKeyBg = QColor(preferences.getColor(PREF_UI_PIANOROLL_DARK_BG_KEY_BLACK_COLOR));</a>
<a name="ln329"> </a>
<a name="ln330">                  colGridLine = QColor(preferences.getColor(PREF_UI_PIANOROLL_DARK_BG_GRIDLINE_COLOR));</a>
<a name="ln331">                  break;</a>
<a name="ln332">            default:</a>
<a name="ln333">                  colSelectionBox = QColor(preferences.getColor(PREF_UI_PIANOROLL_LIGHT_SELECTION_BOX_COLOR));</a>
<a name="ln334"> </a>
<a name="ln335">                  colWhiteKeyBg = QColor(preferences.getColor(PREF_UI_PIANOROLL_LIGHT_BG_KEY_WHITE_COLOR));</a>
<a name="ln336">                  colGutter = QColor(preferences.getColor(PREF_UI_PIANOROLL_LIGHT_BG_BASE_COLOR));</a>
<a name="ln337">                  colBlackKeyBg = QColor(preferences.getColor(PREF_UI_PIANOROLL_LIGHT_BG_KEY_BLACK_COLOR));</a>
<a name="ln338"> </a>
<a name="ln339">                  colGridLine = QColor(preferences.getColor(PREF_UI_PIANOROLL_LIGHT_BG_GRIDLINE_COLOR));</a>
<a name="ln340">                  break;</a>
<a name="ln341">            }</a>
<a name="ln342"> </a>
<a name="ln343">      const QColor colSelectionBoxFill = QColor(</a>
<a name="ln344">                        colSelectionBox.red(), colSelectionBox.green(), colSelectionBox.blue(),</a>
<a name="ln345">                        128);</a>
<a name="ln346"> </a>
<a name="ln347">      const QPen penLineMajor = QPen(colGridLine, 2.0, Qt::SolidLine);</a>
<a name="ln348">      const QPen penLineMinor = QPen(colGridLine, 1.0, Qt::SolidLine);</a>
<a name="ln349">      const QPen penLineSub = QPen(colGridLine, 1.0, Qt::DotLine);</a>
<a name="ln350"> </a>
<a name="ln351">      QRectF r1;</a>
<a name="ln352">      r1.setCoords(-1000000.0, 0.0, tickToPixelX(0), 1000000.0);</a>
<a name="ln353">      QRectF r2;</a>
<a name="ln354">      r2.setCoords(tickToPixelX(ticks), 0.0, 1000000.0, 1000000.0);</a>
<a name="ln355"> </a>
<a name="ln356">      p-&gt;fillRect(r, colWhiteKeyBg);</a>
<a name="ln357">      if (r.intersects(r1))</a>
<a name="ln358">            p-&gt;fillRect(r.intersected(r1), colGutter);</a>
<a name="ln359">      if (r.intersects(r2))</a>
<a name="ln360">            p-&gt;fillRect(r.intersected(r2), colGutter);</a>
<a name="ln361"> </a>
<a name="ln362">      //</a>
<a name="ln363">      // draw horizontal grid lines</a>
<a name="ln364">      //</a>
<a name="ln365">      qreal y1 = r.y();</a>
<a name="ln366">      qreal y2 = y1 + r.height();</a>
<a name="ln367">      qreal x1 = qMax(r.x(), (qreal)tickToPixelX(0));</a>
<a name="ln368">      qreal x2 = qMin(x1 + r.width(), (qreal)tickToPixelX(ticks));</a>
<a name="ln369"> </a>
<a name="ln370">      int topPitch = ceil((_noteHeight * 128 - y1) / _noteHeight);</a>
<a name="ln371">      int bmPitch = floor((_noteHeight * 128 - y2) / _noteHeight);</a>
<a name="ln372"> </a>
<a name="ln373">      Part* part = _staff-&gt;part();</a>
<a name="ln374">      Interval transp = part-&gt;instrument()-&gt;transpose();</a>
<a name="ln375"> </a>
<a name="ln376">      //MIDI notes span [0, 127] and map to pitches starting at C-1</a>
<a name="ln377">      for (int pitch = bmPitch; pitch &lt;= topPitch; ++pitch) {</a>
<a name="ln378">            int y = (127 - pitch) * _noteHeight;</a>
<a name="ln379"> </a>
<a name="ln380">            int degree = (pitch - transp.chromatic + 60) % 12;</a>
<a name="ln381">            const BarPattern&amp; pat = barPatterns[_barPattern];</a>
<a name="ln382">//            if (degree == 1 || degree == 3 || degree == 6 || degree == 8 || degree == 10) {</a>
<a name="ln383">              if (!pat.isWhiteKey[degree]) {</a>
<a name="ln384">                  qreal px0 = qMax(r.x(), (qreal)tickToPixelX(0));</a>
<a name="ln385">                  qreal px1 = qMin(r.x() + r.width(), (qreal)tickToPixelX(ticks));</a>
<a name="ln386">                  QRectF hbar;</a>
<a name="ln387"> </a>
<a name="ln388">                  hbar.setCoords(px0, y, px1, y + _noteHeight);</a>
<a name="ln389">                  p-&gt;fillRect(hbar, colBlackKeyBg);</a>
<a name="ln390">            }</a>
<a name="ln391"> </a>
<a name="ln392">            //Lines between rows</a>
<a name="ln393">            p-&gt;setPen(degree == 0 ? penLineMajor : penLineMinor);</a>
<a name="ln394">            p-&gt;drawLine(QLineF(x1, y + _noteHeight, x2, y + _noteHeight));</a>
<a name="ln395">            }</a>
<a name="ln396"> </a>
<a name="ln397">      //</a>
<a name="ln398">      // draw vertical grid lines</a>
<a name="ln399">      //</a>
<a name="ln400">      Pos pos1(_score-&gt;tempomap(), _score-&gt;sigmap(), qMax(pixelXToTick(x1), 0), TType::TICKS);</a>
<a name="ln401">      Pos pos2(_score-&gt;tempomap(), _score-&gt;sigmap(), qMax(pixelXToTick(x2), 0), TType::TICKS);</a>
<a name="ln402"> </a>
<a name="ln403">      int bar1, bar2, beat, tick;</a>
<a name="ln404">      pos1.mbt(&amp;bar1, &amp;beat, &amp;tick);</a>
<a name="ln405">      pos2.mbt(&amp;bar2, &amp;beat, &amp;tick);</a>
<a name="ln406"> </a>
<a name="ln407">      //Draw bar lines</a>
<a name="ln408">      const int minBeatGap = 20;</a>
<a name="ln409"> </a>
<a name="ln410">      for (int bar = bar1; bar &lt;= bar2; ++bar) {</a>
<a name="ln411">            Pos barPos(_score-&gt;tempomap(), _score-&gt;sigmap(), bar, 0, 0);</a>
<a name="ln412"> </a>
<a name="ln413">            //Beat lines</a>
<a name="ln414">            int beatsInBar = barPos.timesig().timesig().numerator();</a>
<a name="ln415">            int ticksPerBeat = barPos.timesig().timesig().beatTicks();</a>
<a name="ln416">            double pixPerBeat = ticksPerBeat * _xZoom;</a>
<a name="ln417">            int beatSkip = ceil(minBeatGap / pixPerBeat);</a>
<a name="ln418"> </a>
<a name="ln419"> </a>
<a name="ln420">//            int subExp = qMin((int)floor(log2(pixPerBeat / minBeatGap)), _subBeats);</a>
<a name="ln421">//            int numSubBeats = pow(2, subExp);</a>
<a name="ln422"> </a>
<a name="ln423">            //Round up to next power of 2</a>
<a name="ln424">            beatSkip = (int)pow(2, ceil(log(beatSkip)/log(2)));</a>
<a name="ln425"> </a>
<a name="ln426">            for (int beat1 = 0; beat1 &lt; beatsInBar; beat1 += beatSkip) {</a>
<a name="ln427">                  Pos beatPos(_score-&gt;tempomap(), _score-&gt;sigmap(), bar, beat1, 0);</a>
<a name="ln428">                  double x = tickToPixelX(beatPos.time(TType::TICKS));</a>
<a name="ln429">                  p-&gt;setPen(penLineMinor);</a>
<a name="ln430">                  p-&gt;drawLine(x, y1, x, y2);</a>
<a name="ln431"> </a>
<a name="ln432">                  int subbeats = _tuplet * (1 &lt;&lt; _subdiv);</a>
<a name="ln433"> </a>
<a name="ln434">                  for (int sub = 1; sub &lt; subbeats; ++sub) {</a>
<a name="ln435">                      Pos subBeatPos(_score-&gt;tempomap(), _score-&gt;sigmap(), bar, beat1, sub * MScore::division / subbeats);</a>
<a name="ln436">                      x = tickToPixelX(subBeatPos.time(TType::TICKS));</a>
<a name="ln437"> </a>
<a name="ln438">                      p-&gt;setPen(penLineSub);</a>
<a name="ln439">                      p-&gt;drawLine(x, y1, x, y2);</a>
<a name="ln440">                      }</a>
<a name="ln441"> </a>
<a name="ln442">                  }</a>
<a name="ln443"> </a>
<a name="ln444">            //Bar line</a>
<a name="ln445">            double x = tickToPixelX(barPos.time(TType::TICKS));</a>
<a name="ln446">            p-&gt;setPen(x &gt; 0 ? penLineMajor : QPen(Qt::black, 2.0));</a>
<a name="ln447">            p-&gt;drawLine(x, y1, x, y2);</a>
<a name="ln448">            }</a>
<a name="ln449"> </a>
<a name="ln450">      //Draw notes</a>
<a name="ln451">      for (int i = 0; i &lt; noteList.size(); ++i)</a>
<a name="ln452">            noteList[i]-&gt;paint(p);</a>
<a name="ln453"> </a>
<a name="ln454">      //Draw locators</a>
<a name="ln455">      for (int i = 0; i &lt; 3; ++i) {</a>
<a name="ln456">            if (_locator[i].valid())</a>
<a name="ln457">                  {</a>
<a name="ln458">                  p-&gt;setPen(QPen(i == 0 ? Qt::red : Qt::blue, 2));</a>
<a name="ln459">                  qreal x = tickToPixelX(_locator[i].time(TType::TICKS));</a>
<a name="ln460">                  p-&gt;drawLine(x, y1, x, y2);</a>
<a name="ln461">                  }</a>
<a name="ln462">            }</a>
<a name="ln463"> </a>
<a name="ln464">      //Draw drag selection box</a>
<a name="ln465">      if (dragStarted &amp;&amp; dragStyle == DragStyle::SELECTION_RECT) {</a>
<a name="ln466">            int minX = qMin(mouseDownPos.x(), lastMousePos.x());</a>
<a name="ln467">            int minY = qMin(mouseDownPos.y(), lastMousePos.y());</a>
<a name="ln468">            int maxX = qMax(mouseDownPos.x(), lastMousePos.x());</a>
<a name="ln469">            int maxY = qMax(mouseDownPos.y(), lastMousePos.y());</a>
<a name="ln470">            QRectF rect(minX, minY, maxX - minX + 1, maxY - minY + 1);</a>
<a name="ln471"> </a>
<a name="ln472">            p-&gt;setPen(QPen(colSelectionBox, 2));</a>
<a name="ln473">            p-&gt;setBrush(QBrush(colSelectionBoxFill, Qt::SolidPattern));</a>
<a name="ln474">            p-&gt;drawRect(rect);</a>
<a name="ln475">            }</a>
<a name="ln476">      }</a>
<a name="ln477"> </a>
<a name="ln478"> </a>
<a name="ln479">//---------------------------------------------------------</a>
<a name="ln480">//   moveLocator</a>
<a name="ln481">//---------------------------------------------------------</a>
<a name="ln482"> </a>
<a name="ln483">void PianoView::moveLocator(int /*i*/)</a>
<a name="ln484">      {</a>
<a name="ln485">      scene()-&gt;update();</a>
<a name="ln486">      }</a>
<a name="ln487"> </a>
<a name="ln488"> </a>
<a name="ln489">//---------------------------------------------------------</a>
<a name="ln490">//   pixelXToTick</a>
<a name="ln491">//---------------------------------------------------------</a>
<a name="ln492"> </a>
<a name="ln493">int PianoView::pixelXToTick(int pixX) {</a>
<a name="ln494">      return static_cast&lt;int&gt;(pixX / _xZoom) - MAP_OFFSET;</a>
<a name="ln495">      }</a>
<a name="ln496"> </a>
<a name="ln497"> </a>
<a name="ln498">//---------------------------------------------------------</a>
<a name="ln499">//   tickToPixelX</a>
<a name="ln500">//---------------------------------------------------------</a>
<a name="ln501"> </a>
<a name="ln502">int PianoView::tickToPixelX(int tick) {</a>
<a name="ln503">      return static_cast&lt;int&gt;(tick + MAP_OFFSET) * _xZoom;</a>
<a name="ln504">      }</a>
<a name="ln505"> </a>
<a name="ln506">//---------------------------------------------------------</a>
<a name="ln507">//   wheelEvent</a>
<a name="ln508">//---------------------------------------------------------</a>
<a name="ln509"> </a>
<a name="ln510">void PianoView::wheelEvent(QWheelEvent* event)</a>
<a name="ln511">      {</a>
<a name="ln512">      int step = event-&gt;delta() / 120;</a>
<a name="ln513"> </a>
<a name="ln514">      if (event-&gt;modifiers() == 0) {</a>
<a name="ln515">            //Vertical scroll</a>
<a name="ln516">            QGraphicsView::wheelEvent(event);</a>
<a name="ln517">            }</a>
<a name="ln518">      else if (event-&gt;modifiers() == Qt::ShiftModifier) {</a>
<a name="ln519">            //Horizontal scroll</a>
<a name="ln520">            QWheelEvent we(event-&gt;pos(), event-&gt;delta(), event-&gt;buttons(), 0, Qt::Horizontal);</a>
<a name="ln521">            QGraphicsView::wheelEvent(&amp;we);</a>
<a name="ln522">            }</a>
<a name="ln523">      else if (event-&gt;modifiers() == Qt::ControlModifier) {</a>
<a name="ln524">            //Vertical zoom</a>
<a name="ln525">            QRectF viewRect = mapToScene(viewport()-&gt;geometry()).boundingRect();</a>
<a name="ln526">            qreal mouseYNote = (event-&gt;y() + (int)viewRect.y()) / (qreal)_noteHeight;</a>
<a name="ln527"> </a>
<a name="ln528">            _noteHeight = qMax(qMin(_noteHeight + step, MAX_KEY_HEIGHT), MIN_KEY_HEIGHT);</a>
<a name="ln529">            emit noteHeightChanged(_noteHeight);</a>
<a name="ln530"> </a>
<a name="ln531">            updateBoundingSize();</a>
<a name="ln532">            updateNotes();</a>
<a name="ln533"> </a>
<a name="ln534">            int mousePixY = static_cast&lt;int&gt;(mouseYNote * _noteHeight);</a>
<a name="ln535">            verticalScrollBar()-&gt;setValue(mousePixY - event-&gt;y());</a>
<a name="ln536"> </a>
<a name="ln537">            scene()-&gt;update();</a>
<a name="ln538">            }</a>
<a name="ln539">      else if (event-&gt;modifiers() == (Qt::ShiftModifier | Qt::ControlModifier)) {</a>
<a name="ln540">            //Horizontal zoom</a>
<a name="ln541"> </a>
<a name="ln542">            QRectF viewRect = mapToScene(viewport()-&gt;geometry()).boundingRect();</a>
<a name="ln543"> </a>
<a name="ln544">            int mouseXTick = pixelXToTick(event-&gt;x() + (int)viewRect.x());</a>
<a name="ln545"> </a>
<a name="ln546">            _xZoom *= pow(X_ZOOM_RATIO, step);</a>
<a name="ln547">            emit xZoomChanged(_xZoom);</a>
<a name="ln548"> </a>
<a name="ln549">            updateBoundingSize();</a>
<a name="ln550">            updateNotes();</a>
<a name="ln551"> </a>
<a name="ln552">            int mousePixX = tickToPixelX(mouseXTick);</a>
<a name="ln553">            horizontalScrollBar()-&gt;setValue(mousePixX - event-&gt;x());</a>
<a name="ln554"> </a>
<a name="ln555">            scene()-&gt;update();</a>
<a name="ln556">            }</a>
<a name="ln557">      }</a>
<a name="ln558"> </a>
<a name="ln559"> </a>
<a name="ln560">//---------------------------------------------------------</a>
<a name="ln561">//   showPopupMenu</a>
<a name="ln562">//---------------------------------------------------------</a>
<a name="ln563"> </a>
<a name="ln564">void PianoView::showPopupMenu(const QPoint&amp; pos)</a>
<a name="ln565">      {</a>
<a name="ln566">      QMenu popup(this);</a>
<a name="ln567">//      popup.addAction(getAction(&quot;cut&quot;));</a>
<a name="ln568">//      popup.addAction(getAction(&quot;copy&quot;));</a>
<a name="ln569">      popup.addAction(getAction(&quot;paste&quot;));</a>
<a name="ln570">//      popup.addAction(getAction(&quot;swap&quot;));</a>
<a name="ln571">      popup.addAction(getAction(&quot;delete&quot;));</a>
<a name="ln572"> </a>
<a name="ln573">      popup.exec(pos);</a>
<a name="ln574">      }</a>
<a name="ln575"> </a>
<a name="ln576">//---------------------------------------------------------</a>
<a name="ln577">//   contextMenuEvent</a>
<a name="ln578">//---------------------------------------------------------</a>
<a name="ln579"> </a>
<a name="ln580">void PianoView::contextMenuEvent(QContextMenuEvent *event)</a>
<a name="ln581">      {</a>
<a name="ln582">      showPopupMenu(event-&gt;globalPos());</a>
<a name="ln583">      }</a>
<a name="ln584"> </a>
<a name="ln585"> </a>
<a name="ln586">//---------------------------------------------------------</a>
<a name="ln587">//   mousePressEvent</a>
<a name="ln588">//---------------------------------------------------------</a>
<a name="ln589"> </a>
<a name="ln590">void PianoView::mousePressEvent(QMouseEvent* event)</a>
<a name="ln591">      {</a>
<a name="ln592">      bool rightBn = event-&gt;button() == Qt::RightButton;</a>
<a name="ln593">      if (!rightBn) {</a>
<a name="ln594">            mouseDown = true;</a>
<a name="ln595">            mouseDownPos = mapToScene(event-&gt;pos());</a>
<a name="ln596">            lastMousePos = mouseDownPos;</a>
<a name="ln597">            }</a>
<a name="ln598">      }</a>
<a name="ln599"> </a>
<a name="ln600">//---------------------------------------------------------</a>
<a name="ln601">//   mouseReleaseEvent</a>
<a name="ln602">//---------------------------------------------------------</a>
<a name="ln603"> </a>
<a name="ln604">void PianoView::mouseReleaseEvent(QMouseEvent* event)</a>
<a name="ln605">      {</a>
<a name="ln606">      int modifiers = QGuiApplication::keyboardModifiers();</a>
<a name="ln607">      bool bnShift = modifiers &amp; Qt::ShiftModifier;</a>
<a name="ln608">      bool bnCtrl = modifiers &amp; Qt::ControlModifier;</a>
<a name="ln609"> </a>
<a name="ln610">      bool rightBn = event-&gt;button() == Qt::RightButton;</a>
<a name="ln611">      if (rightBn) {</a>
<a name="ln612">            //Right clicks have been handled as popup menu</a>
<a name="ln613">            return;</a>
<a name="ln614">            }</a>
<a name="ln615"> </a>
<a name="ln616"> </a>
<a name="ln617">      NoteSelectType selType = bnShift ? (bnCtrl ? NoteSelectType::SUBTRACT : NoteSelectType::XOR)</a>
<a name="ln618">              : (bnCtrl ? NoteSelectType::ADD : NoteSelectType::REPLACE);</a>
<a name="ln619"> </a>
<a name="ln620">      if (dragStarted) {</a>
<a name="ln621">            if (dragStyle == DragStyle::SELECTION_RECT) {</a>
<a name="ln622">                  //Update selection</a>
<a name="ln623">                  qreal minX = qMin(mouseDownPos.x(), lastMousePos.x());</a>
<a name="ln624">                  qreal minY = qMin(mouseDownPos.y(), lastMousePos.y());</a>
<a name="ln625">                  qreal maxX = qMax(mouseDownPos.x(), lastMousePos.x());</a>
<a name="ln626">                  qreal maxY = qMax(mouseDownPos.y(), lastMousePos.y());</a>
<a name="ln627"> </a>
<a name="ln628">                  int startTick = pixelXToTick((int)minX);</a>
<a name="ln629">                  int endTick = pixelXToTick((int)maxX);</a>
<a name="ln630">                  int lowPitch = (int)floor(128 - maxY / noteHeight());</a>
<a name="ln631">                  int highPitch = (int)ceil(128 - minY / noteHeight());</a>
<a name="ln632"> </a>
<a name="ln633">                  selectNotes(startTick, endTick, lowPitch, highPitch, selType);</a>
<a name="ln634">                  }</a>
<a name="ln635">            else if (dragStyle == DragStyle::MOVE_NOTES) {</a>
<a name="ln636">                  //Keep last note drag event, if any</a>
<a name="ln637">                  if (inProgressUndoEvent)</a>
<a name="ln638">                        inProgressUndoEvent = false;</a>
<a name="ln639">                  }</a>
<a name="ln640"> </a>
<a name="ln641">            dragStarted = false;</a>
<a name="ln642">            }</a>
<a name="ln643">      else {</a>
<a name="ln644">            Score* score = _staff-&gt;score();</a>
<a name="ln645"> </a>
<a name="ln646">            int pickTick = pixelXToTick((int)mouseDownPos.x());</a>
<a name="ln647">            int pickPitch = pixelYToPitch(mouseDownPos.y());</a>
<a name="ln648"> </a>
<a name="ln649">            PianoItem *pn = pickNote(pickTick, pickPitch);</a>
<a name="ln650">            if (pn) {</a>
<a name="ln651">                  if (selType == NoteSelectType::REPLACE)</a>
<a name="ln652">                        selType = NoteSelectType::FIRST;</a>
<a name="ln653"> </a>
<a name="ln654">                  mscore-&gt;play(pn-&gt;note());</a>
<a name="ln655">                  score-&gt;setPlayNote(false);</a>
<a name="ln656"> </a>
<a name="ln657">                  selectNotes(pickTick, pickTick + 1, pickPitch, pickPitch, selType);</a>
<a name="ln658">                  }</a>
<a name="ln659">            else {</a>
<a name="ln660">                  if (!bnShift &amp;&amp; !bnCtrl) {</a>
<a name="ln661">                        //Select an empty pixel - should clear selection</a>
<a name="ln662">                        selectNotes(pickTick, pickTick + 1, pickPitch, pickPitch, selType);</a>
<a name="ln663">                        }</a>
<a name="ln664">                  else if (!bnShift &amp;&amp; bnCtrl) {</a>
<a name="ln665"> </a>
<a name="ln666">                        //Insert a new note at nearest subbeat</a>
<a name="ln667">                        int subbeats = _tuplet * (1 &lt;&lt; _subdiv);</a>
<a name="ln668">                        int subbeatTicks = MScore::division / subbeats;</a>
<a name="ln669">                        int roundedTick = (pickTick / subbeatTicks) * subbeatTicks;</a>
<a name="ln670"> </a>
<a name="ln671">                        InputState&amp; is = score-&gt;inputState();</a>
<a name="ln672">                        int voice = score-&gt;inputState().voice();</a>
<a name="ln673">                        int track = _staff-&gt;idx() * VOICES + voice;</a>
<a name="ln674"> </a>
<a name="ln675">                        NoteVal nv(pickPitch);</a>
<a name="ln676"> </a>
<a name="ln677">                        Fraction t = Fraction::fromTicks(roundedTick);</a>
<a name="ln678">                        Segment* seg = score-&gt;tick2segment(t);</a>
<a name="ln679">                        score-&gt;expandVoice(seg, track);</a>
<a name="ln680"> </a>
<a name="ln681">                        ChordRest* e = score-&gt;findCR(t, track);</a>
<a name="ln682">                        if (e &amp;&amp; !e-&gt;tuplet() &amp;&amp; _tuplet == 1) {</a>
<a name="ln683">                              //Ignore tuplets</a>
<a name="ln684">                              score-&gt;startCmd();</a>
<a name="ln685"> </a>
<a name="ln686">                              ChordRest* cr0;</a>
<a name="ln687">                              ChordRest* cr1;</a>
<a name="ln688">                              Fraction frac = is.duration().fraction();</a>
<a name="ln689"> </a>
<a name="ln690">                              //Default to quarter note if faction is invalid</a>
<a name="ln691">                              if (!frac.isValid() || frac.isZero())</a>
<a name="ln692">                                    frac.set(1, 4);</a>
<a name="ln693"> </a>
<a name="ln694">                              if (cutChordRest(e, track, roundedTick, cr0, cr1)) {</a>
<a name="ln695">                                    score-&gt;setNoteRest(cr1-&gt;segment(), track, nv, frac);</a>
<a name="ln696">                                    }</a>
<a name="ln697">                              else {</a>
<a name="ln698">                                    if (cr0-&gt;isChord() &amp;&amp; cr0-&gt;ticks().ticks() == frac.ticks()) {</a>
<a name="ln699">                                          Chord* ch = toChord(cr0);</a>
<a name="ln700">                                          score-&gt;addNote(ch, nv);</a>
<a name="ln701">                                          }</a>
<a name="ln702">                                    else {</a>
<a name="ln703">                                          score-&gt;setNoteRest(cr0-&gt;segment(), track, nv, frac);</a>
<a name="ln704">                                          }</a>
<a name="ln705">                                    }</a>
<a name="ln706"> </a>
<a name="ln707">                              score-&gt;endCmd();</a>
<a name="ln708">                              }</a>
<a name="ln709"> </a>
<a name="ln710">                        }</a>
<a name="ln711">                  else if (bnShift &amp;&amp; !bnCtrl) {</a>
<a name="ln712">                        //Append a pitch to our current chord/rest</a>
<a name="ln713">                        int voice = score-&gt;inputState().voice();</a>
<a name="ln714"> </a>
<a name="ln715">                        //Find best chord to add to</a>
<a name="ln716">                        int track = _staff-&gt;idx() * VOICES + voice;</a>
<a name="ln717"> </a>
<a name="ln718">                        Fraction pt = Fraction::fromTicks(pickTick);</a>
<a name="ln719">                        Segment* seg = score-&gt;tick2segment(pt);</a>
<a name="ln720">                        score-&gt;expandVoice(seg, track);</a>
<a name="ln721"> </a>
<a name="ln722">                        ChordRest* e = score-&gt;findCR(pt, track);</a>
<a name="ln723"> </a>
<a name="ln724">                        if (e &amp;&amp; e-&gt;isChord()) {</a>
<a name="ln725">                              Chord* ch = toChord(e);</a>
<a name="ln726"> </a>
<a name="ln727">                              if (pt &gt;= e-&gt;tick() &amp;&amp; pt &lt; (ch-&gt;tick() + ch-&gt;ticks())) {</a>
<a name="ln728">                                    NoteVal nv(pickPitch);</a>
<a name="ln729">                                    score-&gt;startCmd();</a>
<a name="ln730">                                    score-&gt;addNote(ch, nv);</a>
<a name="ln731">                                    score-&gt;endCmd();</a>
<a name="ln732">                                    }</a>
<a name="ln733"> </a>
<a name="ln734">                              }</a>
<a name="ln735">                        else if (e &amp;&amp; e-&gt;isRest()) {</a>
<a name="ln736">                              Rest* r = toRest(e);</a>
<a name="ln737">                              NoteVal nv(pickPitch);</a>
<a name="ln738">                              score-&gt;startCmd();</a>
<a name="ln739">                              score-&gt;setNoteRest(r-&gt;segment(), track, nv, r-&gt;ticks());</a>
<a name="ln740">                              score-&gt;endCmd();</a>
<a name="ln741">                              }</a>
<a name="ln742">                        }</a>
<a name="ln743">                  else if (bnShift &amp;&amp; bnCtrl) {</a>
<a name="ln744">                        //Cut the chord/rest at the nearest subbeat</a>
<a name="ln745">                        int voice = score-&gt;inputState().voice();</a>
<a name="ln746"> </a>
<a name="ln747">                        //Find best chord to add to</a>
<a name="ln748">                        int track = _staff-&gt;idx() * VOICES + voice;</a>
<a name="ln749"> </a>
<a name="ln750">                        int subbeats = _tuplet * (1 &lt;&lt; _subdiv);</a>
<a name="ln751"> </a>
<a name="ln752">                        int subbeatTicks = MScore::division / subbeats;</a>
<a name="ln753">                        int roundedTick = (pickTick / subbeatTicks) * subbeatTicks;</a>
<a name="ln754"> </a>
<a name="ln755">                        Fraction rt = Fraction::fromTicks(roundedTick);</a>
<a name="ln756">                        Segment* seg = score-&gt;tick2segment(rt);</a>
<a name="ln757">                        score-&gt;expandVoice(seg, track);</a>
<a name="ln758"> </a>
<a name="ln759">                        ChordRest* e = score-&gt;findCR(rt, track);</a>
<a name="ln760">                        if (e &amp;&amp; !e-&gt;tuplet() &amp;&amp; _tuplet == 1) {</a>
<a name="ln761">                              score-&gt;startCmd();</a>
<a name="ln762">                              int startTick = e-&gt;tick().ticks();</a>
<a name="ln763"> </a>
<a name="ln764">                              if (roundedTick != startTick) {</a>
<a name="ln765">                                    ChordRest* cr0;</a>
<a name="ln766">                                    ChordRest* cr1;</a>
<a name="ln767">                                    cutChordRest(e, track, roundedTick, cr0, cr1);</a>
<a name="ln768">                                    }</a>
<a name="ln769">                              score-&gt;endCmd();</a>
<a name="ln770">                              }</a>
<a name="ln771">                        }</a>
<a name="ln772">                  }</a>
<a name="ln773">            }</a>
<a name="ln774"> </a>
<a name="ln775"> </a>
<a name="ln776">      dragStyle = DragStyle::NONE;</a>
<a name="ln777">      mouseDown = false;</a>
<a name="ln778">      scene()-&gt;update();</a>
<a name="ln779">      }</a>
<a name="ln780"> </a>
<a name="ln781"> </a>
<a name="ln782"> </a>
<a name="ln783">//---------------------------------------------------------</a>
<a name="ln784">//   mouseMoveEvent</a>
<a name="ln785">//---------------------------------------------------------</a>
<a name="ln786"> </a>
<a name="ln787">void PianoView::mouseMoveEvent(QMouseEvent* event)</a>
<a name="ln788">      {</a>
<a name="ln789">      lastMousePos = mapToScene(event-&gt;pos());</a>
<a name="ln790"> </a>
<a name="ln791">      if (mouseDown &amp;&amp; !dragStarted) {</a>
<a name="ln792">            qreal dx = lastMousePos.x() - mouseDownPos.x();</a>
<a name="ln793">            qreal dy = lastMousePos.y() - mouseDownPos.y();</a>
<a name="ln794"> </a>
<a name="ln795">            if (dx * dx + dy * dy &gt;= MIN_DRAG_DIST_SQ) {</a>
<a name="ln796">                  //Start dragging</a>
<a name="ln797">                  dragStarted = true;</a>
<a name="ln798"> </a>
<a name="ln799">                  //Check for move note</a>
<a name="ln800">                  int tick = pixelXToTick(mouseDownPos.x());</a>
<a name="ln801">                  int mouseDownPitch = pixelYToPitch(mouseDownPos.y());</a>
<a name="ln802">                  PianoItem* pi = pickNote(tick, mouseDownPitch);</a>
<a name="ln803">                  if (pi) {</a>
<a name="ln804">                        if (!pi-&gt;note()-&gt;selected()) {</a>
<a name="ln805">                              selectNotes(tick, tick, mouseDownPitch, mouseDownPitch, NoteSelectType::REPLACE);</a>
<a name="ln806">                              }</a>
<a name="ln807">                        dragStyle = DragStyle::MOVE_NOTES;</a>
<a name="ln808">                        lastDragPitch = mouseDownPitch;</a>
<a name="ln809">                        }</a>
<a name="ln810">                  else {</a>
<a name="ln811">                        dragStyle = DragStyle::SELECTION_RECT;</a>
<a name="ln812">                        }</a>
<a name="ln813">                  }</a>
<a name="ln814">            }</a>
<a name="ln815"> </a>
<a name="ln816">      if (dragStarted) {</a>
<a name="ln817">            if (dragStyle == DragStyle::MOVE_NOTES) {</a>
<a name="ln818">                  int curPitch = pixelYToPitch(lastMousePos.y());</a>
<a name="ln819">                  if (curPitch != lastDragPitch) {</a>
<a name="ln820">                        int pitchDelta = curPitch - lastDragPitch;</a>
<a name="ln821"> </a>
<a name="ln822">                        Score* score = _staff-&gt;score();</a>
<a name="ln823">                        if (inProgressUndoEvent) {</a>
<a name="ln824">//                              score-&gt;undoRedo(true, 0, false);</a>
<a name="ln825">                              inProgressUndoEvent = false;</a>
<a name="ln826">                              }</a>
<a name="ln827"> </a>
<a name="ln828">                        score-&gt;startCmd();</a>
<a name="ln829">                        score-&gt;upDownDelta(pitchDelta);</a>
<a name="ln830">                        score-&gt;endCmd();</a>
<a name="ln831"> </a>
<a name="ln832">                        inProgressUndoEvent = true;</a>
<a name="ln833">                        lastDragPitch = curPitch;</a>
<a name="ln834">                        }</a>
<a name="ln835">                  }</a>
<a name="ln836"> </a>
<a name="ln837">            scene()-&gt;update();</a>
<a name="ln838">            }</a>
<a name="ln839"> </a>
<a name="ln840"> </a>
<a name="ln841">      //Update mouse tracker</a>
<a name="ln842">      QPointF p(mapToScene(event-&gt;pos()));</a>
<a name="ln843">      int pitch = static_cast&lt;int&gt;((_noteHeight * 128 - p.y()) / _noteHeight);</a>
<a name="ln844">      emit pitchChanged(pitch);</a>
<a name="ln845"> </a>
<a name="ln846">      int tick = pixelXToTick(p.x());</a>
<a name="ln847">      if (tick &lt; 0) {</a>
<a name="ln848">            tick = 0;</a>
<a name="ln849">            trackingPos.setTick(tick);</a>
<a name="ln850">            trackingPos.setInvalid();</a>
<a name="ln851">            }</a>
<a name="ln852">      else</a>
<a name="ln853">            trackingPos.setTick(tick);</a>
<a name="ln854">      emit trackingPosChanged(trackingPos);</a>
<a name="ln855">      }</a>
<a name="ln856"> </a>
<a name="ln857">//---------------------------------------------------------</a>
<a name="ln858">//   cutChordRest</a>
<a name="ln859">//---------------------------------------------------------</a>
<a name="ln860"> </a>
<a name="ln861">bool PianoView::cutChordRest(ChordRest* e, int track, int cutTick, ChordRest*&amp; cr0, ChordRest*&amp; cr1)</a>
<a name="ln862">      {</a>
<a name="ln863">      int startTick = e-&gt;segment()-&gt;tick().ticks();</a>
<a name="ln864">      int tcks = e-&gt;ticks().ticks();</a>
<a name="ln865">      if (cutTick &lt;= startTick || cutTick &gt; startTick + tcks) {</a>
<a name="ln866">            cr0 = e;</a>
<a name="ln867">            cr1 = 0;</a>
<a name="ln868">            return false;</a>
<a name="ln869">            }</a>
<a name="ln870"> </a>
<a name="ln871">      //Deselect note being cut</a>
<a name="ln872">      if (e-&gt;isChord()) {</a>
<a name="ln873">            Chord* ch = toChord(e);</a>
<a name="ln874">            for (Note* n: ch-&gt;notes()) {</a>
<a name="ln875">                  n-&gt;setSelected(false);</a>
<a name="ln876">                  }</a>
<a name="ln877">            }</a>
<a name="ln878">      else if (e-&gt;isRest()) {</a>
<a name="ln879">            Rest* r = toRest(e);</a>
<a name="ln880">            r-&gt;setSelected(false);</a>
<a name="ln881">            }</a>
<a name="ln882"> </a>
<a name="ln883"> </a>
<a name="ln884">      //Subdivide at the cut tick</a>
<a name="ln885">      NoteVal nv(-1);</a>
<a name="ln886"> </a>
<a name="ln887">      Score* score = _staff-&gt;score();</a>
<a name="ln888">      score-&gt;setNoteRest(e-&gt;segment(), track, nv, Fraction::fromTicks(cutTick) - e-&gt;tick());</a>
<a name="ln889">      ChordRest *nextCR = score-&gt;findCR(Fraction::fromTicks(cutTick), track);</a>
<a name="ln890"> </a>
<a name="ln891">//      nextCR-&gt;segment()-&gt;setTick(cutTick);</a>
<a name="ln892">      Chord* ch0 = 0;</a>
<a name="ln893"> </a>
<a name="ln894">      if (nextCR-&gt;isChord()) {</a>
<a name="ln895">            //Copy chord into initial segment</a>
<a name="ln896">            Chord* ch1 = toChord(nextCR);</a>
<a name="ln897"> </a>
<a name="ln898">            for (Note* n: ch1-&gt;notes()) {</a>
<a name="ln899">                  NoteVal nx = n-&gt;noteVal();</a>
<a name="ln900">                  if (!ch0) {</a>
<a name="ln901">                        ChordRest* cr = score-&gt;findCR(Fraction::fromTicks(startTick), track);</a>
<a name="ln902">                        score-&gt;setNoteRest(cr-&gt;segment(), track, nx, cr-&gt;ticks());</a>
<a name="ln903">                        ch0 = toChord(score-&gt;findCR(Fraction::fromTicks(startTick), track));</a>
<a name="ln904">                        }</a>
<a name="ln905">                  else {</a>
<a name="ln906">                        score-&gt;addNote(ch0, nx);</a>
<a name="ln907">                        }</a>
<a name="ln908">                  }</a>
<a name="ln909">            }</a>
<a name="ln910"> </a>
<a name="ln911">      cr0 = ch0;</a>
<a name="ln912">      cr1 = nextCR;</a>
<a name="ln913">      return true;</a>
<a name="ln914">      }</a>
<a name="ln915"> </a>
<a name="ln916">//---------------------------------------------------------</a>
<a name="ln917">//   selectNotes</a>
<a name="ln918">//---------------------------------------------------------</a>
<a name="ln919"> </a>
<a name="ln920">PianoItem* PianoView::pickNote(int tick, int pitch)</a>
<a name="ln921">      {</a>
<a name="ln922">      for (int i = 0; i &lt; noteList.size(); ++i) {</a>
<a name="ln923">            PianoItem* pi = noteList[i];</a>
<a name="ln924"> </a>
<a name="ln925">            if (pi-&gt;intersects(tick, tick, pitch, pitch))</a>
<a name="ln926">                  return pi;</a>
<a name="ln927">            }</a>
<a name="ln928"> </a>
<a name="ln929">      return 0;</a>
<a name="ln930">      }</a>
<a name="ln931"> </a>
<a name="ln932">//---------------------------------------------------------</a>
<a name="ln933">//   selectNotes</a>
<a name="ln934">//---------------------------------------------------------</a>
<a name="ln935"> </a>
<a name="ln936">void PianoView::selectNotes(int startTick, int endTick, int lowPitch, int highPitch, NoteSelectType selType)</a>
<a name="ln937">      {</a>
<a name="ln938">      Score* score = _staff-&gt;score();</a>
<a name="ln939">      //score-&gt;masterScore()-&gt;cmdState().reset();      // DEBUG: should not be necessary</a>
<a name="ln940">      score-&gt;startCmd();</a>
<a name="ln941"> </a>
<a name="ln942">      QList&lt;PianoItem*&gt; oldSel;</a>
<a name="ln943">      for (int i = 0; i &lt; noteList.size(); ++i) {</a>
<a name="ln944">            PianoItem* pi = noteList[i];</a>
<a name="ln945">            if (pi-&gt;note()-&gt;selected())</a>
<a name="ln946">                  oldSel.append(pi);</a>
<a name="ln947">            }</a>
<a name="ln948"> </a>
<a name="ln949">      Selection&amp; selection = score-&gt;selection();</a>
<a name="ln950">      selection.deselectAll();</a>
<a name="ln951"> </a>
<a name="ln952">      for (int i = 0; i &lt; noteList.size(); ++i) {</a>
<a name="ln953">            PianoItem* pi = noteList[i];</a>
<a name="ln954">            bool inBounds = pi-&gt;intersects(startTick, endTick, highPitch, lowPitch);</a>
<a name="ln955"> </a>
<a name="ln956">            bool sel;</a>
<a name="ln957">            switch (selType) {</a>
<a name="ln958">                  default:</a>
<a name="ln959">                  case NoteSelectType::REPLACE:</a>
<a name="ln960">                        sel = inBounds;</a>
<a name="ln961">                        break;</a>
<a name="ln962">                  case NoteSelectType::XOR:</a>
<a name="ln963">                        sel = inBounds != oldSel.contains(pi);</a>
<a name="ln964">                        break;</a>
<a name="ln965">                  case NoteSelectType::ADD:</a>
<a name="ln966">                        sel = inBounds || oldSel.contains(pi);</a>
<a name="ln967">                        break;</a>
<a name="ln968">                  case NoteSelectType::SUBTRACT:</a>
<a name="ln969">                        sel = !inBounds &amp;&amp; oldSel.contains(pi);</a>
<a name="ln970">                        break;</a>
<a name="ln971">                  case NoteSelectType::FIRST:</a>
<a name="ln972">                        sel = inBounds &amp;&amp; selection.elements().empty();</a>
<a name="ln973">                        break;</a>
<a name="ln974">                  }</a>
<a name="ln975"> </a>
<a name="ln976">            if (sel)</a>
<a name="ln977">                  selection.add(pi-&gt;note());</a>
<a name="ln978">            }</a>
<a name="ln979"> </a>
<a name="ln980">      for (MuseScoreView* view : score-&gt;getViewer())</a>
<a name="ln981">            view-&gt;updateAll();</a>
<a name="ln982"> </a>
<a name="ln983">      scene()-&gt;update();</a>
<a name="ln984">      score-&gt;setUpdateAll();</a>
<a name="ln985">      score-&gt;update();</a>
<a name="ln986">      score-&gt;endCmd();</a>
<a name="ln987"> </a>
<a name="ln988">      emit selectionChanged();</a>
<a name="ln989">      }</a>
<a name="ln990"> </a>
<a name="ln991">//---------------------------------------------------------</a>
<a name="ln992">//   leaveEvent</a>
<a name="ln993">//---------------------------------------------------------</a>
<a name="ln994"> </a>
<a name="ln995">void PianoView::leaveEvent(QEvent* event)</a>
<a name="ln996">      {</a>
<a name="ln997">      emit pitchChanged(-1);</a>
<a name="ln998">      trackingPos.setInvalid();</a>
<a name="ln999">      emit trackingPosChanged(trackingPos);</a>
<a name="ln1000">      QGraphicsView::leaveEvent(event);</a>
<a name="ln1001">      }</a>
<a name="ln1002"> </a>
<a name="ln1003">//---------------------------------------------------------</a>
<a name="ln1004">//   ensureVisible</a>
<a name="ln1005">//---------------------------------------------------------</a>
<a name="ln1006"> </a>
<a name="ln1007">void PianoView::ensureVisible(int tick)</a>
<a name="ln1008">      {</a>
<a name="ln1009">      QRectF rect = mapToScene(viewport()-&gt;geometry()).boundingRect();</a>
<a name="ln1010"> </a>
<a name="ln1011">      qreal xpos = tickToPixelX(tick);</a>
<a name="ln1012">      qreal margin = rect.width() / 2;</a>
<a name="ln1013">      if (xpos &lt; rect.x() + margin)</a>
<a name="ln1014">            horizontalScrollBar()-&gt;setValue(qMax(xpos - margin, 0.0));</a>
<a name="ln1015">      else if (xpos &gt;= rect.x() + rect.width() - margin)</a>
<a name="ln1016">            horizontalScrollBar()-&gt;setValue(qMax(xpos - rect.width() + margin, 0.0));</a>
<a name="ln1017">      }</a>
<a name="ln1018"> </a>
<a name="ln1019">//---------------------------------------------------------</a>
<a name="ln1020">//   updateBoundingSize</a>
<a name="ln1021">//---------------------------------------------------------</a>
<a name="ln1022">void PianoView::updateBoundingSize()</a>
<a name="ln1023">      {</a>
<a name="ln1024">      Measure* lm = _staff-&gt;score()-&gt;lastMeasure();</a>
<a name="ln1025">      ticks       = (lm-&gt;tick() + lm-&gt;ticks()).ticks();</a>
<a name="ln1026">      scene()-&gt;setSceneRect(0.0, 0.0,</a>
<a name="ln1027">              double((ticks + MAP_OFFSET * 2) * _xZoom),</a>
<a name="ln1028">              _noteHeight * 128);</a>
<a name="ln1029">      }</a>
<a name="ln1030"> </a>
<a name="ln1031">//---------------------------------------------------------</a>
<a name="ln1032">//   setStaff</a>
<a name="ln1033">//---------------------------------------------------------</a>
<a name="ln1034"> </a>
<a name="ln1035">void PianoView::setStaff(Staff* s, Pos* l)</a>
<a name="ln1036">      {</a>
<a name="ln1037">      _locator = l;</a>
<a name="ln1038"> </a>
<a name="ln1039">      if (_staff == s)</a>
<a name="ln1040">            return;</a>
<a name="ln1041"> </a>
<a name="ln1042">      _staff    = s;</a>
<a name="ln1043">      setEnabled(_staff != nullptr);</a>
<a name="ln1044">      if (!_staff) {</a>
<a name="ln1045">            scene()-&gt;blockSignals(true);  // block changeSelection()</a>
<a name="ln1046">            scene()-&gt;clear();</a>
<a name="ln1047">            clearNoteData();</a>
<a name="ln1048">            scene()-&gt;blockSignals(false);</a>
<a name="ln1049">            return;</a>
<a name="ln1050">            }</a>
<a name="ln1051"> </a>
<a name="ln1052">      trackingPos.setContext(_staff-&gt;score()-&gt;tempomap(), _staff-&gt;score()-&gt;sigmap());</a>
<a name="ln1053">      updateBoundingSize();</a>
<a name="ln1054"> </a>
<a name="ln1055">      updateNotes();</a>
<a name="ln1056"> </a>
<a name="ln1057">      QRectF boundingRect;</a>
<a name="ln1058">      bool brInit = false;</a>
<a name="ln1059">      QRectF boundingRectSel;</a>
<a name="ln1060">      bool brsInit = false;</a>
<a name="ln1061"> </a>
<a name="ln1062">      foreach (PianoItem* item, noteList) {</a>
<a name="ln1063">            if (!brInit) {</a>
<a name="ln1064">                  boundingRect = item-&gt;boundingRect();</a>
<a name="ln1065">                  brInit = true;</a>
<a name="ln1066">                  }</a>
<a name="ln1067">            else</a>
<a name="ln1068">                  boundingRect |= item-&gt;boundingRect();</a>
<a name="ln1069"> </a>
<a name="ln1070">            if (item-&gt;note()-&gt;selected()) {</a>
<a name="ln1071">                  if (!brsInit) {</a>
<a name="ln1072">                        boundingRectSel = item-&gt;boundingRect();</a>
<a name="ln1073">                        brsInit = true;</a>
<a name="ln1074">                        }</a>
<a name="ln1075">                  else</a>
<a name="ln1076">                        boundingRectSel |= item-&gt;boundingRect();</a>
<a name="ln1077">                  }</a>
<a name="ln1078"> </a>
<a name="ln1079">            }</a>
<a name="ln1080"> </a>
<a name="ln1081">      QRectF viewRect = mapToScene(viewport()-&gt;geometry()).boundingRect();</a>
<a name="ln1082"> </a>
<a name="ln1083">      if (brsInit) {</a>
<a name="ln1084">            horizontalScrollBar()-&gt;setValue(boundingRectSel.x());</a>
<a name="ln1085">            verticalScrollBar()-&gt;setValue(qMax(boundingRectSel.y() + (boundingRectSel.height() - viewRect.height()) / 2, 0.0));</a>
<a name="ln1086">            }</a>
<a name="ln1087">      else if (brInit) {</a>
<a name="ln1088">            horizontalScrollBar()-&gt;setValue(boundingRect.x());</a>
<a name="ln1089">            verticalScrollBar()-&gt;setValue(qMax(boundingRect.y() - (boundingRectSel.height() - viewRect.height()) / 2, 0.0));</a>
<a name="ln1090">            }</a>
<a name="ln1091">      else {</a>
<a name="ln1092">            horizontalScrollBar()-&gt;setValue(0);</a>
<a name="ln1093">            verticalScrollBar()-&gt;setValue(qMax(viewRect.y() - viewRect.height() / 2, 0.0));</a>
<a name="ln1094">            }</a>
<a name="ln1095">      }</a>
<a name="ln1096"> </a>
<a name="ln1097">//---------------------------------------------------------</a>
<a name="ln1098">//   addChord</a>
<a name="ln1099">//---------------------------------------------------------</a>
<a name="ln1100"> </a>
<a name="ln1101">void PianoView::addChord(Chord* chrd, int voice)</a>
<a name="ln1102">      {</a>
<a name="ln1103">      for (Chord* c : chrd-&gt;graceNotes())</a>
<a name="ln1104">            addChord(c, voice);</a>
<a name="ln1105">      for (Note* note : chrd-&gt;notes()) {</a>
<a name="ln1106">            if (note-&gt;tieBack())</a>
<a name="ln1107">                  continue;</a>
<a name="ln1108">            noteList.append(new PianoItem(note, this));</a>
<a name="ln1109">            }</a>
<a name="ln1110">      }</a>
<a name="ln1111"> </a>
<a name="ln1112">//---------------------------------------------------------</a>
<a name="ln1113">//   updateNotes</a>
<a name="ln1114">//---------------------------------------------------------</a>
<a name="ln1115"> </a>
<a name="ln1116">void PianoView::updateNotes()</a>
<a name="ln1117">      {</a>
<a name="ln1118">      scene()-&gt;blockSignals(true);  // block changeSelection()</a>
<a name="ln1119">      scene()-&gt;clearFocus();</a>
<a name="ln1120">      scene()-&gt;clear();</a>
<a name="ln1121">      clearNoteData();</a>
<a name="ln1122"> </a>
<a name="ln1123">      int staffIdx = _staff-&gt;idx();</a>
<a name="ln1124">      if (staffIdx == -1)</a>
<a name="ln1125">            return;</a>
<a name="ln1126"> </a>
<a name="ln1127">      SegmentType st = SegmentType::ChordRest;</a>
<a name="ln1128">      for (Segment* s = _staff-&gt;score()-&gt;firstSegment(st); s; s = s-&gt;next1(st)) {</a>
<a name="ln1129">            for (int voice = 0; voice &lt; VOICES; ++voice) {</a>
<a name="ln1130">                  int track = voice + staffIdx * VOICES;</a>
<a name="ln1131">                  Element* e = s-&gt;element(track);</a>
<a name="ln1132">                  if (e &amp;&amp; e-&gt;isChord())</a>
<a name="ln1133">                        addChord(toChord(e), voice);</a>
<a name="ln1134">                  }</a>
<a name="ln1135">            }</a>
<a name="ln1136">      for (int i = 0; i &lt; 3; ++i)</a>
<a name="ln1137">            moveLocator(i);</a>
<a name="ln1138">      scene()-&gt;blockSignals(false);</a>
<a name="ln1139"> </a>
<a name="ln1140">      scene()-&gt;update(sceneRect());</a>
<a name="ln1141">      }</a>
<a name="ln1142"> </a>
<a name="ln1143">//---------------------------------------------------------</a>
<a name="ln1144">//   updateNotes</a>
<a name="ln1145">//---------------------------------------------------------</a>
<a name="ln1146"> </a>
<a name="ln1147">void PianoView::clearNoteData()</a>
<a name="ln1148">      {</a>
<a name="ln1149">      for (int i = 0; i &lt; noteList.size(); ++i)</a>
<a name="ln1150">            delete noteList[i];</a>
<a name="ln1151"> </a>
<a name="ln1152">      noteList.clear();</a>
<a name="ln1153">      }</a>
<a name="ln1154"> </a>
<a name="ln1155"> </a>
<a name="ln1156">//---------------------------------------------------------</a>
<a name="ln1157">//   getSelectedItems</a>
<a name="ln1158">//---------------------------------------------------------</a>
<a name="ln1159"> </a>
<a name="ln1160">QList&lt;PianoItem*&gt; PianoView::getSelectedItems()</a>
<a name="ln1161">      {</a>
<a name="ln1162">      QList&lt;PianoItem*&gt; list;</a>
<a name="ln1163">      for (int i = 0; i &lt; noteList.size(); ++i) {</a>
<a name="ln1164">            if (noteList[i]-&gt;note()-&gt;selected())</a>
<a name="ln1165">                  list.append(noteList[i]);</a>
<a name="ln1166">            }</a>
<a name="ln1167">      return list;</a>
<a name="ln1168">      }</a>
<a name="ln1169"> </a>
<a name="ln1170">//---------------------------------------------------------</a>
<a name="ln1171">//   getItems</a>
<a name="ln1172">//---------------------------------------------------------</a>
<a name="ln1173"> </a>
<a name="ln1174">QList&lt;PianoItem*&gt; PianoView::getItems()</a>
<a name="ln1175">      {</a>
<a name="ln1176">      QList&lt;PianoItem*&gt; list;</a>
<a name="ln1177">      for (int i = 0; i &lt; noteList.size(); ++i)</a>
<a name="ln1178">            list.append(noteList[i]);</a>
<a name="ln1179">      return list;</a>
<a name="ln1180">      }</a>
<a name="ln1181"> </a>
<a name="ln1182">//---------------------------------------------------------</a>
<a name="ln1183">//   getAction</a>
<a name="ln1184">//    returns action for shortcut</a>
<a name="ln1185">//---------------------------------------------------------</a>
<a name="ln1186"> </a>
<a name="ln1187">QAction* PianoView::getAction(const char* id)</a>
<a name="ln1188">      {</a>
<a name="ln1189">      Shortcut* s = Shortcut::getShortcut(id);</a>
<a name="ln1190">      return s ? s-&gt;action() : 0;</a>
<a name="ln1191">      }</a>
<a name="ln1192"> </a>
<a name="ln1193">//---------------------------------------------------------</a>
<a name="ln1194">//   setXZoom</a>
<a name="ln1195">//---------------------------------------------------------</a>
<a name="ln1196"> </a>
<a name="ln1197">void PianoView::setXZoom(int value)</a>
<a name="ln1198">      {</a>
<a name="ln1199">      if (_xZoom != value) {</a>
<a name="ln1200">            _xZoom = value;</a>
<a name="ln1201">            scene()-&gt;update();</a>
<a name="ln1202">            emit xZoomChanged(_xZoom);</a>
<a name="ln1203">            }</a>
<a name="ln1204">      }</a>
<a name="ln1205"> </a>
<a name="ln1206">//---------------------------------------------------------</a>
<a name="ln1207">//   setBarPattern</a>
<a name="ln1208">//---------------------------------------------------------</a>
<a name="ln1209"> </a>
<a name="ln1210">void PianoView::setBarPattern(int value)</a>
<a name="ln1211">      {</a>
<a name="ln1212">      if (_barPattern != value) {</a>
<a name="ln1213">            _barPattern = value;</a>
<a name="ln1214">            scene()-&gt;update();</a>
<a name="ln1215">            emit barPatternChanged(_barPattern);</a>
<a name="ln1216">            }</a>
<a name="ln1217">      }</a>
<a name="ln1218"> </a>
<a name="ln1219">//---------------------------------------------------------</a>
<a name="ln1220">//   setSubBeats</a>
<a name="ln1221">//---------------------------------------------------------</a>
<a name="ln1222"> </a>
<a name="ln1223">void PianoView::setTuplet(int value)</a>
<a name="ln1224">      {</a>
<a name="ln1225">      if (_tuplet != value) {</a>
<a name="ln1226">            _tuplet = value;</a>
<a name="ln1227">            scene()-&gt;update();</a>
<a name="ln1228">            emit tupletChanged(_tuplet);</a>
<a name="ln1229">            }</a>
<a name="ln1230">      }</a>
<a name="ln1231"> </a>
<a name="ln1232">//---------------------------------------------------------</a>
<a name="ln1233">//   setSubdiv</a>
<a name="ln1234">//---------------------------------------------------------</a>
<a name="ln1235"> </a>
<a name="ln1236">void PianoView::setSubdiv(int value)</a>
<a name="ln1237">      {</a>
<a name="ln1238">      if (_subdiv != value) {</a>
<a name="ln1239">            _subdiv = value;</a>
<a name="ln1240">            scene()-&gt;update();</a>
<a name="ln1241">            emit subdivChanged(_subdiv);</a>
<a name="ln1242">            }</a>
<a name="ln1243">      }</a>
<a name="ln1244"> </a>
<a name="ln1245">}</a>

</code></pre>
<div class="balloon" rel="269"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: _locator, ticks, lastDragPitch.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
