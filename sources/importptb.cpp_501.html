
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>importptb.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">#include &quot;importptb.h&quot;</a>
<a name="ln2">#include &quot;assert.h&quot;</a>
<a name="ln3"> </a>
<a name="ln4">#include &lt;libmscore/part.h&gt;</a>
<a name="ln5">#include &lt;libmscore/staff.h&gt;</a>
<a name="ln6">#include &lt;libmscore/measure.h&gt;</a>
<a name="ln7">#include &lt;libmscore/symbol.h&gt;</a>
<a name="ln8">#include &lt;libmscore/tie.h&gt;</a>
<a name="ln9">#include &lt;libmscore/bend.h&gt;</a>
<a name="ln10">#include &lt;libmscore/timesig.h&gt;</a>
<a name="ln11">#include &lt;libmscore/sym.h&gt;</a>
<a name="ln12">#include &lt;libmscore/articulation.h&gt;</a>
<a name="ln13">#include &lt;libmscore/tuplet.h&gt;</a>
<a name="ln14">#include &lt;libmscore/instrument.h&gt;</a>
<a name="ln15">#include &lt;libmscore/clef.h&gt;</a>
<a name="ln16">#include &lt;libmscore/rest.h&gt;</a>
<a name="ln17">#include &lt;libmscore/stafftext.h&gt;</a>
<a name="ln18">#include &lt;libmscore/chord.h&gt;</a>
<a name="ln19">#include &lt;libmscore/tempotext.h&gt;</a>
<a name="ln20">#include &lt;libmscore/excerpt.h&gt;</a>
<a name="ln21">#include &lt;libmscore/rehearsalmark.h&gt;</a>
<a name="ln22">#include &lt;libmscore/bracketItem.h&gt;</a>
<a name="ln23">#include &lt;libmscore/box.h&gt;</a>
<a name="ln24">#include &lt;libmscore/palmmute.h&gt;</a>
<a name="ln25"> </a>
<a name="ln26">namespace Ms {</a>
<a name="ln27"> </a>
<a name="ln28">bool PowerTab::readBoolean()</a>
<a name="ln29">      {</a>
<a name="ln30">      return readUChar() != 0;</a>
<a name="ln31">      }</a>
<a name="ln32"> </a>
<a name="ln33">unsigned char PowerTab::readUChar()</a>
<a name="ln34">      {</a>
<a name="ln35">      unsigned char byte;</a>
<a name="ln36">      _file-&gt;read((char*)&amp;byte, 1);</a>
<a name="ln37">      return byte;</a>
<a name="ln38">      }</a>
<a name="ln39"> </a>
<a name="ln40">unsigned short PowerTab::readShort()</a>
<a name="ln41">      {</a>
<a name="ln42">      uint16_t val;</a>
<a name="ln43">      _file-&gt;read((char*)&amp;val, 2);</a>
<a name="ln44">      return val;</a>
<a name="ln45">      }</a>
<a name="ln46"> </a>
<a name="ln47">char PowerTab::readChar()</a>
<a name="ln48">      {</a>
<a name="ln49">      char byte;</a>
<a name="ln50">      _file-&gt;read(&amp;byte, 1);</a>
<a name="ln51">      return byte;</a>
<a name="ln52">      }</a>
<a name="ln53"> </a>
<a name="ln54"> </a>
<a name="ln55">int PowerTab::readInt()</a>
<a name="ln56">      {</a>
<a name="ln57">      int32_t val;</a>
<a name="ln58">      _file-&gt;read((char*)&amp;val, 4);</a>
<a name="ln59">      return val;</a>
<a name="ln60">      }</a>
<a name="ln61"> </a>
<a name="ln62">std::string PowerTab::readString(int length)</a>
<a name="ln63">      {</a>
<a name="ln64">      if (length == -1) {</a>
<a name="ln65">            length = readUChar();</a>
<a name="ln66">            if (length == 0xFF)</a>
<a name="ln67">                  length = readShort();</a>
<a name="ln68">            }</a>
<a name="ln69">      char* p = new char[length];</a>
<a name="ln70">      _file-&gt;read(p, length);</a>
<a name="ln71"> </a>
<a name="ln72">      std::string s(p, length);</a>
<a name="ln73">      delete[] p;</a>
<a name="ln74">      return s;</a>
<a name="ln75">      }</a>
<a name="ln76"> </a>
<a name="ln77">bool PowerTab::readVersion()</a>
<a name="ln78">      {</a>
<a name="ln79">      std::string version = readString(4);</a>
<a name="ln80">      version += std::string(&quot;-&quot;) + to_string(readShort());</a>
<a name="ln81">      return version == &quot;ptab-4&quot;;</a>
<a name="ln82">      }</a>
<a name="ln83"> </a>
<a name="ln84">void PowerTab::skip(int len /* = 1 */)</a>
<a name="ln85">      {</a>
<a name="ln86">      for (int i = 0; i &lt; len; ++i)</a>
<a name="ln87">            readChar();</a>
<a name="ln88">      }</a>
<a name="ln89"> </a>
<a name="ln90">void PowerTab::readSongInfo(ptSongInfo&amp; info)</a>
<a name="ln91">      {</a>
<a name="ln92">      auto classification = readChar();</a>
<a name="ln93">      info.classification = classification;</a>
<a name="ln94">      if (classification == 0) {</a>
<a name="ln95">            skip(1);</a>
<a name="ln96">            info.name = readString();</a>
<a name="ln97">            info.interpret = readString();</a>
<a name="ln98"> </a>
<a name="ln99">            auto releaseType = readChar();</a>
<a name="ln100"> </a>
<a name="ln101">            switch (releaseType) {</a>
<a name="ln102">                  case 0: {</a>
<a name="ln103">                        /*auto albumType =*/ readChar();</a>
<a name="ln104">                        info.album = readString();</a>
<a name="ln105">                        info.year = readShort();</a>
<a name="ln106">                        info.liverecording = readChar() != 0;</a>
<a name="ln107">                        break;</a>
<a name="ln108">                        }</a>
<a name="ln109">                  case 1: {</a>
<a name="ln110">                        info.album = readString();</a>
<a name="ln111">                        info.liverecording = readChar() != 0;</a>
<a name="ln112">                        break;</a>
<a name="ln113">                        }</a>
<a name="ln114">                  case 2: {</a>
<a name="ln115">                        info.album  = readString();</a>
<a name="ln116">                        info.day    = readShort();</a>
<a name="ln117">                        info.month  = readShort();</a>
<a name="ln118">                        info.year   = readShort();</a>
<a name="ln119">                        break;</a>
<a name="ln120">                        }</a>
<a name="ln121">                  default:</a>
<a name="ln122">                        assert(0);</a>
<a name="ln123">                  }</a>
<a name="ln124"> </a>
<a name="ln125">            if (readChar() == 0) {</a>
<a name="ln126">                  info.author = readString();</a>
<a name="ln127">                  info.lyricist = readString();</a>
<a name="ln128">                  }</a>
<a name="ln129"> </a>
<a name="ln130">            info.arrenger           = readString();</a>
<a name="ln131">            info.guitarTranscriber  = readString();</a>
<a name="ln132">            info.bassTranscriber    = readString();</a>
<a name="ln133">            info.copyright          = readString();</a>
<a name="ln134"> </a>
<a name="ln135">            info.lyrics             = readString();</a>
<a name="ln136"> </a>
<a name="ln137">            info.guitarInstructions = readString();</a>
<a name="ln138">            info.bassInstructions   = readString();</a>
<a name="ln139"> </a>
<a name="ln140">            }</a>
<a name="ln141">      else if (classification == 1) {</a>
<a name="ln142">            info.name         = readString();</a>
<a name="ln143">            info.album        = readString();</a>
<a name="ln144">            info.style        = readShort();</a>
<a name="ln145">            info.level        = readUChar();</a>
<a name="ln146">            info.author       = readString();</a>
<a name="ln147">            info.instructions = readString();</a>
<a name="ln148">            info.copyright    = readString();</a>
<a name="ln149">            }</a>
<a name="ln150">      }</a>
<a name="ln151"> </a>
<a name="ln152">int PowerTab::readHeaderItems()</a>
<a name="ln153">      {</a>
<a name="ln154">      int itemCount = readShort();</a>
<a name="ln155">      if (itemCount != 0) {</a>
<a name="ln156">            int header = readShort();</a>
<a name="ln157">            if (header == 0xFFFF) {</a>
<a name="ln158">                  if (readShort() != 1) {</a>
<a name="ln159">                        return -1;</a>
<a name="ln160">                        }</a>
<a name="ln161">                  auto str = readString(readShort()); //section title</a>
<a name="ln162">                  }</a>
<a name="ln163">            }</a>
<a name="ln164">      return itemCount;</a>
<a name="ln165">      }</a>
<a name="ln166"> </a>
<a name="ln167">void PowerTab::readTrackInfo(ptTrack&amp; info)</a>
<a name="ln168">      {</a>
<a name="ln169">      TrackInfo tr;</a>
<a name="ln170"> </a>
<a name="ln171">      tr.number = readUChar();</a>
<a name="ln172">      tr.name = readString();</a>
<a name="ln173">      tr.instrument = readUChar();</a>
<a name="ln174">      tr.volume = readUChar();</a>
<a name="ln175">      tr.balance = readUChar();</a>
<a name="ln176">      tr.reverb = readUChar();</a>
<a name="ln177">      tr.chorus = readUChar();</a>
<a name="ln178">      tr.tremolo = readUChar();</a>
<a name="ln179">      tr.phaser = readUChar();</a>
<a name="ln180">      tr.capo = readUChar();</a>
<a name="ln181">      tr.tuningName = readString();</a>
<a name="ln182">      tr.offset = readUChar();</a>
<a name="ln183"> </a>
<a name="ln184">      int ln = readUChar();</a>
<a name="ln185">      for (int i = 0; i &lt; ln; ++i)</a>
<a name="ln186">            tr.strings.push_back(readUChar());</a>
<a name="ln187">      info.infos.push_back(tr);</a>
<a name="ln188">      }</a>
<a name="ln189"> </a>
<a name="ln190">void PowerTab::readChord(ptTrack&amp; info)</a>
<a name="ln191">      {</a>
<a name="ln192">      ptChord ch;</a>
<a name="ln193">      ch.key = readShort(); //chord key</a>
<a name="ln194">      ch.formula = readUChar();</a>
<a name="ln195">      ch.modification = readShort(); //Chord Modification</a>
<a name="ln196">      ch.extra = readUChar();</a>
<a name="ln197">      ch.top_fret = readUChar();</a>
<a name="ln198">      auto stringCount = readUChar();</a>
<a name="ln199">      for (int i = 0; i &lt; stringCount; ++i) {</a>
<a name="ln200">            ch.frets.push_back(readUChar()); // fret</a>
<a name="ln201">            }</a>
<a name="ln202">      if (info.diagramMap.find({ {ch.key, ch.formula, ch.modification} }) == info.diagramMap.end())</a>
<a name="ln203">            info.diagramMap[ { {ch.key, ch.formula, ch.modification} }] = ch;</a>
<a name="ln204">      else {</a>
<a name="ln205">            auto a1 = info.diagramMap[ { {ch.key, ch.formula, ch.modification} }];</a>
<a name="ln206">            auto a2 = ch;</a>
<a name="ln207"> </a>
<a name="ln208">//??            int k = 1;</a>
<a name="ln209">            }</a>
<a name="ln210">      }</a>
<a name="ln211"> </a>
<a name="ln212">void PowerTab::readFontSettings()</a>
<a name="ln213">      {</a>
<a name="ln214">      readString(); //font name</a>
<a name="ln215">      readInt(); // point size</a>
<a name="ln216">      readInt(); // weight</a>
<a name="ln217">      readBoolean(); //italic</a>
<a name="ln218">      readBoolean(); //underline</a>
<a name="ln219">      readBoolean(); //strikeout</a>
<a name="ln220">      readInt(); //color</a>
<a name="ln221">      }</a>
<a name="ln222"> </a>
<a name="ln223">void PowerTab::readFloatingText()</a>
<a name="ln224">      {</a>
<a name="ln225">      readString(); //text</a>
<a name="ln226">      //rect :</a>
<a name="ln227">      readInt(); // left</a>
<a name="ln228">      readInt(); // top</a>
<a name="ln229">      readInt(); // right</a>
<a name="ln230">      readInt(); // bottom</a>
<a name="ln231"> </a>
<a name="ln232">      readUChar();</a>
<a name="ln233">      readFontSettings();</a>
<a name="ln234">      }</a>
<a name="ln235"> </a>
<a name="ln236">void PowerTab::readDynamic()</a>
<a name="ln237">      {</a>
<a name="ln238">      readShort();</a>
<a name="ln239">      readUChar();</a>
<a name="ln240">      readUChar();</a>
<a name="ln241">      readShort();</a>
<a name="ln242">      }</a>
<a name="ln243"> </a>
<a name="ln244">void PowerTab::readKeySignature()</a>
<a name="ln245">      {</a>
<a name="ln246">      readUChar();</a>
<a name="ln247">      }</a>
<a name="ln248"> </a>
<a name="ln249">void PowerTab::readRehearsalSign(ptSection&amp; sec)</a>
<a name="ln250">      {</a>
<a name="ln251">      auto c = readChar();</a>
<a name="ln252">      auto str = readString();</a>
<a name="ln253">      if (str.size()) {</a>
<a name="ln254">            sec.partName = str;</a>
<a name="ln255">            sec.partMarker = c;</a>
<a name="ln256">            }</a>
<a name="ln257">      }</a>
<a name="ln258"> </a>
<a name="ln259">void PowerTab::readChordText(ptSection&amp; sec)</a>
<a name="ln260">      {</a>
<a name="ln261">      ptChordText cht;</a>
<a name="ln262">      cht.position = readUChar();</a>
<a name="ln263">      cht.key = readShort();</a>
<a name="ln264">      cht.formula = readUChar();</a>
<a name="ln265">      cht.formula_mod = readShort();</a>
<a name="ln266">      cht.extra = readUChar();</a>
<a name="ln267">      //sec.chordTextMap.push_back(cht);</a>
<a name="ln268">      sec.chordTextMap.insert({ cht.position, cht });</a>
<a name="ln269">      }</a>
<a name="ln270"> </a>
<a name="ln271">void PowerTab::readRhytmSlash(ptSection&amp; sec)</a>
<a name="ln272">      {</a>
<a name="ln273">      stRhytmSlash rs;</a>
<a name="ln274">      rs.position = readUChar();</a>
<a name="ln275">      auto beaming = readUChar();</a>
<a name="ln276">      auto data = readInt();</a>
<a name="ln277">      auto duration = (data &amp; 0xE00000) &gt;&gt; 21;</a>
<a name="ln278">      switch (duration) {</a>
<a name="ln279">            case 0:</a>
<a name="ln280">                  rs.duration = 1;</a>
<a name="ln281">                  break;</a>
<a name="ln282">            case 1:</a>
<a name="ln283">                  rs.duration = 2;</a>
<a name="ln284">                  break;</a>
<a name="ln285">            case 2:</a>
<a name="ln286">                  rs.duration = 4;</a>
<a name="ln287">                  break;</a>
<a name="ln288">            case 3:</a>
<a name="ln289">                  rs.duration = 8;</a>
<a name="ln290">                  break;</a>
<a name="ln291">            case 4:</a>
<a name="ln292">                  rs.duration = 16;</a>
<a name="ln293">            }</a>
<a name="ln294"> </a>
<a name="ln295">      rs.triplet = beaming &amp; (0x20 | 0x40);</a>
<a name="ln296">      rs.tripletend = beaming &amp; 0x80;</a>
<a name="ln297"> </a>
<a name="ln298">      rs.dotted = data &amp; 0x01;</a>
<a name="ln299">      rs.doubleDotted = data &amp; 0x02;</a>
<a name="ln300"> </a>
<a name="ln301">      rs.is_rest = data &amp; 0x04;</a>
<a name="ln302"> </a>
<a name="ln303">      sec.rhytm.emplace_back(rs);</a>
<a name="ln304">      }</a>
<a name="ln305"> </a>
<a name="ln306">void PowerTab::readGuitarIn(ptTrack&amp; info)</a>
<a name="ln307">      {</a>
<a name="ln308">      ptGuitarIn gin;</a>
<a name="ln309">      gin.section = readShort();</a>
<a name="ln310">      gin.staff = readUChar() + staffInc;</a>
<a name="ln311">      gin.position = readUChar();</a>
<a name="ln312">      gin.rhytmSlash = readUChar();</a>
<a name="ln313">      gin.trackinfo = readUChar();</a>
<a name="ln314">      info.guitar_ins.push_back(gin);</a>
<a name="ln315">      //info.getSection(section).getPosition(position).addComponent(new ptGuitarIn(staff, inf));</a>
<a name="ln316">      }</a>
<a name="ln317"> </a>
<a name="ln318">void PowerTab::readTempoMarker(ptTrack&amp; info)</a>
<a name="ln319">      {</a>
<a name="ln320">      auto section = readShort();</a>
<a name="ln321">      /*auto position =*/ readUChar();</a>
<a name="ln322">      auto tempo = readShort();</a>
<a name="ln323">      /*auto data =*/ readShort();</a>
<a name="ln324">      readString(); //description</a>
<a name="ln325"> </a>
<a name="ln326">#if 0 // TODO-ws</a>
<a name="ln327">      int tripletFeel = 0;</a>
<a name="ln328">      if (data &amp; 0x01) {</a>
<a name="ln329">            tripletFeel = 8;</a>
<a name="ln330">            }</a>
<a name="ln331">      else if (data &amp; 0x02) {</a>
<a name="ln332">            tripletFeel = 16;</a>
<a name="ln333">            }</a>
<a name="ln334">#endif</a>
<a name="ln335">      if (tempo &gt; 0) {</a>
<a name="ln336">            info.getSection(section).tempo = tempo;//.getPosition(position).addComponent(new ptTempo(tempo));</a>
<a name="ln337">            }</a>
<a name="ln338">      }</a>
<a name="ln339"> </a>
<a name="ln340">void PowerTab::readSectionSymbol(ptTrack&amp; info)</a>
<a name="ln341">      {</a>
<a name="ln342">      int section = readShort();</a>
<a name="ln343">      int position = readUChar();</a>
<a name="ln344">      int data = readInt();</a>
<a name="ln345"> </a>
<a name="ln346">      int endNumber = data &gt;&gt; 16;</a>
<a name="ln347">      info.getSection(section).getPosition(position).addComponent(new ptSymbol(endNumber));</a>
<a name="ln348">      }</a>
<a name="ln349"> </a>
<a name="ln350">void PowerTab::readTimeSignature(ptBar* bar)</a>
<a name="ln351">      {</a>
<a name="ln352">      skip(3);</a>
<a name="ln353">      int data = readUChar();</a>
<a name="ln354">      readUChar(); // measure pulses</a>
<a name="ln355"> </a>
<a name="ln356">      bar-&gt;numerator = ((data - (data % 8)) / 8) + 1;</a>
<a name="ln357">      bar-&gt;denominator = pow(2, data % 8);</a>
<a name="ln358">      }</a>
<a name="ln359"> </a>
<a name="ln360">void PowerTab::readBarLine(ptSection&amp; sec)</a>
<a name="ln361">      {</a>
<a name="ln362">      auto bar = new ptBar();</a>
<a name="ln363">      /*int position =*/ readUChar();</a>
<a name="ln364">      auto b_type = readUChar();</a>
<a name="ln365"> </a>
<a name="ln366">      bar-&gt;repeatStart = (b_type &gt;&gt; 5) == 3;</a>
<a name="ln367">      bar-&gt;repeatClose = (b_type &gt;&gt; 5) == 4 ? b_type - 128 : 0;</a>
<a name="ln368"> </a>
<a name="ln369">      bar-&gt;measureNo = sec.number;</a>
<a name="ln370"> </a>
<a name="ln371">      readKeySignature();</a>
<a name="ln372">      readTimeSignature(bar);</a>
<a name="ln373">      readRehearsalSign(sec);</a>
<a name="ln374">      //sec.getPosition(position).addComponent(bar);</a>
<a name="ln375">      sec.bars.push_back(shared_ptr&lt;ptBar&gt;(bar));</a>
<a name="ln376">      /*if (bars.empty() || ( bars.back()-&gt;measureNo &lt; bar-&gt;measureNo ))</a>
<a name="ln377">            bars.push_back(bar);*/</a>
<a name="ln378">      }</a>
<a name="ln379"> </a>
<a name="ln380">void PowerTab::readStaff(int staff, ptSection&amp; sec)</a>
<a name="ln381">      {</a>
<a name="ln382">      skip(5);</a>
<a name="ln383">      for (int voice = 0; voice &lt; 2; ++voice) {</a>
<a name="ln384">            int itemCount = readHeaderItems();</a>
<a name="ln385">            for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln386">                  readPosition(staff, voice, sec);</a>
<a name="ln387">                  if (i &lt; itemCount - 1) {</a>
<a name="ln388">                        readShort();</a>
<a name="ln389">                        }</a>
<a name="ln390">                  }</a>
<a name="ln391">            }</a>
<a name="ln392">      }</a>
<a name="ln393"> </a>
<a name="ln394">void PowerTab::readNote(ptBeat* beat)</a>
<a name="ln395">      {</a>
<a name="ln396">      ptNote note;</a>
<a name="ln397">      auto position = readUChar();</a>
<a name="ln398">      auto simpleData = readShort();</a>
<a name="ln399">      auto symboCount = readUChar();</a>
<a name="ln400">      for (int i = 0; i &lt; symboCount; ++i) {</a>
<a name="ln401">            skip(2);</a>
<a name="ln402">            auto data3 = readUChar();</a>
<a name="ln403">            auto data4 = readUChar();</a>
<a name="ln404">            note.bend = data4 == 101 ? data3 / 16 + 1 : 0;</a>
<a name="ln405">            note.slide = data4 == 100 ? data3 + 1 : 0;</a>
<a name="ln406">            }</a>
<a name="ln407">      note.value = position &amp; 0x1F;</a>
<a name="ln408">      note.str = ((position &amp; 0xE0) &gt;&gt; 5);</a>
<a name="ln409">      note.tied = simpleData &amp; 0x01;</a>
<a name="ln410">      note.dead = simpleData &amp; 0x02;</a>
<a name="ln411">      note.hammer = simpleData &amp; 0x08;</a>
<a name="ln412">      beat-&gt;notes.emplace_back(note);</a>
<a name="ln413">      }</a>
<a name="ln414"> </a>
<a name="ln415">void PowerTab::readPosition(int staff, int voice, ptSection&amp; sec)</a>
<a name="ln416">      {</a>
<a name="ln417">      auto position = readUChar();</a>
<a name="ln418"> </a>
<a name="ln419">      ptBeat* beat{ nullptr };</a>
<a name="ln420">      bool add = false;</a>
<a name="ln421">      if (voice == 0 || sec.beats[staff].empty()) {</a>
<a name="ln422">            beat = new ptBeat(staff, voice);</a>
<a name="ln423">            beat-&gt;position = position;</a>
<a name="ln424">            add = true;</a>
<a name="ln425">            }</a>
<a name="ln426">      else {</a>
<a name="ln427">            auto pos = sec.beats[staff].begin();</a>
<a name="ln428">            auto end = sec.beats[staff].end();</a>
<a name="ln429">            while (pos != end &amp;&amp; pos-&gt;get()-&gt;position &lt; position) {</a>
<a name="ln430">                  ++pos;</a>
<a name="ln431">                  }</a>
<a name="ln432">            if (pos == end) {</a>
<a name="ln433">                  beat = new ptBeat(staff, voice);</a>
<a name="ln434">                  beat-&gt;position = position;</a>
<a name="ln435">                  add = true;</a>
<a name="ln436">                  }</a>
<a name="ln437">            else if (pos-&gt;get()-&gt;position == position) {</a>
<a name="ln438">                  beat = pos-&gt;get();</a>
<a name="ln439">                  }</a>
<a name="ln440">            else {</a>
<a name="ln441">                  beat = new ptBeat(staff, voice);</a>
<a name="ln442">                  beat-&gt;position = position;</a>
<a name="ln443">                  sec.beats[staff].insert(pos, shared_ptr&lt;ptBeat&gt;(beat));</a>
<a name="ln444">                  }</a>
<a name="ln445">            }</a>
<a name="ln446">      auto beaming = readUChar();</a>
<a name="ln447">      beaming = (((int)beaming - 128 &lt; 0) ? beaming : beaming - 128);</a>
<a name="ln448"> </a>
<a name="ln449">      readUChar();</a>
<a name="ln450"> </a>
<a name="ln451">      auto data1 = readUChar();</a>
<a name="ln452">      auto data2 = readUChar(); //32 - palm mute, 4 - accent, 2 - staccato</a>
<a name="ln453">      auto data3 = readUChar();</a>
<a name="ln454">      auto durationValue = readUChar();</a>
<a name="ln455"> </a>
<a name="ln456">      int multiBarRest = 1;</a>
<a name="ln457">      auto complexCount = readUChar();</a>
<a name="ln458">      for (int i = 0; i &lt; complexCount; ++i) {</a>
<a name="ln459">            auto count = readShort();</a>
<a name="ln460">            readUChar();</a>
<a name="ln461">            auto type = readUChar();</a>
<a name="ln462">            if (type &amp; 0x08) {</a>
<a name="ln463">                  multiBarRest = count;</a>
<a name="ln464">                  }</a>
<a name="ln465">            }</a>
<a name="ln466"> </a>
<a name="ln467">      auto itemCount = readHeaderItems();</a>
<a name="ln468">      for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln469">            readNote(beat);</a>
<a name="ln470">            if ( i &lt; itemCount - 1) {</a>
<a name="ln471">                  readShort();</a>
<a name="ln472">                  }</a>
<a name="ln473">            }</a>
<a name="ln474">      curTrack-&gt;infos[staff].notes_count += itemCount;</a>
<a name="ln475">      beat-&gt;mmrest = (itemCount == 0) ? multiBarRest : 1;</a>
<a name="ln476">      beat-&gt;vibrato = (( (data1 &amp; 0x08) != 0) || ( (data1 &amp; 0x10) != 0 ));</a>
<a name="ln477">      beat-&gt;grace = (data3 &amp; 0x01) != 0;</a>
<a name="ln478">      beat-&gt;tuplet = (data3 &amp; 0x20) != 0;</a>
<a name="ln479"> </a>
<a name="ln480">      if (beat-&gt;duration != 0) {</a>
<a name="ln481">            durationValue = std::max((int)durationValue, beat-&gt;duration);</a>
<a name="ln482">            }</a>
<a name="ln483"> </a>
<a name="ln484">      beat-&gt;duration = durationValue;//beat-&gt;duration == 0 ? durationValue : std::min(beat-&gt;duration, (int)durationValue);</a>
<a name="ln485">      beat-&gt;dotted = (data1 &amp; 0x01);</a>
<a name="ln486">      beat-&gt;doubleDotted = (data1 &amp; 0x02);</a>
<a name="ln487">      beat-&gt;arpegioUp = (data1 &amp; 0x20);</a>
<a name="ln488">      beat-&gt;arpegioDown = (data1 &amp; 0x40);</a>
<a name="ln489">      beat-&gt;enters = ((beaming - (beaming % 8)) / 8) + 1;</a>
<a name="ln490">      beat-&gt;times = (beaming % 8) + 1;</a>
<a name="ln491">      beat-&gt;isRest = (data1 &amp; 0x04);</a>
<a name="ln492">      beat-&gt;palmMute = data2 &amp; 0x20;</a>
<a name="ln493">      beat-&gt;accent = data2 &amp; 0x04;</a>
<a name="ln494">      beat-&gt;staccato = data2 &amp; 0x02;</a>
<a name="ln495"> </a>
<a name="ln496">      for (int i = int(sec.beats.size()); i &lt; staff + 1; ++i) {</a>
<a name="ln497">            sec.beats.push_back({});</a>
<a name="ln498">            }</a>
<a name="ln499">      if (add) {</a>
<a name="ln500">            sec.beats[staff].push_back(std::shared_ptr&lt;ptBeat&gt;(beat));</a>
<a name="ln501">            }</a>
<a name="ln502">      //sec.getPosition(position).addComponent(beat);</a>
<a name="ln503">      }</a>
<a name="ln504"> </a>
<a name="ln505">std::vector&lt;int&gt; PowerTab::getStaffMap(ptSection&amp; sec)</a>
<a name="ln506">      {</a>
<a name="ln507">      std::vector&lt;int&gt; result;</a>
<a name="ln508">      std::vector&lt;int&gt; slash;</a>
<a name="ln509">      if (!staffInc &amp;&amp; curTrack-&gt;guitar_ins.size()) {</a>
<a name="ln510">            auto first = curTrack-&gt;guitar_ins.front();</a>
<a name="ln511">            while (first.section == sec.number) {</a>
<a name="ln512">                  if (first.trackinfo) {</a>
<a name="ln513">                        for (unsigned int i = 0; i &lt; curTrack-&gt;infos.size(); ++i) {</a>
<a name="ln514">                              if ((1 &lt;&lt; i) &amp; first.trackinfo) {</a>
<a name="ln515">                                    result.push_back(i);</a>
<a name="ln516">                                    }</a>
<a name="ln517">                              }</a>
<a name="ln518">                        }</a>
<a name="ln519"> </a>
<a name="ln520">                  if (first.rhytmSlash) {</a>
<a name="ln521">                        for (unsigned int i = 0; i &lt; curTrack-&gt;infos.size(); ++i) {</a>
<a name="ln522">                              if ((i &lt;&lt; 1) &amp; first.rhytmSlash) {</a>
<a name="ln523">                                    slash.push_back(-1 - i);</a>
<a name="ln524">                                    }</a>
<a name="ln525">                              }</a>
<a name="ln526">                        }</a>
<a name="ln527"> </a>
<a name="ln528">                  curTrack-&gt;guitar_ins.pop_front();</a>
<a name="ln529">                  if (curTrack-&gt;guitar_ins.empty()) break;</a>
<a name="ln530">                  first = curTrack-&gt;guitar_ins.front();</a>
<a name="ln531">                  }</a>
<a name="ln532">            }</a>
<a name="ln533"> </a>
<a name="ln534">      if (result.empty() || int(result.size()) &lt; sec.staffs) {</a>
<a name="ln535">            result.clear();</a>
<a name="ln536">            if (int(lastStaffMap.size()) &lt; sec.staffs) {</a>
<a name="ln537">                  for (int i = 0; i &lt; sec.staffs; ++i) {</a>
<a name="ln538">                        result.push_back(i + staffInc);</a>
<a name="ln539">                        }</a>
<a name="ln540">                  }</a>
<a name="ln541">            else {</a>
<a name="ln542">                  result = lastStaffMap;</a>
<a name="ln543">                  }</a>
<a name="ln544">            }</a>
<a name="ln545"> </a>
<a name="ln546">      for (auto i : slash) {</a>
<a name="ln547">            result.push_back(i);</a>
<a name="ln548">            }</a>
<a name="ln549"> </a>
<a name="ln550">      lastStaffMap = result;</a>
<a name="ln551">      return result;</a>
<a name="ln552">      }</a>
<a name="ln553"> </a>
<a name="ln554">//---------------------------------------------------------</a>
<a name="ln555">//   addPalmMate</a>
<a name="ln556">//---------------------------------------------------------</a>
<a name="ln557"> </a>
<a name="ln558">void PowerTab::addPalmMute(Chord* chord)</a>
<a name="ln559">      {</a>
<a name="ln560">      int track = chord-&gt;track();</a>
<a name="ln561">	while (int(_palmMutes.size()) &lt; track + 1)</a>
<a name="ln562">		_palmMutes.push_back(0);</a>
<a name="ln563"> </a>
<a name="ln564">	if (_palmMutes[track]) {</a>
<a name="ln565">		PalmMute* pm = _palmMutes[track];</a>
<a name="ln566">		Chord* lastChord = toChord(pm-&gt;endCR());</a>
<a name="ln567">		if (lastChord == chord)</a>
<a name="ln568">			return;</a>
<a name="ln569">            //</a>
<a name="ln570">            // extend the current palm mute or start a new one</a>
<a name="ln571">            //</a>
<a name="ln572">            Fraction tick = chord-&gt;segment()-&gt;tick();</a>
<a name="ln573">		if (pm-&gt;tick2() &lt; tick)</a>
<a name="ln574">                  _palmMutes[track] = 0;</a>
<a name="ln575">            else {</a>
<a name="ln576">                  pm-&gt;setTick2(chord-&gt;tick() + chord-&gt;actualTicks());</a>
<a name="ln577">			pm-&gt;setEndElement(chord);</a>
<a name="ln578">		      }</a>
<a name="ln579"> </a>
<a name="ln580">	      }</a>
<a name="ln581">	if (!_palmMutes[track]) {</a>
<a name="ln582">		PalmMute* pm = new PalmMute(score);</a>
<a name="ln583">		_palmMutes[track] = pm;</a>
<a name="ln584">            Segment* segment = chord-&gt;segment();</a>
<a name="ln585">            Fraction tick = segment-&gt;tick();</a>
<a name="ln586"> </a>
<a name="ln587">		pm-&gt;setTick(tick);</a>
<a name="ln588">		pm-&gt;setTick2(tick + chord-&gt;actualTicks());</a>
<a name="ln589">		pm-&gt;setTrack(track);</a>
<a name="ln590">		pm-&gt;setTrack2(track);</a>
<a name="ln591">		pm-&gt;setStartElement(chord);</a>
<a name="ln592">		pm-&gt;setEndElement(chord);</a>
<a name="ln593">		score-&gt;addElement(pm);</a>
<a name="ln594">	      }</a>
<a name="ln595">      }</a>
<a name="ln596"> </a>
<a name="ln597">void PowerTab::fillMeasure(tBeatList&amp; elist, Measure* measure, int staff, std::vector&lt;Note*&gt;&amp; tiedNotes)</a>
<a name="ln598">      {</a>
<a name="ln599">      Tuplet* tuple = nullptr;</a>
<a name="ln600">      int tupleBeatCounter{ 0 };</a>
<a name="ln601">      Fraction tick = measure-&gt;tick();</a>
<a name="ln602">      Fraction endtick = measure-&gt;endTick();</a>
<a name="ln603">      Chord*      hammer{ nullptr };</a>
<a name="ln604"> </a>
<a name="ln605">      while (elist.size() &amp;&amp; tick &lt; endtick) {</a>
<a name="ln606">            auto beat = elist.front().get();</a>
<a name="ln607">            auto segment = measure-&gt;getSegment(SegmentType::ChordRest, tick);</a>
<a name="ln608">            Fraction l(1, beat-&gt;duration);</a>
<a name="ln609">            int dots = beat-&gt;dotted ? (beat-&gt;doubleDotted ? 2 : 1) : (beat-&gt;doubleDotted ? 2 : 0);</a>
<a name="ln610">            switch (dots) {</a>
<a name="ln611">                  case 1:</a>
<a name="ln612">                        l = l + (l * Fraction(1,2));</a>
<a name="ln613">                        break;</a>
<a name="ln614">                  case 2:</a>
<a name="ln615">                        l = l + (l * Fraction(3,4));</a>
<a name="ln616">                        break;</a>
<a name="ln617">                  }</a>
<a name="ln618"> </a>
<a name="ln619">            TDuration d(l);</a>
<a name="ln620">            d.setDots(dots);</a>
<a name="ln621"> </a>
<a name="ln622">            if (beat-&gt;tuplet || tupleBeatCounter) {</a>
<a name="ln623">                  Fraction nt = (l * Fraction(1,3) * Fraction(2,1));</a>
<a name="ln624">                  tick += nt;</a>
<a name="ln625">                  }</a>
<a name="ln626">            else {</a>
<a name="ln627">                  tick += l;</a>
<a name="ln628">                  }</a>
<a name="ln629">            ChordRest* cr;</a>
<a name="ln630">            if (beat-&gt;notes.empty()) {</a>
<a name="ln631">                  auto rest = new Rest(score);</a>
<a name="ln632">                  cr = rest;</a>
<a name="ln633">                  rest-&gt;setTrack(staff * VOICES);</a>
<a name="ln634">                  rest-&gt;setTicks(l);</a>
<a name="ln635">                  rest-&gt;setDurationType(d);</a>
<a name="ln636">                  segment-&gt;add(rest);</a>
<a name="ln637"> </a>
<a name="ln638">                  }</a>
<a name="ln639">            else {</a>
<a name="ln640">                  Chord* chord = new Chord(score);</a>
<a name="ln641">                  cr = chord;</a>
<a name="ln642">                  chord-&gt;setTrack(staff * VOICES);</a>
<a name="ln643">                  chord-&gt;setTicks(l);</a>
<a name="ln644">                  chord-&gt;setDurationType(d);</a>
<a name="ln645">                  segment-&gt;add(chord);</a>
<a name="ln646"> </a>
<a name="ln647">                  if (beat-&gt;palmMute)</a>
<a name="ln648">                        addPalmMute(chord);</a>
<a name="ln649">                  if (beat-&gt;accent) {</a>
<a name="ln650">                        auto accent = new Articulation(score);</a>
<a name="ln651">                        accent-&gt;setSymId(SymId::articAccentAbove);</a>
<a name="ln652">                        chord-&gt;add(accent);</a>
<a name="ln653">                        }</a>
<a name="ln654">                  if (beat-&gt;staccato) {</a>
<a name="ln655">                        auto st = new Articulation(score);</a>
<a name="ln656">                        st-&gt;setSymId(SymId::articStaccatoAbove);</a>
<a name="ln657">                        chord-&gt;add(st);</a>
<a name="ln658">                        }</a>
<a name="ln659">                  bool has_hammer = false;</a>
<a name="ln660">                  for (auto n : beat-&gt;notes) {</a>
<a name="ln661">                        auto note = new Note(score);</a>
<a name="ln662">                        chord-&gt;add(note);</a>
<a name="ln663">                        if (n.dead) {</a>
<a name="ln664">                              note-&gt;setHeadGroup(NoteHead::Group::HEAD_CROSS);</a>
<a name="ln665">                              note-&gt;setGhost(true);</a>
<a name="ln666">                              }</a>
<a name="ln667"> </a>
<a name="ln668">                        if (n.hammer) {</a>
<a name="ln669">                              has_hammer = true;</a>
<a name="ln670">                              }</a>
<a name="ln671"> </a>
<a name="ln672">                        if (n.tied &amp;&amp; tiedNotes[n.str]) {</a>
<a name="ln673">                              Tie* tie = new Tie(score);</a>
<a name="ln674">                              tie-&gt;setEndNote(note);</a>
<a name="ln675">                              tiedNotes[n.str]-&gt;add(tie);</a>
<a name="ln676">                              }</a>
<a name="ln677"> </a>
<a name="ln678">                        if (n.bend) {</a>
<a name="ln679">                              Bend* bend = new Bend(score);</a>
<a name="ln680">//TODO-ws                              bend-&gt;setNote(note);</a>
<a name="ln681">                              bend-&gt;points().append(PitchValue(0, n.bend * 25 - 12));</a>
<a name="ln682">                              bend-&gt;points().append(PitchValue(50, 0));</a>
<a name="ln683">                              note-&gt;add(bend);</a>
<a name="ln684">                              }</a>
<a name="ln685"> </a>
<a name="ln686">                        if (false &amp;&amp; n.slide) {</a>
<a name="ln687">                              Text* st = new Text(score, Tid::HARMONY_A);</a>
<a name="ln688">                              st-&gt;setXmlText(QString(&quot;SLIDE %1&quot;).arg(n.slide));</a>
<a name="ln689">                              st-&gt;setTrack(staff * VOICES);</a>
<a name="ln690">                              chord-&gt;notes().front()-&gt;add(st);</a>
<a name="ln691">                              }</a>
<a name="ln692"> </a>
<a name="ln693">                        tiedNotes[n.str] = note;</a>
<a name="ln694">                        note-&gt;setFret(n.value);</a>
<a name="ln695">                        note-&gt;setString(n.str);</a>
<a name="ln696">                        const StringData* sd = score-&gt;staff(staff)-&gt;part()-&gt;instrument()-&gt;stringData();</a>
<a name="ln697">                        int k     = int(curTrack-&gt;infos[staff].strings.size()) - n.str - 1;</a>
<a name="ln698">                        int pitch = sd-&gt;stringList().at(k).pitch + n.value; //getPitch(n.str, n.value, 0);</a>
<a name="ln699">                        note-&gt;setPitch(pitch);</a>
<a name="ln700">                        note-&gt;setTpcFromPitch();</a>
<a name="ln701">                        }</a>
<a name="ln702"> </a>
<a name="ln703">                  if (hammer) {</a>
<a name="ln704">                        auto cr1 = hammer;</a>
<a name="ln705">                        auto cr2 = chord;</a>
<a name="ln706">                        hammer = nullptr;</a>
<a name="ln707"> </a>
<a name="ln708">                        Slur* slur = new Slur(score);</a>
<a name="ln709">                        slur-&gt;setStartElement(cr1);</a>
<a name="ln710">                        slur-&gt;setEndElement(cr2);</a>
<a name="ln711">                        slur-&gt;setTick(cr1-&gt;tick());</a>
<a name="ln712">                        slur-&gt;setTick2(tick);</a>
<a name="ln713">                        slur-&gt;setTrack(staff * VOICES);</a>
<a name="ln714">                        slur-&gt;setTrack2(staff  * VOICES);</a>
<a name="ln715">                        score-&gt;addElement(slur);</a>
<a name="ln716"> </a>
<a name="ln717">                        Text* st = new Text(score, Tid::HARMONY_A);</a>
<a name="ln718">                        st-&gt;setXmlText(&quot;H&quot;);</a>
<a name="ln719">                        st-&gt;setTrack(staff * VOICES);</a>
<a name="ln720">                        cr1-&gt;notes().front()-&gt;add(st);</a>
<a name="ln721">                        }</a>
<a name="ln722">                  if (has_hammer) {</a>
<a name="ln723">                        hammer = chord;</a>
<a name="ln724">                        }</a>
<a name="ln725">                  }</a>
<a name="ln726"> </a>
<a name="ln727">            if (tupleBeatCounter) {</a>
<a name="ln728">                  tupleBeatCounter--;</a>
<a name="ln729">                  cr-&gt;setTuplet(tuple);</a>
<a name="ln730">                  tuple-&gt;add(cr);</a>
<a name="ln731">                  }</a>
<a name="ln732"> </a>
<a name="ln733">            if (beat-&gt;tuplet &amp;&amp; !tuple) {</a>
<a name="ln734">                  tuple = new Tuplet(score);</a>
<a name="ln735">                  tuple-&gt;setParent(measure);</a>
<a name="ln736">                  tuple-&gt;setTrack(cr-&gt;track());</a>
<a name="ln737">                  tuple-&gt;setBaseLen(l);</a>
<a name="ln738">                  tuple-&gt;setRatio(Fraction(3, 2));</a>
<a name="ln739">                  tuple-&gt;setTicks(l * tuple-&gt;ratio().denominator());</a>
<a name="ln740">                  cr-&gt;setTuplet(tuple);</a>
<a name="ln741">                  tuple-&gt;add(cr);</a>
<a name="ln742">                  tupleBeatCounter = 2;</a>
<a name="ln743">                  }</a>
<a name="ln744">            elist.pop_front();</a>
<a name="ln745">            }</a>
<a name="ln746"> </a>
<a name="ln747">      if (tick == measure-&gt;tick()) {</a>
<a name="ln748">            auto rest = new Rest(score);</a>
<a name="ln749">            rest-&gt;setTrack(staff * VOICES);</a>
<a name="ln750">            auto ts = measure-&gt;timesig();</a>
<a name="ln751">            rest-&gt;setTicks(ts);</a>
<a name="ln752">            rest-&gt;setDurationType(TDuration(ts));</a>
<a name="ln753">            measure-&gt;getSegment(SegmentType::ChordRest, tick)-&gt;add(rest);</a>
<a name="ln754">            }</a>
<a name="ln755"> </a>
<a name="ln756">      }</a>
<a name="ln757"> </a>
<a name="ln758">void PowerTab::addToScore(ptSection&amp; sec)</a>
<a name="ln759">      {</a>
<a name="ln760">      cur_section = &amp;sec;</a>
<a name="ln761">      Fraction tick = score-&gt;lastMeasure() ? score-&gt;lastMeasure()-&gt;endTick() : Fraction(0,1);</a>
<a name="ln762"> </a>
<a name="ln763">      Fraction lastTS(-1, -1);</a>
<a name="ln764">      bool firstMeasure = true;</a>
<a name="ln765">      if (score-&gt;lastMeasure()) {</a>
<a name="ln766">            lastTS = score-&gt;lastMeasure()-&gt;timesig();</a>
<a name="ln767">            firstMeasure = false;</a>
<a name="ln768">            }</a>
<a name="ln769">      if (firstMeasure) {</a>
<a name="ln770">            //int lastStaff = sec.staffMap.back() + 1;</a>
<a name="ln771">            for (int i = 0; i &lt; staves; ++i) {</a>
<a name="ln772">                  Part* part = new Part(score);</a>
<a name="ln773">                  Staff* s = new Staff(score);</a>
<a name="ln774">                  s-&gt;setPart(part);</a>
<a name="ln775">                  part-&gt;insertStaff(s, -1);</a>
<a name="ln776">                  auto info = &amp;curTrack-&gt;infos[i];</a>
<a name="ln777">                  std::string ss = info-&gt;name;</a>
<a name="ln778">                  part-&gt;setPartName(QString::fromUtf8(ss.data(), int(ss.size())));</a>
<a name="ln779">                  part-&gt;setPlainLongName(QString::fromUtf8(ss.data(), int(ss.size())));</a>
<a name="ln780"> </a>
<a name="ln781">                  std::vector&lt;int&gt; reverseStr;</a>
<a name="ln782">                  for (auto it = info-&gt;strings.rbegin(); it != info-&gt;strings.rend(); ++it)</a>
<a name="ln783">                        reverseStr.push_back(*it);</a>
<a name="ln784">                  StringData stringData(32, int(info-&gt;strings.size()), reverseStr.data());</a>
<a name="ln785">                  part-&gt;instrument()-&gt;setStringData(stringData);</a>
<a name="ln786"> </a>
<a name="ln787">                  part-&gt;setMidiProgram(info-&gt;instrument);</a>
<a name="ln788"> </a>
<a name="ln789">                  score-&gt;staves().push_back(s);</a>
<a name="ln790">                  score-&gt;appendPart(part);</a>
<a name="ln791">                  }</a>
<a name="ln792">            }</a>
<a name="ln793">      auto bar1 = sec.bars.front();</a>
<a name="ln794">      while (bar1-&gt;denominator == 0) {</a>
<a name="ln795">            if (sec.bars.size() == 1)</a>
<a name="ln796">                  break;</a>
<a name="ln797">            sec.bars.pop_front();</a>
<a name="ln798">            bar1 = sec.bars.front();</a>
<a name="ln799">            }</a>
<a name="ln800">      if (bar1-&gt;denominator == 0) {</a>
<a name="ln801">            bar1-&gt;denominator = 4;</a>
<a name="ln802">            bar1-&gt;numerator = 4;</a>
<a name="ln803">            }</a>
<a name="ln804">      auto measure = createMeasure(bar1.get(), tick);</a>
<a name="ln805">      if (repeatCount) {</a>
<a name="ln806">            measure-&gt;setRepeatEnd(true);</a>
<a name="ln807">            measure-&gt;setRepeatCount(repeatCount);</a>
<a name="ln808">            }</a>
<a name="ln809">      repeatCount = bar1-&gt;repeatClose;</a>
<a name="ln810">      if (bar1-&gt;repeatStart) {</a>
<a name="ln811">            measure-&gt;setRepeatStart(true);</a>
<a name="ln812">            }</a>
<a name="ln813">      if (sec.bars.size() &gt; 1) {</a>
<a name="ln814">            sec.bars.pop_front();</a>
<a name="ln815">            }</a>
<a name="ln816">      if (sec.tempo) {</a>
<a name="ln817">            TempoText* tt = new TempoText(score);</a>
<a name="ln818">            tt-&gt;setTempo(double(sec.tempo) / 60.0f);</a>
<a name="ln819">            tt-&gt;setXmlText(QString(&quot;&lt;sym&gt;metNoteQuarterUp&lt;/sym&gt; = %1&quot;).arg(sec.tempo));</a>
<a name="ln820">            tt-&gt;setTrack(0);</a>
<a name="ln821">            Segment* segment = measure-&gt;getSegment(SegmentType::ChordRest, measure-&gt;tick());</a>
<a name="ln822">            segment-&gt;add(tt);</a>
<a name="ln823">            score-&gt;setTempo(measure-&gt;tick(), tt-&gt;tempo());</a>
<a name="ln824">            }</a>
<a name="ln825">      if (!sec.partName.empty() &amp;&amp; lastPart != sec.partMarker) {</a>
<a name="ln826">            lastPart = sec.partMarker;</a>
<a name="ln827">            RehearsalMark* t = new RehearsalMark(score);</a>
<a name="ln828">            t-&gt;setFrameType(FrameType::SQUARE);</a>
<a name="ln829">            t-&gt;setPlainText(QString(sec.partMarker));</a>
<a name="ln830">            t-&gt;setTrack(0);</a>
<a name="ln831">            auto seg = measure-&gt;getSegment(SegmentType::ChordRest, measure-&gt;tick());</a>
<a name="ln832">            seg-&gt;add(t);</a>
<a name="ln833"> </a>
<a name="ln834">            t = new RehearsalMark(score);</a>
<a name="ln835">            t-&gt;setFrameType(FrameType::NO_FRAME);</a>
<a name="ln836">            t-&gt;setPlainText(QString::fromUtf8(sec.partName.data(), int(sec.partName.size())));</a>
<a name="ln837">            t-&gt;setOffset(QPointF(10.0, 0.0));</a>
<a name="ln838">            t-&gt;setTrack(0);</a>
<a name="ln839">            seg-&gt;add(t);</a>
<a name="ln840">            }</a>
<a name="ln841">      if (firstMeasure) {</a>
<a name="ln842">            for (int staffIdx = 0; staffIdx &lt; staves; ++staffIdx) {</a>
<a name="ln843">                  int keysig = staffIdx &gt;= staffInc ? 0 : 1; // Can be parsed int beat section</a>
<a name="ln844">                  KeySig* t = new KeySig(score);</a>
<a name="ln845">                  t-&gt;setKey(Key(keysig));</a>
<a name="ln846">                  t-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln847">                  Segment* s = measure-&gt;getSegment(SegmentType::KeySig, tick);</a>
<a name="ln848">                  s-&gt;add(t);</a>
<a name="ln849"> </a>
<a name="ln850">                  ClefType clefId = staffIdx &gt;= staffInc ? ClefType::F8_VB : ClefType::G15_MB;</a>
<a name="ln851">                  auto clef = new Clef(score);</a>
<a name="ln852">                  clef-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln853">                  clef-&gt;setClefType(clefId);</a>
<a name="ln854">                  s = measure-&gt;getSegment(SegmentType::HeaderClef, Fraction(0,1));</a>
<a name="ln855">                  s-&gt;add(clef);</a>
<a name="ln856">                  }</a>
<a name="ln857"> </a>
<a name="ln858">            }</a>
<a name="ln859"> </a>
<a name="ln860">      std::vector&lt;std::vector&lt;Note*&gt;&gt; tiedNotes(staves);</a>
<a name="ln861">      for (auto&amp; nvec : tiedNotes) {</a>
<a name="ln862">            nvec.resize(10);</a>
<a name="ln863">            memset(nvec.data(), 0, sizeof(Note*) * 10);</a>
<a name="ln864">            }</a>
<a name="ln865">      //std::vector&lt;tBeatList&gt;</a>
<a name="ln866">      while (true) {</a>
<a name="ln867">            bool empty = true;</a>
<a name="ln868">            while (int(sec.beats.size()) &lt; staves) {</a>
<a name="ln869">                  sec.beats.push_back({});</a>
<a name="ln870">                  }</a>
<a name="ln871">            for (unsigned int i = 0; i &lt; sec.beats.size(); ++i) {</a>
<a name="ln872">                  fillMeasure(sec.beats[i], measure, i, tiedNotes[i]);</a>
<a name="ln873">                  if (sec.beats[i].size() &amp;&amp; i &lt; unsigned(staffInc))</a>
<a name="ln874">                        empty = false;</a>
<a name="ln875">                  }</a>
<a name="ln876">            if (lastTS != measure-&gt;timesig()) {</a>
<a name="ln877">                  lastTS = measure-&gt;timesig();</a>
<a name="ln878">                  for (int staffIdx = 0; staffIdx &lt; staves; ++staffIdx) {</a>
<a name="ln879">                        Staff* staff = score-&gt;staff(staffIdx);</a>
<a name="ln880">                        auto staffType = staff-&gt;staffType(Fraction(0,1));</a>
<a name="ln881">                        if (staffType-&gt;genTimesig()) {</a>
<a name="ln882">                              auto t = new TimeSig(score);</a>
<a name="ln883">                              t-&gt;setTrack(staffIdx * VOICES);</a>
<a name="ln884">                              t-&gt;setSig(lastTS);</a>
<a name="ln885">                              Segment* s = measure-&gt;getSegment(SegmentType::TimeSig, measure-&gt;tick());</a>
<a name="ln886">                              s-&gt;add(t);</a>
<a name="ln887">                              }</a>
<a name="ln888">                        }</a>
<a name="ln889">                  }</a>
<a name="ln890">            if (empty) {</a>
<a name="ln891">                  break;</a>
<a name="ln892">                  }</a>
<a name="ln893">            auto bar = sec.bars.front();</a>
<a name="ln894">            while (bar-&gt;denominator == 0) {</a>
<a name="ln895">                  if (sec.bars.size() == 1)</a>
<a name="ln896">                        break;</a>
<a name="ln897">                  sec.bars.pop_front();</a>
<a name="ln898">                  bar = sec.bars.front();</a>
<a name="ln899">                  }</a>
<a name="ln900">            if (bar-&gt;denominator == 0) {</a>
<a name="ln901">                  bar-&gt;denominator = measure-&gt;timesig().denominator();</a>
<a name="ln902">                  bar-&gt;numerator = measure-&gt;timesig().numerator();</a>
<a name="ln903">                  }</a>
<a name="ln904">            measure = createMeasure(bar.get(), measure-&gt;endTick());</a>
<a name="ln905">            if (repeatCount) {</a>
<a name="ln906">                  measure-&gt;setRepeatEnd(true);</a>
<a name="ln907">                  measure-&gt;setRepeatCount(repeatCount);</a>
<a name="ln908">                  }</a>
<a name="ln909">            repeatCount = bar-&gt;repeatClose;</a>
<a name="ln910">            if (bar-&gt;repeatStart) {</a>
<a name="ln911">                  measure-&gt;setRepeatStart(true);</a>
<a name="ln912">                  }</a>
<a name="ln913">            if (sec.bars.size() &gt; 2) {</a>
<a name="ln914">                  sec.bars.pop_front();</a>
<a name="ln915">                  }</a>
<a name="ln916">            }</a>
<a name="ln917">      if (sec.bars.size()) {</a>
<a name="ln918">            auto bar = sec.bars.back();</a>
<a name="ln919">            if (bar-&gt;repeatStart) {</a>
<a name="ln920">                  measure-&gt;setRepeatStart(true);</a>
<a name="ln921">                  }</a>
<a name="ln922">            if (bar-&gt;repeatClose) {</a>
<a name="ln923">                  measure-&gt;setRepeatEnd(true);</a>
<a name="ln924">                  measure-&gt;setRepeatCount(bar-&gt;repeatClose);</a>
<a name="ln925">                  }</a>
<a name="ln926">            sec.bars.clear();</a>
<a name="ln927">            }</a>
<a name="ln928"> </a>
<a name="ln929">      }</a>
<a name="ln930"> </a>
<a name="ln931">void PowerTab::ptSection::copyTracks(ptTrack* track)</a>
<a name="ln932">      {</a>
<a name="ln933">      //if not found GuitarIn in section or all tracks are read -&gt; return</a>
<a name="ln934">      if (staffs == int(staffMap.size())) {</a>
<a name="ln935">            return;</a>
<a name="ln936">            }</a>
<a name="ln937"> </a>
<a name="ln938">      auto signature = chordTextMap.begin();</a>
<a name="ln939">      for (unsigned index = 0; index &lt; staffMap.size(); ++index) {</a>
<a name="ln940">            auto staff = (staffMap[index] + 1) * -1;</a>
<a name="ln941">            if (staff &lt; 0) {</a>
<a name="ln942">                  continue;</a>
<a name="ln943">                  }</a>
<a name="ln944"> </a>
<a name="ln945">            for (auto rt : rhytm) {</a>
<a name="ln946">                  auto newSig = chordTextMap.find(rt.position);</a>
<a name="ln947">                  if (newSig != chordTextMap.end()) {</a>
<a name="ln948">                        signature = newSig;</a>
<a name="ln949">                        }</a>
<a name="ln950"> </a>
<a name="ln951">                  ptBeat* beat = new ptBeat(staff, 0);</a>
<a name="ln952">                  beat-&gt;position = rt.position;</a>
<a name="ln953">                  beat-&gt;duration = rt.duration;</a>
<a name="ln954">                  beat-&gt;dotted = rt.dotted;</a>
<a name="ln955">                  beat-&gt;doubleDotted = rt.doubleDotted;</a>
<a name="ln956">                  beat-&gt;isRest = rt.is_rest;</a>
<a name="ln957">                  beat-&gt;tuplet = rt.triplet;</a>
<a name="ln958">                  if (!rt.is_rest) {</a>
<a name="ln959">                        auto diagram = track-&gt;diagramMap.find({ {signature-&gt;second.key, signature-&gt;second.formula, signature-&gt;second.formula_mod} });</a>
<a name="ln960">                        for (unsigned int string = 0; string &lt; diagram-&gt;second.frets.size(); ++string) {</a>
<a name="ln961">                              int fret = diagram-&gt;second.frets[string];</a>
<a name="ln962">                              if (fret &gt;= 0xFE) {</a>
<a name="ln963">                                    continue;</a>
<a name="ln964">                                    }</a>
<a name="ln965">                              ptNote note;</a>
<a name="ln966">                              note.value = fret;</a>
<a name="ln967">                              note.str = string;</a>
<a name="ln968">                              if (fret == 0xFE) {</a>
<a name="ln969">                                    note.dead = true;</a>
<a name="ln970">                                    note.value = 0;</a>
<a name="ln971">                                    }</a>
<a name="ln972">                              beat-&gt;notes.emplace_back(note);</a>
<a name="ln973">                              }</a>
<a name="ln974">                        }</a>
<a name="ln975">                  while (int(beats.size()) &lt;= staff) {</a>
<a name="ln976">                        beats.push_back({});</a>
<a name="ln977">                        }</a>
<a name="ln978">                  beats[staff].push_back(shared_ptr&lt;ptBeat&gt;(beat));</a>
<a name="ln979">                  }</a>
<a name="ln980">            }</a>
<a name="ln981">      }</a>
<a name="ln982"> </a>
<a name="ln983">void PowerTab::readSection(ptSection&amp; sec)</a>
<a name="ln984">      {</a>
<a name="ln985">      //rect:</a>
<a name="ln986">      readInt(); // left</a>
<a name="ln987">      readInt(); // top</a>
<a name="ln988">      readInt(); // right</a>
<a name="ln989">      readInt(); // bottom</a>
<a name="ln990"> </a>
<a name="ln991">      auto lastBarData = readUChar();</a>
<a name="ln992"> </a>
<a name="ln993">      skip(4); //spacing from staff</a>
<a name="ln994"> </a>
<a name="ln995">      readBarLine(sec);</a>
<a name="ln996"> </a>
<a name="ln997">      int itemCount = readHeaderItems();</a>
<a name="ln998">      for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln999">            readDirection(sec);</a>
<a name="ln1000">            if (i &lt; itemCount - 1) {</a>
<a name="ln1001">                  readShort();</a>
<a name="ln1002">                  }</a>
<a name="ln1003">            }</a>
<a name="ln1004">      //ChordText section</a>
<a name="ln1005">      itemCount = readHeaderItems();</a>
<a name="ln1006">      for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln1007">            readChordText(sec);</a>
<a name="ln1008">            if (i &lt; itemCount - 1) {</a>
<a name="ln1009">                  readShort();</a>
<a name="ln1010">                  }</a>
<a name="ln1011">            }</a>
<a name="ln1012">      //RhytmSlash</a>
<a name="ln1013">      itemCount = readHeaderItems();</a>
<a name="ln1014">      for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln1015">            readRhytmSlash(sec);</a>
<a name="ln1016">            if (i &lt; itemCount - 1)</a>
<a name="ln1017">                  readShort();</a>
<a name="ln1018">            }</a>
<a name="ln1019">      // Staff</a>
<a name="ln1020">      sec.staffs = readHeaderItems();</a>
<a name="ln1021">      sec.staffMap = getStaffMap(sec);</a>
<a name="ln1022">      for (int i = 0; i &lt; sec.staffs; ++i) {</a>
<a name="ln1023">            int staff = sec.staffMap[i];</a>
<a name="ln1024">            readStaff(staff, sec);</a>
<a name="ln1025">            if (i &lt; sec.staffs - 1) {</a>
<a name="ln1026">                  readShort();</a>
<a name="ln1027">                  }</a>
<a name="ln1028">            }</a>
<a name="ln1029">      sec.copyTracks(curTrack);</a>
<a name="ln1030">      // MusicBar section</a>
<a name="ln1031">      itemCount = readHeaderItems();</a>
<a name="ln1032">      for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln1033">            readBarLine(sec);</a>
<a name="ln1034">            if (i &lt; itemCount - 1) {</a>
<a name="ln1035">                  readShort();</a>
<a name="ln1036">                  }</a>
<a name="ln1037">            }</a>
<a name="ln1038"> </a>
<a name="ln1039">      auto bar = new ptBar();</a>
<a name="ln1040">      bar-&gt;repeatClose = (lastBarData &gt;&gt; 5 == 4) ? lastBarData - 128 : 0;</a>
<a name="ln1041">      sec.bars.push_back(shared_ptr&lt;ptBar&gt;(bar));</a>
<a name="ln1042">      //sec.getPosition(sec.getNextPositionNumber()).addComponent(bar);</a>
<a name="ln1043">      }</a>
<a name="ln1044"> </a>
<a name="ln1045">void PowerTab::readDirection(ptSection&amp; sec)</a>
<a name="ln1046">      {</a>
<a name="ln1047">      int position = readUChar();</a>
<a name="ln1048">      int symbolCount = readUChar();</a>
<a name="ln1049">      for (int i = 0; i &lt; symbolCount; ++i) {</a>
<a name="ln1050">            unsigned int data = readShort();</a>
<a name="ln1051">            sec.getPosition(position).addComponent(new ptDirection((data &gt;&gt; 8), ((data &amp; 0xC0) &gt;&gt; 6), (data &amp; 0x1F)));</a>
<a name="ln1052">            }</a>
<a name="ln1053">      }</a>
<a name="ln1054"> </a>
<a name="ln1055">void PowerTab::readDataInstruments(ptTrack&amp; info)</a>
<a name="ln1056">      {</a>
<a name="ln1057">      curTrack = &amp;info;</a>
<a name="ln1058">      //Guitar section</a>
<a name="ln1059">      auto itemCount = readHeaderItems();</a>
<a name="ln1060">      for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln1061">            readTrackInfo(info);</a>
<a name="ln1062">            if (i &lt; itemCount - 1) {</a>
<a name="ln1063">                  readShort();</a>
<a name="ln1064">                  }</a>
<a name="ln1065">            }</a>
<a name="ln1066">      // Chord Diagram Section</a>
<a name="ln1067">      itemCount = readHeaderItems();</a>
<a name="ln1068">      for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln1069">            readChord(info);</a>
<a name="ln1070">            if (i &lt; itemCount - 1) {</a>
<a name="ln1071">                  readShort();</a>
<a name="ln1072">                  }</a>
<a name="ln1073">            }</a>
<a name="ln1074">      //Floating Text section</a>
<a name="ln1075">      itemCount = readHeaderItems();</a>
<a name="ln1076">      for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln1077">            readFloatingText();</a>
<a name="ln1078">            if (i &lt; itemCount - 1) {</a>
<a name="ln1079">                  readShort();</a>
<a name="ln1080">                  }</a>
<a name="ln1081">            }</a>
<a name="ln1082">      // GuitarIn section</a>
<a name="ln1083">      itemCount = readHeaderItems();</a>
<a name="ln1084">      for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln1085">            readGuitarIn(info);</a>
<a name="ln1086">            if (i &lt; itemCount - 1) {</a>
<a name="ln1087">                  readShort();</a>
<a name="ln1088">                  }</a>
<a name="ln1089">            }</a>
<a name="ln1090">      // Tempo marker</a>
<a name="ln1091">      itemCount = readHeaderItems();</a>
<a name="ln1092">      for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln1093">            readTempoMarker(info);</a>
<a name="ln1094">            if (i &lt; itemCount - 1) {</a>
<a name="ln1095">                  readShort();</a>
<a name="ln1096">                  }</a>
<a name="ln1097">            }</a>
<a name="ln1098">      //Dynamic section</a>
<a name="ln1099">      itemCount = readHeaderItems();</a>
<a name="ln1100">      for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln1101">            readDynamic();</a>
<a name="ln1102">            if (i &lt; itemCount - 1) {</a>
<a name="ln1103">                  readShort();</a>
<a name="ln1104">                  }</a>
<a name="ln1105">            }</a>
<a name="ln1106">      //Symbol section</a>
<a name="ln1107">      itemCount = readHeaderItems();</a>
<a name="ln1108">      for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln1109">            readSectionSymbol(info);</a>
<a name="ln1110">            if (i &lt; itemCount - 1) {</a>
<a name="ln1111">                  readShort();</a>
<a name="ln1112">                  }</a>
<a name="ln1113">            }</a>
<a name="ln1114">      //Section section</a>
<a name="ln1115">      itemCount = readHeaderItems();</a>
<a name="ln1116">      for (int i = 0; i &lt; itemCount; ++i) {</a>
<a name="ln1117">            readSection(info.getSection(i));</a>
<a name="ln1118">            if (i &lt; itemCount - 1) {</a>
<a name="ln1119">                  readShort();</a>
<a name="ln1120">                  }</a>
<a name="ln1121">            }</a>
<a name="ln1122">      }</a>
<a name="ln1123"> </a>
<a name="ln1124">std::string crTS(int strings, int tuning[])</a>
<a name="ln1125">      {</a>
<a name="ln1126">      const static char* tune[] = { &quot;C&quot;, &quot;C#&quot;, &quot;D&quot;, &quot;D#&quot;, &quot;E&quot;, &quot;F&quot;, &quot;F#&quot;, &quot;G&quot;, &quot;G#&quot;, &quot;A&quot;, &quot;A#&quot;, &quot;B&quot; };</a>
<a name="ln1127">      std::vector&lt;int&gt; pitch;</a>
<a name="ln1128">      for (int i = 0; i &lt; strings; ++i) {</a>
<a name="ln1129">            pitch.push_back(tuning[i]);</a>
<a name="ln1130">            }</a>
<a name="ln1131">      std::string t;</a>
<a name="ln1132">      for (auto i : pitch) {</a>
<a name="ln1133">            t += tune[i % 12];</a>
<a name="ln1134">            t += &quot; &quot;;</a>
<a name="ln1135">            }</a>
<a name="ln1136">      return t;</a>
<a name="ln1137">      }</a>
<a name="ln1138"> </a>
<a name="ln1139"> </a>
<a name="ln1140">Measure* PowerTab::createMeasure(ptBar* bar, const Fraction&amp; tick)</a>
<a name="ln1141">      {</a>
<a name="ln1142">      auto measure = new Measure(score);</a>
<a name="ln1143">      Fraction nts(bar-&gt;numerator, bar-&gt;denominator);</a>
<a name="ln1144"> </a>
<a name="ln1145">      measure-&gt;setTick(tick);</a>
<a name="ln1146">      measure-&gt;setTimesig(nts);</a>
<a name="ln1147">      measure-&gt;setTicks(nts);</a>
<a name="ln1148"> </a>
<a name="ln1149">      score-&gt;measures()-&gt;add(measure);</a>
<a name="ln1150"> </a>
<a name="ln1151">      return measure;</a>
<a name="ln1152">      }</a>
<a name="ln1153"> </a>
<a name="ln1154">PowerTab::ptSection&amp; PowerTab::ptTrack::getSection(int ind)</a>
<a name="ln1155">      {</a>
<a name="ln1156">      for (int i = (int)sections.size(); i &lt; ind + 1; ++i) {</a>
<a name="ln1157">            sections.push_back(ptSection(i));</a>
<a name="ln1158">            }</a>
<a name="ln1159">      return sections[ind];</a>
<a name="ln1160">      }</a>
<a name="ln1161"> </a>
<a name="ln1162">PowerTab::ptSection::ptSection(int num)</a>
<a name="ln1163">      {</a>
<a name="ln1164">      number = num;</a>
<a name="ln1165">      }</a>
<a name="ln1166"> </a>
<a name="ln1167">PowerTab::ptPosition&amp; PowerTab::ptSection::getPosition(int pos)</a>
<a name="ln1168">      {</a>
<a name="ln1169">      unsigned int i = 0;</a>
<a name="ln1170">      while ( i &lt; positions.size() ) {</a>
<a name="ln1171">            auto&amp; p = positions[i];</a>
<a name="ln1172">            if (p.position == pos) {</a>
<a name="ln1173">                  return p;</a>
<a name="ln1174">                  }</a>
<a name="ln1175">            ++i;</a>
<a name="ln1176">            }</a>
<a name="ln1177">      ptPosition p;</a>
<a name="ln1178">      p.position = pos;</a>
<a name="ln1179">      positions.emplace_back(p);</a>
<a name="ln1180">      return positions.back();</a>
<a name="ln1181">      }</a>
<a name="ln1182"> </a>
<a name="ln1183">int PowerTab::ptSection::getNextPositionNumber()</a>
<a name="ln1184">      {</a>
<a name="ln1185">      int next = 0;</a>
<a name="ln1186">      unsigned int k = 0;</a>
<a name="ln1187">      while (k &lt; positions.size()) {</a>
<a name="ln1188">            auto p = positions[k];</a>
<a name="ln1189">            next = std::max(next, p.position + 1);</a>
<a name="ln1190">            ++k;</a>
<a name="ln1191">            }</a>
<a name="ln1192">      return next;</a>
<a name="ln1193">      }</a>
<a name="ln1194"> </a>
<a name="ln1195">void PowerTab::ptPosition::addComponent(ptComponent* c)</a>
<a name="ln1196">      {</a>
<a name="ln1197">      components.push_back(shared_ptr&lt;ptComponent&gt;(c));</a>
<a name="ln1198">      }</a>
<a name="ln1199"> </a>
<a name="ln1200"> </a>
<a name="ln1201">//---------------------------------------------------------</a>
<a name="ln1202">//   read</a>
<a name="ln1203">//---------------------------------------------------------</a>
<a name="ln1204"> </a>
<a name="ln1205">Score::FileError PowerTab::read()</a>
<a name="ln1206">      {</a>
<a name="ln1207">      if (!readVersion())</a>
<a name="ln1208">            return Score::FileError::FILE_BAD_FORMAT;</a>
<a name="ln1209">      ptSong song;</a>
<a name="ln1210"> </a>
<a name="ln1211">      readSongInfo(song.info);</a>
<a name="ln1212">      readDataInstruments(song.track1);</a>
<a name="ln1213">      staffInc = int(song.track1.infos.size());</a>
<a name="ln1214">      lastStaffMap.clear();</a>
<a name="ln1215">      readDataInstruments(song.track1);</a>
<a name="ln1216"> </a>
<a name="ln1217">      staves = int(song.track1.infos.size());</a>
<a name="ln1218"> </a>
<a name="ln1219">      std::vector&lt;tBeatList&gt; parts(staves);</a>
<a name="ln1220">      for (int i = staffInc; i &lt; staves; ++i) {</a>
<a name="ln1221">            for (auto&amp; sec : song.track1.sections) {</a>
<a name="ln1222">                  while (int(sec.beats.size()) &lt; staves)</a>
<a name="ln1223">                        sec.beats.push_back({});</a>
<a name="ln1224">                  parts[i].insert(parts[i].end(), sec.beats[i].begin(), sec.beats[i].end());</a>
<a name="ln1225">                  sec.beats[i].clear();</a>
<a name="ln1226">                  }</a>
<a name="ln1227">            }</a>
<a name="ln1228"> </a>
<a name="ln1229">      for (auto&amp; sec : song.track1.sections) {</a>
<a name="ln1230">            for (int i = 0; i &lt; staves; ++i) {</a>
<a name="ln1231">                  if (parts[i].size()) {</a>
<a name="ln1232">                        sec.beats[i].insert(sec.beats[i].begin(), parts[i].begin(), parts[i].end());</a>
<a name="ln1233">                        parts[i].clear();</a>
<a name="ln1234">                        }</a>
<a name="ln1235">                  }</a>
<a name="ln1236">            addToScore(sec);</a>
<a name="ln1237">            for (int i = 0; i &lt; staves; ++i)</a>
<a name="ln1238">                  parts[i] = sec.beats[i];</a>
<a name="ln1239">            }</a>
<a name="ln1240"> </a>
<a name="ln1241">      score-&gt;style().set(Sid::ArpeggioHiddenInStdIfTab, true);</a>
<a name="ln1242"> </a>
<a name="ln1243">      MeasureBase* m;</a>
<a name="ln1244">      if (!score-&gt;measures()-&gt;first()) {</a>
<a name="ln1245">            m = new VBox(score);</a>
<a name="ln1246">            m-&gt;setTick(Fraction(0,1));</a>
<a name="ln1247">            score-&gt;addMeasure(m, 0);</a>
<a name="ln1248">            }</a>
<a name="ln1249">      else  {</a>
<a name="ln1250">            m = score-&gt;measures()-&gt;first();</a>
<a name="ln1251">            if (!m-&gt;isVBox()) {</a>
<a name="ln1252">                  MeasureBase* mb = new VBox(score);</a>
<a name="ln1253">                  mb-&gt;setTick(Fraction(0,1));</a>
<a name="ln1254">                  score-&gt;addMeasure(mb, m);</a>
<a name="ln1255">                  m = mb;</a>
<a name="ln1256">                  }</a>
<a name="ln1257">            }</a>
<a name="ln1258">      // create title</a>
<a name="ln1259">      std::string name = song.info.name;</a>
<a name="ln1260">      if (!name.empty()) {</a>
<a name="ln1261">            Text* s = new Text(score, Tid::TITLE);</a>
<a name="ln1262">            s-&gt;setPlainText(QString::fromUtf8(name.data(), int(name.size())));</a>
<a name="ln1263">            m-&gt;add(s);</a>
<a name="ln1264">            }</a>
<a name="ln1265"> </a>
<a name="ln1266">//      static const char* tune[] = { &quot;C&quot;, &quot;C#&quot;, &quot;D&quot;, &quot;D#&quot;, &quot;E&quot;, &quot;F&quot;, &quot;F#&quot;, &quot;G&quot;, &quot;G#&quot;, &quot;A&quot;, &quot;A#&quot;, &quot;B&quot; };</a>
<a name="ln1267">      int id = 0;</a>
<a name="ln1268">      for (Part* part : score-&gt;parts()) {</a>
<a name="ln1269">            QMultiMap&lt;int, int&gt; tracks;</a>
<a name="ln1270">            Score* pscore = new Score(score);</a>
<a name="ln1271"> </a>
<a name="ln1272">//TODO-ws            pscore-&gt;tuning.clear();</a>
<a name="ln1273">            auto&amp; info = song.track1.infos[id++];</a>
<a name="ln1274">            for (auto it = info.strings.rbegin(); it != info.strings.rend(); ++it) {</a>
<a name="ln1275">//TODO-ws                  pscore-&gt;tuning += tune[*it % 12];</a>
<a name="ln1276">//                  pscore-&gt;tuning += &quot; &quot;;</a>
<a name="ln1277">                  }</a>
<a name="ln1278"> </a>
<a name="ln1279"> </a>
<a name="ln1280">//TODO-ws          pscore-&gt;showLyrics = score-&gt;showLyrics;</a>
<a name="ln1281">            pscore-&gt;style().set(Sid::createMultiMeasureRests, false);</a>
<a name="ln1282">            pscore-&gt;style().set(Sid::ArpeggioHiddenInStdIfTab, true);</a>
<a name="ln1283"> </a>
<a name="ln1284">            QList&lt;int&gt; stavesMap;</a>
<a name="ln1285">            Part* p = new Part(pscore);</a>
<a name="ln1286">            p-&gt;setInstrument(*part-&gt;instrument());</a>
<a name="ln1287"> </a>
<a name="ln1288">            Staff* staff = part-&gt;staves()-&gt;front();</a>
<a name="ln1289"> </a>
<a name="ln1290">            Staff* s = new Staff(pscore);</a>
<a name="ln1291">            s-&gt;setPart(p);</a>
<a name="ln1292">            const StaffType* st = staff-&gt;staffType(Fraction(0,1));</a>
<a name="ln1293">            s-&gt;setStaffType(Fraction(0,1), *st);</a>
<a name="ln1294"> </a>
<a name="ln1295">            s-&gt;linkTo(staff);</a>
<a name="ln1296">            p-&gt;staves()-&gt;append(s);</a>
<a name="ln1297">            pscore-&gt;staves().append(s);</a>
<a name="ln1298">            stavesMap.append(staff-&gt;idx());</a>
<a name="ln1299">            for (int i = staff-&gt;idx() * VOICES, j = 0; i &lt; staff-&gt;idx() * VOICES + VOICES; i++, j++)</a>
<a name="ln1300">                  tracks.insert(i, j);</a>
<a name="ln1301"> </a>
<a name="ln1302">            Excerpt* excerpt = new Excerpt(score);</a>
<a name="ln1303">            excerpt-&gt;setTracks(tracks);</a>
<a name="ln1304">            excerpt-&gt;setPartScore(pscore);</a>
<a name="ln1305">            //title?</a>
<a name="ln1306">            excerpt-&gt;setTitle(part-&gt;instrument()-&gt;longNames()[0].name());</a>
<a name="ln1307">            pscore-&gt;setExcerpt(excerpt);</a>
<a name="ln1308">            excerpt-&gt;parts().append(part);</a>
<a name="ln1309">            score-&gt;excerpts().append(excerpt);</a>
<a name="ln1310"> </a>
<a name="ln1311">            Excerpt::cloneStaves(score, pscore, stavesMap, tracks);</a>
<a name="ln1312"> </a>
<a name="ln1313">            if (staff-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;strings() &gt; 0</a>
<a name="ln1314">               &amp;&amp; part-&gt;staves()-&gt;front()-&gt;staffType(Fraction(0,1))-&gt;group() == StaffGroup::STANDARD) {</a>
<a name="ln1315">                  p-&gt;setStaves(2);</a>
<a name="ln1316">                  Staff* s1 = p-&gt;staff(1);</a>
<a name="ln1317"> </a>
<a name="ln1318">                  int lines = staff-&gt;part()-&gt;instrument()-&gt;stringData()-&gt;strings();</a>
<a name="ln1319">                  StaffTypes sts = StaffTypes::TAB_DEFAULT;</a>
<a name="ln1320">                  if (lines == 4)</a>
<a name="ln1321">                        sts = StaffTypes::TAB_4COMMON;</a>
<a name="ln1322">                  StaffType st1 = *StaffType::preset(sts);</a>
<a name="ln1323">                  s1-&gt;setStaffType(Fraction(0,1), st1);</a>
<a name="ln1324">                  s1-&gt;setLines(Fraction(0,1), lines);</a>
<a name="ln1325">                  Excerpt::cloneStaff(s, s1);</a>
<a name="ln1326">                  BracketItem* bi = new BracketItem(pscore, BracketType::NORMAL, 2);</a>
<a name="ln1327">                  p-&gt;staves()-&gt;front()-&gt;addBracket(bi);</a>
<a name="ln1328">                  }</a>
<a name="ln1329">            pscore-&gt;appendPart(p);</a>
<a name="ln1330"> </a>
<a name="ln1331">            //</a>
<a name="ln1332">            // create excerpt title</a>
<a name="ln1333">            //</a>
<a name="ln1334">            MeasureBase* measure = pscore-&gt;first();</a>
<a name="ln1335">            if (!measure || (measure-&gt;type() != ElementType::VBOX)) {</a>
<a name="ln1336">                  MeasureBase* mb = new VBox(pscore);</a>
<a name="ln1337">                  mb-&gt;setTick(Fraction(0,1));</a>
<a name="ln1338">                  pscore-&gt;addMeasure(mb, measure);</a>
<a name="ln1339">                  measure = mb;</a>
<a name="ln1340">                  }</a>
<a name="ln1341">            Text* txt = new Text(pscore, Tid::INSTRUMENT_EXCERPT);</a>
<a name="ln1342">            txt-&gt;setPlainText(part-&gt;longName());</a>
<a name="ln1343">            measure-&gt;add(txt);</a>
<a name="ln1344"> </a>
<a name="ln1345">            pscore-&gt;setPlaylistDirty();</a>
<a name="ln1346">            pscore-&gt;setLayoutAll();</a>
<a name="ln1347">            pscore-&gt;addLayoutFlags(LayoutFlag::FIX_PITCH_VELO);</a>
<a name="ln1348">            pscore-&gt;doLayout();</a>
<a name="ln1349">            }</a>
<a name="ln1350">      return Score::FileError::FILE_NO_ERROR;</a>
<a name="ln1351">      }</a>
<a name="ln1352"> </a>
<a name="ln1353">}</a>

</code></pre>
<div class="balloon" rel="730"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'tuple' pointer was utilized before it was verified against nullptr. Check lines: 730, 733.</p></div>
<div class="balloon" rel="968"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'fret == 0xFE' is always false.</p></div>
<div class="balloon" rel="1162"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: partMarker.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
