
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>textbase.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2011-2014 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;text.h&quot;</a>
<a name="ln14">#include &quot;textedit.h&quot;</a>
<a name="ln15">#include &quot;jump.h&quot;</a>
<a name="ln16">#include &quot;marker.h&quot;</a>
<a name="ln17">#include &quot;score.h&quot;</a>
<a name="ln18">#include &quot;segment.h&quot;</a>
<a name="ln19">#include &quot;measure.h&quot;</a>
<a name="ln20">#include &quot;system.h&quot;</a>
<a name="ln21">#include &quot;box.h&quot;</a>
<a name="ln22">#include &quot;page.h&quot;</a>
<a name="ln23">#include &quot;textframe.h&quot;</a>
<a name="ln24">#include &quot;sym.h&quot;</a>
<a name="ln25">#include &quot;xml.h&quot;</a>
<a name="ln26">#include &quot;undo.h&quot;</a>
<a name="ln27">#include &quot;mscore.h&quot;</a>
<a name="ln28"> </a>
<a name="ln29">namespace Ms {</a>
<a name="ln30"> </a>
<a name="ln31">#ifdef Q_OS_MAC</a>
<a name="ln32">#define CONTROL_MODIFIER Qt::AltModifier</a>
<a name="ln33">#else</a>
<a name="ln34">#define CONTROL_MODIFIER Qt::ControlModifier</a>
<a name="ln35">#endif</a>
<a name="ln36"> </a>
<a name="ln37">static const qreal subScriptSize     = 0.6;</a>
<a name="ln38">static const qreal subScriptOffset   = 0.5;       // of x-height</a>
<a name="ln39">static const qreal superScriptOffset = -.9;      // of x-height</a>
<a name="ln40"> </a>
<a name="ln41">//static const qreal tempotextOffset = 0.4; // of x-height // 80% of 50% = 2 spatiums</a>
<a name="ln42"> </a>
<a name="ln43">//---------------------------------------------------------</a>
<a name="ln44">//   operator==</a>
<a name="ln45">//---------------------------------------------------------</a>
<a name="ln46"> </a>
<a name="ln47">bool CharFormat::operator==(const CharFormat&amp; cf) const</a>
<a name="ln48">      {</a>
<a name="ln49">      return cf.style()     == style()</a>
<a name="ln50">         &amp;&amp; cf.preedit()    == preedit()</a>
<a name="ln51">         &amp;&amp; cf.valign()     == valign()</a>
<a name="ln52">         &amp;&amp; cf.fontSize()   == fontSize()</a>
<a name="ln53">         &amp;&amp; cf.fontFamily() == fontFamily();</a>
<a name="ln54">      }</a>
<a name="ln55"> </a>
<a name="ln56">//---------------------------------------------------------</a>
<a name="ln57">//   clearSelection</a>
<a name="ln58">//---------------------------------------------------------</a>
<a name="ln59"> </a>
<a name="ln60">void TextCursor::clearSelection()</a>
<a name="ln61">      {</a>
<a name="ln62">      _selectLine   = _row;</a>
<a name="ln63">      _selectColumn = _column;</a>
<a name="ln64">      }</a>
<a name="ln65"> </a>
<a name="ln66">//---------------------------------------------------------</a>
<a name="ln67">//   init</a>
<a name="ln68">//---------------------------------------------------------</a>
<a name="ln69"> </a>
<a name="ln70">void TextCursor::init()</a>
<a name="ln71">      {</a>
<a name="ln72">      _format.setFontFamily(_text-&gt;family());</a>
<a name="ln73">      _format.setFontSize(_text-&gt;size());</a>
<a name="ln74">      _format.setStyle(_text-&gt;fontStyle());</a>
<a name="ln75">      _format.setPreedit(false);</a>
<a name="ln76">      _format.setValign(VerticalAlignment::AlignNormal);</a>
<a name="ln77">      }</a>
<a name="ln78"> </a>
<a name="ln79">//---------------------------------------------------------</a>
<a name="ln80">//   columns</a>
<a name="ln81">//---------------------------------------------------------</a>
<a name="ln82"> </a>
<a name="ln83">int TextCursor::columns() const</a>
<a name="ln84">      {</a>
<a name="ln85">      return _text-&gt;textBlock(_row).columns();</a>
<a name="ln86">      }</a>
<a name="ln87"> </a>
<a name="ln88">//---------------------------------------------------------</a>
<a name="ln89">//   currentCharacter</a>
<a name="ln90">//---------------------------------------------------------</a>
<a name="ln91"> </a>
<a name="ln92">QChar TextCursor::currentCharacter() const</a>
<a name="ln93">      {</a>
<a name="ln94">      const TextBlock&amp; t = _text-&gt;_layout[row()];</a>
<a name="ln95">      QString s = t.text(column(), 1);</a>
<a name="ln96">      if (s.isEmpty())</a>
<a name="ln97">            return QChar();</a>
<a name="ln98">      return s[0];</a>
<a name="ln99">      }</a>
<a name="ln100"> </a>
<a name="ln101">//---------------------------------------------------------</a>
<a name="ln102">//   updateCursorFormat</a>
<a name="ln103">//---------------------------------------------------------</a>
<a name="ln104"> </a>
<a name="ln105">void TextCursor::updateCursorFormat()</a>
<a name="ln106">      {</a>
<a name="ln107">      TextBlock* block = &amp;_text-&gt;_layout[_row];</a>
<a name="ln108">      int col = hasSelection() ? selectColumn() : column();</a>
<a name="ln109">      const CharFormat* format = block-&gt;formatAt(col);</a>
<a name="ln110">      if (!format || format-&gt;fontFamily() == &quot;ScoreText&quot;)</a>
<a name="ln111">            init();</a>
<a name="ln112">      else</a>
<a name="ln113">            setFormat(*format);</a>
<a name="ln114">      }</a>
<a name="ln115"> </a>
<a name="ln116">//---------------------------------------------------------</a>
<a name="ln117">//   cursorRect</a>
<a name="ln118">//---------------------------------------------------------</a>
<a name="ln119"> </a>
<a name="ln120">QRectF TextCursor::cursorRect() const</a>
<a name="ln121">      {</a>
<a name="ln122">      const TextBlock&amp; tline       = curLine();</a>
<a name="ln123">      const TextFragment* fragment = tline.fragment(column());</a>
<a name="ln124"> </a>
<a name="ln125">      QFont _font  = fragment ? fragment-&gt;font(_text) : _text-&gt;font();</a>
<a name="ln126">      qreal ascent = QFontMetricsF(_font, MScore::paintDevice()).ascent();</a>
<a name="ln127">      qreal h = ascent;</a>
<a name="ln128">      qreal x = tline.xpos(column(), _text);</a>
<a name="ln129">      qreal y = tline.y() - ascent * .9;</a>
<a name="ln130">      return QRectF(x, y, 4.0, h);</a>
<a name="ln131">      }</a>
<a name="ln132"> </a>
<a name="ln133">//---------------------------------------------------------</a>
<a name="ln134">//   curLine</a>
<a name="ln135">//    return the current text line in edit mode</a>
<a name="ln136">//---------------------------------------------------------</a>
<a name="ln137"> </a>
<a name="ln138">TextBlock&amp; TextCursor::curLine() const</a>
<a name="ln139">      {</a>
<a name="ln140">      Q_ASSERT(!_text-&gt;_layout.empty());</a>
<a name="ln141">      return _text-&gt;_layout[_row];</a>
<a name="ln142">      }</a>
<a name="ln143"> </a>
<a name="ln144">//---------------------------------------------------------</a>
<a name="ln145">//   changeSelectionFormat</a>
<a name="ln146">//---------------------------------------------------------</a>
<a name="ln147"> </a>
<a name="ln148">void TextCursor::changeSelectionFormat(FormatId id, QVariant val)</a>
<a name="ln149">      {</a>
<a name="ln150">      if (!hasSelection())</a>
<a name="ln151">            return;</a>
<a name="ln152">      int r1 = selectLine();</a>
<a name="ln153">      int r2 = row();</a>
<a name="ln154">      int c1 = selectColumn();</a>
<a name="ln155">      int c2 = column();</a>
<a name="ln156"> </a>
<a name="ln157">      if (r1 &gt; r2) {</a>
<a name="ln158">            qSwap(r1, r2);</a>
<a name="ln159">            qSwap(c1, c2);</a>
<a name="ln160">            }</a>
<a name="ln161">      else if (r1 == r2) {</a>
<a name="ln162">            if (c1 &gt; c2)</a>
<a name="ln163">                  qSwap(c1, c2);</a>
<a name="ln164">            }</a>
<a name="ln165">      int rows = _text-&gt;rows();</a>
<a name="ln166">      for (int row = 0; row &lt; rows; ++row) {</a>
<a name="ln167">            TextBlock&amp; t = _text-&gt;_layout[row];</a>
<a name="ln168">            if (row &lt; r1)</a>
<a name="ln169">                  continue;</a>
<a name="ln170">            if (row &gt; r2)</a>
<a name="ln171">                  break;</a>
<a name="ln172">            if (row == r1 &amp;&amp; r1 == r2)</a>
<a name="ln173">                  t.changeFormat(id, val, c1, c2 - c1);</a>
<a name="ln174">            else if (row == r1)</a>
<a name="ln175">                  t.changeFormat(id, val, c1, t.columns() - c1);</a>
<a name="ln176">            else if (row == r2)</a>
<a name="ln177">                  t.changeFormat(id, val, 0, c2);</a>
<a name="ln178">            else</a>
<a name="ln179">                  t.changeFormat(id, val, 0, t.columns());</a>
<a name="ln180">            }</a>
<a name="ln181">      _text-&gt;layout1();</a>
<a name="ln182">      }</a>
<a name="ln183"> </a>
<a name="ln184">//---------------------------------------------------------</a>
<a name="ln185">//   setFormat</a>
<a name="ln186">//---------------------------------------------------------</a>
<a name="ln187"> </a>
<a name="ln188">void TextCursor::setFormat(FormatId id, QVariant val)</a>
<a name="ln189">      {</a>
<a name="ln190">      changeSelectionFormat(id, val);</a>
<a name="ln191">      format()-&gt;setFormat(id, val);</a>
<a name="ln192">      text()-&gt;setTextInvalid();</a>
<a name="ln193">      }</a>
<a name="ln194"> </a>
<a name="ln195">//---------------------------------------------------------</a>
<a name="ln196">//   movePosition</a>
<a name="ln197">//---------------------------------------------------------</a>
<a name="ln198"> </a>
<a name="ln199">bool TextCursor::movePosition(QTextCursor::MoveOperation op, QTextCursor::MoveMode mode, int count)</a>
<a name="ln200">      {</a>
<a name="ln201">      for (int i = 0; i &lt; count; i++) {</a>
<a name="ln202">            switch (op) {</a>
<a name="ln203">                  case QTextCursor::Left:</a>
<a name="ln204">                        if (hasSelection() &amp;&amp; mode == QTextCursor::MoveAnchor) {</a>
<a name="ln205">                              int r1 = _selectLine;</a>
<a name="ln206">                              int r2 = _row;</a>
<a name="ln207">                              int c1 = _selectColumn;</a>
<a name="ln208">                              int c2 = _column;</a>
<a name="ln209"> </a>
<a name="ln210">                              if (r1 &gt; r2) {</a>
<a name="ln211">                                    qSwap(r1, r2);</a>
<a name="ln212">                                    qSwap(c1, c2);</a>
<a name="ln213">                                    }</a>
<a name="ln214">                              else if (r1 == r2) {</a>
<a name="ln215">                                    if (c1 &gt; c2)</a>
<a name="ln216">                                           qSwap(c1, c2);</a>
<a name="ln217">                                    }</a>
<a name="ln218">                              clearSelection();</a>
<a name="ln219">                              _row    = r1;</a>
<a name="ln220">                              _column = c1;</a>
<a name="ln221">                              }</a>
<a name="ln222">                        else if (_column == 0) {</a>
<a name="ln223">                              if (_row == 0)</a>
<a name="ln224">                                    return false;</a>
<a name="ln225">                              --_row;</a>
<a name="ln226">                              _column = curLine().columns();</a>
<a name="ln227">                              }</a>
<a name="ln228">                        else</a>
<a name="ln229">                              --_column;</a>
<a name="ln230">                        break;</a>
<a name="ln231"> </a>
<a name="ln232">                  case QTextCursor::Right:</a>
<a name="ln233">                        if (hasSelection() &amp;&amp; mode == QTextCursor::MoveAnchor) {</a>
<a name="ln234">                              int r1 = _selectLine;</a>
<a name="ln235">                              int r2 = _row;</a>
<a name="ln236">                              int c1 = _selectColumn;</a>
<a name="ln237">                              int c2 = _column;</a>
<a name="ln238"> </a>
<a name="ln239">                              if (r1 &gt; r2) {</a>
<a name="ln240">                                    qSwap(r1, r2);</a>
<a name="ln241">                                    qSwap(c1, c2);</a>
<a name="ln242">                                    }</a>
<a name="ln243">                              else if (r1 == r2) {</a>
<a name="ln244">                                    if (c1 &gt; c2)</a>
<a name="ln245">                                           qSwap(c1, c2);</a>
<a name="ln246">                                    }</a>
<a name="ln247">                              clearSelection();</a>
<a name="ln248">                              _row    = r2;</a>
<a name="ln249">                              _column = c2;</a>
<a name="ln250">                              }</a>
<a name="ln251">                        else if (column() &gt;= curLine().columns()) {</a>
<a name="ln252">                              if (_row &gt;= _text-&gt;rows() - 1)</a>
<a name="ln253">                                    return false;</a>
<a name="ln254">                              ++_row;</a>
<a name="ln255">                              _column = 0;</a>
<a name="ln256">                              }</a>
<a name="ln257">                        else</a>
<a name="ln258">                              ++_column;</a>
<a name="ln259">                        break;</a>
<a name="ln260"> </a>
<a name="ln261">                  case QTextCursor::Up:</a>
<a name="ln262">                        if (_row == 0)</a>
<a name="ln263">                              return false;</a>
<a name="ln264">                        --_row;</a>
<a name="ln265">                        if (_column &gt; curLine().columns())</a>
<a name="ln266">                              _column = curLine().columns();</a>
<a name="ln267">                        break;</a>
<a name="ln268"> </a>
<a name="ln269">                  case QTextCursor::Down:</a>
<a name="ln270">                        if (_row &gt;= _text-&gt;rows() - 1)</a>
<a name="ln271">                              return false;</a>
<a name="ln272">                        ++_row;</a>
<a name="ln273">                        if (_column &gt; curLine().columns())</a>
<a name="ln274">                              _column = curLine().columns();</a>
<a name="ln275">                        break;</a>
<a name="ln276"> </a>
<a name="ln277">                  case QTextCursor::Start:</a>
<a name="ln278">                        _row    = 0;</a>
<a name="ln279">                        _column = 0;</a>
<a name="ln280">                        break;</a>
<a name="ln281"> </a>
<a name="ln282">                  case QTextCursor::End:</a>
<a name="ln283">                        _row    = _text-&gt;rows() - 1;</a>
<a name="ln284">                        _column = curLine().columns();</a>
<a name="ln285">                        break;</a>
<a name="ln286"> </a>
<a name="ln287">                  case QTextCursor::StartOfLine:</a>
<a name="ln288">                        _column = 0;</a>
<a name="ln289">                        break;</a>
<a name="ln290"> </a>
<a name="ln291">                  case QTextCursor::EndOfLine:</a>
<a name="ln292">                        _column = curLine().columns();</a>
<a name="ln293">                        break;</a>
<a name="ln294"> </a>
<a name="ln295">                  case QTextCursor::WordLeft:</a>
<a name="ln296">                        if (_column &gt; 0) {</a>
<a name="ln297">                              --_column;</a>
<a name="ln298">                              while (_column &gt; 0 &amp;&amp; currentCharacter().isSpace())</a>
<a name="ln299">                                    --_column;</a>
<a name="ln300">                              while (_column &gt; 0 &amp;&amp; !currentCharacter().isSpace())</a>
<a name="ln301">                                    --_column;</a>
<a name="ln302">                              if (currentCharacter().isSpace())</a>
<a name="ln303">                                    ++_column;</a>
<a name="ln304">                              }</a>
<a name="ln305">                        break;</a>
<a name="ln306"> </a>
<a name="ln307">                  case QTextCursor::NextWord: {</a>
<a name="ln308">                        int cols =  columns();</a>
<a name="ln309">                        if (_column &lt; cols) {</a>
<a name="ln310">                              ++_column;</a>
<a name="ln311">                              while (_column &lt; cols &amp;&amp; !currentCharacter().isSpace())</a>
<a name="ln312">                                    ++_column;</a>
<a name="ln313">                              while (_column &lt; cols &amp;&amp; currentCharacter().isSpace())</a>
<a name="ln314">                                    ++_column;</a>
<a name="ln315">                              }</a>
<a name="ln316">                        }</a>
<a name="ln317">                        break;</a>
<a name="ln318"> </a>
<a name="ln319">                  default:</a>
<a name="ln320">                        qDebug(&quot;Text::movePosition: not implemented&quot;);</a>
<a name="ln321">                        return false;</a>
<a name="ln322">                  }</a>
<a name="ln323">            if (mode == QTextCursor::MoveAnchor)</a>
<a name="ln324">                  clearSelection();</a>
<a name="ln325">            }</a>
<a name="ln326">      updateCursorFormat();</a>
<a name="ln327">      _text-&gt;score()-&gt;addRefresh(_text-&gt;canvasBoundingRect());</a>
<a name="ln328">      return true;</a>
<a name="ln329">      }</a>
<a name="ln330"> </a>
<a name="ln331"> </a>
<a name="ln332"> </a>
<a name="ln333">//---------------------------------------------------------</a>
<a name="ln334">//   doubleClickSelect</a>
<a name="ln335">//---------------------------------------------------------</a>
<a name="ln336"> </a>
<a name="ln337">void TextCursor::doubleClickSelect()</a>
<a name="ln338">      {</a>
<a name="ln339">      clearSelection();</a>
<a name="ln340"> </a>
<a name="ln341">      // if clicked on a space, select surrounding spaces</a>
<a name="ln342">      // otherwise select surround non-spaces</a>
<a name="ln343">      const bool selectSpaces = currentCharacter().isSpace();</a>
<a name="ln344"> </a>
<a name="ln345">      //handle double-clicking inside a word</a>
<a name="ln346">      int startPosition = _column;</a>
<a name="ln347"> </a>
<a name="ln348">      while (_column &gt; 0 &amp;&amp; currentCharacter().isSpace() == selectSpaces)</a>
<a name="ln349">            --_column;</a>
<a name="ln350"> </a>
<a name="ln351">      if (currentCharacter().isSpace() != selectSpaces)</a>
<a name="ln352">            ++_column;</a>
<a name="ln353"> </a>
<a name="ln354">      _selectColumn = _column;</a>
<a name="ln355"> </a>
<a name="ln356">      _column = startPosition;</a>
<a name="ln357">      while (_column  &lt; curLine().columns() &amp;&amp; currentCharacter().isSpace() == selectSpaces)</a>
<a name="ln358">            ++_column;</a>
<a name="ln359"> </a>
<a name="ln360">      updateCursorFormat();</a>
<a name="ln361">      _text-&gt;score()-&gt;addRefresh(_text-&gt;canvasBoundingRect());</a>
<a name="ln362">      }</a>
<a name="ln363"> </a>
<a name="ln364">//---------------------------------------------------------</a>
<a name="ln365">//   set</a>
<a name="ln366">//---------------------------------------------------------</a>
<a name="ln367"> </a>
<a name="ln368">bool TextCursor::set(const QPointF&amp; p, QTextCursor::MoveMode mode)</a>
<a name="ln369">      {</a>
<a name="ln370">      QPointF pt  = p - _text-&gt;canvasPos();</a>
<a name="ln371">      if (!_text-&gt;bbox().contains(pt))</a>
<a name="ln372">            return false;</a>
<a name="ln373">      int oldRow    = _row;</a>
<a name="ln374">      int oldColumn = _column;</a>
<a name="ln375"> </a>
<a name="ln376">//      if (_text-&gt;_layout.empty())</a>
<a name="ln377">//            _text-&gt;_layout.append(TextBlock());</a>
<a name="ln378">      _row = 0;</a>
<a name="ln379">      for (int row = 0; row &lt; _text-&gt;rows(); ++row) {</a>
<a name="ln380">            const TextBlock&amp; l = _text-&gt;_layout.at(row);</a>
<a name="ln381">            if (l.y() &gt; pt.y()) {</a>
<a name="ln382">                  _row = row;</a>
<a name="ln383">                  break;</a>
<a name="ln384">                  }</a>
<a name="ln385">            }</a>
<a name="ln386">      _column = curLine().column(pt.x(), _text);</a>
<a name="ln387"> </a>
<a name="ln388">      if (oldRow != _row || oldColumn != _column) {</a>
<a name="ln389">            _text-&gt;score()-&gt;setUpdateAll();</a>
<a name="ln390">            if (mode == QTextCursor::MoveAnchor)</a>
<a name="ln391">                  clearSelection();</a>
<a name="ln392">            if (hasSelection())</a>
<a name="ln393">                  QApplication::clipboard()-&gt;setText(selectedText(), QClipboard::Selection);</a>
<a name="ln394">            }</a>
<a name="ln395">      updateCursorFormat();</a>
<a name="ln396">      return true;</a>
<a name="ln397">      }</a>
<a name="ln398"> </a>
<a name="ln399">//---------------------------------------------------------</a>
<a name="ln400">//   selectedText</a>
<a name="ln401">//    return current selection</a>
<a name="ln402">//---------------------------------------------------------</a>
<a name="ln403"> </a>
<a name="ln404">QString TextCursor::selectedText() const</a>
<a name="ln405">      {</a>
<a name="ln406">      QString s;</a>
<a name="ln407">      int r1 = selectLine();</a>
<a name="ln408">      int r2 = _row;</a>
<a name="ln409">      int c1 = selectColumn();</a>
<a name="ln410">      int c2 = column();</a>
<a name="ln411"> </a>
<a name="ln412">      if (r1 &gt; r2) {</a>
<a name="ln413">            qSwap(r1, r2);</a>
<a name="ln414">            qSwap(c1, c2);</a>
<a name="ln415">            }</a>
<a name="ln416">      else if (r1 == r2) {</a>
<a name="ln417">            if (c1 &gt; c2)</a>
<a name="ln418">                  qSwap(c1, c2);</a>
<a name="ln419">            }</a>
<a name="ln420">      int rows = _text-&gt;rows();</a>
<a name="ln421">      for (int row = 0; row &lt; rows; ++row) {</a>
<a name="ln422">            const TextBlock&amp; t = _text-&gt;_layout.at(row);</a>
<a name="ln423">            if (row &gt;= r1 &amp;&amp; row &lt;= r2) {</a>
<a name="ln424">                  if (row == r1 &amp;&amp; r1 == r2)</a>
<a name="ln425">                        s += t.text(c1, c2 - c1);</a>
<a name="ln426">                  else if (row == r1) {</a>
<a name="ln427">                        s += t.text(c1, -1);</a>
<a name="ln428">                        s += &quot;\n&quot;;</a>
<a name="ln429">                        }</a>
<a name="ln430">                  else if (row == r2)</a>
<a name="ln431">                        s += t.text(0, c2);</a>
<a name="ln432">                  else {</a>
<a name="ln433">                        s += t.text(0, -1);</a>
<a name="ln434">                        s += &quot;\n&quot;;</a>
<a name="ln435">                        }</a>
<a name="ln436">                  }</a>
<a name="ln437">            }</a>
<a name="ln438">      return s;</a>
<a name="ln439">      }</a>
<a name="ln440"> </a>
<a name="ln441">//---------------------------------------------------------</a>
<a name="ln442">//   TextFragment</a>
<a name="ln443">//---------------------------------------------------------</a>
<a name="ln444"> </a>
<a name="ln445">TextFragment::TextFragment()</a>
<a name="ln446">      {</a>
<a name="ln447">      }</a>
<a name="ln448"> </a>
<a name="ln449">TextFragment::TextFragment(const QString&amp; s)</a>
<a name="ln450">      {</a>
<a name="ln451">      text = s;</a>
<a name="ln452">      }</a>
<a name="ln453"> </a>
<a name="ln454">TextFragment::TextFragment(TextCursor* cursor, const QString&amp; s)</a>
<a name="ln455">      {</a>
<a name="ln456">      format = *cursor-&gt;format();</a>
<a name="ln457">      text = s;</a>
<a name="ln458">      }</a>
<a name="ln459"> </a>
<a name="ln460">//---------------------------------------------------------</a>
<a name="ln461">//   split</a>
<a name="ln462">//---------------------------------------------------------</a>
<a name="ln463"> </a>
<a name="ln464">TextFragment TextFragment::split(int column)</a>
<a name="ln465">      {</a>
<a name="ln466">      int idx = 0;</a>
<a name="ln467">      int col = 0;</a>
<a name="ln468">      TextFragment f;</a>
<a name="ln469">      f.format = format;</a>
<a name="ln470"> </a>
<a name="ln471">      for (const QChar&amp; c : text) {</a>
<a name="ln472">            if (col == column) {</a>
<a name="ln473">                  if (idx) {</a>
<a name="ln474">                        if (idx &lt; text.size()) {</a>
<a name="ln475">                              f.text = text.mid(idx);</a>
<a name="ln476">                              text   = text.left(idx);</a>
<a name="ln477">                              }</a>
<a name="ln478">                        }</a>
<a name="ln479">                  return f;</a>
<a name="ln480">                  }</a>
<a name="ln481">            ++idx;</a>
<a name="ln482">            if (c.isHighSurrogate())</a>
<a name="ln483">                  continue;</a>
<a name="ln484">            ++col;</a>
<a name="ln485">            }</a>
<a name="ln486">      return f;</a>
<a name="ln487">      }</a>
<a name="ln488"> </a>
<a name="ln489"> </a>
<a name="ln490">//---------------------------------------------------------</a>
<a name="ln491">//   columns</a>
<a name="ln492">//---------------------------------------------------------</a>
<a name="ln493"> </a>
<a name="ln494">int TextFragment::columns() const</a>
<a name="ln495">      {</a>
<a name="ln496">      int col = 0;</a>
<a name="ln497">      for (const QChar&amp; c : text) {</a>
<a name="ln498">            if (c.isHighSurrogate())</a>
<a name="ln499">                  continue;</a>
<a name="ln500">            ++col;</a>
<a name="ln501">            }</a>
<a name="ln502">      return col;</a>
<a name="ln503">      }</a>
<a name="ln504"> </a>
<a name="ln505">//---------------------------------------------------------</a>
<a name="ln506">//   operator ==</a>
<a name="ln507">//---------------------------------------------------------</a>
<a name="ln508"> </a>
<a name="ln509">bool TextFragment::operator ==(const TextFragment&amp; f) const</a>
<a name="ln510">      {</a>
<a name="ln511">      return format == f.format &amp;&amp; text == f.text;</a>
<a name="ln512">      }</a>
<a name="ln513"> </a>
<a name="ln514">//---------------------------------------------------------</a>
<a name="ln515">//   draw</a>
<a name="ln516">//---------------------------------------------------------</a>
<a name="ln517"> </a>
<a name="ln518">void TextFragment::draw(QPainter* p, const TextBase* t) const</a>
<a name="ln519">      {</a>
<a name="ln520">      QFont f(font(t));</a>
<a name="ln521">      f.setPointSizeF(f.pointSizeF() * MScore::pixelRatio);</a>
<a name="ln522">      p-&gt;setFont(f);</a>
<a name="ln523">      p-&gt;drawText(pos, text);</a>
<a name="ln524">      }</a>
<a name="ln525"> </a>
<a name="ln526">//---------------------------------------------------------</a>
<a name="ln527">//   font</a>
<a name="ln528">//---------------------------------------------------------</a>
<a name="ln529"> </a>
<a name="ln530">QFont TextFragment::font(const TextBase* t) const</a>
<a name="ln531">      {</a>
<a name="ln532">      QFont font;</a>
<a name="ln533"> </a>
<a name="ln534">      qreal m = format.fontSize();</a>
<a name="ln535"> </a>
<a name="ln536">      if (t-&gt;sizeIsSpatiumDependent())</a>
<a name="ln537">            m *= t-&gt;spatium() / SPATIUM20;</a>
<a name="ln538">      if (format.valign() != VerticalAlignment::AlignNormal)</a>
<a name="ln539">            m *= subScriptSize;</a>
<a name="ln540">      font.setUnderline(format.underline() || format.preedit());</a>
<a name="ln541"> </a>
<a name="ln542">      QString family;</a>
<a name="ln543">      if (format.fontFamily() == &quot;ScoreText&quot;) {</a>
<a name="ln544">            family = t-&gt;score()-&gt;styleSt(Sid::MusicalTextFont);</a>
<a name="ln545"> </a>
<a name="ln546">            // check if all symbols are available</a>
<a name="ln547">            font.setFamily(family);</a>
<a name="ln548">            QFontMetricsF fm(font);</a>
<a name="ln549"> </a>
<a name="ln550">            bool fail = false;</a>
<a name="ln551">            for (int i = 0; i &lt; text.size(); ++i) {</a>
<a name="ln552">                  QChar c = text[i];</a>
<a name="ln553">                  if (c.isHighSurrogate()) {</a>
<a name="ln554">                        if (i+1 == text.size())</a>
<a name="ln555">                              qFatal(&quot;bad string&quot;);</a>
<a name="ln556">                        QChar c2 = text[i+1];</a>
<a name="ln557">                        ++i;</a>
<a name="ln558">                        uint v = QChar::surrogateToUcs4(c, c2);</a>
<a name="ln559">                        if (!fm.inFontUcs4(v)) {</a>
<a name="ln560">                              fail = true;</a>
<a name="ln561">                              break;</a>
<a name="ln562">                              }</a>
<a name="ln563">                        }</a>
<a name="ln564">                  else {</a>
<a name="ln565">                        if (!fm.inFont(c)) {</a>
<a name="ln566">                              fail = true;</a>
<a name="ln567">                              break;</a>
<a name="ln568">                              }</a>
<a name="ln569">                        }</a>
<a name="ln570">                  }</a>
<a name="ln571">            if (fail)</a>
<a name="ln572">                  family = ScoreFont::fallbackTextFont();</a>
<a name="ln573">            }</a>
<a name="ln574">      else</a>
<a name="ln575">            family = format.fontFamily();</a>
<a name="ln576"> </a>
<a name="ln577">      font.setFamily(family);</a>
<a name="ln578">      font.setBold(format.bold());</a>
<a name="ln579">      font.setItalic(format.italic());</a>
<a name="ln580">      Q_ASSERT(m &gt; 0.0);</a>
<a name="ln581"> </a>
<a name="ln582">      font.setPointSizeF(m);</a>
<a name="ln583">      return font;</a>
<a name="ln584">      }</a>
<a name="ln585"> </a>
<a name="ln586">//---------------------------------------------------------</a>
<a name="ln587">//   draw</a>
<a name="ln588">//---------------------------------------------------------</a>
<a name="ln589"> </a>
<a name="ln590">void TextBlock::draw(QPainter* p, const TextBase* t) const</a>
<a name="ln591">      {</a>
<a name="ln592">      p-&gt;translate(0.0, _y);</a>
<a name="ln593">      for (const TextFragment&amp; f : _fragments)</a>
<a name="ln594">            f.draw(p, t);</a>
<a name="ln595">      p-&gt;translate(0.0, -_y);</a>
<a name="ln596">      }</a>
<a name="ln597"> </a>
<a name="ln598">//---------------------------------------------------------</a>
<a name="ln599">//   layout</a>
<a name="ln600">//---------------------------------------------------------</a>
<a name="ln601"> </a>
<a name="ln602">void TextBlock::layout(TextBase* t)</a>
<a name="ln603">      {</a>
<a name="ln604">      _bbox        = QRectF();</a>
<a name="ln605">      qreal x      = 0.0;</a>
<a name="ln606">      _lineSpacing = 0.0;</a>
<a name="ln607">      qreal lm     = 0.0;</a>
<a name="ln608"> </a>
<a name="ln609">      qreal layoutWidth = 0;</a>
<a name="ln610">      Element* e = t-&gt;parent();</a>
<a name="ln611">      if (e &amp;&amp; t-&gt;layoutToParentWidth()) {</a>
<a name="ln612">            layoutWidth = e-&gt;width();</a>
<a name="ln613">            switch(e-&gt;type()) {</a>
<a name="ln614">                  case ElementType::HBOX:</a>
<a name="ln615">                  case ElementType::VBOX:</a>
<a name="ln616">                  case ElementType::TBOX: {</a>
<a name="ln617">                        Box* b = toBox(e);</a>
<a name="ln618">                        layoutWidth -= ((b-&gt;leftMargin() + b-&gt;rightMargin()) * DPMM);</a>
<a name="ln619">                        lm = b-&gt;leftMargin() * DPMM;</a>
<a name="ln620">                        }</a>
<a name="ln621">                        break;</a>
<a name="ln622">                  case ElementType::PAGE: {</a>
<a name="ln623">                        Page* p = toPage(e);</a>
<a name="ln624">                        layoutWidth -= (p-&gt;lm() + p-&gt;rm());</a>
<a name="ln625">                        lm = p-&gt;lm();</a>
<a name="ln626">                        }</a>
<a name="ln627">                        break;</a>
<a name="ln628">                  case ElementType::MEASURE: {</a>
<a name="ln629">                        Measure* m = toMeasure(e);</a>
<a name="ln630">                        layoutWidth = m-&gt;bbox().width();</a>
<a name="ln631">                        }</a>
<a name="ln632">                        break;</a>
<a name="ln633">                  default:</a>
<a name="ln634">                        break;</a>
<a name="ln635">                  }</a>
<a name="ln636">            }</a>
<a name="ln637">      if (_fragments.empty()) {</a>
<a name="ln638">            QFontMetricsF fm = t-&gt;fontMetrics();</a>
<a name="ln639">            _bbox.setRect(0.0, -fm.ascent(), 1.0, fm.descent());</a>
<a name="ln640">            _lineSpacing = fm.lineSpacing();</a>
<a name="ln641">            }</a>
<a name="ln642">      else {</a>
<a name="ln643">            for (TextFragment&amp; f : _fragments) {</a>
<a name="ln644">                  f.pos.setX(x);</a>
<a name="ln645">                  QFontMetricsF fm(f.font(t), MScore::paintDevice());</a>
<a name="ln646">                  if (f.format.valign() != VerticalAlignment::AlignNormal) {</a>
<a name="ln647">                        qreal voffset = fm.xHeight() / subScriptSize;   // use original height</a>
<a name="ln648">                        if (f.format.valign() == VerticalAlignment::AlignSubScript)</a>
<a name="ln649">                              voffset *= subScriptOffset;</a>
<a name="ln650">                        else</a>
<a name="ln651">                              voffset *= superScriptOffset;</a>
<a name="ln652">                        f.pos.setY(voffset);</a>
<a name="ln653">                        }</a>
<a name="ln654">                  else</a>
<a name="ln655">                        f.pos.setY(0.0);</a>
<a name="ln656">                  qreal w  = fm.width(f.text);</a>
<a name="ln657">                  _bbox   |= fm.tightBoundingRect(f.text).translated(f.pos);</a>
<a name="ln658">                  x += w;</a>
<a name="ln659">                  _lineSpacing = qMax(_lineSpacing, fm.lineSpacing());</a>
<a name="ln660">                  }</a>
<a name="ln661">            }</a>
<a name="ln662">      qreal rx;</a>
<a name="ln663">      if (t-&gt;align() &amp; Align::RIGHT)</a>
<a name="ln664">            rx = layoutWidth-_bbox.right();</a>
<a name="ln665">      else if (t-&gt;align() &amp; Align::HCENTER)</a>
<a name="ln666">            rx = (layoutWidth - (_bbox.left() + _bbox.right())) * .5;</a>
<a name="ln667">      else  // Align::LEFT</a>
<a name="ln668">            rx = -_bbox.left();</a>
<a name="ln669">      rx += lm;</a>
<a name="ln670">      for (TextFragment&amp; f : _fragments)</a>
<a name="ln671">            f.pos.rx() += rx;</a>
<a name="ln672">      _bbox.translate(rx, 0.0);</a>
<a name="ln673">      }</a>
<a name="ln674"> </a>
<a name="ln675">//---------------------------------------------------------</a>
<a name="ln676">//   xpos</a>
<a name="ln677">//---------------------------------------------------------</a>
<a name="ln678"> </a>
<a name="ln679">qreal TextBlock::xpos(int column, const TextBase* t) const</a>
<a name="ln680">      {</a>
<a name="ln681">      int col = 0;</a>
<a name="ln682">      for (const TextFragment&amp; f : _fragments) {</a>
<a name="ln683">            if (column == col)</a>
<a name="ln684">                  return f.pos.x();</a>
<a name="ln685">            QFontMetricsF fm(f.font(t), MScore::paintDevice());</a>
<a name="ln686">            int idx = 0;</a>
<a name="ln687">            for (const QChar&amp; c : f.text) {</a>
<a name="ln688">                  ++idx;</a>
<a name="ln689">                  if (c.isHighSurrogate())</a>
<a name="ln690">                        continue;</a>
<a name="ln691">                  ++col;</a>
<a name="ln692">                  if (column == col)</a>
<a name="ln693">                        return f.pos.x() + fm.width(f.text.left(idx));</a>
<a name="ln694">                  }</a>
<a name="ln695">            }</a>
<a name="ln696">      return _bbox.x();</a>
<a name="ln697">      }</a>
<a name="ln698"> </a>
<a name="ln699">//---------------------------------------------------------</a>
<a name="ln700">//   fragment</a>
<a name="ln701">//---------------------------------------------------------</a>
<a name="ln702"> </a>
<a name="ln703">const TextFragment* TextBlock::fragment(int column) const</a>
<a name="ln704">      {</a>
<a name="ln705">      if (_fragments.empty())</a>
<a name="ln706">            return 0;</a>
<a name="ln707">      int col = 0;</a>
<a name="ln708">      auto f = _fragments.begin();</a>
<a name="ln709">      for (; f != _fragments.end(); ++f) {</a>
<a name="ln710">            for (const QChar&amp; c : f-&gt;text) {</a>
<a name="ln711">                  if (c.isHighSurrogate())</a>
<a name="ln712">                        continue;</a>
<a name="ln713">                  if (column == col)</a>
<a name="ln714">                        return &amp;*f;</a>
<a name="ln715">                  ++col;</a>
<a name="ln716">                  }</a>
<a name="ln717">            }</a>
<a name="ln718">      if (column == col)</a>
<a name="ln719">            return &amp;*(f-1);</a>
<a name="ln720">      return 0;</a>
<a name="ln721">      }</a>
<a name="ln722"> </a>
<a name="ln723">//---------------------------------------------------------</a>
<a name="ln724">//   formatAt</a>
<a name="ln725">//---------------------------------------------------------</a>
<a name="ln726"> </a>
<a name="ln727">const CharFormat* TextBlock::formatAt(int column) const</a>
<a name="ln728">      {</a>
<a name="ln729">      const TextFragment* f = fragment(column);</a>
<a name="ln730">      if (f)</a>
<a name="ln731">            return &amp;(f-&gt;format);</a>
<a name="ln732">      return 0;</a>
<a name="ln733">      }</a>
<a name="ln734"> </a>
<a name="ln735">//---------------------------------------------------------</a>
<a name="ln736">//   boundingRect</a>
<a name="ln737">//---------------------------------------------------------</a>
<a name="ln738"> </a>
<a name="ln739">QRectF TextBlock::boundingRect(int col1, int col2, const TextBase* t) const</a>
<a name="ln740">      {</a>
<a name="ln741">      qreal x1 = xpos(col1, t);</a>
<a name="ln742">      qreal x2 = xpos(col2, t);</a>
<a name="ln743">      return QRectF(x1, _bbox.y(), x2-x1, _bbox.height());</a>
<a name="ln744">      }</a>
<a name="ln745"> </a>
<a name="ln746">//---------------------------------------------------------</a>
<a name="ln747">//   columns</a>
<a name="ln748">//---------------------------------------------------------</a>
<a name="ln749"> </a>
<a name="ln750">int TextBlock::columns() const</a>
<a name="ln751">      {</a>
<a name="ln752">      int col = 0;</a>
<a name="ln753">      for (const TextFragment&amp; f : _fragments) {</a>
<a name="ln754">            for (const QChar&amp; c : f.text) {</a>
<a name="ln755">                  if (!c.isHighSurrogate())</a>
<a name="ln756">                        ++col;</a>
<a name="ln757">                  }</a>
<a name="ln758">            }</a>
<a name="ln759">      return col;</a>
<a name="ln760">      }</a>
<a name="ln761"> </a>
<a name="ln762">//---------------------------------------------------------</a>
<a name="ln763">//   column</a>
<a name="ln764">//    Return nearest column for position x. X is in</a>
<a name="ln765">//    Text coordinate system</a>
<a name="ln766">//---------------------------------------------------------</a>
<a name="ln767"> </a>
<a name="ln768">int TextBlock::column(qreal x, TextBase* t) const</a>
<a name="ln769">      {</a>
<a name="ln770">      int col = 0;</a>
<a name="ln771">      for (const TextFragment&amp; f : _fragments) {</a>
<a name="ln772">            int idx = 0;</a>
<a name="ln773">            if (x &lt;= f.pos.x())</a>
<a name="ln774">                  return col;</a>
<a name="ln775">            qreal px = 0.0;</a>
<a name="ln776">            for (const QChar&amp; c : f.text) {</a>
<a name="ln777">                  ++idx;</a>
<a name="ln778">                  if (c.isHighSurrogate())</a>
<a name="ln779">                        continue;</a>
<a name="ln780">                  QFontMetricsF fm(f.font(t), MScore::paintDevice());</a>
<a name="ln781">                  qreal xo = fm.width(f.text.left(idx));</a>
<a name="ln782">                  if (x &lt;= f.pos.x() + px + (xo-px)*.5)</a>
<a name="ln783">                        return col;</a>
<a name="ln784">                  ++col;</a>
<a name="ln785">                  px = xo;</a>
<a name="ln786">                  }</a>
<a name="ln787">            }</a>
<a name="ln788">      return col;</a>
<a name="ln789">      }</a>
<a name="ln790"> </a>
<a name="ln791">//---------------------------------------------------------</a>
<a name="ln792">//   insert</a>
<a name="ln793">//---------------------------------------------------------</a>
<a name="ln794"> </a>
<a name="ln795">void TextBlock::insert(TextCursor* cursor, const QString&amp; s)</a>
<a name="ln796">      {</a>
<a name="ln797">      int rcol, ridx;</a>
<a name="ln798">      auto i = fragment(cursor-&gt;column(), &amp;rcol, &amp;ridx);</a>
<a name="ln799">      if (i != _fragments.end()) {</a>
<a name="ln800">            if (!(i-&gt;format == *cursor-&gt;format())) {</a>
<a name="ln801">                  if (rcol == 0)</a>
<a name="ln802">                        _fragments.insert(i, TextFragment(cursor, s));</a>
<a name="ln803">                  else {</a>
<a name="ln804">                        TextFragment f2 = i-&gt;split(rcol);</a>
<a name="ln805">                        i = _fragments.insert(i+1, TextFragment(cursor, s));</a>
<a name="ln806">                        _fragments.insert(i+1, f2);</a>
<a name="ln807">                        }</a>
<a name="ln808">                  }</a>
<a name="ln809">            else</a>
<a name="ln810">                  i-&gt;text.insert(ridx, s);</a>
<a name="ln811">            }</a>
<a name="ln812">      else {</a>
<a name="ln813">            if (!_fragments.empty() &amp;&amp; _fragments.back().format == *cursor-&gt;format())</a>
<a name="ln814">                  _fragments.back().text.append(s);</a>
<a name="ln815">            else</a>
<a name="ln816">                  _fragments.append(TextFragment(cursor, s));</a>
<a name="ln817">            }</a>
<a name="ln818">      }</a>
<a name="ln819"> </a>
<a name="ln820">//---------------------------------------------------------</a>
<a name="ln821">//   fragment</a>
<a name="ln822">//    inputs:</a>
<a name="ln823">//      column is the column relative to the start of the TextBlock.</a>
<a name="ln824">//    outputs:</a>
<a name="ln825">//      rcol will be the column relative to the start of the TextFragment that the input column is in.</a>
<a name="ln826">//      ridx will be the QChar index into TextFragment's text QString relative to the start of that TextFragment.</a>
<a name="ln827">//</a>
<a name="ln828">//---------------------------------------------------------</a>
<a name="ln829"> </a>
<a name="ln830">QList&lt;TextFragment&gt;::iterator TextBlock::fragment(int column, int* rcol, int* ridx)</a>
<a name="ln831">      {</a>
<a name="ln832">      int col = 0;</a>
<a name="ln833">      for (auto i = _fragments.begin(); i != _fragments.end(); ++i) {</a>
<a name="ln834">            *rcol = 0;</a>
<a name="ln835">            *ridx = 0;</a>
<a name="ln836">            for (const QChar&amp; c : i-&gt;text) {</a>
<a name="ln837">                  if (col == column)</a>
<a name="ln838">                        return i;</a>
<a name="ln839">                  ++*ridx;</a>
<a name="ln840">                  if (c.isHighSurrogate())</a>
<a name="ln841">                        continue;</a>
<a name="ln842">                  ++col;</a>
<a name="ln843">                  ++*rcol;</a>
<a name="ln844">                  }</a>
<a name="ln845">            }</a>
<a name="ln846">      return _fragments.end();</a>
<a name="ln847">      }</a>
<a name="ln848"> </a>
<a name="ln849">//---------------------------------------------------------</a>
<a name="ln850">//   remove</a>
<a name="ln851">//---------------------------------------------------------</a>
<a name="ln852"> </a>
<a name="ln853">QString TextBlock::remove(int column)</a>
<a name="ln854">      {</a>
<a name="ln855">      int col = 0;</a>
<a name="ln856">      QString s;</a>
<a name="ln857">      for (auto i = _fragments.begin(); i != _fragments.end(); ++i) {</a>
<a name="ln858">            int idx  = 0;</a>
<a name="ln859">            int rcol = 0;</a>
<a name="ln860">            for (const QChar&amp; c : i-&gt;text) {</a>
<a name="ln861">                  if (col == column) {</a>
<a name="ln862">                        if (c.isSurrogate()) {</a>
<a name="ln863">                              s = i-&gt;text.mid(idx, 2);</a>
<a name="ln864">                              i-&gt;text.remove(idx, 2);</a>
<a name="ln865">                              }</a>
<a name="ln866">                        else {</a>
<a name="ln867">                              s = i-&gt;text.mid(idx, 1);</a>
<a name="ln868">                              i-&gt;text.remove(idx, 1);</a>
<a name="ln869">                              }</a>
<a name="ln870">                        if (i-&gt;text.isEmpty())</a>
<a name="ln871">                              _fragments.erase(i);</a>
<a name="ln872">                        simplify();</a>
<a name="ln873">                        return s;</a>
<a name="ln874">                        }</a>
<a name="ln875">                  ++idx;</a>
<a name="ln876">                  if (c.isHighSurrogate())</a>
<a name="ln877">                        continue;</a>
<a name="ln878">                  ++col;</a>
<a name="ln879">                  ++rcol;</a>
<a name="ln880">                  }</a>
<a name="ln881">            }</a>
<a name="ln882">      return s;</a>
<a name="ln883">//      qDebug(&quot;TextBlock::remove: column %d not found&quot;, column);</a>
<a name="ln884">      }</a>
<a name="ln885"> </a>
<a name="ln886">//---------------------------------------------------------</a>
<a name="ln887">//   simplify</a>
<a name="ln888">//---------------------------------------------------------</a>
<a name="ln889"> </a>
<a name="ln890">void TextBlock::simplify()</a>
<a name="ln891">      {</a>
<a name="ln892">      if (_fragments.size() &lt; 2)</a>
<a name="ln893">            return;</a>
<a name="ln894">      auto i = _fragments.begin();</a>
<a name="ln895">      TextFragment* f = &amp;*i;</a>
<a name="ln896">      ++i;</a>
<a name="ln897">      for (; i != _fragments.end(); ++i) {</a>
<a name="ln898">            while (i != _fragments.end() &amp;&amp; (i-&gt;format == f-&gt;format)) {</a>
<a name="ln899">                  f-&gt;text.append(i-&gt;text);</a>
<a name="ln900">                  i = _fragments.erase(i);</a>
<a name="ln901">                  }</a>
<a name="ln902">            if (i == _fragments.end())</a>
<a name="ln903">                  break;</a>
<a name="ln904">            f = &amp;*i;</a>
<a name="ln905">            }</a>
<a name="ln906">      }</a>
<a name="ln907"> </a>
<a name="ln908">//---------------------------------------------------------</a>
<a name="ln909">//   remove</a>
<a name="ln910">//---------------------------------------------------------</a>
<a name="ln911"> </a>
<a name="ln912">QString TextBlock::remove(int start, int n)</a>
<a name="ln913">      {</a>
<a name="ln914">      if (n == 0)</a>
<a name="ln915">            return QString();</a>
<a name="ln916">      int col = 0;</a>
<a name="ln917">      QString s;</a>
<a name="ln918">      for (auto i = _fragments.begin(); i != _fragments.end();) {</a>
<a name="ln919">            int rcol = 0;</a>
<a name="ln920">            bool inc = true;</a>
<a name="ln921">            for( int idx = 0; idx &lt; i-&gt;text.length(); ) {</a>
<a name="ln922">                  QChar c = i-&gt;text[idx];</a>
<a name="ln923">                  if (col == start) {</a>
<a name="ln924">                        if (c.isHighSurrogate()) {</a>
<a name="ln925">                              s += c;</a>
<a name="ln926">                              i-&gt;text.remove(idx, 1);</a>
<a name="ln927">                              c = i-&gt;text[idx];</a>
<a name="ln928">                              }</a>
<a name="ln929">                        s += c;</a>
<a name="ln930">                        i-&gt;text.remove(idx, 1);</a>
<a name="ln931">                        if (i-&gt;text.isEmpty() &amp;&amp; (_fragments.size() &gt; 1)) {</a>
<a name="ln932">                              i = _fragments.erase(i);</a>
<a name="ln933">                              inc = false;</a>
<a name="ln934">                              }</a>
<a name="ln935">                        --n;</a>
<a name="ln936">                        if (n == 0)</a>
<a name="ln937">                              return s;</a>
<a name="ln938">                        continue;</a>
<a name="ln939">                        }</a>
<a name="ln940">                  ++idx;</a>
<a name="ln941">                  if (c.isHighSurrogate())</a>
<a name="ln942">                        continue;</a>
<a name="ln943">                  ++col;</a>
<a name="ln944">                  ++rcol;</a>
<a name="ln945">                  }</a>
<a name="ln946">            if (inc)</a>
<a name="ln947">                  ++i;</a>
<a name="ln948">            }</a>
<a name="ln949">      return s;</a>
<a name="ln950">      }</a>
<a name="ln951"> </a>
<a name="ln952">//---------------------------------------------------------</a>
<a name="ln953">//   changeFormat</a>
<a name="ln954">//---------------------------------------------------------</a>
<a name="ln955"> </a>
<a name="ln956">void TextBlock::changeFormat(FormatId id, QVariant data, int start, int n)</a>
<a name="ln957">      {</a>
<a name="ln958">      int col = 0;</a>
<a name="ln959">      for (auto i = _fragments.begin(); i != _fragments.end(); ++i) {</a>
<a name="ln960">            int columns = i-&gt;columns();</a>
<a name="ln961">            if (start + n &lt;= col)</a>
<a name="ln962">                  break;</a>
<a name="ln963">            if (start &gt;= col + columns) {</a>
<a name="ln964">                  col += i-&gt;columns();</a>
<a name="ln965">                  continue;</a>
<a name="ln966">                  }</a>
<a name="ln967">            int endCol = col + columns;</a>
<a name="ln968"> </a>
<a name="ln969">            if ((start &lt;= col) &amp;&amp; (start &lt; endCol) &amp;&amp; ((start+n) &lt; endCol)) {</a>
<a name="ln970">                  // left</a>
<a name="ln971">                  TextFragment f = i-&gt;split(start + n - col);</a>
<a name="ln972">                  i-&gt;changeFormat(id, data);</a>
<a name="ln973">                  i = _fragments.insert(i+1, f);</a>
<a name="ln974">                  }</a>
<a name="ln975">            else if (start &gt; col &amp;&amp; ((start+n) &lt; endCol)) {</a>
<a name="ln976">                  // middle</a>
<a name="ln977">                  TextFragment lf = i-&gt;split(start+n - col);</a>
<a name="ln978">                  TextFragment mf = i-&gt;split(start - col);</a>
<a name="ln979">                  mf.changeFormat(id, data);</a>
<a name="ln980">                  i = _fragments.insert(i+1, mf);</a>
<a name="ln981">                  i = _fragments.insert(i+1, lf);</a>
<a name="ln982">                  }</a>
<a name="ln983">            else if (start &gt; col) {</a>
<a name="ln984">                  // right</a>
<a name="ln985">                  TextFragment f = i-&gt;split(start - col);</a>
<a name="ln986">                  f.changeFormat(id, data);</a>
<a name="ln987">                  i = _fragments.insert(i+1, f);</a>
<a name="ln988">                  }</a>
<a name="ln989">            else {</a>
<a name="ln990">                  // complete fragment</a>
<a name="ln991">                  i-&gt;changeFormat(id, data);</a>
<a name="ln992">                  }</a>
<a name="ln993">            col = endCol;</a>
<a name="ln994">            }</a>
<a name="ln995">      }</a>
<a name="ln996"> </a>
<a name="ln997">//---------------------------------------------------------</a>
<a name="ln998">//   setFormat</a>
<a name="ln999">//---------------------------------------------------------</a>
<a name="ln1000"> </a>
<a name="ln1001">void CharFormat::setFormat(FormatId id, QVariant data)</a>
<a name="ln1002">      {</a>
<a name="ln1003">      switch (id) {</a>
<a name="ln1004">            case FormatId::Bold:</a>
<a name="ln1005">                  setBold(data.toBool());</a>
<a name="ln1006">                  break;</a>
<a name="ln1007">            case FormatId::Italic:</a>
<a name="ln1008">                  setItalic(data.toBool());</a>
<a name="ln1009">                  break;</a>
<a name="ln1010">            case FormatId::Underline:</a>
<a name="ln1011">                  setUnderline(data.toBool());</a>
<a name="ln1012">                  break;</a>
<a name="ln1013">            case FormatId::Valign:</a>
<a name="ln1014">                  _valign = static_cast&lt;VerticalAlignment&gt;(data.toInt());</a>
<a name="ln1015">                  break;</a>
<a name="ln1016">            case FormatId::FontSize:</a>
<a name="ln1017">                  _fontSize = data.toDouble();</a>
<a name="ln1018">                  break;</a>
<a name="ln1019">            case FormatId::FontFamily:</a>
<a name="ln1020">                  _fontFamily = data.toString();</a>
<a name="ln1021">                  break;</a>
<a name="ln1022">            }</a>
<a name="ln1023">      }</a>
<a name="ln1024"> </a>
<a name="ln1025">//---------------------------------------------------------</a>
<a name="ln1026">//   changeFormat</a>
<a name="ln1027">//---------------------------------------------------------</a>
<a name="ln1028"> </a>
<a name="ln1029">void TextFragment::changeFormat(FormatId id, QVariant data)</a>
<a name="ln1030">      {</a>
<a name="ln1031">      format.setFormat(id, data);</a>
<a name="ln1032">      }</a>
<a name="ln1033"> </a>
<a name="ln1034">//---------------------------------------------------------</a>
<a name="ln1035">//   split</a>
<a name="ln1036">//---------------------------------------------------------</a>
<a name="ln1037"> </a>
<a name="ln1038">TextBlock TextBlock::split(int column)</a>
<a name="ln1039">      {</a>
<a name="ln1040">      TextBlock tl;</a>
<a name="ln1041"> </a>
<a name="ln1042">      int col = 0;</a>
<a name="ln1043">      for (auto i = _fragments.begin(); i != _fragments.end(); ++i) {</a>
<a name="ln1044">            int idx = 0;</a>
<a name="ln1045">            for (const QChar&amp; c : i-&gt;text) {</a>
<a name="ln1046">                  if (col == column) {</a>
<a name="ln1047">                        if (idx) {</a>
<a name="ln1048">                              if (idx &lt; i-&gt;text.size()) {</a>
<a name="ln1049">                                    TextFragment tf(i-&gt;text.mid(idx));</a>
<a name="ln1050">                                    tf.format = i-&gt;format;</a>
<a name="ln1051">                                    tl._fragments.append(tf);</a>
<a name="ln1052">                                    i-&gt;text = i-&gt;text.left(idx);</a>
<a name="ln1053">                                    ++i;</a>
<a name="ln1054">                                    }</a>
<a name="ln1055">                              }</a>
<a name="ln1056">                        for (; i != _fragments.end(); i = _fragments.erase(i))</a>
<a name="ln1057">                              tl._fragments.append(*i);</a>
<a name="ln1058">                        return tl;</a>
<a name="ln1059">                        }</a>
<a name="ln1060">                  ++idx;</a>
<a name="ln1061">                  if (c.isHighSurrogate())</a>
<a name="ln1062">                        continue;</a>
<a name="ln1063">                  ++col;</a>
<a name="ln1064">                  }</a>
<a name="ln1065">            }</a>
<a name="ln1066">      TextFragment tf(&quot;&quot;);</a>
<a name="ln1067">      if (_fragments.size() &gt; 0)</a>
<a name="ln1068">            tf.format = _fragments.last().format;</a>
<a name="ln1069">      tl._fragments.append(tf);</a>
<a name="ln1070">      return tl;</a>
<a name="ln1071">      }</a>
<a name="ln1072"> </a>
<a name="ln1073">//---------------------------------------------------------</a>
<a name="ln1074">//   text</a>
<a name="ln1075">//    extract text, symbols are marked with &lt;sym&gt;xxx&lt;/sym&gt;</a>
<a name="ln1076">//---------------------------------------------------------</a>
<a name="ln1077"> </a>
<a name="ln1078">QString TextBlock::text(int col1, int len) const</a>
<a name="ln1079">      {</a>
<a name="ln1080">      QString s;</a>
<a name="ln1081">      int col = 0;</a>
<a name="ln1082">      for (auto f : _fragments) {</a>
<a name="ln1083">            if (f.text.isEmpty())</a>
<a name="ln1084">                  continue;</a>
<a name="ln1085">            for (const QChar&amp; c : f.text) {</a>
<a name="ln1086">                  if (col &gt;= col1 &amp;&amp; (len &lt; 0 || ((col-col1) &lt; len)))</a>
<a name="ln1087">                        s += XmlWriter::xmlString(c.unicode());</a>
<a name="ln1088">                  if (!c.isHighSurrogate())</a>
<a name="ln1089">                        ++col;</a>
<a name="ln1090">                  }</a>
<a name="ln1091">            }</a>
<a name="ln1092">      return s;</a>
<a name="ln1093">      }</a>
<a name="ln1094"> </a>
<a name="ln1095">//---------------------------------------------------------</a>
<a name="ln1096">//   Text</a>
<a name="ln1097">//---------------------------------------------------------</a>
<a name="ln1098"> </a>
<a name="ln1099">TextBase::TextBase(Score* s, Tid tid, ElementFlags f)</a>
<a name="ln1100">   : Element(s, f | ElementFlag::MOVABLE)</a>
<a name="ln1101">      {</a>
<a name="ln1102">      _tid                    = tid;</a>
<a name="ln1103">      _family                 = &quot;FreeSerif&quot;;</a>
<a name="ln1104">      _size                   = 10.0;</a>
<a name="ln1105">      _fontStyle              = FontStyle::Normal;</a>
<a name="ln1106">      _bgColor                = QColor(255, 255, 255, 0);</a>
<a name="ln1107">      _frameColor             = QColor(0, 0, 0, 255);</a>
<a name="ln1108">      _align                  = Align::LEFT;</a>
<a name="ln1109">      _frameType              = FrameType::NO_FRAME;</a>
<a name="ln1110">      _frameWidth             = Spatium(0.1);</a>
<a name="ln1111">      _paddingWidth           = Spatium(0.2);</a>
<a name="ln1112">      _frameRound             = 0;</a>
<a name="ln1113">      }</a>
<a name="ln1114"> </a>
<a name="ln1115">TextBase::TextBase(Score* s, ElementFlags f)</a>
<a name="ln1116">   : TextBase(s, Tid::DEFAULT, f)</a>
<a name="ln1117">      {</a>
<a name="ln1118">      }</a>
<a name="ln1119"> </a>
<a name="ln1120">TextBase::TextBase(const TextBase&amp; st)</a>
<a name="ln1121">   : Element(st)</a>
<a name="ln1122">      {</a>
<a name="ln1123">      _text                        = st._text;</a>
<a name="ln1124">      _layout                      = st._layout;</a>
<a name="ln1125">      textInvalid                  = st.textInvalid;</a>
<a name="ln1126">      layoutInvalid                = st.layoutInvalid;</a>
<a name="ln1127">      frame                        = st.frame;</a>
<a name="ln1128">      _layoutToParentWidth         = st._layoutToParentWidth;</a>
<a name="ln1129">      hexState                     = -1;</a>
<a name="ln1130"> </a>
<a name="ln1131">      _tid                         = st._tid;</a>
<a name="ln1132">      _family                      = st._family;</a>
<a name="ln1133">      _size                        = st._size;</a>
<a name="ln1134">      _fontStyle                   = st._fontStyle;</a>
<a name="ln1135">      _bgColor                     = st._bgColor;</a>
<a name="ln1136">      _frameColor                  = st._frameColor;</a>
<a name="ln1137">      _align                       = st._align;</a>
<a name="ln1138">      _frameType                   = st._frameType;</a>
<a name="ln1139">      _frameWidth                  = st._frameWidth;</a>
<a name="ln1140">      _paddingWidth                = st._paddingWidth;</a>
<a name="ln1141">      _frameRound                  = st._frameRound;</a>
<a name="ln1142"> </a>
<a name="ln1143">      size_t n = _elementStyle-&gt;size() + TEXT_STYLE_SIZE;</a>
<a name="ln1144">      delete[] _propertyFlagsList;</a>
<a name="ln1145">      _propertyFlagsList = new PropertyFlags[n];</a>
<a name="ln1146">      for (size_t i = 0; i &lt; n; ++i)</a>
<a name="ln1147">            _propertyFlagsList[i] = st._propertyFlagsList[i];</a>
<a name="ln1148">      _links = 0;</a>
<a name="ln1149">      }</a>
<a name="ln1150"> </a>
<a name="ln1151">//---------------------------------------------------------</a>
<a name="ln1152">//   drawSelection</a>
<a name="ln1153">//---------------------------------------------------------</a>
<a name="ln1154"> </a>
<a name="ln1155">void TextBase::drawSelection(QPainter* p, const QRectF&amp; r) const</a>
<a name="ln1156">      {</a>
<a name="ln1157">      QBrush bg(QColor(&quot;steelblue&quot;));</a>
<a name="ln1158">      p-&gt;setCompositionMode(QPainter::CompositionMode_HardLight);</a>
<a name="ln1159">      p-&gt;setBrush(bg);</a>
<a name="ln1160">      p-&gt;setPen(Qt::NoPen);</a>
<a name="ln1161">      p-&gt;drawRect(r);</a>
<a name="ln1162">      p-&gt;setCompositionMode(QPainter::CompositionMode_SourceOver);</a>
<a name="ln1163">      p-&gt;setPen(textColor());</a>
<a name="ln1164">      }</a>
<a name="ln1165"> </a>
<a name="ln1166">//---------------------------------------------------------</a>
<a name="ln1167">//   textColor</a>
<a name="ln1168">//---------------------------------------------------------</a>
<a name="ln1169"> </a>
<a name="ln1170">QColor TextBase::textColor() const</a>
<a name="ln1171">      {</a>
<a name="ln1172">      return curColor();</a>
<a name="ln1173">      }</a>
<a name="ln1174"> </a>
<a name="ln1175">//---------------------------------------------------------</a>
<a name="ln1176">//   insert</a>
<a name="ln1177">//    insert character</a>
<a name="ln1178">//---------------------------------------------------------</a>
<a name="ln1179"> </a>
<a name="ln1180">void TextBase::insert(TextCursor* cursor, uint code)</a>
<a name="ln1181">      {</a>
<a name="ln1182">      if (cursor-&gt;row() &gt;= rows())</a>
<a name="ln1183">            _layout.append(TextBlock());</a>
<a name="ln1184">      if (code == '\t')</a>
<a name="ln1185">            code = ' ';</a>
<a name="ln1186"> </a>
<a name="ln1187">      QString s;</a>
<a name="ln1188">      if (QChar::requiresSurrogates(code))</a>
<a name="ln1189">            s = QString(QChar(QChar::highSurrogate(code))).append(QChar(QChar::lowSurrogate(code)));</a>
<a name="ln1190">      else</a>
<a name="ln1191">            s = QString(code);</a>
<a name="ln1192">      _layout[cursor-&gt;row()].insert(cursor, s);</a>
<a name="ln1193"> </a>
<a name="ln1194">      cursor-&gt;setColumn(cursor-&gt;column() + 1);</a>
<a name="ln1195">      cursor-&gt;clearSelection();</a>
<a name="ln1196">      }</a>
<a name="ln1197"> </a>
<a name="ln1198">//---------------------------------------------------------</a>
<a name="ln1199">//   parseStringProperty</a>
<a name="ln1200">//---------------------------------------------------------</a>
<a name="ln1201"> </a>
<a name="ln1202">static QString parseStringProperty(const QString&amp; s)</a>
<a name="ln1203">      {</a>
<a name="ln1204">      QString rs;</a>
<a name="ln1205">      for (const QChar&amp; c : s) {</a>
<a name="ln1206">            if (c == '&quot;')</a>
<a name="ln1207">                  break;</a>
<a name="ln1208">            rs += c;</a>
<a name="ln1209">            }</a>
<a name="ln1210">      return rs;</a>
<a name="ln1211">      }</a>
<a name="ln1212"> </a>
<a name="ln1213">//---------------------------------------------------------</a>
<a name="ln1214">//   parseNumProperty</a>
<a name="ln1215">//---------------------------------------------------------</a>
<a name="ln1216"> </a>
<a name="ln1217">static qreal parseNumProperty(const QString&amp; s)</a>
<a name="ln1218">      {</a>
<a name="ln1219">      return parseStringProperty(s).toDouble();</a>
<a name="ln1220">      }</a>
<a name="ln1221"> </a>
<a name="ln1222">//---------------------------------------------------------</a>
<a name="ln1223">//   createLayout</a>
<a name="ln1224">//    create layout from text</a>
<a name="ln1225">//---------------------------------------------------------</a>
<a name="ln1226"> </a>
<a name="ln1227">void TextBase::createLayout()</a>
<a name="ln1228">      {</a>
<a name="ln1229">      _layout.clear();</a>
<a name="ln1230">      TextCursor cursor((Text*)this);</a>
<a name="ln1231">      cursor.init();</a>
<a name="ln1232"> </a>
<a name="ln1233">      int state = 0;</a>
<a name="ln1234">      QString token;</a>
<a name="ln1235">      QString sym;</a>
<a name="ln1236">      bool symState = false;</a>
<a name="ln1237">      for (int i = 0; i &lt; _text.length(); i++) {</a>
<a name="ln1238">            const QChar&amp; c = _text[i];</a>
<a name="ln1239">            if (state == 0) {</a>
<a name="ln1240">                  if (c == '&lt;') {</a>
<a name="ln1241">                        state = 1;</a>
<a name="ln1242">                        token.clear();</a>
<a name="ln1243">                        }</a>
<a name="ln1244">                  else if (c == '&amp;') {</a>
<a name="ln1245">                        state = 2;</a>
<a name="ln1246">                        token.clear();</a>
<a name="ln1247">                        }</a>
<a name="ln1248">                  else if (c == '\n') {</a>
<a name="ln1249">                        if (rows() &lt;= cursor.row())</a>
<a name="ln1250">                              _layout.append(TextBlock());</a>
<a name="ln1251">                        _layout[cursor.row()].setEol(true);</a>
<a name="ln1252">                        cursor.setRow(cursor.row() + 1);</a>
<a name="ln1253">                        cursor.setColumn(0);</a>
<a name="ln1254">                        if (rows() &lt;= cursor.row())</a>
<a name="ln1255">                              _layout.append(TextBlock());</a>
<a name="ln1256">                        }</a>
<a name="ln1257">                  else {</a>
<a name="ln1258">                        if (symState)</a>
<a name="ln1259">                              sym += c;</a>
<a name="ln1260">                        else {</a>
<a name="ln1261">                              if (c.isHighSurrogate()) {</a>
<a name="ln1262">                                    i++;</a>
<a name="ln1263">                                    Q_ASSERT(i &lt; _text.length());</a>
<a name="ln1264">                                    insert(&amp;cursor, QChar::surrogateToUcs4(c, _text[i]));</a>
<a name="ln1265">                                    }</a>
<a name="ln1266">                              else</a>
<a name="ln1267">                                    insert(&amp;cursor, c.unicode());</a>
<a name="ln1268">                              }</a>
<a name="ln1269">                        }</a>
<a name="ln1270">                  }</a>
<a name="ln1271">            else if (state == 1) {</a>
<a name="ln1272">                  if (c == '&gt;') {</a>
<a name="ln1273">                        bool unstyleFontStyle = false;</a>
<a name="ln1274">                        state = 0;</a>
<a name="ln1275">                        if (token == &quot;b&quot;) {</a>
<a name="ln1276">                              cursor.format()-&gt;setBold(true);</a>
<a name="ln1277">                              unstyleFontStyle = true;</a>
<a name="ln1278">                              }</a>
<a name="ln1279">                        else if (token == &quot;/b&quot;)</a>
<a name="ln1280">                              cursor.format()-&gt;setBold(false);</a>
<a name="ln1281">                        else if (token == &quot;i&quot;) {</a>
<a name="ln1282">                              cursor.format()-&gt;setItalic(true);</a>
<a name="ln1283">                              unstyleFontStyle = true;</a>
<a name="ln1284">                              }</a>
<a name="ln1285">                        else if (token == &quot;/i&quot;)</a>
<a name="ln1286">                              cursor.format()-&gt;setItalic(false);</a>
<a name="ln1287">                        else if (token == &quot;u&quot;) {</a>
<a name="ln1288">                              cursor.format()-&gt;setUnderline(true);</a>
<a name="ln1289">                              unstyleFontStyle = true;</a>
<a name="ln1290">                              }</a>
<a name="ln1291">                        else if (token == &quot;/u&quot;)</a>
<a name="ln1292">                              cursor.format()-&gt;setUnderline(false);</a>
<a name="ln1293">                        else if (token == &quot;sub&quot;)</a>
<a name="ln1294">                              cursor.format()-&gt;setValign(VerticalAlignment::AlignSubScript);</a>
<a name="ln1295">                        else if (token == &quot;/sub&quot;)</a>
<a name="ln1296">                              cursor.format()-&gt;setValign(VerticalAlignment::AlignNormal);</a>
<a name="ln1297">                        else if (token == &quot;sup&quot;)</a>
<a name="ln1298">                              cursor.format()-&gt;setValign(VerticalAlignment::AlignSuperScript);</a>
<a name="ln1299">                        else if (token == &quot;/sup&quot;)</a>
<a name="ln1300">                              cursor.format()-&gt;setValign(VerticalAlignment::AlignNormal);</a>
<a name="ln1301">                        else if (token == &quot;sym&quot;) {</a>
<a name="ln1302">                              symState = true;</a>
<a name="ln1303">                              sym.clear();</a>
<a name="ln1304">                              }</a>
<a name="ln1305">                        else if (token == &quot;/sym&quot;) {</a>
<a name="ln1306">                              symState = false;</a>
<a name="ln1307">                              SymId id = Sym::name2id(sym);</a>
<a name="ln1308">                              if (id != SymId::noSym) {</a>
<a name="ln1309">                                    CharFormat fmt = *cursor.format();  // save format</a>
<a name="ln1310">                                    // uint code = score()-&gt;scoreFont()-&gt;sym(id).code();</a>
<a name="ln1311">                                    uint code = ScoreFont::fallbackFont()-&gt;sym(id).code();</a>
<a name="ln1312">                                    cursor.format()-&gt;setFontFamily(&quot;ScoreText&quot;);</a>
<a name="ln1313">                                    cursor.format()-&gt;setBold(false);</a>
<a name="ln1314">                                    cursor.format()-&gt;setItalic(false);</a>
<a name="ln1315">                                    insert(&amp;cursor, code);</a>
<a name="ln1316">                                    cursor.setFormat(fmt);  // restore format</a>
<a name="ln1317">                                    }</a>
<a name="ln1318">                              else {</a>
<a name="ln1319">                                    qDebug(&quot;unknown symbol &lt;%s&gt;&quot;, qPrintable(sym));</a>
<a name="ln1320">                                    }</a>
<a name="ln1321">                              }</a>
<a name="ln1322">                        else if (token.startsWith(&quot;font &quot;)) {</a>
<a name="ln1323">                              token = token.mid(5);</a>
<a name="ln1324">                              if (token.startsWith(&quot;size=\&quot;&quot;)) {</a>
<a name="ln1325">                                    cursor.format()-&gt;setFontSize(parseNumProperty(token.mid(6)));</a>
<a name="ln1326">                                    setPropertyFlags(Pid::FONT_SIZE, PropertyFlags::UNSTYLED);</a>
<a name="ln1327">                                    }</a>
<a name="ln1328">                              else if (token.startsWith(&quot;face=\&quot;&quot;)) {</a>
<a name="ln1329">                                    QString face = parseStringProperty(token.mid(6));</a>
<a name="ln1330">                                    face = unEscape(face);</a>
<a name="ln1331">                                    cursor.format()-&gt;setFontFamily(face);</a>
<a name="ln1332">                                    setPropertyFlags(Pid::FONT_FACE, PropertyFlags::UNSTYLED);</a>
<a name="ln1333">                                    }</a>
<a name="ln1334">                              else</a>
<a name="ln1335">                                    qDebug(&quot;cannot parse html property &lt;%s&gt; in text &lt;%s&gt;&quot;,</a>
<a name="ln1336">                                       qPrintable(token), qPrintable(_text));</a>
<a name="ln1337">                              }</a>
<a name="ln1338">                        if (unstyleFontStyle)</a>
<a name="ln1339">                              setPropertyFlags(Pid::FONT_STYLE, PropertyFlags::UNSTYLED);</a>
<a name="ln1340">                        }</a>
<a name="ln1341">                  else</a>
<a name="ln1342">                        token += c;</a>
<a name="ln1343">                  }</a>
<a name="ln1344">            else if (state == 2) {</a>
<a name="ln1345">                  if (c == ';') {</a>
<a name="ln1346">                        state = 0;</a>
<a name="ln1347">                        if (token == &quot;lt&quot;)</a>
<a name="ln1348">                              insert(&amp;cursor, '&lt;');</a>
<a name="ln1349">                        else if (token == &quot;gt&quot;)</a>
<a name="ln1350">                              insert(&amp;cursor, '&gt;');</a>
<a name="ln1351">                        else if (token == &quot;amp&quot;)</a>
<a name="ln1352">                              insert(&amp;cursor, '&amp;');</a>
<a name="ln1353">                        else if (token == &quot;quot&quot;)</a>
<a name="ln1354">                              insert(&amp;cursor, '&quot;');</a>
<a name="ln1355">                        else {</a>
<a name="ln1356">                              // TODO insert(&amp;cursor, Sym::name2id(token));</a>
<a name="ln1357">                              }</a>
<a name="ln1358">                        }</a>
<a name="ln1359">                  else</a>
<a name="ln1360">                        token += c;</a>
<a name="ln1361">                  }</a>
<a name="ln1362">            }</a>
<a name="ln1363">      if (_layout.empty())</a>
<a name="ln1364">            _layout.append(TextBlock());</a>
<a name="ln1365">      layoutInvalid = false;</a>
<a name="ln1366">      }</a>
<a name="ln1367"> </a>
<a name="ln1368">//---------------------------------------------------------</a>
<a name="ln1369">//   layout</a>
<a name="ln1370">//---------------------------------------------------------</a>
<a name="ln1371"> </a>
<a name="ln1372">void TextBase::layout()</a>
<a name="ln1373">      {</a>
<a name="ln1374">      setPos(QPointF());</a>
<a name="ln1375">      if (!parent())</a>
<a name="ln1376">            setOffset(0.0, 0.0);</a>
<a name="ln1377">//      else if (isStyled(Pid::OFFSET))                                   // TODO: should be set already</a>
<a name="ln1378">//            setOffset(propertyDefault(Pid::OFFSET).toPointF());</a>
<a name="ln1379">      if (placeBelow())</a>
<a name="ln1380">            rypos() = staff() ? staff()-&gt;height() : 0.0;</a>
<a name="ln1381">      layout1();</a>
<a name="ln1382">      }</a>
<a name="ln1383"> </a>
<a name="ln1384">//---------------------------------------------------------</a>
<a name="ln1385">//   layout1</a>
<a name="ln1386">//---------------------------------------------------------</a>
<a name="ln1387"> </a>
<a name="ln1388">void TextBase::layout1()</a>
<a name="ln1389">      {</a>
<a name="ln1390">      if (layoutInvalid)</a>
<a name="ln1391">            createLayout();</a>
<a name="ln1392">      if (_layout.empty())</a>
<a name="ln1393">            _layout.append(TextBlock());</a>
<a name="ln1394">      QRectF bb;</a>
<a name="ln1395">      qreal y = 0;</a>
<a name="ln1396">      for (int i = 0; i &lt; rows(); ++i) {</a>
<a name="ln1397">            TextBlock* t = &amp;_layout[i];</a>
<a name="ln1398">            t-&gt;layout(this);</a>
<a name="ln1399">            const QRectF* r = &amp;t-&gt;boundingRect();</a>
<a name="ln1400"> </a>
<a name="ln1401">            if (r-&gt;height() == 0)</a>
<a name="ln1402">                  r = &amp;_layout[i-i].boundingRect();</a>
<a name="ln1403">            y += t-&gt;lineSpacing();</a>
<a name="ln1404">            t-&gt;setY(y);</a>
<a name="ln1405">            bb |= r-&gt;translated(0.0, y);</a>
<a name="ln1406">            }</a>
<a name="ln1407">      qreal yoff = 0;</a>
<a name="ln1408">      qreal h    = 0;</a>
<a name="ln1409">      if (parent()) {</a>
<a name="ln1410">            if (layoutToParentWidth()) {</a>
<a name="ln1411">                  if (parent()-&gt;isTBox()) {</a>
<a name="ln1412">                        // hack: vertical alignment is always TOP</a>
<a name="ln1413">                        _align = Align(((char)_align) &amp; ((char)Align::HMASK)) | Align::TOP;</a>
<a name="ln1414">                        }</a>
<a name="ln1415">                  else if (parent()-&gt;isBox()) {</a>
<a name="ln1416">                        // consider inner margins of frame</a>
<a name="ln1417">                        Box* b = toBox(parent());</a>
<a name="ln1418">                        yoff = b-&gt;topMargin()  * DPMM;</a>
<a name="ln1419">                        h  = b-&gt;height() - yoff - b-&gt;bottomMargin() * DPMM;</a>
<a name="ln1420">                        }</a>
<a name="ln1421">                  else if (parent()-&gt;isPage()) {</a>
<a name="ln1422">                        Page* p = toPage(parent());</a>
<a name="ln1423">                        h = p-&gt;height() - p-&gt;tm() - p-&gt;bm();</a>
<a name="ln1424">                        yoff = p-&gt;tm();</a>
<a name="ln1425">                        }</a>
<a name="ln1426">                  else if (parent()-&gt;isMeasure())</a>
<a name="ln1427">                        ;</a>
<a name="ln1428">                  else</a>
<a name="ln1429">                        h  = parent()-&gt;height();</a>
<a name="ln1430">                  }</a>
<a name="ln1431">            }</a>
<a name="ln1432">      else</a>
<a name="ln1433">            setPos(QPointF());</a>
<a name="ln1434"> </a>
<a name="ln1435">      if (align() &amp; Align::BOTTOM)</a>
<a name="ln1436">            yoff += h - bb.bottom();</a>
<a name="ln1437">      else if (align() &amp; Align::VCENTER) {</a>
<a name="ln1438">            yoff +=  (h - (bb.top() + bb.bottom())) * .5;</a>
<a name="ln1439">            }</a>
<a name="ln1440">      else if (align() &amp; Align::BASELINE)</a>
<a name="ln1441">            yoff += h * .5 - _layout.front().lineSpacing();</a>
<a name="ln1442">      else</a>
<a name="ln1443">            yoff += -bb.top();</a>
<a name="ln1444"> </a>
<a name="ln1445">      for (TextBlock&amp; t : _layout)</a>
<a name="ln1446">            t.setY(t.y() + yoff);</a>
<a name="ln1447"> </a>
<a name="ln1448">      bb.translate(0.0, yoff);</a>
<a name="ln1449"> </a>
<a name="ln1450">      setbbox(bb);</a>
<a name="ln1451">      if (hasFrame())</a>
<a name="ln1452">            layoutFrame();</a>
<a name="ln1453">      score()-&gt;addRefresh(canvasBoundingRect());</a>
<a name="ln1454">      }</a>
<a name="ln1455"> </a>
<a name="ln1456">//---------------------------------------------------------</a>
<a name="ln1457">//   layoutFrame</a>
<a name="ln1458">//---------------------------------------------------------</a>
<a name="ln1459"> </a>
<a name="ln1460">void TextBase::layoutFrame()</a>
<a name="ln1461">      {</a>
<a name="ln1462">//      if (empty()) {    // or bbox.width() &lt;= 1.0</a>
<a name="ln1463">      if (bbox().width() &lt;= 1.0 || bbox().height() &lt; 1.0) {    // or bbox.width() &lt;= 1.0</a>
<a name="ln1464">            // this does not work for Harmony:</a>
<a name="ln1465">            QFontMetricsF fm = QFontMetricsF(font(), MScore::paintDevice());</a>
<a name="ln1466">            qreal ch = fm.ascent();</a>
<a name="ln1467">            qreal cw = fm.width('n');</a>
<a name="ln1468">            frame = QRectF(0.0, -ch, cw, ch);</a>
<a name="ln1469">            }</a>
<a name="ln1470">      else</a>
<a name="ln1471">            frame = bbox();</a>
<a name="ln1472"> </a>
<a name="ln1473">      if (square()) {</a>
<a name="ln1474">#if 0</a>
<a name="ln1475">            // &quot;real&quot; square</a>
<a name="ln1476">            if (frame.width() &gt; frame.height()) {</a>
<a name="ln1477">                  qreal w = frame.width() - frame.height();</a>
<a name="ln1478">                  frame.adjust(0.0, -w * .5, 0.0, w * .5);</a>
<a name="ln1479">                  }</a>
<a name="ln1480">            else {</a>
<a name="ln1481">                  qreal w = frame.height() - frame.width();</a>
<a name="ln1482">                  frame.adjust(-w * .5, 0.0, w * .5, 0.0);</a>
<a name="ln1483">                  }</a>
<a name="ln1484">#else</a>
<a name="ln1485">            // make sure width &gt;= height</a>
<a name="ln1486">            if (frame.height() &gt; frame.width()) {</a>
<a name="ln1487">                  qreal w = frame.height() - frame.width();</a>
<a name="ln1488">                  frame.adjust(-w * .5, 0.0, w * .5, 0.0);</a>
<a name="ln1489">                  }</a>
<a name="ln1490">#endif</a>
<a name="ln1491">            }</a>
<a name="ln1492">      else if (circle()) {</a>
<a name="ln1493">            if (frame.width() &gt; frame.height()) {</a>
<a name="ln1494">                  frame.setY(frame.y() + (frame.width() - frame.height()) * -.5);</a>
<a name="ln1495">                  frame.setHeight(frame.width());</a>
<a name="ln1496">                  }</a>
<a name="ln1497">            else {</a>
<a name="ln1498">                  frame.setX(frame.x() + (frame.height() - frame.width()) * -.5);</a>
<a name="ln1499">                  frame.setWidth(frame.height());</a>
<a name="ln1500">                  }</a>
<a name="ln1501">            }</a>
<a name="ln1502">      qreal _spatium = spatium();</a>
<a name="ln1503">      qreal w = (paddingWidth() + frameWidth() * .5f).val() * _spatium;</a>
<a name="ln1504">      frame.adjust(-w, -w, w, w);</a>
<a name="ln1505">      w = frameWidth().val() * _spatium;</a>
<a name="ln1506">      setbbox(frame.adjusted(-w, -w, w, w));</a>
<a name="ln1507">      }</a>
<a name="ln1508"> </a>
<a name="ln1509">//---------------------------------------------------------</a>
<a name="ln1510">//   lineSpacing</a>
<a name="ln1511">//---------------------------------------------------------</a>
<a name="ln1512"> </a>
<a name="ln1513">qreal TextBase::lineSpacing() const</a>
<a name="ln1514">      {</a>
<a name="ln1515">      return fontMetrics().lineSpacing() * MScore::pixelRatio;</a>
<a name="ln1516">      }</a>
<a name="ln1517"> </a>
<a name="ln1518">//---------------------------------------------------------</a>
<a name="ln1519">//   lineHeight</a>
<a name="ln1520">//---------------------------------------------------------</a>
<a name="ln1521"> </a>
<a name="ln1522">qreal TextBase::lineHeight() const</a>
<a name="ln1523">      {</a>
<a name="ln1524">      return fontMetrics().height();</a>
<a name="ln1525">      }</a>
<a name="ln1526"> </a>
<a name="ln1527">//---------------------------------------------------------</a>
<a name="ln1528">//   baseLine</a>
<a name="ln1529">//---------------------------------------------------------</a>
<a name="ln1530"> </a>
<a name="ln1531">qreal TextBase::baseLine() const</a>
<a name="ln1532">      {</a>
<a name="ln1533">      return fontMetrics().ascent();</a>
<a name="ln1534">      }</a>
<a name="ln1535"> </a>
<a name="ln1536">//---------------------------------------------------------</a>
<a name="ln1537">//   XmlNesting</a>
<a name="ln1538">//---------------------------------------------------------</a>
<a name="ln1539"> </a>
<a name="ln1540">class XmlNesting : public QStack&lt;QString&gt; {</a>
<a name="ln1541">      QString* _s;</a>
<a name="ln1542"> </a>
<a name="ln1543">   public:</a>
<a name="ln1544">      XmlNesting(QString* s) { _s = s; }</a>
<a name="ln1545">      void pushToken(const QString&amp; t) {</a>
<a name="ln1546">            *_s += &quot;&lt;&quot;;</a>
<a name="ln1547">            *_s += t;</a>
<a name="ln1548">            *_s += &quot;&gt;&quot;;</a>
<a name="ln1549">            push(t);</a>
<a name="ln1550">            }</a>
<a name="ln1551">      void pushB() { pushToken(&quot;b&quot;); }</a>
<a name="ln1552">      void pushI() { pushToken(&quot;i&quot;); }</a>
<a name="ln1553">      void pushU() { pushToken(&quot;u&quot;); }</a>
<a name="ln1554"> </a>
<a name="ln1555">      QString popToken() {</a>
<a name="ln1556">            QString s = pop();</a>
<a name="ln1557">            *_s += &quot;&lt;/&quot;;</a>
<a name="ln1558">            *_s += s;</a>
<a name="ln1559">            *_s += &quot;&gt;&quot;;</a>
<a name="ln1560">            return s;</a>
<a name="ln1561">            }</a>
<a name="ln1562">      void popToken(const char* t) {</a>
<a name="ln1563">            QStringList ps;</a>
<a name="ln1564">            for (;;) {</a>
<a name="ln1565">                  QString s = popToken();</a>
<a name="ln1566">                  if (s == t)</a>
<a name="ln1567">                        break;</a>
<a name="ln1568">                  ps += s;</a>
<a name="ln1569">                  }</a>
<a name="ln1570">            for (const QString&amp; s : ps)</a>
<a name="ln1571">                  pushToken(s);</a>
<a name="ln1572">            }</a>
<a name="ln1573">      void popB() { popToken(&quot;b&quot;); }</a>
<a name="ln1574">      void popI() { popToken(&quot;i&quot;); }</a>
<a name="ln1575">      void popU() { popToken(&quot;u&quot;); }</a>
<a name="ln1576">      };</a>
<a name="ln1577"> </a>
<a name="ln1578">//---------------------------------------------------------</a>
<a name="ln1579">//   genText</a>
<a name="ln1580">//---------------------------------------------------------</a>
<a name="ln1581"> </a>
<a name="ln1582">void TextBase::genText() const</a>
<a name="ln1583">      {</a>
<a name="ln1584">      _text.clear();</a>
<a name="ln1585">      bool bold_      = false;</a>
<a name="ln1586">      bool italic_    = false;</a>
<a name="ln1587">      bool underline_ = false;</a>
<a name="ln1588"> </a>
<a name="ln1589">      for (const TextBlock&amp; block : _layout) {</a>
<a name="ln1590">            for (const TextFragment&amp; f : block.fragments()) {</a>
<a name="ln1591">                  if (!f.format.bold() &amp;&amp; bold())</a>
<a name="ln1592">                        bold_ = true;</a>
<a name="ln1593">                  if (!f.format.italic() &amp;&amp; italic())</a>
<a name="ln1594">                        italic_ = true;</a>
<a name="ln1595">                  if (!f.format.underline() &amp;&amp; underline())</a>
<a name="ln1596">                        underline_ = true;</a>
<a name="ln1597">                  }</a>
<a name="ln1598">            }</a>
<a name="ln1599">      CharFormat fmt;</a>
<a name="ln1600">      fmt.setFontFamily(family());</a>
<a name="ln1601">      fmt.setFontSize(size());</a>
<a name="ln1602">      fmt.setStyle(fontStyle());</a>
<a name="ln1603">      fmt.setPreedit(false);</a>
<a name="ln1604">      fmt.setValign(VerticalAlignment::AlignNormal);</a>
<a name="ln1605"> </a>
<a name="ln1606">      XmlNesting xmlNesting(&amp;_text);</a>
<a name="ln1607">      if (bold_)</a>
<a name="ln1608">            xmlNesting.pushB();</a>
<a name="ln1609">      if (italic_)</a>
<a name="ln1610">            xmlNesting.pushI();</a>
<a name="ln1611">      if (underline_)</a>
<a name="ln1612">            xmlNesting.pushU();</a>
<a name="ln1613"> </a>
<a name="ln1614">      for (const TextBlock&amp; block : _layout) {</a>
<a name="ln1615">            for (const TextFragment&amp; f : block.fragments()) {</a>
<a name="ln1616">                  if (f.text.isEmpty())                     // skip empty fragments, not to</a>
<a name="ln1617">                        continue;                           // insert extra HTML formatting</a>
<a name="ln1618">                  const CharFormat&amp; format = f.format;</a>
<a name="ln1619">                  if (fmt.bold() != format.bold()) {</a>
<a name="ln1620">                        if (format.bold())</a>
<a name="ln1621">                              xmlNesting.pushB();</a>
<a name="ln1622">                        else</a>
<a name="ln1623">                              xmlNesting.popB();</a>
<a name="ln1624">                        }</a>
<a name="ln1625">                  if (fmt.italic() != format.italic()) {</a>
<a name="ln1626">                        if (format.italic())</a>
<a name="ln1627">                              xmlNesting.pushI();</a>
<a name="ln1628">                        else</a>
<a name="ln1629">                              xmlNesting.popI();</a>
<a name="ln1630">                        }</a>
<a name="ln1631">                  if (fmt.underline() != format.underline()) {</a>
<a name="ln1632">                        if (format.underline())</a>
<a name="ln1633">                              xmlNesting.pushU();</a>
<a name="ln1634">                        else</a>
<a name="ln1635">                              xmlNesting.popU();</a>
<a name="ln1636">                        }</a>
<a name="ln1637"> </a>
<a name="ln1638">                  if (format.fontSize() != fmt.fontSize())</a>
<a name="ln1639">                        _text += QString(&quot;&lt;font size=\&quot;%1\&quot;/&gt;&quot;).arg(format.fontSize());</a>
<a name="ln1640">                  if (format.fontFamily() != fmt.fontFamily())</a>
<a name="ln1641">                        _text += QString(&quot;&lt;font face=\&quot;%1\&quot;/&gt;&quot;).arg(TextBase::escape(format.fontFamily()));</a>
<a name="ln1642"> </a>
<a name="ln1643">                  VerticalAlignment va = format.valign();</a>
<a name="ln1644">                  VerticalAlignment cva = fmt.valign();</a>
<a name="ln1645">                  if (cva != va) {</a>
<a name="ln1646">                        switch (va) {</a>
<a name="ln1647">                              case VerticalAlignment::AlignNormal:</a>
<a name="ln1648">                                    xmlNesting.popToken(cva == VerticalAlignment::AlignSuperScript ? &quot;sup&quot; : &quot;sub&quot;);</a>
<a name="ln1649">                                    break;</a>
<a name="ln1650">                              case VerticalAlignment::AlignSuperScript:</a>
<a name="ln1651">                                    xmlNesting.pushToken(&quot;sup&quot;);</a>
<a name="ln1652">                                    break;</a>
<a name="ln1653">                              case VerticalAlignment::AlignSubScript:</a>
<a name="ln1654">                                    xmlNesting.pushToken(&quot;sub&quot;);</a>
<a name="ln1655">                                    break;</a>
<a name="ln1656">                              }</a>
<a name="ln1657">                        }</a>
<a name="ln1658">                  _text += XmlWriter::xmlString(f.text);</a>
<a name="ln1659">                  fmt = format;</a>
<a name="ln1660">                  }</a>
<a name="ln1661">            if (block.eol())</a>
<a name="ln1662">                  _text += QChar::LineFeed;</a>
<a name="ln1663">            }</a>
<a name="ln1664">      while (!xmlNesting.empty())</a>
<a name="ln1665">            xmlNesting.popToken();</a>
<a name="ln1666">      textInvalid = false;</a>
<a name="ln1667">      }</a>
<a name="ln1668"> </a>
<a name="ln1669">//---------------------------------------------------------</a>
<a name="ln1670">//   selectAll</a>
<a name="ln1671">//---------------------------------------------------------</a>
<a name="ln1672"> </a>
<a name="ln1673">void TextBase::selectAll(TextCursor* _cursor)</a>
<a name="ln1674">      {</a>
<a name="ln1675">      _cursor-&gt;setSelectLine(0);</a>
<a name="ln1676">      _cursor-&gt;setSelectColumn(0);</a>
<a name="ln1677">      _cursor-&gt;setRow(rows() - 1);</a>
<a name="ln1678">      _cursor-&gt;setColumn(_cursor-&gt;curLine().columns());</a>
<a name="ln1679">      }</a>
<a name="ln1680"> </a>
<a name="ln1681">//---------------------------------------------------------</a>
<a name="ln1682">//   multiClickSelect</a>
<a name="ln1683">//    for double and triple clicks</a>
<a name="ln1684">//---------------------------------------------------------</a>
<a name="ln1685"> </a>
<a name="ln1686">void TextBase::multiClickSelect(EditData&amp; editData, MultiClick clicks)</a>
<a name="ln1687">      {</a>
<a name="ln1688">      switch (clicks) {</a>
<a name="ln1689">            case MultiClick::Double:</a>
<a name="ln1690">                  cursor(editData)-&gt;doubleClickSelect();</a>
<a name="ln1691">                  break;</a>
<a name="ln1692">            case MultiClick::Triple:</a>
<a name="ln1693">                  selectAll(cursor(editData));</a>
<a name="ln1694">                  break;</a>
<a name="ln1695">            }</a>
<a name="ln1696">      }</a>
<a name="ln1697"> </a>
<a name="ln1698">//---------------------------------------------------------</a>
<a name="ln1699">//   write</a>
<a name="ln1700">//---------------------------------------------------------</a>
<a name="ln1701"> </a>
<a name="ln1702">void TextBase::write(XmlWriter&amp; xml) const</a>
<a name="ln1703">      {</a>
<a name="ln1704">      if (!xml.canWrite(this))</a>
<a name="ln1705">            return;</a>
<a name="ln1706">      xml.stag(this);</a>
<a name="ln1707">      writeProperties(xml, true, true);</a>
<a name="ln1708">      xml.etag();</a>
<a name="ln1709">      }</a>
<a name="ln1710"> </a>
<a name="ln1711">//---------------------------------------------------------</a>
<a name="ln1712">//   read</a>
<a name="ln1713">//---------------------------------------------------------</a>
<a name="ln1714"> </a>
<a name="ln1715">void TextBase::read(XmlReader&amp; e)</a>
<a name="ln1716">      {</a>
<a name="ln1717">      while (e.readNextStartElement()) {</a>
<a name="ln1718">            if (!readProperties(e))</a>
<a name="ln1719">                  e.unknown();</a>
<a name="ln1720">            }</a>
<a name="ln1721">      }</a>
<a name="ln1722"> </a>
<a name="ln1723">//---------------------------------------------------------</a>
<a name="ln1724">//   writeProperties</a>
<a name="ln1725">//---------------------------------------------------------</a>
<a name="ln1726"> </a>
<a name="ln1727">void TextBase::writeProperties(XmlWriter&amp; xml, bool writeText, bool /*writeStyle*/) const</a>
<a name="ln1728">      {</a>
<a name="ln1729">      Element::writeProperties(xml);</a>
<a name="ln1730">      writeProperty(xml, Pid::SUB_STYLE);</a>
<a name="ln1731"> </a>
<a name="ln1732">      for (const StyledProperty&amp; spp : *_elementStyle) {</a>
<a name="ln1733">            if (!isStyled(spp.pid))</a>
<a name="ln1734">                  writeProperty(xml, spp.pid);</a>
<a name="ln1735">            }</a>
<a name="ln1736">      for (const StyledProperty&amp; spp : *textStyle(tid())) {</a>
<a name="ln1737">            if (!isStyled(spp.pid))</a>
<a name="ln1738">                  writeProperty(xml, spp.pid);</a>
<a name="ln1739">            }</a>
<a name="ln1740">      if (writeText)</a>
<a name="ln1741">            xml.writeXml(&quot;text&quot;, xmlText());</a>
<a name="ln1742">      }</a>
<a name="ln1743"> </a>
<a name="ln1744">static constexpr std::array&lt;Pid, 18&gt; pids { {</a>
<a name="ln1745">      Pid::SUB_STYLE,</a>
<a name="ln1746">      Pid::FONT_FACE,</a>
<a name="ln1747">      Pid::FONT_SIZE,</a>
<a name="ln1748">      Pid::FONT_STYLE,</a>
<a name="ln1749">      Pid::COLOR,</a>
<a name="ln1750">      Pid::FRAME_TYPE,</a>
<a name="ln1751">      Pid::FRAME_WIDTH,</a>
<a name="ln1752">      Pid::FRAME_PADDING,</a>
<a name="ln1753">      Pid::FRAME_ROUND,</a>
<a name="ln1754">      Pid::FRAME_FG_COLOR,</a>
<a name="ln1755">      Pid::FRAME_BG_COLOR,</a>
<a name="ln1756">      Pid::ALIGN,</a>
<a name="ln1757">      } };</a>
<a name="ln1758"> </a>
<a name="ln1759">//---------------------------------------------------------</a>
<a name="ln1760">//   readProperties</a>
<a name="ln1761">//---------------------------------------------------------</a>
<a name="ln1762"> </a>
<a name="ln1763">bool TextBase::readProperties(XmlReader&amp; e)</a>
<a name="ln1764">      {</a>
<a name="ln1765">      const QStringRef&amp; tag(e.name());</a>
<a name="ln1766">      for (Pid i :pids) {</a>
<a name="ln1767">            if (readProperty(tag, e, i))</a>
<a name="ln1768">                  return true;</a>
<a name="ln1769">            }</a>
<a name="ln1770">      if (tag == &quot;text&quot;)</a>
<a name="ln1771">            setXmlText(e.readXml());</a>
<a name="ln1772">      else if (tag == &quot;bold&quot;) {</a>
<a name="ln1773">            bool val = e.readInt();</a>
<a name="ln1774">            if (val)</a>
<a name="ln1775">                  _fontStyle = _fontStyle + FontStyle::Bold;</a>
<a name="ln1776">            else</a>
<a name="ln1777">                  _fontStyle = _fontStyle - FontStyle::Bold;</a>
<a name="ln1778">            if (isStyled(Pid::FONT_STYLE))</a>
<a name="ln1779">                  setPropertyFlags(Pid::FONT_STYLE, PropertyFlags::UNSTYLED);</a>
<a name="ln1780">            }</a>
<a name="ln1781">      else if (tag == &quot;italic&quot;) {</a>
<a name="ln1782">            bool val = e.readInt();</a>
<a name="ln1783">            if (val)</a>
<a name="ln1784">                  _fontStyle = _fontStyle + FontStyle::Italic;</a>
<a name="ln1785">            else</a>
<a name="ln1786">                  _fontStyle = _fontStyle - FontStyle::Italic;</a>
<a name="ln1787">            if (isStyled(Pid::FONT_STYLE))</a>
<a name="ln1788">                  setPropertyFlags(Pid::FONT_STYLE, PropertyFlags::UNSTYLED);</a>
<a name="ln1789">            }</a>
<a name="ln1790">      else if (tag == &quot;underline&quot;) {</a>
<a name="ln1791">            bool val = e.readInt();</a>
<a name="ln1792">            if (val)</a>
<a name="ln1793">                  _fontStyle = _fontStyle + FontStyle::Underline;</a>
<a name="ln1794">            else</a>
<a name="ln1795">                  _fontStyle = _fontStyle - FontStyle::Underline;</a>
<a name="ln1796">            if (isStyled(Pid::FONT_STYLE))</a>
<a name="ln1797">                  setPropertyFlags(Pid::FONT_STYLE, PropertyFlags::UNSTYLED);</a>
<a name="ln1798">            }</a>
<a name="ln1799">      else if (!Element::readProperties(e))</a>
<a name="ln1800">            return false;</a>
<a name="ln1801">      return true;</a>
<a name="ln1802">      }</a>
<a name="ln1803"> </a>
<a name="ln1804">//---------------------------------------------------------</a>
<a name="ln1805">//   propertyId</a>
<a name="ln1806">//---------------------------------------------------------</a>
<a name="ln1807"> </a>
<a name="ln1808">Pid TextBase::propertyId(const QStringRef&amp; name) const</a>
<a name="ln1809">      {</a>
<a name="ln1810">      if (name == &quot;text&quot;)</a>
<a name="ln1811">            return Pid::TEXT;</a>
<a name="ln1812">      for (Pid pid : pids) {</a>
<a name="ln1813">            if (propertyName(pid) == name)</a>
<a name="ln1814">                  return pid;</a>
<a name="ln1815">            }</a>
<a name="ln1816">      return Element::propertyId(name);</a>
<a name="ln1817">      }</a>
<a name="ln1818"> </a>
<a name="ln1819">//---------------------------------------------------------</a>
<a name="ln1820">//   pageRectangle</a>
<a name="ln1821">//---------------------------------------------------------</a>
<a name="ln1822"> </a>
<a name="ln1823">QRectF TextBase::pageRectangle() const</a>
<a name="ln1824">      {</a>
<a name="ln1825">      if (parent() &amp;&amp; (parent()-&gt;isHBox() || parent()-&gt;isVBox() || parent()-&gt;isTBox())) {</a>
<a name="ln1826">            Box* box = toBox(parent());</a>
<a name="ln1827">            QRectF r = box-&gt;abbox();</a>
<a name="ln1828">            qreal x = r.x() + box-&gt;leftMargin() * DPMM;</a>
<a name="ln1829">            qreal y = r.y() + box-&gt;topMargin() * DPMM;</a>
<a name="ln1830">            qreal h = r.height() - (box-&gt;topMargin() + box-&gt;bottomMargin()) * DPMM;</a>
<a name="ln1831">            qreal w = r.width()  - (box-&gt;leftMargin() + box-&gt;rightMargin()) * DPMM;</a>
<a name="ln1832"> </a>
<a name="ln1833">            // QSizeF ps = _doc-&gt;pageSize();</a>
<a name="ln1834">            // return QRectF(x, y, ps.width(), ps.height());</a>
<a name="ln1835"> </a>
<a name="ln1836">            return QRectF(x, y, w, h);</a>
<a name="ln1837">            }</a>
<a name="ln1838">      if (parent() &amp;&amp; parent()-&gt;isPage()) {</a>
<a name="ln1839">            Page* box  = toPage(parent());</a>
<a name="ln1840">            QRectF r = box-&gt;abbox();</a>
<a name="ln1841">            qreal x = r.x() + box-&gt;lm();</a>
<a name="ln1842">            qreal y = r.y() + box-&gt;tm();</a>
<a name="ln1843">            qreal h = r.height() - box-&gt;tm() - box-&gt;bm();</a>
<a name="ln1844">            qreal w = r.width()  - box-&gt;lm() - box-&gt;rm();</a>
<a name="ln1845">            return QRectF(x, y, w, h);</a>
<a name="ln1846">            }</a>
<a name="ln1847">      return abbox();</a>
<a name="ln1848">      }</a>
<a name="ln1849"> </a>
<a name="ln1850">//---------------------------------------------------------</a>
<a name="ln1851">//   dragTo</a>
<a name="ln1852">//---------------------------------------------------------</a>
<a name="ln1853"> </a>
<a name="ln1854">void TextBase::dragTo(EditData&amp; ed)</a>
<a name="ln1855">      {</a>
<a name="ln1856">      TextEditData* ted = static_cast&lt;TextEditData*&gt;(ed.getData(this));</a>
<a name="ln1857">      TextCursor* _cursor = &amp;ted-&gt;cursor;</a>
<a name="ln1858">      _cursor-&gt;set(ed.pos, QTextCursor::KeepAnchor);</a>
<a name="ln1859">      score()-&gt;setUpdateAll();</a>
<a name="ln1860">      score()-&gt;update();</a>
<a name="ln1861">      }</a>
<a name="ln1862"> </a>
<a name="ln1863">//---------------------------------------------------------</a>
<a name="ln1864">//   dragAnchor</a>
<a name="ln1865">//---------------------------------------------------------</a>
<a name="ln1866"> </a>
<a name="ln1867">QLineF TextBase::dragAnchor() const</a>
<a name="ln1868">      {</a>
<a name="ln1869">      qreal xp = 0.0;</a>
<a name="ln1870">      for (Element* e = parent(); e; e = e-&gt;parent())</a>
<a name="ln1871">            xp += e-&gt;x();</a>
<a name="ln1872">      qreal yp;</a>
<a name="ln1873">      if (parent()-&gt;isSegment()) {</a>
<a name="ln1874">            System* system = toSegment(parent())-&gt;measure()-&gt;system();</a>
<a name="ln1875">            yp = system-&gt;staffCanvasYpage(staffIdx());</a>
<a name="ln1876">            }</a>
<a name="ln1877">      else</a>
<a name="ln1878">            yp = parent()-&gt;canvasPos().y();</a>
<a name="ln1879">      QPointF p1(xp, yp);</a>
<a name="ln1880">      QPointF p2 = canvasPos();</a>
<a name="ln1881">      if (layoutToParentWidth())</a>
<a name="ln1882">            p2 += bbox().topLeft();</a>
<a name="ln1883">      return QLineF(p1, p2);</a>
<a name="ln1884">      }</a>
<a name="ln1885"> </a>
<a name="ln1886">//---------------------------------------------------------</a>
<a name="ln1887">//   mousePress</a>
<a name="ln1888">//    set text cursor</a>
<a name="ln1889">//---------------------------------------------------------</a>
<a name="ln1890"> </a>
<a name="ln1891">bool TextBase::mousePress(EditData&amp; ed)</a>
<a name="ln1892">      {</a>
<a name="ln1893">      bool shift = ed.modifiers &amp; Qt::ShiftModifier;</a>
<a name="ln1894">      TextEditData* ted = static_cast&lt;TextEditData*&gt;(ed.getData(this));</a>
<a name="ln1895">      if (!ted-&gt;cursor.set(ed.startMove, shift ? QTextCursor::KeepAnchor : QTextCursor::MoveAnchor))</a>
<a name="ln1896">            return false;</a>
<a name="ln1897">      if (ed.buttons == Qt::MidButton)</a>
<a name="ln1898">            paste(ed);</a>
<a name="ln1899">      score()-&gt;setUpdateAll();</a>
<a name="ln1900">      return true;</a>
<a name="ln1901">      }</a>
<a name="ln1902"> </a>
<a name="ln1903">//---------------------------------------------------------</a>
<a name="ln1904">//   layoutEdit</a>
<a name="ln1905">//---------------------------------------------------------</a>
<a name="ln1906"> </a>
<a name="ln1907">void TextBase::layoutEdit()</a>
<a name="ln1908">      {</a>
<a name="ln1909">      layout();</a>
<a name="ln1910">      if (parent() &amp;&amp; parent()-&gt;type() == ElementType::TBOX) {</a>
<a name="ln1911">            TBox* tbox = toTBox(parent());</a>
<a name="ln1912">            tbox-&gt;layout();</a>
<a name="ln1913">            System* system = tbox-&gt;system();</a>
<a name="ln1914">            system-&gt;setHeight(tbox-&gt;height());</a>
<a name="ln1915">            triggerLayout();</a>
<a name="ln1916">            }</a>
<a name="ln1917">      else {</a>
<a name="ln1918">            static const qreal w = 2.0; // 8.0 / view-&gt;matrix().m11();</a>
<a name="ln1919">            score()-&gt;addRefresh(canvasBoundingRect().adjusted(-w, -w, w, w));</a>
<a name="ln1920">            }</a>
<a name="ln1921">      }</a>
<a name="ln1922"> </a>
<a name="ln1923">//---------------------------------------------------------</a>
<a name="ln1924">//   acceptDrop</a>
<a name="ln1925">//---------------------------------------------------------</a>
<a name="ln1926"> </a>
<a name="ln1927">bool TextBase::acceptDrop(EditData&amp; data) const</a>
<a name="ln1928">      {</a>
<a name="ln1929">      // do not accept the drop if this text element is not being edited</a>
<a name="ln1930">      ElementEditData* eed = data.getData(this);</a>
<a name="ln1931">      if (!eed || eed-&gt;type() != EditDataType::TextEditData)</a>
<a name="ln1932">            return false;</a>
<a name="ln1933">      ElementType type = data.dropElement-&gt;type();</a>
<a name="ln1934">      return type == ElementType::SYMBOL || type == ElementType::FSYMBOL;</a>
<a name="ln1935">      }</a>
<a name="ln1936"> </a>
<a name="ln1937">//---------------------------------------------------------</a>
<a name="ln1938">//   setPlainText</a>
<a name="ln1939">//---------------------------------------------------------</a>
<a name="ln1940"> </a>
<a name="ln1941">void TextBase::setPlainText(const QString&amp; s)</a>
<a name="ln1942">      {</a>
<a name="ln1943">      setXmlText(s.toHtmlEscaped());</a>
<a name="ln1944">      }</a>
<a name="ln1945"> </a>
<a name="ln1946">//---------------------------------------------------------</a>
<a name="ln1947">//   setXmlText</a>
<a name="ln1948">//---------------------------------------------------------</a>
<a name="ln1949"> </a>
<a name="ln1950">void TextBase::setXmlText(const QString&amp; s)</a>
<a name="ln1951">      {</a>
<a name="ln1952">      _text = s;</a>
<a name="ln1953">      layoutInvalid = true;</a>
<a name="ln1954">      textInvalid   = false;</a>
<a name="ln1955">      }</a>
<a name="ln1956"> </a>
<a name="ln1957">//---------------------------------------------------------</a>
<a name="ln1958">//   plainText</a>
<a name="ln1959">//    return plain text with symbols</a>
<a name="ln1960">//---------------------------------------------------------</a>
<a name="ln1961"> </a>
<a name="ln1962">QString TextBase::plainText() const</a>
<a name="ln1963">      {</a>
<a name="ln1964">      QString s;</a>
<a name="ln1965"> </a>
<a name="ln1966">      const TextBase* text = this;</a>
<a name="ln1967">      std::unique_ptr&lt;TextBase&gt; tmpText;</a>
<a name="ln1968">      if (layoutInvalid) {</a>
<a name="ln1969">            // Create temporary text object to avoid side effects</a>
<a name="ln1970">            // of createLayout() call.</a>
<a name="ln1971">            tmpText.reset(toTextBase(this-&gt;clone()));</a>
<a name="ln1972">            tmpText-&gt;createLayout();</a>
<a name="ln1973">            text = tmpText.get();</a>
<a name="ln1974">            }</a>
<a name="ln1975"> </a>
<a name="ln1976">      for (const TextBlock&amp; block : text-&gt;_layout) {</a>
<a name="ln1977">            for (const TextFragment&amp; f : block.fragments())</a>
<a name="ln1978">                  s += f.text;</a>
<a name="ln1979">            if (block.eol())</a>
<a name="ln1980">                  s += QChar::LineFeed;</a>
<a name="ln1981">            }</a>
<a name="ln1982">      return s;</a>
<a name="ln1983">      }</a>
<a name="ln1984"> </a>
<a name="ln1985">//---------------------------------------------------------</a>
<a name="ln1986">//   xmlText</a>
<a name="ln1987">//---------------------------------------------------------</a>
<a name="ln1988"> </a>
<a name="ln1989">QString TextBase::xmlText() const</a>
<a name="ln1990">      {</a>
<a name="ln1991">#if 1</a>
<a name="ln1992">      // this is way too expensive</a>
<a name="ln1993">      // what side effects has genText() ?</a>
<a name="ln1994">      // this method is const by design</a>
<a name="ln1995"> </a>
<a name="ln1996">      const TextBase* text = this;</a>
<a name="ln1997">      std::unique_ptr&lt;TextBase&gt; tmpText;</a>
<a name="ln1998">      if (textInvalid) {</a>
<a name="ln1999">            // Create temporary text object to avoid side effects</a>
<a name="ln2000">            // of genText() call.</a>
<a name="ln2001">            tmpText.reset(toTextBase(this-&gt;clone()));</a>
<a name="ln2002">            tmpText-&gt;genText();</a>
<a name="ln2003">            text = tmpText.get();</a>
<a name="ln2004">            }</a>
<a name="ln2005">      return text-&gt;_text;</a>
<a name="ln2006">#else</a>
<a name="ln2007">      if (textInvalid)</a>
<a name="ln2008">            genText();</a>
<a name="ln2009">      return _text;</a>
<a name="ln2010">#endif</a>
<a name="ln2011">      }</a>
<a name="ln2012"> </a>
<a name="ln2013">//---------------------------------------------------------</a>
<a name="ln2014">//   convertFromHtml</a>
<a name="ln2015">//---------------------------------------------------------</a>
<a name="ln2016"> </a>
<a name="ln2017">QString TextBase::convertFromHtml(const QString&amp; ss) const</a>
<a name="ln2018">      {</a>
<a name="ln2019">      QTextDocument doc;</a>
<a name="ln2020">      doc.setHtml(ss);</a>
<a name="ln2021"> </a>
<a name="ln2022">      QString s;</a>
<a name="ln2023">      qreal size_ = size();</a>
<a name="ln2024">      QString family_ = family();</a>
<a name="ln2025">      for (auto b = doc.firstBlock(); b.isValid() ; b = b.next()) {</a>
<a name="ln2026">            if (!s.isEmpty())</a>
<a name="ln2027">                  s += &quot;\n&quot;;</a>
<a name="ln2028">            for (auto it = b.begin(); !it.atEnd(); ++it) {</a>
<a name="ln2029">                  QTextFragment f = it.fragment();</a>
<a name="ln2030">                  if (f.isValid()) {</a>
<a name="ln2031">                        QTextCharFormat tf = f.charFormat();</a>
<a name="ln2032">                        QFont font = tf.font();</a>
<a name="ln2033">                        qreal htmlSize = font.pointSizeF();</a>
<a name="ln2034">                        // html font sizes may have spatium adjustments; need to undo this</a>
<a name="ln2035">                        if (sizeIsSpatiumDependent())</a>
<a name="ln2036">                              htmlSize *= SPATIUM20 / spatium();</a>
<a name="ln2037">                        if (fabs(size_ - htmlSize) &gt; 0.1) {</a>
<a name="ln2038">                              size_ = htmlSize;</a>
<a name="ln2039">                              s += QString(&quot;&lt;font size=\&quot;%1\&quot;/&gt;&quot;).arg(size_);</a>
<a name="ln2040">                              }</a>
<a name="ln2041">                        if (family_ != font.family()) {</a>
<a name="ln2042">                              family_ = font.family();</a>
<a name="ln2043">                              s += QString(&quot;&lt;font face=\&quot;%1\&quot;/&gt;&quot;).arg(family_);</a>
<a name="ln2044">                              }</a>
<a name="ln2045">                        if (font.bold())</a>
<a name="ln2046">                              s += &quot;&lt;b&gt;&quot;;</a>
<a name="ln2047">                        if (font.italic())</a>
<a name="ln2048">                              s += &quot;&lt;i&gt;&quot;;</a>
<a name="ln2049">                        if (font.underline())</a>
<a name="ln2050">                              s += &quot;&lt;u&gt;&quot;;</a>
<a name="ln2051">                        s += f.text().toHtmlEscaped();</a>
<a name="ln2052">                        if (font.underline())</a>
<a name="ln2053">                              s += &quot;&lt;/u&gt;&quot;;</a>
<a name="ln2054">                        if (font.italic())</a>
<a name="ln2055">                              s += &quot;&lt;/i&gt;&quot;;</a>
<a name="ln2056">                        if (font.bold())</a>
<a name="ln2057">                              s += &quot;&lt;/b&gt;&quot;;</a>
<a name="ln2058">                        }</a>
<a name="ln2059">                  }</a>
<a name="ln2060">            }</a>
<a name="ln2061"> </a>
<a name="ln2062">      if (score() &amp;&amp; score()-&gt;mscVersion() &lt;= 114) {</a>
<a name="ln2063">            s.replace(QChar(0xe10e), QString(&quot;&lt;sym&gt;accidentalNatural&lt;/sym&gt;&quot;));  //natural</a>
<a name="ln2064">            s.replace(QChar(0xe10c), QString(&quot;&lt;sym&gt;accidentalSharp&lt;/sym&gt;&quot;));    // sharp</a>
<a name="ln2065">            s.replace(QChar(0xe10d), QString(&quot;&lt;sym&gt;accidentalFlat&lt;/sym&gt;&quot;));     // flat</a>
<a name="ln2066">            s.replace(QChar(0xe104), QString(&quot;&lt;sym&gt;metNoteHalfUp&lt;/sym&gt;&quot;)),      // note2_Sym</a>
<a name="ln2067">            s.replace(QChar(0xe105), QString(&quot;&lt;sym&gt;metNoteQuarterUp&lt;/sym&gt;&quot;));   // note4_Sym</a>
<a name="ln2068">            s.replace(QChar(0xe106), QString(&quot;&lt;sym&gt;metNote8thUp&lt;/sym&gt;&quot;));       // note8_Sym</a>
<a name="ln2069">            s.replace(QChar(0xe107), QString(&quot;&lt;sym&gt;metNote16thUp&lt;/sym&gt;&quot;));      // note16_Sym</a>
<a name="ln2070">            s.replace(QChar(0xe108), QString(&quot;&lt;sym&gt;metNote32ndUp&lt;/sym&gt;&quot;));      // note32_Sym</a>
<a name="ln2071">            s.replace(QChar(0xe109), QString(&quot;&lt;sym&gt;metNote64thUp&lt;/sym&gt;&quot;));      // note64_Sym</a>
<a name="ln2072">            s.replace(QChar(0xe10a), QString(&quot;&lt;sym&gt;metAugmentationDot&lt;/sym&gt;&quot;)); // dot</a>
<a name="ln2073">            s.replace(QChar(0xe10b), QString(&quot;&lt;sym&gt;metAugmentationDot&lt;/sym&gt;&lt;sym&gt;space&lt;/sym&gt;&lt;sym&gt;metAugmentationDot&lt;/sym&gt;&quot;));    // dotdot</a>
<a name="ln2074">            s.replace(QChar(0xe167), QString(&quot;&lt;sym&gt;segno&lt;/sym&gt;&quot;));              // segno</a>
<a name="ln2075">            s.replace(QChar(0xe168), QString(&quot;&lt;sym&gt;coda&lt;/sym&gt;&quot;));               // coda</a>
<a name="ln2076">            s.replace(QChar(0xe169), QString(&quot;&lt;sym&gt;codaSquare&lt;/sym&gt;&quot;));         // varcoda</a>
<a name="ln2077">            }</a>
<a name="ln2078">      return s;</a>
<a name="ln2079">      }</a>
<a name="ln2080"> </a>
<a name="ln2081">//---------------------------------------------------------</a>
<a name="ln2082">//   convertToHtml</a>
<a name="ln2083">//    convert from internal html format to Qt</a>
<a name="ln2084">//---------------------------------------------------------</a>
<a name="ln2085"> </a>
<a name="ln2086">QString TextBase::convertToHtml(const QString&amp; s, const TextStyle&amp; /*st*/)</a>
<a name="ln2087">      {</a>
<a name="ln2088">//TODO      qreal size     = st.size();</a>
<a name="ln2089">//      QString family = st.family();</a>
<a name="ln2090">      qreal size     = 10;</a>
<a name="ln2091">      QString family = &quot;arial&quot;;</a>
<a name="ln2092">      return QString(&quot;&lt;html&gt;&lt;body style=\&quot;font-family:'%1'; font-size:%2pt;\&quot;&gt;%3&lt;/body&gt;&lt;/html&gt;&quot;).arg(family).arg(size).arg(s);</a>
<a name="ln2093">      }</a>
<a name="ln2094"> </a>
<a name="ln2095">//---------------------------------------------------------</a>
<a name="ln2096">//   tagEscape</a>
<a name="ln2097">//---------------------------------------------------------</a>
<a name="ln2098"> </a>
<a name="ln2099">QString TextBase::tagEscape(QString s)</a>
<a name="ln2100">      {</a>
<a name="ln2101">      QStringList tags = { &quot;sym&quot;, &quot;b&quot;, &quot;i&quot;, &quot;u&quot;, &quot;sub&quot;, &quot;sup&quot; };</a>
<a name="ln2102">      for (QString tag : tags) {</a>
<a name="ln2103">            QString openTag = &quot;&lt;&quot; + tag + &quot;&gt;&quot;;</a>
<a name="ln2104">            QString openProxy = &quot;!!&quot; + tag + &quot;!!&quot;;</a>
<a name="ln2105">            QString closeTag = &quot;&lt;/&quot; + tag + &quot;&gt;&quot;;</a>
<a name="ln2106">            QString closeProxy = &quot;!!/&quot; + tag + &quot;!!&quot;;</a>
<a name="ln2107">            s.replace(openTag, openProxy);</a>
<a name="ln2108">            s.replace(closeTag, closeProxy);</a>
<a name="ln2109">            }</a>
<a name="ln2110">      s = XmlWriter::xmlString(s);</a>
<a name="ln2111">      for (QString tag : tags) {</a>
<a name="ln2112">            QString openTag = &quot;&lt;&quot; + tag + &quot;&gt;&quot;;</a>
<a name="ln2113">            QString openProxy = &quot;!!&quot; + tag + &quot;!!&quot;;</a>
<a name="ln2114">            QString closeTag = &quot;&lt;/&quot; + tag + &quot;&gt;&quot;;</a>
<a name="ln2115">            QString closeProxy = &quot;!!/&quot; + tag + &quot;!!&quot;;</a>
<a name="ln2116">            s.replace(openProxy, openTag);</a>
<a name="ln2117">            s.replace(closeProxy, closeTag);</a>
<a name="ln2118">            }</a>
<a name="ln2119">      return s;</a>
<a name="ln2120">      }</a>
<a name="ln2121"> </a>
<a name="ln2122">//---------------------------------------------------------</a>
<a name="ln2123">//   unEscape</a>
<a name="ln2124">//---------------------------------------------------------</a>
<a name="ln2125"> </a>
<a name="ln2126">QString TextBase::unEscape(QString s)</a>
<a name="ln2127">      {</a>
<a name="ln2128">      s.replace(&quot;&amp;lt;&quot;, &quot;&lt;&quot;);</a>
<a name="ln2129">      s.replace(&quot;&amp;gt;&quot;, &quot;&gt;&quot;);</a>
<a name="ln2130">      s.replace(&quot;&amp;amp;&quot;, &quot;&amp;&quot;);</a>
<a name="ln2131">      s.replace(&quot;&amp;quot;&quot;, &quot;\&quot;&quot;);</a>
<a name="ln2132">      return s;</a>
<a name="ln2133">      }</a>
<a name="ln2134"> </a>
<a name="ln2135">//---------------------------------------------------------</a>
<a name="ln2136">//   escape</a>
<a name="ln2137">//---------------------------------------------------------</a>
<a name="ln2138"> </a>
<a name="ln2139">QString TextBase::escape(QString s)</a>
<a name="ln2140">      {</a>
<a name="ln2141">      s.replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;);</a>
<a name="ln2142">      s.replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;);</a>
<a name="ln2143">      s.replace(&quot;&amp;&quot;, &quot;&amp;amp;&quot;);</a>
<a name="ln2144">      s.replace(&quot;\&quot;&quot;, &quot;&amp;quot;&quot;);</a>
<a name="ln2145">      return s;</a>
<a name="ln2146">      }</a>
<a name="ln2147"> </a>
<a name="ln2148">//---------------------------------------------------------</a>
<a name="ln2149">//   accessibleInfo</a>
<a name="ln2150">//---------------------------------------------------------</a>
<a name="ln2151"> </a>
<a name="ln2152">QString TextBase::accessibleInfo() const</a>
<a name="ln2153">      {</a>
<a name="ln2154">      QString rez;</a>
<a name="ln2155">      switch (tid()) {</a>
<a name="ln2156">            case Tid::TITLE:</a>
<a name="ln2157">            case Tid::SUBTITLE:</a>
<a name="ln2158">            case Tid::COMPOSER:</a>
<a name="ln2159">            case Tid::POET:</a>
<a name="ln2160">            case Tid::TRANSLATOR:</a>
<a name="ln2161">            case Tid::MEASURE_NUMBER:</a>
<a name="ln2162">                  rez = score() ? score()-&gt;getTextStyleUserName(tid()) : textStyleUserName(tid());</a>
<a name="ln2163">                  break;</a>
<a name="ln2164">            default:</a>
<a name="ln2165">                  rez = Element::accessibleInfo();</a>
<a name="ln2166">                  break;</a>
<a name="ln2167">            }</a>
<a name="ln2168">      QString s = plainText().simplified();</a>
<a name="ln2169">      if (s.length() &gt; 20) {</a>
<a name="ln2170">            s.truncate(20);</a>
<a name="ln2171">            s += &quot;…&quot;;</a>
<a name="ln2172">            }</a>
<a name="ln2173">      return  QString(&quot;%1: %2&quot;).arg(rez).arg(s);</a>
<a name="ln2174">      }</a>
<a name="ln2175"> </a>
<a name="ln2176">//---------------------------------------------------------</a>
<a name="ln2177">//   screenReaderInfo</a>
<a name="ln2178">//---------------------------------------------------------</a>
<a name="ln2179"> </a>
<a name="ln2180">QString TextBase::screenReaderInfo() const</a>
<a name="ln2181">      {</a>
<a name="ln2182">      QString rez;</a>
<a name="ln2183"> </a>
<a name="ln2184">      switch (tid()) {</a>
<a name="ln2185">            case Tid::TITLE:</a>
<a name="ln2186">            case Tid::SUBTITLE:</a>
<a name="ln2187">            case Tid::COMPOSER:</a>
<a name="ln2188">            case Tid::POET:</a>
<a name="ln2189">            case Tid::TRANSLATOR:</a>
<a name="ln2190">            case Tid::MEASURE_NUMBER:</a>
<a name="ln2191">                  rez = score() ? score()-&gt;getTextStyleUserName(tid()) : textStyleUserName(tid());</a>
<a name="ln2192">                  break;</a>
<a name="ln2193">            default:</a>
<a name="ln2194">                  rez = Element::accessibleInfo();</a>
<a name="ln2195">                  break;</a>
<a name="ln2196">            }</a>
<a name="ln2197">      QString s = plainText().simplified();</a>
<a name="ln2198">      return  QString(&quot;%1: %2&quot;).arg(rez).arg(s);</a>
<a name="ln2199">      }</a>
<a name="ln2200"> </a>
<a name="ln2201">//---------------------------------------------------------</a>
<a name="ln2202">//   subtype</a>
<a name="ln2203">//---------------------------------------------------------</a>
<a name="ln2204"> </a>
<a name="ln2205">int TextBase::subtype() const</a>
<a name="ln2206">      {</a>
<a name="ln2207">      return int(tid());</a>
<a name="ln2208">      }</a>
<a name="ln2209"> </a>
<a name="ln2210">//---------------------------------------------------------</a>
<a name="ln2211">//   subtypeName</a>
<a name="ln2212">//---------------------------------------------------------</a>
<a name="ln2213"> </a>
<a name="ln2214">QString TextBase::subtypeName() const</a>
<a name="ln2215">      {</a>
<a name="ln2216">      return score() ? score()-&gt;getTextStyleUserName(tid()) : textStyleUserName(tid());</a>
<a name="ln2217">      }</a>
<a name="ln2218"> </a>
<a name="ln2219">//---------------------------------------------------------</a>
<a name="ln2220">//   fragmentList</a>
<a name="ln2221">//---------------------------------------------------------</a>
<a name="ln2222"> </a>
<a name="ln2223">/*</a>
<a name="ln2224"> Return the text as a single list of TextFragment</a>
<a name="ln2225"> Used by the MusicXML formatted export to avoid parsing the xml text format</a>
<a name="ln2226"> */</a>
<a name="ln2227"> </a>
<a name="ln2228">QList&lt;TextFragment&gt; TextBase::fragmentList() const</a>
<a name="ln2229">      {</a>
<a name="ln2230">      QList&lt;TextFragment&gt; res;</a>
<a name="ln2231">      for (const TextBlock&amp; block : _layout) {</a>
<a name="ln2232">            for (const TextFragment&amp; f : block.fragments()) {</a>
<a name="ln2233">                  /* TODO TBD</a>
<a name="ln2234">                  if (f.text.empty())                     // skip empty fragments, not to</a>
<a name="ln2235">                        continue;                           // insert extra HTML formatting</a>
<a name="ln2236">                   */</a>
<a name="ln2237">                  res.append(f);</a>
<a name="ln2238">                  if (block.eol()) {</a>
<a name="ln2239">                        // simply append a newline</a>
<a name="ln2240">                        res.last().text += &quot;\n&quot;;</a>
<a name="ln2241">                        }</a>
<a name="ln2242">                  }</a>
<a name="ln2243">            }</a>
<a name="ln2244">      return res;</a>
<a name="ln2245">      }</a>
<a name="ln2246"> </a>
<a name="ln2247">//---------------------------------------------------------</a>
<a name="ln2248">//   validateText</a>
<a name="ln2249">//    check if s is a valid musescore xml text string</a>
<a name="ln2250">//    - simple bugs are automatically adjusted</a>
<a name="ln2251">//   return true if text is valid or could be fixed</a>
<a name="ln2252">//  (this is incomplete/experimental)</a>
<a name="ln2253">//---------------------------------------------------------</a>
<a name="ln2254"> </a>
<a name="ln2255">bool TextBase::validateText(QString&amp; s)</a>
<a name="ln2256">      {</a>
<a name="ln2257">      QString d;</a>
<a name="ln2258">      for (int i = 0; i &lt; s.size(); ++i) {</a>
<a name="ln2259">            QChar c = s[i];</a>
<a name="ln2260">            if (c == '&amp;') {</a>
<a name="ln2261">                  const char* ok[] { &quot;amp;&quot;, &quot;lt;&quot;, &quot;gt;&quot;, &quot;quot;&quot; };</a>
<a name="ln2262">                  QString t = s.mid(i+1);</a>
<a name="ln2263">                  bool found = false;</a>
<a name="ln2264">                  for (auto k : ok) {</a>
<a name="ln2265">                        if (t.startsWith(k)) {</a>
<a name="ln2266">                              d.append(c);</a>
<a name="ln2267">                              d.append(k);</a>
<a name="ln2268">                              i += int(strlen(k));</a>
<a name="ln2269">                              found = true;</a>
<a name="ln2270">                              break;</a>
<a name="ln2271">                              }</a>
<a name="ln2272">                        }</a>
<a name="ln2273">                  if (!found)</a>
<a name="ln2274">                        d.append(&quot;&amp;amp;&quot;);</a>
<a name="ln2275">                  }</a>
<a name="ln2276">            else if (c == '&lt;') {</a>
<a name="ln2277">                  const char* ok[] { &quot;b&gt;&quot;, &quot;/b&gt;&quot;, &quot;i&gt;&quot;, &quot;/i&gt;&quot;, &quot;u&gt;&quot;, &quot;/u&quot;, &quot;font &quot;, &quot;/font&gt;&quot;, &quot;sym&gt;&quot;, &quot;/sym&gt;&quot; };</a>
<a name="ln2278">                  QString t = s.mid(i+1);</a>
<a name="ln2279">                  bool found = false;</a>
<a name="ln2280">                  for (auto k : ok) {</a>
<a name="ln2281">                        if (t.startsWith(k)) {</a>
<a name="ln2282">                              d.append(c);</a>
<a name="ln2283">                              d.append(k);</a>
<a name="ln2284">                              i += int(strlen(k));</a>
<a name="ln2285">                              found = true;</a>
<a name="ln2286">                              break;</a>
<a name="ln2287">                              }</a>
<a name="ln2288">                        }</a>
<a name="ln2289">                  if (!found)</a>
<a name="ln2290">                        d.append(&quot;&amp;lt;&quot;);</a>
<a name="ln2291">                  }</a>
<a name="ln2292">            else</a>
<a name="ln2293">                  d.append(c);</a>
<a name="ln2294">            }</a>
<a name="ln2295">      QString ss = &quot;&lt;data&gt;&quot; + d + &quot;&lt;/data&gt;\n&quot;;</a>
<a name="ln2296">      XmlReader xml(ss);</a>
<a name="ln2297">      while (xml.readNextStartElement())</a>
<a name="ln2298">            ; // qDebug(&quot;  token %d &lt;%s&gt;&quot;, int(xml.tokenType()), qPrintable(xml.name().toString()));</a>
<a name="ln2299">      if (xml.error() == QXmlStreamReader::NoError) {</a>
<a name="ln2300">            s = d;</a>
<a name="ln2301">            return true;</a>
<a name="ln2302">            }</a>
<a name="ln2303">      qDebug(&quot;xml error at line %lld column %lld: %s&quot;,</a>
<a name="ln2304">            xml.lineNumber(),</a>
<a name="ln2305">            xml.columnNumber(),</a>
<a name="ln2306">            qPrintable(xml.errorString()));</a>
<a name="ln2307">      qDebug (&quot;text: |%s|&quot;, qPrintable(ss));</a>
<a name="ln2308">      return false;</a>
<a name="ln2309">      }</a>
<a name="ln2310"> </a>
<a name="ln2311">//---------------------------------------------------------</a>
<a name="ln2312">//   font</a>
<a name="ln2313">//---------------------------------------------------------</a>
<a name="ln2314"> </a>
<a name="ln2315">QFont TextBase::font() const</a>
<a name="ln2316">      {</a>
<a name="ln2317">      qreal m = _size;</a>
<a name="ln2318">      if (sizeIsSpatiumDependent())</a>
<a name="ln2319">            m *= spatium() / SPATIUM20;</a>
<a name="ln2320">      QFont f(_family, m, bold() ? QFont::Bold : QFont::Normal, italic());</a>
<a name="ln2321">      if (underline())</a>
<a name="ln2322">            f.setUnderline(underline());</a>
<a name="ln2323">      return f;</a>
<a name="ln2324">      }</a>
<a name="ln2325"> </a>
<a name="ln2326">//---------------------------------------------------------</a>
<a name="ln2327">//   fontMetrics</a>
<a name="ln2328">//---------------------------------------------------------</a>
<a name="ln2329"> </a>
<a name="ln2330">QFontMetricsF TextBase::fontMetrics() const</a>
<a name="ln2331">      {</a>
<a name="ln2332">      return QFontMetricsF(font());</a>
<a name="ln2333">      }</a>
<a name="ln2334"> </a>
<a name="ln2335">//---------------------------------------------------------</a>
<a name="ln2336">//   getProperty</a>
<a name="ln2337">//---------------------------------------------------------</a>
<a name="ln2338"> </a>
<a name="ln2339">QVariant TextBase::getProperty(Pid propertyId) const</a>
<a name="ln2340">      {</a>
<a name="ln2341">      switch (propertyId) {</a>
<a name="ln2342">            case Pid::SUB_STYLE:</a>
<a name="ln2343">                  return int(tid());</a>
<a name="ln2344">            case Pid::FONT_FACE:</a>
<a name="ln2345">                  return family();</a>
<a name="ln2346">            case Pid::FONT_SIZE:</a>
<a name="ln2347">                  return size();</a>
<a name="ln2348">            case Pid::FONT_STYLE:</a>
<a name="ln2349">                  return int(fontStyle());</a>
<a name="ln2350">            case Pid::FRAME_TYPE:</a>
<a name="ln2351">                  return int(frameType());</a>
<a name="ln2352">            case Pid::FRAME_WIDTH:</a>
<a name="ln2353">                  return frameWidth();</a>
<a name="ln2354">            case Pid::FRAME_PADDING:</a>
<a name="ln2355">                  return paddingWidth();</a>
<a name="ln2356">            case Pid::FRAME_ROUND:</a>
<a name="ln2357">                  return frameRound();</a>
<a name="ln2358">            case Pid::FRAME_FG_COLOR:</a>
<a name="ln2359">                  return frameColor();</a>
<a name="ln2360">            case Pid::FRAME_BG_COLOR:</a>
<a name="ln2361">                  return bgColor();</a>
<a name="ln2362">            case Pid::ALIGN:</a>
<a name="ln2363">                  return QVariant::fromValue(align());</a>
<a name="ln2364">            case Pid::TEXT:</a>
<a name="ln2365">                  return xmlText();</a>
<a name="ln2366">            default:</a>
<a name="ln2367">                  return Element::getProperty(propertyId);</a>
<a name="ln2368">            }</a>
<a name="ln2369">      }</a>
<a name="ln2370"> </a>
<a name="ln2371">//---------------------------------------------------------</a>
<a name="ln2372">//   setProperty</a>
<a name="ln2373">//---------------------------------------------------------</a>
<a name="ln2374"> </a>
<a name="ln2375">bool TextBase::setProperty(Pid pid, const QVariant&amp; v)</a>
<a name="ln2376">      {</a>
<a name="ln2377">      if (textInvalid)</a>
<a name="ln2378">            genText();</a>
<a name="ln2379">      bool rv = true;</a>
<a name="ln2380">      switch (pid) {</a>
<a name="ln2381">            case Pid::SUB_STYLE:</a>
<a name="ln2382">                  initTid(Tid(v.toInt()));</a>
<a name="ln2383">                  break;</a>
<a name="ln2384">            case Pid::FONT_FACE:</a>
<a name="ln2385">                  setFamily(v.toString());</a>
<a name="ln2386">                  break;</a>
<a name="ln2387">            case Pid::FONT_SIZE:</a>
<a name="ln2388">                  setSize(v.toReal());</a>
<a name="ln2389">                  break;</a>
<a name="ln2390">            case Pid::FONT_STYLE:</a>
<a name="ln2391">                  setFontStyle(FontStyle(v.toInt()));</a>
<a name="ln2392">                  break;</a>
<a name="ln2393">            case Pid::FRAME_TYPE:</a>
<a name="ln2394">                  setFrameType(FrameType(v.toInt()));</a>
<a name="ln2395">                  break;</a>
<a name="ln2396">            case Pid::FRAME_WIDTH:</a>
<a name="ln2397">                  setFrameWidth(v.value&lt;Spatium&gt;());</a>
<a name="ln2398">                  break;</a>
<a name="ln2399">            case Pid::FRAME_PADDING:</a>
<a name="ln2400">                  setPaddingWidth(v.value&lt;Spatium&gt;());</a>
<a name="ln2401">                  break;</a>
<a name="ln2402">            case Pid::FRAME_ROUND:</a>
<a name="ln2403">                  setFrameRound(v.toInt());</a>
<a name="ln2404">                  break;</a>
<a name="ln2405">            case Pid::FRAME_FG_COLOR:</a>
<a name="ln2406">                  setFrameColor(v.value&lt;QColor&gt;());</a>
<a name="ln2407">                  break;</a>
<a name="ln2408">            case Pid::FRAME_BG_COLOR:</a>
<a name="ln2409">                  setBgColor(v.value&lt;QColor&gt;());</a>
<a name="ln2410">                  break;</a>
<a name="ln2411">            case Pid::TEXT:</a>
<a name="ln2412">                  setXmlText(v.toString());</a>
<a name="ln2413">                  break;</a>
<a name="ln2414">            case Pid::ALIGN:</a>
<a name="ln2415">                  setAlign(v.value&lt;Align&gt;());</a>
<a name="ln2416">                  break;</a>
<a name="ln2417">            default:</a>
<a name="ln2418">                  rv = Element::setProperty(pid, v);</a>
<a name="ln2419">                  break;</a>
<a name="ln2420">            }</a>
<a name="ln2421">      layoutInvalid = true;</a>
<a name="ln2422">      triggerLayout();</a>
<a name="ln2423">      return rv;</a>
<a name="ln2424">      }</a>
<a name="ln2425"> </a>
<a name="ln2426">//---------------------------------------------------------</a>
<a name="ln2427">//   propertyDefault</a>
<a name="ln2428">//---------------------------------------------------------</a>
<a name="ln2429"> </a>
<a name="ln2430">QVariant TextBase::propertyDefault(Pid id) const</a>
<a name="ln2431">      {</a>
<a name="ln2432">      if (id == Pid::Z)</a>
<a name="ln2433">            return Element::propertyDefault(id);</a>
<a name="ln2434">      if (composition()) {</a>
<a name="ln2435">            QVariant v = parent()-&gt;propertyDefault(id);</a>
<a name="ln2436">            if (v.isValid())</a>
<a name="ln2437">                  return v;</a>
<a name="ln2438">            }</a>
<a name="ln2439">      Sid sid = getPropertyStyle(id);</a>
<a name="ln2440">      if (sid != Sid::NOSTYLE)</a>
<a name="ln2441">            return styleValue(id, sid);</a>
<a name="ln2442">      QVariant v;</a>
<a name="ln2443">      switch (id) {</a>
<a name="ln2444">            case Pid::SUB_STYLE:</a>
<a name="ln2445">                  v = int(Tid::DEFAULT);</a>
<a name="ln2446">                  break;</a>
<a name="ln2447">            case Pid::TEXT:</a>
<a name="ln2448">                  v = QString();</a>
<a name="ln2449">                  break;</a>
<a name="ln2450">            default:</a>
<a name="ln2451">                  for (const StyledProperty&amp; p : *textStyle(Tid::DEFAULT)) {</a>
<a name="ln2452">                        if (p.pid == id)</a>
<a name="ln2453">                              return styleValue(id, p.sid);</a>
<a name="ln2454">                        }</a>
<a name="ln2455">                  return Element::propertyDefault(id);</a>
<a name="ln2456">            }</a>
<a name="ln2457">      return v;</a>
<a name="ln2458">      }</a>
<a name="ln2459"> </a>
<a name="ln2460">//---------------------------------------------------------</a>
<a name="ln2461">//   getPropertyFlagsIdx</a>
<a name="ln2462">//---------------------------------------------------------</a>
<a name="ln2463"> </a>
<a name="ln2464">int TextBase::getPropertyFlagsIdx(Pid id) const</a>
<a name="ln2465">      {</a>
<a name="ln2466">      int i = 0;</a>
<a name="ln2467">      for (const StyledProperty&amp; p : *_elementStyle) {</a>
<a name="ln2468">            if (p.pid == id)</a>
<a name="ln2469">                  return i;</a>
<a name="ln2470">            ++i;</a>
<a name="ln2471">            }</a>
<a name="ln2472">      for (const StyledProperty&amp; p : *textStyle(tid())) {</a>
<a name="ln2473">            if (p.pid == id)</a>
<a name="ln2474">                  return i;</a>
<a name="ln2475">            ++i;</a>
<a name="ln2476">            }</a>
<a name="ln2477">      return -1;</a>
<a name="ln2478">      }</a>
<a name="ln2479"> </a>
<a name="ln2480">//---------------------------------------------------------</a>
<a name="ln2481">//   getPropertyStyle</a>
<a name="ln2482">//---------------------------------------------------------</a>
<a name="ln2483"> </a>
<a name="ln2484">Sid TextBase::getPropertyStyle(Pid id) const</a>
<a name="ln2485">      {</a>
<a name="ln2486">      for (const StyledProperty&amp; p : *_elementStyle) {</a>
<a name="ln2487">            if (p.pid == id)</a>
<a name="ln2488">                  return p.sid;</a>
<a name="ln2489">            }</a>
<a name="ln2490">      for (const StyledProperty&amp; p : *textStyle(tid())) {</a>
<a name="ln2491">            if (p.pid == id)</a>
<a name="ln2492">                  return p.sid;</a>
<a name="ln2493">            }</a>
<a name="ln2494">      return Sid::NOSTYLE;</a>
<a name="ln2495">      }</a>
<a name="ln2496"> </a>
<a name="ln2497">//---------------------------------------------------------</a>
<a name="ln2498">//   styleChanged</a>
<a name="ln2499">//---------------------------------------------------------</a>
<a name="ln2500"> </a>
<a name="ln2501">void TextBase::styleChanged()</a>
<a name="ln2502">      {</a>
<a name="ln2503">      if (!styledProperties()) {</a>
<a name="ln2504">            qDebug(&quot;no styled properties&quot;);</a>
<a name="ln2505">            return;</a>
<a name="ln2506">            }</a>
<a name="ln2507">      int i = 0;</a>
<a name="ln2508">      for (const StyledProperty&amp; spp : *_elementStyle) {</a>
<a name="ln2509">            PropertyFlags f = _propertyFlagsList[i];</a>
<a name="ln2510">            if (f == PropertyFlags::STYLED)</a>
<a name="ln2511">                  setProperty(spp.pid, styleValue(spp.pid, getPropertyStyle(spp.pid)));</a>
<a name="ln2512">            ++i;</a>
<a name="ln2513">            }</a>
<a name="ln2514">      for (const StyledProperty&amp; spp : *textStyle(tid())) {</a>
<a name="ln2515">            PropertyFlags f = _propertyFlagsList[i];</a>
<a name="ln2516">            if (f == PropertyFlags::STYLED)</a>
<a name="ln2517">                  setProperty(spp.pid, styleValue(spp.pid, getPropertyStyle(spp.pid)));</a>
<a name="ln2518">            ++i;</a>
<a name="ln2519">            }</a>
<a name="ln2520">      }</a>
<a name="ln2521"> </a>
<a name="ln2522">//---------------------------------------------------------</a>
<a name="ln2523">//   initElementStyle</a>
<a name="ln2524">//---------------------------------------------------------</a>
<a name="ln2525"> </a>
<a name="ln2526">void TextBase::initElementStyle(const ElementStyle* ss)</a>
<a name="ln2527">      {</a>
<a name="ln2528">      _elementStyle = ss;</a>
<a name="ln2529">      size_t n      = ss-&gt;size() + TEXT_STYLE_SIZE;</a>
<a name="ln2530"> </a>
<a name="ln2531">      delete[] _propertyFlagsList;</a>
<a name="ln2532">      _propertyFlagsList = new PropertyFlags[n];</a>
<a name="ln2533">      for (size_t i = 0; i &lt; n; ++i)</a>
<a name="ln2534">            _propertyFlagsList[i] = PropertyFlags::STYLED;</a>
<a name="ln2535">      for (const StyledProperty&amp; p : *_elementStyle)</a>
<a name="ln2536">            setProperty(p.pid, styleValue(p.pid, p.sid));</a>
<a name="ln2537">      for (const StyledProperty&amp; p : *textStyle(tid()))</a>
<a name="ln2538">            setProperty(p.pid, styleValue(p.pid, p.sid));</a>
<a name="ln2539">      }</a>
<a name="ln2540"> </a>
<a name="ln2541">//---------------------------------------------------------</a>
<a name="ln2542">//   initTid</a>
<a name="ln2543">//---------------------------------------------------------</a>
<a name="ln2544"> </a>
<a name="ln2545">void TextBase::initTid(Tid tid, bool preserveDifferent)</a>
<a name="ln2546">      {</a>
<a name="ln2547">      if (! preserveDifferent)</a>
<a name="ln2548">            initTid(tid);</a>
<a name="ln2549">      else {</a>
<a name="ln2550">            setTid(tid);</a>
<a name="ln2551">            for (const StyledProperty&amp; p : *textStyle(tid)) {</a>
<a name="ln2552">                  if (getProperty(p.pid) == propertyDefault(p.pid))</a>
<a name="ln2553">                        setProperty(p.pid, styleValue(p.pid, p.sid));</a>
<a name="ln2554">                  }</a>
<a name="ln2555">            }</a>
<a name="ln2556">      }</a>
<a name="ln2557"> </a>
<a name="ln2558">void TextBase::initTid(Tid tid)</a>
<a name="ln2559">      {</a>
<a name="ln2560">      setTid(tid);</a>
<a name="ln2561">      for (const StyledProperty&amp; p : *textStyle(tid)) {</a>
<a name="ln2562">            setProperty(p.pid, styleValue(p.pid, p.sid));</a>
<a name="ln2563">            }</a>
<a name="ln2564">      }</a>
<a name="ln2565"> </a>
<a name="ln2566">//---------------------------------------------------------</a>
<a name="ln2567">//   editCut</a>
<a name="ln2568">//---------------------------------------------------------</a>
<a name="ln2569"> </a>
<a name="ln2570">void TextBase::editCut(EditData&amp; ed)</a>
<a name="ln2571">      {</a>
<a name="ln2572">      TextEditData* ted = static_cast&lt;TextEditData*&gt;(ed.getData(this));</a>
<a name="ln2573">      TextCursor* _cursor = &amp;ted-&gt;cursor;</a>
<a name="ln2574">      QString s = _cursor-&gt;selectedText();</a>
<a name="ln2575"> </a>
<a name="ln2576">      if (!s.isEmpty()) {</a>
<a name="ln2577">            QApplication::clipboard()-&gt;setText(s, QClipboard::Clipboard);</a>
<a name="ln2578">            ed.curGrip = Grip::START;</a>
<a name="ln2579">            ed.key     = Qt::Key_Delete;</a>
<a name="ln2580">            ed.s       = QString();</a>
<a name="ln2581">            edit(ed);</a>
<a name="ln2582">            }</a>
<a name="ln2583">      }</a>
<a name="ln2584"> </a>
<a name="ln2585">//---------------------------------------------------------</a>
<a name="ln2586">//   editCopy</a>
<a name="ln2587">//---------------------------------------------------------</a>
<a name="ln2588"> </a>
<a name="ln2589">void TextBase::editCopy(EditData&amp; ed)</a>
<a name="ln2590">      {</a>
<a name="ln2591">      //</a>
<a name="ln2592">      // store selection as plain text</a>
<a name="ln2593">      //</a>
<a name="ln2594">      TextEditData* ted = static_cast&lt;TextEditData*&gt;(ed.getData(this));</a>
<a name="ln2595">      TextCursor* _cursor = &amp;ted-&gt;cursor;</a>
<a name="ln2596">      QString s = _cursor-&gt;selectedText();</a>
<a name="ln2597">      if (!s.isEmpty())</a>
<a name="ln2598">            QApplication::clipboard()-&gt;setText(s, QClipboard::Clipboard);</a>
<a name="ln2599">      }</a>
<a name="ln2600"> </a>
<a name="ln2601">//---------------------------------------------------------</a>
<a name="ln2602">//   cursor</a>
<a name="ln2603">//---------------------------------------------------------</a>
<a name="ln2604"> </a>
<a name="ln2605">TextCursor* TextBase::cursor(const EditData&amp; ed)</a>
<a name="ln2606">      {</a>
<a name="ln2607">      TextEditData* ted = static_cast&lt;TextEditData*&gt;(ed.getData(this));</a>
<a name="ln2608">      Q_ASSERT(ted);</a>
<a name="ln2609">      return &amp;ted-&gt;cursor;</a>
<a name="ln2610">      }</a>
<a name="ln2611"> </a>
<a name="ln2612">//---------------------------------------------------------</a>
<a name="ln2613">//   draw</a>
<a name="ln2614">//---------------------------------------------------------</a>
<a name="ln2615"> </a>
<a name="ln2616">void TextBase::draw(QPainter* p) const</a>
<a name="ln2617">      {</a>
<a name="ln2618">      if (hasFrame()) {</a>
<a name="ln2619">            qreal baseSpatium = MScore::baseStyle().value(Sid::spatium).toDouble();</a>
<a name="ln2620">            if (frameWidth().val() != 0.0) {</a>
<a name="ln2621">                  QColor fColor = curColor(visible(), frameColor());</a>
<a name="ln2622">                  qreal frameWidthVal = frameWidth().val() * (sizeIsSpatiumDependent() ? spatium() : baseSpatium);</a>
<a name="ln2623"> </a>
<a name="ln2624">                  QPen pen(fColor, frameWidthVal, Qt::SolidLine,</a>
<a name="ln2625">                     Qt::SquareCap, Qt::MiterJoin);</a>
<a name="ln2626">                  p-&gt;setPen(pen);</a>
<a name="ln2627">                  }</a>
<a name="ln2628">            else</a>
<a name="ln2629">                  p-&gt;setPen(Qt::NoPen);</a>
<a name="ln2630">            QColor bg(bgColor());</a>
<a name="ln2631">            p-&gt;setBrush(bg.alpha() ? QBrush(bg) : Qt::NoBrush);</a>
<a name="ln2632">            if (circle())</a>
<a name="ln2633">                  p-&gt;drawEllipse(frame);</a>
<a name="ln2634">            else {</a>
<a name="ln2635">                  qreal frameRoundFactor = (sizeIsSpatiumDependent() ? (spatium()/baseSpatium) / 2 : 0.5f);</a>
<a name="ln2636"> </a>
<a name="ln2637">                  int r2 = frameRound() * frameRoundFactor;</a>
<a name="ln2638">                  if (r2 &gt; 99)</a>
<a name="ln2639">                        r2 = 99;</a>
<a name="ln2640">                  p-&gt;drawRoundedRect(frame, frameRound() * frameRoundFactor, r2);</a>
<a name="ln2641">                  }</a>
<a name="ln2642">            }</a>
<a name="ln2643">      p-&gt;setBrush(Qt::NoBrush);</a>
<a name="ln2644">      p-&gt;setPen(textColor());</a>
<a name="ln2645">      for (const TextBlock&amp; t : _layout)</a>
<a name="ln2646">            t.draw(p, this);</a>
<a name="ln2647">      }</a>
<a name="ln2648"> </a>
<a name="ln2649">//---------------------------------------------------------</a>
<a name="ln2650">//   drawEditMode</a>
<a name="ln2651">//    draw edit mode decorations</a>
<a name="ln2652">//---------------------------------------------------------</a>
<a name="ln2653"> </a>
<a name="ln2654">void TextBase::drawEditMode(QPainter* p, EditData&amp; ed)</a>
<a name="ln2655">      {</a>
<a name="ln2656">      QPointF pos(canvasPos());</a>
<a name="ln2657">      p-&gt;translate(pos);</a>
<a name="ln2658"> </a>
<a name="ln2659">      TextEditData* ted = static_cast&lt;TextEditData*&gt;(ed.getData(this));</a>
<a name="ln2660">      if (!ted) {</a>
<a name="ln2661">            qDebug(&quot;ted not found&quot;);</a>
<a name="ln2662">            return;</a>
<a name="ln2663">            }</a>
<a name="ln2664">      TextCursor* _cursor = &amp;ted-&gt;cursor;</a>
<a name="ln2665"> </a>
<a name="ln2666">      if (_cursor-&gt;hasSelection()) {</a>
<a name="ln2667">            p-&gt;setBrush(Qt::NoBrush);</a>
<a name="ln2668">            p-&gt;setPen(textColor());</a>
<a name="ln2669">            int r1 = _cursor-&gt;selectLine();</a>
<a name="ln2670">            int r2 = _cursor-&gt;row();</a>
<a name="ln2671">            int c1 = _cursor-&gt;selectColumn();</a>
<a name="ln2672">            int c2 = _cursor-&gt;column();</a>
<a name="ln2673"> </a>
<a name="ln2674">            if (r1 &gt; r2) {</a>
<a name="ln2675">                  qSwap(r1, r2);</a>
<a name="ln2676">                  qSwap(c1, c2);</a>
<a name="ln2677">                  }</a>
<a name="ln2678">            else if (r1 == r2) {</a>
<a name="ln2679">                  if (c1 &gt; c2)</a>
<a name="ln2680">                        qSwap(c1, c2);</a>
<a name="ln2681">                  }</a>
<a name="ln2682">            int row = 0;</a>
<a name="ln2683">            for (const TextBlock&amp; t : _layout) {</a>
<a name="ln2684">                  t.draw(p, this);</a>
<a name="ln2685">                  if (row &gt;= r1 &amp;&amp; row &lt;= r2) {</a>
<a name="ln2686">                        QRectF br;</a>
<a name="ln2687">                        if (row == r1 &amp;&amp; r1 == r2)</a>
<a name="ln2688">                              br = t.boundingRect(c1, c2, this);</a>
<a name="ln2689">                        else if (row == r1)</a>
<a name="ln2690">                              br = t.boundingRect(c1, t.columns(), this);</a>
<a name="ln2691">                        else if (row == r2)</a>
<a name="ln2692">                              br = t.boundingRect(0, c2, this);</a>
<a name="ln2693">                        else</a>
<a name="ln2694">                              br = t.boundingRect();</a>
<a name="ln2695">                        br.translate(0.0, t.y());</a>
<a name="ln2696">                        drawSelection(p, br);</a>
<a name="ln2697">                        }</a>
<a name="ln2698">                  ++row;</a>
<a name="ln2699">                  }</a>
<a name="ln2700">            }</a>
<a name="ln2701">      p-&gt;setBrush(curColor());</a>
<a name="ln2702">      QPen pen(curColor());</a>
<a name="ln2703">      pen.setJoinStyle(Qt::MiterJoin);</a>
<a name="ln2704">      p-&gt;setPen(pen);</a>
<a name="ln2705"> </a>
<a name="ln2706">      // Don't draw cursor if there is a selection</a>
<a name="ln2707">      if (!_cursor-&gt;hasSelection())</a>
<a name="ln2708">            p-&gt;drawRect(_cursor-&gt;cursorRect());</a>
<a name="ln2709"> </a>
<a name="ln2710">      QMatrix matrix = p-&gt;matrix();</a>
<a name="ln2711">      p-&gt;translate(-pos);</a>
<a name="ln2712">      p-&gt;setPen(QPen(QBrush(Qt::lightGray), 4.0 / matrix.m11()));  // 4 pixel pen size</a>
<a name="ln2713">      p-&gt;setBrush(Qt::NoBrush);</a>
<a name="ln2714"> </a>
<a name="ln2715">      qreal m = spatium();</a>
<a name="ln2716">      QRectF r = canvasBoundingRect().adjusted(-m, -m, m, m);</a>
<a name="ln2717">//      qDebug(&quot;%f %f %f %f\n&quot;, r.x(), r.y(), r.width(), r.height());</a>
<a name="ln2718"> </a>
<a name="ln2719">      p-&gt;drawRect(r);</a>
<a name="ln2720">      pen = QPen(MScore::defaultColor, 0.0);</a>
<a name="ln2721">      }</a>
<a name="ln2722"> </a>
<a name="ln2723">//---------------------------------------------------------</a>
<a name="ln2724">//   hasCustomFormatting</a>
<a name="ln2725">//---------------------------------------------------------</a>
<a name="ln2726"> </a>
<a name="ln2727">bool TextBase::hasCustomFormatting() const</a>
<a name="ln2728">      {</a>
<a name="ln2729">      CharFormat fmt;</a>
<a name="ln2730">      fmt.setFontFamily(family());</a>
<a name="ln2731">      fmt.setFontSize(size());</a>
<a name="ln2732">      fmt.setStyle(fontStyle());</a>
<a name="ln2733">      fmt.setPreedit(false);</a>
<a name="ln2734">      fmt.setValign(VerticalAlignment::AlignNormal);</a>
<a name="ln2735"> </a>
<a name="ln2736">      for (const TextBlock&amp; block : _layout) {</a>
<a name="ln2737">            for (const TextFragment&amp; f : block.fragments()) {</a>
<a name="ln2738">                  if (f.text.isEmpty())                     // skip empty fragments, not to</a>
<a name="ln2739">                        continue;                           // insert extra HTML formatting</a>
<a name="ln2740">                  const CharFormat&amp; format = f.format;</a>
<a name="ln2741">                  if (fmt.style() != format.style())</a>
<a name="ln2742">                        return true;</a>
<a name="ln2743">                  if (format.fontSize() != fmt.fontSize())</a>
<a name="ln2744">                        return true;</a>
<a name="ln2745">                  if (format.fontFamily() != fmt.fontFamily())</a>
<a name="ln2746">                        return true;</a>
<a name="ln2747"> </a>
<a name="ln2748">                  VerticalAlignment va = format.valign();</a>
<a name="ln2749">                  VerticalAlignment cva = fmt.valign();</a>
<a name="ln2750">                  if (cva != va)</a>
<a name="ln2751">                        return true;</a>
<a name="ln2752">                  }</a>
<a name="ln2753">            }</a>
<a name="ln2754">      return false;</a>
<a name="ln2755">      }</a>
<a name="ln2756"> </a>
<a name="ln2757">//---------------------------------------------------------</a>
<a name="ln2758">//   stripText</a>
<a name="ln2759">//    remove some custom text formatting and return</a>
<a name="ln2760">//    result as xml string</a>
<a name="ln2761">//---------------------------------------------------------</a>
<a name="ln2762"> </a>
<a name="ln2763">QString TextBase::stripText(bool removeStyle, bool removeSize, bool removeFace) const</a>
<a name="ln2764">      {</a>
<a name="ln2765">      QString _txt;</a>
<a name="ln2766">      bool bold_      = false;</a>
<a name="ln2767">      bool italic_    = false;</a>
<a name="ln2768">      bool underline_ = false;</a>
<a name="ln2769"> </a>
<a name="ln2770">      for (const TextBlock&amp; block : _layout) {</a>
<a name="ln2771">            for (const TextFragment&amp; f : block.fragments()) {</a>
<a name="ln2772">                  if (!f.format.bold() &amp;&amp; bold())</a>
<a name="ln2773">                        bold_ = true;</a>
<a name="ln2774">                  if (!f.format.italic() &amp;&amp; italic())</a>
<a name="ln2775">                        italic_ = true;</a>
<a name="ln2776">                  if (!f.format.underline() &amp;&amp; underline())</a>
<a name="ln2777">                        underline_ = true;</a>
<a name="ln2778">                  }</a>
<a name="ln2779">            }</a>
<a name="ln2780">      CharFormat fmt;</a>
<a name="ln2781">      fmt.setFontFamily(family());</a>
<a name="ln2782">      fmt.setFontSize(size());</a>
<a name="ln2783">      fmt.setStyle(fontStyle());</a>
<a name="ln2784">      fmt.setPreedit(false);</a>
<a name="ln2785">      fmt.setValign(VerticalAlignment::AlignNormal);</a>
<a name="ln2786"> </a>
<a name="ln2787">      XmlNesting xmlNesting(&amp;_txt);</a>
<a name="ln2788">      if (!removeStyle) {</a>
<a name="ln2789">            if (bold_)</a>
<a name="ln2790">                  xmlNesting.pushB();</a>
<a name="ln2791">            if (italic_)</a>
<a name="ln2792">                  xmlNesting.pushI();</a>
<a name="ln2793">            if (underline_)</a>
<a name="ln2794">                  xmlNesting.pushU();</a>
<a name="ln2795">            }</a>
<a name="ln2796"> </a>
<a name="ln2797">      for (const TextBlock&amp; block : _layout) {</a>
<a name="ln2798">            for (const TextFragment&amp; f : block.fragments()) {</a>
<a name="ln2799">                  if (f.text.isEmpty())                     // skip empty fragments, not to</a>
<a name="ln2800">                        continue;                           // insert extra HTML formatting</a>
<a name="ln2801">                  const CharFormat&amp; format = f.format;</a>
<a name="ln2802">                  if (!removeStyle) {</a>
<a name="ln2803">                        if (fmt.bold() != format.bold()) {</a>
<a name="ln2804">                              if (format.bold())</a>
<a name="ln2805">                                    xmlNesting.pushB();</a>
<a name="ln2806">                              else</a>
<a name="ln2807">                                    xmlNesting.popB();</a>
<a name="ln2808">                              }</a>
<a name="ln2809">                        if (fmt.italic() != format.italic()) {</a>
<a name="ln2810">                              if (format.italic())</a>
<a name="ln2811">                                    xmlNesting.pushI();</a>
<a name="ln2812">                              else</a>
<a name="ln2813">                                    xmlNesting.popI();</a>
<a name="ln2814">                              }</a>
<a name="ln2815">                        if (fmt.underline() != format.underline()) {</a>
<a name="ln2816">                              if (format.underline())</a>
<a name="ln2817">                                    xmlNesting.pushU();</a>
<a name="ln2818">                              else</a>
<a name="ln2819">                                    xmlNesting.popU();</a>
<a name="ln2820">                              }</a>
<a name="ln2821">                        }</a>
<a name="ln2822"> </a>
<a name="ln2823">                  if (!removeSize &amp;&amp; (format.fontSize() != fmt.fontSize()))</a>
<a name="ln2824">                        _txt += QString(&quot;&lt;font size=\&quot;%1\&quot;/&gt;&quot;).arg(format.fontSize());</a>
<a name="ln2825">                  if (!removeFace &amp;&amp; (format.fontFamily() != fmt.fontFamily()))</a>
<a name="ln2826">                        _txt += QString(&quot;&lt;font face=\&quot;%1\&quot;/&gt;&quot;).arg(TextBase::escape(format.fontFamily()));</a>
<a name="ln2827"> </a>
<a name="ln2828">                  VerticalAlignment va = format.valign();</a>
<a name="ln2829">                  VerticalAlignment cva = fmt.valign();</a>
<a name="ln2830">                  if (cva != va) {</a>
<a name="ln2831">                        switch (va) {</a>
<a name="ln2832">                              case VerticalAlignment::AlignNormal:</a>
<a name="ln2833">                                    xmlNesting.popToken(cva == VerticalAlignment::AlignSuperScript ? &quot;sup&quot; : &quot;sub&quot;);</a>
<a name="ln2834">                                    break;</a>
<a name="ln2835">                              case VerticalAlignment::AlignSuperScript:</a>
<a name="ln2836">                                    xmlNesting.pushToken(&quot;sup&quot;);</a>
<a name="ln2837">                                    break;</a>
<a name="ln2838">                              case VerticalAlignment::AlignSubScript:</a>
<a name="ln2839">                                    xmlNesting.pushToken(&quot;sub&quot;);</a>
<a name="ln2840">                                    break;</a>
<a name="ln2841">                              }</a>
<a name="ln2842">                        }</a>
<a name="ln2843">                  _txt += XmlWriter::xmlString(f.text);</a>
<a name="ln2844">                  fmt = format;</a>
<a name="ln2845">                  }</a>
<a name="ln2846">            if (block.eol())</a>
<a name="ln2847">                  _txt += QChar::LineFeed;</a>
<a name="ln2848">            }</a>
<a name="ln2849">      while (!xmlNesting.empty())</a>
<a name="ln2850">            xmlNesting.popToken();</a>
<a name="ln2851">      return _txt;</a>
<a name="ln2852">      }</a>
<a name="ln2853"> </a>
<a name="ln2854">//---------------------------------------------------------</a>
<a name="ln2855">//   undoChangeProperty</a>
<a name="ln2856">//---------------------------------------------------------</a>
<a name="ln2857"> </a>
<a name="ln2858">void TextBase::undoChangeProperty(Pid id, const QVariant&amp; v, PropertyFlags ps)</a>
<a name="ln2859">      {</a>
<a name="ln2860">      if (ps == PropertyFlags::STYLED &amp;&amp; v == propertyDefault(id)) {</a>
<a name="ln2861">            // this is a reset</a>
<a name="ln2862">            // remove some custom formatting</a>
<a name="ln2863">            if (id == Pid::FONT_STYLE)</a>
<a name="ln2864">                  undoChangeProperty(Pid::TEXT, stripText(true, false, false), propertyFlags(id));</a>
<a name="ln2865">            else if (id == Pid::FONT_SIZE)</a>
<a name="ln2866">                  undoChangeProperty(Pid::TEXT, stripText(false, true, false), propertyFlags(id));</a>
<a name="ln2867">            else if (id == Pid::FONT_FACE)</a>
<a name="ln2868">                  undoChangeProperty(Pid::TEXT, stripText(false, false, true), propertyFlags(id));</a>
<a name="ln2869">            }</a>
<a name="ln2870">      Element::undoChangeProperty(id, v, ps);</a>
<a name="ln2871">      }</a>
<a name="ln2872"> </a>
<a name="ln2873">}</a>
<a name="ln2874"> </a>

</code></pre>
<div class="balloon" rel="1319"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="1402"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v501/" target="_blank">V501</a> There are identical sub-expressions to the left and to the right of the '-' operator: i - i</p></div>
<div class="balloon" rel="2307"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="2720"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1001/" target="_blank">V1001</a> The 'pen' variable is assigned but is not used by the end of the function.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
