
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>palettemodel.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2019 Werner Schweer and others</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2.</a>
<a name="ln9">//</a>
<a name="ln10">//  This program is distributed in the hope that it will be useful,</a>
<a name="ln11">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">//  GNU General Public License for more details.</a>
<a name="ln14">//</a>
<a name="ln15">//  You should have received a copy of the GNU General Public License</a>
<a name="ln16">//  along with this program; if not, write to the Free Software</a>
<a name="ln17">//  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</a>
<a name="ln18">//=============================================================================</a>
<a name="ln19"> </a>
<a name="ln20">#include &quot;palettemodel.h&quot;</a>
<a name="ln21"> </a>
<a name="ln22">#include &quot;libmscore/beam.h&quot;</a>
<a name="ln23">#include &quot;libmscore/chordrest.h&quot;</a>
<a name="ln24">#include &quot;libmscore/icon.h&quot;</a>
<a name="ln25">#include &quot;libmscore/select.h&quot;</a>
<a name="ln26">#include &quot;palettetree.h&quot;</a>
<a name="ln27">#include &quot;palette.h&quot;</a>
<a name="ln28">#include &quot;preferences.h&quot;</a>
<a name="ln29">#include &quot;scoreaccessibility.h&quot;</a>
<a name="ln30"> </a>
<a name="ln31">namespace Ms {</a>
<a name="ln32">//---------------------------------------------------------</a>
<a name="ln33">//   PaletteTreeModel::PaletteTreeModel</a>
<a name="ln34">//---------------------------------------------------------</a>
<a name="ln35"> </a>
<a name="ln36">PaletteTreeModel::PaletteTreeModel(std::unique_ptr&lt;PaletteTree&gt; tree, QObject* parent)</a>
<a name="ln37">   : QAbstractItemModel(parent), _paletteTree(std::move(tree))</a>
<a name="ln38">      {</a>
<a name="ln39">      connect(this, &amp;QAbstractItemModel::dataChanged, this, &amp;PaletteTreeModel::onDataChanged);</a>
<a name="ln40">      connect(this, &amp;QAbstractItemModel::layoutChanged, this, &amp;PaletteTreeModel::setTreeChanged);</a>
<a name="ln41">      connect(this, &amp;QAbstractItemModel::modelReset, this, &amp;PaletteTreeModel::setTreeChanged);</a>
<a name="ln42">      connect(this, &amp;QAbstractItemModel::rowsInserted, this, &amp;PaletteTreeModel::setTreeChanged);</a>
<a name="ln43">      connect(this, &amp;QAbstractItemModel::rowsMoved, this, &amp;PaletteTreeModel::setTreeChanged);</a>
<a name="ln44">      connect(this, &amp;QAbstractItemModel::rowsRemoved, this, &amp;PaletteTreeModel::setTreeChanged);</a>
<a name="ln45">      }</a>
<a name="ln46"> </a>
<a name="ln47">//---------------------------------------------------------</a>
<a name="ln48">//   PaletteTreeModel::onDataChanged</a>
<a name="ln49">//---------------------------------------------------------</a>
<a name="ln50"> </a>
<a name="ln51">void PaletteTreeModel::onDataChanged(const QModelIndex&amp; topLeft, const QModelIndex&amp; bottomRight, const QVector&lt;int&gt;&amp; roles)</a>
<a name="ln52">      {</a>
<a name="ln53">      Q_UNUSED(topLeft);</a>
<a name="ln54">      Q_UNUSED(bottomRight);</a>
<a name="ln55">      static const std::set&lt;int&gt; nonPersistentRoles({ CellActiveRole, PaletteExpandedRole });</a>
<a name="ln56"> </a>
<a name="ln57">      bool treeChanged = false;</a>
<a name="ln58">      for (int role : roles) {</a>
<a name="ln59">            if (!nonPersistentRoles.count(role)) {</a>
<a name="ln60">                  treeChanged = true;</a>
<a name="ln61">                  break;</a>
<a name="ln62">                  }</a>
<a name="ln63">            }</a>
<a name="ln64"> </a>
<a name="ln65">      if (treeChanged)</a>
<a name="ln66">            setTreeChanged();</a>
<a name="ln67">      }</a>
<a name="ln68"> </a>
<a name="ln69">//---------------------------------------------------------</a>
<a name="ln70">//   PaletteTreeModel::setTreeChanged</a>
<a name="ln71">//---------------------------------------------------------</a>
<a name="ln72"> </a>
<a name="ln73">void PaletteTreeModel::setTreeChanged()</a>
<a name="ln74">      {</a>
<a name="ln75">      _treeChanged = true;</a>
<a name="ln76">      if (!_treeChangedSignalBlocked)</a>
<a name="ln77">            emit treeChanged();</a>
<a name="ln78">      }</a>
<a name="ln79"> </a>
<a name="ln80">//---------------------------------------------------------</a>
<a name="ln81">//   PaletteTreeModel::blockTreeChanged</a>
<a name="ln82">//---------------------------------------------------------</a>
<a name="ln83"> </a>
<a name="ln84">bool PaletteTreeModel::blockTreeChanged(bool block)</a>
<a name="ln85">      {</a>
<a name="ln86">      const bool wasBlocked = _treeChangedSignalBlocked;</a>
<a name="ln87">      _treeChangedSignalBlocked = block;</a>
<a name="ln88"> </a>
<a name="ln89">      if (wasBlocked &amp;&amp; !block &amp;&amp; _treeChanged)</a>
<a name="ln90">            emit treeChanged();</a>
<a name="ln91"> </a>
<a name="ln92">      return wasBlocked;</a>
<a name="ln93">      }</a>
<a name="ln94"> </a>
<a name="ln95">//---------------------------------------------------------</a>
<a name="ln96">//   PaletteTreeModel::iptrToPalettePanel</a>
<a name="ln97">//---------------------------------------------------------</a>
<a name="ln98"> </a>
<a name="ln99">PalettePanel* PaletteTreeModel::iptrToPalettePanel(void* iptr, int* idx)</a>
<a name="ln100">      {</a>
<a name="ln101">      const auto palette = std::find_if(</a>
<a name="ln102">         palettes().begin(), palettes().end(),</a>
<a name="ln103">         [iptr](const std::unique_ptr&lt;PalettePanel&gt;&amp; p) {</a>
<a name="ln104">               return iptr == p.get();</a>
<a name="ln105">               });</a>
<a name="ln106"> </a>
<a name="ln107">      if (idx)</a>
<a name="ln108">            (*idx) = palette - palettes().begin();</a>
<a name="ln109"> </a>
<a name="ln110">      if (palette != palettes().end())</a>
<a name="ln111">            return static_cast&lt;PalettePanel*&gt;(iptr);</a>
<a name="ln112">      return nullptr;</a>
<a name="ln113">      }</a>
<a name="ln114"> </a>
<a name="ln115">//---------------------------------------------------------</a>
<a name="ln116">//   PaletteTreeModel::findPalettePanel</a>
<a name="ln117">//---------------------------------------------------------</a>
<a name="ln118"> </a>
<a name="ln119">const PalettePanel* PaletteTreeModel::findPalettePanel(const QModelIndex&amp; index) const</a>
<a name="ln120">      {</a>
<a name="ln121">      if (index.internalPointer() != _paletteTree.get())</a>
<a name="ln122">            return nullptr;</a>
<a name="ln123"> </a>
<a name="ln124">      const int row = index.row();</a>
<a name="ln125">      if (index.column() != 0 || row &lt; 0 || row &gt; int(palettes().size()))</a>
<a name="ln126">            return nullptr;</a>
<a name="ln127"> </a>
<a name="ln128">      return palettes()[row].get();</a>
<a name="ln129">      }</a>
<a name="ln130"> </a>
<a name="ln131">//---------------------------------------------------------</a>
<a name="ln132">//   PaletteTreeModel::findPalettePanel</a>
<a name="ln133">//---------------------------------------------------------</a>
<a name="ln134"> </a>
<a name="ln135">PalettePanel* PaletteTreeModel::findPalettePanel(const QModelIndex&amp; index)</a>
<a name="ln136">      {</a>
<a name="ln137">      return const_cast&lt;PalettePanel*&gt;(const_cast&lt;const PaletteTreeModel*&gt;(this)-&gt;findPalettePanel(index));</a>
<a name="ln138">      }</a>
<a name="ln139"> </a>
<a name="ln140">//---------------------------------------------------------</a>
<a name="ln141">//   PaletteTreeModel::findCell</a>
<a name="ln142">//---------------------------------------------------------</a>
<a name="ln143"> </a>
<a name="ln144">PaletteCellConstPtr PaletteTreeModel::findCell(const QModelIndex&amp; index) const</a>
<a name="ln145">      {</a>
<a name="ln146">      if (const PalettePanel* pp = iptrToPalettePanel(index.internalPointer())) {</a>
<a name="ln147">            const int row = index.row();</a>
<a name="ln148">            if (index.column() != 0 || row &lt; 0 || row &gt;= pp-&gt;ncells())</a>
<a name="ln149">                  return nullptr;</a>
<a name="ln150">            return pp-&gt;cell(row);</a>
<a name="ln151">            }</a>
<a name="ln152"> </a>
<a name="ln153">      return nullptr;</a>
<a name="ln154">      }</a>
<a name="ln155"> </a>
<a name="ln156">//---------------------------------------------------------</a>
<a name="ln157">//   PaletteTreeModel::findCell</a>
<a name="ln158">//---------------------------------------------------------</a>
<a name="ln159"> </a>
<a name="ln160">PaletteCellPtr PaletteTreeModel::findCell(const QModelIndex&amp; index)</a>
<a name="ln161">      {</a>
<a name="ln162">      return std::const_pointer_cast&lt;PaletteCell&gt;(const_cast&lt;const PaletteTreeModel*&gt;(this)-&gt;findCell(index));</a>
<a name="ln163">      }</a>
<a name="ln164"> </a>
<a name="ln165">//---------------------------------------------------------</a>
<a name="ln166">//   PaletteTreeModel::setPaletteTree</a>
<a name="ln167">//---------------------------------------------------------</a>
<a name="ln168"> </a>
<a name="ln169">void PaletteTreeModel::setPaletteTree(std::unique_ptr&lt;PaletteTree&gt; newTree)</a>
<a name="ln170">      {</a>
<a name="ln171">      beginResetModel();</a>
<a name="ln172">      _paletteTree = std::move(newTree);</a>
<a name="ln173">      endResetModel();</a>
<a name="ln174"> </a>
<a name="ln175">      _treeChanged = false;</a>
<a name="ln176">      }</a>
<a name="ln177"> </a>
<a name="ln178">//---------------------------------------------------------</a>
<a name="ln179">//   PaletteTreeModel::index</a>
<a name="ln180">//---------------------------------------------------------</a>
<a name="ln181"> </a>
<a name="ln182">QModelIndex PaletteTreeModel::index(int row, int column, const QModelIndex&amp; parent) const</a>
<a name="ln183">      {</a>
<a name="ln184">      if (!hasIndex(row, column, parent))</a>
<a name="ln185">            return QModelIndex();</a>
<a name="ln186"> </a>
<a name="ln187">      if (!parent.isValid())</a>
<a name="ln188">            return createIndex(row, column, const_cast&lt;void*&gt;(static_cast&lt;const void*&gt;(_paletteTree.get())));</a>
<a name="ln189"> </a>
<a name="ln190">      void* iptr = parent.internalPointer();</a>
<a name="ln191"> </a>
<a name="ln192">      if (iptr == _paletteTree.get())</a>
<a name="ln193">            return createIndex(row, column, palettes()[parent.row()].get());</a>
<a name="ln194"> </a>
<a name="ln195">      return QModelIndex();</a>
<a name="ln196">      }</a>
<a name="ln197"> </a>
<a name="ln198">//---------------------------------------------------------</a>
<a name="ln199">//   PaletteTreeModel::parent</a>
<a name="ln200">//---------------------------------------------------------</a>
<a name="ln201"> </a>
<a name="ln202">QModelIndex PaletteTreeModel::parent(const QModelIndex&amp; modelIndex) const</a>
<a name="ln203">      {</a>
<a name="ln204">      void* iptr = modelIndex.internalPointer();</a>
<a name="ln205"> </a>
<a name="ln206">      if (iptr == _paletteTree.get())</a>
<a name="ln207">            return QModelIndex();</a>
<a name="ln208"> </a>
<a name="ln209">      int row;</a>
<a name="ln210">      if (iptrToPalettePanel(iptr, &amp;row))</a>
<a name="ln211">            return index(row, /* column */ 0, QModelIndex());</a>
<a name="ln212"> </a>
<a name="ln213">      return QModelIndex();</a>
<a name="ln214">      }</a>
<a name="ln215"> </a>
<a name="ln216">//---------------------------------------------------------</a>
<a name="ln217">//   PaletteTreeModel::rowCount</a>
<a name="ln218">//---------------------------------------------------------</a>
<a name="ln219"> </a>
<a name="ln220">int PaletteTreeModel::rowCount(const QModelIndex&amp; parent) const</a>
<a name="ln221">      {</a>
<a name="ln222">      if (!parent.isValid())</a>
<a name="ln223">            return int(palettes().size());</a>
<a name="ln224"> </a>
<a name="ln225">      void* iptr = parent.internalPointer();</a>
<a name="ln226"> </a>
<a name="ln227">      if (iptr == _paletteTree.get()) {</a>
<a name="ln228">            const int row = parent.row();</a>
<a name="ln229">            if (parent.column() != 0 || row &lt; 0 || row &gt;= int(palettes().size()))</a>
<a name="ln230">                  return 0;</a>
<a name="ln231">            return palettes()[row]-&gt;ncells();</a>
<a name="ln232">            }</a>
<a name="ln233"> </a>
<a name="ln234">      return 0;</a>
<a name="ln235">      }</a>
<a name="ln236"> </a>
<a name="ln237">//---------------------------------------------------------</a>
<a name="ln238">//   PaletteTreeModel::columnCount</a>
<a name="ln239">//---------------------------------------------------------</a>
<a name="ln240"> </a>
<a name="ln241">int PaletteTreeModel::columnCount(const QModelIndex&amp; parent) const</a>
<a name="ln242">      {</a>
<a name="ln243">      Q_UNUSED(parent);</a>
<a name="ln244">      return 1;</a>
<a name="ln245">      }</a>
<a name="ln246"> </a>
<a name="ln247">//---------------------------------------------------------</a>
<a name="ln248">//   PaletteTreeModel::data</a>
<a name="ln249">//---------------------------------------------------------</a>
<a name="ln250"> </a>
<a name="ln251">QVariant PaletteTreeModel::data(const QModelIndex&amp; index, int role) const</a>
<a name="ln252">      {</a>
<a name="ln253">      if (const PalettePanel* pp = findPalettePanel(index)) {</a>
<a name="ln254">            switch (role) {</a>
<a name="ln255">                  case Qt::DisplayRole:</a>
<a name="ln256">                  case Qt::ToolTipRole:</a>
<a name="ln257">                        return pp-&gt;translatedName();</a>
<a name="ln258">                  case Qt::AccessibleTextRole:</a>
<a name="ln259">                        return QString(&quot;%1 palette&quot;).arg(pp-&gt;translatedName());</a>
<a name="ln260">                  case VisibleRole:</a>
<a name="ln261">                        return pp-&gt;visible();</a>
<a name="ln262">                  case CustomRole:</a>
<a name="ln263">                        return pp-&gt;custom();</a>
<a name="ln264">                  case EditableRole:</a>
<a name="ln265">                        return pp-&gt;editable();</a>
<a name="ln266">                  case GridSizeRole:</a>
<a name="ln267">                        return pp-&gt;gridSize() * Palette::guiMag();</a>
<a name="ln268">                  case DrawGridRole:</a>
<a name="ln269">                        return pp-&gt;drawGrid();</a>
<a name="ln270">                  case PaletteExpandedRole:</a>
<a name="ln271">                        return pp-&gt;expanded();</a>
<a name="ln272">                  // TODO showMore?</a>
<a name="ln273">                  case PaletteTypeRole:</a>
<a name="ln274">                        return QVariant::fromValue(pp-&gt;type());</a>
<a name="ln275">                  case PaletteContentTypeRole:</a>
<a name="ln276">                        return QVariant::fromValue(pp-&gt;contentType());</a>
<a name="ln277">                  }</a>
<a name="ln278">            return QVariant();</a>
<a name="ln279">            }</a>
<a name="ln280"> </a>
<a name="ln281">      if (PaletteCellConstPtr cell = findCell(index)) {</a>
<a name="ln282">            switch (role) {</a>
<a name="ln283">                  case Qt::DisplayRole:</a>
<a name="ln284">                        return QVariant(); // Don't show element names in</a>
<a name="ln285">                        // item views (i.e. just show icons). If you need</a>
<a name="ln286">                        // to know the name, use the ToolTip instead.</a>
<a name="ln287">                  case Qt::ToolTipRole:</a>
<a name="ln288">                        return cell-&gt;translatedName();</a>
<a name="ln289">                  case Qt::AccessibleTextRole: {</a>
<a name="ln290">                        QString name = cell-&gt;translatedName();</a>
<a name="ln291">                        ScoreAccessibility::makeReadable(name);</a>
<a name="ln292">                        return name;</a>
<a name="ln293">                        }</a>
<a name="ln294">                  case Qt::DecorationRole: {</a>
<a name="ln295">                        qreal extraMag = 1.0;</a>
<a name="ln296">                        if (const PalettePanel* pp = iptrToPalettePanel(index.internalPointer()))</a>
<a name="ln297">                              extraMag = pp-&gt;mag();</a>
<a name="ln298">                        return QIcon(new PaletteCellIconEngine(cell, extraMag * Palette::guiMag()));</a>
<a name="ln299">                        }</a>
<a name="ln300">                  case PaletteCellRole:</a>
<a name="ln301">                        return QVariant::fromValue(cell.get());</a>
<a name="ln302">                  case VisibleRole:</a>
<a name="ln303">                        return cell-&gt;visible;</a>
<a name="ln304">                  case CustomRole:</a>
<a name="ln305">                        return cell-&gt;custom;</a>
<a name="ln306">                  case EditableRole: {</a>
<a name="ln307">                        if (const PalettePanel* pp = iptrToPalettePanel(index.internalPointer()))</a>
<a name="ln308">                              return pp-&gt;editable();</a>
<a name="ln309">                        return false;</a>
<a name="ln310">                        }</a>
<a name="ln311">                  case MimeDataRole: {</a>
<a name="ln312">                        QVariantMap map;</a>
<a name="ln313">                        if (cell-&gt;element)</a>
<a name="ln314">                              map[mimeSymbolFormat] = cell-&gt;element-&gt;mimeData(QPointF());</a>
<a name="ln315">                        map[PaletteCell::mimeDataFormat] = cell-&gt;mimeData();</a>
<a name="ln316">                        return map;</a>
<a name="ln317">                        }</a>
<a name="ln318">                  case CellActiveRole:</a>
<a name="ln319">                        return cell-&gt;active;</a>
<a name="ln320">                  default:</a>
<a name="ln321">                        break;</a>
<a name="ln322">                  }</a>
<a name="ln323">            return QVariant();</a>
<a name="ln324">            }</a>
<a name="ln325"> </a>
<a name="ln326">      // data for root item</a>
<a name="ln327">      switch (role) {</a>
<a name="ln328">            case EditableRole:</a>
<a name="ln329">                  return true;</a>
<a name="ln330">            default:</a>
<a name="ln331">                  break;</a>
<a name="ln332">            }</a>
<a name="ln333"> </a>
<a name="ln334">      return QVariant();</a>
<a name="ln335">      }</a>
<a name="ln336"> </a>
<a name="ln337">//---------------------------------------------------------</a>
<a name="ln338">//   PaletteTreeModel::setData</a>
<a name="ln339">//---------------------------------------------------------</a>
<a name="ln340"> </a>
<a name="ln341">bool PaletteTreeModel::setData(const QModelIndex&amp; index, const QVariant&amp; value, int role)</a>
<a name="ln342">      {</a>
<a name="ln343">      if (PalettePanel* pp = findPalettePanel(index)) {</a>
<a name="ln344">            switch (role) {</a>
<a name="ln345">                  case VisibleRole:</a>
<a name="ln346">                        if (value.canConvert&lt;bool&gt;()) {</a>
<a name="ln347">                              const bool val = value.toBool();</a>
<a name="ln348">                              if (val != pp-&gt;visible()) {</a>
<a name="ln349">                                    pp-&gt;setVisible(val);</a>
<a name="ln350">                                    emit dataChanged(index, index, { VisibleRole });</a>
<a name="ln351">                                    }</a>
<a name="ln352">                              return true;</a>
<a name="ln353">                              }</a>
<a name="ln354">                        return false;</a>
<a name="ln355">                  case EditableRole:</a>
<a name="ln356">                        if (value.canConvert&lt;bool&gt;()) {</a>
<a name="ln357">                              const bool val = value.toBool();</a>
<a name="ln358">                              if (val != pp-&gt;editable()) {</a>
<a name="ln359">                                    pp-&gt;setEditable(val);</a>
<a name="ln360">                                    emit dataChanged(index, index, { EditableRole });</a>
<a name="ln361">                                    // notify cells editability changed too</a>
<a name="ln362">                                    const QModelIndex childFirstIndex = PaletteTreeModel::index(0, 0, index);</a>
<a name="ln363">                                    const int rows = rowCount(index);</a>
<a name="ln364">                                    const QModelIndex childLastIndex = PaletteTreeModel::index(rows - 1, 0, index);</a>
<a name="ln365">                                    emit dataChanged(childFirstIndex, childLastIndex, { EditableRole });</a>
<a name="ln366">                              }</a>
<a name="ln367">                              return true;</a>
<a name="ln368">                        }</a>
<a name="ln369">                        return false;</a>
<a name="ln370">                  case PaletteExpandedRole:</a>
<a name="ln371">                        if (value.canConvert&lt;bool&gt;()) {</a>
<a name="ln372">                              const bool val = value.toBool();</a>
<a name="ln373">                              if (val != pp-&gt;expanded()) {</a>
<a name="ln374">                                    const bool singlePalette = preferences.getBool(PREF_APP_USESINGLEPALETTE);</a>
<a name="ln375"> </a>
<a name="ln376">                                    if (singlePalette &amp;&amp; val) {</a>
<a name="ln377">                                          for (auto&amp; palette : palettes())</a>
<a name="ln378">                                                palette-&gt;setExpanded(false);</a>
<a name="ln379">                                          pp-&gt;setExpanded(val);</a>
<a name="ln380"> </a>
<a name="ln381">                                          const QModelIndex parent = index.parent();</a>
<a name="ln382">                                          const int rows = rowCount(parent);</a>
<a name="ln383">                                          const QModelIndex first = PaletteTreeModel::index(0, 0, parent);</a>
<a name="ln384">                                          const QModelIndex last = PaletteTreeModel::index(rows - 1, 0, parent);</a>
<a name="ln385">                                          emit dataChanged(first, last, { PaletteExpandedRole });</a>
<a name="ln386">                                          }</a>
<a name="ln387">                                    else {</a>
<a name="ln388">                                          pp-&gt;setExpanded(val);</a>
<a name="ln389">                                          emit dataChanged(index, index, { PaletteExpandedRole });</a>
<a name="ln390">                                          }</a>
<a name="ln391">                                    }</a>
<a name="ln392">                              return true;</a>
<a name="ln393">                              }</a>
<a name="ln394">                        return false;</a>
<a name="ln395">                  case Qt::DisplayRole:</a>
<a name="ln396">                        pp-&gt;setName(value.toString());</a>
<a name="ln397">                        emit dataChanged(index, index, { Qt::DisplayRole, Qt::AccessibleTextRole });</a>
<a name="ln398">                        return true;</a>
<a name="ln399">//                   case CustomRole:</a>
<a name="ln400">//                         if (value.canConvert&lt;bool&gt;()) {</a>
<a name="ln401">//                               const bool val = value.toBool();</a>
<a name="ln402">//                               if (val != pp-&gt;custom()) {</a>
<a name="ln403">//                                     pp-&gt;setCustom(val);</a>
<a name="ln404">//                                     emit dataChanged(index, index, { CustomRole });</a>
<a name="ln405">//                                     }</a>
<a name="ln406">//                               return true;</a>
<a name="ln407">//                               }</a>
<a name="ln408">//                         return false;</a>
<a name="ln409">//                   case gridSizeRole:</a>
<a name="ln410">//                         return pp-&gt;gridSize();</a>
<a name="ln411">//                   case drawGridRole:</a>
<a name="ln412">//                         return pp-&gt;drawGrid();</a>
<a name="ln413">                  default:</a>
<a name="ln414">                        break;</a>
<a name="ln415">                  }</a>
<a name="ln416">            return false;</a>
<a name="ln417">            }</a>
<a name="ln418"> </a>
<a name="ln419">      if (PaletteCellPtr cell = findCell(index)) {</a>
<a name="ln420">            switch (role) {</a>
<a name="ln421">//                   case Qt::DisplayRole:</a>
<a name="ln422">//                   case Qt::ToolTipRole:</a>
<a name="ln423">                  // or EditRole?</a>
<a name="ln424">//                         return cell-&gt;name;</a>
<a name="ln425">                  case PaletteCellRole: {</a>
<a name="ln426">                        PaletteCell* newCell = value.value&lt;PaletteCell*&gt;();</a>
<a name="ln427">                        if (!newCell)</a>
<a name="ln428">                              return false;</a>
<a name="ln429">                        *cell = std::move(*newCell);</a>
<a name="ln430">                        emit dataChanged(index, index);</a>
<a name="ln431">                        return true;</a>
<a name="ln432">                        };</a>
<a name="ln433">                  case VisibleRole:</a>
<a name="ln434">                        if (value.canConvert&lt;bool&gt;()) {</a>
<a name="ln435">                              const bool val = value.toBool();</a>
<a name="ln436">                              if (val != cell-&gt;visible) {</a>
<a name="ln437">                                    cell-&gt;visible = val;</a>
<a name="ln438">                                    emit dataChanged(index, index, { VisibleRole });</a>
<a name="ln439">                                    }</a>
<a name="ln440">                              return true;</a>
<a name="ln441">                              }</a>
<a name="ln442">                        return false;</a>
<a name="ln443">                  case CustomRole:</a>
<a name="ln444">                        if (value.canConvert&lt;bool&gt;()) {</a>
<a name="ln445">                              const bool val = value.toBool();</a>
<a name="ln446">                              if (val != cell-&gt;custom) {</a>
<a name="ln447">                                    cell-&gt;custom = val;</a>
<a name="ln448">                                    emit dataChanged(index, index, { CustomRole });</a>
<a name="ln449">                                    }</a>
<a name="ln450">                              return true;</a>
<a name="ln451">                              }</a>
<a name="ln452">                        return false;</a>
<a name="ln453">                  case MimeDataRole: {</a>
<a name="ln454">                        const QVariantMap map = value.toMap();</a>
<a name="ln455"> </a>
<a name="ln456">                        if (map.contains(PaletteCell::mimeDataFormat)) {</a>
<a name="ln457">                              const QByteArray cellMimeData = map[PaletteCell::mimeDataFormat].toByteArray();</a>
<a name="ln458">                              PaletteCellPtr newCell(PaletteCell::readMimeData(cellMimeData));</a>
<a name="ln459">                              if (!newCell)</a>
<a name="ln460">                                    return false;</a>
<a name="ln461">                              *cell = std::move(*newCell);</a>
<a name="ln462">                              }</a>
<a name="ln463">                        else if (map.contains(mimeSymbolFormat)) {</a>
<a name="ln464">                              const QByteArray elementMimeData = map[mimeSymbolFormat].toByteArray();</a>
<a name="ln465">                              *cell = std::move(*PaletteCell::readElementMimeData(elementMimeData));</a>
<a name="ln466">                              cell-&gt;custom = true; // mark the updated cell custom</a>
<a name="ln467">                              }</a>
<a name="ln468">                        else {</a>
<a name="ln469">                              return false;</a>
<a name="ln470">                              }</a>
<a name="ln471"> </a>
<a name="ln472">                        emit dataChanged(index, index);</a>
<a name="ln473">                        return true;</a>
<a name="ln474">                        }</a>
<a name="ln475">                  default:</a>
<a name="ln476">                        break;</a>
<a name="ln477">                  }</a>
<a name="ln478">            return false;</a>
<a name="ln479">            }</a>
<a name="ln480"> </a>
<a name="ln481">      return false;</a>
<a name="ln482">      }</a>
<a name="ln483"> </a>
<a name="ln484">//---------------------------------------------------------</a>
<a name="ln485">//   PaletteTreeModel::roleNames</a>
<a name="ln486">//---------------------------------------------------------</a>
<a name="ln487"> </a>
<a name="ln488">QHash&lt;int, QByteArray&gt; PaletteTreeModel::roleNames() const</a>
<a name="ln489">      {</a>
<a name="ln490">      QHash&lt;int, QByteArray&gt; roles(QAbstractItemModel::roleNames());</a>
<a name="ln491">      roles[MimeDataRole] = &quot;mimeData&quot;;</a>
<a name="ln492">      roles[GridSizeRole] = &quot;gridSize&quot;;</a>
<a name="ln493">      roles[DrawGridRole] = &quot;drawGrid&quot;;</a>
<a name="ln494">      roles[CustomRole] = &quot;custom&quot;;</a>
<a name="ln495">      roles[EditableRole] = &quot;editable&quot;;</a>
<a name="ln496">      roles[PaletteExpandedRole] = &quot;expanded&quot;;</a>
<a name="ln497">      roles[CellActiveRole] = &quot;cellActive&quot;;</a>
<a name="ln498">      roles[Qt::AccessibleTextRole] = &quot;accessibleText&quot;;</a>
<a name="ln499">      return roles;</a>
<a name="ln500">      }</a>
<a name="ln501"> </a>
<a name="ln502">//---------------------------------------------------------</a>
<a name="ln503">//   PaletteTreeModel::flags</a>
<a name="ln504">//---------------------------------------------------------</a>
<a name="ln505"> </a>
<a name="ln506">Qt::ItemFlags PaletteTreeModel::flags(const QModelIndex&amp; index) const</a>
<a name="ln507">      {</a>
<a name="ln508">      return QAbstractItemModel::flags(index) | Qt::ItemIsDragEnabled;</a>
<a name="ln509">      }</a>
<a name="ln510"> </a>
<a name="ln511">//---------------------------------------------------------</a>
<a name="ln512">//   PaletteTreeModel::supportedDropActions</a>
<a name="ln513">//---------------------------------------------------------</a>
<a name="ln514"> </a>
<a name="ln515">Qt::DropActions PaletteTreeModel::supportedDropActions() const</a>
<a name="ln516">      {</a>
<a name="ln517">      return Qt::DropActions(Qt::CopyAction | Qt::MoveAction);</a>
<a name="ln518">      }</a>
<a name="ln519"> </a>
<a name="ln520">//---------------------------------------------------------</a>
<a name="ln521">//   PaletteTreeModel::mimeData</a>
<a name="ln522">//---------------------------------------------------------</a>
<a name="ln523"> </a>
<a name="ln524">QMimeData* PaletteTreeModel::mimeData(const QModelIndexList&amp; indexes) const</a>
<a name="ln525">      {</a>
<a name="ln526">      QMimeData* mime = QAbstractItemModel::mimeData(indexes); // TODO: needed or use only &quot;our&quot; MIME data?</a>
<a name="ln527"> </a>
<a name="ln528">      if (indexes.empty() || indexes.size() &gt; 1)</a>
<a name="ln529">            return mime;</a>
<a name="ln530"> </a>
<a name="ln531">      if (const PalettePanel* pp = findPalettePanel(indexes[0])) {</a>
<a name="ln532">            mime-&gt;setData(PalettePanel::mimeDataFormat, pp-&gt;mimeData());</a>
<a name="ln533">            }</a>
<a name="ln534">      else if (PaletteCellConstPtr cell = findCell(indexes[0])) {</a>
<a name="ln535">            mime-&gt;setData(mimeSymbolFormat, cell-&gt;element-&gt;mimeData(QPointF()));</a>
<a name="ln536">            }</a>
<a name="ln537"> </a>
<a name="ln538">      return mime;</a>
<a name="ln539">      }</a>
<a name="ln540"> </a>
<a name="ln541">//---------------------------------------------------------</a>
<a name="ln542">//   PaletteTreeModel::mimeTypes</a>
<a name="ln543">//---------------------------------------------------------</a>
<a name="ln544"> </a>
<a name="ln545">QStringList PaletteTreeModel::mimeTypes() const</a>
<a name="ln546">      {</a>
<a name="ln547">      QStringList types = QAbstractItemModel::mimeTypes();</a>
<a name="ln548">      types &lt;&lt; mimeSymbolFormat;</a>
<a name="ln549">      return types;</a>
<a name="ln550">      }</a>
<a name="ln551"> </a>
<a name="ln552">//---------------------------------------------------------</a>
<a name="ln553">//   PaletteTreeModel::canDropMimeData</a>
<a name="ln554">//---------------------------------------------------------</a>
<a name="ln555"> </a>
<a name="ln556">bool PaletteTreeModel::canDropMimeData(const QMimeData* data, Qt::DropAction action, int row, int column, const QModelIndex&amp; parent) const</a>
<a name="ln557">      {</a>
<a name="ln558">      Q_UNUSED(column);</a>
<a name="ln559"> </a>
<a name="ln560">      if (!parent.isValid())</a>
<a name="ln561">            return (action == Qt::CopyAction) &amp;&amp; data-&gt;hasFormat(PalettePanel::mimeDataFormat);</a>
<a name="ln562"> </a>
<a name="ln563">      if (const PalettePanel* pp = findPalettePanel(parent)) {</a>
<a name="ln564">            if (row &lt; 0 || row &gt; pp-&gt;ncells())</a>
<a name="ln565">                  return false;</a>
<a name="ln566"> </a>
<a name="ln567">            if (data-&gt;hasFormat(PaletteCell::mimeDataFormat))</a>
<a name="ln568">                  return action &amp; (Qt::CopyAction | Qt::MoveAction);</a>
<a name="ln569">            else if (data-&gt;hasFormat(mimeSymbolFormat))</a>
<a name="ln570">                  return action == Qt::CopyAction;</a>
<a name="ln571">            }</a>
<a name="ln572">      return false;</a>
<a name="ln573">      }</a>
<a name="ln574"> </a>
<a name="ln575">//---------------------------------------------------------</a>
<a name="ln576">//   PaletteTreeModel::dropMimeData</a>
<a name="ln577">//---------------------------------------------------------</a>
<a name="ln578"> </a>
<a name="ln579">bool PaletteTreeModel::dropMimeData(const QMimeData* data, Qt::DropAction action, int row, int column, const QModelIndex&amp; parent)</a>
<a name="ln580">      {</a>
<a name="ln581">      Q_UNUSED(column); // when dropping at the end of palette, column == -1. Probably an effect of proxy models</a>
<a name="ln582"> </a>
<a name="ln583">      if (!parent.isValid()) {</a>
<a name="ln584">            if (action != Qt::CopyAction || !data-&gt;hasFormat(PalettePanel::mimeDataFormat))</a>
<a name="ln585">                  return false;</a>
<a name="ln586">            if (row &lt; 0 || row &gt; int(palettes().size()))</a>
<a name="ln587">                  return false;</a>
<a name="ln588"> </a>
<a name="ln589">            auto panel = PalettePanel::readMimeData(data-&gt;data(PalettePanel::mimeDataFormat));</a>
<a name="ln590">            if (!panel)</a>
<a name="ln591">                  return false;</a>
<a name="ln592"> </a>
<a name="ln593">            beginInsertRows(parent, row, row);</a>
<a name="ln594">            palettes().insert(palettes().begin() + row, std::move(panel));</a>
<a name="ln595">            endInsertRows();</a>
<a name="ln596">            return true;</a>
<a name="ln597">            }</a>
<a name="ln598"> </a>
<a name="ln599">      if (PalettePanel* pp = findPalettePanel(parent)) {</a>
<a name="ln600">            if (row &lt; 0 || row &gt; pp-&gt;ncells())</a>
<a name="ln601">                  return false;</a>
<a name="ln602"> </a>
<a name="ln603">            PaletteCellPtr cell;</a>
<a name="ln604"> </a>
<a name="ln605">            if (data-&gt;hasFormat(PaletteCell::mimeDataFormat)) {</a>
<a name="ln606">                  cell = PaletteCell::readMimeData(data-&gt;data(PaletteCell::mimeDataFormat));</a>
<a name="ln607">                  if (action == Qt::CopyAction)</a>
<a name="ln608">                        cell-&gt;custom = true;</a>
<a name="ln609">                  }</a>
<a name="ln610">            else if (data-&gt;hasFormat(mimeSymbolFormat)) {</a>
<a name="ln611">                  cell = PaletteCell::readElementMimeData(data-&gt;data(mimeSymbolFormat));</a>
<a name="ln612">                  cell-&gt;custom = true; // the cell is created by dropping an element so it is custom</a>
<a name="ln613">                  }</a>
<a name="ln614"> </a>
<a name="ln615">            if (!cell)</a>
<a name="ln616">                  return false;</a>
<a name="ln617"> </a>
<a name="ln618">            beginInsertRows(parent, row, row);</a>
<a name="ln619">            pp-&gt;insertCell(row, std::move(cell));</a>
<a name="ln620">            endInsertRows();</a>
<a name="ln621">            return true;</a>
<a name="ln622">            }</a>
<a name="ln623">      return false;</a>
<a name="ln624">      }</a>
<a name="ln625"> </a>
<a name="ln626">//---------------------------------------------------------</a>
<a name="ln627">//   PaletteTreeModel::moveRows</a>
<a name="ln628">//---------------------------------------------------------</a>
<a name="ln629"> </a>
<a name="ln630">bool PaletteTreeModel::moveRows(const QModelIndex&amp; sourceParent, int sourceRow, int count, const QModelIndex&amp; destinationParent, int destinationChild)</a>
<a name="ln631">      {</a>
<a name="ln632">      const bool sameParent = sourceParent == destinationParent;</a>
<a name="ln633"> </a>
<a name="ln634">      if (!sourceParent.isValid()) {</a>
<a name="ln635">            // moving palette panels</a>
<a name="ln636">            if (sourceRow + count &gt; int(palettes().size()) || destinationChild &gt;= int(palettes().size()))</a>
<a name="ln637">                  return false;</a>
<a name="ln638"> </a>
<a name="ln639">            if (!sameParent) {</a>
<a name="ln640">                  // Cannot move between different parents, at least for now</a>
<a name="ln641">                  // TODO: reconsider?</a>
<a name="ln642">                  return false;</a>
<a name="ln643">                  }</a>
<a name="ln644"> </a>
<a name="ln645">            // The moved rows are considered to be inserted *before* destinationRow,</a>
<a name="ln646">            // so if we want to move a row down in the list within the same parent</a>
<a name="ln647">            // then we should increment the destinationChild index.</a>
<a name="ln648">            const int destinationRow = (destinationChild &gt;= sourceRow) ? destinationChild + 1 : destinationChild;</a>
<a name="ln649"> </a>
<a name="ln650">            if (sameParent &amp;&amp; sourceRow == destinationRow)</a>
<a name="ln651">                return false;</a>
<a name="ln652"> </a>
<a name="ln653">            std::vector&lt;std::unique_ptr&lt;PalettePanel&gt;&gt; movedPanels;</a>
<a name="ln654"> </a>
<a name="ln655">            auto srcBegin = palettes().begin() + sourceRow;</a>
<a name="ln656">            auto srcEnd = srcBegin + count;</a>
<a name="ln657"> </a>
<a name="ln658">            // As of Qt 5.12, Qt proxy models rebuild the entire index mapping if</a>
<a name="ln659">            // layoutChanged() gets emitted (i.e. if begin/endMoveRows() gets called).</a>
<a name="ln660">            // Performance is much better when doing remove + insert rows instead.</a>
<a name="ln661">            beginRemoveRows(sourceParent, sourceRow, sourceRow + count - 1);</a>
<a name="ln662">            movedPanels.reserve(count);</a>
<a name="ln663">            movedPanels.insert(movedPanels.end(), std::make_move_iterator(srcBegin), std::make_move_iterator(srcEnd));</a>
<a name="ln664">            palettes().erase(srcBegin, srcEnd);</a>
<a name="ln665">            endRemoveRows();</a>
<a name="ln666"> </a>
<a name="ln667">            const int destIdx = (destinationRow &lt; sourceRow) ? destinationRow : (destinationRow - count);</a>
<a name="ln668">            auto dest = palettes().begin() + destIdx;</a>
<a name="ln669"> </a>
<a name="ln670">            beginInsertRows(destinationParent, destIdx, destIdx + count - 1);</a>
<a name="ln671">            palettes().insert(dest, std::make_move_iterator(movedPanels.begin()), std::make_move_iterator(movedPanels.end()));</a>
<a name="ln672">            endInsertRows();</a>
<a name="ln673"> </a>
<a name="ln674">            return true;</a>
<a name="ln675">            }</a>
<a name="ln676"> </a>
<a name="ln677">      PalettePanel* sourcePanel = findPalettePanel(sourceParent);</a>
<a name="ln678">      PalettePanel* destPanel = sameParent ? sourcePanel : findPalettePanel(destinationParent);</a>
<a name="ln679">      if (sourcePanel &amp;&amp; destPanel) {</a>
<a name="ln680">            // moving palette cells</a>
<a name="ln681">            if (sourceRow + count &gt; sourcePanel-&gt;ncells() || destinationChild &gt; destPanel-&gt;ncells())</a>
<a name="ln682">                  return false;</a>
<a name="ln683"> </a>
<a name="ln684">            // The moved rows are considered to be inserted *before* destinationRow,</a>
<a name="ln685">            // so if we want to move a row down in the list within the same parent</a>
<a name="ln686">            // then we should increment the destinationChild index.</a>
<a name="ln687">            const int destinationRow = (sameParent &amp;&amp; destinationChild &gt;= sourceRow) ? destinationChild + 1 : destinationChild;</a>
<a name="ln688"> </a>
<a name="ln689">            if (sameParent &amp;&amp; sourceRow == destinationRow)</a>
<a name="ln690">                return false;</a>
<a name="ln691"> </a>
<a name="ln692">            // As of Qt 5.12, Qt proxy models rebuild the entire index mapping if</a>
<a name="ln693">            // layoutChanged() gets emitted (i.e. if begin/endMoveRows() gets called).</a>
<a name="ln694">            // Performance is much better when doing remove + insert rows instead.</a>
<a name="ln695">            beginRemoveRows(sourceParent, sourceRow, sourceRow + count - 1);</a>
<a name="ln696">            auto movedCells(sourcePanel-&gt;takeCells(sourceRow, count));</a>
<a name="ln697">            endRemoveRows();</a>
<a name="ln698"> </a>
<a name="ln699">            const int destIdx = (sameParent &amp;&amp; destinationRow &gt;= sourceRow) ? (destinationRow - count) : destinationRow;</a>
<a name="ln700"> </a>
<a name="ln701">            beginInsertRows(destinationParent, destIdx, destIdx + count - 1);</a>
<a name="ln702">            destPanel-&gt;insertCells(destIdx, std::move(movedCells));</a>
<a name="ln703">            endInsertRows();</a>
<a name="ln704"> </a>
<a name="ln705">            return true;</a>
<a name="ln706">            }</a>
<a name="ln707"> </a>
<a name="ln708">      return false;</a>
<a name="ln709">      }</a>
<a name="ln710"> </a>
<a name="ln711">//---------------------------------------------------------</a>
<a name="ln712">//   PaletteTreeModel::removeRows</a>
<a name="ln713">//---------------------------------------------------------</a>
<a name="ln714"> </a>
<a name="ln715">bool PaletteTreeModel::removeRows(int row, int count, const QModelIndex&amp; parent)</a>
<a name="ln716">      {</a>
<a name="ln717">      if (!parent.isValid()) {</a>
<a name="ln718">            // removing palette panels</a>
<a name="ln719">            if (row &lt; 0 || row + count &gt; int(palettes().size()))</a>
<a name="ln720">                  return false;</a>
<a name="ln721"> </a>
<a name="ln722">            beginRemoveRows(parent, row, row + count - 1);</a>
<a name="ln723">            auto rangeBegin = palettes().begin() + row;</a>
<a name="ln724">            auto rangeEnd = rangeBegin + count;</a>
<a name="ln725">            palettes().erase(rangeBegin, rangeEnd);</a>
<a name="ln726">            endRemoveRows();</a>
<a name="ln727">            return true;</a>
<a name="ln728">            }</a>
<a name="ln729"> </a>
<a name="ln730">      if (PalettePanel* panel = findPalettePanel(parent)) {</a>
<a name="ln731">            // removing palette cells</a>
<a name="ln732">            if (row &lt; 0 || row + count &gt; panel-&gt;ncells())</a>
<a name="ln733">                  return false;</a>
<a name="ln734"> </a>
<a name="ln735">            beginRemoveRows(parent, row, row + count - 1);</a>
<a name="ln736">            panel-&gt;takeCells(row, count);</a>
<a name="ln737">            endRemoveRows();</a>
<a name="ln738">            return true;</a>
<a name="ln739">            }</a>
<a name="ln740"> </a>
<a name="ln741">      return false;</a>
<a name="ln742">      }</a>
<a name="ln743"> </a>
<a name="ln744">//---------------------------------------------------------</a>
<a name="ln745">//   PaletteTreeModel::insertRows</a>
<a name="ln746">//---------------------------------------------------------</a>
<a name="ln747"> </a>
<a name="ln748">bool PaletteTreeModel::insertRows(int row, int count, const QModelIndex&amp; parent)</a>
<a name="ln749">      {</a>
<a name="ln750">      if (!parent.isValid()) {</a>
<a name="ln751">            // inserting palette panels</a>
<a name="ln752">            if (row &lt; 0 || row &gt; int(palettes().size()))</a>
<a name="ln753">                  return false;</a>
<a name="ln754"> </a>
<a name="ln755">            beginInsertRows(parent, row, row + count - 1);</a>
<a name="ln756">            for (int i = 0; i &lt; count; ++i) {</a>
<a name="ln757">                  std::unique_ptr&lt;PalettePanel&gt; p(new PalettePanel(PalettePanel::Type::Custom));</a>
<a name="ln758">                  p-&gt;setName(QT_TRANSLATE_NOOP(&quot;Palette&quot;, &quot;Custom&quot;));</a>
<a name="ln759">                  p-&gt;setGrid(QSize(48, 48));</a>
<a name="ln760">                  p-&gt;setExpanded(true);</a>
<a name="ln761">                  palettes().insert(palettes().begin() + row, std::move(p));</a>
<a name="ln762">                  }</a>
<a name="ln763">            endInsertRows();</a>
<a name="ln764">            return true;</a>
<a name="ln765">            }</a>
<a name="ln766"> </a>
<a name="ln767">      if (PalettePanel* panel = findPalettePanel(parent)) {</a>
<a name="ln768">            // inserting palette cells</a>
<a name="ln769">            if (row &lt; 0 || row &gt; panel-&gt;ncells())</a>
<a name="ln770">                  return false;</a>
<a name="ln771"> </a>
<a name="ln772">            beginInsertRows(parent, row, row + count - 1);</a>
<a name="ln773">            for (int i = 0; i &lt; count; ++i)</a>
<a name="ln774">                  panel-&gt;insertCell(row, PaletteCellPtr(new PaletteCell));</a>
<a name="ln775">            endInsertRows();</a>
<a name="ln776">            return true;</a>
<a name="ln777">            }</a>
<a name="ln778"> </a>
<a name="ln779">      return false;</a>
<a name="ln780">      }</a>
<a name="ln781"> </a>
<a name="ln782">//---------------------------------------------------------</a>
<a name="ln783">//   PaletteTreeModel::insertPalettePanel</a>
<a name="ln784">//---------------------------------------------------------</a>
<a name="ln785"> </a>
<a name="ln786">bool PaletteTreeModel::insertPalettePanel(std::unique_ptr&lt;PalettePanel&gt; pp, int row, const QModelIndex&amp; parent)</a>
<a name="ln787">      {</a>
<a name="ln788">      if (row &lt; 0 || row &gt; int(palettes().size()) || parent != QModelIndex())</a>
<a name="ln789">            return false;</a>
<a name="ln790">      beginInsertRows(parent, row, row);</a>
<a name="ln791">      palettes().insert(palettes().begin() + row, std::move(pp));</a>
<a name="ln792">      endInsertRows();</a>
<a name="ln793">      return true;</a>
<a name="ln794">      }</a>
<a name="ln795"> </a>
<a name="ln796">//---------------------------------------------------------</a>
<a name="ln797">//   PaletteTreeModel::updateCellsState</a>
<a name="ln798">//---------------------------------------------------------</a>
<a name="ln799"> </a>
<a name="ln800">void PaletteTreeModel::updateCellsState(const Selection&amp; sel)</a>
<a name="ln801">      {</a>
<a name="ln802">      const ChordRest* cr = sel.firstChordRest();</a>
<a name="ln803">      const Beam::Mode bm = cr ? cr-&gt;beamMode() : Beam::Mode::NONE;</a>
<a name="ln804">      const IconType beamIconType = Beam::iconType(bm);</a>
<a name="ln805">      bool deactivateAll = !cr;</a>
<a name="ln806"> </a>
<a name="ln807">      for (Element* e : sel.elements()) {</a>
<a name="ln808">            if (e-&gt;isNote())</a>
<a name="ln809">                  e = e-&gt;parent();</a>
<a name="ln810">            if (e-&gt;isChordRest()) {</a>
<a name="ln811">                  if (toChordRest(e)-&gt;beamMode() != bm)</a>
<a name="ln812">                        deactivateAll = true;</a>
<a name="ln813">                  }</a>
<a name="ln814">            }</a>
<a name="ln815"> </a>
<a name="ln816">      const size_t npalettes = palettes().size();</a>
<a name="ln817">      for (size_t row = 0; row &lt; npalettes; ++row) {</a>
<a name="ln818">            PalettePanel* palette = palettes()[row].get();</a>
<a name="ln819">            // TODO: should this be turned on for all palettes?</a>
<a name="ln820">            if (palette-&gt;type() != PalettePanel::Type::Beam)</a>
<a name="ln821">                  continue;</a>
<a name="ln822"> </a>
<a name="ln823">            for (int ci = 0; ci &lt; palette-&gt;ncells(); ++ci) {</a>
<a name="ln824">                  PaletteCellPtr cell = palette-&gt;cell(ci);</a>
<a name="ln825">                  if (deactivateAll)</a>
<a name="ln826">                        cell-&gt;active = false;</a>
<a name="ln827">                  else if (cell-&gt;element &amp;&amp; cell-&gt;element-&gt;isIcon()) {</a>
<a name="ln828">                        const Icon* icon = toIcon(cell-&gt;element.get());</a>
<a name="ln829">                        cell-&gt;active = (icon-&gt;iconType() == beamIconType);</a>
<a name="ln830">                        }</a>
<a name="ln831">                  }</a>
<a name="ln832"> </a>
<a name="ln833">            const QModelIndex parent = index(int(row), 0, QModelIndex());</a>
<a name="ln834">            const QModelIndex first = index(0, 0, parent);</a>
<a name="ln835">            const QModelIndex last = index(palette-&gt;ncells() - 1, 0, parent);</a>
<a name="ln836">            emit dataChanged(first, last, { CellActiveRole });</a>
<a name="ln837">            }</a>
<a name="ln838">      }</a>
<a name="ln839"> </a>
<a name="ln840">//---------------------------------------------------------</a>
<a name="ln841">//   PaletteTreeModel::retranslate</a>
<a name="ln842">//---------------------------------------------------------</a>
<a name="ln843"> </a>
<a name="ln844">void PaletteTreeModel::retranslate()</a>
<a name="ln845">      {</a>
<a name="ln846">      _paletteTree-&gt;retranslate();</a>
<a name="ln847">      }</a>
<a name="ln848"> </a>
<a name="ln849">//---------------------------------------------------------</a>
<a name="ln850">//   PaletteTreeModel::findPaletteCell</a>
<a name="ln851">//---------------------------------------------------------</a>
<a name="ln852"> </a>
<a name="ln853">QModelIndex PaletteTreeModel::findPaletteCell(const PaletteCell&amp; cell, const QModelIndex&amp; parent) const</a>
<a name="ln854">      {</a>
<a name="ln855">      if (const PalettePanel* pp = findPalettePanel(parent)) {</a>
<a name="ln856">            const int idx = pp-&gt;findPaletteCell(cell);</a>
<a name="ln857">            if (idx == -1)</a>
<a name="ln858">                  return QModelIndex();</a>
<a name="ln859">            return index(idx, /* column */ 0, parent);</a>
<a name="ln860">            }</a>
<a name="ln861">      return QModelIndex();</a>
<a name="ln862">      }</a>
<a name="ln863"> </a>
<a name="ln864">//---------------------------------------------------------</a>
<a name="ln865">//   PaletteTreeModel::match</a>
<a name="ln866">///   Currently only searching for a given palette cell is</a>
<a name="ln867">///   implemented, for anything else the corresponding</a>
<a name="ln868">///   member function of QAbstractItemModel is used.</a>
<a name="ln869">//---------------------------------------------------------</a>
<a name="ln870"> </a>
<a name="ln871">QModelIndexList PaletteTreeModel::match(const QModelIndex&amp; start, int role, const QVariant&amp; value, int hits, Qt::MatchFlags flags) const</a>
<a name="ln872">      {</a>
<a name="ln873">      if (role != PaletteCellRole || flags != Qt::MatchExactly || hits != 1</a>
<a name="ln874">         || !value.canConvert&lt;const PaletteCell*&gt;()</a>
<a name="ln875">         || !findPalettePanel(start.parent())</a>
<a name="ln876">         )</a>
<a name="ln877">            return QAbstractItemModel::match(start, role, value, hits, flags);</a>
<a name="ln878"> </a>
<a name="ln879">      const PaletteCell* cell = value.value&lt;const PaletteCell*&gt;();</a>
<a name="ln880">      if (!cell)</a>
<a name="ln881">            return QModelIndexList();</a>
<a name="ln882"> </a>
<a name="ln883">      return QModelIndexList({ findPaletteCell(*cell, start.parent()) });</a>
<a name="ln884">      }</a>
<a name="ln885"> </a>
<a name="ln886">//---------------------------------------------------------</a>
<a name="ln887">//   PaletteTreeModel::itemDataChanged</a>
<a name="ln888">//---------------------------------------------------------</a>
<a name="ln889"> </a>
<a name="ln890">void PaletteTreeModel::itemDataChanged(const QModelIndex&amp; idx)</a>
<a name="ln891">      {</a>
<a name="ln892">      emit dataChanged(idx, idx);</a>
<a name="ln893">      if (findPalettePanel(idx)) {</a>
<a name="ln894">            // palette cells appearance depends on palette settings</a>
<a name="ln895">            const QModelIndex childFirstIndex = index(0, 0, idx);</a>
<a name="ln896">            const int rows = rowCount(idx);</a>
<a name="ln897">            const QModelIndex childLastIndex = index(rows - 1, 0, idx);</a>
<a name="ln898">            emit dataChanged(childFirstIndex, childLastIndex, { Qt::DecorationRole });</a>
<a name="ln899">            }</a>
<a name="ln900">      }</a>
<a name="ln901"> </a>
<a name="ln902">//---------------------------------------------------------</a>
<a name="ln903">//   PaletteCellFilter::addChainedFilter</a>
<a name="ln904">///   Ownership over the added filter is passed to this</a>
<a name="ln905">///   filter.</a>
<a name="ln906">//---------------------------------------------------------</a>
<a name="ln907"> </a>
<a name="ln908">void PaletteCellFilter::addChainedFilter(PaletteCellFilter* newFilter)</a>
<a name="ln909">      {</a>
<a name="ln910">      PaletteCellFilter* f = this;</a>
<a name="ln911">      while (f-&gt;chainedFilter)</a>
<a name="ln912">            f = f-&gt;chainedFilter;</a>
<a name="ln913"> </a>
<a name="ln914">      newFilter-&gt;setParent(f);</a>
<a name="ln915">      f-&gt;chainedFilter = newFilter;</a>
<a name="ln916">      connect(newFilter, &amp;PaletteCellFilter::filterChanged, f, &amp;PaletteCellFilter::filterChanged);</a>
<a name="ln917">      }</a>
<a name="ln918"> </a>
<a name="ln919">//---------------------------------------------------------</a>
<a name="ln920">//   PaletteCellFilter::accept</a>
<a name="ln921">//---------------------------------------------------------</a>
<a name="ln922"> </a>
<a name="ln923">bool PaletteCellFilter::accept(const PaletteCell&amp; cell) const</a>
<a name="ln924">      {</a>
<a name="ln925">      const PaletteCellFilter* f = this;</a>
<a name="ln926">      while (f) {</a>
<a name="ln927">            if (!f-&gt;acceptCell(cell))</a>
<a name="ln928">                  return false;</a>
<a name="ln929">            f = f-&gt;chainedFilter;</a>
<a name="ln930">            }</a>
<a name="ln931">      return true;</a>
<a name="ln932">      }</a>
<a name="ln933"> </a>
<a name="ln934">//---------------------------------------------------------</a>
<a name="ln935">//   PaletteCellFilter::connectToModel</a>
<a name="ln936">//---------------------------------------------------------</a>
<a name="ln937"> </a>
<a name="ln938">void PaletteCellFilter::connectToModel(const QAbstractItemModel* model)</a>
<a name="ln939">      {</a>
<a name="ln940">//       TODO: are all these needed?</a>
<a name="ln941">//       columnsInserted(const QModelIndex &amp;parent, int first, int last)</a>
<a name="ln942">//       columnsMoved(const QModelIndex &amp;parent, int start, int end, const QModelIndex &amp;destination, int column)</a>
<a name="ln943">//       columnsRemoved(const QModelIndex &amp;parent, int first, int last)</a>
<a name="ln944">      connect(model, &amp;QAbstractItemModel::dataChanged, this, &amp;PaletteCellFilter::filterChanged);</a>
<a name="ln945">//       dataChanged(const QModelIndex &amp;topLeft, const QModelIndex &amp;bottomRight, const QVector&lt;int&gt; &amp;roles = ...)</a>
<a name="ln946">      connect(model, &amp;QAbstractItemModel::layoutChanged, this, &amp;PaletteCellFilter::filterChanged);</a>
<a name="ln947">//       layoutChanged(const QList&lt;QPersistentModelIndex&gt; &amp;parents = ..., QAbstractItemModel::LayoutChangeHint hint = ...)</a>
<a name="ln948">      connect(model, &amp;QAbstractItemModel::modelReset, this, &amp;PaletteCellFilter::filterChanged);</a>
<a name="ln949">//       modelReset()</a>
<a name="ln950">      connect(model, &amp;QAbstractItemModel::rowsInserted, this, &amp;PaletteCellFilter::filterChanged);</a>
<a name="ln951">//       rowsInserted(const QModelIndex &amp;parent, int first, int last)</a>
<a name="ln952">      connect(model, &amp;QAbstractItemModel::rowsMoved, this, &amp;PaletteCellFilter::filterChanged);</a>
<a name="ln953">//       rowsMoved(const QModelIndex &amp;parent, int start, int end, const QModelIndex &amp;destination, int row)</a>
<a name="ln954">      connect(model, &amp;QAbstractItemModel::rowsRemoved, this, &amp;PaletteCellFilter::filterChanged);</a>
<a name="ln955">//       rowsRemoved(const QModelIndex &amp;parent, int first, int last)</a>
<a name="ln956">      }</a>
<a name="ln957"> </a>
<a name="ln958">//---------------------------------------------------------</a>
<a name="ln959">//   ExcludePaletteCellFilter</a>
<a name="ln960">//---------------------------------------------------------</a>
<a name="ln961"> </a>
<a name="ln962">class ExcludePaletteCellFilter : public PaletteCellFilter {</a>
<a name="ln963">      const PalettePanel* excludePanel;</a>
<a name="ln964">      const QPersistentModelIndex panelIndex; // filter is valid as long as this index is valid too</a>
<a name="ln965"> </a>
<a name="ln966">   public:</a>
<a name="ln967">      ExcludePaletteCellFilter(const PalettePanel* p, QPersistentModelIndex index, QObject* parent = nullptr)</a>
<a name="ln968">         : PaletteCellFilter(parent), excludePanel(p), panelIndex(std::move(index)) {}</a>
<a name="ln969"> </a>
<a name="ln970">      bool acceptCell(const PaletteCell&amp; cell) const override</a>
<a name="ln971">            {</a>
<a name="ln972">            return panelIndex.isValid() &amp;&amp; -1 == excludePanel-&gt;findPaletteCell(cell, /* matchName */ false);</a>
<a name="ln973">            }</a>
<a name="ln974">      };</a>
<a name="ln975"> </a>
<a name="ln976">//---------------------------------------------------------</a>
<a name="ln977">//   PaletteTreeModel::getFilter</a>
<a name="ln978">///   The ownership of the returned filter is passed to a</a>
<a name="ln979">///   caller.</a>
<a name="ln980">//---------------------------------------------------------</a>
<a name="ln981"> </a>
<a name="ln982">PaletteCellFilter* PaletteTreeModel::getFilter(const QModelIndex&amp; index) const</a>
<a name="ln983">      {</a>
<a name="ln984">      if (const PalettePanel* pp = findPalettePanel(index)) {</a>
<a name="ln985">            ExcludePaletteCellFilter* filter = new ExcludePaletteCellFilter(pp, index);</a>
<a name="ln986">            filter-&gt;connectToModel(this);</a>
<a name="ln987">            return filter;</a>
<a name="ln988">            }</a>
<a name="ln989"> </a>
<a name="ln990">      // TODO: make a filter for a single cell?</a>
<a name="ln991"> </a>
<a name="ln992">      return nullptr;</a>
<a name="ln993">      }</a>
<a name="ln994"> </a>
<a name="ln995">//---------------------------------------------------------</a>
<a name="ln996">//   FilterPaletteTreeModel::FilterPaletteTreeModel</a>
<a name="ln997">//---------------------------------------------------------</a>
<a name="ln998"> </a>
<a name="ln999">FilterPaletteTreeModel::FilterPaletteTreeModel(PaletteCellFilter* filter, PaletteTreeModel* model, QObject* parent)</a>
<a name="ln1000">   : QSortFilterProxyModel(parent), cellFilter(filter)</a>
<a name="ln1001">      {</a>
<a name="ln1002">      cellFilter-&gt;setParent(this);</a>
<a name="ln1003">//       connect(cellFilter, &amp;PaletteCellFilter::filterChanged, this, &amp;QSortFilterProxyModel::invalidate);</a>
<a name="ln1004">      connect(cellFilter, &amp;PaletteCellFilter::filterChanged, this, &amp;FilterPaletteTreeModel::invalidateFilter);</a>
<a name="ln1005"> </a>
<a name="ln1006">      setSourceModel(model);</a>
<a name="ln1007">      }</a>
<a name="ln1008"> </a>
<a name="ln1009">//---------------------------------------------------------</a>
<a name="ln1010">//   FilterPaletteTreeModel::filterAcceptsRow</a>
<a name="ln1011">//---------------------------------------------------------</a>
<a name="ln1012"> </a>
<a name="ln1013">bool FilterPaletteTreeModel::filterAcceptsRow(int sourceRow, const QModelIndex&amp; sourceParent) const</a>
<a name="ln1014">      {</a>
<a name="ln1015">      const QModelIndex&amp; cellIndex = sourceModel()-&gt;index(sourceRow, /* column */ 0, sourceParent);</a>
<a name="ln1016">      const QVariant cellData = sourceModel()-&gt;data(cellIndex, PaletteTreeModel::PaletteCellRole);</a>
<a name="ln1017">      const PaletteCell* cell = cellData.value&lt;const PaletteCell*&gt;();</a>
<a name="ln1018">      if (!cell) // a palette panel or just an unrelated model</a>
<a name="ln1019">            return true;</a>
<a name="ln1020">      return cellFilter-&gt;accept(*cell);</a>
<a name="ln1021">      }</a>
<a name="ln1022"> </a>
<a name="ln1023">//---------------------------------------------------------</a>
<a name="ln1024">//   PaletteCellFilterProxyModel::PaletteCellFilterProxyModel</a>
<a name="ln1025">//---------------------------------------------------------</a>
<a name="ln1026"> </a>
<a name="ln1027">PaletteCellFilterProxyModel::PaletteCellFilterProxyModel(QObject* parent)</a>
<a name="ln1028">      : QSortFilterProxyModel(parent)</a>
<a name="ln1029">      {</a>
<a name="ln1030">      setFilterRole(Qt::ToolTipRole); // palette cells have no data for DisplayRole</a>
<a name="ln1031">      }</a>
<a name="ln1032"> </a>
<a name="ln1033">//---------------------------------------------------------</a>
<a name="ln1034">//   PaletteCellFilterProxyModel::filterAcceptsRow</a>
<a name="ln1035">//---------------------------------------------------------</a>
<a name="ln1036"> </a>
<a name="ln1037">bool PaletteCellFilterProxyModel::filterAcceptsRow(int sourceRow, const QModelIndex&amp; sourceParent) const</a>
<a name="ln1038">      {</a>
<a name="ln1039">      const QAbstractItemModel* model = sourceModel();</a>
<a name="ln1040">      const QModelIndex rowIndex = model-&gt;index(sourceRow, 0, sourceParent);</a>
<a name="ln1041">      const int rowCount = model-&gt;rowCount(rowIndex);</a>
<a name="ln1042"> </a>
<a name="ln1043">      if (rowCount == 0) {</a>
<a name="ln1044">            if (QSortFilterProxyModel::filterAcceptsRow(sourceRow, sourceParent))</a>
<a name="ln1045">                  return true;</a>
<a name="ln1046">            // accept row if its parent is accepted by filter: necessary to be able to search by palette name</a>
<a name="ln1047">            if (sourceParent.isValid() &amp;&amp; QSortFilterProxyModel::filterAcceptsRow(sourceParent.row(), sourceParent.parent()))</a>
<a name="ln1048">                  return true;</a>
<a name="ln1049">            return false;</a>
<a name="ln1050">            }</a>
<a name="ln1051"> </a>
<a name="ln1052">      for (int i = 0; i &lt; rowCount; ++i) {</a>
<a name="ln1053">            if (filterAcceptsRow(i, rowIndex))</a>
<a name="ln1054">                  return true;</a>
<a name="ln1055">            }</a>
<a name="ln1056"> </a>
<a name="ln1057">      return false;</a>
<a name="ln1058">      }</a>
<a name="ln1059">} // namespace Ms</a>

</code></pre>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
