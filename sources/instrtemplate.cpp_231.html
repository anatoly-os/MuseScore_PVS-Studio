
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>instrtemplate.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2011 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;instrtemplate.h&quot;</a>
<a name="ln14">#include &quot;bracket.h&quot;</a>
<a name="ln15">#include &quot;drumset.h&quot;</a>
<a name="ln16">#include &quot;stafftype.h&quot;</a>
<a name="ln17">#include &quot;style.h&quot;</a>
<a name="ln18">#include &quot;sym.h&quot;</a>
<a name="ln19">#include &quot;stringdata.h&quot;</a>
<a name="ln20">#include &quot;utils.h&quot;</a>
<a name="ln21">#include &quot;xml.h&quot;</a>
<a name="ln22"> </a>
<a name="ln23">namespace Ms {</a>
<a name="ln24"> </a>
<a name="ln25">QList&lt;InstrumentGroup*&gt; instrumentGroups;</a>
<a name="ln26">QList&lt;MidiArticulation&gt; articulation;                // global articulations</a>
<a name="ln27">QList&lt;InstrumentGenre*&gt; instrumentGenres;</a>
<a name="ln28"> </a>
<a name="ln29">//---------------------------------------------------------</a>
<a name="ln30">//   searchGenre</a>
<a name="ln31">//---------------------------------------------------------</a>
<a name="ln32"> </a>
<a name="ln33">static InstrumentGenre * searchInstrumentGenre(const QString&amp; genre)</a>
<a name="ln34">      {</a>
<a name="ln35">      foreach(InstrumentGenre* ig, instrumentGenres) {</a>
<a name="ln36">            if (ig-&gt;id == genre)</a>
<a name="ln37">                  return ig;</a>
<a name="ln38">            }</a>
<a name="ln39">      return nullptr;</a>
<a name="ln40">      }</a>
<a name="ln41"> </a>
<a name="ln42">//---------------------------------------------------------</a>
<a name="ln43">//   searchInstrumentGroup</a>
<a name="ln44">//---------------------------------------------------------</a>
<a name="ln45"> </a>
<a name="ln46">static InstrumentGroup* searchInstrumentGroup(const QString&amp; name)</a>
<a name="ln47">      {</a>
<a name="ln48">      foreach(InstrumentGroup* g, instrumentGroups) {</a>
<a name="ln49">            if (g-&gt;id == name)</a>
<a name="ln50">                  return g;</a>
<a name="ln51">            }</a>
<a name="ln52">      return nullptr;</a>
<a name="ln53">      }</a>
<a name="ln54"> </a>
<a name="ln55">//---------------------------------------------------------</a>
<a name="ln56">//   searchArticulation</a>
<a name="ln57">//---------------------------------------------------------</a>
<a name="ln58"> </a>
<a name="ln59">static MidiArticulation searchArticulation(const QString&amp; name)</a>
<a name="ln60">      {</a>
<a name="ln61">      foreach(MidiArticulation a, articulation) {</a>
<a name="ln62">            if (a.name == name)</a>
<a name="ln63">                  return a;</a>
<a name="ln64">            }</a>
<a name="ln65">      return MidiArticulation();</a>
<a name="ln66">      }</a>
<a name="ln67"> </a>
<a name="ln68">//---------------------------------------------------------</a>
<a name="ln69">//   readStaffIdx</a>
<a name="ln70">//---------------------------------------------------------</a>
<a name="ln71"> </a>
<a name="ln72">static int readStaffIdx(XmlReader&amp; e)</a>
<a name="ln73">      {</a>
<a name="ln74">      int idx = e.intAttribute(&quot;staff&quot;, 1) - 1;</a>
<a name="ln75">      if (idx &gt;= MAX_STAVES)</a>
<a name="ln76">            idx = MAX_STAVES-1;</a>
<a name="ln77">      if (idx &lt; 0)</a>
<a name="ln78">            idx = 0;</a>
<a name="ln79">      return idx;</a>
<a name="ln80">      }</a>
<a name="ln81"> </a>
<a name="ln82">//---------------------------------------------------------</a>
<a name="ln83">//   read InstrumentGroup</a>
<a name="ln84">//---------------------------------------------------------</a>
<a name="ln85"> </a>
<a name="ln86">void InstrumentGroup::read(XmlReader&amp; e)</a>
<a name="ln87">      {</a>
<a name="ln88">      id       = e.attribute(&quot;id&quot;);</a>
<a name="ln89">      name     = qApp-&gt;translate(&quot;InstrumentsXML&quot;, e.attribute(&quot;name&quot;).toUtf8().data());</a>
<a name="ln90">      extended = e.intAttribute(&quot;extended&quot;, 0);</a>
<a name="ln91"> </a>
<a name="ln92">      while (e.readNextStartElement()) {</a>
<a name="ln93">            const QStringRef&amp; tag(e.name());</a>
<a name="ln94">            if (tag == &quot;instrument&quot; || tag == &quot;Instrument&quot;) {</a>
<a name="ln95">                  QString sid = e.attribute(&quot;id&quot;);</a>
<a name="ln96">                  InstrumentTemplate* t = searchTemplate(sid);</a>
<a name="ln97">                  if (t == 0) {</a>
<a name="ln98">                        t = new InstrumentTemplate;</a>
<a name="ln99">                        t-&gt;articulation.append(articulation);     // init with global articulation</a>
<a name="ln100">                        instrumentTemplates.append(t);</a>
<a name="ln101">                        }</a>
<a name="ln102">                  t-&gt;read(e);</a>
<a name="ln103">                  }</a>
<a name="ln104">            else if (tag == &quot;ref&quot;) {</a>
<a name="ln105">                  InstrumentTemplate* ttt = searchTemplate(e.readElementText());</a>
<a name="ln106">                  if (ttt) {</a>
<a name="ln107">                        InstrumentTemplate* t = new InstrumentTemplate(*ttt);</a>
<a name="ln108">                        instrumentTemplates.append(t);</a>
<a name="ln109">                        }</a>
<a name="ln110">                  else</a>
<a name="ln111">                        qDebug(&quot;instrument reference not found &lt;%s&gt;&quot;, e.text().toUtf8().data());</a>
<a name="ln112">                  }</a>
<a name="ln113">            else if (tag == &quot;name&quot;)</a>
<a name="ln114">                  name = qApp-&gt;translate(&quot;InstrumentsXML&quot;, e.readElementText().toUtf8().data());</a>
<a name="ln115">            else if (tag == &quot;extended&quot;)</a>
<a name="ln116">                  extended = e.readInt();</a>
<a name="ln117">            else</a>
<a name="ln118">                  e.unknown();</a>
<a name="ln119">            }</a>
<a name="ln120">      if (id.isEmpty())</a>
<a name="ln121">            id = name.toLower().replace(&quot; &quot;, &quot;-&quot;);</a>
<a name="ln122">      }</a>
<a name="ln123"> </a>
<a name="ln124">//---------------------------------------------------------</a>
<a name="ln125">//   clear InstrumentGroup</a>
<a name="ln126">//---------------------------------------------------------</a>
<a name="ln127"> </a>
<a name="ln128">void InstrumentGroup::clear()</a>
<a name="ln129">      {</a>
<a name="ln130">      qDeleteAll(instrumentTemplates);</a>
<a name="ln131">      instrumentTemplates.clear();</a>
<a name="ln132">      }</a>
<a name="ln133"> </a>
<a name="ln134">//---------------------------------------------------------</a>
<a name="ln135">//   InstrumentTemplate</a>
<a name="ln136">//---------------------------------------------------------</a>
<a name="ln137"> </a>
<a name="ln138">InstrumentTemplate::InstrumentTemplate()</a>
<a name="ln139">      {</a>
<a name="ln140">      staves             = 1;</a>
<a name="ln141">      minPitchA          = 0;</a>
<a name="ln142">      maxPitchA          = 127;</a>
<a name="ln143">      minPitchP          = 0;</a>
<a name="ln144">      maxPitchP          = 127;</a>
<a name="ln145">      staffGroup         = StaffGroup::STANDARD;</a>
<a name="ln146">      staffTypePreset    = 0;</a>
<a name="ln147">      useDrumset         = false;</a>
<a name="ln148">      drumset            = 0;</a>
<a name="ln149">      extended           = false;</a>
<a name="ln150">      singleNoteDynamics = true;</a>
<a name="ln151"> </a>
<a name="ln152">      for (int i = 0; i &lt; MAX_STAVES; ++i) {</a>
<a name="ln153">            clefTypes[i]._concertClef = ClefType::G;</a>
<a name="ln154">            clefTypes[i]._transposingClef = ClefType::G;</a>
<a name="ln155">            staffLines[i]  = 5;</a>
<a name="ln156">            smallStaff[i]  = false;</a>
<a name="ln157">            bracket[i]     = BracketType::NO_BRACKET;</a>
<a name="ln158">            bracketSpan[i] = 0;</a>
<a name="ln159">            barlineSpan[i] = false;</a>
<a name="ln160">            }</a>
<a name="ln161">      transpose.diatonic   = 0;</a>
<a name="ln162">      transpose.chromatic  = 0;</a>
<a name="ln163">      }</a>
<a name="ln164"> </a>
<a name="ln165">InstrumentTemplate::InstrumentTemplate(const InstrumentTemplate&amp; t)</a>
<a name="ln166">      {</a>
<a name="ln167">      init(t);</a>
<a name="ln168">      }</a>
<a name="ln169"> </a>
<a name="ln170">//---------------------------------------------------------</a>
<a name="ln171">//   init</a>
<a name="ln172">//---------------------------------------------------------</a>
<a name="ln173"> </a>
<a name="ln174">void InstrumentTemplate::init(const InstrumentTemplate&amp; t)</a>
<a name="ln175">      {</a>
<a name="ln176">      longNames  = t.longNames;</a>
<a name="ln177">      shortNames = t.shortNames;</a>
<a name="ln178">      musicXMLid = t.musicXMLid;</a>
<a name="ln179">      staves     = t.staves;</a>
<a name="ln180">      extended   = t.extended;</a>
<a name="ln181"> </a>
<a name="ln182">      for (int i = 0; i &lt; MAX_STAVES; ++i) {</a>
<a name="ln183">            clefTypes[i]   = t.clefTypes[i];</a>
<a name="ln184">            staffLines[i]  = t.staffLines[i];</a>
<a name="ln185">            smallStaff[i]  = t.smallStaff[i];</a>
<a name="ln186">            bracket[i]     = t.bracket[i];</a>
<a name="ln187">            bracketSpan[i] = t.bracketSpan[i];</a>
<a name="ln188">            barlineSpan[i] = t.barlineSpan[i];</a>
<a name="ln189">            }</a>
<a name="ln190">      minPitchA  = t.minPitchA;</a>
<a name="ln191">      maxPitchA  = t.maxPitchA;</a>
<a name="ln192">      minPitchP  = t.minPitchP;</a>
<a name="ln193">      maxPitchP  = t.maxPitchP;</a>
<a name="ln194">      transpose  = t.transpose;</a>
<a name="ln195">      staffGroup = t.staffGroup;</a>
<a name="ln196">      staffTypePreset   = t.staffTypePreset;</a>
<a name="ln197">      useDrumset = t.useDrumset;</a>
<a name="ln198">      if (t.drumset)</a>
<a name="ln199">            drumset = new Drumset(*t.drumset);</a>
<a name="ln200">      else</a>
<a name="ln201">            drumset = 0;</a>
<a name="ln202">      stringData  = t.stringData;</a>
<a name="ln203">      midiActions = t.midiActions;</a>
<a name="ln204">      channel     = t.channel;</a>
<a name="ln205">      singleNoteDynamics = t.singleNoteDynamics;</a>
<a name="ln206">      }</a>
<a name="ln207"> </a>
<a name="ln208">InstrumentTemplate::~InstrumentTemplate()</a>
<a name="ln209">      {</a>
<a name="ln210">      delete drumset;</a>
<a name="ln211">      }</a>
<a name="ln212"> </a>
<a name="ln213">//---------------------------------------------------------</a>
<a name="ln214">//   write</a>
<a name="ln215">//---------------------------------------------------------</a>
<a name="ln216"> </a>
<a name="ln217">void InstrumentTemplate::write(XmlWriter&amp; xml) const</a>
<a name="ln218">      {</a>
<a name="ln219">      xml.stag(QString(&quot;Instrument id=\&quot;%1\&quot;&quot;).arg(id));</a>
<a name="ln220">      longNames.write(xml, &quot;longName&quot;);</a>
<a name="ln221">      shortNames.write(xml, &quot;shortName&quot;);</a>
<a name="ln222"> </a>
<a name="ln223">      if (longNames.size() &gt; 1)</a>
<a name="ln224">            xml.tag(&quot;trackName&quot;, trackName);</a>
<a name="ln225">      xml.tag(&quot;description&quot;, description);</a>
<a name="ln226">      xml.tag(&quot;musicXMLid&quot;, musicXMLid);</a>
<a name="ln227">      if (extended)</a>
<a name="ln228">            xml.tag(&quot;extended&quot;, extended);</a>
<a name="ln229">      stringData.write(xml);</a>
<a name="ln230">      if (staves &gt; 1)</a>
<a name="ln231">            xml.tag(&quot;staves&quot;, staves);</a>
<a name="ln232">      for (int i = 0; i &lt; staves; ++i) {</a>
<a name="ln233">            if (clefTypes[i]._concertClef == clefTypes[i]._transposingClef) {</a>
<a name="ln234">                  QString tag = ClefInfo::tag(clefTypes[i]._concertClef);</a>
<a name="ln235">                  if (i)</a>
<a name="ln236">                        xml.tag(QString(&quot;clef staff=\&quot;%1\&quot;&quot;).arg(i+1), tag);</a>
<a name="ln237">                  else</a>
<a name="ln238">                        xml.tag(&quot;clef&quot;, tag);</a>
<a name="ln239">                  }</a>
<a name="ln240">            else {</a>
<a name="ln241">                  QString tag1 = ClefInfo::tag(clefTypes[i]._concertClef);</a>
<a name="ln242">                  QString tag2 = ClefInfo::tag(clefTypes[i]._transposingClef);</a>
<a name="ln243">                  if (i) {</a>
<a name="ln244">                        xml.tag(QString(&quot;concertClef staff=\&quot;%1\&quot;&quot;).arg(i+1), tag1);</a>
<a name="ln245">                        xml.tag(QString(&quot;transposingClef staff=\&quot;%1\&quot;&quot;).arg(i+1), tag2);</a>
<a name="ln246">                        }</a>
<a name="ln247">                  else {</a>
<a name="ln248">                        xml.tag(&quot;concertClef&quot;, tag1);</a>
<a name="ln249">                        xml.tag(&quot;transposingClef&quot;, tag2);</a>
<a name="ln250">                        }</a>
<a name="ln251">                  }</a>
<a name="ln252">            if (staffLines[i] != 5) {</a>
<a name="ln253">                  if (i)</a>
<a name="ln254">                        xml.tag(QString(&quot;stafflines staff=\&quot;%1\&quot;&quot;).arg(i+1), staffLines[i]);</a>
<a name="ln255">                  else</a>
<a name="ln256">                        xml.tag(&quot;stafflines&quot;, staffLines[i]);</a>
<a name="ln257">                  }</a>
<a name="ln258">            if (smallStaff[i]) {</a>
<a name="ln259">                  if (i)</a>
<a name="ln260">                        xml.tag(QString(&quot;smallStaff staff=\&quot;%1\&quot;&quot;).arg(i+1), smallStaff[i]);</a>
<a name="ln261">                  else</a>
<a name="ln262">                        xml.tag(&quot;smallStaff&quot;, smallStaff[i]);</a>
<a name="ln263">                  }</a>
<a name="ln264"> </a>
<a name="ln265">            if (bracket[i] != BracketType::NO_BRACKET) {</a>
<a name="ln266">                  if (i)</a>
<a name="ln267">                        xml.tag(QString(&quot;bracket staff=\&quot;%1\&quot;&quot;).arg(i+1), int(bracket[i]));</a>
<a name="ln268">                  else</a>
<a name="ln269">                        xml.tag(&quot;bracket&quot;, int(bracket[i]));</a>
<a name="ln270">                  }</a>
<a name="ln271">            if (bracketSpan[i] != 0) {</a>
<a name="ln272">                  if (i)</a>
<a name="ln273">                        xml.tag(QString(&quot;bracketSpan staff=\&quot;%1\&quot;&quot;).arg(i+1), bracketSpan[i]);</a>
<a name="ln274">                  else</a>
<a name="ln275">                        xml.tag(&quot;bracketSpan&quot;, bracketSpan[i]);</a>
<a name="ln276">                  }</a>
<a name="ln277">            if (barlineSpan[i]) {</a>
<a name="ln278">                  if (i)</a>
<a name="ln279">                        xml.tag(QString(&quot;barlineSpan staff=\&quot;%1\&quot;&quot;).arg(i+1), barlineSpan[i]);</a>
<a name="ln280">                  else</a>
<a name="ln281">                        xml.tag(&quot;barlineSpan&quot;, barlineSpan[i]);</a>
<a name="ln282">                  }</a>
<a name="ln283">            }</a>
<a name="ln284">      if (minPitchA != 0 || maxPitchA != 127)</a>
<a name="ln285">            xml.tag(&quot;aPitchRange&quot;, QString(&quot;%1-%2&quot;).arg(int(minPitchA)).arg(int(maxPitchA)));</a>
<a name="ln286">      if (minPitchP != 0 || maxPitchP != 127)</a>
<a name="ln287">            xml.tag(&quot;pPitchRange&quot;, QString(&quot;%1-%2&quot;).arg(int(minPitchP)).arg(int(maxPitchP)));</a>
<a name="ln288">      if (transpose.diatonic)</a>
<a name="ln289">            xml.tag(&quot;transposeDiatonic&quot;, transpose.diatonic);</a>
<a name="ln290">      if (transpose.chromatic)</a>
<a name="ln291">            xml.tag(&quot;transposeChromatic&quot;, transpose.chromatic);</a>
<a name="ln292">      if (useDrumset)</a>
<a name="ln293">            xml.tag(&quot;drumset&quot;, int(useDrumset));</a>
<a name="ln294">      if (drumset)</a>
<a name="ln295">            drumset-&gt;save(xml);</a>
<a name="ln296">      </a>
<a name="ln297">      if (!singleNoteDynamics)      // default is true</a>
<a name="ln298">            xml.tag(&quot;singleNoteDynamics&quot;, singleNoteDynamics);</a>
<a name="ln299"> </a>
<a name="ln300">      for (const NamedEventList&amp; a : midiActions)</a>
<a name="ln301">            a.write(xml, &quot;MidiAction&quot;);</a>
<a name="ln302">      for (const Channel&amp; a : channel)</a>
<a name="ln303">            a.write(xml, nullptr);</a>
<a name="ln304">      for (const MidiArticulation&amp; ma : articulation) {</a>
<a name="ln305">            bool isGlobal = false;</a>
<a name="ln306">            for (const MidiArticulation&amp; ga : Ms::articulation) {</a>
<a name="ln307">                  if (ma == ga) {</a>
<a name="ln308">                        isGlobal = true;</a>
<a name="ln309">                        break;</a>
<a name="ln310">                        }</a>
<a name="ln311">                  }</a>
<a name="ln312">            if (!isGlobal)</a>
<a name="ln313">                  ma.write(xml);</a>
<a name="ln314">            }</a>
<a name="ln315">      xml.etag();</a>
<a name="ln316">      }</a>
<a name="ln317"> </a>
<a name="ln318">//---------------------------------------------------------</a>
<a name="ln319">//   write1</a>
<a name="ln320">//    output only translatable names</a>
<a name="ln321">//---------------------------------------------------------</a>
<a name="ln322"> </a>
<a name="ln323">void InstrumentTemplate::write1(XmlWriter&amp; xml) const</a>
<a name="ln324">      {</a>
<a name="ln325">      xml.stag(QString(&quot;Instrument id=\&quot;%1\&quot;&quot;).arg(id));</a>
<a name="ln326">      longNames.write(xml, &quot;longName&quot;);</a>
<a name="ln327">      shortNames.write(xml, &quot;shortName&quot;);</a>
<a name="ln328">      if (longNames.size() &gt; 1)</a>
<a name="ln329">            xml.tag(&quot;trackName&quot;, trackName);</a>
<a name="ln330">      xml.tag(&quot;description&quot;, description);</a>
<a name="ln331">      xml.etag();</a>
<a name="ln332">      }</a>
<a name="ln333"> </a>
<a name="ln334">//---------------------------------------------------------</a>
<a name="ln335">//   read</a>
<a name="ln336">//---------------------------------------------------------</a>
<a name="ln337"> </a>
<a name="ln338">void InstrumentTemplate::read(XmlReader&amp; e)</a>
<a name="ln339">      {</a>
<a name="ln340">      id = e.attribute(&quot;id&quot;);</a>
<a name="ln341"> </a>
<a name="ln342">      while (e.readNextStartElement()) {</a>
<a name="ln343">            const QStringRef&amp; tag(e.name());</a>
<a name="ln344"> </a>
<a name="ln345">            if (tag == &quot;longName&quot; || tag == &quot;name&quot;) {               // &quot;name&quot; is obsolete</a>
<a name="ln346">                  int pos = e.intAttribute(&quot;pos&quot;, 0);</a>
<a name="ln347">                  for (QList&lt;StaffName&gt;::iterator i = longNames.begin(); i != longNames.end(); ++i) {</a>
<a name="ln348">                        if ((*i).pos() == pos) {</a>
<a name="ln349">                              longNames.erase(i);</a>
<a name="ln350">                              break;</a>
<a name="ln351">                              }</a>
<a name="ln352">                        }</a>
<a name="ln353">                  longNames.append(StaffName(qApp-&gt;translate(&quot;InstrumentsXML&quot;, e.readElementText().toUtf8().data()), pos));</a>
<a name="ln354">                  }</a>
<a name="ln355">            else if (tag == &quot;shortName&quot; || tag == &quot;short-name&quot;) {   // &quot;short-name&quot; is obsolete</a>
<a name="ln356">                  int pos = e.intAttribute(&quot;pos&quot;, 0);</a>
<a name="ln357">                  for (QList&lt;StaffName&gt;::iterator i = shortNames.begin(); i != shortNames.end(); ++i) {</a>
<a name="ln358">                        if ((*i).pos() == pos) {</a>
<a name="ln359">                              shortNames.erase(i);</a>
<a name="ln360">                              break;</a>
<a name="ln361">							  }</a>
<a name="ln362">                        }</a>
<a name="ln363">                  shortNames.append(StaffName(qApp-&gt;translate(&quot;InstrumentsXML&quot;, e.readElementText().toUtf8().data()), pos));</a>
<a name="ln364">                  }</a>
<a name="ln365">            else if (tag == &quot;trackName&quot;)</a>
<a name="ln366">                  trackName = qApp-&gt;translate(&quot;InstrumentsXML&quot;, e.readElementText().toUtf8().data());</a>
<a name="ln367">            else if (tag == &quot;description&quot;)</a>
<a name="ln368">                  description = e.readElementText();</a>
<a name="ln369">            else if (tag == &quot;extended&quot;)</a>
<a name="ln370">                  extended = e.readInt();</a>
<a name="ln371">            else if (tag == &quot;staves&quot;) {</a>
<a name="ln372">                  staves = e.readInt();</a>
<a name="ln373">                  bracketSpan[0] = staves;</a>
<a name="ln374">//                  for (int i = 0; i &lt; staves-1; ++i)</a>
<a name="ln375">//                        barlineSpan[i] = true;</a>
<a name="ln376">                  }</a>
<a name="ln377">            else if (tag == &quot;clef&quot;) {           // sets both transposing and concert clef</a>
<a name="ln378">                  int idx = readStaffIdx(e);</a>
<a name="ln379">                  QString val(e.readElementText());</a>
<a name="ln380">                  bool ok;</a>
<a name="ln381">                  int i = val.toInt(&amp;ok);</a>
<a name="ln382">                  ClefType ct = ok ? ClefType(i) : Clef::clefType(val);</a>
<a name="ln383">                  clefTypes[idx]._concertClef = ct;</a>
<a name="ln384">                  clefTypes[idx]._transposingClef = ct;</a>
<a name="ln385">                  }</a>
<a name="ln386">            else if (tag == &quot;concertClef&quot;) {</a>
<a name="ln387">                  int idx = readStaffIdx(e);</a>
<a name="ln388">                  QString val(e.readElementText());</a>
<a name="ln389">                  bool ok;</a>
<a name="ln390">                  int i = val.toInt(&amp;ok);</a>
<a name="ln391">                  clefTypes[idx]._concertClef = ok ? ClefType(i) : Clef::clefType(val);</a>
<a name="ln392">                  }</a>
<a name="ln393">            else if (tag == &quot;transposingClef&quot;) {</a>
<a name="ln394">                  int idx = readStaffIdx(e);</a>
<a name="ln395">                  QString val(e.readElementText());</a>
<a name="ln396">                  bool ok;</a>
<a name="ln397">                  int i = val.toInt(&amp;ok);</a>
<a name="ln398">                  clefTypes[idx]._transposingClef = ok ? ClefType(i) : Clef::clefType(val);</a>
<a name="ln399">                  }</a>
<a name="ln400">            else if (tag == &quot;stafflines&quot;) {</a>
<a name="ln401">                  int idx = readStaffIdx(e);</a>
<a name="ln402">                  staffLines[idx] = e.readInt();</a>
<a name="ln403">                  }</a>
<a name="ln404">            else if (tag == &quot;smallStaff&quot;) {</a>
<a name="ln405">                  int idx = readStaffIdx(e);</a>
<a name="ln406">                  smallStaff[idx] = e.readInt();</a>
<a name="ln407">                  }</a>
<a name="ln408">            else if (tag == &quot;bracket&quot;) {</a>
<a name="ln409">                  int idx = readStaffIdx(e);</a>
<a name="ln410">                  bracket[idx] = BracketType(e.readInt());</a>
<a name="ln411">                  }</a>
<a name="ln412">            else if (tag == &quot;bracketSpan&quot;) {</a>
<a name="ln413">                  int idx = readStaffIdx(e);</a>
<a name="ln414">                  bracketSpan[idx] = e.readInt();</a>
<a name="ln415">                  }</a>
<a name="ln416">            else if (tag == &quot;barlineSpan&quot;) {</a>
<a name="ln417">                  int idx = readStaffIdx(e);</a>
<a name="ln418">                  int span = e.readInt();</a>
<a name="ln419">                  for (int i = 0; i &lt; span-1; ++i)</a>
<a name="ln420">                        barlineSpan[idx+i] = true;</a>
<a name="ln421">                  }</a>
<a name="ln422">            else if (tag == &quot;aPitchRange&quot;)</a>
<a name="ln423">                  setPitchRange(e.readElementText(), &amp;minPitchA, &amp;maxPitchA);</a>
<a name="ln424">            else if (tag == &quot;pPitchRange&quot;)</a>
<a name="ln425">                  setPitchRange(e.readElementText(), &amp;minPitchP, &amp;maxPitchP);</a>
<a name="ln426">            else if (tag == &quot;transposition&quot;) {    // obsolete</a>
<a name="ln427">                  int i = e.readInt();</a>
<a name="ln428">                  transpose.chromatic = i;</a>
<a name="ln429">                  transpose.diatonic = chromatic2diatonic(i);</a>
<a name="ln430">                  }</a>
<a name="ln431">            else if (tag == &quot;transposeChromatic&quot;)</a>
<a name="ln432">                  transpose.chromatic = e.readInt();</a>
<a name="ln433">            else if (tag == &quot;transposeDiatonic&quot;)</a>
<a name="ln434">                  transpose.diatonic = e.readInt();</a>
<a name="ln435">            else if (tag == &quot;StringData&quot;)</a>
<a name="ln436">                  stringData.read(e);</a>
<a name="ln437">            else if (tag == &quot;drumset&quot;)</a>
<a name="ln438">                  useDrumset = e.readInt();</a>
<a name="ln439">            else if (tag == &quot;Drum&quot;) {</a>
<a name="ln440">                  // if we see one of this tags, a custom drumset will</a>
<a name="ln441">                  // be created</a>
<a name="ln442">                  if (drumset == 0) {</a>
<a name="ln443">                        drumset = new Drumset(*smDrumset);</a>
<a name="ln444">                        drumset-&gt;clear();</a>
<a name="ln445">                        }</a>
<a name="ln446">                  drumset-&gt;load(e);</a>
<a name="ln447">                  }</a>
<a name="ln448">            else if (tag == &quot;MidiAction&quot;) {</a>
<a name="ln449">                  NamedEventList a;</a>
<a name="ln450">                  a.read(e);</a>
<a name="ln451">                  midiActions.append(a);</a>
<a name="ln452">                  }</a>
<a name="ln453">            else if (tag == &quot;Channel&quot; || tag == &quot;channel&quot;) {</a>
<a name="ln454">                  Channel a;</a>
<a name="ln455">                  a.read(e, nullptr);</a>
<a name="ln456">                  channel.append(a);</a>
<a name="ln457">                  }</a>
<a name="ln458">            else if (tag == &quot;Articulation&quot;) {</a>
<a name="ln459">                  MidiArticulation a;</a>
<a name="ln460">                  a.read(e);</a>
<a name="ln461">                  int n = articulation.size();</a>
<a name="ln462">                  int i;</a>
<a name="ln463">                  for(i = 0; i &lt; n; ++i) {</a>
<a name="ln464">                        if (articulation[i].name == a.name) {</a>
<a name="ln465">                              articulation[i] = a;</a>
<a name="ln466">                              break;</a>
<a name="ln467">                              }</a>
<a name="ln468">                        }</a>
<a name="ln469">                  if (i == n)</a>
<a name="ln470">                        articulation.append(a);</a>
<a name="ln471">                  }</a>
<a name="ln472">            else if (tag == &quot;stafftype&quot;) {</a>
<a name="ln473">                  int staffIdx = readStaffIdx(e);</a>
<a name="ln474">                  QString xmlPresetName = e.attribute(&quot;staffTypePreset&quot;, &quot;&quot;);</a>
<a name="ln475">                  QString stfGroup = e.readElementText();</a>
<a name="ln476">                  if (stfGroup == &quot;percussion&quot;)</a>
<a name="ln477">                        staffGroup = StaffGroup::PERCUSSION;</a>
<a name="ln478">                  else if (stfGroup == &quot;tablature&quot;)</a>
<a name="ln479">                        staffGroup = StaffGroup::TAB;</a>
<a name="ln480">                  else</a>
<a name="ln481">                        staffGroup = StaffGroup::STANDARD;</a>
<a name="ln482">                  staffTypePreset = 0;</a>
<a name="ln483">                  if (!xmlPresetName.isEmpty())</a>
<a name="ln484">                        staffTypePreset = StaffType::presetFromXmlName(xmlPresetName);</a>
<a name="ln485">                  if (!staffTypePreset || staffTypePreset-&gt;group() != staffGroup)</a>
<a name="ln486">                        staffTypePreset = StaffType::getDefaultPreset(staffGroup);</a>
<a name="ln487">                  if (staffTypePreset)</a>
<a name="ln488">                        staffLines[staffIdx] = staffTypePreset-&gt;lines();</a>
<a name="ln489">                  }</a>
<a name="ln490">            else if (tag == &quot;init&quot;) {</a>
<a name="ln491">                  QString val(e.readElementText());</a>
<a name="ln492">                  InstrumentTemplate* ttt = searchTemplate(val);</a>
<a name="ln493">                  if (ttt)</a>
<a name="ln494">                        init(*ttt);</a>
<a name="ln495">                  else</a>
<a name="ln496">                        qDebug(&quot;InstrumentTemplate:: init instrument &lt;%s&gt; not found&quot;, qPrintable(val));</a>
<a name="ln497">                  }</a>
<a name="ln498">            else if (tag == &quot;musicXMLid&quot;) {</a>
<a name="ln499">                  musicXMLid = e.readElementText();</a>
<a name="ln500">                  }</a>
<a name="ln501">            else if (tag == &quot;genre&quot;) {</a>
<a name="ln502">                  QString val(e.readElementText());</a>
<a name="ln503">                  linkGenre(val);</a>
<a name="ln504">                  }</a>
<a name="ln505">            else if (tag == &quot;singleNoteDynamics&quot;)</a>
<a name="ln506">                  singleNoteDynamics = e.readBool();</a>
<a name="ln507">            else</a>
<a name="ln508">                  e.unknown();</a>
<a name="ln509">            }</a>
<a name="ln510">      if (channel.empty()) {</a>
<a name="ln511">            Channel a;</a>
<a name="ln512">            a.setChorus(0);</a>
<a name="ln513">            a.setReverb(0);</a>
<a name="ln514">            a.setName(&quot;normal&quot;);</a>
<a name="ln515">            a.setProgram(0);</a>
<a name="ln516">            a.setBank(0);</a>
<a name="ln517">            a.setVolume(90);</a>
<a name="ln518">            a.setPan(0);</a>
<a name="ln519">            channel.append(a);</a>
<a name="ln520">            }</a>
<a name="ln521">      if (useDrumset) {</a>
<a name="ln522">            if (channel[0].bank() == 0 &amp;&amp; channel[0].synti().toLower() != &quot;zerberus&quot;)</a>
<a name="ln523">                  channel[0].setBank(128);</a>
<a name="ln524">            }</a>
<a name="ln525">      if (trackName.isEmpty() &amp;&amp; !longNames.isEmpty())</a>
<a name="ln526">            trackName = longNames[0].name();</a>
<a name="ln527">      if (description.isEmpty() &amp;&amp; !longNames.isEmpty())</a>
<a name="ln528">            description = longNames[0].name();</a>
<a name="ln529">      if (id.isEmpty())</a>
<a name="ln530">            id = trackName.toLower().replace(&quot; &quot;, &quot;-&quot;);</a>
<a name="ln531"> </a>
<a name="ln532">      if (staves == 0)</a>
<a name="ln533">            qDebug(&quot; 2Instrument: staves == 0 &lt;%s&gt;&quot;, qPrintable(id));</a>
<a name="ln534">      }</a>
<a name="ln535"> </a>
<a name="ln536"> </a>
<a name="ln537">//---------------------------------------------------------</a>
<a name="ln538">//   setPitchRange</a>
<a name="ln539">//---------------------------------------------------------</a>
<a name="ln540"> </a>
<a name="ln541">void InstrumentTemplate::setPitchRange(const QString&amp; s, char* a, char* b) const</a>
<a name="ln542">      {</a>
<a name="ln543">      QStringList sl = s.split(&quot;-&quot;);</a>
<a name="ln544">      if (sl.size() != 2) {</a>
<a name="ln545">            *a = 0;</a>
<a name="ln546">            *b = 127;</a>
<a name="ln547">            return;</a>
<a name="ln548">            }</a>
<a name="ln549">      *a = sl[0].toInt();</a>
<a name="ln550">      *b = sl[1].toInt();</a>
<a name="ln551">      }</a>
<a name="ln552"> </a>
<a name="ln553">//---------------------------------------------------------</a>
<a name="ln554">//   saveInstrumentTemplates</a>
<a name="ln555">//---------------------------------------------------------</a>
<a name="ln556"> </a>
<a name="ln557">bool saveInstrumentTemplates(const QString&amp; instrTemplates)</a>
<a name="ln558">      {</a>
<a name="ln559">      QFile qf(instrTemplates);</a>
<a name="ln560">      if (!qf.open(QIODevice::WriteOnly)) {</a>
<a name="ln561">            qDebug(&quot;cannot save instrument templates at &lt;%s&gt;&quot;, qPrintable(instrTemplates));</a>
<a name="ln562">            return false;</a>
<a name="ln563">            }</a>
<a name="ln564">      XmlWriter xml(0, &amp;qf);</a>
<a name="ln565">      xml &lt;&lt; &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&quot;;</a>
<a name="ln566">      xml.stag(&quot;museScore&quot;);</a>
<a name="ln567">      foreach(const InstrumentGenre* genre, instrumentGenres)</a>
<a name="ln568">            genre-&gt;write(xml);</a>
<a name="ln569">      xml &lt;&lt; &quot;\n&quot;;</a>
<a name="ln570">      foreach(const MidiArticulation&amp; a, articulation)</a>
<a name="ln571">            a.write(xml);</a>
<a name="ln572">      xml &lt;&lt; &quot;\n&quot;;</a>
<a name="ln573">      foreach(InstrumentGroup* group, instrumentGroups) {</a>
<a name="ln574">            xml.stag(QString(&quot;InstrumentGroup id=\&quot;%1\&quot;&quot;).arg(group-&gt;id));</a>
<a name="ln575">            xml.tag(&quot;name&quot;, group-&gt;name);</a>
<a name="ln576">            if (group-&gt;extended)</a>
<a name="ln577">                  xml.tag(&quot;extended&quot;, group-&gt;extended);</a>
<a name="ln578">            for (InstrumentTemplate* it : group-&gt;instrumentTemplates) {</a>
<a name="ln579">                  it-&gt;write(xml);</a>
<a name="ln580">                  xml &lt;&lt; &quot;\n&quot;;</a>
<a name="ln581">                  }</a>
<a name="ln582">            xml.etag();</a>
<a name="ln583">            xml &lt;&lt; &quot;\n&quot;;</a>
<a name="ln584">            }</a>
<a name="ln585">      xml.etag();</a>
<a name="ln586">      qf.close();</a>
<a name="ln587">      return true;</a>
<a name="ln588">      }</a>
<a name="ln589"> </a>
<a name="ln590">//---------------------------------------------------------</a>
<a name="ln591">//   saveInstrumentTemplates1</a>
<a name="ln592">//---------------------------------------------------------</a>
<a name="ln593"> </a>
<a name="ln594">bool saveInstrumentTemplates1(const QString&amp; instrTemplates)</a>
<a name="ln595">      {</a>
<a name="ln596">      QFile qf(instrTemplates);</a>
<a name="ln597">      if (!qf.open(QIODevice::WriteOnly)) {</a>
<a name="ln598">            qDebug(&quot;cannot save instrument templates at &lt;%s&gt;&quot;, qPrintable(instrTemplates));</a>
<a name="ln599">            return false;</a>
<a name="ln600">            }</a>
<a name="ln601">      XmlWriter xml(0, &amp;qf);</a>
<a name="ln602">      xml &lt;&lt; &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&quot;;</a>
<a name="ln603">      xml.stag(&quot;museScore&quot;);</a>
<a name="ln604">      foreach(const InstrumentGenre* genre, instrumentGenres)</a>
<a name="ln605">            genre-&gt;write1(xml);</a>
<a name="ln606">      foreach(InstrumentGroup* group, instrumentGroups) {</a>
<a name="ln607">            xml.stag(QString(&quot;InstrumentGroup id=\&quot;%1\&quot;&quot;).arg(group-&gt;id));</a>
<a name="ln608">            xml.tag(&quot;name&quot;, group-&gt;name);</a>
<a name="ln609">            for (InstrumentTemplate* it : group-&gt;instrumentTemplates) {</a>
<a name="ln610">                  it-&gt;write1(xml);</a>
<a name="ln611">                  xml &lt;&lt; &quot;\n&quot;;</a>
<a name="ln612">                  }</a>
<a name="ln613">            xml.etag();</a>
<a name="ln614">            xml &lt;&lt; &quot;\n&quot;;</a>
<a name="ln615">            }</a>
<a name="ln616">      xml.etag();</a>
<a name="ln617">      qf.close();</a>
<a name="ln618">      return true;</a>
<a name="ln619">      }</a>
<a name="ln620"> </a>
<a name="ln621">//---------------------------------------------------------</a>
<a name="ln622">//   clearInstrumentTemplates</a>
<a name="ln623">//---------------------------------------------------------</a>
<a name="ln624"> </a>
<a name="ln625">void clearInstrumentTemplates()</a>
<a name="ln626">      {</a>
<a name="ln627">      for (InstrumentGroup* g : instrumentGroups)</a>
<a name="ln628">            g-&gt;clear();</a>
<a name="ln629">      qDeleteAll(instrumentGroups);</a>
<a name="ln630">      instrumentGroups.clear();</a>
<a name="ln631">      qDeleteAll(instrumentGenres);</a>
<a name="ln632">      instrumentGenres.clear();</a>
<a name="ln633">      articulation.clear();</a>
<a name="ln634">      }</a>
<a name="ln635"> </a>
<a name="ln636">//---------------------------------------------------------</a>
<a name="ln637">//   loadInstrumentTemplates</a>
<a name="ln638">//---------------------------------------------------------</a>
<a name="ln639"> </a>
<a name="ln640">bool loadInstrumentTemplates(const QString&amp; instrTemplates)</a>
<a name="ln641">      {</a>
<a name="ln642">      QFile qf(instrTemplates);</a>
<a name="ln643">      if (!qf.open(QIODevice::Text | QIODevice::ReadOnly)) {</a>
<a name="ln644">            qDebug(&quot;cannot load instrument templates at &lt;%s&gt;&quot;, qPrintable(instrTemplates));</a>
<a name="ln645">            return false;</a>
<a name="ln646">            }</a>
<a name="ln647"> </a>
<a name="ln648">      XmlReader e(&amp;qf);</a>
<a name="ln649">      while (e.readNextStartElement()) {</a>
<a name="ln650">            if (e.name() == &quot;museScore&quot;) {</a>
<a name="ln651">                  while (e.readNextStartElement()) {</a>
<a name="ln652">                        const QStringRef&amp; tag(e.name());</a>
<a name="ln653">                        if (tag == &quot;instrument-group&quot; || tag == &quot;InstrumentGroup&quot;) {</a>
<a name="ln654">                              QString idGroup(e.attribute(&quot;id&quot;));</a>
<a name="ln655">                              InstrumentGroup* group = searchInstrumentGroup(idGroup);</a>
<a name="ln656">                              if (group == 0) {</a>
<a name="ln657">                                    group = new InstrumentGroup;</a>
<a name="ln658">                                    instrumentGroups.append(group);</a>
<a name="ln659">                                    }</a>
<a name="ln660">                              group-&gt;read(e);</a>
<a name="ln661">                              }</a>
<a name="ln662">                        else if (tag == &quot;Articulation&quot;) {</a>
<a name="ln663">                              // read global articulation</a>
<a name="ln664">                              QString name(e.attribute(&quot;name&quot;));</a>
<a name="ln665">                              MidiArticulation a = searchArticulation(name);</a>
<a name="ln666">                              a.read(e);</a>
<a name="ln667">                              articulation.append(a);</a>
<a name="ln668">                              }</a>
<a name="ln669">                        else if (tag == &quot;Genre&quot;) {</a>
<a name="ln670">                              QString idGenre(e.attribute(&quot;id&quot;));</a>
<a name="ln671">                              InstrumentGenre* genre = searchInstrumentGenre(idGenre);</a>
<a name="ln672">                              if (!genre) {</a>
<a name="ln673">                                    genre = new InstrumentGenre;</a>
<a name="ln674">                                    instrumentGenres.append(genre);</a>
<a name="ln675">                                    }</a>
<a name="ln676">                              genre-&gt;read(e);</a>
<a name="ln677">                              }</a>
<a name="ln678">                        else</a>
<a name="ln679">                              e.unknown();</a>
<a name="ln680">                        }</a>
<a name="ln681">                  }</a>
<a name="ln682">            }</a>
<a name="ln683">      // saveInstrumentTemplates1(&quot;/home/ws/mops.xml&quot;);</a>
<a name="ln684">      return true;</a>
<a name="ln685">      }</a>
<a name="ln686"> </a>
<a name="ln687">//---------------------------------------------------------</a>
<a name="ln688">//   searchTemplate</a>
<a name="ln689">//---------------------------------------------------------</a>
<a name="ln690"> </a>
<a name="ln691">InstrumentTemplate* searchTemplate(const QString&amp; name)</a>
<a name="ln692">      {</a>
<a name="ln693">      for (InstrumentGroup* g : instrumentGroups) {</a>
<a name="ln694">            for (InstrumentTemplate* it : g-&gt;instrumentTemplates) {</a>
<a name="ln695">                  if (it-&gt;id == name)</a>
<a name="ln696">                        return it;</a>
<a name="ln697">                  }</a>
<a name="ln698">            }</a>
<a name="ln699">      return 0;</a>
<a name="ln700">      }</a>
<a name="ln701"> </a>
<a name="ln702">//---------------------------------------------------------</a>
<a name="ln703">//   searchTemplateForMusicXMLid</a>
<a name="ln704">//---------------------------------------------------------</a>
<a name="ln705"> </a>
<a name="ln706">InstrumentTemplate* searchTemplateForMusicXmlId(const QString&amp; mxmlId)</a>
<a name="ln707">      {</a>
<a name="ln708">      for (InstrumentGroup* g : instrumentGroups) {</a>
<a name="ln709">            for (InstrumentTemplate* it : g-&gt;instrumentTemplates) {</a>
<a name="ln710">                  if (it-&gt;musicXMLid == mxmlId)</a>
<a name="ln711">                        return it;</a>
<a name="ln712">                  }</a>
<a name="ln713">            }</a>
<a name="ln714">      return 0;</a>
<a name="ln715">      }</a>
<a name="ln716"> </a>
<a name="ln717">//---------------------------------------------------------</a>
<a name="ln718">//   linkGenre</a>
<a name="ln719">//      link the current instrument template to the genre list specified by &quot;genre&quot;</a>
<a name="ln720">//      Each genre is a list of pointers to instrument templates</a>
<a name="ln721">//      The list of genres is at application level</a>
<a name="ln722">//---------------------------------------------------------</a>
<a name="ln723"> </a>
<a name="ln724">void InstrumentTemplate::linkGenre(const QString&amp; genre)</a>
<a name="ln725">      {</a>
<a name="ln726">      InstrumentGenre *ig = searchInstrumentGenre(genre);</a>
<a name="ln727">      if (ig)</a>
<a name="ln728">            genres.append(ig);</a>
<a name="ln729">      }</a>
<a name="ln730"> </a>
<a name="ln731">//---------------------------------------------------------</a>
<a name="ln732">//   genreMember</a>
<a name="ln733">//      is this instrument template a member of the supplied genre</a>
<a name="ln734">//---------------------------------------------------------</a>
<a name="ln735"> </a>
<a name="ln736">bool InstrumentTemplate::genreMember(const QString&amp; name)</a>
<a name="ln737">      {</a>
<a name="ln738">            bool rVal=false;</a>
<a name="ln739">            foreach(InstrumentGenre *instrumentGenre, genres ) {</a>
<a name="ln740">                if(instrumentGenre-&gt;id == name) {</a>
<a name="ln741">                      rVal = true;</a>
<a name="ln742">                      break;</a>
<a name="ln743">                }</a>
<a name="ln744">            }</a>
<a name="ln745">            return rVal;</a>
<a name="ln746">      }</a>
<a name="ln747"> </a>
<a name="ln748">void InstrumentGenre::write(XmlWriter&amp; xml) const</a>
<a name="ln749">      {</a>
<a name="ln750">      xml.stag(QString(&quot;Genre id=\&quot;%1\&quot;&quot;).arg(id));</a>
<a name="ln751">      xml.tag(&quot;name&quot;, name);</a>
<a name="ln752">      xml.etag();</a>
<a name="ln753">      }</a>
<a name="ln754"> </a>
<a name="ln755">void InstrumentGenre::write1(XmlWriter&amp; xml) const</a>
<a name="ln756">      {</a>
<a name="ln757">      write(xml);</a>
<a name="ln758">      }</a>
<a name="ln759"> </a>
<a name="ln760">void InstrumentGenre::read(XmlReader&amp; e)</a>
<a name="ln761">      {</a>
<a name="ln762">      id = e.attribute(&quot;id&quot;);</a>
<a name="ln763">      while (e.readNextStartElement()) {</a>
<a name="ln764">            const QStringRef&amp; tag(e.name());</a>
<a name="ln765">            if (tag == &quot;name&quot;) {</a>
<a name="ln766">                  name = qApp-&gt;translate(&quot;InstrumentsXML&quot;, e.readElementText().toUtf8().data());</a>
<a name="ln767">            }</a>
<a name="ln768">            else</a>
<a name="ln769">                  e.unknown();</a>
<a name="ln770">            }</a>
<a name="ln771">     }</a>
<a name="ln772"> </a>
<a name="ln773">//---------------------------------------------------------</a>
<a name="ln774">//   clefType</a>
<a name="ln775">//---------------------------------------------------------</a>
<a name="ln776"> </a>
<a name="ln777">ClefTypeList InstrumentTemplate::clefType(int staffIdx) const</a>
<a name="ln778">      {</a>
<a name="ln779">      if (staffIdx &lt; staves)</a>
<a name="ln780">            return clefTypes[staffIdx];</a>
<a name="ln781">      return clefTypes[0];</a>
<a name="ln782">      }</a>
<a name="ln783"> </a>
<a name="ln784">//---------------------------------------------------------</a>
<a name="ln785">//   defaultClef</a>
<a name="ln786">//    traverse the instrument list for first instrument</a>
<a name="ln787">//    with midi patch 'program'. Return the default clef</a>
<a name="ln788">//    for this instrument.</a>
<a name="ln789">//---------------------------------------------------------</a>
<a name="ln790"> </a>
<a name="ln791">ClefType defaultClef(int program)</a>
<a name="ln792">      {</a>
<a name="ln793">      if (program &gt;= 25 &amp;&amp; program &lt; 32)              // this are guitars</a>
<a name="ln794">            return ClefType::G8_VB;</a>
<a name="ln795">      else if (program &gt;= 33 &amp;&amp; program &lt; 41)         // this is bass</a>
<a name="ln796">            return ClefType::F8_VB;</a>
<a name="ln797"> </a>
<a name="ln798">      for (InstrumentGroup* g : instrumentGroups) {</a>
<a name="ln799">            for (InstrumentTemplate* it : g-&gt;instrumentTemplates) {</a>
<a name="ln800">                  if (it-&gt;channel[0].bank() == 0 &amp;&amp; it-&gt;channel[0].program() == program){</a>
<a name="ln801">                        return (it-&gt;clefTypes[0]._concertClef);</a>
<a name="ln802">                        }</a>
<a name="ln803">                  }</a>
<a name="ln804">            }</a>
<a name="ln805">      return ClefType::G;</a>
<a name="ln806">      }</a>
<a name="ln807"> </a>
<a name="ln808">}</a>
<a name="ln809"> </a>
<a name="ln810"> </a>

</code></pre>
<div class="balloon" rel="111"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="496"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="533"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="561"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="598"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="644"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
