
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>winfnt.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/***************************************************************************/</a>
<a name="ln2">/*                                                                         */</a>
<a name="ln3">/*  winfnt.c                                                               */</a>
<a name="ln4">/*                                                                         */</a>
<a name="ln5">/*    FreeType font driver for Windows FNT/FON files                       */</a>
<a name="ln6">/*                                                                         */</a>
<a name="ln7">/*  Copyright 1996-2015 by                                                 */</a>
<a name="ln8">/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</a>
<a name="ln9">/*  Copyright 2003 Huw D M Davies for Codeweavers                          */</a>
<a name="ln10">/*  Copyright 2007 Dmitry Timoshkov for Codeweavers                        */</a>
<a name="ln11">/*                                                                         */</a>
<a name="ln12">/*  This file is part of the FreeType project, and may only be used,       */</a>
<a name="ln13">/*  modified, and distributed under the terms of the FreeType project      */</a>
<a name="ln14">/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</a>
<a name="ln15">/*  this file you indicate that you have read the license and              */</a>
<a name="ln16">/*  understand and accept it fully.                                        */</a>
<a name="ln17">/*                                                                         */</a>
<a name="ln18">/***************************************************************************/</a>
<a name="ln19"> </a>
<a name="ln20"> </a>
<a name="ln21">#include &lt;ft2build.h&gt;</a>
<a name="ln22">#include FT_WINFONTS_H</a>
<a name="ln23">#include FT_INTERNAL_DEBUG_H</a>
<a name="ln24">#include FT_INTERNAL_STREAM_H</a>
<a name="ln25">#include FT_INTERNAL_OBJECTS_H</a>
<a name="ln26">#include FT_TRUETYPE_IDS_H</a>
<a name="ln27"> </a>
<a name="ln28">#include &quot;winfnt.h&quot;</a>
<a name="ln29">#include &quot;fnterrs.h&quot;</a>
<a name="ln30">#include FT_SERVICE_WINFNT_H</a>
<a name="ln31">#include FT_SERVICE_FONT_FORMAT_H</a>
<a name="ln32"> </a>
<a name="ln33">  /*************************************************************************/</a>
<a name="ln34">  /*                                                                       */</a>
<a name="ln35">  /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</a>
<a name="ln36">  /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</a>
<a name="ln37">  /* messages during execution.                                            */</a>
<a name="ln38">  /*                                                                       */</a>
<a name="ln39">#undef  FT_COMPONENT</a>
<a name="ln40">#define FT_COMPONENT  trace_winfnt</a>
<a name="ln41"> </a>
<a name="ln42"> </a>
<a name="ln43">  static const FT_Frame_Field  winmz_header_fields[] =</a>
<a name="ln44">  {</a>
<a name="ln45">#undef  FT_STRUCTURE</a>
<a name="ln46">#define FT_STRUCTURE  WinMZ_HeaderRec</a>
<a name="ln47"> </a>
<a name="ln48">    FT_FRAME_START( 64 ),</a>
<a name="ln49">      FT_FRAME_USHORT_LE ( magic ),</a>
<a name="ln50">      FT_FRAME_SKIP_BYTES( 29 * 2 ),</a>
<a name="ln51">      FT_FRAME_ULONG_LE  ( lfanew ),</a>
<a name="ln52">    FT_FRAME_END</a>
<a name="ln53">  };</a>
<a name="ln54"> </a>
<a name="ln55">  static const FT_Frame_Field  winne_header_fields[] =</a>
<a name="ln56">  {</a>
<a name="ln57">#undef  FT_STRUCTURE</a>
<a name="ln58">#define FT_STRUCTURE  WinNE_HeaderRec</a>
<a name="ln59"> </a>
<a name="ln60">    FT_FRAME_START( 40 ),</a>
<a name="ln61">      FT_FRAME_USHORT_LE ( magic ),</a>
<a name="ln62">      FT_FRAME_SKIP_BYTES( 34 ),</a>
<a name="ln63">      FT_FRAME_USHORT_LE ( resource_tab_offset ),</a>
<a name="ln64">      FT_FRAME_USHORT_LE ( rname_tab_offset ),</a>
<a name="ln65">    FT_FRAME_END</a>
<a name="ln66">  };</a>
<a name="ln67"> </a>
<a name="ln68">  static const FT_Frame_Field  winpe32_header_fields[] =</a>
<a name="ln69">  {</a>
<a name="ln70">#undef  FT_STRUCTURE</a>
<a name="ln71">#define FT_STRUCTURE  WinPE32_HeaderRec</a>
<a name="ln72"> </a>
<a name="ln73">    FT_FRAME_START( 248 ),</a>
<a name="ln74">      FT_FRAME_ULONG_LE  ( magic ),   /* PE00 */</a>
<a name="ln75">      FT_FRAME_USHORT_LE ( machine ), /* 0x014C - i386 */</a>
<a name="ln76">      FT_FRAME_USHORT_LE ( number_of_sections ),</a>
<a name="ln77">      FT_FRAME_SKIP_BYTES( 12 ),</a>
<a name="ln78">      FT_FRAME_USHORT_LE ( size_of_optional_header ),</a>
<a name="ln79">      FT_FRAME_SKIP_BYTES( 2 ),</a>
<a name="ln80">      FT_FRAME_USHORT_LE ( magic32 ), /* 0x10B */</a>
<a name="ln81">      FT_FRAME_SKIP_BYTES( 110 ),</a>
<a name="ln82">      FT_FRAME_ULONG_LE  ( rsrc_virtual_address ),</a>
<a name="ln83">      FT_FRAME_ULONG_LE  ( rsrc_size ),</a>
<a name="ln84">      FT_FRAME_SKIP_BYTES( 104 ),</a>
<a name="ln85">    FT_FRAME_END</a>
<a name="ln86">  };</a>
<a name="ln87"> </a>
<a name="ln88">  static const FT_Frame_Field  winpe32_section_fields[] =</a>
<a name="ln89">  {</a>
<a name="ln90">#undef  FT_STRUCTURE</a>
<a name="ln91">#define FT_STRUCTURE  WinPE32_SectionRec</a>
<a name="ln92"> </a>
<a name="ln93">    FT_FRAME_START( 40 ),</a>
<a name="ln94">      FT_FRAME_BYTES     ( name, 8 ),</a>
<a name="ln95">      FT_FRAME_SKIP_BYTES( 4 ),</a>
<a name="ln96">      FT_FRAME_ULONG_LE  ( virtual_address ),</a>
<a name="ln97">      FT_FRAME_ULONG_LE  ( size_of_raw_data ),</a>
<a name="ln98">      FT_FRAME_ULONG_LE  ( pointer_to_raw_data ),</a>
<a name="ln99">      FT_FRAME_SKIP_BYTES( 16 ),</a>
<a name="ln100">    FT_FRAME_END</a>
<a name="ln101">  };</a>
<a name="ln102"> </a>
<a name="ln103">  static const FT_Frame_Field  winpe_rsrc_dir_fields[] =</a>
<a name="ln104">  {</a>
<a name="ln105">#undef  FT_STRUCTURE</a>
<a name="ln106">#define FT_STRUCTURE  WinPE_RsrcDirRec</a>
<a name="ln107"> </a>
<a name="ln108">    FT_FRAME_START( 16 ),</a>
<a name="ln109">      FT_FRAME_ULONG_LE ( characteristics ),</a>
<a name="ln110">      FT_FRAME_ULONG_LE ( time_date_stamp ),</a>
<a name="ln111">      FT_FRAME_USHORT_LE( major_version ),</a>
<a name="ln112">      FT_FRAME_USHORT_LE( minor_version ),</a>
<a name="ln113">      FT_FRAME_USHORT_LE( number_of_named_entries ),</a>
<a name="ln114">      FT_FRAME_USHORT_LE( number_of_id_entries ),</a>
<a name="ln115">    FT_FRAME_END</a>
<a name="ln116">  };</a>
<a name="ln117"> </a>
<a name="ln118">  static const FT_Frame_Field  winpe_rsrc_dir_entry_fields[] =</a>
<a name="ln119">  {</a>
<a name="ln120">#undef  FT_STRUCTURE</a>
<a name="ln121">#define FT_STRUCTURE  WinPE_RsrcDirEntryRec</a>
<a name="ln122"> </a>
<a name="ln123">    FT_FRAME_START( 8 ),</a>
<a name="ln124">      FT_FRAME_ULONG_LE( name ),</a>
<a name="ln125">      FT_FRAME_ULONG_LE( offset ),</a>
<a name="ln126">    FT_FRAME_END</a>
<a name="ln127">  };</a>
<a name="ln128"> </a>
<a name="ln129">  static const FT_Frame_Field  winpe_rsrc_data_entry_fields[] =</a>
<a name="ln130">  {</a>
<a name="ln131">#undef  FT_STRUCTURE</a>
<a name="ln132">#define FT_STRUCTURE  WinPE_RsrcDataEntryRec</a>
<a name="ln133"> </a>
<a name="ln134">    FT_FRAME_START( 16 ),</a>
<a name="ln135">      FT_FRAME_ULONG_LE( offset_to_data ),</a>
<a name="ln136">      FT_FRAME_ULONG_LE( size ),</a>
<a name="ln137">      FT_FRAME_ULONG_LE( code_page ),</a>
<a name="ln138">      FT_FRAME_ULONG_LE( reserved ),</a>
<a name="ln139">    FT_FRAME_END</a>
<a name="ln140">  };</a>
<a name="ln141"> </a>
<a name="ln142">  static const FT_Frame_Field  winfnt_header_fields[] =</a>
<a name="ln143">  {</a>
<a name="ln144">#undef  FT_STRUCTURE</a>
<a name="ln145">#define FT_STRUCTURE  FT_WinFNT_HeaderRec</a>
<a name="ln146"> </a>
<a name="ln147">    FT_FRAME_START( 148 ),</a>
<a name="ln148">      FT_FRAME_USHORT_LE( version ),</a>
<a name="ln149">      FT_FRAME_ULONG_LE ( file_size ),</a>
<a name="ln150">      FT_FRAME_BYTES    ( copyright, 60 ),</a>
<a name="ln151">      FT_FRAME_USHORT_LE( file_type ),</a>
<a name="ln152">      FT_FRAME_USHORT_LE( nominal_point_size ),</a>
<a name="ln153">      FT_FRAME_USHORT_LE( vertical_resolution ),</a>
<a name="ln154">      FT_FRAME_USHORT_LE( horizontal_resolution ),</a>
<a name="ln155">      FT_FRAME_USHORT_LE( ascent ),</a>
<a name="ln156">      FT_FRAME_USHORT_LE( internal_leading ),</a>
<a name="ln157">      FT_FRAME_USHORT_LE( external_leading ),</a>
<a name="ln158">      FT_FRAME_BYTE     ( italic ),</a>
<a name="ln159">      FT_FRAME_BYTE     ( underline ),</a>
<a name="ln160">      FT_FRAME_BYTE     ( strike_out ),</a>
<a name="ln161">      FT_FRAME_USHORT_LE( weight ),</a>
<a name="ln162">      FT_FRAME_BYTE     ( charset ),</a>
<a name="ln163">      FT_FRAME_USHORT_LE( pixel_width ),</a>
<a name="ln164">      FT_FRAME_USHORT_LE( pixel_height ),</a>
<a name="ln165">      FT_FRAME_BYTE     ( pitch_and_family ),</a>
<a name="ln166">      FT_FRAME_USHORT_LE( avg_width ),</a>
<a name="ln167">      FT_FRAME_USHORT_LE( max_width ),</a>
<a name="ln168">      FT_FRAME_BYTE     ( first_char ),</a>
<a name="ln169">      FT_FRAME_BYTE     ( last_char ),</a>
<a name="ln170">      FT_FRAME_BYTE     ( default_char ),</a>
<a name="ln171">      FT_FRAME_BYTE     ( break_char ),</a>
<a name="ln172">      FT_FRAME_USHORT_LE( bytes_per_row ),</a>
<a name="ln173">      FT_FRAME_ULONG_LE ( device_offset ),</a>
<a name="ln174">      FT_FRAME_ULONG_LE ( face_name_offset ),</a>
<a name="ln175">      FT_FRAME_ULONG_LE ( bits_pointer ),</a>
<a name="ln176">      FT_FRAME_ULONG_LE ( bits_offset ),</a>
<a name="ln177">      FT_FRAME_BYTE     ( reserved ),</a>
<a name="ln178">      FT_FRAME_ULONG_LE ( flags ),</a>
<a name="ln179">      FT_FRAME_USHORT_LE( A_space ),</a>
<a name="ln180">      FT_FRAME_USHORT_LE( B_space ),</a>
<a name="ln181">      FT_FRAME_USHORT_LE( C_space ),</a>
<a name="ln182">      FT_FRAME_ULONG_LE ( color_table_offset ),</a>
<a name="ln183">      FT_FRAME_BYTES    ( reserved1, 16 ),</a>
<a name="ln184">    FT_FRAME_END</a>
<a name="ln185">  };</a>
<a name="ln186"> </a>
<a name="ln187"> </a>
<a name="ln188">  static void</a>
<a name="ln189">  fnt_font_done( FNT_Face face )</a>
<a name="ln190">  {</a>
<a name="ln191">    FT_Memory  memory = FT_FACE( face )-&gt;memory;</a>
<a name="ln192">    FT_Stream  stream = FT_FACE( face )-&gt;stream;</a>
<a name="ln193">    FNT_Font   font   = face-&gt;font;</a>
<a name="ln194"> </a>
<a name="ln195"> </a>
<a name="ln196">    if ( !font )</a>
<a name="ln197">      return;</a>
<a name="ln198"> </a>
<a name="ln199">    if ( font-&gt;fnt_frame )</a>
<a name="ln200">      FT_FRAME_RELEASE( font-&gt;fnt_frame );</a>
<a name="ln201">    FT_FREE( font-&gt;family_name );</a>
<a name="ln202"> </a>
<a name="ln203">    FT_FREE( font );</a>
<a name="ln204">    face-&gt;font = NULL;</a>
<a name="ln205">  }</a>
<a name="ln206"> </a>
<a name="ln207"> </a>
<a name="ln208">  static FT_Error</a>
<a name="ln209">  fnt_font_load( FNT_Font   font,</a>
<a name="ln210">                 FT_Stream  stream )</a>
<a name="ln211">  {</a>
<a name="ln212">    FT_Error          error;</a>
<a name="ln213">    FT_WinFNT_Header  header = &amp;font-&gt;header;</a>
<a name="ln214">    FT_Bool           new_format;</a>
<a name="ln215">    FT_UInt           size;</a>
<a name="ln216"> </a>
<a name="ln217"> </a>
<a name="ln218">    /* first of all, read the FNT header */</a>
<a name="ln219">    if ( FT_STREAM_SEEK( font-&gt;offset )                        ||</a>
<a name="ln220">         FT_STREAM_READ_FIELDS( winfnt_header_fields, header ) )</a>
<a name="ln221">      goto Exit;</a>
<a name="ln222"> </a>
<a name="ln223">    /* check header */</a>
<a name="ln224">    if ( header-&gt;version != 0x200 &amp;&amp;</a>
<a name="ln225">         header-&gt;version != 0x300 )</a>
<a name="ln226">    {</a>
<a name="ln227">      FT_TRACE2(( &quot;  not a Windows FNT file\n&quot; ));</a>
<a name="ln228">      error = FT_THROW( Unknown_File_Format );</a>
<a name="ln229">      goto Exit;</a>
<a name="ln230">    }</a>
<a name="ln231"> </a>
<a name="ln232">    new_format = FT_BOOL( font-&gt;header.version == 0x300 );</a>
<a name="ln233">    size       = new_format ? 148 : 118;</a>
<a name="ln234"> </a>
<a name="ln235">    if ( header-&gt;file_size &lt; size )</a>
<a name="ln236">    {</a>
<a name="ln237">      FT_TRACE2(( &quot;  not a Windows FNT file\n&quot; ));</a>
<a name="ln238">      error = FT_THROW( Unknown_File_Format );</a>
<a name="ln239">      goto Exit;</a>
<a name="ln240">    }</a>
<a name="ln241"> </a>
<a name="ln242">    /* Version 2 doesn't have these fields */</a>
<a name="ln243">    if ( header-&gt;version == 0x200 )</a>
<a name="ln244">    {</a>
<a name="ln245">      header-&gt;flags   = 0;</a>
<a name="ln246">      header-&gt;A_space = 0;</a>
<a name="ln247">      header-&gt;B_space = 0;</a>
<a name="ln248">      header-&gt;C_space = 0;</a>
<a name="ln249"> </a>
<a name="ln250">      header-&gt;color_table_offset = 0;</a>
<a name="ln251">    }</a>
<a name="ln252"> </a>
<a name="ln253">    if ( header-&gt;file_type &amp; 1 )</a>
<a name="ln254">    {</a>
<a name="ln255">      FT_TRACE2(( &quot;[can't handle vector FNT fonts]\n&quot; ));</a>
<a name="ln256">      error = FT_THROW( Unknown_File_Format );</a>
<a name="ln257">      goto Exit;</a>
<a name="ln258">    }</a>
<a name="ln259"> </a>
<a name="ln260">    /* this is a FNT file/table; extract its frame */</a>
<a name="ln261">    if ( FT_STREAM_SEEK( font-&gt;offset )                         ||</a>
<a name="ln262">         FT_FRAME_EXTRACT( header-&gt;file_size, font-&gt;fnt_frame ) )</a>
<a name="ln263">      goto Exit;</a>
<a name="ln264"> </a>
<a name="ln265">  Exit:</a>
<a name="ln266">    return error;</a>
<a name="ln267">  }</a>
<a name="ln268"> </a>
<a name="ln269"> </a>
<a name="ln270">  static FT_Error</a>
<a name="ln271">  fnt_face_get_dll_font( FNT_Face  face,</a>
<a name="ln272">                         FT_Int    face_instance_index )</a>
<a name="ln273">  {</a>
<a name="ln274">    FT_Error         error;</a>
<a name="ln275">    FT_Stream        stream = FT_FACE( face )-&gt;stream;</a>
<a name="ln276">    FT_Memory        memory = FT_FACE( face )-&gt;memory;</a>
<a name="ln277">    WinMZ_HeaderRec  mz_header;</a>
<a name="ln278">    FT_Long          face_index;</a>
<a name="ln279"> </a>
<a name="ln280"> </a>
<a name="ln281">    face-&gt;font = NULL;</a>
<a name="ln282"> </a>
<a name="ln283">    face_index = FT_ABS( face_instance_index ) &amp; 0xFFFF;</a>
<a name="ln284"> </a>
<a name="ln285">    /* does it begin with an MZ header? */</a>
<a name="ln286">    if ( FT_STREAM_SEEK( 0 )                                      ||</a>
<a name="ln287">         FT_STREAM_READ_FIELDS( winmz_header_fields, &amp;mz_header ) )</a>
<a name="ln288">      goto Exit;</a>
<a name="ln289"> </a>
<a name="ln290">    error = FT_ERR( Unknown_File_Format );</a>
<a name="ln291">    if ( mz_header.magic == WINFNT_MZ_MAGIC )</a>
<a name="ln292">    {</a>
<a name="ln293">      /* yes, now look for an NE header in the file */</a>
<a name="ln294">      WinNE_HeaderRec  ne_header;</a>
<a name="ln295"> </a>
<a name="ln296"> </a>
<a name="ln297">      FT_TRACE2(( &quot;MZ signature found\n&quot; ));</a>
<a name="ln298"> </a>
<a name="ln299">      if ( FT_STREAM_SEEK( mz_header.lfanew )                       ||</a>
<a name="ln300">           FT_STREAM_READ_FIELDS( winne_header_fields, &amp;ne_header ) )</a>
<a name="ln301">        goto Exit;</a>
<a name="ln302"> </a>
<a name="ln303">      error = FT_ERR( Unknown_File_Format );</a>
<a name="ln304">      if ( ne_header.magic == WINFNT_NE_MAGIC )</a>
<a name="ln305">      {</a>
<a name="ln306">        /* good, now look into the resource table for each FNT resource */</a>
<a name="ln307">        FT_ULong   res_offset  = mz_header.lfanew +</a>
<a name="ln308">                                   ne_header.resource_tab_offset;</a>
<a name="ln309">        FT_UShort  size_shift;</a>
<a name="ln310">        FT_UShort  font_count  = 0;</a>
<a name="ln311">        FT_ULong   font_offset = 0;</a>
<a name="ln312"> </a>
<a name="ln313"> </a>
<a name="ln314">        FT_TRACE2(( &quot;NE signature found\n&quot; ));</a>
<a name="ln315"> </a>
<a name="ln316">        if ( FT_STREAM_SEEK( res_offset )                    ||</a>
<a name="ln317">             FT_FRAME_ENTER( ne_header.rname_tab_offset -</a>
<a name="ln318">                             ne_header.resource_tab_offset ) )</a>
<a name="ln319">          goto Exit;</a>
<a name="ln320"> </a>
<a name="ln321">        size_shift = FT_GET_USHORT_LE();</a>
<a name="ln322"> </a>
<a name="ln323">        /* Microsoft's specification of the executable-file header format */</a>
<a name="ln324">        /* for `New Executable' (NE) doesn't give a limit for the         */</a>
<a name="ln325">        /* alignment shift count; however, in 1985, the year of the       */</a>
<a name="ln326">        /* specification release, only 32bit values were supported, thus  */</a>
<a name="ln327">        /* anything larger than 16 doesn't make sense in general, given   */</a>
<a name="ln328">        /* that file offsets are 16bit values, shifted by the alignment   */</a>
<a name="ln329">        /* shift count                                                    */</a>
<a name="ln330">        if ( size_shift &gt; 16 )</a>
<a name="ln331">        {</a>
<a name="ln332">          FT_TRACE2(( &quot;invalid alignment shift count for resource data\n&quot; ));</a>
<a name="ln333">          error = FT_THROW( Invalid_File_Format );</a>
<a name="ln334">          goto Exit;</a>
<a name="ln335">        }</a>
<a name="ln336"> </a>
<a name="ln337"> </a>
<a name="ln338">        for (;;)</a>
<a name="ln339">        {</a>
<a name="ln340">          FT_UShort  type_id, count;</a>
<a name="ln341"> </a>
<a name="ln342"> </a>
<a name="ln343">          type_id = FT_GET_USHORT_LE();</a>
<a name="ln344">          if ( !type_id )</a>
<a name="ln345">            break;</a>
<a name="ln346"> </a>
<a name="ln347">          count = FT_GET_USHORT_LE();</a>
<a name="ln348"> </a>
<a name="ln349">          if ( type_id == 0x8008U )</a>
<a name="ln350">          {</a>
<a name="ln351">            font_count  = count;</a>
<a name="ln352">            font_offset = FT_STREAM_POS() + 4 +</a>
<a name="ln353">                          (FT_ULong)( stream-&gt;cursor - stream-&gt;limit );</a>
<a name="ln354">            break;</a>
<a name="ln355">          }</a>
<a name="ln356"> </a>
<a name="ln357">          stream-&gt;cursor += 4 + count * 12;</a>
<a name="ln358">        }</a>
<a name="ln359"> </a>
<a name="ln360">        FT_FRAME_EXIT();</a>
<a name="ln361"> </a>
<a name="ln362">        if ( !font_count || !font_offset )</a>
<a name="ln363">        {</a>
<a name="ln364">          FT_TRACE2(( &quot;this file doesn't contain any FNT resources\n&quot; ));</a>
<a name="ln365">          error = FT_THROW( Invalid_File_Format );</a>
<a name="ln366">          goto Exit;</a>
<a name="ln367">        }</a>
<a name="ln368"> </a>
<a name="ln369">        /* loading `winfnt_header_fields' needs at least 118 bytes;    */</a>
<a name="ln370">        /* use this as a rough measure to check the expected font size */</a>
<a name="ln371">        if ( font_count * 118UL &gt; stream-&gt;size )</a>
<a name="ln372">        {</a>
<a name="ln373">          FT_TRACE2(( &quot;invalid number of faces\n&quot; ));</a>
<a name="ln374">          error = FT_THROW( Invalid_File_Format );</a>
<a name="ln375">          goto Exit;</a>
<a name="ln376">        }</a>
<a name="ln377"> </a>
<a name="ln378">        face-&gt;root.num_faces = font_count;</a>
<a name="ln379"> </a>
<a name="ln380">        if ( face_instance_index &lt; 0 )</a>
<a name="ln381">          goto Exit;</a>
<a name="ln382"> </a>
<a name="ln383">        if ( face_index &gt;= font_count )</a>
<a name="ln384">        {</a>
<a name="ln385">          error = FT_THROW( Invalid_Argument );</a>
<a name="ln386">          goto Exit;</a>
<a name="ln387">        }</a>
<a name="ln388"> </a>
<a name="ln389">        if ( FT_NEW( face-&gt;font ) )</a>
<a name="ln390">          goto Exit;</a>
<a name="ln391"> </a>
<a name="ln392">        if ( FT_STREAM_SEEK( font_offset + (FT_ULong)face_index * 12 ) ||</a>
<a name="ln393">             FT_FRAME_ENTER( 12 )                                      )</a>
<a name="ln394">          goto Fail;</a>
<a name="ln395"> </a>
<a name="ln396">        face-&gt;font-&gt;offset   = (FT_ULong)FT_GET_USHORT_LE() &lt;&lt; size_shift;</a>
<a name="ln397">        face-&gt;font-&gt;fnt_size = (FT_ULong)FT_GET_USHORT_LE() &lt;&lt; size_shift;</a>
<a name="ln398"> </a>
<a name="ln399">        stream-&gt;cursor += 8;</a>
<a name="ln400"> </a>
<a name="ln401">        FT_FRAME_EXIT();</a>
<a name="ln402"> </a>
<a name="ln403">        error = fnt_font_load( face-&gt;font, stream );</a>
<a name="ln404">      }</a>
<a name="ln405">      else if ( ne_header.magic == WINFNT_PE_MAGIC )</a>
<a name="ln406">      {</a>
<a name="ln407">        WinPE32_HeaderRec       pe32_header;</a>
<a name="ln408">        WinPE32_SectionRec      pe32_section;</a>
<a name="ln409">        WinPE_RsrcDirRec        root_dir, name_dir, lang_dir;</a>
<a name="ln410">        WinPE_RsrcDirEntryRec   dir_entry1, dir_entry2, dir_entry3;</a>
<a name="ln411">        WinPE_RsrcDataEntryRec  data_entry;</a>
<a name="ln412"> </a>
<a name="ln413">        FT_ULong   root_dir_offset, name_dir_offset, lang_dir_offset;</a>
<a name="ln414">        FT_UShort  i, j, k;</a>
<a name="ln415"> </a>
<a name="ln416"> </a>
<a name="ln417">        FT_TRACE2(( &quot;PE signature found\n&quot; ));</a>
<a name="ln418"> </a>
<a name="ln419">        if ( FT_STREAM_SEEK( mz_header.lfanew )                           ||</a>
<a name="ln420">             FT_STREAM_READ_FIELDS( winpe32_header_fields, &amp;pe32_header ) )</a>
<a name="ln421">          goto Exit;</a>
<a name="ln422"> </a>
<a name="ln423">        FT_TRACE2(( &quot;magic %04lx, machine %02x, number_of_sections %u, &quot;</a>
<a name="ln424">                    &quot;size_of_optional_header %02x\n&quot;</a>
<a name="ln425">                    &quot;magic32 %02x, rsrc_virtual_address %04lx, &quot;</a>
<a name="ln426">                    &quot;rsrc_size %04lx\n&quot;,</a>
<a name="ln427">                    pe32_header.magic, pe32_header.machine,</a>
<a name="ln428">                    pe32_header.number_of_sections,</a>
<a name="ln429">                    pe32_header.size_of_optional_header,</a>
<a name="ln430">                    pe32_header.magic32, pe32_header.rsrc_virtual_address,</a>
<a name="ln431">                    pe32_header.rsrc_size ));</a>
<a name="ln432"> </a>
<a name="ln433">        if ( pe32_header.magic != WINFNT_PE_MAGIC /* check full signature */ ||</a>
<a name="ln434">             pe32_header.machine != 0x014C /* i386 */                        ||</a>
<a name="ln435">             pe32_header.size_of_optional_header != 0xE0 /* FIXME */         ||</a>
<a name="ln436">             pe32_header.magic32 != 0x10B                                    )</a>
<a name="ln437">        {</a>
<a name="ln438">          FT_TRACE2(( &quot;this file has an invalid PE header\n&quot; ));</a>
<a name="ln439">          error = FT_THROW( Invalid_File_Format );</a>
<a name="ln440">          goto Exit;</a>
<a name="ln441">        }</a>
<a name="ln442"> </a>
<a name="ln443">        face-&gt;root.num_faces = 0;</a>
<a name="ln444"> </a>
<a name="ln445">        for ( i = 0; i &lt; pe32_header.number_of_sections; i++ )</a>
<a name="ln446">        {</a>
<a name="ln447">          if ( FT_STREAM_READ_FIELDS( winpe32_section_fields,</a>
<a name="ln448">                                      &amp;pe32_section ) )</a>
<a name="ln449">            goto Exit;</a>
<a name="ln450"> </a>
<a name="ln451">          FT_TRACE2(( &quot;name %.8s, va %04lx, size %04lx, offset %04lx\n&quot;,</a>
<a name="ln452">                      pe32_section.name, pe32_section.virtual_address,</a>
<a name="ln453">                      pe32_section.size_of_raw_data,</a>
<a name="ln454">                      pe32_section.pointer_to_raw_data ));</a>
<a name="ln455"> </a>
<a name="ln456">          if ( pe32_header.rsrc_virtual_address ==</a>
<a name="ln457">                 pe32_section.virtual_address )</a>
<a name="ln458">            goto Found_rsrc_section;</a>
<a name="ln459">        }</a>
<a name="ln460"> </a>
<a name="ln461">        FT_TRACE2(( &quot;this file doesn't contain any resources\n&quot; ));</a>
<a name="ln462">        error = FT_THROW( Invalid_File_Format );</a>
<a name="ln463">        goto Exit;</a>
<a name="ln464"> </a>
<a name="ln465">      Found_rsrc_section:</a>
<a name="ln466">        FT_TRACE2(( &quot;found resources section %.8s\n&quot;, pe32_section.name ));</a>
<a name="ln467"> </a>
<a name="ln468">        if ( FT_STREAM_SEEK( pe32_section.pointer_to_raw_data )        ||</a>
<a name="ln469">             FT_STREAM_READ_FIELDS( winpe_rsrc_dir_fields, &amp;root_dir ) )</a>
<a name="ln470">          goto Exit;</a>
<a name="ln471"> </a>
<a name="ln472">        root_dir_offset = pe32_section.pointer_to_raw_data;</a>
<a name="ln473"> </a>
<a name="ln474">        for ( i = 0; i &lt; root_dir.number_of_named_entries +</a>
<a name="ln475">                           root_dir.number_of_id_entries; i++ )</a>
<a name="ln476">        {</a>
<a name="ln477">          if ( FT_STREAM_SEEK( root_dir_offset + 16 + i * 8 )      ||</a>
<a name="ln478">               FT_STREAM_READ_FIELDS( winpe_rsrc_dir_entry_fields,</a>
<a name="ln479">                                      &amp;dir_entry1 )                )</a>
<a name="ln480">            goto Exit;</a>
<a name="ln481"> </a>
<a name="ln482">          if ( !(dir_entry1.offset &amp; 0x80000000UL ) /* DataIsDirectory */ )</a>
<a name="ln483">          {</a>
<a name="ln484">            error = FT_THROW( Invalid_File_Format );</a>
<a name="ln485">            goto Exit;</a>
<a name="ln486">          }</a>
<a name="ln487"> </a>
<a name="ln488">          dir_entry1.offset &amp;= ~0x80000000UL;</a>
<a name="ln489"> </a>
<a name="ln490">          name_dir_offset = pe32_section.pointer_to_raw_data +</a>
<a name="ln491">                            dir_entry1.offset;</a>
<a name="ln492"> </a>
<a name="ln493">          if ( FT_STREAM_SEEK( pe32_section.pointer_to_raw_data +</a>
<a name="ln494">                               dir_entry1.offset )                       ||</a>
<a name="ln495">               FT_STREAM_READ_FIELDS( winpe_rsrc_dir_fields, &amp;name_dir ) )</a>
<a name="ln496">            goto Exit;</a>
<a name="ln497"> </a>
<a name="ln498">          for ( j = 0; j &lt; name_dir.number_of_named_entries +</a>
<a name="ln499">                             name_dir.number_of_id_entries; j++ )</a>
<a name="ln500">          {</a>
<a name="ln501">            if ( FT_STREAM_SEEK( name_dir_offset + 16 + j * 8 )      ||</a>
<a name="ln502">                 FT_STREAM_READ_FIELDS( winpe_rsrc_dir_entry_fields,</a>
<a name="ln503">                                        &amp;dir_entry2 )                )</a>
<a name="ln504">              goto Exit;</a>
<a name="ln505"> </a>
<a name="ln506">            if ( !(dir_entry2.offset &amp; 0x80000000UL ) /* DataIsDirectory */ )</a>
<a name="ln507">            {</a>
<a name="ln508">              error = FT_THROW( Invalid_File_Format );</a>
<a name="ln509">              goto Exit;</a>
<a name="ln510">            }</a>
<a name="ln511"> </a>
<a name="ln512">            dir_entry2.offset &amp;= ~0x80000000UL;</a>
<a name="ln513"> </a>
<a name="ln514">            lang_dir_offset = pe32_section.pointer_to_raw_data +</a>
<a name="ln515">                                dir_entry2.offset;</a>
<a name="ln516"> </a>
<a name="ln517">            if ( FT_STREAM_SEEK( pe32_section.pointer_to_raw_data +</a>
<a name="ln518">                                   dir_entry2.offset )                     ||</a>
<a name="ln519">                 FT_STREAM_READ_FIELDS( winpe_rsrc_dir_fields, &amp;lang_dir ) )</a>
<a name="ln520">              goto Exit;</a>
<a name="ln521"> </a>
<a name="ln522">            for ( k = 0; k &lt; lang_dir.number_of_named_entries +</a>
<a name="ln523">                               lang_dir.number_of_id_entries; k++ )</a>
<a name="ln524">            {</a>
<a name="ln525">              if ( FT_STREAM_SEEK( lang_dir_offset + 16 + k * 8 )      ||</a>
<a name="ln526">                   FT_STREAM_READ_FIELDS( winpe_rsrc_dir_entry_fields,</a>
<a name="ln527">                                          &amp;dir_entry3 )                )</a>
<a name="ln528">                goto Exit;</a>
<a name="ln529"> </a>
<a name="ln530">              if ( dir_entry2.offset &amp; 0x80000000UL /* DataIsDirectory */ )</a>
<a name="ln531">              {</a>
<a name="ln532">                error = FT_THROW( Invalid_File_Format );</a>
<a name="ln533">                goto Exit;</a>
<a name="ln534">              }</a>
<a name="ln535"> </a>
<a name="ln536">              if ( dir_entry1.name == 8 /* RT_FONT */ )</a>
<a name="ln537">              {</a>
<a name="ln538">                if ( FT_STREAM_SEEK( root_dir_offset + dir_entry3.offset ) ||</a>
<a name="ln539">                     FT_STREAM_READ_FIELDS( winpe_rsrc_data_entry_fields,</a>
<a name="ln540">                                            &amp;data_entry )                  )</a>
<a name="ln541">                  goto Exit;</a>
<a name="ln542"> </a>
<a name="ln543">                FT_TRACE2(( &quot;found font #%lu, offset %04lx, &quot;</a>
<a name="ln544">                            &quot;size %04lx, cp %lu\n&quot;,</a>
<a name="ln545">                            dir_entry2.name,</a>
<a name="ln546">                            pe32_section.pointer_to_raw_data +</a>
<a name="ln547">                              data_entry.offset_to_data -</a>
<a name="ln548">                              pe32_section.virtual_address,</a>
<a name="ln549">                            data_entry.size, data_entry.code_page ));</a>
<a name="ln550"> </a>
<a name="ln551">                if ( face_index == face-&gt;root.num_faces )</a>
<a name="ln552">                {</a>
<a name="ln553">                  if ( FT_NEW( face-&gt;font ) )</a>
<a name="ln554">                    goto Exit;</a>
<a name="ln555"> </a>
<a name="ln556">                  face-&gt;font-&gt;offset   = pe32_section.pointer_to_raw_data +</a>
<a name="ln557">                                           data_entry.offset_to_data -</a>
<a name="ln558">                                           pe32_section.virtual_address;</a>
<a name="ln559">                  face-&gt;font-&gt;fnt_size = data_entry.size;</a>
<a name="ln560"> </a>
<a name="ln561">                  error = fnt_font_load( face-&gt;font, stream );</a>
<a name="ln562">                  if ( error )</a>
<a name="ln563">                  {</a>
<a name="ln564">                    FT_TRACE2(( &quot;font #%lu load error %d\n&quot;,</a>
<a name="ln565">                                dir_entry2.name, error ));</a>
<a name="ln566">                    goto Fail;</a>
<a name="ln567">                  }</a>
<a name="ln568">                  else</a>
<a name="ln569">                    FT_TRACE2(( &quot;font #%lu successfully loaded\n&quot;,</a>
<a name="ln570">                                dir_entry2.name ));</a>
<a name="ln571">                }</a>
<a name="ln572"> </a>
<a name="ln573">                face-&gt;root.num_faces++;</a>
<a name="ln574">              }</a>
<a name="ln575">            }</a>
<a name="ln576">          }</a>
<a name="ln577">        }</a>
<a name="ln578">      }</a>
<a name="ln579"> </a>
<a name="ln580">      if ( !face-&gt;root.num_faces )</a>
<a name="ln581">      {</a>
<a name="ln582">        FT_TRACE2(( &quot;this file doesn't contain any RT_FONT resources\n&quot; ));</a>
<a name="ln583">        error = FT_THROW( Invalid_File_Format );</a>
<a name="ln584">        goto Exit;</a>
<a name="ln585">      }</a>
<a name="ln586"> </a>
<a name="ln587">      if ( face_index &gt;= face-&gt;root.num_faces )</a>
<a name="ln588">      {</a>
<a name="ln589">        error = FT_THROW( Invalid_Argument );</a>
<a name="ln590">        goto Exit;</a>
<a name="ln591">      }</a>
<a name="ln592">    }</a>
<a name="ln593"> </a>
<a name="ln594">  Fail:</a>
<a name="ln595">    if ( error )</a>
<a name="ln596">      fnt_font_done( face );</a>
<a name="ln597"> </a>
<a name="ln598">  Exit:</a>
<a name="ln599">    return error;</a>
<a name="ln600">  }</a>
<a name="ln601"> </a>
<a name="ln602"> </a>
<a name="ln603">  typedef struct  FNT_CMapRec_</a>
<a name="ln604">  {</a>
<a name="ln605">    FT_CMapRec  cmap;</a>
<a name="ln606">    FT_UInt32   first;</a>
<a name="ln607">    FT_UInt32   count;</a>
<a name="ln608"> </a>
<a name="ln609">  } FNT_CMapRec, *FNT_CMap;</a>
<a name="ln610"> </a>
<a name="ln611"> </a>
<a name="ln612">  static FT_Error</a>
<a name="ln613">  fnt_cmap_init( FNT_CMap    cmap,</a>
<a name="ln614">                 FT_Pointer  pointer )</a>
<a name="ln615">  {</a>
<a name="ln616">    FNT_Face  face = (FNT_Face)FT_CMAP_FACE( cmap );</a>
<a name="ln617">    FNT_Font  font = face-&gt;font;</a>
<a name="ln618"> </a>
<a name="ln619">    FT_UNUSED( pointer );</a>
<a name="ln620"> </a>
<a name="ln621"> </a>
<a name="ln622">    cmap-&gt;first = (FT_UInt32)  font-&gt;header.first_char;</a>
<a name="ln623">    cmap-&gt;count = (FT_UInt32)( font-&gt;header.last_char - cmap-&gt;first + 1 );</a>
<a name="ln624"> </a>
<a name="ln625">    return 0;</a>
<a name="ln626">  }</a>
<a name="ln627"> </a>
<a name="ln628"> </a>
<a name="ln629">  static FT_UInt</a>
<a name="ln630">  fnt_cmap_char_index( FNT_CMap   cmap,</a>
<a name="ln631">                       FT_UInt32  char_code )</a>
<a name="ln632">  {</a>
<a name="ln633">    FT_UInt  gindex = 0;</a>
<a name="ln634"> </a>
<a name="ln635"> </a>
<a name="ln636">    char_code -= cmap-&gt;first;</a>
<a name="ln637">    if ( char_code &lt; cmap-&gt;count )</a>
<a name="ln638">      /* we artificially increase the glyph index; */</a>
<a name="ln639">      /* FNT_Load_Glyph reverts to the right one   */</a>
<a name="ln640">      gindex = (FT_UInt)( char_code + 1 );</a>
<a name="ln641">    return gindex;</a>
<a name="ln642">  }</a>
<a name="ln643"> </a>
<a name="ln644"> </a>
<a name="ln645">  static FT_UInt32</a>
<a name="ln646">  fnt_cmap_char_next( FNT_CMap    cmap,</a>
<a name="ln647">                      FT_UInt32  *pchar_code )</a>
<a name="ln648">  {</a>
<a name="ln649">    FT_UInt    gindex = 0;</a>
<a name="ln650">    FT_UInt32  result = 0;</a>
<a name="ln651">    FT_UInt32  char_code = *pchar_code + 1;</a>
<a name="ln652"> </a>
<a name="ln653"> </a>
<a name="ln654">    if ( char_code &lt;= cmap-&gt;first )</a>
<a name="ln655">    {</a>
<a name="ln656">      result = cmap-&gt;first;</a>
<a name="ln657">      gindex = 1;</a>
<a name="ln658">    }</a>
<a name="ln659">    else</a>
<a name="ln660">    {</a>
<a name="ln661">      char_code -= cmap-&gt;first;</a>
<a name="ln662">      if ( char_code &lt; cmap-&gt;count )</a>
<a name="ln663">      {</a>
<a name="ln664">        result = cmap-&gt;first + char_code;</a>
<a name="ln665">        gindex = (FT_UInt)( char_code + 1 );</a>
<a name="ln666">      }</a>
<a name="ln667">    }</a>
<a name="ln668"> </a>
<a name="ln669">    *pchar_code = result;</a>
<a name="ln670">    return gindex;</a>
<a name="ln671">  }</a>
<a name="ln672"> </a>
<a name="ln673"> </a>
<a name="ln674">  static const FT_CMap_ClassRec  fnt_cmap_class_rec =</a>
<a name="ln675">  {</a>
<a name="ln676">    sizeof ( FNT_CMapRec ),</a>
<a name="ln677"> </a>
<a name="ln678">    (FT_CMap_InitFunc)     fnt_cmap_init,</a>
<a name="ln679">    (FT_CMap_DoneFunc)     NULL,</a>
<a name="ln680">    (FT_CMap_CharIndexFunc)fnt_cmap_char_index,</a>
<a name="ln681">    (FT_CMap_CharNextFunc) fnt_cmap_char_next,</a>
<a name="ln682"> </a>
<a name="ln683">    NULL, NULL, NULL, NULL, NULL</a>
<a name="ln684">  };</a>
<a name="ln685"> </a>
<a name="ln686">  static FT_CMap_Class const  fnt_cmap_class = &amp;fnt_cmap_class_rec;</a>
<a name="ln687"> </a>
<a name="ln688"> </a>
<a name="ln689">  static void</a>
<a name="ln690">  FNT_Face_Done( FT_Face  fntface )       /* FNT_Face */</a>
<a name="ln691">  {</a>
<a name="ln692">    FNT_Face   face = (FNT_Face)fntface;</a>
<a name="ln693">    FT_Memory  memory;</a>
<a name="ln694"> </a>
<a name="ln695"> </a>
<a name="ln696">    if ( !face )</a>
<a name="ln697">      return;</a>
<a name="ln698"> </a>
<a name="ln699">    memory = FT_FACE_MEMORY( face );</a>
<a name="ln700"> </a>
<a name="ln701">    fnt_font_done( face );</a>
<a name="ln702"> </a>
<a name="ln703">    FT_FREE( fntface-&gt;available_sizes );</a>
<a name="ln704">    fntface-&gt;num_fixed_sizes = 0;</a>
<a name="ln705">  }</a>
<a name="ln706"> </a>
<a name="ln707"> </a>
<a name="ln708">  static FT_Error</a>
<a name="ln709">  FNT_Face_Init( FT_Stream      stream,</a>
<a name="ln710">                 FT_Face        fntface,        /* FNT_Face */</a>
<a name="ln711">                 FT_Int         face_instance_index,</a>
<a name="ln712">                 FT_Int         num_params,</a>
<a name="ln713">                 FT_Parameter*  params )</a>
<a name="ln714">  {</a>
<a name="ln715">    FNT_Face   face   = (FNT_Face)fntface;</a>
<a name="ln716">    FT_Error   error;</a>
<a name="ln717">    FT_Memory  memory = FT_FACE_MEMORY( face );</a>
<a name="ln718">    FT_Int     face_index;</a>
<a name="ln719"> </a>
<a name="ln720">    FT_UNUSED( num_params );</a>
<a name="ln721">    FT_UNUSED( params );</a>
<a name="ln722"> </a>
<a name="ln723"> </a>
<a name="ln724">    FT_TRACE2(( &quot;Windows FNT driver\n&quot; ));</a>
<a name="ln725"> </a>
<a name="ln726">    face_index = FT_ABS( face_instance_index ) &amp; 0xFFFF;</a>
<a name="ln727"> </a>
<a name="ln728">    /* try to load font from a DLL */</a>
<a name="ln729">    error = fnt_face_get_dll_font( face, face_instance_index );</a>
<a name="ln730">    if ( !error &amp;&amp; face_instance_index &lt; 0 )</a>
<a name="ln731">      goto Exit;</a>
<a name="ln732"> </a>
<a name="ln733">    if ( FT_ERR_EQ( error, Unknown_File_Format ) )</a>
<a name="ln734">    {</a>
<a name="ln735">      /* this didn't work; try to load a single FNT font */</a>
<a name="ln736">      FNT_Font  font;</a>
<a name="ln737"> </a>
<a name="ln738">      if ( FT_NEW( face-&gt;font ) )</a>
<a name="ln739">        goto Exit;</a>
<a name="ln740"> </a>
<a name="ln741">      fntface-&gt;num_faces = 1;</a>
<a name="ln742"> </a>
<a name="ln743">      font           = face-&gt;font;</a>
<a name="ln744">      font-&gt;offset   = 0;</a>
<a name="ln745">      font-&gt;fnt_size = stream-&gt;size;</a>
<a name="ln746"> </a>
<a name="ln747">      error = fnt_font_load( font, stream );</a>
<a name="ln748"> </a>
<a name="ln749">      if ( !error )</a>
<a name="ln750">      {</a>
<a name="ln751">        if ( face_instance_index &lt; 0 )</a>
<a name="ln752">          goto Exit;</a>
<a name="ln753"> </a>
<a name="ln754">        if ( face_index &gt; 0 )</a>
<a name="ln755">          error = FT_THROW( Invalid_Argument );</a>
<a name="ln756">      }</a>
<a name="ln757">    }</a>
<a name="ln758"> </a>
<a name="ln759">    if ( error )</a>
<a name="ln760">      goto Fail;</a>
<a name="ln761"> </a>
<a name="ln762">    /* we now need to fill the root FT_Face fields */</a>
<a name="ln763">    /* with relevant information                   */</a>
<a name="ln764">    {</a>
<a name="ln765">      FT_Face   root = FT_FACE( face );</a>
<a name="ln766">      FNT_Font  font = face-&gt;font;</a>
<a name="ln767">      FT_ULong  family_size;</a>
<a name="ln768"> </a>
<a name="ln769"> </a>
<a name="ln770">      root-&gt;face_index = face_index;</a>
<a name="ln771"> </a>
<a name="ln772">      root-&gt;face_flags |= FT_FACE_FLAG_FIXED_SIZES |</a>
<a name="ln773">                          FT_FACE_FLAG_HORIZONTAL;</a>
<a name="ln774"> </a>
<a name="ln775">      if ( font-&gt;header.avg_width == font-&gt;header.max_width )</a>
<a name="ln776">        root-&gt;face_flags |= FT_FACE_FLAG_FIXED_WIDTH;</a>
<a name="ln777"> </a>
<a name="ln778">      if ( font-&gt;header.italic )</a>
<a name="ln779">        root-&gt;style_flags |= FT_STYLE_FLAG_ITALIC;</a>
<a name="ln780"> </a>
<a name="ln781">      if ( font-&gt;header.weight &gt;= 800 )</a>
<a name="ln782">        root-&gt;style_flags |= FT_STYLE_FLAG_BOLD;</a>
<a name="ln783"> </a>
<a name="ln784">      /* set up the `fixed_sizes' array */</a>
<a name="ln785">      if ( FT_NEW_ARRAY( root-&gt;available_sizes, 1 ) )</a>
<a name="ln786">        goto Fail;</a>
<a name="ln787"> </a>
<a name="ln788">      root-&gt;num_fixed_sizes = 1;</a>
<a name="ln789"> </a>
<a name="ln790">      {</a>
<a name="ln791">        FT_Bitmap_Size*  bsize = root-&gt;available_sizes;</a>
<a name="ln792">        FT_UShort        x_res, y_res;</a>
<a name="ln793"> </a>
<a name="ln794"> </a>
<a name="ln795">        bsize-&gt;width  = (FT_Short)font-&gt;header.avg_width;</a>
<a name="ln796">        bsize-&gt;height = (FT_Short)( font-&gt;header.pixel_height +</a>
<a name="ln797">                                    font-&gt;header.external_leading );</a>
<a name="ln798">        bsize-&gt;size   = font-&gt;header.nominal_point_size &lt;&lt; 6;</a>
<a name="ln799"> </a>
<a name="ln800">        x_res = font-&gt;header.horizontal_resolution;</a>
<a name="ln801">        if ( !x_res )</a>
<a name="ln802">          x_res = 72;</a>
<a name="ln803"> </a>
<a name="ln804">        y_res = font-&gt;header.vertical_resolution;</a>
<a name="ln805">        if ( !y_res )</a>
<a name="ln806">          y_res = 72;</a>
<a name="ln807"> </a>
<a name="ln808">        bsize-&gt;y_ppem = FT_MulDiv( bsize-&gt;size, y_res, 72 );</a>
<a name="ln809">        bsize-&gt;y_ppem = FT_PIX_ROUND( bsize-&gt;y_ppem );</a>
<a name="ln810"> </a>
<a name="ln811">        /*</a>
<a name="ln812">         * this reads:</a>
<a name="ln813">         *</a>
<a name="ln814">         * the nominal height is larger than the bbox's height</a>
<a name="ln815">         *</a>
<a name="ln816">         * =&gt; nominal_point_size contains incorrect value;</a>
<a name="ln817">         *    use pixel_height as the nominal height</a>
<a name="ln818">         */</a>
<a name="ln819">        if ( bsize-&gt;y_ppem &gt; ( font-&gt;header.pixel_height &lt;&lt; 6 ) )</a>
<a name="ln820">        {</a>
<a name="ln821">          FT_TRACE2(( &quot;use pixel_height as the nominal height\n&quot; ));</a>
<a name="ln822"> </a>
<a name="ln823">          bsize-&gt;y_ppem = font-&gt;header.pixel_height &lt;&lt; 6;</a>
<a name="ln824">          bsize-&gt;size   = FT_MulDiv( bsize-&gt;y_ppem, 72, y_res );</a>
<a name="ln825">        }</a>
<a name="ln826"> </a>
<a name="ln827">        bsize-&gt;x_ppem = FT_MulDiv( bsize-&gt;size, x_res, 72 );</a>
<a name="ln828">        bsize-&gt;x_ppem = FT_PIX_ROUND( bsize-&gt;x_ppem );</a>
<a name="ln829">      }</a>
<a name="ln830"> </a>
<a name="ln831">      {</a>
<a name="ln832">        FT_CharMapRec  charmap;</a>
<a name="ln833"> </a>
<a name="ln834"> </a>
<a name="ln835">        charmap.encoding    = FT_ENCODING_NONE;</a>
<a name="ln836">        /* initial platform/encoding should indicate unset status? */</a>
<a name="ln837">        charmap.platform_id = TT_PLATFORM_APPLE_UNICODE;</a>
<a name="ln838">        charmap.encoding_id = TT_APPLE_ID_DEFAULT;</a>
<a name="ln839">        charmap.face        = root;</a>
<a name="ln840"> </a>
<a name="ln841">        if ( font-&gt;header.charset == FT_WinFNT_ID_MAC )</a>
<a name="ln842">        {</a>
<a name="ln843">          charmap.encoding    = FT_ENCODING_APPLE_ROMAN;</a>
<a name="ln844">          charmap.platform_id = TT_PLATFORM_MACINTOSH;</a>
<a name="ln845">/*        charmap.encoding_id = TT_MAC_ID_ROMAN; */</a>
<a name="ln846">        }</a>
<a name="ln847"> </a>
<a name="ln848">        error = FT_CMap_New( fnt_cmap_class,</a>
<a name="ln849">                             NULL,</a>
<a name="ln850">                             &amp;charmap,</a>
<a name="ln851">                             NULL );</a>
<a name="ln852">        if ( error )</a>
<a name="ln853">          goto Fail;</a>
<a name="ln854"> </a>
<a name="ln855">        /* Select default charmap */</a>
<a name="ln856">        if ( root-&gt;num_charmaps )</a>
<a name="ln857">          root-&gt;charmap = root-&gt;charmaps[0];</a>
<a name="ln858">      }</a>
<a name="ln859"> </a>
<a name="ln860">      /* set up remaining flags */</a>
<a name="ln861"> </a>
<a name="ln862">      if ( font-&gt;header.last_char &lt; font-&gt;header.first_char )</a>
<a name="ln863">      {</a>
<a name="ln864">        FT_TRACE2(( &quot;invalid number of glyphs\n&quot; ));</a>
<a name="ln865">        error = FT_THROW( Invalid_File_Format );</a>
<a name="ln866">        goto Fail;</a>
<a name="ln867">      }</a>
<a name="ln868"> </a>
<a name="ln869">      /* reserve one slot for the .notdef glyph at index 0 */</a>
<a name="ln870">      root-&gt;num_glyphs = font-&gt;header.last_char -</a>
<a name="ln871">                         font-&gt;header.first_char + 1 + 1;</a>
<a name="ln872"> </a>
<a name="ln873">      if ( font-&gt;header.face_name_offset &gt;= font-&gt;header.file_size )</a>
<a name="ln874">      {</a>
<a name="ln875">        FT_TRACE2(( &quot;invalid family name offset\n&quot; ));</a>
<a name="ln876">        error = FT_THROW( Invalid_File_Format );</a>
<a name="ln877">        goto Fail;</a>
<a name="ln878">      }</a>
<a name="ln879">      family_size = font-&gt;header.file_size - font-&gt;header.face_name_offset;</a>
<a name="ln880">      /* Some broken fonts don't delimit the face name with a final */</a>
<a name="ln881">      /* NULL byte -- the frame is erroneously one byte too small.  */</a>
<a name="ln882">      /* We thus allocate one more byte, setting it explicitly to   */</a>
<a name="ln883">      /* zero.                                                      */</a>
<a name="ln884">      if ( FT_ALLOC( font-&gt;family_name, family_size + 1 ) )</a>
<a name="ln885">        goto Fail;</a>
<a name="ln886"> </a>
<a name="ln887">      FT_MEM_COPY( font-&gt;family_name,</a>
<a name="ln888">                   font-&gt;fnt_frame + font-&gt;header.face_name_offset,</a>
<a name="ln889">                   family_size );</a>
<a name="ln890"> </a>
<a name="ln891">      font-&gt;family_name[family_size] = '\0';</a>
<a name="ln892"> </a>
<a name="ln893">      if ( FT_REALLOC( font-&gt;family_name,</a>
<a name="ln894">                       family_size,</a>
<a name="ln895">                       ft_strlen( font-&gt;family_name ) + 1 ) )</a>
<a name="ln896">        goto Fail;</a>
<a name="ln897"> </a>
<a name="ln898">      root-&gt;family_name = font-&gt;family_name;</a>
<a name="ln899">      root-&gt;style_name  = (char *)&quot;Regular&quot;;</a>
<a name="ln900"> </a>
<a name="ln901">      if ( root-&gt;style_flags &amp; FT_STYLE_FLAG_BOLD )</a>
<a name="ln902">      {</a>
<a name="ln903">        if ( root-&gt;style_flags &amp; FT_STYLE_FLAG_ITALIC )</a>
<a name="ln904">          root-&gt;style_name = (char *)&quot;Bold Italic&quot;;</a>
<a name="ln905">        else</a>
<a name="ln906">          root-&gt;style_name = (char *)&quot;Bold&quot;;</a>
<a name="ln907">      }</a>
<a name="ln908">      else if ( root-&gt;style_flags &amp; FT_STYLE_FLAG_ITALIC )</a>
<a name="ln909">        root-&gt;style_name = (char *)&quot;Italic&quot;;</a>
<a name="ln910">    }</a>
<a name="ln911">    goto Exit;</a>
<a name="ln912"> </a>
<a name="ln913">  Fail:</a>
<a name="ln914">    FNT_Face_Done( fntface );</a>
<a name="ln915"> </a>
<a name="ln916">  Exit:</a>
<a name="ln917">    return error;</a>
<a name="ln918">  }</a>
<a name="ln919"> </a>
<a name="ln920"> </a>
<a name="ln921">  static FT_Error</a>
<a name="ln922">  FNT_Size_Select( FT_Size   size,</a>
<a name="ln923">                   FT_ULong  strike_index )</a>
<a name="ln924">  {</a>
<a name="ln925">    FNT_Face          face   = (FNT_Face)size-&gt;face;</a>
<a name="ln926">    FT_WinFNT_Header  header = &amp;face-&gt;font-&gt;header;</a>
<a name="ln927"> </a>
<a name="ln928">    FT_UNUSED( strike_index );</a>
<a name="ln929"> </a>
<a name="ln930"> </a>
<a name="ln931">    FT_Select_Metrics( size-&gt;face, 0 );</a>
<a name="ln932"> </a>
<a name="ln933">    size-&gt;metrics.ascender    = header-&gt;ascent * 64;</a>
<a name="ln934">    size-&gt;metrics.descender   = -( header-&gt;pixel_height -</a>
<a name="ln935">                                   header-&gt;ascent ) * 64;</a>
<a name="ln936">    size-&gt;metrics.max_advance = header-&gt;max_width * 64;</a>
<a name="ln937"> </a>
<a name="ln938">    return FT_Err_Ok;</a>
<a name="ln939">  }</a>
<a name="ln940"> </a>
<a name="ln941"> </a>
<a name="ln942">  static FT_Error</a>
<a name="ln943">  FNT_Size_Request( FT_Size          size,</a>
<a name="ln944">                    FT_Size_Request  req )</a>
<a name="ln945">  {</a>
<a name="ln946">    FNT_Face          face    = (FNT_Face)size-&gt;face;</a>
<a name="ln947">    FT_WinFNT_Header  header  = &amp;face-&gt;font-&gt;header;</a>
<a name="ln948">    FT_Bitmap_Size*   bsize   = size-&gt;face-&gt;available_sizes;</a>
<a name="ln949">    FT_Error          error   = FT_ERR( Invalid_Pixel_Size );</a>
<a name="ln950">    FT_Long           height;</a>
<a name="ln951"> </a>
<a name="ln952"> </a>
<a name="ln953">    height = FT_REQUEST_HEIGHT( req );</a>
<a name="ln954">    height = ( height + 32 ) &gt;&gt; 6;</a>
<a name="ln955"> </a>
<a name="ln956">    switch ( req-&gt;type )</a>
<a name="ln957">    {</a>
<a name="ln958">    case FT_SIZE_REQUEST_TYPE_NOMINAL:</a>
<a name="ln959">      if ( height == ( ( bsize-&gt;y_ppem + 32 ) &gt;&gt; 6 ) )</a>
<a name="ln960">        error = FT_Err_Ok;</a>
<a name="ln961">      break;</a>
<a name="ln962"> </a>
<a name="ln963">    case FT_SIZE_REQUEST_TYPE_REAL_DIM:</a>
<a name="ln964">      if ( height == header-&gt;pixel_height )</a>
<a name="ln965">        error = FT_Err_Ok;</a>
<a name="ln966">      break;</a>
<a name="ln967"> </a>
<a name="ln968">    default:</a>
<a name="ln969">      error = FT_THROW( Unimplemented_Feature );</a>
<a name="ln970">      break;</a>
<a name="ln971">    }</a>
<a name="ln972"> </a>
<a name="ln973">    if ( error )</a>
<a name="ln974">      return error;</a>
<a name="ln975">    else</a>
<a name="ln976">      return FNT_Size_Select( size, 0 );</a>
<a name="ln977">  }</a>
<a name="ln978"> </a>
<a name="ln979"> </a>
<a name="ln980">  static FT_Error</a>
<a name="ln981">  FNT_Load_Glyph( FT_GlyphSlot  slot,</a>
<a name="ln982">                  FT_Size       size,</a>
<a name="ln983">                  FT_UInt       glyph_index,</a>
<a name="ln984">                  FT_Int32      load_flags )</a>
<a name="ln985">  {</a>
<a name="ln986">    FNT_Face    face   = (FNT_Face)FT_SIZE_FACE( size );</a>
<a name="ln987">    FNT_Font    font;</a>
<a name="ln988">    FT_Error    error  = FT_Err_Ok;</a>
<a name="ln989">    FT_Byte*    p;</a>
<a name="ln990">    FT_UInt     len;</a>
<a name="ln991">    FT_Bitmap*  bitmap = &amp;slot-&gt;bitmap;</a>
<a name="ln992">    FT_ULong    offset;</a>
<a name="ln993">    FT_Bool     new_format;</a>
<a name="ln994"> </a>
<a name="ln995">    FT_UNUSED( load_flags );</a>
<a name="ln996"> </a>
<a name="ln997"> </a>
<a name="ln998">    if ( !face )</a>
<a name="ln999">    {</a>
<a name="ln1000">      error = FT_THROW( Invalid_Face_Handle );</a>
<a name="ln1001">      goto Exit;</a>
<a name="ln1002">    }</a>
<a name="ln1003"> </a>
<a name="ln1004">    font = face-&gt;font;</a>
<a name="ln1005"> </a>
<a name="ln1006">    if ( !font                                                   ||</a>
<a name="ln1007">         glyph_index &gt;= (FT_UInt)( FT_FACE( face )-&gt;num_glyphs ) )</a>
<a name="ln1008">    {</a>
<a name="ln1009">      error = FT_THROW( Invalid_Argument );</a>
<a name="ln1010">      goto Exit;</a>
<a name="ln1011">    }</a>
<a name="ln1012"> </a>
<a name="ln1013">    FT_TRACE1(( &quot;FNT_Load_Glyph: glyph index %d\n&quot;, glyph_index ));</a>
<a name="ln1014"> </a>
<a name="ln1015">    if ( glyph_index &gt; 0 )</a>
<a name="ln1016">      glyph_index--;                           /* revert to real index */</a>
<a name="ln1017">    else</a>
<a name="ln1018">      glyph_index = font-&gt;header.default_char; /* the `.notdef' glyph  */</a>
<a name="ln1019"> </a>
<a name="ln1020">    new_format = FT_BOOL( font-&gt;header.version == 0x300 );</a>
<a name="ln1021">    len        = new_format ? 6 : 4;</a>
<a name="ln1022"> </a>
<a name="ln1023">    /* get glyph width and offset */</a>
<a name="ln1024">    offset = ( new_format ? 148 : 118 ) + len * glyph_index;</a>
<a name="ln1025"> </a>
<a name="ln1026">    if ( offset &gt;= font-&gt;header.file_size - 2 - ( new_format ? 4 : 2 ) )</a>
<a name="ln1027">    {</a>
<a name="ln1028">      FT_TRACE2(( &quot;invalid FNT offset\n&quot; ));</a>
<a name="ln1029">      error = FT_THROW( Invalid_File_Format );</a>
<a name="ln1030">      goto Exit;</a>
<a name="ln1031">    }</a>
<a name="ln1032"> </a>
<a name="ln1033">    p = font-&gt;fnt_frame + offset;</a>
<a name="ln1034"> </a>
<a name="ln1035">    bitmap-&gt;width = FT_NEXT_USHORT_LE( p );</a>
<a name="ln1036"> </a>
<a name="ln1037">    /* jump to glyph entry */</a>
<a name="ln1038">    if ( new_format )</a>
<a name="ln1039">      offset = FT_NEXT_ULONG_LE( p );</a>
<a name="ln1040">    else</a>
<a name="ln1041">      offset = FT_NEXT_USHORT_LE( p );</a>
<a name="ln1042"> </a>
<a name="ln1043">    if ( offset &gt;= font-&gt;header.file_size )</a>
<a name="ln1044">    {</a>
<a name="ln1045">      FT_TRACE2(( &quot;invalid FNT offset\n&quot; ));</a>
<a name="ln1046">      error = FT_THROW( Invalid_File_Format );</a>
<a name="ln1047">      goto Exit;</a>
<a name="ln1048">    }</a>
<a name="ln1049"> </a>
<a name="ln1050">    /* jump to glyph data */</a>
<a name="ln1051">    p = font-&gt;fnt_frame + /* font-&gt;header.bits_offset */ + offset;</a>
<a name="ln1052"> </a>
<a name="ln1053">    /* allocate and build bitmap */</a>
<a name="ln1054">    {</a>
<a name="ln1055">      FT_Memory  memory = FT_FACE_MEMORY( slot-&gt;face );</a>
<a name="ln1056">      FT_UInt    pitch  = ( bitmap-&gt;width + 7 ) &gt;&gt; 3;</a>
<a name="ln1057">      FT_Byte*   column;</a>
<a name="ln1058">      FT_Byte*   write;</a>
<a name="ln1059"> </a>
<a name="ln1060"> </a>
<a name="ln1061">      bitmap-&gt;pitch      = (int)pitch;</a>
<a name="ln1062">      bitmap-&gt;rows       = font-&gt;header.pixel_height;</a>
<a name="ln1063">      bitmap-&gt;pixel_mode = FT_PIXEL_MODE_MONO;</a>
<a name="ln1064"> </a>
<a name="ln1065">      if ( offset + pitch * bitmap-&gt;rows &gt; font-&gt;header.file_size )</a>
<a name="ln1066">      {</a>
<a name="ln1067">        FT_TRACE2(( &quot;invalid bitmap width\n&quot; ));</a>
<a name="ln1068">        error = FT_THROW( Invalid_File_Format );</a>
<a name="ln1069">        goto Exit;</a>
<a name="ln1070">      }</a>
<a name="ln1071"> </a>
<a name="ln1072">      /* note: since glyphs are stored in columns and not in rows we */</a>
<a name="ln1073">      /*       can't use ft_glyphslot_set_bitmap                     */</a>
<a name="ln1074">      if ( FT_ALLOC_MULT( bitmap-&gt;buffer, pitch, bitmap-&gt;rows ) )</a>
<a name="ln1075">        goto Exit;</a>
<a name="ln1076"> </a>
<a name="ln1077">      column = (FT_Byte*)bitmap-&gt;buffer;</a>
<a name="ln1078"> </a>
<a name="ln1079">      for ( ; pitch &gt; 0; pitch--, column++ )</a>
<a name="ln1080">      {</a>
<a name="ln1081">        FT_Byte*  limit = p + bitmap-&gt;rows;</a>
<a name="ln1082"> </a>
<a name="ln1083"> </a>
<a name="ln1084">        for ( write = column; p &lt; limit; p++, write += bitmap-&gt;pitch )</a>
<a name="ln1085">          *write = *p;</a>
<a name="ln1086">      }</a>
<a name="ln1087">    }</a>
<a name="ln1088"> </a>
<a name="ln1089">    slot-&gt;internal-&gt;flags = FT_GLYPH_OWN_BITMAP;</a>
<a name="ln1090">    slot-&gt;bitmap_left     = 0;</a>
<a name="ln1091">    slot-&gt;bitmap_top      = font-&gt;header.ascent;</a>
<a name="ln1092">    slot-&gt;format          = FT_GLYPH_FORMAT_BITMAP;</a>
<a name="ln1093"> </a>
<a name="ln1094">    /* now set up metrics */</a>
<a name="ln1095">    slot-&gt;metrics.width        = (FT_Pos)( bitmap-&gt;width &lt;&lt; 6 );</a>
<a name="ln1096">    slot-&gt;metrics.height       = (FT_Pos)( bitmap-&gt;rows &lt;&lt; 6 );</a>
<a name="ln1097">    slot-&gt;metrics.horiAdvance  = (FT_Pos)( bitmap-&gt;width &lt;&lt; 6 );</a>
<a name="ln1098">    slot-&gt;metrics.horiBearingX = 0;</a>
<a name="ln1099">    slot-&gt;metrics.horiBearingY = slot-&gt;bitmap_top &lt;&lt; 6;</a>
<a name="ln1100"> </a>
<a name="ln1101">    ft_synthesize_vertical_metrics( &amp;slot-&gt;metrics,</a>
<a name="ln1102">                                    (FT_Pos)( bitmap-&gt;rows &lt;&lt; 6 ) );</a>
<a name="ln1103"> </a>
<a name="ln1104">  Exit:</a>
<a name="ln1105">    return error;</a>
<a name="ln1106">  }</a>
<a name="ln1107"> </a>
<a name="ln1108"> </a>
<a name="ln1109">  static FT_Error</a>
<a name="ln1110">  winfnt_get_header( FT_Face               face,</a>
<a name="ln1111">                     FT_WinFNT_HeaderRec  *aheader )</a>
<a name="ln1112">  {</a>
<a name="ln1113">    FNT_Font  font = ((FNT_Face)face)-&gt;font;</a>
<a name="ln1114"> </a>
<a name="ln1115"> </a>
<a name="ln1116">    *aheader = font-&gt;header;</a>
<a name="ln1117"> </a>
<a name="ln1118">    return 0;</a>
<a name="ln1119">  }</a>
<a name="ln1120"> </a>
<a name="ln1121"> </a>
<a name="ln1122">  static const FT_Service_WinFntRec  winfnt_service_rec =</a>
<a name="ln1123">  {</a>
<a name="ln1124">    winfnt_get_header</a>
<a name="ln1125">  };</a>
<a name="ln1126"> </a>
<a name="ln1127"> /*</a>
<a name="ln1128">  *  SERVICE LIST</a>
<a name="ln1129">  *</a>
<a name="ln1130">  */</a>
<a name="ln1131"> </a>
<a name="ln1132">  static const FT_ServiceDescRec  winfnt_services[] =</a>
<a name="ln1133">  {</a>
<a name="ln1134">    { FT_SERVICE_ID_FONT_FORMAT, FT_FONT_FORMAT_WINFNT },</a>
<a name="ln1135">    { FT_SERVICE_ID_WINFNT,      &amp;winfnt_service_rec },</a>
<a name="ln1136">    { NULL, NULL }</a>
<a name="ln1137">  };</a>
<a name="ln1138"> </a>
<a name="ln1139"> </a>
<a name="ln1140">  static FT_Module_Interface</a>
<a name="ln1141">  winfnt_get_service( FT_Module         module,</a>
<a name="ln1142">                      const FT_String*  service_id )</a>
<a name="ln1143">  {</a>
<a name="ln1144">    FT_UNUSED( module );</a>
<a name="ln1145"> </a>
<a name="ln1146">    return ft_service_list_lookup( winfnt_services, service_id );</a>
<a name="ln1147">  }</a>
<a name="ln1148"> </a>
<a name="ln1149"> </a>
<a name="ln1150"> </a>
<a name="ln1151"> </a>
<a name="ln1152">  FT_CALLBACK_TABLE_DEF</a>
<a name="ln1153">  const FT_Driver_ClassRec  winfnt_driver_class =</a>
<a name="ln1154">  {</a>
<a name="ln1155">    {</a>
<a name="ln1156">      FT_MODULE_FONT_DRIVER        |</a>
<a name="ln1157">      FT_MODULE_DRIVER_NO_OUTLINES,</a>
<a name="ln1158">      sizeof ( FT_DriverRec ),</a>
<a name="ln1159"> </a>
<a name="ln1160">      &quot;winfonts&quot;,</a>
<a name="ln1161">      0x10000L,</a>
<a name="ln1162">      0x20000L,</a>
<a name="ln1163"> </a>
<a name="ln1164">      0,</a>
<a name="ln1165"> </a>
<a name="ln1166">      0,                  /* FT_Module_Constructor */</a>
<a name="ln1167">      0,                  /* FT_Module_Destructor  */</a>
<a name="ln1168">      winfnt_get_service</a>
<a name="ln1169">    },</a>
<a name="ln1170"> </a>
<a name="ln1171">    sizeof ( FNT_FaceRec ),</a>
<a name="ln1172">    sizeof ( FT_SizeRec ),</a>
<a name="ln1173">    sizeof ( FT_GlyphSlotRec ),</a>
<a name="ln1174"> </a>
<a name="ln1175">    FNT_Face_Init,</a>
<a name="ln1176">    FNT_Face_Done,</a>
<a name="ln1177">    0,                    /* FT_Size_InitFunc */</a>
<a name="ln1178">    0,                    /* FT_Size_DoneFunc */</a>
<a name="ln1179">    0,                    /* FT_Slot_InitFunc */</a>
<a name="ln1180">    0,                    /* FT_Slot_DoneFunc */</a>
<a name="ln1181"> </a>
<a name="ln1182">    FNT_Load_Glyph,</a>
<a name="ln1183"> </a>
<a name="ln1184">    0,                    /* FT_Face_GetKerningFunc  */</a>
<a name="ln1185">    0,                    /* FT_Face_AttachFunc      */</a>
<a name="ln1186">    0,                    /* FT_Face_GetAdvancesFunc */</a>
<a name="ln1187"> </a>
<a name="ln1188">    FNT_Size_Request,</a>
<a name="ln1189">    FNT_Size_Select</a>
<a name="ln1190">  };</a>
<a name="ln1191"> </a>
<a name="ln1192"> </a>
<a name="ln1193">/* END */</a>

</code></pre>
<div class="balloon" rel="1095"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1028/" target="_blank">V1028</a> Possible overflow. Consider casting operands of the 'bitmap->width << 6' operator to the 'FT_Pos' type, not the result.</p></div>
<div class="balloon" rel="1096"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1028/" target="_blank">V1028</a> Possible overflow. Consider casting operands of the 'bitmap->rows << 6' operator to the 'FT_Pos' type, not the result.</p></div>
<div class="balloon" rel="1097"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1028/" target="_blank">V1028</a> Possible overflow. Consider casting operands of the 'bitmap->width << 6' operator to the 'FT_Pos' type, not the result.</p></div>
<div class="balloon" rel="1102"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1028/" target="_blank">V1028</a> Possible overflow. Consider casting operands of the 'bitmap->rows << 6' operator to the 'FT_Pos' type, not the result.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
