
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>ttobjs.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/***************************************************************************/</a>
<a name="ln2">/*                                                                         */</a>
<a name="ln3">/*  ttobjs.c                                                               */</a>
<a name="ln4">/*                                                                         */</a>
<a name="ln5">/*    Objects manager (body).                                              */</a>
<a name="ln6">/*                                                                         */</a>
<a name="ln7">/*  Copyright 1996-2015 by                                                 */</a>
<a name="ln8">/*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</a>
<a name="ln9">/*                                                                         */</a>
<a name="ln10">/*  This file is part of the FreeType project, and may only be used,       */</a>
<a name="ln11">/*  modified, and distributed under the terms of the FreeType project      */</a>
<a name="ln12">/*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</a>
<a name="ln13">/*  this file you indicate that you have read the license and              */</a>
<a name="ln14">/*  understand and accept it fully.                                        */</a>
<a name="ln15">/*                                                                         */</a>
<a name="ln16">/***************************************************************************/</a>
<a name="ln17"> </a>
<a name="ln18"> </a>
<a name="ln19">#include &lt;ft2build.h&gt;</a>
<a name="ln20">#include FT_INTERNAL_DEBUG_H</a>
<a name="ln21">#include FT_INTERNAL_STREAM_H</a>
<a name="ln22">#include FT_TRUETYPE_TAGS_H</a>
<a name="ln23">#include FT_INTERNAL_SFNT_H</a>
<a name="ln24">#include FT_TRUETYPE_DRIVER_H</a>
<a name="ln25"> </a>
<a name="ln26">#include &quot;ttgload.h&quot;</a>
<a name="ln27">#include &quot;ttpload.h&quot;</a>
<a name="ln28"> </a>
<a name="ln29">#include &quot;tterrors.h&quot;</a>
<a name="ln30"> </a>
<a name="ln31">#ifdef TT_USE_BYTECODE_INTERPRETER</a>
<a name="ln32">#include &quot;ttinterp.h&quot;</a>
<a name="ln33">#endif</a>
<a name="ln34"> </a>
<a name="ln35">#ifdef TT_CONFIG_OPTION_UNPATENTED_HINTING</a>
<a name="ln36">#include FT_TRUETYPE_UNPATENTED_H</a>
<a name="ln37">#endif</a>
<a name="ln38"> </a>
<a name="ln39">#ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT</a>
<a name="ln40">#include &quot;ttgxvar.h&quot;</a>
<a name="ln41">#endif</a>
<a name="ln42"> </a>
<a name="ln43">  /*************************************************************************/</a>
<a name="ln44">  /*                                                                       */</a>
<a name="ln45">  /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</a>
<a name="ln46">  /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</a>
<a name="ln47">  /* messages during execution.                                            */</a>
<a name="ln48">  /*                                                                       */</a>
<a name="ln49">#undef  FT_COMPONENT</a>
<a name="ln50">#define FT_COMPONENT  trace_ttobjs</a>
<a name="ln51"> </a>
<a name="ln52"> </a>
<a name="ln53">#ifdef TT_USE_BYTECODE_INTERPRETER</a>
<a name="ln54"> </a>
<a name="ln55">  /*************************************************************************/</a>
<a name="ln56">  /*                                                                       */</a>
<a name="ln57">  /*                       GLYPH ZONE FUNCTIONS                            */</a>
<a name="ln58">  /*                                                                       */</a>
<a name="ln59">  /*************************************************************************/</a>
<a name="ln60"> </a>
<a name="ln61"> </a>
<a name="ln62">  /*************************************************************************/</a>
<a name="ln63">  /*                                                                       */</a>
<a name="ln64">  /* &lt;Function&gt;                                                            */</a>
<a name="ln65">  /*    tt_glyphzone_done                                                  */</a>
<a name="ln66">  /*                                                                       */</a>
<a name="ln67">  /* &lt;Description&gt;                                                         */</a>
<a name="ln68">  /*    Deallocate a glyph zone.                                           */</a>
<a name="ln69">  /*                                                                       */</a>
<a name="ln70">  /* &lt;Input&gt;                                                               */</a>
<a name="ln71">  /*    zone :: A pointer to the target glyph zone.                        */</a>
<a name="ln72">  /*                                                                       */</a>
<a name="ln73">  FT_LOCAL_DEF( void )</a>
<a name="ln74">  tt_glyphzone_done( TT_GlyphZone  zone )</a>
<a name="ln75">  {</a>
<a name="ln76">    FT_Memory  memory = zone-&gt;memory;</a>
<a name="ln77"> </a>
<a name="ln78"> </a>
<a name="ln79">    if ( memory )</a>
<a name="ln80">    {</a>
<a name="ln81">      FT_FREE( zone-&gt;contours );</a>
<a name="ln82">      FT_FREE( zone-&gt;tags );</a>
<a name="ln83">      FT_FREE( zone-&gt;cur );</a>
<a name="ln84">      FT_FREE( zone-&gt;org );</a>
<a name="ln85">      FT_FREE( zone-&gt;orus );</a>
<a name="ln86"> </a>
<a name="ln87">      zone-&gt;max_points   = zone-&gt;n_points   = 0;</a>
<a name="ln88">      zone-&gt;max_contours = zone-&gt;n_contours = 0;</a>
<a name="ln89">      zone-&gt;memory       = NULL;</a>
<a name="ln90">    }</a>
<a name="ln91">  }</a>
<a name="ln92"> </a>
<a name="ln93"> </a>
<a name="ln94">  /*************************************************************************/</a>
<a name="ln95">  /*                                                                       */</a>
<a name="ln96">  /* &lt;Function&gt;                                                            */</a>
<a name="ln97">  /*    tt_glyphzone_new                                                   */</a>
<a name="ln98">  /*                                                                       */</a>
<a name="ln99">  /* &lt;Description&gt;                                                         */</a>
<a name="ln100">  /*    Allocate a new glyph zone.                                         */</a>
<a name="ln101">  /*                                                                       */</a>
<a name="ln102">  /* &lt;Input&gt;                                                               */</a>
<a name="ln103">  /*    memory      :: A handle to the current memory object.              */</a>
<a name="ln104">  /*                                                                       */</a>
<a name="ln105">  /*    maxPoints   :: The capacity of glyph zone in points.               */</a>
<a name="ln106">  /*                                                                       */</a>
<a name="ln107">  /*    maxContours :: The capacity of glyph zone in contours.             */</a>
<a name="ln108">  /*                                                                       */</a>
<a name="ln109">  /* &lt;Output&gt;                                                              */</a>
<a name="ln110">  /*    zone        :: A pointer to the target glyph zone record.          */</a>
<a name="ln111">  /*                                                                       */</a>
<a name="ln112">  /* &lt;Return&gt;                                                              */</a>
<a name="ln113">  /*    FreeType error code.  0 means success.                             */</a>
<a name="ln114">  /*                                                                       */</a>
<a name="ln115">  FT_LOCAL_DEF( FT_Error )</a>
<a name="ln116">  tt_glyphzone_new( FT_Memory     memory,</a>
<a name="ln117">                    FT_UShort     maxPoints,</a>
<a name="ln118">                    FT_Short      maxContours,</a>
<a name="ln119">                    TT_GlyphZone  zone )</a>
<a name="ln120">  {</a>
<a name="ln121">    FT_Error  error;</a>
<a name="ln122"> </a>
<a name="ln123"> </a>
<a name="ln124">    FT_MEM_ZERO( zone, sizeof ( *zone ) );</a>
<a name="ln125">    zone-&gt;memory = memory;</a>
<a name="ln126"> </a>
<a name="ln127">    if ( FT_NEW_ARRAY( zone-&gt;org,      maxPoints   ) ||</a>
<a name="ln128">         FT_NEW_ARRAY( zone-&gt;cur,      maxPoints   ) ||</a>
<a name="ln129">         FT_NEW_ARRAY( zone-&gt;orus,     maxPoints   ) ||</a>
<a name="ln130">         FT_NEW_ARRAY( zone-&gt;tags,     maxPoints   ) ||</a>
<a name="ln131">         FT_NEW_ARRAY( zone-&gt;contours, maxContours ) )</a>
<a name="ln132">    {</a>
<a name="ln133">      tt_glyphzone_done( zone );</a>
<a name="ln134">    }</a>
<a name="ln135">    else</a>
<a name="ln136">    {</a>
<a name="ln137">      zone-&gt;max_points   = maxPoints;</a>
<a name="ln138">      zone-&gt;max_contours = maxContours;</a>
<a name="ln139">    }</a>
<a name="ln140"> </a>
<a name="ln141">    return error;</a>
<a name="ln142">  }</a>
<a name="ln143">#endif /* TT_USE_BYTECODE_INTERPRETER */</a>
<a name="ln144"> </a>
<a name="ln145"> </a>
<a name="ln146">  /* Compare the face with a list of well-known `tricky' fonts. */</a>
<a name="ln147">  /* This list shall be expanded as we find more of them.       */</a>
<a name="ln148"> </a>
<a name="ln149">  static FT_Bool</a>
<a name="ln150">  tt_check_trickyness_family( FT_String*  name )</a>
<a name="ln151">  {</a>
<a name="ln152"> </a>
<a name="ln153">#define TRICK_NAMES_MAX_CHARACTERS  19</a>
<a name="ln154">#define TRICK_NAMES_COUNT            9</a>
<a name="ln155"> </a>
<a name="ln156">    static const char trick_names[TRICK_NAMES_COUNT]</a>
<a name="ln157">                                 [TRICK_NAMES_MAX_CHARACTERS + 1] =</a>
<a name="ln158">    {</a>
<a name="ln159">      &quot;DFKaiSho-SB&quot;,        /* dfkaisb.ttf */</a>
<a name="ln160">      &quot;DFKaiShu&quot;,</a>
<a name="ln161">      &quot;DFKai-SB&quot;,           /* kaiu.ttf */</a>
<a name="ln162">      &quot;HuaTianKaiTi?&quot;,      /* htkt2.ttf */</a>
<a name="ln163">      &quot;HuaTianSongTi?&quot;,     /* htst3.ttf */</a>
<a name="ln164">      &quot;Ming(for ISO10646)&quot;, /* hkscsiic.ttf &amp; iicore.ttf */</a>
<a name="ln165">      &quot;MingLiU&quot;,            /* mingliu.ttf &amp; mingliu.ttc */</a>
<a name="ln166">      &quot;PMingLiU&quot;,           /* mingliu.ttc */</a>
<a name="ln167">      &quot;MingLi43&quot;,           /* mingli.ttf */</a>
<a name="ln168">    };</a>
<a name="ln169"> </a>
<a name="ln170">    int  nn;</a>
<a name="ln171"> </a>
<a name="ln172"> </a>
<a name="ln173">    for ( nn = 0; nn &lt; TRICK_NAMES_COUNT; nn++ )</a>
<a name="ln174">      if ( ft_strstr( name, trick_names[nn] ) )</a>
<a name="ln175">        return TRUE;</a>
<a name="ln176"> </a>
<a name="ln177">    return FALSE;</a>
<a name="ln178">  }</a>
<a name="ln179"> </a>
<a name="ln180"> </a>
<a name="ln181">  /* XXX: This function should be in the `sfnt' module. */</a>
<a name="ln182"> </a>
<a name="ln183">  /* Some PDF generators clear the checksums in the TrueType header table. */</a>
<a name="ln184">  /* For example, Quartz ContextPDF clears all entries, or Bullzip PDF     */</a>
<a name="ln185">  /* Printer clears the entries for subsetted subtables.  We thus have to  */</a>
<a name="ln186">  /* recalculate the checksums  where necessary.                           */</a>
<a name="ln187"> </a>
<a name="ln188">  static FT_UInt32</a>
<a name="ln189">  tt_synth_sfnt_checksum( FT_Stream  stream,</a>
<a name="ln190">                          FT_ULong   length )</a>
<a name="ln191">  {</a>
<a name="ln192">    FT_Error   error;</a>
<a name="ln193">    FT_UInt32  checksum = 0;</a>
<a name="ln194">    FT_UInt    i;</a>
<a name="ln195"> </a>
<a name="ln196"> </a>
<a name="ln197">    if ( FT_FRAME_ENTER( length ) )</a>
<a name="ln198">      return 0;</a>
<a name="ln199"> </a>
<a name="ln200">    for ( ; length &gt; 3; length -= 4 )</a>
<a name="ln201">      checksum += (FT_UInt32)FT_GET_ULONG();</a>
<a name="ln202"> </a>
<a name="ln203">    for ( i = 3; length &gt; 0; length--, i-- )</a>
<a name="ln204">      checksum += (FT_UInt32)FT_GET_BYTE() &lt;&lt; ( i * 8 );</a>
<a name="ln205"> </a>
<a name="ln206">    FT_FRAME_EXIT();</a>
<a name="ln207"> </a>
<a name="ln208">    return checksum;</a>
<a name="ln209">  }</a>
<a name="ln210"> </a>
<a name="ln211"> </a>
<a name="ln212">  /* XXX: This function should be in the `sfnt' module. */</a>
<a name="ln213"> </a>
<a name="ln214">  static FT_ULong</a>
<a name="ln215">  tt_get_sfnt_checksum( TT_Face    face,</a>
<a name="ln216">                        FT_UShort  i )</a>
<a name="ln217">  {</a>
<a name="ln218">#if 0 /* if we believe the written value, use following part. */</a>
<a name="ln219">    if ( face-&gt;dir_tables[i].CheckSum )</a>
<a name="ln220">      return face-&gt;dir_tables[i].CheckSum;</a>
<a name="ln221">#endif</a>
<a name="ln222"> </a>
<a name="ln223">    if ( !face-&gt;goto_table )</a>
<a name="ln224">      return 0;</a>
<a name="ln225"> </a>
<a name="ln226">    if ( face-&gt;goto_table( face,</a>
<a name="ln227">                           face-&gt;dir_tables[i].Tag,</a>
<a name="ln228">                           face-&gt;root.stream,</a>
<a name="ln229">                           NULL ) )</a>
<a name="ln230">      return 0;</a>
<a name="ln231"> </a>
<a name="ln232">    return (FT_ULong)tt_synth_sfnt_checksum( face-&gt;root.stream,</a>
<a name="ln233">                                             face-&gt;dir_tables[i].Length );</a>
<a name="ln234">  }</a>
<a name="ln235"> </a>
<a name="ln236"> </a>
<a name="ln237">  typedef struct tt_sfnt_id_rec_</a>
<a name="ln238">  {</a>
<a name="ln239">    FT_ULong  CheckSum;</a>
<a name="ln240">    FT_ULong  Length;</a>
<a name="ln241"> </a>
<a name="ln242">  } tt_sfnt_id_rec;</a>
<a name="ln243"> </a>
<a name="ln244"> </a>
<a name="ln245">  static FT_Bool</a>
<a name="ln246">  tt_check_trickyness_sfnt_ids( TT_Face  face )</a>
<a name="ln247">  {</a>
<a name="ln248">#define TRICK_SFNT_IDS_PER_FACE   3</a>
<a name="ln249">#define TRICK_SFNT_IDS_NUM_FACES  17</a>
<a name="ln250"> </a>
<a name="ln251">    static const tt_sfnt_id_rec sfnt_id[TRICK_SFNT_IDS_NUM_FACES]</a>
<a name="ln252">                                       [TRICK_SFNT_IDS_PER_FACE] = {</a>
<a name="ln253"> </a>
<a name="ln254">#define TRICK_SFNT_ID_cvt   0</a>
<a name="ln255">#define TRICK_SFNT_ID_fpgm  1</a>
<a name="ln256">#define TRICK_SFNT_ID_prep  2</a>
<a name="ln257"> </a>
<a name="ln258">      { /* MingLiU 1995 */</a>
<a name="ln259">        { 0x05BCF058UL, 0x000002E4UL }, /* cvt  */</a>
<a name="ln260">        { 0x28233BF1UL, 0x000087C4UL }, /* fpgm */</a>
<a name="ln261">        { 0xA344A1EAUL, 0x000001E1UL }  /* prep */</a>
<a name="ln262">      },</a>
<a name="ln263">      { /* MingLiU 1996- */</a>
<a name="ln264">        { 0x05BCF058UL, 0x000002E4UL }, /* cvt  */</a>
<a name="ln265">        { 0x28233BF1UL, 0x000087C4UL }, /* fpgm */</a>
<a name="ln266">        { 0xA344A1EBUL, 0x000001E1UL }  /* prep */</a>
<a name="ln267">      },</a>
<a name="ln268">      { /* DFKaiShu */</a>
<a name="ln269">        { 0x11E5EAD4UL, 0x00000350UL }, /* cvt  */</a>
<a name="ln270">        { 0x5A30CA3BUL, 0x00009063UL }, /* fpgm */</a>
<a name="ln271">        { 0x13A42602UL, 0x0000007EUL }  /* prep */</a>
<a name="ln272">      },</a>
<a name="ln273">      { /* HuaTianKaiTi */</a>
<a name="ln274">        { 0xFFFBFFFCUL, 0x00000008UL }, /* cvt  */</a>
<a name="ln275">        { 0x9C9E48B8UL, 0x0000BEA2UL }, /* fpgm */</a>
<a name="ln276">        { 0x70020112UL, 0x00000008UL }  /* prep */</a>
<a name="ln277">      },</a>
<a name="ln278">      { /* HuaTianSongTi */</a>
<a name="ln279">        { 0xFFFBFFFCUL, 0x00000008UL }, /* cvt  */</a>
<a name="ln280">        { 0x0A5A0483UL, 0x00017C39UL }, /* fpgm */</a>
<a name="ln281">        { 0x70020112UL, 0x00000008UL }  /* prep */</a>
<a name="ln282">      },</a>
<a name="ln283">      { /* NEC fadpop7.ttf */</a>
<a name="ln284">        { 0x00000000UL, 0x00000000UL }, /* cvt  */</a>
<a name="ln285">        { 0x40C92555UL, 0x000000E5UL }, /* fpgm */</a>
<a name="ln286">        { 0xA39B58E3UL, 0x0000117CUL }  /* prep */</a>
<a name="ln287">      },</a>
<a name="ln288">      { /* NEC fadrei5.ttf */</a>
<a name="ln289">        { 0x00000000UL, 0x00000000UL }, /* cvt  */</a>
<a name="ln290">        { 0x33C41652UL, 0x000000E5UL }, /* fpgm */</a>
<a name="ln291">        { 0x26D6C52AUL, 0x00000F6AUL }  /* prep */</a>
<a name="ln292">      },</a>
<a name="ln293">      { /* NEC fangot7.ttf */</a>
<a name="ln294">        { 0x00000000UL, 0x00000000UL }, /* cvt  */</a>
<a name="ln295">        { 0x6DB1651DUL, 0x0000019DUL }, /* fpgm */</a>
<a name="ln296">        { 0x6C6E4B03UL, 0x00002492UL }  /* prep */</a>
<a name="ln297">      },</a>
<a name="ln298">      { /* NEC fangyo5.ttf */</a>
<a name="ln299">        { 0x00000000UL, 0x00000000UL }, /* cvt  */</a>
<a name="ln300">        { 0x40C92555UL, 0x000000E5UL }, /* fpgm */</a>
<a name="ln301">        { 0xDE51FAD0UL, 0x0000117CUL }  /* prep */</a>
<a name="ln302">      },</a>
<a name="ln303">      { /* NEC fankyo5.ttf */</a>
<a name="ln304">        { 0x00000000UL, 0x00000000UL }, /* cvt  */</a>
<a name="ln305">        { 0x85E47664UL, 0x000000E5UL }, /* fpgm */</a>
<a name="ln306">        { 0xA6C62831UL, 0x00001CAAUL }  /* prep */</a>
<a name="ln307">      },</a>
<a name="ln308">      { /* NEC fanrgo5.ttf */</a>
<a name="ln309">        { 0x00000000UL, 0x00000000UL }, /* cvt  */</a>
<a name="ln310">        { 0x2D891CFDUL, 0x0000019DUL }, /* fpgm */</a>
<a name="ln311">        { 0xA0604633UL, 0x00001DE8UL }  /* prep */</a>
<a name="ln312">      },</a>
<a name="ln313">      { /* NEC fangot5.ttc */</a>
<a name="ln314">        { 0x00000000UL, 0x00000000UL }, /* cvt  */</a>
<a name="ln315">        { 0x40AA774CUL, 0x000001CBUL }, /* fpgm */</a>
<a name="ln316">        { 0x9B5CAA96UL, 0x00001F9AUL }  /* prep */</a>
<a name="ln317">      },</a>
<a name="ln318">      { /* NEC fanmin3.ttc */</a>
<a name="ln319">        { 0x00000000UL, 0x00000000UL }, /* cvt  */</a>
<a name="ln320">        { 0x0D3DE9CBUL, 0x00000141UL }, /* fpgm */</a>
<a name="ln321">        { 0xD4127766UL, 0x00002280UL }  /* prep */</a>
<a name="ln322">      },</a>
<a name="ln323">      { /* NEC FA-Gothic, 1996 */</a>
<a name="ln324">        { 0x00000000UL, 0x00000000UL }, /* cvt  */</a>
<a name="ln325">        { 0x4A692698UL, 0x000001F0UL }, /* fpgm */</a>
<a name="ln326">        { 0x340D4346UL, 0x00001FCAUL }  /* prep */</a>
<a name="ln327">      },</a>
<a name="ln328">      { /* NEC FA-Minchou, 1996 */</a>
<a name="ln329">        { 0x00000000UL, 0x00000000UL }, /* cvt  */</a>
<a name="ln330">        { 0xCD34C604UL, 0x00000166UL }, /* fpgm */</a>
<a name="ln331">        { 0x6CF31046UL, 0x000022B0UL }  /* prep */</a>
<a name="ln332">      },</a>
<a name="ln333">      { /* NEC FA-RoundGothicB, 1996 */</a>
<a name="ln334">        { 0x00000000UL, 0x00000000UL }, /* cvt  */</a>
<a name="ln335">        { 0x5DA75315UL, 0x0000019DUL }, /* fpgm */</a>
<a name="ln336">        { 0x40745A5FUL, 0x000022E0UL }  /* prep */</a>
<a name="ln337">      },</a>
<a name="ln338">      { /* NEC FA-RoundGothicM, 1996 */</a>
<a name="ln339">        { 0x00000000UL, 0x00000000UL }, /* cvt  */</a>
<a name="ln340">        { 0xF055FC48UL, 0x000001C2UL }, /* fpgm */</a>
<a name="ln341">        { 0x3900DED3UL, 0x00001E18UL }  /* prep */</a>
<a name="ln342">      }</a>
<a name="ln343">    };</a>
<a name="ln344"> </a>
<a name="ln345">    FT_ULong   checksum;</a>
<a name="ln346">    int        num_matched_ids[TRICK_SFNT_IDS_NUM_FACES];</a>
<a name="ln347">    FT_Bool    has_cvt, has_fpgm, has_prep;</a>
<a name="ln348">    FT_UShort  i;</a>
<a name="ln349">    int        j, k;</a>
<a name="ln350"> </a>
<a name="ln351"> </a>
<a name="ln352">    FT_MEM_SET( num_matched_ids, 0,</a>
<a name="ln353">                sizeof ( int ) * TRICK_SFNT_IDS_NUM_FACES );</a>
<a name="ln354">    has_cvt  = FALSE;</a>
<a name="ln355">    has_fpgm = FALSE;</a>
<a name="ln356">    has_prep = FALSE;</a>
<a name="ln357"> </a>
<a name="ln358">    for ( i = 0; i &lt; face-&gt;num_tables; i++ )</a>
<a name="ln359">    {</a>
<a name="ln360">      checksum = 0;</a>
<a name="ln361"> </a>
<a name="ln362">      switch( face-&gt;dir_tables[i].Tag )</a>
<a name="ln363">      {</a>
<a name="ln364">      case TTAG_cvt:</a>
<a name="ln365">        k = TRICK_SFNT_ID_cvt;</a>
<a name="ln366">        has_cvt  = TRUE;</a>
<a name="ln367">        break;</a>
<a name="ln368"> </a>
<a name="ln369">      case TTAG_fpgm:</a>
<a name="ln370">        k = TRICK_SFNT_ID_fpgm;</a>
<a name="ln371">        has_fpgm = TRUE;</a>
<a name="ln372">        break;</a>
<a name="ln373"> </a>
<a name="ln374">      case TTAG_prep:</a>
<a name="ln375">        k = TRICK_SFNT_ID_prep;</a>
<a name="ln376">        has_prep = TRUE;</a>
<a name="ln377">        break;</a>
<a name="ln378"> </a>
<a name="ln379">      default:</a>
<a name="ln380">        continue;</a>
<a name="ln381">      }</a>
<a name="ln382"> </a>
<a name="ln383">      for ( j = 0; j &lt; TRICK_SFNT_IDS_NUM_FACES; j++ )</a>
<a name="ln384">        if ( face-&gt;dir_tables[i].Length == sfnt_id[j][k].Length )</a>
<a name="ln385">        {</a>
<a name="ln386">          if ( !checksum )</a>
<a name="ln387">            checksum = tt_get_sfnt_checksum( face, i );</a>
<a name="ln388"> </a>
<a name="ln389">          if ( sfnt_id[j][k].CheckSum == checksum )</a>
<a name="ln390">            num_matched_ids[j]++;</a>
<a name="ln391"> </a>
<a name="ln392">          if ( num_matched_ids[j] == TRICK_SFNT_IDS_PER_FACE )</a>
<a name="ln393">            return TRUE;</a>
<a name="ln394">        }</a>
<a name="ln395">    }</a>
<a name="ln396"> </a>
<a name="ln397">    for ( j = 0; j &lt; TRICK_SFNT_IDS_NUM_FACES; j++ )</a>
<a name="ln398">    {</a>
<a name="ln399">      if ( !has_cvt  &amp;&amp; !sfnt_id[j][TRICK_SFNT_ID_cvt].Length )</a>
<a name="ln400">        num_matched_ids[j] ++;</a>
<a name="ln401">      if ( !has_fpgm &amp;&amp; !sfnt_id[j][TRICK_SFNT_ID_fpgm].Length )</a>
<a name="ln402">        num_matched_ids[j] ++;</a>
<a name="ln403">      if ( !has_prep &amp;&amp; !sfnt_id[j][TRICK_SFNT_ID_prep].Length )</a>
<a name="ln404">        num_matched_ids[j] ++;</a>
<a name="ln405">      if ( num_matched_ids[j] == TRICK_SFNT_IDS_PER_FACE )</a>
<a name="ln406">        return TRUE;</a>
<a name="ln407">    }</a>
<a name="ln408"> </a>
<a name="ln409">    return FALSE;</a>
<a name="ln410">  }</a>
<a name="ln411"> </a>
<a name="ln412"> </a>
<a name="ln413">  static FT_Bool</a>
<a name="ln414">  tt_check_trickyness( FT_Face  face )</a>
<a name="ln415">  {</a>
<a name="ln416">    if ( !face )</a>
<a name="ln417">      return FALSE;</a>
<a name="ln418"> </a>
<a name="ln419">    /* For first, check the face name for quick check. */</a>
<a name="ln420">    if ( face-&gt;family_name                               &amp;&amp;</a>
<a name="ln421">         tt_check_trickyness_family( face-&gt;family_name ) )</a>
<a name="ln422">      return TRUE;</a>
<a name="ln423"> </a>
<a name="ln424">    /* Type42 fonts may lack `name' tables, we thus try to identify */</a>
<a name="ln425">    /* tricky fonts by checking the checksums of Type42-persistent  */</a>
<a name="ln426">    /* sfnt tables (`cvt', `fpgm', and `prep').                     */</a>
<a name="ln427">    if ( tt_check_trickyness_sfnt_ids( (TT_Face)face ) )</a>
<a name="ln428">      return TRUE;</a>
<a name="ln429"> </a>
<a name="ln430">    return FALSE;</a>
<a name="ln431">  }</a>
<a name="ln432"> </a>
<a name="ln433"> </a>
<a name="ln434">  /* Check whether `.notdef' is the only glyph in the `loca' table. */</a>
<a name="ln435">  static FT_Bool</a>
<a name="ln436">  tt_check_single_notdef( FT_Face  ttface )</a>
<a name="ln437">  {</a>
<a name="ln438">    FT_Bool   result = FALSE;</a>
<a name="ln439"> </a>
<a name="ln440">    TT_Face   face = (TT_Face)ttface;</a>
<a name="ln441">    FT_UInt   asize;</a>
<a name="ln442">    FT_ULong  i;</a>
<a name="ln443">    FT_ULong  glyph_index = 0;</a>
<a name="ln444">    FT_UInt   count       = 0;</a>
<a name="ln445"> </a>
<a name="ln446"> </a>
<a name="ln447">    for( i = 0; i &lt; face-&gt;num_locations; i++ )</a>
<a name="ln448">    {</a>
<a name="ln449">      tt_face_get_location( face, i, &amp;asize );</a>
<a name="ln450">      if ( asize &gt; 0 )</a>
<a name="ln451">      {</a>
<a name="ln452">        count += 1;</a>
<a name="ln453">        if ( count &gt; 1 )</a>
<a name="ln454">          break;</a>
<a name="ln455">        glyph_index = i;</a>
<a name="ln456">      }</a>
<a name="ln457">    }</a>
<a name="ln458"> </a>
<a name="ln459">    /* Only have a single outline. */</a>
<a name="ln460">    if ( count == 1 )</a>
<a name="ln461">    {</a>
<a name="ln462">      if ( glyph_index == 0 )</a>
<a name="ln463">        result = TRUE;</a>
<a name="ln464">      else</a>
<a name="ln465">      {</a>
<a name="ln466">        /* FIXME: Need to test glyphname == .notdef ? */</a>
<a name="ln467">        FT_Error error;</a>
<a name="ln468">        char buf[8];</a>
<a name="ln469"> </a>
<a name="ln470"> </a>
<a name="ln471">        error = FT_Get_Glyph_Name( ttface, glyph_index, buf, 8 );</a>
<a name="ln472">        if ( !error                                            &amp;&amp;</a>
<a name="ln473">             buf[0] == '.' &amp;&amp; !ft_strncmp( buf, &quot;.notdef&quot;, 8 ) )</a>
<a name="ln474">          result = TRUE;</a>
<a name="ln475">      }</a>
<a name="ln476">    }</a>
<a name="ln477"> </a>
<a name="ln478">    return result;</a>
<a name="ln479">  }</a>
<a name="ln480"> </a>
<a name="ln481"> </a>
<a name="ln482">  /*************************************************************************/</a>
<a name="ln483">  /*                                                                       */</a>
<a name="ln484">  /* &lt;Function&gt;                                                            */</a>
<a name="ln485">  /*    tt_face_init                                                       */</a>
<a name="ln486">  /*                                                                       */</a>
<a name="ln487">  /* &lt;Description&gt;                                                         */</a>
<a name="ln488">  /*    Initialize a given TrueType face object.                           */</a>
<a name="ln489">  /*                                                                       */</a>
<a name="ln490">  /* &lt;Input&gt;                                                               */</a>
<a name="ln491">  /*    stream     :: The source font stream.                              */</a>
<a name="ln492">  /*                                                                       */</a>
<a name="ln493">  /*    face_index :: The index of the TrueType font, if we are opening a  */</a>
<a name="ln494">  /*                  collection, in bits 0-15.  The numbered instance     */</a>
<a name="ln495">  /*                  index~+~1 of a GX (sub)font, if applicable, in bits  */</a>
<a name="ln496">  /*                  16-30.                                               */</a>
<a name="ln497">  /*                                                                       */</a>
<a name="ln498">  /*    num_params :: Number of additional generic parameters.  Ignored.   */</a>
<a name="ln499">  /*                                                                       */</a>
<a name="ln500">  /*    params     :: Additional generic parameters.  Ignored.             */</a>
<a name="ln501">  /*                                                                       */</a>
<a name="ln502">  /* &lt;InOut&gt;                                                               */</a>
<a name="ln503">  /*    face       :: The newly built face object.                         */</a>
<a name="ln504">  /*                                                                       */</a>
<a name="ln505">  /* &lt;Return&gt;                                                              */</a>
<a name="ln506">  /*    FreeType error code.  0 means success.                             */</a>
<a name="ln507">  /*                                                                       */</a>
<a name="ln508">  FT_LOCAL_DEF( FT_Error )</a>
<a name="ln509">  tt_face_init( FT_Stream      stream,</a>
<a name="ln510">                FT_Face        ttface,      /* TT_Face */</a>
<a name="ln511">                FT_Int         face_index,</a>
<a name="ln512">                FT_Int         num_params,</a>
<a name="ln513">                FT_Parameter*  params )</a>
<a name="ln514">  {</a>
<a name="ln515">    FT_Error      error;</a>
<a name="ln516">    FT_Library    library;</a>
<a name="ln517">    SFNT_Service  sfnt;</a>
<a name="ln518">    TT_Face       face = (TT_Face)ttface;</a>
<a name="ln519"> </a>
<a name="ln520"> </a>
<a name="ln521">    FT_TRACE2(( &quot;TTF driver\n&quot; ));</a>
<a name="ln522"> </a>
<a name="ln523">    library = ttface-&gt;driver-&gt;root.library;</a>
<a name="ln524"> </a>
<a name="ln525">    sfnt = (SFNT_Service)FT_Get_Module_Interface( library, &quot;sfnt&quot; );</a>
<a name="ln526">    if ( !sfnt )</a>
<a name="ln527">    {</a>
<a name="ln528">      FT_ERROR(( &quot;tt_face_init: cannot access `sfnt' module\n&quot; ));</a>
<a name="ln529">      error = FT_THROW( Missing_Module );</a>
<a name="ln530">      goto Exit;</a>
<a name="ln531">    }</a>
<a name="ln532"> </a>
<a name="ln533">    /* create input stream from resource */</a>
<a name="ln534">    if ( FT_STREAM_SEEK( 0 ) )</a>
<a name="ln535">      goto Exit;</a>
<a name="ln536"> </a>
<a name="ln537">    /* check that we have a valid TrueType file */</a>
<a name="ln538">    error = sfnt-&gt;init_face( stream, face, face_index, num_params, params );</a>
<a name="ln539"> </a>
<a name="ln540">    /* Stream may have changed. */</a>
<a name="ln541">    stream = face-&gt;root.stream;</a>
<a name="ln542"> </a>
<a name="ln543">    if ( error )</a>
<a name="ln544">      goto Exit;</a>
<a name="ln545"> </a>
<a name="ln546">    /* We must also be able to accept Mac/GX fonts, as well as OT ones. */</a>
<a name="ln547">    /* The 0x00020000 tag is completely undocumented; some fonts from   */</a>
<a name="ln548">    /* Arphic made for Chinese Windows 3.1 have this.                   */</a>
<a name="ln549">    if ( face-&gt;format_tag != 0x00010000L &amp;&amp;    /* MS fonts  */</a>
<a name="ln550">         face-&gt;format_tag != 0x00020000L &amp;&amp;    /* CJK fonts for Win 3.1 */</a>
<a name="ln551">         face-&gt;format_tag != TTAG_true   )     /* Mac fonts */</a>
<a name="ln552">    {</a>
<a name="ln553">      FT_TRACE2(( &quot;  not a TTF font\n&quot; ));</a>
<a name="ln554">      goto Bad_Format;</a>
<a name="ln555">    }</a>
<a name="ln556"> </a>
<a name="ln557">#ifdef TT_USE_BYTECODE_INTERPRETER</a>
<a name="ln558">    ttface-&gt;face_flags |= FT_FACE_FLAG_HINTER;</a>
<a name="ln559">#endif</a>
<a name="ln560"> </a>
<a name="ln561">    /* If we are performing a simple font format check, exit immediately. */</a>
<a name="ln562">    if ( face_index &lt; 0 )</a>
<a name="ln563">      return FT_Err_Ok;</a>
<a name="ln564"> </a>
<a name="ln565">    /* Load font directory */</a>
<a name="ln566">    error = sfnt-&gt;load_face( stream, face, face_index, num_params, params );</a>
<a name="ln567">    if ( error )</a>
<a name="ln568">      goto Exit;</a>
<a name="ln569"> </a>
<a name="ln570">    if ( tt_check_trickyness( ttface ) )</a>
<a name="ln571">      ttface-&gt;face_flags |= FT_FACE_FLAG_TRICKY;</a>
<a name="ln572"> </a>
<a name="ln573">    error = tt_face_load_hdmx( face, stream );</a>
<a name="ln574">    if ( error )</a>
<a name="ln575">      goto Exit;</a>
<a name="ln576"> </a>
<a name="ln577">    if ( FT_IS_SCALABLE( ttface ) )</a>
<a name="ln578">    {</a>
<a name="ln579"> </a>
<a name="ln580">#ifdef FT_CONFIG_OPTION_INCREMENTAL</a>
<a name="ln581"> </a>
<a name="ln582">      if ( !ttface-&gt;internal-&gt;incremental_interface )</a>
<a name="ln583">        error = tt_face_load_loca( face, stream );</a>
<a name="ln584">      if ( !error )</a>
<a name="ln585">        error = tt_face_load_cvt( face, stream );</a>
<a name="ln586">      if ( !error )</a>
<a name="ln587">        error = tt_face_load_fpgm( face, stream );</a>
<a name="ln588">      if ( !error )</a>
<a name="ln589">        error = tt_face_load_prep( face, stream );</a>
<a name="ln590"> </a>
<a name="ln591">      /* Check the scalable flag based on `loca'. */</a>
<a name="ln592">      if ( !ttface-&gt;internal-&gt;incremental_interface &amp;&amp;</a>
<a name="ln593">           ttface-&gt;num_fixed_sizes                  &amp;&amp;</a>
<a name="ln594">           face-&gt;glyph_locations                    &amp;&amp;</a>
<a name="ln595">           tt_check_single_notdef( ttface )         )</a>
<a name="ln596">      {</a>
<a name="ln597">        FT_TRACE5(( &quot;tt_face_init:&quot;</a>
<a name="ln598">                    &quot; Only the `.notdef' glyph has an outline.\n&quot;</a>
<a name="ln599">                    &quot;             &quot;</a>
<a name="ln600">                    &quot; Resetting scalable flag to FALSE.\n&quot; ));</a>
<a name="ln601"> </a>
<a name="ln602">        ttface-&gt;face_flags &amp;= ~FT_FACE_FLAG_SCALABLE;</a>
<a name="ln603">      }</a>
<a name="ln604"> </a>
<a name="ln605">#else /* !FT_CONFIG_OPTION_INCREMENTAL */</a>
<a name="ln606"> </a>
<a name="ln607">      if ( !error )</a>
<a name="ln608">        error = tt_face_load_loca( face, stream );</a>
<a name="ln609">      if ( !error )</a>
<a name="ln610">        error = tt_face_load_cvt( face, stream );</a>
<a name="ln611">      if ( !error )</a>
<a name="ln612">        error = tt_face_load_fpgm( face, stream );</a>
<a name="ln613">      if ( !error )</a>
<a name="ln614">        error = tt_face_load_prep( face, stream );</a>
<a name="ln615"> </a>
<a name="ln616">      /* Check the scalable flag based on `loca'. */</a>
<a name="ln617">      if ( ttface-&gt;num_fixed_sizes          &amp;&amp;</a>
<a name="ln618">           face-&gt;glyph_locations            &amp;&amp;</a>
<a name="ln619">           tt_check_single_notdef( ttface ) )</a>
<a name="ln620">      {</a>
<a name="ln621">        FT_TRACE5(( &quot;tt_face_init:&quot;</a>
<a name="ln622">                    &quot; Only the `.notdef' glyph has an outline.\n&quot;</a>
<a name="ln623">                    &quot;             &quot;</a>
<a name="ln624">                    &quot; Resetting scalable flag to FALSE.\n&quot; ));</a>
<a name="ln625"> </a>
<a name="ln626">        ttface-&gt;face_flags &amp;= ~FT_FACE_FLAG_SCALABLE;</a>
<a name="ln627">      }</a>
<a name="ln628"> </a>
<a name="ln629">#endif /* !FT_CONFIG_OPTION_INCREMENTAL */</a>
<a name="ln630"> </a>
<a name="ln631">    }</a>
<a name="ln632"> </a>
<a name="ln633">#ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT</a>
<a name="ln634"> </a>
<a name="ln635">    {</a>
<a name="ln636">      FT_Int  instance_index = face_index &gt;&gt; 16;</a>
<a name="ln637"> </a>
<a name="ln638"> </a>
<a name="ln639">      if ( FT_HAS_MULTIPLE_MASTERS( ttface ) &amp;&amp;</a>
<a name="ln640">           instance_index &gt; 0                )</a>
<a name="ln641">      {</a>
<a name="ln642">        error = TT_Get_MM_Var( face, NULL );</a>
<a name="ln643">        if ( error )</a>
<a name="ln644">          goto Exit;</a>
<a name="ln645"> </a>
<a name="ln646">        if ( face-&gt;blend-&gt;mmvar-&gt;namedstyle )</a>
<a name="ln647">        {</a>
<a name="ln648">          FT_Memory  memory = ttface-&gt;memory;</a>
<a name="ln649"> </a>
<a name="ln650">          FT_Var_Named_Style*  named_style;</a>
<a name="ln651">          FT_String*           style_name;</a>
<a name="ln652"> </a>
<a name="ln653"> </a>
<a name="ln654">          /* in `face_index', the instance index starts with value 1 */</a>
<a name="ln655">          named_style = face-&gt;blend-&gt;mmvar-&gt;namedstyle + instance_index - 1;</a>
<a name="ln656">          error = sfnt-&gt;get_name( face,</a>
<a name="ln657">                                  (FT_UShort)named_style-&gt;strid,</a>
<a name="ln658">                                  &amp;style_name );</a>
<a name="ln659">          if ( error )</a>
<a name="ln660">            goto Exit;</a>
<a name="ln661"> </a>
<a name="ln662">          /* set style name; if already set, replace it */</a>
<a name="ln663">          if ( face-&gt;root.style_name )</a>
<a name="ln664">            FT_FREE( face-&gt;root.style_name );</a>
<a name="ln665">          face-&gt;root.style_name = style_name;</a>
<a name="ln666"> </a>
<a name="ln667">          /* finally, select the named instance */</a>
<a name="ln668">          error = TT_Set_Var_Design( face,</a>
<a name="ln669">                                     face-&gt;blend-&gt;mmvar-&gt;num_axis,</a>
<a name="ln670">                                     named_style-&gt;coords );</a>
<a name="ln671">          if ( error )</a>
<a name="ln672">            goto Exit;</a>
<a name="ln673">        }</a>
<a name="ln674">      }</a>
<a name="ln675">    }</a>
<a name="ln676"> </a>
<a name="ln677">#endif /* TT_CONFIG_OPTION_GX_VAR_SUPPORT */</a>
<a name="ln678"> </a>
<a name="ln679">#if defined( TT_CONFIG_OPTION_UNPATENTED_HINTING    ) &amp;&amp; \</a>
<a name="ln680">    !defined( TT_CONFIG_OPTION_BYTECODE_INTERPRETER )</a>
<a name="ln681"> </a>
<a name="ln682">    {</a>
<a name="ln683">      FT_Bool  unpatented_hinting;</a>
<a name="ln684">      int      i;</a>
<a name="ln685"> </a>
<a name="ln686"> </a>
<a name="ln687">      /* Determine whether unpatented hinting is to be used for this face. */</a>
<a name="ln688">      unpatented_hinting = FT_BOOL</a>
<a name="ln689">        ( library-&gt;debug_hooks[FT_DEBUG_HOOK_UNPATENTED_HINTING] != NULL );</a>
<a name="ln690"> </a>
<a name="ln691">      for ( i = 0; i &lt; num_params &amp;&amp; !face-&gt;unpatented_hinting; i++ )</a>
<a name="ln692">        if ( params[i].tag == FT_PARAM_TAG_UNPATENTED_HINTING )</a>
<a name="ln693">          unpatented_hinting = TRUE;</a>
<a name="ln694"> </a>
<a name="ln695">      if ( !unpatented_hinting )</a>
<a name="ln696">        ttface-&gt;internal-&gt;ignore_unpatented_hinter = TRUE;</a>
<a name="ln697">    }</a>
<a name="ln698"> </a>
<a name="ln699">#endif /* TT_CONFIG_OPTION_UNPATENTED_HINTING &amp;&amp;</a>
<a name="ln700">          !TT_CONFIG_OPTION_BYTECODE_INTERPRETER */</a>
<a name="ln701"> </a>
<a name="ln702">    /* initialize standard glyph loading routines */</a>
<a name="ln703">    TT_Init_Glyph_Loading( face );</a>
<a name="ln704"> </a>
<a name="ln705">  Exit:</a>
<a name="ln706">    return error;</a>
<a name="ln707"> </a>
<a name="ln708">  Bad_Format:</a>
<a name="ln709">    error = FT_THROW( Unknown_File_Format );</a>
<a name="ln710">    goto Exit;</a>
<a name="ln711">  }</a>
<a name="ln712"> </a>
<a name="ln713"> </a>
<a name="ln714">  /*************************************************************************/</a>
<a name="ln715">  /*                                                                       */</a>
<a name="ln716">  /* &lt;Function&gt;                                                            */</a>
<a name="ln717">  /*    tt_face_done                                                       */</a>
<a name="ln718">  /*                                                                       */</a>
<a name="ln719">  /* &lt;Description&gt;                                                         */</a>
<a name="ln720">  /*    Finalize a given face object.                                      */</a>
<a name="ln721">  /*                                                                       */</a>
<a name="ln722">  /* &lt;Input&gt;                                                               */</a>
<a name="ln723">  /*    face :: A pointer to the face object to destroy.                   */</a>
<a name="ln724">  /*                                                                       */</a>
<a name="ln725">  FT_LOCAL_DEF( void )</a>
<a name="ln726">  tt_face_done( FT_Face  ttface )           /* TT_Face */</a>
<a name="ln727">  {</a>
<a name="ln728">    TT_Face       face = (TT_Face)ttface;</a>
<a name="ln729">    FT_Memory     memory;</a>
<a name="ln730">    FT_Stream     stream;</a>
<a name="ln731">    SFNT_Service  sfnt;</a>
<a name="ln732"> </a>
<a name="ln733"> </a>
<a name="ln734">    if ( !face )</a>
<a name="ln735">      return;</a>
<a name="ln736"> </a>
<a name="ln737">    memory = ttface-&gt;memory;</a>
<a name="ln738">    stream = ttface-&gt;stream;</a>
<a name="ln739">    sfnt   = (SFNT_Service)face-&gt;sfnt;</a>
<a name="ln740"> </a>
<a name="ln741">    /* for `extended TrueType formats' (i.e. compressed versions) */</a>
<a name="ln742">    if ( face-&gt;extra.finalizer )</a>
<a name="ln743">      face-&gt;extra.finalizer( face-&gt;extra.data );</a>
<a name="ln744"> </a>
<a name="ln745">    if ( sfnt )</a>
<a name="ln746">      sfnt-&gt;done_face( face );</a>
<a name="ln747"> </a>
<a name="ln748">    /* freeing the locations table */</a>
<a name="ln749">    tt_face_done_loca( face );</a>
<a name="ln750"> </a>
<a name="ln751">    tt_face_free_hdmx( face );</a>
<a name="ln752"> </a>
<a name="ln753">    /* freeing the CVT */</a>
<a name="ln754">    FT_FREE( face-&gt;cvt );</a>
<a name="ln755">    face-&gt;cvt_size = 0;</a>
<a name="ln756"> </a>
<a name="ln757">    /* freeing the programs */</a>
<a name="ln758">    FT_FRAME_RELEASE( face-&gt;font_program );</a>
<a name="ln759">    FT_FRAME_RELEASE( face-&gt;cvt_program );</a>
<a name="ln760">    face-&gt;font_program_size = 0;</a>
<a name="ln761">    face-&gt;cvt_program_size  = 0;</a>
<a name="ln762"> </a>
<a name="ln763">#ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT</a>
<a name="ln764">    tt_done_blend( memory, face-&gt;blend );</a>
<a name="ln765">    face-&gt;blend = NULL;</a>
<a name="ln766">#endif</a>
<a name="ln767">  }</a>
<a name="ln768"> </a>
<a name="ln769"> </a>
<a name="ln770">  /*************************************************************************/</a>
<a name="ln771">  /*                                                                       */</a>
<a name="ln772">  /*                           SIZE  FUNCTIONS                             */</a>
<a name="ln773">  /*                                                                       */</a>
<a name="ln774">  /*************************************************************************/</a>
<a name="ln775"> </a>
<a name="ln776">#ifdef TT_USE_BYTECODE_INTERPRETER</a>
<a name="ln777"> </a>
<a name="ln778">  /*************************************************************************/</a>
<a name="ln779">  /*                                                                       */</a>
<a name="ln780">  /* &lt;Function&gt;                                                            */</a>
<a name="ln781">  /*    tt_size_run_fpgm                                                   */</a>
<a name="ln782">  /*                                                                       */</a>
<a name="ln783">  /* &lt;Description&gt;                                                         */</a>
<a name="ln784">  /*    Run the font program.                                              */</a>
<a name="ln785">  /*                                                                       */</a>
<a name="ln786">  /* &lt;Input&gt;                                                               */</a>
<a name="ln787">  /*    size     :: A handle to the size object.                           */</a>
<a name="ln788">  /*                                                                       */</a>
<a name="ln789">  /*    pedantic :: Set if bytecode execution should be pedantic.          */</a>
<a name="ln790">  /*                                                                       */</a>
<a name="ln791">  /* &lt;Return&gt;                                                              */</a>
<a name="ln792">  /*    FreeType error code.  0 means success.                             */</a>
<a name="ln793">  /*                                                                       */</a>
<a name="ln794">  FT_LOCAL_DEF( FT_Error )</a>
<a name="ln795">  tt_size_run_fpgm( TT_Size  size,</a>
<a name="ln796">                    FT_Bool  pedantic )</a>
<a name="ln797">  {</a>
<a name="ln798">    TT_Face         face = (TT_Face)size-&gt;root.face;</a>
<a name="ln799">    TT_ExecContext  exec;</a>
<a name="ln800">    FT_Error        error;</a>
<a name="ln801"> </a>
<a name="ln802"> </a>
<a name="ln803">    exec = size-&gt;context;</a>
<a name="ln804"> </a>
<a name="ln805">    error = TT_Load_Context( exec, face, size );</a>
<a name="ln806">    if ( error )</a>
<a name="ln807">      return error;</a>
<a name="ln808"> </a>
<a name="ln809">    exec-&gt;callTop = 0;</a>
<a name="ln810">    exec-&gt;top     = 0;</a>
<a name="ln811"> </a>
<a name="ln812">    exec-&gt;period    = 64;</a>
<a name="ln813">    exec-&gt;phase     = 0;</a>
<a name="ln814">    exec-&gt;threshold = 0;</a>
<a name="ln815"> </a>
<a name="ln816">    exec-&gt;instruction_trap = FALSE;</a>
<a name="ln817">    exec-&gt;F_dot_P          = 0x4000L;</a>
<a name="ln818"> </a>
<a name="ln819">    exec-&gt;pedantic_hinting = pedantic;</a>
<a name="ln820"> </a>
<a name="ln821">    {</a>
<a name="ln822">      FT_Size_Metrics*  metrics    = &amp;exec-&gt;metrics;</a>
<a name="ln823">      TT_Size_Metrics*  tt_metrics = &amp;exec-&gt;tt_metrics;</a>
<a name="ln824"> </a>
<a name="ln825"> </a>
<a name="ln826">      metrics-&gt;x_ppem   = 0;</a>
<a name="ln827">      metrics-&gt;y_ppem   = 0;</a>
<a name="ln828">      metrics-&gt;x_scale  = 0;</a>
<a name="ln829">      metrics-&gt;y_scale  = 0;</a>
<a name="ln830"> </a>
<a name="ln831">      tt_metrics-&gt;ppem  = 0;</a>
<a name="ln832">      tt_metrics-&gt;scale = 0;</a>
<a name="ln833">      tt_metrics-&gt;ratio = 0x10000L;</a>
<a name="ln834">    }</a>
<a name="ln835"> </a>
<a name="ln836">    /* allow font program execution */</a>
<a name="ln837">    TT_Set_CodeRange( exec,</a>
<a name="ln838">                      tt_coderange_font,</a>
<a name="ln839">                      face-&gt;font_program,</a>
<a name="ln840">                      (FT_Long)face-&gt;font_program_size );</a>
<a name="ln841"> </a>
<a name="ln842">    /* disable CVT and glyph programs coderange */</a>
<a name="ln843">    TT_Clear_CodeRange( exec, tt_coderange_cvt );</a>
<a name="ln844">    TT_Clear_CodeRange( exec, tt_coderange_glyph );</a>
<a name="ln845"> </a>
<a name="ln846">    if ( face-&gt;font_program_size &gt; 0 )</a>
<a name="ln847">    {</a>
<a name="ln848">      TT_Goto_CodeRange( exec, tt_coderange_font, 0 );</a>
<a name="ln849"> </a>
<a name="ln850">      FT_TRACE4(( &quot;Executing `fpgm' table.\n&quot; ));</a>
<a name="ln851">      error = face-&gt;interpreter( exec );</a>
<a name="ln852">    }</a>
<a name="ln853">    else</a>
<a name="ln854">      error = FT_Err_Ok;</a>
<a name="ln855"> </a>
<a name="ln856">    size-&gt;bytecode_ready = error;</a>
<a name="ln857"> </a>
<a name="ln858">    if ( !error )</a>
<a name="ln859">      TT_Save_Context( exec, size );</a>
<a name="ln860"> </a>
<a name="ln861">    return error;</a>
<a name="ln862">  }</a>
<a name="ln863"> </a>
<a name="ln864"> </a>
<a name="ln865">  /*************************************************************************/</a>
<a name="ln866">  /*                                                                       */</a>
<a name="ln867">  /* &lt;Function&gt;                                                            */</a>
<a name="ln868">  /*    tt_size_run_prep                                                   */</a>
<a name="ln869">  /*                                                                       */</a>
<a name="ln870">  /* &lt;Description&gt;                                                         */</a>
<a name="ln871">  /*    Run the control value program.                                     */</a>
<a name="ln872">  /*                                                                       */</a>
<a name="ln873">  /* &lt;Input&gt;                                                               */</a>
<a name="ln874">  /*    size     :: A handle to the size object.                           */</a>
<a name="ln875">  /*                                                                       */</a>
<a name="ln876">  /*    pedantic :: Set if bytecode execution should be pedantic.          */</a>
<a name="ln877">  /*                                                                       */</a>
<a name="ln878">  /* &lt;Return&gt;                                                              */</a>
<a name="ln879">  /*    FreeType error code.  0 means success.                             */</a>
<a name="ln880">  /*                                                                       */</a>
<a name="ln881">  FT_LOCAL_DEF( FT_Error )</a>
<a name="ln882">  tt_size_run_prep( TT_Size  size,</a>
<a name="ln883">                    FT_Bool  pedantic )</a>
<a name="ln884">  {</a>
<a name="ln885">    TT_Face         face = (TT_Face)size-&gt;root.face;</a>
<a name="ln886">    TT_ExecContext  exec;</a>
<a name="ln887">    FT_Error        error;</a>
<a name="ln888"> </a>
<a name="ln889"> </a>
<a name="ln890">    exec = size-&gt;context;</a>
<a name="ln891"> </a>
<a name="ln892">    error = TT_Load_Context( exec, face, size );</a>
<a name="ln893">    if ( error )</a>
<a name="ln894">      return error;</a>
<a name="ln895"> </a>
<a name="ln896">    exec-&gt;callTop = 0;</a>
<a name="ln897">    exec-&gt;top     = 0;</a>
<a name="ln898"> </a>
<a name="ln899">    exec-&gt;instruction_trap = FALSE;</a>
<a name="ln900"> </a>
<a name="ln901">    exec-&gt;pedantic_hinting = pedantic;</a>
<a name="ln902"> </a>
<a name="ln903">    TT_Set_CodeRange( exec,</a>
<a name="ln904">                      tt_coderange_cvt,</a>
<a name="ln905">                      face-&gt;cvt_program,</a>
<a name="ln906">                      (FT_Long)face-&gt;cvt_program_size );</a>
<a name="ln907"> </a>
<a name="ln908">    TT_Clear_CodeRange( exec, tt_coderange_glyph );</a>
<a name="ln909"> </a>
<a name="ln910">    if ( face-&gt;cvt_program_size &gt; 0 )</a>
<a name="ln911">    {</a>
<a name="ln912">      TT_Goto_CodeRange( exec, tt_coderange_cvt, 0 );</a>
<a name="ln913"> </a>
<a name="ln914">      FT_TRACE4(( &quot;Executing `prep' table.\n&quot; ));</a>
<a name="ln915"> </a>
<a name="ln916">      error = face-&gt;interpreter( exec );</a>
<a name="ln917">    }</a>
<a name="ln918">    else</a>
<a name="ln919">      error = FT_Err_Ok;</a>
<a name="ln920"> </a>
<a name="ln921">    size-&gt;cvt_ready = error;</a>
<a name="ln922"> </a>
<a name="ln923">    /* UNDOCUMENTED!  The MS rasterizer doesn't allow the following */</a>
<a name="ln924">    /* graphics state variables to be modified by the CVT program.  */</a>
<a name="ln925"> </a>
<a name="ln926">    exec-&gt;GS.dualVector.x = 0x4000;</a>
<a name="ln927">    exec-&gt;GS.dualVector.y = 0;</a>
<a name="ln928">    exec-&gt;GS.projVector.x = 0x4000;</a>
<a name="ln929">    exec-&gt;GS.projVector.y = 0x0;</a>
<a name="ln930">    exec-&gt;GS.freeVector.x = 0x4000;</a>
<a name="ln931">    exec-&gt;GS.freeVector.y = 0x0;</a>
<a name="ln932"> </a>
<a name="ln933">    exec-&gt;GS.rp0 = 0;</a>
<a name="ln934">    exec-&gt;GS.rp1 = 0;</a>
<a name="ln935">    exec-&gt;GS.rp2 = 0;</a>
<a name="ln936"> </a>
<a name="ln937">    exec-&gt;GS.gep0 = 1;</a>
<a name="ln938">    exec-&gt;GS.gep1 = 1;</a>
<a name="ln939">    exec-&gt;GS.gep2 = 1;</a>
<a name="ln940"> </a>
<a name="ln941">    exec-&gt;GS.loop = 1;</a>
<a name="ln942"> </a>
<a name="ln943">    /* save as default graphics state */</a>
<a name="ln944">    size-&gt;GS = exec-&gt;GS;</a>
<a name="ln945"> </a>
<a name="ln946">    TT_Save_Context( exec, size );</a>
<a name="ln947"> </a>
<a name="ln948">    return error;</a>
<a name="ln949">  }</a>
<a name="ln950"> </a>
<a name="ln951"> </a>
<a name="ln952">  static void</a>
<a name="ln953">  tt_size_done_bytecode( FT_Size  ftsize )</a>
<a name="ln954">  {</a>
<a name="ln955">    TT_Size    size   = (TT_Size)ftsize;</a>
<a name="ln956">    TT_Face    face   = (TT_Face)ftsize-&gt;face;</a>
<a name="ln957">    FT_Memory  memory = face-&gt;root.memory;</a>
<a name="ln958"> </a>
<a name="ln959">    if ( size-&gt;context )</a>
<a name="ln960">    {</a>
<a name="ln961">      TT_Done_Context( size-&gt;context );</a>
<a name="ln962">      size-&gt;context = NULL;</a>
<a name="ln963">    }</a>
<a name="ln964"> </a>
<a name="ln965">    FT_FREE( size-&gt;cvt );</a>
<a name="ln966">    size-&gt;cvt_size = 0;</a>
<a name="ln967"> </a>
<a name="ln968">    /* free storage area */</a>
<a name="ln969">    FT_FREE( size-&gt;storage );</a>
<a name="ln970">    size-&gt;storage_size = 0;</a>
<a name="ln971"> </a>
<a name="ln972">    /* twilight zone */</a>
<a name="ln973">    tt_glyphzone_done( &amp;size-&gt;twilight );</a>
<a name="ln974"> </a>
<a name="ln975">    FT_FREE( size-&gt;function_defs );</a>
<a name="ln976">    FT_FREE( size-&gt;instruction_defs );</a>
<a name="ln977"> </a>
<a name="ln978">    size-&gt;num_function_defs    = 0;</a>
<a name="ln979">    size-&gt;max_function_defs    = 0;</a>
<a name="ln980">    size-&gt;num_instruction_defs = 0;</a>
<a name="ln981">    size-&gt;max_instruction_defs = 0;</a>
<a name="ln982"> </a>
<a name="ln983">    size-&gt;max_func = 0;</a>
<a name="ln984">    size-&gt;max_ins  = 0;</a>
<a name="ln985"> </a>
<a name="ln986">    size-&gt;bytecode_ready = -1;</a>
<a name="ln987">    size-&gt;cvt_ready      = -1;</a>
<a name="ln988">  }</a>
<a name="ln989"> </a>
<a name="ln990"> </a>
<a name="ln991">  /* Initialize bytecode-related fields in the size object.       */</a>
<a name="ln992">  /* We do this only if bytecode interpretation is really needed. */</a>
<a name="ln993">  static FT_Error</a>
<a name="ln994">  tt_size_init_bytecode( FT_Size  ftsize,</a>
<a name="ln995">                         FT_Bool  pedantic )</a>
<a name="ln996">  {</a>
<a name="ln997">    FT_Error   error;</a>
<a name="ln998">    TT_Size    size = (TT_Size)ftsize;</a>
<a name="ln999">    TT_Face    face = (TT_Face)ftsize-&gt;face;</a>
<a name="ln1000">    FT_Memory  memory = face-&gt;root.memory;</a>
<a name="ln1001"> </a>
<a name="ln1002">    FT_UShort       n_twilight;</a>
<a name="ln1003">    TT_MaxProfile*  maxp = &amp;face-&gt;max_profile;</a>
<a name="ln1004"> </a>
<a name="ln1005"> </a>
<a name="ln1006">    /* clean up bytecode related data */</a>
<a name="ln1007">    FT_FREE( size-&gt;function_defs );</a>
<a name="ln1008">    FT_FREE( size-&gt;instruction_defs );</a>
<a name="ln1009">    FT_FREE( size-&gt;cvt );</a>
<a name="ln1010">    FT_FREE( size-&gt;storage );</a>
<a name="ln1011"> </a>
<a name="ln1012">    if ( size-&gt;context )</a>
<a name="ln1013">      TT_Done_Context( size-&gt;context );</a>
<a name="ln1014">    tt_glyphzone_done( &amp;size-&gt;twilight );</a>
<a name="ln1015"> </a>
<a name="ln1016">    size-&gt;bytecode_ready = -1;</a>
<a name="ln1017">    size-&gt;cvt_ready      = -1;</a>
<a name="ln1018"> </a>
<a name="ln1019">    size-&gt;context = TT_New_Context( (TT_Driver)face-&gt;root.driver );</a>
<a name="ln1020"> </a>
<a name="ln1021">    size-&gt;max_function_defs    = maxp-&gt;maxFunctionDefs;</a>
<a name="ln1022">    size-&gt;max_instruction_defs = maxp-&gt;maxInstructionDefs;</a>
<a name="ln1023"> </a>
<a name="ln1024">    size-&gt;num_function_defs    = 0;</a>
<a name="ln1025">    size-&gt;num_instruction_defs = 0;</a>
<a name="ln1026"> </a>
<a name="ln1027">    size-&gt;max_func = 0;</a>
<a name="ln1028">    size-&gt;max_ins  = 0;</a>
<a name="ln1029"> </a>
<a name="ln1030">    size-&gt;cvt_size     = face-&gt;cvt_size;</a>
<a name="ln1031">    size-&gt;storage_size = maxp-&gt;maxStorage;</a>
<a name="ln1032"> </a>
<a name="ln1033">    /* Set default metrics */</a>
<a name="ln1034">    {</a>
<a name="ln1035">      TT_Size_Metrics*  metrics = &amp;size-&gt;ttmetrics;</a>
<a name="ln1036"> </a>
<a name="ln1037"> </a>
<a name="ln1038">      metrics-&gt;rotated   = FALSE;</a>
<a name="ln1039">      metrics-&gt;stretched = FALSE;</a>
<a name="ln1040"> </a>
<a name="ln1041">      /* set default engine compensation */</a>
<a name="ln1042">      metrics-&gt;compensations[0] = 0;   /* gray     */</a>
<a name="ln1043">      metrics-&gt;compensations[1] = 0;   /* black    */</a>
<a name="ln1044">      metrics-&gt;compensations[2] = 0;   /* white    */</a>
<a name="ln1045">      metrics-&gt;compensations[3] = 0;   /* reserved */</a>
<a name="ln1046">    }</a>
<a name="ln1047"> </a>
<a name="ln1048">    /* allocate function defs, instruction defs, cvt, and storage area */</a>
<a name="ln1049">    if ( FT_NEW_ARRAY( size-&gt;function_defs,    size-&gt;max_function_defs    ) ||</a>
<a name="ln1050">         FT_NEW_ARRAY( size-&gt;instruction_defs, size-&gt;max_instruction_defs ) ||</a>
<a name="ln1051">         FT_NEW_ARRAY( size-&gt;cvt,              size-&gt;cvt_size             ) ||</a>
<a name="ln1052">         FT_NEW_ARRAY( size-&gt;storage,          size-&gt;storage_size         ) )</a>
<a name="ln1053">      goto Exit;</a>
<a name="ln1054"> </a>
<a name="ln1055">    /* reserve twilight zone */</a>
<a name="ln1056">    n_twilight = maxp-&gt;maxTwilightPoints;</a>
<a name="ln1057"> </a>
<a name="ln1058">    /* there are 4 phantom points (do we need this?) */</a>
<a name="ln1059">    n_twilight += 4;</a>
<a name="ln1060"> </a>
<a name="ln1061">    error = tt_glyphzone_new( memory, n_twilight, 0, &amp;size-&gt;twilight );</a>
<a name="ln1062">    if ( error )</a>
<a name="ln1063">      goto Exit;</a>
<a name="ln1064"> </a>
<a name="ln1065">    size-&gt;twilight.n_points = n_twilight;</a>
<a name="ln1066"> </a>
<a name="ln1067">    size-&gt;GS = tt_default_graphics_state;</a>
<a name="ln1068"> </a>
<a name="ln1069">    /* set `face-&gt;interpreter' according to the debug hook present */</a>
<a name="ln1070">    {</a>
<a name="ln1071">      FT_Library  library = face-&gt;root.driver-&gt;root.library;</a>
<a name="ln1072"> </a>
<a name="ln1073"> </a>
<a name="ln1074">      face-&gt;interpreter = (TT_Interpreter)</a>
<a name="ln1075">                            library-&gt;debug_hooks[FT_DEBUG_HOOK_TRUETYPE];</a>
<a name="ln1076">      if ( !face-&gt;interpreter )</a>
<a name="ln1077">        face-&gt;interpreter = (TT_Interpreter)TT_RunIns;</a>
<a name="ln1078">    }</a>
<a name="ln1079"> </a>
<a name="ln1080">    /* Fine, now run the font program! */</a>
<a name="ln1081">    error = tt_size_run_fpgm( size, pedantic );</a>
<a name="ln1082"> </a>
<a name="ln1083">  Exit:</a>
<a name="ln1084">    if ( error )</a>
<a name="ln1085">      tt_size_done_bytecode( ftsize );</a>
<a name="ln1086"> </a>
<a name="ln1087">    return error;</a>
<a name="ln1088">  }</a>
<a name="ln1089"> </a>
<a name="ln1090"> </a>
<a name="ln1091">  FT_LOCAL_DEF( FT_Error )</a>
<a name="ln1092">  tt_size_ready_bytecode( TT_Size  size,</a>
<a name="ln1093">                          FT_Bool  pedantic )</a>
<a name="ln1094">  {</a>
<a name="ln1095">    FT_Error  error = FT_Err_Ok;</a>
<a name="ln1096"> </a>
<a name="ln1097"> </a>
<a name="ln1098">    if ( size-&gt;bytecode_ready &lt; 0 )</a>
<a name="ln1099">      error = tt_size_init_bytecode( (FT_Size)size, pedantic );</a>
<a name="ln1100"> </a>
<a name="ln1101">    if ( error || size-&gt;bytecode_ready )</a>
<a name="ln1102">      goto Exit;</a>
<a name="ln1103"> </a>
<a name="ln1104">    /* rescale CVT when needed */</a>
<a name="ln1105">    if ( size-&gt;cvt_ready &lt; 0 )</a>
<a name="ln1106">    {</a>
<a name="ln1107">      FT_UInt  i;</a>
<a name="ln1108">      TT_Face  face = (TT_Face)size-&gt;root.face;</a>
<a name="ln1109"> </a>
<a name="ln1110"> </a>
<a name="ln1111">      /* Scale the cvt values to the new ppem.          */</a>
<a name="ln1112">      /* We use by default the y ppem to scale the CVT. */</a>
<a name="ln1113">      for ( i = 0; i &lt; size-&gt;cvt_size; i++ )</a>
<a name="ln1114">        size-&gt;cvt[i] = FT_MulFix( face-&gt;cvt[i], size-&gt;ttmetrics.scale );</a>
<a name="ln1115"> </a>
<a name="ln1116">      /* all twilight points are originally zero */</a>
<a name="ln1117">      for ( i = 0; i &lt; (FT_UInt)size-&gt;twilight.n_points; i++ )</a>
<a name="ln1118">      {</a>
<a name="ln1119">        size-&gt;twilight.org[i].x = 0;</a>
<a name="ln1120">        size-&gt;twilight.org[i].y = 0;</a>
<a name="ln1121">        size-&gt;twilight.cur[i].x = 0;</a>
<a name="ln1122">        size-&gt;twilight.cur[i].y = 0;</a>
<a name="ln1123">      }</a>
<a name="ln1124"> </a>
<a name="ln1125">      /* clear storage area */</a>
<a name="ln1126">      for ( i = 0; i &lt; (FT_UInt)size-&gt;storage_size; i++ )</a>
<a name="ln1127">        size-&gt;storage[i] = 0;</a>
<a name="ln1128"> </a>
<a name="ln1129">      size-&gt;GS = tt_default_graphics_state;</a>
<a name="ln1130"> </a>
<a name="ln1131">      error = tt_size_run_prep( size, pedantic );</a>
<a name="ln1132">    }</a>
<a name="ln1133"> </a>
<a name="ln1134">  Exit:</a>
<a name="ln1135">    return error;</a>
<a name="ln1136">  }</a>
<a name="ln1137"> </a>
<a name="ln1138">#endif /* TT_USE_BYTECODE_INTERPRETER */</a>
<a name="ln1139"> </a>
<a name="ln1140"> </a>
<a name="ln1141">  /*************************************************************************/</a>
<a name="ln1142">  /*                                                                       */</a>
<a name="ln1143">  /* &lt;Function&gt;                                                            */</a>
<a name="ln1144">  /*    tt_size_init                                                       */</a>
<a name="ln1145">  /*                                                                       */</a>
<a name="ln1146">  /* &lt;Description&gt;                                                         */</a>
<a name="ln1147">  /*    Initialize a new TrueType size object.                             */</a>
<a name="ln1148">  /*                                                                       */</a>
<a name="ln1149">  /* &lt;InOut&gt;                                                               */</a>
<a name="ln1150">  /*    size :: A handle to the size object.                               */</a>
<a name="ln1151">  /*                                                                       */</a>
<a name="ln1152">  /* &lt;Return&gt;                                                              */</a>
<a name="ln1153">  /*    FreeType error code.  0 means success.                             */</a>
<a name="ln1154">  /*                                                                       */</a>
<a name="ln1155">  FT_LOCAL_DEF( FT_Error )</a>
<a name="ln1156">  tt_size_init( FT_Size  ttsize )           /* TT_Size */</a>
<a name="ln1157">  {</a>
<a name="ln1158">    TT_Size   size  = (TT_Size)ttsize;</a>
<a name="ln1159">    FT_Error  error = FT_Err_Ok;</a>
<a name="ln1160"> </a>
<a name="ln1161"> </a>
<a name="ln1162">#ifdef TT_USE_BYTECODE_INTERPRETER</a>
<a name="ln1163">    size-&gt;bytecode_ready = -1;</a>
<a name="ln1164">    size-&gt;cvt_ready      = -1;</a>
<a name="ln1165">#endif</a>
<a name="ln1166"> </a>
<a name="ln1167">    size-&gt;ttmetrics.valid = FALSE;</a>
<a name="ln1168">    size-&gt;strike_index    = 0xFFFFFFFFUL;</a>
<a name="ln1169"> </a>
<a name="ln1170">    return error;</a>
<a name="ln1171">  }</a>
<a name="ln1172"> </a>
<a name="ln1173"> </a>
<a name="ln1174">  /*************************************************************************/</a>
<a name="ln1175">  /*                                                                       */</a>
<a name="ln1176">  /* &lt;Function&gt;                                                            */</a>
<a name="ln1177">  /*    tt_size_done                                                       */</a>
<a name="ln1178">  /*                                                                       */</a>
<a name="ln1179">  /* &lt;Description&gt;                                                         */</a>
<a name="ln1180">  /*    The TrueType size object finalizer.                                */</a>
<a name="ln1181">  /*                                                                       */</a>
<a name="ln1182">  /* &lt;Input&gt;                                                               */</a>
<a name="ln1183">  /*    size :: A handle to the target size object.                        */</a>
<a name="ln1184">  /*                                                                       */</a>
<a name="ln1185">  FT_LOCAL_DEF( void )</a>
<a name="ln1186">  tt_size_done( FT_Size  ttsize )           /* TT_Size */</a>
<a name="ln1187">  {</a>
<a name="ln1188">    TT_Size  size = (TT_Size)ttsize;</a>
<a name="ln1189"> </a>
<a name="ln1190"> </a>
<a name="ln1191">#ifdef TT_USE_BYTECODE_INTERPRETER</a>
<a name="ln1192">    tt_size_done_bytecode( ttsize );</a>
<a name="ln1193">#endif</a>
<a name="ln1194"> </a>
<a name="ln1195">    size-&gt;ttmetrics.valid = FALSE;</a>
<a name="ln1196">  }</a>
<a name="ln1197"> </a>
<a name="ln1198"> </a>
<a name="ln1199">  /*************************************************************************/</a>
<a name="ln1200">  /*                                                                       */</a>
<a name="ln1201">  /* &lt;Function&gt;                                                            */</a>
<a name="ln1202">  /*    tt_size_reset                                                      */</a>
<a name="ln1203">  /*                                                                       */</a>
<a name="ln1204">  /* &lt;Description&gt;                                                         */</a>
<a name="ln1205">  /*    Reset a TrueType size when resolutions and character dimensions    */</a>
<a name="ln1206">  /*    have been changed.                                                 */</a>
<a name="ln1207">  /*                                                                       */</a>
<a name="ln1208">  /* &lt;Input&gt;                                                               */</a>
<a name="ln1209">  /*    size :: A handle to the target size object.                        */</a>
<a name="ln1210">  /*                                                                       */</a>
<a name="ln1211">  FT_LOCAL_DEF( FT_Error )</a>
<a name="ln1212">  tt_size_reset( TT_Size  size )</a>
<a name="ln1213">  {</a>
<a name="ln1214">    TT_Face           face;</a>
<a name="ln1215">    FT_Error          error = FT_Err_Ok;</a>
<a name="ln1216">    FT_Size_Metrics*  metrics;</a>
<a name="ln1217"> </a>
<a name="ln1218"> </a>
<a name="ln1219">    size-&gt;ttmetrics.valid = FALSE;</a>
<a name="ln1220"> </a>
<a name="ln1221">    face = (TT_Face)size-&gt;root.face;</a>
<a name="ln1222"> </a>
<a name="ln1223">    metrics = &amp;size-&gt;metrics;</a>
<a name="ln1224"> </a>
<a name="ln1225">    /* copy the result from base layer */</a>
<a name="ln1226">    *metrics = size-&gt;root.metrics;</a>
<a name="ln1227"> </a>
<a name="ln1228">    if ( metrics-&gt;x_ppem &lt; 1 || metrics-&gt;y_ppem &lt; 1 )</a>
<a name="ln1229">      return FT_THROW( Invalid_PPem );</a>
<a name="ln1230"> </a>
<a name="ln1231">    /* This bit flag, if set, indicates that the ppems must be       */</a>
<a name="ln1232">    /* rounded to integers.  Nearly all TrueType fonts have this bit */</a>
<a name="ln1233">    /* set, as hinting won't work really well otherwise.             */</a>
<a name="ln1234">    /*                                                               */</a>
<a name="ln1235">    if ( face-&gt;header.Flags &amp; 8 )</a>
<a name="ln1236">    {</a>
<a name="ln1237">      metrics-&gt;x_scale = FT_DivFix( metrics-&gt;x_ppem &lt;&lt; 6,</a>
<a name="ln1238">                                    face-&gt;root.units_per_EM );</a>
<a name="ln1239">      metrics-&gt;y_scale = FT_DivFix( metrics-&gt;y_ppem &lt;&lt; 6,</a>
<a name="ln1240">                                    face-&gt;root.units_per_EM );</a>
<a name="ln1241"> </a>
<a name="ln1242">      metrics-&gt;ascender =</a>
<a name="ln1243">        FT_PIX_ROUND( FT_MulFix( face-&gt;root.ascender, metrics-&gt;y_scale ) );</a>
<a name="ln1244">      metrics-&gt;descender =</a>
<a name="ln1245">        FT_PIX_ROUND( FT_MulFix( face-&gt;root.descender, metrics-&gt;y_scale ) );</a>
<a name="ln1246">      metrics-&gt;height =</a>
<a name="ln1247">        FT_PIX_ROUND( FT_MulFix( face-&gt;root.height, metrics-&gt;y_scale ) );</a>
<a name="ln1248">      metrics-&gt;max_advance =</a>
<a name="ln1249">        FT_PIX_ROUND( FT_MulFix( face-&gt;root.max_advance_width,</a>
<a name="ln1250">                                 metrics-&gt;x_scale ) );</a>
<a name="ln1251">    }</a>
<a name="ln1252"> </a>
<a name="ln1253">    /* compute new transformation */</a>
<a name="ln1254">    if ( metrics-&gt;x_ppem &gt;= metrics-&gt;y_ppem )</a>
<a name="ln1255">    {</a>
<a name="ln1256">      size-&gt;ttmetrics.scale   = metrics-&gt;x_scale;</a>
<a name="ln1257">      size-&gt;ttmetrics.ppem    = metrics-&gt;x_ppem;</a>
<a name="ln1258">      size-&gt;ttmetrics.x_ratio = 0x10000L;</a>
<a name="ln1259">      size-&gt;ttmetrics.y_ratio = FT_DivFix( metrics-&gt;y_ppem,</a>
<a name="ln1260">                                           metrics-&gt;x_ppem );</a>
<a name="ln1261">    }</a>
<a name="ln1262">    else</a>
<a name="ln1263">    {</a>
<a name="ln1264">      size-&gt;ttmetrics.scale   = metrics-&gt;y_scale;</a>
<a name="ln1265">      size-&gt;ttmetrics.ppem    = metrics-&gt;y_ppem;</a>
<a name="ln1266">      size-&gt;ttmetrics.x_ratio = FT_DivFix( metrics-&gt;x_ppem,</a>
<a name="ln1267">                                           metrics-&gt;y_ppem );</a>
<a name="ln1268">      size-&gt;ttmetrics.y_ratio = 0x10000L;</a>
<a name="ln1269">    }</a>
<a name="ln1270"> </a>
<a name="ln1271">#ifdef TT_USE_BYTECODE_INTERPRETER</a>
<a name="ln1272">    size-&gt;cvt_ready = -1;</a>
<a name="ln1273">#endif /* TT_USE_BYTECODE_INTERPRETER */</a>
<a name="ln1274"> </a>
<a name="ln1275">    if ( !error )</a>
<a name="ln1276">      size-&gt;ttmetrics.valid = TRUE;</a>
<a name="ln1277"> </a>
<a name="ln1278">    return error;</a>
<a name="ln1279">  }</a>
<a name="ln1280"> </a>
<a name="ln1281"> </a>
<a name="ln1282">  /*************************************************************************/</a>
<a name="ln1283">  /*                                                                       */</a>
<a name="ln1284">  /* &lt;Function&gt;                                                            */</a>
<a name="ln1285">  /*    tt_driver_init                                                     */</a>
<a name="ln1286">  /*                                                                       */</a>
<a name="ln1287">  /* &lt;Description&gt;                                                         */</a>
<a name="ln1288">  /*    Initialize a given TrueType driver object.                         */</a>
<a name="ln1289">  /*                                                                       */</a>
<a name="ln1290">  /* &lt;Input&gt;                                                               */</a>
<a name="ln1291">  /*    driver :: A handle to the target driver object.                    */</a>
<a name="ln1292">  /*                                                                       */</a>
<a name="ln1293">  /* &lt;Return&gt;                                                              */</a>
<a name="ln1294">  /*    FreeType error code.  0 means success.                             */</a>
<a name="ln1295">  /*                                                                       */</a>
<a name="ln1296">  FT_LOCAL_DEF( FT_Error )</a>
<a name="ln1297">  tt_driver_init( FT_Module  ttdriver )     /* TT_Driver */</a>
<a name="ln1298">  {</a>
<a name="ln1299"> </a>
<a name="ln1300">#ifdef TT_USE_BYTECODE_INTERPRETER</a>
<a name="ln1301"> </a>
<a name="ln1302">    TT_Driver  driver = (TT_Driver)ttdriver;</a>
<a name="ln1303"> </a>
<a name="ln1304">#ifdef TT_CONFIG_OPTION_SUBPIXEL_HINTING</a>
<a name="ln1305">    driver-&gt;interpreter_version = TT_INTERPRETER_VERSION_38;</a>
<a name="ln1306">#else</a>
<a name="ln1307">    driver-&gt;interpreter_version = TT_INTERPRETER_VERSION_35;</a>
<a name="ln1308">#endif</a>
<a name="ln1309"> </a>
<a name="ln1310">#else /* !TT_USE_BYTECODE_INTERPRETER */</a>
<a name="ln1311"> </a>
<a name="ln1312">    FT_UNUSED( ttdriver );</a>
<a name="ln1313"> </a>
<a name="ln1314">#endif /* !TT_USE_BYTECODE_INTERPRETER */</a>
<a name="ln1315"> </a>
<a name="ln1316">    return FT_Err_Ok;</a>
<a name="ln1317">  }</a>
<a name="ln1318"> </a>
<a name="ln1319"> </a>
<a name="ln1320">  /*************************************************************************/</a>
<a name="ln1321">  /*                                                                       */</a>
<a name="ln1322">  /* &lt;Function&gt;                                                            */</a>
<a name="ln1323">  /*    tt_driver_done                                                     */</a>
<a name="ln1324">  /*                                                                       */</a>
<a name="ln1325">  /* &lt;Description&gt;                                                         */</a>
<a name="ln1326">  /*    Finalize a given TrueType driver.                                  */</a>
<a name="ln1327">  /*                                                                       */</a>
<a name="ln1328">  /* &lt;Input&gt;                                                               */</a>
<a name="ln1329">  /*    driver :: A handle to the target TrueType driver.                  */</a>
<a name="ln1330">  /*                                                                       */</a>
<a name="ln1331">  FT_LOCAL_DEF( void )</a>
<a name="ln1332">  tt_driver_done( FT_Module  ttdriver )     /* TT_Driver */</a>
<a name="ln1333">  {</a>
<a name="ln1334">    FT_UNUSED( ttdriver );</a>
<a name="ln1335">  }</a>
<a name="ln1336"> </a>
<a name="ln1337"> </a>
<a name="ln1338">  /*************************************************************************/</a>
<a name="ln1339">  /*                                                                       */</a>
<a name="ln1340">  /* &lt;Function&gt;                                                            */</a>
<a name="ln1341">  /*    tt_slot_init                                                       */</a>
<a name="ln1342">  /*                                                                       */</a>
<a name="ln1343">  /* &lt;Description&gt;                                                         */</a>
<a name="ln1344">  /*    Initialize a new slot object.                                      */</a>
<a name="ln1345">  /*                                                                       */</a>
<a name="ln1346">  /* &lt;InOut&gt;                                                               */</a>
<a name="ln1347">  /*    slot :: A handle to the slot object.                               */</a>
<a name="ln1348">  /*                                                                       */</a>
<a name="ln1349">  /* &lt;Return&gt;                                                              */</a>
<a name="ln1350">  /*    FreeType error code.  0 means success.                             */</a>
<a name="ln1351">  /*                                                                       */</a>
<a name="ln1352">  FT_LOCAL_DEF( FT_Error )</a>
<a name="ln1353">  tt_slot_init( FT_GlyphSlot  slot )</a>
<a name="ln1354">  {</a>
<a name="ln1355">    return FT_GlyphLoader_CreateExtra( slot-&gt;internal-&gt;loader );</a>
<a name="ln1356">  }</a>
<a name="ln1357"> </a>
<a name="ln1358"> </a>
<a name="ln1359">/* END */</a>

</code></pre>
<div class="balloon" rel="854"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1048/" target="_blank">V1048</a> The 'error' variable was assigned the same value.</p></div>
<div class="balloon" rel="919"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1048/" target="_blank">V1048</a> The 'error' variable was assigned the same value.</p></div>
<div class="balloon" rel="1275"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression '!error' is always true.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
