
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>jackaudio.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MusE Score</a>
<a name="ln3">//  Linux Music Score Editor</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2010 Werner Schweer and others</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2.</a>
<a name="ln9">//</a>
<a name="ln10">//  This program is distributed in the hope that it will be useful,</a>
<a name="ln11">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">//  GNU General Public License for more details.</a>
<a name="ln14">//</a>
<a name="ln15">//  You should have received a copy of the GNU General Public License</a>
<a name="ln16">//  along with this program; if not, write to the Free Software</a>
<a name="ln17">//  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</a>
<a name="ln18">//=============================================================================</a>
<a name="ln19"> </a>
<a name="ln20">#if (defined (_MSCVER) || defined (_MSC_VER))</a>
<a name="ln21">// Include stdint.h and #define _STDINT_H to prevent &lt;systemdeps.h&gt; from redefining types</a>
<a name="ln22">// #undef UNICODE to force LoadLibrary to use the char-based implementation instead of the wchar_t one.</a>
<a name="ln23">#include &lt;stdint.h&gt;</a>
<a name="ln24">#define _STDINT_H 1</a>
<a name="ln25">#endif</a>
<a name="ln26"> </a>
<a name="ln27">#include &quot;jackaudio.h&quot;</a>
<a name="ln28">#include &quot;musescore.h&quot;</a>
<a name="ln29">#include &quot;libmscore/mscore.h&quot;</a>
<a name="ln30">#include &quot;libmscore/sig.h&quot;</a>
<a name="ln31">#include &quot;preferences.h&quot;</a>
<a name="ln32">// #include &quot;msynth/synti.h&quot;</a>
<a name="ln33">#include &quot;seq.h&quot;</a>
<a name="ln34">#include &quot;libmscore/score.h&quot;</a>
<a name="ln35">#include &quot;libmscore/repeatlist.h&quot;</a>
<a name="ln36">#include &quot;playpanel.h&quot;</a>
<a name="ln37">#include &lt;jack/midiport.h&gt;</a>
<a name="ln38"> </a>
<a name="ln39">// Prevent killing sequencer with wrong data</a>
<a name="ln40">#define less128(__less) ((__less &gt;=0 &amp;&amp; __less &lt;= 127) ? __less : 0)</a>
<a name="ln41"> </a>
<a name="ln42">namespace Ms {</a>
<a name="ln43"> </a>
<a name="ln44">//---------------------------------------------------------</a>
<a name="ln45">//   JackAudio</a>
<a name="ln46">//---------------------------------------------------------</a>
<a name="ln47"> </a>
<a name="ln48">JackAudio::JackAudio(Seq* s)</a>
<a name="ln49">   : Driver(s)</a>
<a name="ln50">      {</a>
<a name="ln51">      client = 0;</a>
<a name="ln52">      }</a>
<a name="ln53"> </a>
<a name="ln54">//---------------------------------------------------------</a>
<a name="ln55">//   ~JackAudio</a>
<a name="ln56">//---------------------------------------------------------</a>
<a name="ln57"> </a>
<a name="ln58">JackAudio::~JackAudio()</a>
<a name="ln59">      {</a>
<a name="ln60">      if (client) {</a>
<a name="ln61">            stop();</a>
<a name="ln62">            if (jack_client_close(client)) {</a>
<a name="ln63">                  qDebug(&quot;jack_client_close() failed: %s&quot;,</a>
<a name="ln64">                     strerror(errno));</a>
<a name="ln65">                  }</a>
<a name="ln66">            }</a>
<a name="ln67">      }</a>
<a name="ln68"> </a>
<a name="ln69">//---------------------------------------------------------</a>
<a name="ln70">//   updateOutPortCount</a>
<a name="ln71">//   Add/remove JACK MIDI Out ports</a>
<a name="ln72">//---------------------------------------------------------</a>
<a name="ln73"> </a>
<a name="ln74">void JackAudio::updateOutPortCount(int maxport)</a>
<a name="ln75">      {</a>
<a name="ln76">      if (!preferences.getBool(PREF_IO_JACK_USEJACKMIDI) || maxport == midiOutputPorts.size())</a>
<a name="ln77">            return;</a>
<a name="ln78">      if (MScore::debugMode)</a>
<a name="ln79">            qDebug()&lt;&lt;&quot;JACK number of ports:&quot;&lt;&lt;midiOutputPorts.size()&lt;&lt;&quot;, change to:&quot;&lt;&lt;maxport;</a>
<a name="ln80"> </a>
<a name="ln81">      bool oldremember = preferences.getBool(PREF_IO_JACK_REMEMBERLASTCONNECTIONS);</a>
<a name="ln82">      preferences.setPreference(PREF_IO_JACK_REMEMBERLASTCONNECTIONS, true);</a>
<a name="ln83"> </a>
<a name="ln84">      if (maxport &gt; midiOutputPorts.size()) {</a>
<a name="ln85">            for (int i = midiOutputPorts.size(); i &lt; maxport; ++i)</a>
<a name="ln86">                  registerPort(QString(&quot;mscore-midi-%1&quot;).arg(i+1), false, true);</a>
<a name="ln87">            restoreMidiConnections();</a>
<a name="ln88">            }</a>
<a name="ln89">      else if (maxport &lt; midiOutputPorts.size()) {</a>
<a name="ln90">            rememberMidiConnections();</a>
<a name="ln91">            for(int i = midiOutputPorts.size() - 1; i &gt;= maxport; --i) {</a>
<a name="ln92">                  unregisterPort(midiOutputPorts[i]);</a>
<a name="ln93">                  midiOutputPorts.removeAt(i);</a>
<a name="ln94">                  }</a>
<a name="ln95">            }</a>
<a name="ln96">      preferences.setPreference(PREF_IO_JACK_REMEMBERLASTCONNECTIONS, oldremember);</a>
<a name="ln97"> </a>
<a name="ln98">      }</a>
<a name="ln99"> </a>
<a name="ln100">//---------------------------------------------------------</a>
<a name="ln101">//   registerPort</a>
<a name="ln102">//---------------------------------------------------------</a>
<a name="ln103"> </a>
<a name="ln104">void JackAudio::registerPort(const QString&amp; name, bool input, bool midi)</a>
<a name="ln105">      {</a>
<a name="ln106">      int portFlag         = input ? JackPortIsInput : JackPortIsOutput;</a>
<a name="ln107">      const char* portType = midi ? JACK_DEFAULT_MIDI_TYPE : JACK_DEFAULT_AUDIO_TYPE;</a>
<a name="ln108"> </a>
<a name="ln109">      jack_port_t* port = jack_port_register(client, qPrintable(name), portType, portFlag, 0);</a>
<a name="ln110">      if (port == 0) {</a>
<a name="ln111">            qDebug(&quot;JackAudio:registerPort(%s) failed&quot;, qPrintable(name));</a>
<a name="ln112">            return;</a>
<a name="ln113">            }</a>
<a name="ln114">      if (midi) {</a>
<a name="ln115">            if (input)</a>
<a name="ln116">                  midiInputPorts.append(port);</a>
<a name="ln117">            else</a>
<a name="ln118">                  midiOutputPorts.append(port);</a>
<a name="ln119">            }</a>
<a name="ln120">      else</a>
<a name="ln121">            ports.append(port);</a>
<a name="ln122">      }</a>
<a name="ln123"> </a>
<a name="ln124">//---------------------------------------------------------</a>
<a name="ln125">//   unregisterPort</a>
<a name="ln126">//---------------------------------------------------------</a>
<a name="ln127"> </a>
<a name="ln128">void JackAudio::unregisterPort(jack_port_t* port)</a>
<a name="ln129">      {</a>
<a name="ln130">      if (jack_port_is_mine(client,port)) {</a>
<a name="ln131">            jack_port_unregister(client, port);</a>
<a name="ln132">            port = 0;</a>
<a name="ln133">            }</a>
<a name="ln134">      else</a>
<a name="ln135">            qDebug(&quot;Trying to unregister port that is not my!&quot;);</a>
<a name="ln136">      }</a>
<a name="ln137"> </a>
<a name="ln138">//---------------------------------------------------------</a>
<a name="ln139">//   inputPorts</a>
<a name="ln140">//---------------------------------------------------------</a>
<a name="ln141"> </a>
<a name="ln142">QList&lt;QString&gt; JackAudio::inputPorts()</a>
<a name="ln143">      {</a>
<a name="ln144">      const char** prts = jack_get_ports(client, 0, 0, 0);</a>
<a name="ln145">      QList&lt;QString&gt; clientList;</a>
<a name="ln146">      for (const char** p = prts; p &amp;&amp; *p; ++p) {</a>
<a name="ln147">            jack_port_t* port = jack_port_by_name(client, *p);</a>
<a name="ln148">            int flags = jack_port_flags(port);</a>
<a name="ln149">            if (!(flags &amp; JackPortIsInput))</a>
<a name="ln150">                  continue;</a>
<a name="ln151">            char buffer[128];</a>
<a name="ln152">            strncpy(buffer, *p, sizeof(buffer) - 1);</a>
<a name="ln153">            buffer[sizeof(buffer) - 1] = 0;</a>
<a name="ln154">            if (strncmp(buffer, &quot;Mscore&quot;, 6) == 0)</a>
<a name="ln155">                  continue;</a>
<a name="ln156">            clientList.append(QString(buffer));</a>
<a name="ln157">            }</a>
<a name="ln158">      return clientList;</a>
<a name="ln159">      }</a>
<a name="ln160"> </a>
<a name="ln161">//---------------------------------------------------------</a>
<a name="ln162">//   connect</a>
<a name="ln163">//---------------------------------------------------------</a>
<a name="ln164"> </a>
<a name="ln165">void JackAudio::connect(void* src, void* dst)</a>
<a name="ln166">      {</a>
<a name="ln167">      const char* sn = jack_port_name((jack_port_t*) src);</a>
<a name="ln168">      const char* dn = jack_port_name((jack_port_t*) dst);</a>
<a name="ln169"> </a>
<a name="ln170">      if (sn == 0 || dn == 0) {</a>
<a name="ln171">            qDebug(&quot;JackAudio::connect: unknown jack ports&quot;);</a>
<a name="ln172">            return;</a>
<a name="ln173">            }</a>
<a name="ln174">      if (jack_connect(client, sn, dn)) {</a>
<a name="ln175">            qDebug(&quot;jack connect &lt;%s&gt;%p - &lt;%s&gt;%p failed&quot;,</a>
<a name="ln176">               sn, src, dn, dst);</a>
<a name="ln177">            }</a>
<a name="ln178">      }</a>
<a name="ln179"> </a>
<a name="ln180">//---------------------------------------------------------</a>
<a name="ln181">//   connect</a>
<a name="ln182">//---------------------------------------------------------</a>
<a name="ln183"> </a>
<a name="ln184">void JackAudio::connect(const char* src, const char* dst)</a>
<a name="ln185">      {</a>
<a name="ln186">      if (src == 0 || dst == 0) {</a>
<a name="ln187">            qDebug(&quot;JackAudio::connect: unknown jack ports&quot;);</a>
<a name="ln188">            return;</a>
<a name="ln189">            }</a>
<a name="ln190">      qDebug(&quot;JackAudio::connect &lt;%s&gt; &lt;%s&gt;&quot;, src, dst);</a>
<a name="ln191">      int rv = jack_connect(client, src, dst);</a>
<a name="ln192">      if (rv)</a>
<a name="ln193">            qDebug(&quot;jack connect port &lt;%s&gt; - &lt;%s&gt; failed: %d&quot;, src, dst, rv);</a>
<a name="ln194">      }</a>
<a name="ln195"> </a>
<a name="ln196">//---------------------------------------------------------</a>
<a name="ln197">//   disconnect</a>
<a name="ln198">//---------------------------------------------------------</a>
<a name="ln199"> </a>
<a name="ln200">void JackAudio::disconnect(void* src, void* dst)</a>
<a name="ln201">      {</a>
<a name="ln202">      const char* sn = jack_port_name((jack_port_t*) src);</a>
<a name="ln203">      const char* dn = jack_port_name((jack_port_t*) dst);</a>
<a name="ln204">      if (sn == 0 || dn == 0) {</a>
<a name="ln205">            qDebug(&quot;JackAudio::disconnect: unknown jack ports&quot;);</a>
<a name="ln206">            return;</a>
<a name="ln207">            }</a>
<a name="ln208">      if (jack_disconnect(client, sn, dn)) {</a>
<a name="ln209">            qDebug(&quot;jack disconnect &lt;%s&gt; - &lt;%s&gt; failed&quot;, sn, dn);</a>
<a name="ln210">            }</a>
<a name="ln211">      }</a>
<a name="ln212"> </a>
<a name="ln213">//---------------------------------------------------------</a>
<a name="ln214">//   start</a>
<a name="ln215">//    return false on error</a>
<a name="ln216">//---------------------------------------------------------</a>
<a name="ln217"> </a>
<a name="ln218">bool JackAudio::start(bool hotPlug)</a>
<a name="ln219">      {</a>
<a name="ln220">      bool oldremember = preferences.getBool(PREF_IO_JACK_REMEMBERLASTCONNECTIONS);</a>
<a name="ln221">      if (hotPlug)</a>
<a name="ln222">            preferences.setPreference(PREF_IO_JACK_REMEMBERLASTCONNECTIONS, true);</a>
<a name="ln223"> </a>
<a name="ln224">      if (jack_activate(client)) {</a>
<a name="ln225">            qDebug(&quot;JACK: cannot activate client&quot;);</a>
<a name="ln226">            return false;</a>
<a name="ln227">            }</a>
<a name="ln228">      /* connect the ports. Note: you can't do this before</a>
<a name="ln229">         the client is activated, because we can't allow</a>
<a name="ln230">         connections to be made to clients that aren't</a>
<a name="ln231">         running.</a>
<a name="ln232">       */</a>
<a name="ln233">      if (preferences.getBool(PREF_IO_JACK_USEJACKAUDIO))</a>
<a name="ln234">            restoreAudioConnections();</a>
<a name="ln235">      if (preferences.getBool(PREF_IO_JACK_USEJACKMIDI))</a>
<a name="ln236">            restoreMidiConnections();</a>
<a name="ln237"> </a>
<a name="ln238">      if (hotPlug)</a>
<a name="ln239">            preferences.setPreference(PREF_IO_JACK_REMEMBERLASTCONNECTIONS, oldremember);</a>
<a name="ln240">      return true;</a>
<a name="ln241">      }</a>
<a name="ln242"> </a>
<a name="ln243">//---------------------------------------------------------</a>
<a name="ln244">//   stop</a>
<a name="ln245">//    return false on error</a>
<a name="ln246">//---------------------------------------------------------</a>
<a name="ln247"> </a>
<a name="ln248">bool JackAudio::stop()</a>
<a name="ln249">      {</a>
<a name="ln250">      if (preferences.getBool(PREF_IO_JACK_USEJACKMIDI))</a>
<a name="ln251">            rememberMidiConnections();</a>
<a name="ln252">      if (preferences.getBool(PREF_IO_JACK_USEJACKAUDIO))</a>
<a name="ln253">            rememberAudioConnections();</a>
<a name="ln254"> </a>
<a name="ln255">      if (jack_deactivate(client)) {</a>
<a name="ln256">            qDebug(&quot;cannot deactivate client&quot;);</a>
<a name="ln257">            return false;</a>
<a name="ln258">            }</a>
<a name="ln259">      return true;</a>
<a name="ln260">      }</a>
<a name="ln261"> </a>
<a name="ln262">//---------------------------------------------------------</a>
<a name="ln263">//   framePos</a>
<a name="ln264">//---------------------------------------------------------</a>
<a name="ln265"> </a>
<a name="ln266">int JackAudio::framePos() const</a>
<a name="ln267">      {</a>
<a name="ln268">      jack_nframes_t n = jack_frame_time(client);</a>
<a name="ln269">      return (int)n;</a>
<a name="ln270">      }</a>
<a name="ln271"> </a>
<a name="ln272">//---------------------------------------------------------</a>
<a name="ln273">//   freewheel_callback</a>
<a name="ln274">//---------------------------------------------------------</a>
<a name="ln275"> </a>
<a name="ln276">static void freewheel_callback(int /*starting*/, void*)</a>
<a name="ln277">      {</a>
<a name="ln278">      }</a>
<a name="ln279"> </a>
<a name="ln280">//---------------------------------------------------------</a>
<a name="ln281">//   sampleRateCallback</a>
<a name="ln282">//---------------------------------------------------------</a>
<a name="ln283"> </a>
<a name="ln284">int sampleRateCallback(jack_nframes_t sampleRate, void*)</a>
<a name="ln285">      {</a>
<a name="ln286">      qDebug(&quot;JACK: sample rate changed: %d&quot;, sampleRate);</a>
<a name="ln287">      MScore::sampleRate = sampleRate;</a>
<a name="ln288">      return 0;</a>
<a name="ln289">      }</a>
<a name="ln290"> </a>
<a name="ln291">//---------------------------------------------------------</a>
<a name="ln292">//   bufferSizeCallback called if JACK buffer changed</a>
<a name="ln293">//---------------------------------------------------------</a>
<a name="ln294"> </a>
<a name="ln295">int bufferSizeCallback(jack_nframes_t nframes, void *arg)</a>
<a name="ln296">      {</a>
<a name="ln297">      JackAudio* audio = (JackAudio*)arg;</a>
<a name="ln298">      audio-&gt;setBufferSize(nframes);</a>
<a name="ln299">      return 0;</a>
<a name="ln300">      }</a>
<a name="ln301"> </a>
<a name="ln302">static void registration_callback(jack_port_id_t, int, void*)</a>
<a name="ln303">      {</a>
<a name="ln304">//      qDebug(&quot;JACK: registration changed&quot;);</a>
<a name="ln305">      }</a>
<a name="ln306"> </a>
<a name="ln307">static int graph_callback(void*)</a>
<a name="ln308">      {</a>
<a name="ln309">//      qDebug(&quot;JACK: graph changed&quot;);</a>
<a name="ln310">      return 0;</a>
<a name="ln311">      }</a>
<a name="ln312"> </a>
<a name="ln313">//---------------------------------------------------------</a>
<a name="ln314">//   timebase</a>
<a name="ln315">//---------------------------------------------------------</a>
<a name="ln316"> </a>
<a name="ln317">void JackAudio::timebase(jack_transport_state_t state, jack_nframes_t /*nframes*/, jack_position_t *pos, int /*new_pos*/, void *arg)</a>
<a name="ln318">      {</a>
<a name="ln319">      JackAudio* audio = (JackAudio*)arg;</a>
<a name="ln320">      if (!audio-&gt;seq-&gt;score()) {</a>
<a name="ln321">            if (state==JackTransportLooping || state==JackTransportRolling)</a>
<a name="ln322">                  audio-&gt;stopTransport();</a>
<a name="ln323">            }</a>
<a name="ln324">      else if (audio-&gt;seq-&gt;isRunning()) {</a>
<a name="ln325">            if (!audio-&gt;seq-&gt;score()-&gt;masterScore())</a>
<a name="ln326">                  return;</a>
<a name="ln327"> </a>
<a name="ln328">            pos-&gt;valid = JackPositionBBT;</a>
<a name="ln329">            int curTick = audio-&gt;seq-&gt;score()-&gt;repeatList().utick2tick(audio-&gt;seq-&gt;getCurTick());</a>
<a name="ln330">            int bar,beat,tick;</a>
<a name="ln331">            audio-&gt;seq-&gt;score()-&gt;sigmap()-&gt;tickValues(curTick, &amp;bar, &amp;beat, &amp;tick);</a>
<a name="ln332">            // Providing the final tempo</a>
<a name="ln333">            pos-&gt;beats_per_minute = 60 * audio-&gt;seq-&gt;curTempo() * audio-&gt;seq-&gt;score()-&gt;tempomap()-&gt;relTempo();</a>
<a name="ln334">            pos-&gt;ticks_per_beat   = MScore::division;</a>
<a name="ln335">            pos-&gt;tick             = tick;</a>
<a name="ln336">            pos-&gt;bar              = bar+1;</a>
<a name="ln337">            pos-&gt;beat             = beat+1;</a>
<a name="ln338"> </a>
<a name="ln339">            if (audio-&gt;timeSigTempoChanged) {</a>
<a name="ln340">                  Fraction timeSig = audio-&gt;seq-&gt;score()-&gt;sigmap()-&gt;timesig(curTick).nominal();</a>
<a name="ln341">                  pos-&gt;beats_per_bar =  timeSig.numerator();</a>
<a name="ln342">                  pos-&gt;beat_type = timeSig.denominator();</a>
<a name="ln343">                  audio-&gt;timeSigTempoChanged = false;</a>
<a name="ln344">                  qDebug()&lt;&lt;&quot;Time signature changed: &quot;&lt;&lt; pos-&gt;beats_per_minute&lt;&lt;&quot;, bar: &quot;&lt;&lt; pos-&gt;bar&lt;&lt;&quot;,beat: &quot;&lt;&lt;pos-&gt;beat&lt;&lt;&quot;, tick:&quot;&lt;&lt;pos-&gt;tick&lt;&lt;&quot;, time sig: &quot;&lt;&lt;pos-&gt;beats_per_bar&lt;&lt;&quot;/&quot;&lt;&lt;pos-&gt;beat_type;</a>
<a name="ln345">                  }</a>
<a name="ln346">            }</a>
<a name="ln347">      // TODO: Handle new_pos</a>
<a name="ln348">      }</a>
<a name="ln349">//---------------------------------------------------------</a>
<a name="ln350">//   processAudio</a>
<a name="ln351">//    JACK callback</a>
<a name="ln352">//---------------------------------------------------------</a>
<a name="ln353"> </a>
<a name="ln354">int JackAudio::processAudio(jack_nframes_t frames, void* p)</a>
<a name="ln355">      {</a>
<a name="ln356">      JackAudio* audio = (JackAudio*)p;</a>
<a name="ln357">      // Prevent from crash if score not opened yet</a>
<a name="ln358">      if(!audio-&gt;seq-&gt;score())</a>
<a name="ln359">            return 0;</a>
<a name="ln360"> </a>
<a name="ln361">      float* l;</a>
<a name="ln362">      float* r;</a>
<a name="ln363">      if (preferences.getBool(PREF_IO_JACK_USEJACKAUDIO) &amp;&amp; audio-&gt;ports.size() == 2) {</a>
<a name="ln364">            l = (float*)jack_port_get_buffer(audio-&gt;ports[0], frames);</a>
<a name="ln365">            r = (float*)jack_port_get_buffer(audio-&gt;ports[1], frames);</a>
<a name="ln366">            }</a>
<a name="ln367">      else {</a>
<a name="ln368">            l = 0;</a>
<a name="ln369">            r = 0;</a>
<a name="ln370">            }</a>
<a name="ln371">      if (preferences.getBool(PREF_IO_JACK_USEJACKMIDI)) {</a>
<a name="ln372">            foreach(jack_port_t* port, audio-&gt;midiOutputPorts) {</a>
<a name="ln373">                  void* portBuffer = jack_port_get_buffer(port, frames);</a>
<a name="ln374">                  jack_midi_clear_buffer(portBuffer);</a>
<a name="ln375">                  }</a>
<a name="ln376">            foreach(jack_port_t* port, audio-&gt;midiInputPorts) {</a>
<a name="ln377">                  void* portBuffer = jack_port_get_buffer(port, frames);</a>
<a name="ln378">                  if (portBuffer) {</a>
<a name="ln379">                        jack_nframes_t n = jack_midi_get_event_count(portBuffer);</a>
<a name="ln380">                        for (jack_nframes_t i = 0; i &lt; n; ++i) {</a>
<a name="ln381">                              jack_midi_event_t event;</a>
<a name="ln382">                              if (jack_midi_event_get(&amp;event, portBuffer, i) != 0)</a>
<a name="ln383">                                    continue;</a>
<a name="ln384">                              size_t nn = event.size;</a>
<a name="ln385">                              int type = event.buffer[0];</a>
<a name="ln386">                              if (nn &amp;&amp; (type == ME_CLOCK || type == ME_SENSE))</a>
<a name="ln387">                                    continue;</a>
<a name="ln388">                              Event e;</a>
<a name="ln389">                              e.setChannel(type &amp; 0xf);</a>
<a name="ln390">                              type &amp;= 0xf0;</a>
<a name="ln391">                              e.setType(type);</a>
<a name="ln392">                              if (type == ME_NOTEON || type == ME_NOTEOFF) {</a>
<a name="ln393">                                    e.setPitch(event.buffer[1]);</a>
<a name="ln394">                                    e.setVelo(event.buffer[2]);</a>
<a name="ln395">                                    audio-&gt;seq-&gt;eventToGui(e);</a>
<a name="ln396">                                    }</a>
<a name="ln397">                              else if (type == ME_CONTROLLER) {</a>
<a name="ln398">                                    e.setController(event.buffer[1]);</a>
<a name="ln399">                                    e.setValue(event.buffer[2]);</a>
<a name="ln400">                                    audio-&gt;seq-&gt;eventToGui(e);</a>
<a name="ln401">                                    }</a>
<a name="ln402">                              }</a>
<a name="ln403">                        }</a>
<a name="ln404">                  }</a>
<a name="ln405">            }</a>
<a name="ln406">      if (l &amp;&amp; r) {</a>
<a name="ln407">#if (!defined (_MSCVER) &amp;&amp; !defined (_MSC_VER))</a>
<a name="ln408">         float buffer[frames * 2];</a>
<a name="ln409">#else</a>
<a name="ln410">         // MSVC does not support VLA. Replace with std::vector. If profiling determines that the</a>
<a name="ln411">         //    heap allocation is slow, an optimization might be used.</a>
<a name="ln412">         std::vector&lt;float&gt; vBuffer(frames * 2);</a>
<a name="ln413">         float* buffer = vBuffer.data();</a>
<a name="ln414">#endif</a>
<a name="ln415">            audio-&gt;seq-&gt;process((unsigned)frames, buffer);</a>
<a name="ln416">            float* sp = buffer;</a>
<a name="ln417">            for (unsigned i = 0; i &lt; frames; ++i) {</a>
<a name="ln418">                  *l++ = *sp++;</a>
<a name="ln419">                  *r++ = *sp++;</a>
<a name="ln420">                  }</a>
<a name="ln421">            }</a>
<a name="ln422">      else {</a>
<a name="ln423">            // JACK MIDI only</a>
<a name="ln424">#if (!defined (_MSCVER) &amp;&amp; !defined (_MSC_VER))</a>
<a name="ln425">         float buffer[frames * 2];</a>
<a name="ln426">#else</a>
<a name="ln427">            // MSVC does not support VLA. Replace with std::vector. If profiling determines that the</a>
<a name="ln428">            //    heap allocation is slow, an optimization might be used.</a>
<a name="ln429">         std::vector&lt;float&gt; vBuffer(frames * 2);</a>
<a name="ln430">         float* buffer = vBuffer.data();</a>
<a name="ln431">#endif</a>
<a name="ln432">            audio-&gt;seq-&gt;process((unsigned)frames, buffer);</a>
<a name="ln433">            }</a>
<a name="ln434">      return 0;</a>
<a name="ln435">      }</a>
<a name="ln436"> </a>
<a name="ln437">//---------------------------------------------------------</a>
<a name="ln438">//   jackError</a>
<a name="ln439">//---------------------------------------------------------</a>
<a name="ln440"> </a>
<a name="ln441">static void jackError(const char *s)</a>
<a name="ln442">      {</a>
<a name="ln443">      qDebug(&quot;JACK ERROR: %s&quot;, s);</a>
<a name="ln444">      }</a>
<a name="ln445"> </a>
<a name="ln446">//---------------------------------------------------------</a>
<a name="ln447">//   noJackError</a>
<a name="ln448">//---------------------------------------------------------</a>
<a name="ln449"> </a>
<a name="ln450">static void noJackError(const char*  s )</a>
<a name="ln451">      {</a>
<a name="ln452">      qDebug(&quot;noJACK ERROR: %s&quot;, s);</a>
<a name="ln453">      }</a>
<a name="ln454"> </a>
<a name="ln455">//---------------------------------------------------------</a>
<a name="ln456">//   init</a>
<a name="ln457">//    return false on error</a>
<a name="ln458">//---------------------------------------------------------</a>
<a name="ln459"> </a>
<a name="ln460">bool JackAudio::init(bool hot)</a>
<a name="ln461">      {</a>
<a name="ln462">      if (hot) {</a>
<a name="ln463">            hotPlug();</a>
<a name="ln464">            return true;</a>
<a name="ln465">            }</a>
<a name="ln466">      jack_set_error_function(noJackError);</a>
<a name="ln467"> </a>
<a name="ln468">      client = 0;</a>
<a name="ln469">      timeSigTempoChanged = false;</a>
<a name="ln470">      fakeState = Transport::STOP;</a>
<a name="ln471">      strcpy(_jackName, &quot;mscore&quot;);</a>
<a name="ln472"> </a>
<a name="ln473">      jack_options_t options = (jack_options_t)0;</a>
<a name="ln474">      jack_status_t status;</a>
<a name="ln475">      client = jack_client_open(_jackName, options, &amp;status);</a>
<a name="ln476"> </a>
<a name="ln477">      if (client == 0) {</a>
<a name="ln478">            qDebug(&quot;JackAudio()::init(): failed, status 0x%0x&quot;, status);</a>
<a name="ln479">            return false;</a>
<a name="ln480">            }</a>
<a name="ln481"> </a>
<a name="ln482">      jack_set_error_function(jackError);</a>
<a name="ln483">      jack_set_process_callback(client, processAudio, this);</a>
<a name="ln484">      //jack_on_shutdown(client, processShutdown, this);</a>
<a name="ln485">      jack_set_sample_rate_callback(client, sampleRateCallback, this);</a>
<a name="ln486">      jack_set_port_registration_callback(client, registration_callback, this);</a>
<a name="ln487">      jack_set_graph_order_callback(client, graph_callback, this);</a>
<a name="ln488">      jack_set_freewheel_callback (client, freewheel_callback, this);</a>
<a name="ln489">      if (preferences.getBool(PREF_IO_JACK_TIMEBASEMASTER))</a>
<a name="ln490">            setTimebaseCallback();</a>
<a name="ln491">      if (jack_set_buffer_size_callback (client, bufferSizeCallback, this) != 0)</a>
<a name="ln492">            qDebug(&quot;Can not set bufferSizeCallback&quot;);</a>
<a name="ln493">      _segmentSize  = jack_get_buffer_size(client);</a>
<a name="ln494"> </a>
<a name="ln495">      MScore::sampleRate = sampleRate();</a>
<a name="ln496">      // register mscore left/right output ports</a>
<a name="ln497">      if (preferences.getBool(PREF_IO_JACK_USEJACKAUDIO)) {</a>
<a name="ln498">            registerPort(&quot;left&quot;, false, false);</a>
<a name="ln499">            registerPort(&quot;right&quot;, false, false);</a>
<a name="ln500">            }</a>
<a name="ln501"> </a>
<a name="ln502">      if (preferences.getBool(PREF_IO_JACK_USEJACKMIDI)) {</a>
<a name="ln503">            registerPort(QString(&quot;mscore-midi-1&quot;), false, true);</a>
<a name="ln504">            registerPort(QString(&quot;mscore-midiin-1&quot;), true, true);</a>
<a name="ln505">            }</a>
<a name="ln506">      return true;</a>
<a name="ln507">      }</a>
<a name="ln508"> </a>
<a name="ln509">//---------------------------------------------------------</a>
<a name="ln510">//   startTransport</a>
<a name="ln511">//---------------------------------------------------------</a>
<a name="ln512"> </a>
<a name="ln513">void JackAudio::startTransport()</a>
<a name="ln514">      {</a>
<a name="ln515">      if (preferences.getBool(PREF_IO_JACK_USEJACKTRANSPORT))</a>
<a name="ln516">            jack_transport_start(client);</a>
<a name="ln517">      else</a>
<a name="ln518">            fakeState = Transport::PLAY;</a>
<a name="ln519">      }</a>
<a name="ln520"> </a>
<a name="ln521">//---------------------------------------------------------</a>
<a name="ln522">//   stopTrasnport</a>
<a name="ln523">//---------------------------------------------------------</a>
<a name="ln524"> </a>
<a name="ln525">void JackAudio::stopTransport()</a>
<a name="ln526">      {</a>
<a name="ln527">      if (preferences.getBool(PREF_IO_JACK_USEJACKTRANSPORT))</a>
<a name="ln528">            jack_transport_stop(client);</a>
<a name="ln529">      else</a>
<a name="ln530">            fakeState = Transport::STOP;</a>
<a name="ln531">      }</a>
<a name="ln532"> </a>
<a name="ln533">//---------------------------------------------------------</a>
<a name="ln534">//   getState</a>
<a name="ln535">//---------------------------------------------------------</a>
<a name="ln536"> </a>
<a name="ln537">Transport JackAudio::getState()</a>
<a name="ln538">      {</a>
<a name="ln539">      if (!preferences.getBool(PREF_IO_JACK_USEJACKTRANSPORT))</a>
<a name="ln540">            return fakeState;</a>
<a name="ln541">      int transportState = jack_transport_query(client, NULL);</a>
<a name="ln542">      switch (transportState) {</a>
<a name="ln543">            case JackTransportStopped:  return Transport::STOP;</a>
<a name="ln544">            case JackTransportLooping:</a>
<a name="ln545">            case JackTransportRolling:  return Transport::PLAY;</a>
<a name="ln546">            case JackTransportStarting: return seq-&gt;isPlaying()?Transport::PLAY:Transport::STOP;// Keep current state</a>
<a name="ln547">            default:</a>
<a name="ln548">                  return Transport::STOP;</a>
<a name="ln549">            }</a>
<a name="ln550">      }</a>
<a name="ln551"> </a>
<a name="ln552">//---------------------------------------------------------</a>
<a name="ln553">//   putEvent</a>
<a name="ln554">//---------------------------------------------------------</a>
<a name="ln555"> </a>
<a name="ln556">void JackAudio::putEvent(const NPlayEvent&amp; e, unsigned framePos)</a>
<a name="ln557">      {</a>
<a name="ln558">      if (!preferences.getBool(PREF_IO_JACK_USEJACKMIDI))</a>
<a name="ln559">            return;</a>
<a name="ln560"> </a>
<a name="ln561">      int portIdx = seq-&gt;score()-&gt;midiPort(e.channel());</a>
<a name="ln562">      int chan    = seq-&gt;score()-&gt;midiChannel(e.channel());</a>
<a name="ln563"> </a>
<a name="ln564">// qDebug(&quot;JackAudio::putEvent %d:%d  pos %d(%d)&quot;, portIdx, chan, framePos, _segmentSize);</a>
<a name="ln565"> </a>
<a name="ln566">      if (portIdx &lt; 0 || portIdx &gt;= midiOutputPorts.size()) {</a>
<a name="ln567">            qDebug(&quot;JackAudio::putEvent: invalid port %d&quot;, portIdx);</a>
<a name="ln568">            return;</a>
<a name="ln569">            }</a>
<a name="ln570">      jack_port_t* port = midiOutputPorts[portIdx];</a>
<a name="ln571">      if (midiOutputTrace) {</a>
<a name="ln572">            const char* portName = jack_port_name(port);</a>
<a name="ln573">            int a     = e.dataA();</a>
<a name="ln574">            int b     = e.dataB();</a>
<a name="ln575">            qDebug(&quot;MidiOut&lt;%s&gt;: jackMidi: %02x %02x %02x, chan: %i&quot;, portName, e.type(), a, b, chan);</a>
<a name="ln576">            // e.dump();</a>
<a name="ln577">            }</a>
<a name="ln578">      void* pb = jack_port_get_buffer(port, _segmentSize);</a>
<a name="ln579"> </a>
<a name="ln580">      if (pb == NULL) {</a>
<a name="ln581">            qDebug()&lt;&lt;&quot;jack_port_get_buffer failed, cannot send anything&quot;;</a>
<a name="ln582">            }</a>
<a name="ln583"> </a>
<a name="ln584">      if (framePos &gt;= _segmentSize) {</a>
<a name="ln585">            qDebug(&quot;JackAudio::putEvent: time out of range %d(seg=%d)&quot;, framePos, _segmentSize);</a>
<a name="ln586">            if (framePos &gt; _segmentSize)</a>
<a name="ln587">                  framePos = _segmentSize - 1;</a>
<a name="ln588">            }</a>
<a name="ln589"> </a>
<a name="ln590">      switch(e.type()) {</a>
<a name="ln591">            case ME_NOTEON:</a>
<a name="ln592">            case ME_NOTEOFF:</a>
<a name="ln593">            case ME_POLYAFTER:</a>
<a name="ln594">            case ME_CONTROLLER:</a>
<a name="ln595">                  // Catch CTRL_PROGRAM and let other ME_CONTROLLER events to go</a>
<a name="ln596">                  if (e.dataA() == CTRL_PROGRAM) {</a>
<a name="ln597">                        // Convert CTRL_PROGRAM event to ME_PROGRAM</a>
<a name="ln598">                        unsigned char* p = jack_midi_event_reserve(pb, framePos, 2);</a>
<a name="ln599">                        if (p == 0) {</a>
<a name="ln600">                              qDebug(&quot;JackMidi: buffer overflow, event lost&quot;);</a>
<a name="ln601">                              return;</a>
<a name="ln602">                              }</a>
<a name="ln603">                        p[0] = ME_PROGRAM | chan;</a>
<a name="ln604">                        p[1] = less128(e.dataB());</a>
<a name="ln605">                        break;</a>
<a name="ln606">                        }</a>
<a name="ln607">                  //fall through</a>
<a name="ln608">            case ME_PITCHBEND:</a>
<a name="ln609">                  {</a>
<a name="ln610">                  unsigned char* p = jack_midi_event_reserve(pb, framePos, 3);</a>
<a name="ln611">                  if (p == 0) {</a>
<a name="ln612">                        qDebug(&quot;JackMidi: buffer overflow, event lost&quot;);</a>
<a name="ln613">                        return;</a>
<a name="ln614">                        }</a>
<a name="ln615">                  p[0] = e.type() | chan;</a>
<a name="ln616">                  p[1] = less128(e.dataA());</a>
<a name="ln617">                  p[2] = less128(e.dataB());</a>
<a name="ln618">                  }</a>
<a name="ln619">                  break;</a>
<a name="ln620"> </a>
<a name="ln621">            case ME_PROGRAM:</a>
<a name="ln622">            case ME_AFTERTOUCH:</a>
<a name="ln623">                  {</a>
<a name="ln624">                  unsigned char* p = jack_midi_event_reserve(pb, framePos, 2);</a>
<a name="ln625">                  if (p == 0) {</a>
<a name="ln626">                        qDebug(&quot;JackMidi: buffer overflow, event lost&quot;);</a>
<a name="ln627">                        return;</a>
<a name="ln628">                        }</a>
<a name="ln629">                  p[0] = e.type() | chan;</a>
<a name="ln630">                  p[1] = less128(e.dataA());</a>
<a name="ln631">                  }</a>
<a name="ln632">                  break;</a>
<a name="ln633">          // Do we really need to handle ME_SYSEX?</a>
<a name="ln634">          /*  case ME_SYSEX:</a>
<a name="ln635">                  {</a>
<a name="ln636">                  const unsigned char* data = e.edata();</a>
<a name="ln637">                  int len = e.len();</a>
<a name="ln638">                  unsigned char* p = jack_midi_event_reserve(pb, framePos, len+2);</a>
<a name="ln639">                  if (p == 0) {</a>
<a name="ln640">                        qDebug(&quot;JackMidi: buffer overflow, event lost&quot;);</a>
<a name="ln641">                        return;</a>
<a name="ln642">                        }</a>
<a name="ln643">                  p[0]     = 0xf0;</a>
<a name="ln644">                  p[len+1] = 0xf7;</a>
<a name="ln645">                  memcpy(p+1, data, len);</a>
<a name="ln646">                  }</a>
<a name="ln647">                  break;*/</a>
<a name="ln648">            case ME_SONGPOS:</a>
<a name="ln649">            case ME_CLOCK:</a>
<a name="ln650">            case ME_START:</a>
<a name="ln651">            case ME_CONTINUE:</a>
<a name="ln652">            case ME_STOP:</a>
<a name="ln653">                  qDebug(&quot;JackMidi: event type %x not supported&quot;, e.type());</a>
<a name="ln654">                  break;</a>
<a name="ln655">            }</a>
<a name="ln656">      }</a>
<a name="ln657"> </a>
<a name="ln658">//---------------------------------------------------------</a>
<a name="ln659">//   midiRead</a>
<a name="ln660">//---------------------------------------------------------</a>
<a name="ln661"> </a>
<a name="ln662">void JackAudio::midiRead()</a>
<a name="ln663">      {</a>
<a name="ln664">//      midiDriver-&gt;read();</a>
<a name="ln665">      }</a>
<a name="ln666"> </a>
<a name="ln667">//---------------------------------------------------------</a>
<a name="ln668">//   handleTimeSigTempoChanged</a>
<a name="ln669">//   Called after tempo or time signature</a>
<a name="ln670">//   changed while playback</a>
<a name="ln671">//---------------------------------------------------------</a>
<a name="ln672"> </a>
<a name="ln673">void JackAudio::handleTimeSigTempoChanged()</a>
<a name="ln674">      {</a>
<a name="ln675">      timeSigTempoChanged = true;</a>
<a name="ln676">      }</a>
<a name="ln677"> </a>
<a name="ln678">//---------------------------------------------------------</a>
<a name="ln679">//   checkTransportSeek</a>
<a name="ln680">//   The opposite of Timebase master:</a>
<a name="ln681">//   check JACK Transport for a new position or tempo.</a>
<a name="ln682">//---------------------------------------------------------</a>
<a name="ln683"> </a>
<a name="ln684">void JackAudio::checkTransportSeek(int cur_frame, int nframes, bool inCountIn)</a>
<a name="ln685">      {</a>
<a name="ln686">      if (!seq || !seq-&gt;score() || inCountIn)</a>
<a name="ln687">            return;</a>
<a name="ln688"> </a>
<a name="ln689">      // Obtaining the current JACK Transport position</a>
<a name="ln690">      jack_position_t pos;</a>
<a name="ln691">      jack_transport_query(client, &amp;pos);</a>
<a name="ln692"> </a>
<a name="ln693">      if (preferences.getBool(PREF_IO_JACK_USEJACKTRANSPORT)) {</a>
<a name="ln694">            if (mscore-&gt;getPlayPanel() &amp;&amp; mscore-&gt;getPlayPanel()-&gt;isTempoSliderPressed())</a>
<a name="ln695">                  return;</a>
<a name="ln696">            int cur_utick = seq-&gt;score()-&gt;utime2utick((qreal)cur_frame / MScore::sampleRate);</a>
<a name="ln697">            int utick     = seq-&gt;score()-&gt;utime2utick((qreal)pos.frame / MScore::sampleRate);</a>
<a name="ln698"> </a>
<a name="ln699">            // Conversion is not precise, should check frames and uticks</a>
<a name="ln700">            if (labs((long int)cur_frame - (long int)pos.frame)&gt;nframes + 1 &amp;&amp; abs(utick - cur_utick)&gt; seq-&gt;score()-&gt;utime2utick((qreal)nframes / MScore::sampleRate) + 1) {</a>
<a name="ln701">                  if (MScore::debugMode)</a>
<a name="ln702">                        qDebug()&lt;&lt;&quot;JACK Transport position changed, cur_frame: &quot;&lt;&lt;cur_frame&lt;&lt;&quot;,pos.frame: &quot;&lt;&lt;pos.frame&lt;&lt;&quot;, frame diff: &quot;&lt;&lt;labs((long int)cur_frame - (long int)pos.frame)&lt;&lt;&quot;cur utick:&quot;&lt;&lt;cur_utick&lt;&lt;&quot;,seek to utick: &quot;&lt;&lt;utick&lt;&lt;&quot;, tick diff: &quot;&lt;&lt;abs(utick - cur_utick);</a>
<a name="ln703">                  seq-&gt;seekRT(utick);</a>
<a name="ln704">                  }</a>
<a name="ln705">            }</a>
<a name="ln706"> </a>
<a name="ln707">      // Tempo</a>
<a name="ln708">      if (!preferences.getBool(PREF_IO_JACK_TIMEBASEMASTER)  &amp;&amp; (pos.valid &amp; JackPositionBBT)) {</a>
<a name="ln709">            if (!seq-&gt;score()-&gt;tempomap())</a>
<a name="ln710">                  return;</a>
<a name="ln711"> </a>
<a name="ln712">            if (int(pos.beats_per_minute) != int(60 * seq-&gt;curTempo() * seq-&gt;score()-&gt;tempomap()-&gt;relTempo())) {</a>
<a name="ln713">                  if (MScore::debugMode)</a>
<a name="ln714">                        qDebug()&lt;&lt;&quot;JACK Transport tempo changed! JACK bpm: &quot;&lt;&lt;(int)pos.beats_per_minute&lt;&lt;&quot;, current bpm: &quot;&lt;&lt;int(60 * seq-&gt;curTempo() * seq-&gt;score()-&gt;tempomap()-&gt;relTempo());</a>
<a name="ln715">                  if (60 * seq-&gt;curTempo() == 0.0)</a>
<a name="ln716">                        return;</a>
<a name="ln717">                  qreal newRelTempo = pos.beats_per_minute / (60* seq-&gt;curTempo());</a>
<a name="ln718">                  seq-&gt;setRelTempo(newRelTempo);</a>
<a name="ln719">                  // Update UI</a>
<a name="ln720">                  if (mscore-&gt;getPlayPanel()) {</a>
<a name="ln721">                        mscore-&gt;getPlayPanel()-&gt;setRelTempo(newRelTempo);</a>
<a name="ln722">                        mscore-&gt;getPlayPanel()-&gt;setTempo(seq-&gt;curTempo() * newRelTempo);</a>
<a name="ln723">                        }</a>
<a name="ln724">                  }</a>
<a name="ln725">            }</a>
<a name="ln726">      }</a>
<a name="ln727"> </a>
<a name="ln728">//---------------------------------------------------------</a>
<a name="ln729">//   seekTransport</a>
<a name="ln730">//---------------------------------------------------------</a>
<a name="ln731"> </a>
<a name="ln732">void JackAudio::seekTransport(int utick)</a>
<a name="ln733">      {</a>
<a name="ln734">      if (MScore::debugMode)</a>
<a name="ln735">            qDebug()&lt;&lt;&quot;jack locate to utick: &quot;&lt;&lt;utick&lt;&lt;&quot;, frame: &quot;&lt;&lt;int(seq-&gt;score()-&gt;utick2utime(utick) * MScore::sampleRate);</a>
<a name="ln736">      jack_transport_locate(client, seq-&gt;score()-&gt;utick2utime(utick) * MScore::sampleRate);</a>
<a name="ln737">      }</a>
<a name="ln738"> </a>
<a name="ln739">//---------------------------------------------------------</a>
<a name="ln740">//   setTimebaseCallback</a>
<a name="ln741">//---------------------------------------------------------</a>
<a name="ln742"> </a>
<a name="ln743">void JackAudio::setTimebaseCallback()</a>
<a name="ln744">      {</a>
<a name="ln745">      int errCode = jack_set_timebase_callback(client, 0, timebase, this); // 0: force set timebase</a>
<a name="ln746">      if (errCode == 0) {</a>
<a name="ln747">            if (MScore::debugMode)</a>
<a name="ln748">                  qDebug(&quot;Registered as JACK Timebase Master.&quot;);</a>
<a name="ln749">            }</a>
<a name="ln750">      else {</a>
<a name="ln751">            preferences.setPreference(PREF_IO_JACK_TIMEBASEMASTER, false);</a>
<a name="ln752">            qDebug(&quot;Unable to take over JACK Timebase, error code: %i&quot;,errCode);</a>
<a name="ln753">            }</a>
<a name="ln754">      }</a>
<a name="ln755"> </a>
<a name="ln756">//---------------------------------------------------------</a>
<a name="ln757">//   releaseTimebaseCallback</a>
<a name="ln758">//---------------------------------------------------------</a>
<a name="ln759"> </a>
<a name="ln760">void JackAudio::releaseTimebaseCallback()</a>
<a name="ln761">      {</a>
<a name="ln762">      int errCode = jack_release_timebase(client);</a>
<a name="ln763">      if (errCode == 0)</a>
<a name="ln764">            qDebug(&quot;Unregistered as JACK Timebase Master&quot;);</a>
<a name="ln765">      else</a>
<a name="ln766">            qDebug(&quot;Unable to unregister as JACK Timebase Master (not a Timebase Master?), error code: %i&quot;, errCode);</a>
<a name="ln767">      }</a>
<a name="ln768"> </a>
<a name="ln769">//---------------------------------------------------------</a>
<a name="ln770">//   rememberAudioConnections</a>
<a name="ln771">//---------------------------------------------------------</a>
<a name="ln772"> </a>
<a name="ln773">void JackAudio::rememberAudioConnections()</a>
<a name="ln774">      {</a>
<a name="ln775">      if (!preferences.getBool(PREF_IO_JACK_REMEMBERLASTCONNECTIONS))</a>
<a name="ln776">            return;</a>
<a name="ln777">      if (MScore::debugMode)</a>
<a name="ln778">            qDebug(&quot;Saving audio connections...&quot;);</a>
<a name="ln779">      QSettings settings;</a>
<a name="ln780">      settings.setValue(QString(&quot;audio-0-connections&quot;), 0);</a>
<a name="ln781">      settings.setValue(QString(&quot;audio-1-connections&quot;), 0);</a>
<a name="ln782">      int port = 0;</a>
<a name="ln783">      foreach(jack_port_t* mp, ports) {</a>
<a name="ln784">            const char** cc = jack_port_get_connections(mp);</a>
<a name="ln785">            const char** c = cc;</a>
<a name="ln786">            int idx = 0;</a>
<a name="ln787">            while (c) {</a>
<a name="ln788">                  const char* p = *c++;</a>
<a name="ln789">                  if (p == 0)</a>
<a name="ln790">                        break;</a>
<a name="ln791">                  settings.setValue(QString(&quot;audio-%1-%2&quot;).arg(port).arg(idx), p);</a>
<a name="ln792">                  ++idx;</a>
<a name="ln793">                  }</a>
<a name="ln794">            settings.setValue(QString(&quot;audio-%1-connections&quot;).arg(port), idx);</a>
<a name="ln795">            free((void*)cc);</a>
<a name="ln796">            ++port;</a>
<a name="ln797">            }</a>
<a name="ln798">      }</a>
<a name="ln799"> </a>
<a name="ln800">//---------------------------------------------------------</a>
<a name="ln801">//   restoreAudioConnections</a>
<a name="ln802">//   Connect to the ports in Preferences-&gt;I/O</a>
<a name="ln803">//---------------------------------------------------------</a>
<a name="ln804"> </a>
<a name="ln805">void JackAudio::restoreAudioConnections()</a>
<a name="ln806">      {</a>
<a name="ln807">      for (auto p : ports)</a>
<a name="ln808">            jack_port_disconnect(client, p);</a>
<a name="ln809"> </a>
<a name="ln810">      QList&lt;QString&gt; portList = inputPorts();</a>
<a name="ln811">      QList&lt;QString&gt;::iterator pi = portList.begin();</a>
<a name="ln812"> </a>
<a name="ln813">      QSettings settings;</a>
<a name="ln814">      // Number of saved ports</a>
<a name="ln815">      int n = settings.value(QString(&quot;audio-0-connections&quot;), 0).toInt() + settings.value(QString(&quot;audio-1-connections&quot;), 0).toInt();</a>
<a name="ln816"> </a>
<a name="ln817">      // Connecting to system ports</a>
<a name="ln818">      if (!preferences.getBool(PREF_IO_JACK_REMEMBERLASTCONNECTIONS) || n == 0) {</a>
<a name="ln819">            if (MScore::debugMode)</a>
<a name="ln820">                  qDebug(&quot;Connecting to system ports...&quot;);</a>
<a name="ln821">            for (auto p : ports) {</a>
<a name="ln822">                  const char* src = jack_port_name(p);</a>
<a name="ln823">                  if (pi != portList.end()) {</a>
<a name="ln824">                        connect(src, qPrintable(*pi));</a>
<a name="ln825">                        ++pi;</a>
<a name="ln826">                        }</a>
<a name="ln827">                  }</a>
<a name="ln828">            return;</a>
<a name="ln829">            }</a>
<a name="ln830">      if (MScore::debugMode)</a>
<a name="ln831">            qDebug(&quot;Restoring audio connections...&quot;);</a>
<a name="ln832">      // Connecting to saved ports</a>
<a name="ln833">      int nPorts = ports.size();</a>
<a name="ln834">      for (int i = 0; i &lt; nPorts; ++i) {</a>
<a name="ln835">            int j = settings.value(QString(&quot;audio-%1-connections&quot;).arg(i), 0).toInt();</a>
<a name="ln836">            const char* src = jack_port_name(ports[i]);</a>
<a name="ln837">            for (int k = 0; k &lt; j; ++k) {</a>
<a name="ln838">                  QString dst = settings.value(QString(&quot;audio-%1-%2&quot;).arg(i).arg(k), &quot;&quot;).toString();</a>
<a name="ln839">                  if (!dst.isEmpty()) {</a>
<a name="ln840">                        if (jack_port_connected_to(ports[i], qPrintable(dst)))</a>
<a name="ln841">                              qDebug()&lt;&lt;&quot;Audio port &quot;&lt;&lt;src&lt;&lt;&quot; (&quot;&lt;&lt;i&lt;&lt;&quot;) already connected to &quot;&lt;&lt;qPrintable(dst);</a>
<a name="ln842">                        else</a>
<a name="ln843">                              connect(src, qPrintable(dst));</a>
<a name="ln844">                        }</a>
<a name="ln845">                  }</a>
<a name="ln846">            }</a>
<a name="ln847">      }</a>
<a name="ln848"> </a>
<a name="ln849">//---------------------------------------------------------</a>
<a name="ln850">//   rememberMidiConnections</a>
<a name="ln851">//---------------------------------------------------------</a>
<a name="ln852"> </a>
<a name="ln853">void JackAudio::rememberMidiConnections()</a>
<a name="ln854">      {</a>
<a name="ln855">      if (!preferences.getBool(PREF_IO_JACK_REMEMBERLASTCONNECTIONS))</a>
<a name="ln856">            return;</a>
<a name="ln857">      if (MScore::debugMode)</a>
<a name="ln858">            qDebug(&quot;Saving midi connections...&quot;);</a>
<a name="ln859">      QSettings settings;</a>
<a name="ln860">      int port = 0;</a>
<a name="ln861">      foreach(jack_port_t* mp, midiOutputPorts) {</a>
<a name="ln862">            const char** cc = jack_port_get_connections(mp);</a>
<a name="ln863">            const char** c = cc;</a>
<a name="ln864">            int idx = 0;</a>
<a name="ln865">            while (c) {</a>
<a name="ln866">                  const char* p = *c++;</a>
<a name="ln867">                  if (p == 0)</a>
<a name="ln868">                        break;</a>
<a name="ln869">                  settings.setValue(QString(&quot;midi-%1-%2&quot;).arg(port).arg(idx), p);</a>
<a name="ln870">                  ++idx;</a>
<a name="ln871">                  }</a>
<a name="ln872">            settings.setValue(QString(&quot;midi-%1-connections&quot;).arg(port), idx);</a>
<a name="ln873">            free((void*)cc);</a>
<a name="ln874">            ++port;</a>
<a name="ln875">            }</a>
<a name="ln876"> </a>
<a name="ln877">      port = 0;</a>
<a name="ln878">      foreach(jack_port_t* mp, midiInputPorts) {</a>
<a name="ln879">            const char** cc = jack_port_get_connections(mp);</a>
<a name="ln880">            const char** c = cc;</a>
<a name="ln881">            int idx = 0;</a>
<a name="ln882">            while (c) {</a>
<a name="ln883">                  const char* p = *c++;</a>
<a name="ln884">                  if (p == 0)</a>
<a name="ln885">                        break;</a>
<a name="ln886">                  settings.setValue(QString(&quot;midiin-%1-%2&quot;).arg(idx).arg(port), p);</a>
<a name="ln887">                  ++idx;</a>
<a name="ln888">                  }</a>
<a name="ln889">            settings.setValue(QString(&quot;midiin-%1-connections&quot;).arg(port), idx);</a>
<a name="ln890">            free((void*)cc);</a>
<a name="ln891">            ++port;</a>
<a name="ln892">            }</a>
<a name="ln893">      }</a>
<a name="ln894"> </a>
<a name="ln895">//---------------------------------------------------------</a>
<a name="ln896">//   restoreMidiConnections</a>
<a name="ln897">//   Connects to the ports from previous connection</a>
<a name="ln898">//---------------------------------------------------------</a>
<a name="ln899"> </a>
<a name="ln900">void JackAudio::restoreMidiConnections()</a>
<a name="ln901">      {</a>
<a name="ln902">      if (!preferences.getBool(PREF_IO_JACK_REMEMBERLASTCONNECTIONS))</a>
<a name="ln903">            return;</a>
<a name="ln904">      if (MScore::debugMode)</a>
<a name="ln905">            qDebug(&quot;Restoring midi connections...&quot;);</a>
<a name="ln906">      QSettings settings;</a>
<a name="ln907">      int nPorts = midiOutputPorts.size();</a>
<a name="ln908">      for (int i = 0; i &lt; nPorts; ++i) {</a>
<a name="ln909">            int n = settings.value(QString(&quot;midi-%1-connections&quot;).arg(i), 0).toInt();</a>
<a name="ln910">            const char* src = jack_port_name(midiOutputPorts[i]);</a>
<a name="ln911">            for (int k = 0; k &lt; n; ++k) {</a>
<a name="ln912">                  QString dst = settings.value(QString(&quot;midi-%1-%2&quot;).arg(i).arg(k), &quot;&quot;).toString();</a>
<a name="ln913">                  if (!dst.isEmpty()) {</a>
<a name="ln914">                        if (jack_port_connected_to(midiOutputPorts[i], qPrintable(dst)))</a>
<a name="ln915">                              continue;</a>
<a name="ln916">                        connect(src, qPrintable(dst));</a>
<a name="ln917">                        }</a>
<a name="ln918">                  }</a>
<a name="ln919">            }</a>
<a name="ln920">      nPorts = midiInputPorts.size();</a>
<a name="ln921">      for (int i = 0; i &lt; nPorts; ++i) {</a>
<a name="ln922">            int n = settings.value(QString(&quot;midiin-%1-connections&quot;).arg(i), 0).toInt();</a>
<a name="ln923">            const char* dst = jack_port_name(midiInputPorts[i]);</a>
<a name="ln924">            for (int k = 0; k &lt; n; ++k) {</a>
<a name="ln925">                  QString src = settings.value(QString(&quot;midiin-%1-%2&quot;).arg(k).arg(i), &quot;&quot;).toString();</a>
<a name="ln926">                  if (!src.isEmpty()) {</a>
<a name="ln927">                        if (jack_port_connected_to(midiInputPorts[i], qPrintable(src)))</a>
<a name="ln928">                              continue;</a>
<a name="ln929">                        connect(qPrintable(src), dst);</a>
<a name="ln930">                        }</a>
<a name="ln931">                  }</a>
<a name="ln932">            }</a>
<a name="ln933">      }</a>
<a name="ln934"> </a>
<a name="ln935">//---------------------------------------------------------</a>
<a name="ln936">//   hotPlug</a>
<a name="ln937">//   Change driver settings without unload</a>
<a name="ln938">//---------------------------------------------------------</a>
<a name="ln939"> </a>
<a name="ln940">void JackAudio::hotPlug()</a>
<a name="ln941">      {</a>
<a name="ln942">      bool oldremember = preferences.getBool(PREF_IO_JACK_REMEMBERLASTCONNECTIONS);</a>
<a name="ln943">      preferences.setPreference(PREF_IO_JACK_REMEMBERLASTCONNECTIONS, true);</a>
<a name="ln944">      // Remember connections before calling jack_deactivate() - it disconnects all ports</a>
<a name="ln945">      rememberMidiConnections();</a>
<a name="ln946">      if (ports.size() != 0)</a>
<a name="ln947">            rememberAudioConnections();</a>
<a name="ln948"> </a>
<a name="ln949">      // We must set callbacks only on inactive client</a>
<a name="ln950">      if (jack_deactivate(client))</a>
<a name="ln951">            qDebug(&quot;cannot deactivate client&quot;);</a>
<a name="ln952"> </a>
<a name="ln953">      // Audio connections</a>
<a name="ln954">      if (preferences.getBool(PREF_IO_JACK_USEJACKAUDIO)) {</a>
<a name="ln955">            if (ports.size() == 0) {</a>
<a name="ln956">                  registerPort(&quot;left&quot;, false, false);</a>
<a name="ln957">                  registerPort(&quot;right&quot;, false, false);</a>
<a name="ln958">                  }</a>
<a name="ln959">            }</a>
<a name="ln960">      else if (!preferences.getBool(PREF_IO_JACK_USEJACKAUDIO)) {</a>
<a name="ln961">            foreach(jack_port_t* p, ports) {</a>
<a name="ln962">                  unregisterPort(p);</a>
<a name="ln963">                  ports.removeOne(p);</a>
<a name="ln964">                  }</a>
<a name="ln965">            }</a>
<a name="ln966"> </a>
<a name="ln967">      // Midi connections</a>
<a name="ln968">      if (preferences.getBool(PREF_IO_JACK_USEJACKMIDI)) {</a>
<a name="ln969">            if (midiInputPorts.size() == 0)</a>
<a name="ln970">                  registerPort(QString(&quot;mscore-midiin-1&quot;), true, true);</a>
<a name="ln971">            }</a>
<a name="ln972">      else { // No midi</a>
<a name="ln973">            updateOutPortCount(0);</a>
<a name="ln974">            if (midiInputPorts.size() != 0) {</a>
<a name="ln975">                  unregisterPort(midiInputPorts[0]);</a>
<a name="ln976">                  midiInputPorts.removeOne(midiInputPorts[0]);</a>
<a name="ln977">                  }</a>
<a name="ln978">            }</a>
<a name="ln979"> </a>
<a name="ln980">      // Timebase Master callback</a>
<a name="ln981">      if (preferences.getBool(PREF_IO_JACK_TIMEBASEMASTER))</a>
<a name="ln982">            setTimebaseCallback();</a>
<a name="ln983">      else</a>
<a name="ln984">            releaseTimebaseCallback();</a>
<a name="ln985"> </a>
<a name="ln986">      preferences.setPreference(PREF_IO_JACK_REMEMBERLASTCONNECTIONS, oldremember);</a>
<a name="ln987">      }</a>
<a name="ln988">}</a>

</code></pre>
<div class="balloon" rel="63"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="111"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="443"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="452"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="48"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: _segmentSize, fakeState, _jackName, timeSigTempoChanged.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
