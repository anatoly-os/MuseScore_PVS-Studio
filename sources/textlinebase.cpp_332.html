
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>textlinebase.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2011 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;textlinebase.h&quot;</a>
<a name="ln14">#include &quot;style.h&quot;</a>
<a name="ln15">#include &quot;system.h&quot;</a>
<a name="ln16">#include &quot;measure.h&quot;</a>
<a name="ln17">#include &quot;xml.h&quot;</a>
<a name="ln18">#include &quot;utils.h&quot;</a>
<a name="ln19">#include &quot;score.h&quot;</a>
<a name="ln20">#include &quot;sym.h&quot;</a>
<a name="ln21">#include &quot;text.h&quot;</a>
<a name="ln22">#include &quot;mscore.h&quot;</a>
<a name="ln23">#include &quot;staff.h&quot;</a>
<a name="ln24"> </a>
<a name="ln25">namespace Ms {</a>
<a name="ln26"> </a>
<a name="ln27">//---------------------------------------------------------</a>
<a name="ln28">//   TextLineBaseSegment</a>
<a name="ln29">//---------------------------------------------------------</a>
<a name="ln30"> </a>
<a name="ln31">TextLineBaseSegment::TextLineBaseSegment(Spanner* sp, Score* score, ElementFlags f)</a>
<a name="ln32">   : LineSegment(sp, score, f)</a>
<a name="ln33">      {</a>
<a name="ln34">      _text    = new Text(score);</a>
<a name="ln35">      _endText = new Text(score);</a>
<a name="ln36">      _text-&gt;setParent(this);</a>
<a name="ln37">      _endText-&gt;setParent(this);</a>
<a name="ln38">      _text-&gt;setFlag(ElementFlag::MOVABLE, false);</a>
<a name="ln39">      _endText-&gt;setFlag(ElementFlag::MOVABLE, false);</a>
<a name="ln40">      }</a>
<a name="ln41"> </a>
<a name="ln42">TextLineBaseSegment::TextLineBaseSegment(const TextLineBaseSegment&amp; seg)</a>
<a name="ln43">   : LineSegment(seg)</a>
<a name="ln44">      {</a>
<a name="ln45">      _text    = new Text(*seg._text);</a>
<a name="ln46">      _endText = new Text(*seg._endText);</a>
<a name="ln47">      _text-&gt;setParent(this);</a>
<a name="ln48">      _endText-&gt;setParent(this);</a>
<a name="ln49">      layout();    // set the right _text</a>
<a name="ln50">      }</a>
<a name="ln51"> </a>
<a name="ln52">TextLineBaseSegment::~TextLineBaseSegment()</a>
<a name="ln53">      {</a>
<a name="ln54">      delete _text;</a>
<a name="ln55">      delete _endText;</a>
<a name="ln56">      }</a>
<a name="ln57"> </a>
<a name="ln58">//---------------------------------------------------------</a>
<a name="ln59">//   setSelected</a>
<a name="ln60">//---------------------------------------------------------</a>
<a name="ln61"> </a>
<a name="ln62">void TextLineBaseSegment::setSelected(bool f)</a>
<a name="ln63">      {</a>
<a name="ln64">      SpannerSegment::setSelected(f);</a>
<a name="ln65">      _text-&gt;setSelected(f);</a>
<a name="ln66">      _endText-&gt;setSelected(f);</a>
<a name="ln67">      }</a>
<a name="ln68"> </a>
<a name="ln69">//---------------------------------------------------------</a>
<a name="ln70">//   draw</a>
<a name="ln71">//---------------------------------------------------------</a>
<a name="ln72"> </a>
<a name="ln73">void TextLineBaseSegment::draw(QPainter* painter) const</a>
<a name="ln74">      {</a>
<a name="ln75">      TextLineBase* tl   = textLineBase();</a>
<a name="ln76"> </a>
<a name="ln77">      if (!_text-&gt;empty()) {</a>
<a name="ln78">            painter-&gt;translate(_text-&gt;pos());</a>
<a name="ln79">            _text-&gt;setVisible(tl-&gt;visible());</a>
<a name="ln80">            _text-&gt;draw(painter);</a>
<a name="ln81">            painter-&gt;translate(-_text-&gt;pos());</a>
<a name="ln82">            }</a>
<a name="ln83"> </a>
<a name="ln84">      if (!_endText-&gt;empty()) {</a>
<a name="ln85">            painter-&gt;translate(_endText-&gt;pos());</a>
<a name="ln86">            _endText-&gt;setVisible(tl-&gt;visible());</a>
<a name="ln87">            _endText-&gt;draw(painter);</a>
<a name="ln88">            painter-&gt;translate(-_endText-&gt;pos());</a>
<a name="ln89">            }</a>
<a name="ln90"> </a>
<a name="ln91">      if ((npoints == 0) || (score() &amp;&amp; (score()-&gt;printing() || !score()-&gt;showInvisible()) &amp;&amp; !tl-&gt;lineVisible()))</a>
<a name="ln92">            return;</a>
<a name="ln93"> </a>
<a name="ln94">      // color for line (text color comes from the text properties)</a>
<a name="ln95">#if 0</a>
<a name="ln96">      QColor color;</a>
<a name="ln97">      if ((selected() &amp;&amp; !(score() &amp;&amp; score()-&gt;printing())) || !tl-&gt;visible() || !tl-&gt;lineVisible())</a>
<a name="ln98">            color = curColor(tl-&gt;visible() &amp;&amp; tl-&gt;lineVisible());</a>
<a name="ln99">      else</a>
<a name="ln100">            color = tl-&gt;lineColor();</a>
<a name="ln101">#endif</a>
<a name="ln102">      QColor color = curColor(tl-&gt;visible() &amp;&amp; tl-&gt;lineVisible(), tl-&gt;lineColor());</a>
<a name="ln103"> </a>
<a name="ln104">      qreal textlineLineWidth = tl-&gt;lineWidth();</a>
<a name="ln105">      if (staff())</a>
<a name="ln106">            textlineLineWidth *= mag();</a>
<a name="ln107">      QPen pen(color, textlineLineWidth, tl-&gt;lineStyle());</a>
<a name="ln108">      QPen solidPen(color, textlineLineWidth, Qt::SolidLine);</a>
<a name="ln109">      if (tl-&gt;lineStyle() == Qt::CustomDashLine) {</a>
<a name="ln110">            QVector&lt;qreal&gt; dashes { tl-&gt;dashLineLen(), tl-&gt;dashGapLen() };</a>
<a name="ln111">            pen.setDashPattern(dashes);</a>
<a name="ln112">            }</a>
<a name="ln113"> </a>
<a name="ln114">      if (twoLines) {   // hairpins</a>
<a name="ln115">            painter-&gt;setPen(pen);</a>
<a name="ln116">            painter-&gt;drawLines(&amp;points[0], 1);</a>
<a name="ln117">            painter-&gt;drawLines(&amp;points[2], 1);</a>
<a name="ln118">            }</a>
<a name="ln119">      else {</a>
<a name="ln120">            int start = 0;</a>
<a name="ln121">            int end = npoints;</a>
<a name="ln122">            //draw hooks as solid</a>
<a name="ln123">            painter-&gt;setPen(solidPen);</a>
<a name="ln124">            if (tl-&gt;beginHookType() == HookType::HOOK_90T) {</a>
<a name="ln125">                  painter-&gt;drawLines(&amp;points[0], 1);</a>
<a name="ln126">                  start++;</a>
<a name="ln127">                  }</a>
<a name="ln128">            if (tl-&gt;endHookType() == HookType::HOOK_90T) {</a>
<a name="ln129">                  painter-&gt;drawLines(&amp;points[npoints-1], 1);</a>
<a name="ln130">                  end--;</a>
<a name="ln131">                  }</a>
<a name="ln132">            //draw rest of line as regular</a>
<a name="ln133">            //calculate new gap</a>
<a name="ln134">            if (tl-&gt;lineStyle() == Qt::CustomDashLine) {</a>
<a name="ln135">                  qreal adjustedLineLength = lineLength / textlineLineWidth;</a>
<a name="ln136">                  qreal dash = tl-&gt;dashLineLen();</a>
<a name="ln137">                  qreal gap = tl-&gt;dashGapLen();</a>
<a name="ln138">                  int numPairs;</a>
<a name="ln139">                  qreal newGap = 0;</a>
<a name="ln140">                  QVector&lt;qreal&gt; nDashes { dash, newGap };</a>
<a name="ln141">                  if (tl-&gt;beginHookType() == HookType::HOOK_45 || tl-&gt;beginHookType() == HookType::HOOK_90) {</a>
<a name="ln142">                        qreal absD = sqrt(QPointF::dotProduct(points[start+1]-points[start], points[start+1]-points[start])) / textlineLineWidth;</a>
<a name="ln143">                        numPairs = max(qreal(1), absD / (dash + gap));</a>
<a name="ln144">                        nDashes[1] = (absD - dash * (numPairs + 1)) / numPairs;</a>
<a name="ln145">                        pen.setDashPattern(nDashes);</a>
<a name="ln146">                        painter-&gt;setPen(pen);</a>
<a name="ln147">                        painter-&gt;drawLine(points[start+1], points[start]);</a>
<a name="ln148">                        start++;</a>
<a name="ln149">                        }</a>
<a name="ln150">                  if (tl-&gt;endHookType() == HookType::HOOK_45 || tl-&gt;endHookType() == HookType::HOOK_90) {</a>
<a name="ln151">                        qreal absD = sqrt(QPointF::dotProduct(points[end]-points[end-1], points[end]-points[end-1])) / textlineLineWidth;</a>
<a name="ln152">                        numPairs = max(qreal(1), absD / (dash + gap));</a>
<a name="ln153">                        nDashes[1] = (absD - dash * (numPairs + 1)) / numPairs;</a>
<a name="ln154">                        pen.setDashPattern(nDashes);</a>
<a name="ln155">                        painter-&gt;setPen(pen);</a>
<a name="ln156">                        painter-&gt;drawLines(&amp;points[end-1], 1);</a>
<a name="ln157">                        end--;</a>
<a name="ln158">                        }</a>
<a name="ln159">                  numPairs = max(qreal(1), adjustedLineLength / (dash + gap));</a>
<a name="ln160">                  nDashes[1] = (adjustedLineLength - dash * (numPairs + 1)) / numPairs;</a>
<a name="ln161">                  pen.setDashPattern(nDashes);</a>
<a name="ln162">                  }</a>
<a name="ln163">            painter-&gt;setPen(pen);</a>
<a name="ln164">            for (int i = start; i &lt; end; ++i)</a>
<a name="ln165">                  painter-&gt;drawLines(&amp;points[i], 1);</a>
<a name="ln166">            }</a>
<a name="ln167">      }</a>
<a name="ln168"> </a>
<a name="ln169">//---------------------------------------------------------</a>
<a name="ln170">//   shape</a>
<a name="ln171">//---------------------------------------------------------</a>
<a name="ln172"> </a>
<a name="ln173">Shape TextLineBaseSegment::shape() const</a>
<a name="ln174">      {</a>
<a name="ln175">      Shape shape;</a>
<a name="ln176">      if (!_text-&gt;empty())</a>
<a name="ln177">            shape.add(_text-&gt;bbox().translated(_text-&gt;pos()));</a>
<a name="ln178">      if (!_endText-&gt;empty())</a>
<a name="ln179">            shape.add(_endText-&gt;bbox().translated(_endText-&gt;pos()));</a>
<a name="ln180">      qreal lw  = textLineBase()-&gt;lineWidth();</a>
<a name="ln181">      qreal lw2 = lw * .5;</a>
<a name="ln182">      if (twoLines) {   // hairpins</a>
<a name="ln183">            shape.add(QRectF(points[0].x(), points[0].y() - lw2,</a>
<a name="ln184">               points[1].x() - points[0].x(), points[1].y() - points[0].y() + lw));</a>
<a name="ln185">            shape.add(QRectF(points[2].x(), points[2].y() - lw2,</a>
<a name="ln186">               points[3].x() - points[2].x(), points[3].y() - points[2].y() + lw));</a>
<a name="ln187">            }</a>
<a name="ln188">      else if (textLineBase()-&gt;lineVisible()) {</a>
<a name="ln189">            for (int i = 0; i &lt; npoints; ++i) {</a>
<a name="ln190">                  shape.add(QRectF(points[i].x() - lw2, points[i].y() - lw2,</a>
<a name="ln191">                     points[i+1].x() - points[i].x() + lw, points[i+1].y() - points[i].y() + lw));</a>
<a name="ln192">                  }</a>
<a name="ln193">            }</a>
<a name="ln194">      return shape;</a>
<a name="ln195">      }</a>
<a name="ln196"> </a>
<a name="ln197">//---------------------------------------------------------</a>
<a name="ln198">//   layout</a>
<a name="ln199">//---------------------------------------------------------</a>
<a name="ln200"> </a>
<a name="ln201">void TextLineBaseSegment::layout()</a>
<a name="ln202">      {</a>
<a name="ln203">      npoints      = 0;</a>
<a name="ln204">      TextLineBase* tl = textLineBase();</a>
<a name="ln205">      qreal _spatium = tl-&gt;spatium();</a>
<a name="ln206"> </a>
<a name="ln207">      if (spanner()-&gt;placeBelow())</a>
<a name="ln208">            rypos() = staff() ? staff()-&gt;height() : 0.0;</a>
<a name="ln209"> </a>
<a name="ln210">      if (!tl-&gt;diagonal())</a>
<a name="ln211">            _offset2.setY(0);</a>
<a name="ln212"> </a>
<a name="ln213">      switch (spannerSegmentType()) {</a>
<a name="ln214">            case SpannerSegmentType::SINGLE:</a>
<a name="ln215">            case SpannerSegmentType::BEGIN:</a>
<a name="ln216">                  _text-&gt;setXmlText(tl-&gt;beginText());</a>
<a name="ln217">                  _text-&gt;setFamily(tl-&gt;beginFontFamily());</a>
<a name="ln218">                  _text-&gt;setSize(tl-&gt;beginFontSize());</a>
<a name="ln219">                  _text-&gt;setOffset(tl-&gt;beginTextOffset() * mag());</a>
<a name="ln220">                  _text-&gt;setAlign(tl-&gt;beginTextAlign());</a>
<a name="ln221">                  _text-&gt;setBold(tl-&gt;beginFontStyle() &amp; FontStyle::Bold);</a>
<a name="ln222">                  _text-&gt;setItalic(tl-&gt;beginFontStyle() &amp; FontStyle::Italic);</a>
<a name="ln223">                  _text-&gt;setUnderline(tl-&gt;beginFontStyle() &amp; FontStyle::Underline);</a>
<a name="ln224">                  break;</a>
<a name="ln225">            case SpannerSegmentType::MIDDLE:</a>
<a name="ln226">            case SpannerSegmentType::END:</a>
<a name="ln227">                  _text-&gt;setXmlText(tl-&gt;continueText());</a>
<a name="ln228">                  _text-&gt;setFamily(tl-&gt;continueFontFamily());</a>
<a name="ln229">                  _text-&gt;setSize(tl-&gt;continueFontSize());</a>
<a name="ln230">                  _text-&gt;setOffset(tl-&gt;continueTextOffset() * mag());</a>
<a name="ln231">                  _text-&gt;setAlign(tl-&gt;continueTextAlign());</a>
<a name="ln232">                  _text-&gt;setBold(tl-&gt;continueFontStyle() &amp; FontStyle::Bold);</a>
<a name="ln233">                  _text-&gt;setItalic(tl-&gt;continueFontStyle() &amp; FontStyle::Italic);</a>
<a name="ln234">                  _text-&gt;setUnderline(tl-&gt;continueFontStyle() &amp; FontStyle::Underline);</a>
<a name="ln235"> </a>
<a name="ln236">                  break;</a>
<a name="ln237">            }</a>
<a name="ln238">      _text-&gt;setPlacement(Placement::ABOVE);</a>
<a name="ln239">      _text-&gt;setTrack(track());</a>
<a name="ln240">      _text-&gt;layout();</a>
<a name="ln241"> </a>
<a name="ln242">      if ((isSingleType() || isEndType())) {</a>
<a name="ln243">            _endText-&gt;setXmlText(tl-&gt;endText());</a>
<a name="ln244">            _endText-&gt;setFamily(tl-&gt;endFontFamily());</a>
<a name="ln245">            _endText-&gt;setSize(tl-&gt;endFontSize());</a>
<a name="ln246">            _endText-&gt;setOffset(tl-&gt;endTextOffset());</a>
<a name="ln247">            _endText-&gt;setAlign(tl-&gt;endTextAlign());</a>
<a name="ln248">            _endText-&gt;setBold(tl-&gt;endFontStyle() &amp; FontStyle::Bold);</a>
<a name="ln249">            _endText-&gt;setItalic(tl-&gt;endFontStyle() &amp; FontStyle::Italic);</a>
<a name="ln250">            _endText-&gt;setUnderline(tl-&gt;endFontStyle() &amp; FontStyle::Underline);</a>
<a name="ln251">            _endText-&gt;setPlacement(Placement::ABOVE);</a>
<a name="ln252">            _endText-&gt;setTrack(track());</a>
<a name="ln253">            _endText-&gt;layout();</a>
<a name="ln254">            }</a>
<a name="ln255">      else {</a>
<a name="ln256">            _endText-&gt;setXmlText(&quot;&quot;);</a>
<a name="ln257">            }</a>
<a name="ln258"> </a>
<a name="ln259">      QPointF pp1;</a>
<a name="ln260">      QPointF pp2(pos2());</a>
<a name="ln261"> </a>
<a name="ln262">      // diagonal line with no text or hooks - just use the basic rectangle for line</a>
<a name="ln263">      if (_text-&gt;empty() &amp;&amp; _endText-&gt;empty() &amp;&amp; pp2.y() != 0</a>
<a name="ln264">          &amp;&amp; textLineBase()-&gt;beginHookType() == HookType::NONE &amp;&amp; textLineBase()-&gt;beginHookType() == HookType::NONE) {</a>
<a name="ln265">            npoints = 2;</a>
<a name="ln266">            points[0] = pp1;</a>
<a name="ln267">            points[1] = pp2;</a>
<a name="ln268">            lineLength = sqrt(QPointF::dotProduct(pp2-pp1, pp2-pp1));</a>
<a name="ln269"> </a>
<a name="ln270">            setbbox(QRectF(pp1, pp2).normalized());</a>
<a name="ln271">            return;</a>
<a name="ln272">            }</a>
<a name="ln273"> </a>
<a name="ln274">      // line has text or hooks or is not diagonal - calculate reasonable bbox</a>
<a name="ln275"> </a>
<a name="ln276">      qreal x1 = qMin(0.0, pp2.x());</a>
<a name="ln277">      qreal x2 = qMax(0.0, pp2.x());</a>
<a name="ln278">      qreal y0 = -textLineBase()-&gt;lineWidth();</a>
<a name="ln279">      qreal y1 = qMin(0.0, pp2.y()) + y0;</a>
<a name="ln280">      qreal y2 = qMax(0.0, pp2.y()) - y0;</a>
<a name="ln281"> </a>
<a name="ln282">      qreal l = 0.0;</a>
<a name="ln283">      if (!_text-&gt;empty()) {</a>
<a name="ln284">            qreal textlineTextDistance = _spatium * .5;</a>
<a name="ln285">            if (((isSingleType() || isBeginType())</a>
<a name="ln286">               &amp;&amp; (tl-&gt;beginTextPlace() == PlaceText::LEFT || tl-&gt;beginTextPlace() == PlaceText::AUTO))</a>
<a name="ln287">               || ((isMiddleType() || isEndType()) &amp;&amp; (tl-&gt;continueTextPlace() == PlaceText::LEFT))) {</a>
<a name="ln288">                  l = _text-&gt;pos().x() + _text-&gt;bbox().width() + textlineTextDistance;</a>
<a name="ln289">                  }</a>
<a name="ln290">            qreal h = _text-&gt;height();</a>
<a name="ln291">            if (textLineBase()-&gt;beginTextPlace() == PlaceText::ABOVE)</a>
<a name="ln292">                  y1 = qMin(y1, -h);</a>
<a name="ln293">            else if (textLineBase()-&gt;beginTextPlace() == PlaceText::BELOW)</a>
<a name="ln294">                  y2 = qMax(y2, h);</a>
<a name="ln295">            else {</a>
<a name="ln296">                  y1 = qMin(y1, -h * .5);</a>
<a name="ln297">                  y2 = qMax(y2, h * .5);</a>
<a name="ln298">                  }</a>
<a name="ln299">            x2 = qMax(x2, _text-&gt;width());</a>
<a name="ln300">            }</a>
<a name="ln301"> </a>
<a name="ln302">      if (textLineBase()-&gt;endHookType() != HookType::NONE) {</a>
<a name="ln303">            qreal h = pp2.y() + textLineBase()-&gt;endHookHeight().val() * _spatium;</a>
<a name="ln304">            if (h &gt; y2)</a>
<a name="ln305">                  y2 = h;</a>
<a name="ln306">            else if (h &lt; y1)</a>
<a name="ln307">                  y1 = h;</a>
<a name="ln308">            }</a>
<a name="ln309"> </a>
<a name="ln310">      if (textLineBase()-&gt;beginHookType() != HookType::NONE) {</a>
<a name="ln311">            qreal h = textLineBase()-&gt;beginHookHeight().val() * _spatium;</a>
<a name="ln312">            if (h &gt; y2)</a>
<a name="ln313">                  y2 = h;</a>
<a name="ln314">            else if (h &lt; y1)</a>
<a name="ln315">                  y1 = h;</a>
<a name="ln316">            }</a>
<a name="ln317">      bbox().setRect(x1, y1, x2 - x1, y2 - y1);</a>
<a name="ln318">      if (!_text-&gt;empty())</a>
<a name="ln319">            bbox() |= _text-&gt;bbox().translated(_text-&gt;pos());  // DEBUG</a>
<a name="ln320">      // set end text position and extend bbox</a>
<a name="ln321">      if (!_endText-&gt;empty()) {</a>
<a name="ln322">            _endText-&gt;setPos(bbox().right(), 0);</a>
<a name="ln323">            bbox() |= _endText-&gt;bbox().translated(_endText-&gt;pos());</a>
<a name="ln324">            }</a>
<a name="ln325"> </a>
<a name="ln326">      if (!(tl-&gt;lineVisible() || score()-&gt;showInvisible()))</a>
<a name="ln327">            return;</a>
<a name="ln328"> </a>
<a name="ln329">      if (tl-&gt;lineVisible() || !score()-&gt;printing()) {</a>
<a name="ln330">            pp1 = QPointF(l, 0.0);</a>
<a name="ln331"> </a>
<a name="ln332">            qreal beginHookWidth;</a>
<a name="ln333">            qreal endHookWidth;</a>
<a name="ln334"> </a>
<a name="ln335">            if (tl-&gt;beginHookType() == HookType::HOOK_45) {</a>
<a name="ln336">                  beginHookWidth = fabs(tl-&gt;beginHookHeight().val() * _spatium * .4);</a>
<a name="ln337">                  pp1.rx() += beginHookWidth;</a>
<a name="ln338">                  }</a>
<a name="ln339">            else</a>
<a name="ln340">                  beginHookWidth = 0;</a>
<a name="ln341"> </a>
<a name="ln342">            if (tl-&gt;endHookType() == HookType::HOOK_45) {</a>
<a name="ln343">                  endHookWidth = fabs(tl-&gt;endHookHeight().val() * _spatium * .4);</a>
<a name="ln344">                  pp2.rx() -= endHookWidth;</a>
<a name="ln345">                  }</a>
<a name="ln346">            else</a>
<a name="ln347">                  endHookWidth = 0;</a>
<a name="ln348"> </a>
<a name="ln349">            // don't draw backwards lines (or hooks) if text is longer than nominal line length</a>
<a name="ln350">            bool backwards = !_text-&gt;empty() &amp;&amp; pp1.x() &gt; pp2.x() &amp;&amp; !tl-&gt;diagonal();</a>
<a name="ln351"> </a>
<a name="ln352">            if ((tl-&gt;beginHookType() != HookType::NONE) &amp;&amp; (isSingleType() || isBeginType())) {</a>
<a name="ln353">                  qreal hh = tl-&gt;beginHookHeight().val() * _spatium;</a>
<a name="ln354">                  if (tl-&gt;beginHookType() == HookType::HOOK_90T)</a>
<a name="ln355">                        points[npoints++] = QPointF(pp1.x() - beginHookWidth, pp1.y() - hh);</a>
<a name="ln356">                  points[npoints] = QPointF(pp1.x() - beginHookWidth, pp1.y() + hh);</a>
<a name="ln357">                  ++npoints;</a>
<a name="ln358">                  points[npoints] = pp1;</a>
<a name="ln359">                  }</a>
<a name="ln360">            if (!backwards) {</a>
<a name="ln361">                  points[npoints] = pp1;</a>
<a name="ln362">                  ++npoints;</a>
<a name="ln363">                  points[npoints] = pp2;</a>
<a name="ln364">                  lineLength = sqrt(QPointF::dotProduct(pp2-pp1, pp2-pp1));</a>
<a name="ln365">                  // painter-&gt;drawLine(QLineF(pp1.x(), pp1.y(), pp2.x(), pp2.y()));</a>
<a name="ln366"> </a>
<a name="ln367">                  if ((tl-&gt;endHookType() != HookType::NONE) &amp;&amp; (isSingleType() || isEndType())) {</a>
<a name="ln368">                        ++npoints;</a>
<a name="ln369">                        qreal hh = tl-&gt;endHookHeight().val() * _spatium;</a>
<a name="ln370">                        // painter-&gt;drawLine(QLineF(pp2.x(), pp2.y(), pp2.x() + endHookWidth, pp2.y() + hh));</a>
<a name="ln371">                        points[npoints] = QPointF(pp2.x() + endHookWidth, pp2.y() + hh);</a>
<a name="ln372">                        if (tl-&gt;endHookType() == HookType::HOOK_90T)</a>
<a name="ln373">                              points[++npoints] = QPointF(pp2.x() + endHookWidth, pp2.y() - hh);</a>
<a name="ln374">                        }</a>
<a name="ln375">                  }</a>
<a name="ln376">            }</a>
<a name="ln377">      }</a>
<a name="ln378"> </a>
<a name="ln379">//---------------------------------------------------------</a>
<a name="ln380">//   spatiumChanged</a>
<a name="ln381">//---------------------------------------------------------</a>
<a name="ln382"> </a>
<a name="ln383">void TextLineBaseSegment::spatiumChanged(qreal ov, qreal nv)</a>
<a name="ln384">      {</a>
<a name="ln385">      LineSegment::spatiumChanged(ov, nv);</a>
<a name="ln386"> </a>
<a name="ln387">      textLineBase()-&gt;spatiumChanged(ov, nv);</a>
<a name="ln388">      _text-&gt;spatiumChanged(ov, nv);</a>
<a name="ln389">      _endText-&gt;spatiumChanged(ov, nv);</a>
<a name="ln390">      }</a>
<a name="ln391"> </a>
<a name="ln392">static constexpr std::array&lt;Pid, 26&gt; pids = { {</a>
<a name="ln393">      Pid::LINE_VISIBLE,</a>
<a name="ln394">      Pid::BEGIN_HOOK_TYPE,</a>
<a name="ln395">      Pid::BEGIN_HOOK_HEIGHT,</a>
<a name="ln396">      Pid::END_HOOK_TYPE,</a>
<a name="ln397">      Pid::END_HOOK_HEIGHT,</a>
<a name="ln398">      Pid::BEGIN_TEXT,</a>
<a name="ln399">      Pid::BEGIN_TEXT_ALIGN,</a>
<a name="ln400">      Pid::BEGIN_TEXT_PLACE,</a>
<a name="ln401">      Pid::BEGIN_FONT_FACE,</a>
<a name="ln402">      Pid::BEGIN_FONT_SIZE,</a>
<a name="ln403">      Pid::BEGIN_FONT_STYLE,</a>
<a name="ln404">      Pid::BEGIN_TEXT_OFFSET,</a>
<a name="ln405">      Pid::CONTINUE_TEXT,</a>
<a name="ln406">      Pid::CONTINUE_TEXT_ALIGN,</a>
<a name="ln407">      Pid::CONTINUE_TEXT_PLACE,</a>
<a name="ln408">      Pid::CONTINUE_FONT_FACE,</a>
<a name="ln409">      Pid::CONTINUE_FONT_SIZE,</a>
<a name="ln410">      Pid::CONTINUE_FONT_STYLE,</a>
<a name="ln411">      Pid::CONTINUE_TEXT_OFFSET,</a>
<a name="ln412">      Pid::END_TEXT,</a>
<a name="ln413">      Pid::END_TEXT_ALIGN,</a>
<a name="ln414">      Pid::END_TEXT_PLACE,</a>
<a name="ln415">      Pid::END_FONT_FACE,</a>
<a name="ln416">      Pid::END_FONT_SIZE,</a>
<a name="ln417">      Pid::END_FONT_STYLE,</a>
<a name="ln418">      Pid::END_TEXT_OFFSET,</a>
<a name="ln419">      } };</a>
<a name="ln420"> </a>
<a name="ln421">//---------------------------------------------------------</a>
<a name="ln422">//   propertyDelegate</a>
<a name="ln423">//---------------------------------------------------------</a>
<a name="ln424"> </a>
<a name="ln425">Element* TextLineBaseSegment::propertyDelegate(Pid pid)</a>
<a name="ln426">      {</a>
<a name="ln427">      for (Pid id : pids) {</a>
<a name="ln428">            if (pid == id)</a>
<a name="ln429">                  return spanner();</a>
<a name="ln430">            }</a>
<a name="ln431">      return LineSegment::propertyDelegate(pid);</a>
<a name="ln432">      }</a>
<a name="ln433"> </a>
<a name="ln434">//---------------------------------------------------------</a>
<a name="ln435">//   TextLineBase</a>
<a name="ln436">//---------------------------------------------------------</a>
<a name="ln437"> </a>
<a name="ln438">TextLineBase::TextLineBase(Score* s, ElementFlags f)</a>
<a name="ln439">   : SLine(s, f)</a>
<a name="ln440">      {</a>
<a name="ln441">      setBeginHookHeight(Spatium(1.9));</a>
<a name="ln442">      setEndHookHeight(Spatium(1.9));</a>
<a name="ln443">      }</a>
<a name="ln444"> </a>
<a name="ln445">//---------------------------------------------------------</a>
<a name="ln446">//   write</a>
<a name="ln447">//---------------------------------------------------------</a>
<a name="ln448"> </a>
<a name="ln449">void TextLineBase::write(XmlWriter&amp; xml) const</a>
<a name="ln450">      {</a>
<a name="ln451">      if (!xml.canWrite(this))</a>
<a name="ln452">            return;</a>
<a name="ln453">      xml.stag(this);</a>
<a name="ln454">      writeProperties(xml);</a>
<a name="ln455">      xml.etag();</a>
<a name="ln456">      }</a>
<a name="ln457"> </a>
<a name="ln458">//---------------------------------------------------------</a>
<a name="ln459">//   read</a>
<a name="ln460">//---------------------------------------------------------</a>
<a name="ln461"> </a>
<a name="ln462">void TextLineBase::read(XmlReader&amp; e)</a>
<a name="ln463">      {</a>
<a name="ln464">      eraseSpannerSegments();</a>
<a name="ln465"> </a>
<a name="ln466">      if (score()-&gt;mscVersion() &lt; 301)</a>
<a name="ln467">            e.addSpanner(e.intAttribute(&quot;id&quot;, -1), this);</a>
<a name="ln468"> </a>
<a name="ln469">      while (e.readNextStartElement()) {</a>
<a name="ln470">            if (!readProperties(e))</a>
<a name="ln471">                  e.unknown();</a>
<a name="ln472">            }</a>
<a name="ln473">      }</a>
<a name="ln474"> </a>
<a name="ln475">//---------------------------------------------------------</a>
<a name="ln476">//   spatiumChanged</a>
<a name="ln477">//---------------------------------------------------------</a>
<a name="ln478"> </a>
<a name="ln479">void TextLineBase::spatiumChanged(qreal /*ov*/, qreal /*nv*/)</a>
<a name="ln480">      {</a>
<a name="ln481">      }</a>
<a name="ln482"> </a>
<a name="ln483">//---------------------------------------------------------</a>
<a name="ln484">//   writeProperties</a>
<a name="ln485">//    write properties different from prototype</a>
<a name="ln486">//---------------------------------------------------------</a>
<a name="ln487"> </a>
<a name="ln488">void TextLineBase::writeProperties(XmlWriter&amp; xml) const</a>
<a name="ln489">      {</a>
<a name="ln490">      for (Pid pid : pids) {</a>
<a name="ln491">            if (!isStyled(pid)) </a>
<a name="ln492">                  writeProperty(xml, pid);</a>
<a name="ln493">            }</a>
<a name="ln494">      SLine::writeProperties(xml);</a>
<a name="ln495">      }</a>
<a name="ln496"> </a>
<a name="ln497">//---------------------------------------------------------</a>
<a name="ln498">//   readProperties</a>
<a name="ln499">//---------------------------------------------------------</a>
<a name="ln500"> </a>
<a name="ln501">bool TextLineBase::readProperties(XmlReader&amp; e)</a>
<a name="ln502">      {</a>
<a name="ln503">      const QStringRef&amp; tag(e.name());</a>
<a name="ln504">      for (Pid i : pids) {</a>
<a name="ln505">            if (readProperty(tag, e, i)) {</a>
<a name="ln506">                  setPropertyFlags(i, PropertyFlags::UNSTYLED);</a>
<a name="ln507">                  return true;</a>
<a name="ln508">                  }</a>
<a name="ln509">            }</a>
<a name="ln510">      return SLine::readProperties(e);</a>
<a name="ln511">      }</a>
<a name="ln512"> </a>
<a name="ln513">//---------------------------------------------------------</a>
<a name="ln514">//   TextLineBase::propertyId</a>
<a name="ln515">//---------------------------------------------------------</a>
<a name="ln516"> </a>
<a name="ln517">Pid TextLineBase::propertyId(const QStringRef&amp; name) const</a>
<a name="ln518">      {</a>
<a name="ln519">      for (Pid pid : pids) {</a>
<a name="ln520">            if (propertyName(pid) == name)</a>
<a name="ln521">                  return pid;</a>
<a name="ln522">            }</a>
<a name="ln523">      return SLine::propertyId(name);</a>
<a name="ln524">      }</a>
<a name="ln525"> </a>
<a name="ln526">//---------------------------------------------------------</a>
<a name="ln527">//   getProperty</a>
<a name="ln528">//---------------------------------------------------------</a>
<a name="ln529"> </a>
<a name="ln530">QVariant TextLineBase::getProperty(Pid id) const</a>
<a name="ln531">      {</a>
<a name="ln532">      switch (id) {</a>
<a name="ln533">            case Pid::BEGIN_TEXT:</a>
<a name="ln534">                  return beginText();</a>
<a name="ln535">            case Pid::BEGIN_TEXT_ALIGN:</a>
<a name="ln536">                  return QVariant::fromValue(beginTextAlign());</a>
<a name="ln537">            case Pid::CONTINUE_TEXT_ALIGN:</a>
<a name="ln538">                  return QVariant::fromValue(continueTextAlign());</a>
<a name="ln539">            case Pid::END_TEXT_ALIGN:</a>
<a name="ln540">                  return QVariant::fromValue(endTextAlign());</a>
<a name="ln541">            case Pid::BEGIN_TEXT_PLACE:</a>
<a name="ln542">                  return int(_beginTextPlace);</a>
<a name="ln543">            case Pid::BEGIN_HOOK_TYPE:</a>
<a name="ln544">                  return int(_beginHookType);</a>
<a name="ln545">            case Pid::BEGIN_HOOK_HEIGHT:</a>
<a name="ln546">                  return _beginHookHeight;</a>
<a name="ln547">            case Pid::BEGIN_FONT_FACE:</a>
<a name="ln548">                  return _beginFontFamily;</a>
<a name="ln549">            case Pid::BEGIN_FONT_SIZE:</a>
<a name="ln550">                  return _beginFontSize;</a>
<a name="ln551">            case Pid::BEGIN_FONT_STYLE:</a>
<a name="ln552">                  return int(_beginFontStyle);</a>
<a name="ln553">            case Pid::BEGIN_TEXT_OFFSET:</a>
<a name="ln554">                  return _beginTextOffset;</a>
<a name="ln555">            case Pid::CONTINUE_TEXT:</a>
<a name="ln556">                  return continueText();</a>
<a name="ln557">            case Pid::CONTINUE_TEXT_PLACE:</a>
<a name="ln558">                  return int(_continueTextPlace);</a>
<a name="ln559">            case Pid::CONTINUE_FONT_FACE:</a>
<a name="ln560">                  return _continueFontFamily;</a>
<a name="ln561">            case Pid::CONTINUE_FONT_SIZE:</a>
<a name="ln562">                  return _continueFontSize;</a>
<a name="ln563">            case Pid::CONTINUE_FONT_STYLE:</a>
<a name="ln564">                  return int(_continueFontStyle);</a>
<a name="ln565">            case Pid::CONTINUE_TEXT_OFFSET:</a>
<a name="ln566">                  return _continueTextOffset;</a>
<a name="ln567">            case Pid::END_TEXT:</a>
<a name="ln568">                  return endText();</a>
<a name="ln569">            case Pid::END_TEXT_PLACE:</a>
<a name="ln570">                  return int(_endTextPlace);</a>
<a name="ln571">            case Pid::END_HOOK_TYPE:</a>
<a name="ln572">                  return int(_endHookType);</a>
<a name="ln573">            case Pid::END_HOOK_HEIGHT:</a>
<a name="ln574">                  return _endHookHeight;</a>
<a name="ln575">            case Pid::END_FONT_FACE:</a>
<a name="ln576">                  return _endFontFamily;</a>
<a name="ln577">            case Pid::END_FONT_SIZE:</a>
<a name="ln578">                  return _endFontSize;</a>
<a name="ln579">            case Pid::END_FONT_STYLE:</a>
<a name="ln580">                  return int(_endFontStyle);</a>
<a name="ln581">            case Pid::END_TEXT_OFFSET:</a>
<a name="ln582">                  return _endTextOffset;</a>
<a name="ln583">            case Pid::LINE_VISIBLE:</a>
<a name="ln584">                  return lineVisible();</a>
<a name="ln585">            default:</a>
<a name="ln586">                  return SLine::getProperty(id);</a>
<a name="ln587">            }</a>
<a name="ln588">      }</a>
<a name="ln589"> </a>
<a name="ln590">//---------------------------------------------------------</a>
<a name="ln591">//   setProperty</a>
<a name="ln592">//---------------------------------------------------------</a>
<a name="ln593"> </a>
<a name="ln594">bool TextLineBase::setProperty(Pid id, const QVariant&amp; v)</a>
<a name="ln595">      {</a>
<a name="ln596">      switch (id) {</a>
<a name="ln597">            case Pid::BEGIN_TEXT_PLACE:</a>
<a name="ln598">                  _beginTextPlace = PlaceText(v.toInt());</a>
<a name="ln599">                  break;</a>
<a name="ln600">            case Pid::BEGIN_TEXT_ALIGN:</a>
<a name="ln601">                  _beginTextAlign = v.value&lt;Align&gt;();</a>
<a name="ln602">                  break;</a>
<a name="ln603">            case Pid::CONTINUE_TEXT_ALIGN:</a>
<a name="ln604">                  _continueTextAlign = v.value&lt;Align&gt;();</a>
<a name="ln605">                  break;</a>
<a name="ln606">            case Pid::END_TEXT_ALIGN:</a>
<a name="ln607">                  _endTextAlign = v.value&lt;Align&gt;();</a>
<a name="ln608">                  break;</a>
<a name="ln609">            case Pid::CONTINUE_TEXT_PLACE:</a>
<a name="ln610">                  _continueTextPlace = PlaceText(v.toInt());</a>
<a name="ln611">                  break;</a>
<a name="ln612">            case Pid::END_TEXT_PLACE:</a>
<a name="ln613">                  _endTextPlace = PlaceText(v.toInt());</a>
<a name="ln614">                  break;</a>
<a name="ln615">            case Pid::BEGIN_HOOK_HEIGHT:</a>
<a name="ln616">                  _beginHookHeight = v.value&lt;Spatium&gt;();</a>
<a name="ln617">                  break;</a>
<a name="ln618">            case Pid::END_HOOK_HEIGHT:</a>
<a name="ln619">                  _endHookHeight = v.value&lt;Spatium&gt;();</a>
<a name="ln620">                  break;</a>
<a name="ln621">            case Pid::BEGIN_HOOK_TYPE:</a>
<a name="ln622">                  _beginHookType = HookType(v.toInt());</a>
<a name="ln623">                  break;</a>
<a name="ln624">            case Pid::END_HOOK_TYPE:</a>
<a name="ln625">                  _endHookType = HookType(v.toInt());</a>
<a name="ln626">                  break;</a>
<a name="ln627">            case Pid::BEGIN_TEXT:</a>
<a name="ln628">                  setBeginText(v.toString());</a>
<a name="ln629">                  break;</a>
<a name="ln630">            case Pid::BEGIN_TEXT_OFFSET:</a>
<a name="ln631">                  setBeginTextOffset(v.toPointF());</a>
<a name="ln632">                  break;</a>
<a name="ln633">            case Pid::CONTINUE_TEXT_OFFSET:</a>
<a name="ln634">                  setContinueTextOffset(v.toPointF());</a>
<a name="ln635">                  break;</a>
<a name="ln636">            case Pid::END_TEXT_OFFSET:</a>
<a name="ln637">                  setEndTextOffset(v.toPointF());</a>
<a name="ln638">                  break;</a>
<a name="ln639">            case Pid::CONTINUE_TEXT:</a>
<a name="ln640">                  setContinueText(v.toString());</a>
<a name="ln641">                  break;</a>
<a name="ln642">            case Pid::END_TEXT:</a>
<a name="ln643">                  setEndText(v.toString());</a>
<a name="ln644">                  break;</a>
<a name="ln645">            case Pid::LINE_VISIBLE:</a>
<a name="ln646">                  setLineVisible(v.toBool());</a>
<a name="ln647">                  break;</a>
<a name="ln648">            case Pid::BEGIN_FONT_FACE:</a>
<a name="ln649">                  setBeginFontFamily(v.toString());</a>
<a name="ln650">                  break;</a>
<a name="ln651">            case Pid::BEGIN_FONT_SIZE:</a>
<a name="ln652">                  if (v.toReal() &lt;= 0)</a>
<a name="ln653">                        qFatal(&quot;font size is %f&quot;, v.toReal());</a>
<a name="ln654">                  setBeginFontSize(v.toReal());</a>
<a name="ln655">                  break;</a>
<a name="ln656">            case Pid::BEGIN_FONT_STYLE:</a>
<a name="ln657">                  setBeginFontStyle(FontStyle(v.toInt()));</a>
<a name="ln658">                  break;</a>
<a name="ln659">            case Pid::CONTINUE_FONT_FACE:</a>
<a name="ln660">                  setContinueFontFamily(v.toString());</a>
<a name="ln661">                  break;</a>
<a name="ln662">            case Pid::CONTINUE_FONT_SIZE:</a>
<a name="ln663">                  setContinueFontSize(v.toReal());</a>
<a name="ln664">                  break;</a>
<a name="ln665">            case Pid::CONTINUE_FONT_STYLE:</a>
<a name="ln666">                  setContinueFontStyle(FontStyle(v.toInt()));</a>
<a name="ln667">                  break;</a>
<a name="ln668">            case Pid::END_FONT_FACE:</a>
<a name="ln669">                  setEndFontFamily(v.toString());</a>
<a name="ln670">                  break;</a>
<a name="ln671">            case Pid::END_FONT_SIZE:</a>
<a name="ln672">                  setEndFontSize(v.toReal());</a>
<a name="ln673">                  break;</a>
<a name="ln674">            case Pid::END_FONT_STYLE:</a>
<a name="ln675">                  setEndFontStyle(FontStyle(v.toInt()));</a>
<a name="ln676">                  break;</a>
<a name="ln677">            default:</a>
<a name="ln678">                  return SLine::setProperty(id, v);</a>
<a name="ln679">            }</a>
<a name="ln680">      triggerLayout();</a>
<a name="ln681">      return true;</a>
<a name="ln682">      }</a>
<a name="ln683"> </a>
<a name="ln684"> }</a>
<a name="ln685"> </a>

</code></pre>
<div class="balloon" rel="263"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v501/" target="_blank">V501</a> There are identical sub-expressions 'textLineBase()->beginHookType() == HookType::NONE' to the left and to the right of the '&&' operator.</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
