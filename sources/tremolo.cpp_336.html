
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>tremolo.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2011 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;tremolo.h&quot;</a>
<a name="ln14">#include &quot;score.h&quot;</a>
<a name="ln15">#include &quot;style.h&quot;</a>
<a name="ln16">#include &quot;chord.h&quot;</a>
<a name="ln17">#include &quot;note.h&quot;</a>
<a name="ln18">#include &quot;measure.h&quot;</a>
<a name="ln19">#include &quot;segment.h&quot;</a>
<a name="ln20">#include &quot;stem.h&quot;</a>
<a name="ln21">#include &quot;sym.h&quot;</a>
<a name="ln22">#include &quot;xml.h&quot;</a>
<a name="ln23"> </a>
<a name="ln24">namespace Ms {</a>
<a name="ln25"> </a>
<a name="ln26">//---------------------------------------------------------</a>
<a name="ln27">//   tremoloStyle</a>
<a name="ln28">//---------------------------------------------------------</a>
<a name="ln29"> </a>
<a name="ln30">static const ElementStyle tremoloStyle {</a>
<a name="ln31">      { Sid::tremoloPlacement, Pid::TREMOLO_PLACEMENT },</a>
<a name="ln32">      };</a>
<a name="ln33"> </a>
<a name="ln34">//---------------------------------------------------------</a>
<a name="ln35">//   Tremolo</a>
<a name="ln36">//---------------------------------------------------------</a>
<a name="ln37"> </a>
<a name="ln38">static const char* tremoloName[] = {</a>
<a name="ln39">      QT_TRANSLATE_NOOP(&quot;Tremolo&quot;, &quot;Eighth through stem&quot;),</a>
<a name="ln40">      QT_TRANSLATE_NOOP(&quot;Tremolo&quot;, &quot;16th through stem&quot;),</a>
<a name="ln41">      QT_TRANSLATE_NOOP(&quot;Tremolo&quot;, &quot;32nd through stem&quot;),</a>
<a name="ln42">      QT_TRANSLATE_NOOP(&quot;Tremolo&quot;, &quot;64th through stem&quot;),</a>
<a name="ln43">      QT_TRANSLATE_NOOP(&quot;Tremolo&quot;, &quot;Buzz roll&quot;),</a>
<a name="ln44">      QT_TRANSLATE_NOOP(&quot;Tremolo&quot;, &quot;Eighth between notes&quot;),</a>
<a name="ln45">      QT_TRANSLATE_NOOP(&quot;Tremolo&quot;, &quot;16th between notes&quot;),</a>
<a name="ln46">      QT_TRANSLATE_NOOP(&quot;Tremolo&quot;, &quot;32nd between notes&quot;),</a>
<a name="ln47">      QT_TRANSLATE_NOOP(&quot;Tremolo&quot;, &quot;64th between notes&quot;)</a>
<a name="ln48">      };</a>
<a name="ln49"> </a>
<a name="ln50">Tremolo::Tremolo(Score* score)</a>
<a name="ln51">   : Element(score, ElementFlag::MOVABLE)</a>
<a name="ln52">      {</a>
<a name="ln53">      initElementStyle(&amp;tremoloStyle);</a>
<a name="ln54">      setTremoloType(TremoloType::R8);</a>
<a name="ln55">      _chord1  = 0;</a>
<a name="ln56">      _chord2  = 0;</a>
<a name="ln57">      }</a>
<a name="ln58"> </a>
<a name="ln59">Tremolo::Tremolo(const Tremolo&amp; t)</a>
<a name="ln60">   : Element(t)</a>
<a name="ln61">      {</a>
<a name="ln62">      setTremoloType(t.tremoloType());</a>
<a name="ln63">      _chord1  = t.chord1();</a>
<a name="ln64">      _chord2  = t.chord2();</a>
<a name="ln65">      _durationType = t._durationType;</a>
<a name="ln66">      }</a>
<a name="ln67"> </a>
<a name="ln68">//---------------------------------------------------------</a>
<a name="ln69">//   mag</a>
<a name="ln70">//---------------------------------------------------------</a>
<a name="ln71"> </a>
<a name="ln72">qreal Tremolo::mag() const</a>
<a name="ln73">      {</a>
<a name="ln74">      return parent() ? parent()-&gt;mag() : 1.0;</a>
<a name="ln75">      }</a>
<a name="ln76"> </a>
<a name="ln77">//---------------------------------------------------------</a>
<a name="ln78">//   draw</a>
<a name="ln79">//---------------------------------------------------------</a>
<a name="ln80"> </a>
<a name="ln81">void Tremolo::draw(QPainter* painter) const</a>
<a name="ln82">      {</a>
<a name="ln83">      if (tremoloType() == TremoloType::BUZZ_ROLL) {</a>
<a name="ln84">            painter-&gt;setPen(curColor());</a>
<a name="ln85">            drawSymbol(SymId::buzzRoll, painter);</a>
<a name="ln86">            }</a>
<a name="ln87">      else {</a>
<a name="ln88">            painter-&gt;setBrush(QBrush(curColor()));</a>
<a name="ln89">            painter-&gt;setPen(Qt::NoPen);</a>
<a name="ln90">            painter-&gt;drawPath(path);</a>
<a name="ln91">            }</a>
<a name="ln92">      if ((parent() == 0) &amp;&amp; !twoNotes()) {</a>
<a name="ln93">            qreal x = 0.0; // bbox().width() * .25;</a>
<a name="ln94">            QPen pen(curColor(), point(score()-&gt;styleS(Sid::stemWidth)));</a>
<a name="ln95">            painter-&gt;setPen(pen);</a>
<a name="ln96">            const qreal _spatium = spatium();</a>
<a name="ln97">            if (_tremoloType == TremoloType::BUZZ_ROLL)</a>
<a name="ln98">                  painter-&gt;drawLine(QLineF(x, -_spatium, x, bbox().bottom() + _spatium));</a>
<a name="ln99">            else</a>
<a name="ln100">                  painter-&gt;drawLine(QLineF(x, -_spatium*.5, x, path.boundingRect().height() + _spatium));</a>
<a name="ln101">            }</a>
<a name="ln102">      }</a>
<a name="ln103"> </a>
<a name="ln104">//---------------------------------------------------------</a>
<a name="ln105">//   setTremoloType</a>
<a name="ln106">//---------------------------------------------------------</a>
<a name="ln107"> </a>
<a name="ln108">void Tremolo::setTremoloType(TremoloType t)</a>
<a name="ln109">      {</a>
<a name="ln110">      _tremoloType = t;</a>
<a name="ln111">      switch (tremoloType()) {</a>
<a name="ln112">            case TremoloType::R16:</a>
<a name="ln113">            case TremoloType::C16:</a>
<a name="ln114">                  _lines = 2;</a>
<a name="ln115">                  break;</a>
<a name="ln116">            case TremoloType::R32:</a>
<a name="ln117">            case TremoloType::C32:</a>
<a name="ln118">                  _lines = 3;</a>
<a name="ln119">                  break;</a>
<a name="ln120">            case TremoloType::R64:</a>
<a name="ln121">            case TremoloType::C64:</a>
<a name="ln122">                  _lines = 4;</a>
<a name="ln123">                  break;</a>
<a name="ln124">            default:</a>
<a name="ln125">                  _lines = 1;</a>
<a name="ln126">                  break;</a>
<a name="ln127">            }</a>
<a name="ln128">      computeShape();</a>
<a name="ln129">      }</a>
<a name="ln130"> </a>
<a name="ln131">//---------------------------------------------------------</a>
<a name="ln132">//   placeMidStem</a>
<a name="ln133">///   For one-note tremolo, whether the tremolo should be</a>
<a name="ln134">///   placed at stem middle.</a>
<a name="ln135">//---------------------------------------------------------</a>
<a name="ln136"> </a>
<a name="ln137">bool Tremolo::placeMidStem() const</a>
<a name="ln138">      {</a>
<a name="ln139">      return _tremoloPlacement == TremoloPlacement::STEM_CENTER;</a>
<a name="ln140">      }</a>
<a name="ln141"> </a>
<a name="ln142">//---------------------------------------------------------</a>
<a name="ln143">//   spatiumChanged</a>
<a name="ln144">//---------------------------------------------------------</a>
<a name="ln145"> </a>
<a name="ln146">void Tremolo::spatiumChanged(qreal oldValue, qreal newValue)</a>
<a name="ln147">      {</a>
<a name="ln148">      Element::spatiumChanged(oldValue, newValue);</a>
<a name="ln149">      computeShape();</a>
<a name="ln150">      }</a>
<a name="ln151"> </a>
<a name="ln152">//---------------------------------------------------------</a>
<a name="ln153">//   localSpatiumChanged</a>
<a name="ln154">//    the scale of a staff changed</a>
<a name="ln155">//---------------------------------------------------------</a>
<a name="ln156"> </a>
<a name="ln157">void Tremolo::localSpatiumChanged(qreal oldValue, qreal newValue)</a>
<a name="ln158">      {</a>
<a name="ln159">      Element::localSpatiumChanged(oldValue, newValue);</a>
<a name="ln160">      computeShape();</a>
<a name="ln161">      }</a>
<a name="ln162"> </a>
<a name="ln163">//---------------------------------------------------------</a>
<a name="ln164">//   styleChanged</a>
<a name="ln165">//    the scale of a staff changed</a>
<a name="ln166">//---------------------------------------------------------</a>
<a name="ln167"> </a>
<a name="ln168">void Tremolo::styleChanged()</a>
<a name="ln169">      {</a>
<a name="ln170">      Element::styleChanged();</a>
<a name="ln171">      computeShape();</a>
<a name="ln172">      }</a>
<a name="ln173"> </a>
<a name="ln174">//---------------------------------------------------------</a>
<a name="ln175">//   basePath</a>
<a name="ln176">//---------------------------------------------------------</a>
<a name="ln177"> </a>
<a name="ln178">QPainterPath Tremolo::basePath() const</a>
<a name="ln179">      {</a>
<a name="ln180">      if (_tremoloType == TremoloType::BUZZ_ROLL)</a>
<a name="ln181">            return QPainterPath();</a>
<a name="ln182"> </a>
<a name="ln183">      const qreal _spatium  = spatium();</a>
<a name="ln184"> </a>
<a name="ln185">      qreal w2  = _spatium * score()-&gt;styleS(Sid::tremoloWidth).val() * .5;</a>
<a name="ln186">      qreal lw  = _spatium * score()-&gt;styleS(Sid::tremoloStrokeWidth).val();</a>
<a name="ln187">      qreal td  = _spatium * score()-&gt;styleS(Sid::tremoloDistance).val();</a>
<a name="ln188"> </a>
<a name="ln189">      QPainterPath ppath;</a>
<a name="ln190">      qreal ty  = 0.0;</a>
<a name="ln191"> </a>
<a name="ln192">      for (int i = 0; i &lt; _lines; i++) {</a>
<a name="ln193">            ppath.addRect(-w2, ty, 2.0 * w2, lw);</a>
<a name="ln194">            ty += td;</a>
<a name="ln195">            }</a>
<a name="ln196"> </a>
<a name="ln197">      if (!parent()) {</a>
<a name="ln198">            // just for the palette</a>
<a name="ln199">            QTransform shearTransform;</a>
<a name="ln200">            shearTransform.shear(0.0, -(lw / 2.0) / w2);</a>
<a name="ln201">            ppath = shearTransform.map(ppath);</a>
<a name="ln202">            }</a>
<a name="ln203">      else if (!twoNotes()) {</a>
<a name="ln204">            QTransform shearTransform;</a>
<a name="ln205">            shearTransform.shear(0.0, -(lw / 2.0) / w2);</a>
<a name="ln206">            ppath = shearTransform.map(ppath);</a>
<a name="ln207">            }</a>
<a name="ln208"> </a>
<a name="ln209">      return ppath;</a>
<a name="ln210">      }</a>
<a name="ln211"> </a>
<a name="ln212">//---------------------------------------------------------</a>
<a name="ln213">//   computeShape</a>
<a name="ln214">//---------------------------------------------------------</a>
<a name="ln215"> </a>
<a name="ln216">void Tremolo::computeShape()</a>
<a name="ln217">      {</a>
<a name="ln218">      if (parent() &amp;&amp; twoNotes())</a>
<a name="ln219">            return; // cannot compute shape here, should be done at layout stage</a>
<a name="ln220"> </a>
<a name="ln221">      if (_tremoloType == TremoloType::BUZZ_ROLL)</a>
<a name="ln222">            setbbox(symBbox(SymId::buzzRoll));</a>
<a name="ln223">      else {</a>
<a name="ln224">            path = basePath();</a>
<a name="ln225">            setbbox(path.boundingRect());</a>
<a name="ln226">            }</a>
<a name="ln227">      }</a>
<a name="ln228"> </a>
<a name="ln229">//---------------------------------------------------------</a>
<a name="ln230">//   layoutOneNoteTremolo</a>
<a name="ln231">//---------------------------------------------------------</a>
<a name="ln232"> </a>
<a name="ln233">void Tremolo::layoutOneNoteTremolo(qreal x, qreal y, qreal _spatium)</a>
<a name="ln234">      {</a>
<a name="ln235">      Q_ASSERT(!twoNotes());</a>
<a name="ln236"> </a>
<a name="ln237">      bool up = _chord1-&gt;up();</a>
<a name="ln238">      int line = up ? _chord1-&gt;upLine() : _chord1-&gt;downLine();</a>
<a name="ln239"> </a>
<a name="ln240">      if (!placeMidStem()) {</a>
<a name="ln241">            static const qreal t[3][2][4][2] = {</a>
<a name="ln242">                  // normal stem</a>
<a name="ln243">                  {</a>
<a name="ln244">                     // DOWN</a>
<a name="ln245">                     {</a>
<a name="ln246">                        // even line   odd line</a>
<a name="ln247">                        { 6,           5          },  // line 1</a>
<a name="ln248">                        { 6 - 2 * .8,  5 - 2 * .8 },  // line 2</a>
<a name="ln249">                        { 6 - 4 * .8,  3          },  // line 3</a>
<a name="ln250">                        { 2         ,  3          }   // line 4</a>
<a name="ln251">                        },</a>
<a name="ln252">                     // UP</a>
<a name="ln253">                     {</a>
<a name="ln254">                        // even line   odd line</a>
<a name="ln255">                        { -6,          -5          },  // line 1</a>
<a name="ln256">                        { -6,          -5          },  // line 2</a>
<a name="ln257">                        { -6,          -3 - 4 * .8 },  // line 3</a>
<a name="ln258">                        { -2 - 6 * .8, -3 - 6 * .8 }   // line 4</a>
<a name="ln259">                        }</a>
<a name="ln260">                     },</a>
<a name="ln261">                  // stem with hook</a>
<a name="ln262">                  {</a>
<a name="ln263">                     // DOWN</a>
<a name="ln264">                     {</a>
<a name="ln265">                        // even line   odd line</a>
<a name="ln266">                        { 3,           3          },  // line 1</a>
<a name="ln267">                        { 2,           2          },  // line 2</a>
<a name="ln268">                        { 2,           2          },  // line 3</a>
<a name="ln269">                        { 2,           2          }   // line 4</a>
<a name="ln270">                        },</a>
<a name="ln271">                     // UP</a>
<a name="ln272">                     {</a>
<a name="ln273">                        // even line   odd line</a>
<a name="ln274">                        { -3,          -3          },  // line 1</a>
<a name="ln275">                        { -2 - 2 * .8, -2 - 2 * .8 },  // line 2</a>
<a name="ln276">                        { -2 - 4 * .8, -2 - 4 * .8 },  // line 3</a>
<a name="ln277">                        { -2 - 6 * .8, -2 - 6 * .8 }   // line 4</a>
<a name="ln278">                        }</a>
<a name="ln279">                     },</a>
<a name="ln280">                  // stem with beam</a>
<a name="ln281">                  {</a>
<a name="ln282">                     // DOWN</a>
<a name="ln283">                     {</a>
<a name="ln284">                        // even line   odd line</a>
<a name="ln285">                        { 3,           3          },  // line 1</a>
<a name="ln286">                        { 2,           2          },  // line 2</a>
<a name="ln287">                        { 2,           2          },  // line 3</a>
<a name="ln288">                        { 2,           2          }   // line 4</a>
<a name="ln289">                        },</a>
<a name="ln290">                     // UP</a>
<a name="ln291">                     {</a>
<a name="ln292">                        // even line   odd line</a>
<a name="ln293">                        { -3,          -3          },  // line 1</a>
<a name="ln294">                        { -2 - 2 * .8, -2 - 2 * .8 },  // line 2</a>
<a name="ln295">                        { -2 - 4 * .8, -2 - 4 * .8 },  // line 3</a>
<a name="ln296">                        { -2 - 6 * .8, -2 - 6 * .8 }   // line 4</a>
<a name="ln297">                        }</a>
<a name="ln298">                     },</a>
<a name="ln299">                  };</a>
<a name="ln300">            int idx = _chord1-&gt;hook() ? 1 : (_chord1-&gt;beam() ? 2 : 0);</a>
<a name="ln301">            y = (line + t[idx][up][_lines-1][line &amp; 1]) * .5 * _spatium;</a>
<a name="ln302">            }</a>
<a name="ln303">      else {</a>
<a name="ln304">            const Note* n = up ? chord()-&gt;downNote() : chord()-&gt;upNote();</a>
<a name="ln305">            const qreal noteBorder = n-&gt;y() + (up ? n-&gt;bbox().top() : n-&gt;bbox().bottom());</a>
<a name="ln306"> </a>
<a name="ln307">            const Stem* stem = chord()-&gt;stem();</a>
<a name="ln308">            const qreal stemLen = stem ? stem-&gt;height() : (3 * _spatium);</a>
<a name="ln309">            const qreal stemY = stem ? (stem-&gt;y() + (up ? stem-&gt;bbox().bottom() : stem-&gt;bbox().top())) : noteBorder;</a>
<a name="ln310">            const qreal stemNoteOverlap = std::max(0.0, (up ? 1.0 : -1.0) * (stemY - noteBorder));</a>
<a name="ln311"> </a>
<a name="ln312">            y = stemY</a>
<a name="ln313">                  + (up ? -1 : 1) * (</a>
<a name="ln314">                     stemNoteOverlap // calculate offset from note top or bottom rather than stem anchor point</a>
<a name="ln315">                     + 0.5 * (stemLen - stemNoteOverlap) // divide stem by 2, excluding the area overlapping with the note</a>
<a name="ln316">                     )</a>
<a name="ln317">                  - 0.5 * height() - bbox().top(); // center the tremolo at the given position</a>
<a name="ln318"> </a>
<a name="ln319">            if (const Beam* b = chord()-&gt;beam()) {</a>
<a name="ln320">                  // apply a correction for beam overlapping with the stem</a>
<a name="ln321">                  const qreal beamHalfLineWidth = point(score()-&gt;styleS(Sid::beamWidth)) * .5 * mag();</a>
<a name="ln322">                  const qreal beamSpace = b-&gt;beamDist() - 2 * beamHalfLineWidth;</a>
<a name="ln323"> </a>
<a name="ln324">                  int beamLvl = 1;</a>
<a name="ln325">                  for (const ChordRest* cr : chord()-&gt;beam()-&gt;elements()) {</a>
<a name="ln326">                        if (cr-&gt;isChord()) {</a>
<a name="ln327">                              const int crBeamLvl = toChord(cr)-&gt;beams();</a>
<a name="ln328">                              if (crBeamLvl &gt; beamLvl)</a>
<a name="ln329">                                    beamLvl = crBeamLvl;</a>
<a name="ln330">                              }</a>
<a name="ln331">                        }</a>
<a name="ln332"> </a>
<a name="ln333">                  const qreal stemBeamOverlap = beamLvl * b-&gt;beamDist() // initial guess</a>
<a name="ln334">                                                   - beamHalfLineWidth // exclude the part of the beam line that does not overlap with the stem</a>
<a name="ln335">                                                   - beamSpace; // exclude an extra spacing between beams that was included in the initial guess</a>
<a name="ln336"> </a>
<a name="ln337">                  y += (up ? 1 : -1) * stemBeamOverlap / 2;</a>
<a name="ln338">                  }</a>
<a name="ln339">            else if (chord()-&gt;hook()) {</a>
<a name="ln340">                  const qreal hookLvlHeight = 0.5 * _spatium; // TODO: avoid hardcoding this (how?)</a>
<a name="ln341">                  y += (up ? 1 : -1) * (chord()-&gt;beams() + 0.5) * hookLvlHeight;</a>
<a name="ln342">                  }</a>
<a name="ln343">            }</a>
<a name="ln344"> </a>
<a name="ln345">      setPos(x, y);</a>
<a name="ln346">      }</a>
<a name="ln347"> </a>
<a name="ln348">//---------------------------------------------------------</a>
<a name="ln349">//   layout</a>
<a name="ln350">//---------------------------------------------------------</a>
<a name="ln351"> </a>
<a name="ln352">void Tremolo::layout()</a>
<a name="ln353">      {</a>
<a name="ln354">      const qreal _spatium  = spatium();</a>
<a name="ln355"> </a>
<a name="ln356">      path = basePath();</a>
<a name="ln357"> </a>
<a name="ln358">      _chord1 = toChord(parent());</a>
<a name="ln359">      if (!_chord1) {</a>
<a name="ln360">            // palette</a>
<a name="ln361">            if (_tremoloType != TremoloType::BUZZ_ROLL) {</a>
<a name="ln362">                  const QRectF box = path.boundingRect();</a>
<a name="ln363">                  addbbox(QRectF(box.x(), box.bottom(), box.width(), _spatium));</a>
<a name="ln364">                  }</a>
<a name="ln365">            return;</a>
<a name="ln366">            }</a>
<a name="ln367"> </a>
<a name="ln368">      Note* anchor1 = _chord1-&gt;upNote();</a>
<a name="ln369">      Stem* stem    = _chord1-&gt;stem();</a>
<a name="ln370">      qreal x, y, h;</a>
<a name="ln371">      if (stem) {</a>
<a name="ln372">            x  = stem-&gt;pos().x();</a>
<a name="ln373">            y  = stem-&gt;pos().y();</a>
<a name="ln374">            h  = stem-&gt;stemLen();</a>
<a name="ln375">            }</a>
<a name="ln376">      else {</a>
<a name="ln377">            // center tremolo above note</a>
<a name="ln378">            x = anchor1-&gt;x() + anchor1-&gt;headWidth() * .5;</a>
<a name="ln379">            y = anchor1-&gt;y();</a>
<a name="ln380">            h = 2.0 * _spatium + bbox().height();</a>
<a name="ln381">            if (anchor1-&gt;line() &gt; 4)</a>
<a name="ln382">                  h *= -1;</a>
<a name="ln383">            }</a>
<a name="ln384"> </a>
<a name="ln385">      if (twoNotes())</a>
<a name="ln386">            layoutTwoNotesTremolo(x, y, h, _spatium);</a>
<a name="ln387">      else</a>
<a name="ln388">            layoutOneNoteTremolo(x, y, _spatium);</a>
<a name="ln389">      }</a>
<a name="ln390"> </a>
<a name="ln391">//---------------------------------------------------------</a>
<a name="ln392">//   layoutTwoNotesTremolo</a>
<a name="ln393">//---------------------------------------------------------</a>
<a name="ln394"> </a>
<a name="ln395">void Tremolo::layoutTwoNotesTremolo(qreal x, qreal y, qreal h, qreal _spatium)</a>
<a name="ln396">      {</a>
<a name="ln397">      y += (h - bbox().height()) * .5;</a>
<a name="ln398">      //</a>
<a name="ln399">      // two chord tremolo</a>
<a name="ln400">      //</a>
<a name="ln401"> </a>
<a name="ln402">#if 0 // Needs to be done earlier, see connectTremolo in layout.cpp</a>
<a name="ln403">      Segment* s = _chord1-&gt;segment()-&gt;next();</a>
<a name="ln404">      while (s) {</a>
<a name="ln405">            if (s-&gt;element(track()) &amp;&amp; (s-&gt;element(track())-&gt;isChord()))</a>
<a name="ln406">                  break;</a>
<a name="ln407">            s = s-&gt;next();</a>
<a name="ln408">            }</a>
<a name="ln409">      if (s == 0) {</a>
<a name="ln410">            qDebug(&quot;no second note of tremolo found&quot;);</a>
<a name="ln411">            return;</a>
<a name="ln412">            }</a>
<a name="ln413"> </a>
<a name="ln414">      _chord2 = toChord(s-&gt;element(track()));</a>
<a name="ln415">      _chord2-&gt;setTremolo(this);</a>
<a name="ln416">#endif</a>
<a name="ln417"> </a>
<a name="ln418">      Stem* stem1 = _chord1-&gt;stem();</a>
<a name="ln419">      Stem* stem2 = _chord2-&gt;stem();</a>
<a name="ln420"> </a>
<a name="ln421">      // compute the y coordinates of the tips of the stems</a>
<a name="ln422">      qreal y1, y2;</a>
<a name="ln423">      qreal firstChordStaffY;</a>
<a name="ln424"> </a>
<a name="ln425">      if (stem2 &amp;&amp; stem1) {</a>
<a name="ln426">            // stemPageYOffset variable is used for the case when the first</a>
<a name="ln427">            // chord is cross-staff</a>
<a name="ln428">            firstChordStaffY = stem1-&gt;pagePos().y() - stem1-&gt;y();  // y coordinate of the staff of the first chord</a>
<a name="ln429">            y1 = stem1-&gt;y() + stem1-&gt;p2().y();</a>
<a name="ln430">            y2 = stem2-&gt;pagePos().y() - firstChordStaffY + stem2-&gt;p2().y();  // -&gt;p2().y() is better than -&gt;stemLen()</a>
<a name="ln431">            }</a>
<a name="ln432">      else {</a>
<a name="ln433">            firstChordStaffY = _chord1-&gt;pagePos().y() - _chord1-&gt;y();  // y coordinate of the staff of the first chord</a>
<a name="ln434">            y1 = _chord1-&gt;stemPosBeam().y() - firstChordStaffY + _chord1-&gt;defaultStemLength();</a>
<a name="ln435">            y2 = _chord2-&gt;stemPosBeam().y() - firstChordStaffY + _chord2-&gt;defaultStemLength();</a>
<a name="ln436">            }</a>
<a name="ln437"> </a>
<a name="ln438">      // improve the case when one stem is up and another is down</a>
<a name="ln439">      if (_chord1-&gt;beams() == 0 &amp;&amp; _chord2-&gt;beams() == 0 &amp;&amp; _chord1-&gt;up() != _chord2-&gt;up()) {</a>
<a name="ln440">            qreal meanNote1Y = .5 * (_chord1-&gt;upNote()-&gt;pagePos().y() - firstChordStaffY + _chord1-&gt;downNote()-&gt;pagePos().y() - firstChordStaffY);</a>
<a name="ln441">            qreal meanNote2Y = .5 * (_chord2-&gt;upNote()-&gt;pagePos().y() - firstChordStaffY + _chord2-&gt;downNote()-&gt;pagePos().y() - firstChordStaffY);</a>
<a name="ln442">            y1 = .5 * (y1 + meanNote1Y);</a>
<a name="ln443">            y2 = .5 * (y2 + meanNote2Y);</a>
<a name="ln444">            }</a>
<a name="ln445"> </a>
<a name="ln446">      y = (y1 + y2) * .5;</a>
<a name="ln447">      if (!_chord1-&gt;up()) {</a>
<a name="ln448">            y -= path.boundingRect().height() * .5;</a>
<a name="ln449">            }</a>
<a name="ln450">      if (!_chord2-&gt;up()) {</a>
<a name="ln451">            y -= path.boundingRect().height() * .5;</a>
<a name="ln452">            }</a>
<a name="ln453"> </a>
<a name="ln454">      // compute the x coordinates of the inner edge of the stems</a>
<a name="ln455">      qreal x2  = _chord2-&gt;stemPosBeam().x();</a>
<a name="ln456">      if (_chord2-&gt;up() &amp;&amp; stem2)</a>
<a name="ln457">            x2 -= stem2-&gt;lineWidth();</a>
<a name="ln458">      qreal x1  = _chord1-&gt;stemPosBeam().x();</a>
<a name="ln459">      if (!_chord1-&gt;up() &amp;&amp; stem1)</a>
<a name="ln460">            x1 += stem1-&gt;lineWidth();</a>
<a name="ln461"> </a>
<a name="ln462">      x = (x1 + x2) * .5 - _chord1-&gt;pagePos().x();</a>
<a name="ln463"> </a>
<a name="ln464">      QTransform xScaleTransform;</a>
<a name="ln465">      // TODO const qreal H_MULTIPLIER = score()-&gt;styleS(Sid::tremoloBeamLengthMultiplier).val();</a>
<a name="ln466">      const qreal H_MULTIPLIER = 0.62;</a>
<a name="ln467">      // TODO const qreal MAX_H_LENGTH = _spatium * score()-&gt;styleS(Sid::tremoloBeamLengthMultiplier).val();</a>
<a name="ln468">      const qreal MAX_H_LENGTH = _spatium * 12.0;</a>
<a name="ln469"> </a>
<a name="ln470">      qreal xScaleFactor = qMin(H_MULTIPLIER * (x2 - x1), MAX_H_LENGTH);</a>
<a name="ln471">      const qreal w2  = _spatium * score()-&gt;styleS(Sid::tremoloWidth).val() * .5;</a>
<a name="ln472">      xScaleFactor /= (2.0 * w2);</a>
<a name="ln473"> </a>
<a name="ln474">      xScaleTransform.scale(xScaleFactor, 1.0);</a>
<a name="ln475">      path = xScaleTransform.map(path);</a>
<a name="ln476"> </a>
<a name="ln477">      qreal beamYOffset = 0.0;</a>
<a name="ln478"> </a>
<a name="ln479">      if (_chord1-&gt;beams() == _chord2-&gt;beams() &amp;&amp; _chord1-&gt;beam()) {</a>
<a name="ln480">            int beams = _chord1-&gt;beams();</a>
<a name="ln481">            qreal beamHalfLineWidth = point(score()-&gt;styleS(Sid::beamWidth)) * .5 * mag();</a>
<a name="ln482">            beamYOffset = beams * _chord1-&gt;beam()-&gt;beamDist() - beamHalfLineWidth;</a>
<a name="ln483">            if (_chord1-&gt;up() != _chord2-&gt;up()) {  // cross-staff</a>
<a name="ln484">                  beamYOffset = 2 * beamYOffset + beamHalfLineWidth;</a>
<a name="ln485">                  }</a>
<a name="ln486">            else if (!_chord1-&gt;up() &amp;&amp; !_chord2-&gt;up()) {</a>
<a name="ln487">                  beamYOffset = -beamYOffset;</a>
<a name="ln488">                  }</a>
<a name="ln489">            }</a>
<a name="ln490">      QTransform shearTransform;</a>
<a name="ln491">      qreal dy = y2 - y1;</a>
<a name="ln492">      qreal dx = x2 - x1;</a>
<a name="ln493">      qreal ds = dy / dx;</a>
<a name="ln494">      if (_chord1-&gt;beams() == 0 &amp;&amp; _chord2-&gt;beams() == 0) {</a>
<a name="ln495">            if (_chord1-&gt;up() &amp;&amp; !_chord2-&gt;up())</a>
<a name="ln496">                  ds = (dy - path.boundingRect().height()) / dx;</a>
<a name="ln497">            else if (!_chord1-&gt;up() &amp;&amp; _chord2-&gt;up())</a>
<a name="ln498">                  ds = (dy + path.boundingRect().height()) / dx;</a>
<a name="ln499">            }</a>
<a name="ln500">      shearTransform.shear(0.0, ds);</a>
<a name="ln501">      path = shearTransform.map(path);</a>
<a name="ln502"> </a>
<a name="ln503">      setbbox(path.boundingRect());</a>
<a name="ln504">      setPos(x, y + beamYOffset);</a>
<a name="ln505">      }</a>
<a name="ln506"> </a>
<a name="ln507">//---------------------------------------------------------</a>
<a name="ln508">//   write</a>
<a name="ln509">//---------------------------------------------------------</a>
<a name="ln510"> </a>
<a name="ln511">void Tremolo::write(XmlWriter&amp; xml) const</a>
<a name="ln512">      {</a>
<a name="ln513">      if (!xml.canWrite(this))</a>
<a name="ln514">            return;</a>
<a name="ln515">      xml.stag(this);</a>
<a name="ln516">      writeProperty(xml, Pid::TREMOLO_TYPE);</a>
<a name="ln517">      Element::writeProperties(xml);</a>
<a name="ln518">      xml.etag();</a>
<a name="ln519">      }</a>
<a name="ln520"> </a>
<a name="ln521">//---------------------------------------------------------</a>
<a name="ln522">//   read</a>
<a name="ln523">//---------------------------------------------------------</a>
<a name="ln524"> </a>
<a name="ln525">void Tremolo::read(XmlReader&amp; e)</a>
<a name="ln526">      {</a>
<a name="ln527">      while (e.readNextStartElement()) {</a>
<a name="ln528">            if (e.name() == &quot;subtype&quot;)</a>
<a name="ln529">                  setTremoloType(e.readElementText());</a>
<a name="ln530">            else if (!Element::readProperties(e))</a>
<a name="ln531">                  e.unknown();</a>
<a name="ln532">            }</a>
<a name="ln533">      }</a>
<a name="ln534"> </a>
<a name="ln535">//---------------------------------------------------------</a>
<a name="ln536">//   tremoloTypeName</a>
<a name="ln537">//---------------------------------------------------------</a>
<a name="ln538"> </a>
<a name="ln539">QString Tremolo::tremoloTypeName() const</a>
<a name="ln540">      {</a>
<a name="ln541">      return type2name(tremoloType());</a>
<a name="ln542">      }</a>
<a name="ln543"> </a>
<a name="ln544">//---------------------------------------------------------</a>
<a name="ln545">//   setTremoloType</a>
<a name="ln546">//---------------------------------------------------------</a>
<a name="ln547"> </a>
<a name="ln548">void Tremolo::setTremoloType(const QString&amp; s)</a>
<a name="ln549">      {</a>
<a name="ln550">      setTremoloType(name2Type(s));</a>
<a name="ln551">      }</a>
<a name="ln552"> </a>
<a name="ln553"> </a>
<a name="ln554">//---------------------------------------------------------</a>
<a name="ln555">//   type2Name</a>
<a name="ln556">//---------------------------------------------------------</a>
<a name="ln557"> </a>
<a name="ln558">QString Tremolo::type2name(TremoloType t)</a>
<a name="ln559">      {</a>
<a name="ln560">      switch(t) {</a>
<a name="ln561">            case TremoloType::R8:  return QString(&quot;r8&quot;);</a>
<a name="ln562">            case TremoloType::R16: return QString(&quot;r16&quot;);</a>
<a name="ln563">            case TremoloType::R32: return QString(&quot;r32&quot;);</a>
<a name="ln564">            case TremoloType::R64: return QString(&quot;r64&quot;);</a>
<a name="ln565">            case TremoloType::C8:  return QString(&quot;c8&quot;);</a>
<a name="ln566">            case TremoloType::C16: return QString(&quot;c16&quot;);</a>
<a name="ln567">            case TremoloType::C32: return QString(&quot;c32&quot;);</a>
<a name="ln568">            case TremoloType::C64: return QString(&quot;c64&quot;);</a>
<a name="ln569">            case TremoloType::BUZZ_ROLL: return QString(&quot;buzzroll&quot;);</a>
<a name="ln570">            default:</a>
<a name="ln571">                  break;</a>
<a name="ln572">            }</a>
<a name="ln573">      return QString(&quot;??&quot;);</a>
<a name="ln574">      }</a>
<a name="ln575"> </a>
<a name="ln576"> </a>
<a name="ln577">//---------------------------------------------------------</a>
<a name="ln578">//   nameToType</a>
<a name="ln579">//---------------------------------------------------------</a>
<a name="ln580"> </a>
<a name="ln581">TremoloType Tremolo::name2Type(const QString&amp; s)</a>
<a name="ln582">      {</a>
<a name="ln583">      TremoloType t = TremoloType::INVALID_TREMOLO;</a>
<a name="ln584">      if (s == &quot;r8&quot;)</a>
<a name="ln585">            t = TremoloType::R8;</a>
<a name="ln586">      else if (s == &quot;r16&quot;)</a>
<a name="ln587">            t = TremoloType::R16;</a>
<a name="ln588">      else if (s == &quot;r32&quot;)</a>
<a name="ln589">            t = TremoloType::R32;</a>
<a name="ln590">      else if (s == &quot;r64&quot;)</a>
<a name="ln591">            t = TremoloType::R64;</a>
<a name="ln592">      else if (s == &quot;c8&quot;)</a>
<a name="ln593">            t = TremoloType::C8;</a>
<a name="ln594">      else if (s == &quot;c16&quot;)</a>
<a name="ln595">            t = TremoloType::C16;</a>
<a name="ln596">      else if (s == &quot;c32&quot;)</a>
<a name="ln597">            t = TremoloType::C32;</a>
<a name="ln598">      else if (s == &quot;c64&quot;)</a>
<a name="ln599">            t = TremoloType::C64;</a>
<a name="ln600">      else if (s == &quot;buzzroll&quot;)</a>
<a name="ln601">            t = TremoloType::BUZZ_ROLL;</a>
<a name="ln602">      return t;</a>
<a name="ln603">      }</a>
<a name="ln604"> </a>
<a name="ln605">//---------------------------------------------------------</a>
<a name="ln606">//   tremoloLen</a>
<a name="ln607">//---------------------------------------------------------</a>
<a name="ln608"> </a>
<a name="ln609">Fraction Tremolo::tremoloLen() const</a>
<a name="ln610">      {</a>
<a name="ln611">      Fraction f;</a>
<a name="ln612">      switch(lines()) {</a>
<a name="ln613">            case 1: f.set(1,8); break;</a>
<a name="ln614">            case 2: f.set(1,16); break;</a>
<a name="ln615">            case 3: f.set(1,32); break;</a>
<a name="ln616">            case 4: f.set(1,64); break;</a>
<a name="ln617">            }</a>
<a name="ln618">      return f;</a>
<a name="ln619">      }</a>
<a name="ln620"> </a>
<a name="ln621">//---------------------------------------------------------</a>
<a name="ln622">//   subtypeName</a>
<a name="ln623">//---------------------------------------------------------</a>
<a name="ln624"> </a>
<a name="ln625">QString Tremolo::subtypeName() const</a>
<a name="ln626">      {</a>
<a name="ln627">      return qApp-&gt;translate(&quot;Tremolo&quot;, tremoloName[subtype()]);</a>
<a name="ln628">      }</a>
<a name="ln629"> </a>
<a name="ln630">//---------------------------------------------------------</a>
<a name="ln631">//   accessibleInfo</a>
<a name="ln632">//---------------------------------------------------------</a>
<a name="ln633"> </a>
<a name="ln634">QString Tremolo::accessibleInfo() const</a>
<a name="ln635">      {</a>
<a name="ln636">      return QString(&quot;%1: %2&quot;).arg(Element::accessibleInfo()).arg(subtypeName());</a>
<a name="ln637">      }</a>
<a name="ln638"> </a>
<a name="ln639">//---------------------------------------------------------</a>
<a name="ln640">//   getProperty</a>
<a name="ln641">//---------------------------------------------------------</a>
<a name="ln642"> </a>
<a name="ln643">QVariant Tremolo::getProperty(Pid propertyId) const</a>
<a name="ln644">      {</a>
<a name="ln645">      switch(propertyId) {</a>
<a name="ln646">            case Pid::TREMOLO_TYPE:</a>
<a name="ln647">                  return int(_tremoloType);</a>
<a name="ln648">            case Pid::TREMOLO_PLACEMENT:</a>
<a name="ln649">                  return int (_tremoloPlacement);</a>
<a name="ln650">            default:</a>
<a name="ln651">                  break;</a>
<a name="ln652">            }</a>
<a name="ln653">      return Element::getProperty(propertyId);</a>
<a name="ln654">      }</a>
<a name="ln655"> </a>
<a name="ln656">//---------------------------------------------------------</a>
<a name="ln657">//   setProperty</a>
<a name="ln658">//---------------------------------------------------------</a>
<a name="ln659"> </a>
<a name="ln660">bool Tremolo::setProperty(Pid propertyId, const QVariant&amp; val)</a>
<a name="ln661">      {</a>
<a name="ln662">      switch(propertyId) {</a>
<a name="ln663">            case Pid::TREMOLO_TYPE:</a>
<a name="ln664">                  setTremoloType(TremoloType(val.toInt()));</a>
<a name="ln665">                  break;</a>
<a name="ln666">            case Pid::TREMOLO_PLACEMENT:</a>
<a name="ln667">                  _tremoloPlacement = TremoloPlacement(val.toInt());</a>
<a name="ln668">                  break;</a>
<a name="ln669">            default:</a>
<a name="ln670">                  return Element::setProperty(propertyId, val);</a>
<a name="ln671">            }</a>
<a name="ln672">      triggerLayout();</a>
<a name="ln673">      return true;</a>
<a name="ln674">      }</a>
<a name="ln675"> </a>
<a name="ln676">//---------------------------------------------------------</a>
<a name="ln677">//   propertyId</a>
<a name="ln678">//---------------------------------------------------------</a>
<a name="ln679"> </a>
<a name="ln680">Pid Tremolo::propertyId(const QStringRef&amp; name) const</a>
<a name="ln681">      {</a>
<a name="ln682">      if (name == &quot;subtype&quot;)</a>
<a name="ln683">            return Pid::TREMOLO_TYPE;</a>
<a name="ln684">      return Element::propertyId(name);</a>
<a name="ln685">      }</a>
<a name="ln686"> </a>
<a name="ln687">//---------------------------------------------------------</a>
<a name="ln688">//   propertyUserValue</a>
<a name="ln689">//---------------------------------------------------------</a>
<a name="ln690"> </a>
<a name="ln691">QString Tremolo::propertyUserValue(Pid pid) const</a>
<a name="ln692">      {</a>
<a name="ln693">      switch(pid) {</a>
<a name="ln694">            case Pid::TREMOLO_TYPE:</a>
<a name="ln695">                  return subtypeName();</a>
<a name="ln696">            default:</a>
<a name="ln697">                  break;</a>
<a name="ln698">            }</a>
<a name="ln699">      return Element::propertyUserValue(pid);</a>
<a name="ln700">      }</a>
<a name="ln701">}</a>

</code></pre>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
