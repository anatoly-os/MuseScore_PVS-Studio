
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>keysig.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2011 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;sym.h&quot;</a>
<a name="ln14">#include &quot;staff.h&quot;</a>
<a name="ln15">#include &quot;clef.h&quot;</a>
<a name="ln16">#include &quot;keysig.h&quot;</a>
<a name="ln17">#include &quot;measure.h&quot;</a>
<a name="ln18">#include &quot;segment.h&quot;</a>
<a name="ln19">#include &quot;score.h&quot;</a>
<a name="ln20">#include &quot;system.h&quot;</a>
<a name="ln21">#include &quot;undo.h&quot;</a>
<a name="ln22">#include &quot;xml.h&quot;</a>
<a name="ln23"> </a>
<a name="ln24">namespace Ms {</a>
<a name="ln25"> </a>
<a name="ln26">const char* keyNames[] = {</a>
<a name="ln27">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;G major, E minor&quot;),</a>
<a name="ln28">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;C♭ major, A♭ minor&quot;),</a>
<a name="ln29">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;D major, B minor&quot;),</a>
<a name="ln30">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;G♭ major, E♭ minor&quot;),</a>
<a name="ln31">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;A major, F♯ minor&quot;),</a>
<a name="ln32">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;D♭ major, B♭ minor&quot;),</a>
<a name="ln33">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;E major, C♯ minor&quot;),</a>
<a name="ln34">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;A♭ major, F minor&quot;),</a>
<a name="ln35">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;B major, G♯ minor&quot;),</a>
<a name="ln36">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;E♭ major, C minor&quot;),</a>
<a name="ln37">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;F♯ major, D♯ minor&quot;),</a>
<a name="ln38">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;B♭ major, G minor&quot;),</a>
<a name="ln39">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;C♯ major, A♯ minor&quot;),</a>
<a name="ln40">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;F major, D minor&quot;),</a>
<a name="ln41">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;C major, A minor&quot;),</a>
<a name="ln42">      QT_TRANSLATE_NOOP(&quot;MuseScore&quot;, &quot;Open/Atonal&quot;)</a>
<a name="ln43">      };</a>
<a name="ln44"> </a>
<a name="ln45">//---------------------------------------------------------</a>
<a name="ln46">//   KeySig</a>
<a name="ln47">//---------------------------------------------------------</a>
<a name="ln48"> </a>
<a name="ln49">KeySig::KeySig(Score* s)</a>
<a name="ln50">  : Element(s, ElementFlag::ON_STAFF)</a>
<a name="ln51">      {</a>
<a name="ln52">      _showCourtesy = true;</a>
<a name="ln53">      _hideNaturals = false;</a>
<a name="ln54">      }</a>
<a name="ln55"> </a>
<a name="ln56">KeySig::KeySig(const KeySig&amp; k)</a>
<a name="ln57">   : Element(k)</a>
<a name="ln58">      {</a>
<a name="ln59">      _showCourtesy = k._showCourtesy;</a>
<a name="ln60">      _sig          = k._sig;</a>
<a name="ln61">      _hideNaturals = false;</a>
<a name="ln62">      }</a>
<a name="ln63"> </a>
<a name="ln64">//---------------------------------------------------------</a>
<a name="ln65">//   mag</a>
<a name="ln66">//---------------------------------------------------------</a>
<a name="ln67"> </a>
<a name="ln68">qreal KeySig::mag() const</a>
<a name="ln69">      {</a>
<a name="ln70">      return staff() ? staff()-&gt;mag(tick()) : 1.0;</a>
<a name="ln71">      }</a>
<a name="ln72"> </a>
<a name="ln73">//---------------------------------------------------------</a>
<a name="ln74">//   add</a>
<a name="ln75">//---------------------------------------------------------</a>
<a name="ln76"> </a>
<a name="ln77">void KeySig::addLayout(SymId sym, qreal x, int line)</a>
<a name="ln78">      {</a>
<a name="ln79">      qreal stepDistance = staff() ? staff()-&gt;lineDistance(tick()) * 0.5 : 0.5;</a>
<a name="ln80">      KeySym ks;</a>
<a name="ln81">      ks.sym    = sym;</a>
<a name="ln82">      ks.spos   = QPointF(x, qreal(line) * stepDistance);</a>
<a name="ln83">      _sig.keySymbols().append(ks);</a>
<a name="ln84">      }</a>
<a name="ln85"> </a>
<a name="ln86">//---------------------------------------------------------</a>
<a name="ln87">//   layout</a>
<a name="ln88">//---------------------------------------------------------</a>
<a name="ln89"> </a>
<a name="ln90">void KeySig::layout()</a>
<a name="ln91">      {</a>
<a name="ln92">      qreal _spatium = spatium();</a>
<a name="ln93">      setbbox(QRectF());</a>
<a name="ln94"> </a>
<a name="ln95">      if (isCustom() &amp;&amp; !isAtonal()) {</a>
<a name="ln96">            for (KeySym&amp; ks: _sig.keySymbols()) {</a>
<a name="ln97">                  ks.pos = ks.spos * _spatium;</a>
<a name="ln98">                  addbbox(symBbox(ks.sym).translated(ks.pos));</a>
<a name="ln99">                  }</a>
<a name="ln100">            return;</a>
<a name="ln101">            }</a>
<a name="ln102"> </a>
<a name="ln103">      _sig.keySymbols().clear();</a>
<a name="ln104">      if (staff() &amp;&amp; !staff()-&gt;staffType(tick())-&gt;genKeysig())</a>
<a name="ln105">            return;</a>
<a name="ln106"> </a>
<a name="ln107">      // determine current clef for this staff</a>
<a name="ln108">      ClefType clef = ClefType::G;</a>
<a name="ln109">      if (staff()) {</a>
<a name="ln110">            // Look for a clef before the key signature at the same tick</a>
<a name="ln111">            Clef* c = nullptr;</a>
<a name="ln112">            if (segment()) {</a>
<a name="ln113">                  for (Segment* seg = segment()-&gt;prev1(); !c &amp;&amp; seg &amp;&amp; seg-&gt;tick() == tick(); seg = seg-&gt;prev1())</a>
<a name="ln114">                        if (seg-&gt;isClefType() || seg-&gt;isHeaderClefType())</a>
<a name="ln115">                              c = toClef(seg-&gt;element(track()));</a>
<a name="ln116">                  }</a>
<a name="ln117">            if (c)</a>
<a name="ln118">                  clef = c-&gt;clefType();</a>
<a name="ln119">            else</a>
<a name="ln120">                  // no clef found, so get the clef type from the clefs list, using the previous tick</a>
<a name="ln121">                  clef = staff()-&gt;clef(tick() - Fraction::fromTicks(1));</a>
<a name="ln122">            }</a>
<a name="ln123"> </a>
<a name="ln124">      int accidentals = 0, naturals = 0;</a>
<a name="ln125">      int t1 = int(_sig.key());</a>
<a name="ln126">      switch (qAbs(t1)) {</a>
<a name="ln127">            case 7: accidentals = 0x7f; break;</a>
<a name="ln128">            case 6: accidentals = 0x3f; break;</a>
<a name="ln129">            case 5: accidentals = 0x1f; break;</a>
<a name="ln130">            case 4: accidentals = 0xf;  break;</a>
<a name="ln131">            case 3: accidentals = 0x7;  break;</a>
<a name="ln132">            case 2: accidentals = 0x3;  break;</a>
<a name="ln133">            case 1: accidentals = 0x1;  break;</a>
<a name="ln134">            case 0: accidentals = 0;    break;</a>
<a name="ln135">            default:</a>
<a name="ln136">                  qDebug(&quot;illegal t1 key %d&quot;, t1);</a>
<a name="ln137">                  break;</a>
<a name="ln138">            }</a>
<a name="ln139"> </a>
<a name="ln140">      // manage display of naturals:</a>
<a name="ln141">      // naturals are shown if there is some natural AND prev. measure has no section break</a>
<a name="ln142">      // AND style says they are not off</a>
<a name="ln143">      // OR key sig is CMaj/Amin (in which case they are always shown)</a>
<a name="ln144"> </a>
<a name="ln145">      bool naturalsOn = false;</a>
<a name="ln146">      Measure* prevMeasure = measure() ? measure()-&gt;prevMeasure() : 0;</a>
<a name="ln147"> </a>
<a name="ln148">      // If we're not force hiding naturals (Continuous panel), use score style settings</a>
<a name="ln149">      if (!_hideNaturals) {</a>
<a name="ln150">            const bool newSection = (!segment()</a>
<a name="ln151">               || (segment()-&gt;rtick().isZero() &amp;&amp; (!prevMeasure || prevMeasure-&gt;sectionBreak()))</a>
<a name="ln152">               );</a>
<a name="ln153">            naturalsOn = !newSection &amp;&amp; (score()-&gt;styleI(Sid::keySigNaturals) != int(KeySigNatural::NONE) || (t1 == 0));</a>
<a name="ln154">            }</a>
<a name="ln155"> </a>
<a name="ln156"> </a>
<a name="ln157">      // Don't repeat naturals if shown in courtesy</a>
<a name="ln158">      if (measure() &amp;&amp; measure()-&gt;system() &amp;&amp; measure() == measure()-&gt;system()-&gt;firstMeasure()</a>
<a name="ln159">          &amp;&amp; prevMeasure &amp;&amp; prevMeasure-&gt;findSegment(SegmentType::KeySigAnnounce, tick())</a>
<a name="ln160">          &amp;&amp; !segment()-&gt;isKeySigAnnounceType())</a>
<a name="ln161">            naturalsOn = false;</a>
<a name="ln162">      if (track() == -1)</a>
<a name="ln163">            naturalsOn = false;</a>
<a name="ln164"> </a>
<a name="ln165">      int coffset = 0;</a>
<a name="ln166">      Key t2      = Key::C;</a>
<a name="ln167">      if (naturalsOn) {</a>
<a name="ln168">            if (staff())</a>
<a name="ln169">                  t2 = staff()-&gt;key(tick() - Fraction(1, 480*4));</a>
<a name="ln170">            if (t2 == Key::C)</a>
<a name="ln171">                  naturalsOn = false;</a>
<a name="ln172">            else {</a>
<a name="ln173">                  switch (qAbs(int(t2))) {</a>
<a name="ln174">                        case 7: naturals = 0x7f; break;</a>
<a name="ln175">                        case 6: naturals = 0x3f; break;</a>
<a name="ln176">                        case 5: naturals = 0x1f; break;</a>
<a name="ln177">                        case 4: naturals = 0xf;  break;</a>
<a name="ln178">                        case 3: naturals = 0x7;  break;</a>
<a name="ln179">                        case 2: naturals = 0x3;  break;</a>
<a name="ln180">                        case 1: naturals = 0x1;  break;</a>
<a name="ln181">                        case 0: naturals = 0;    break;</a>
<a name="ln182">                        default:</a>
<a name="ln183">                              qDebug(&quot;illegal t2 key %d&quot;, int(t2));</a>
<a name="ln184">                              break;</a>
<a name="ln185">                        }</a>
<a name="ln186">                  // remove redundant naturals</a>
<a name="ln187">                  if (!((t1 &gt; 0) ^ (t2 &gt; 0)))</a>
<a name="ln188">                        naturals &amp;= ~accidentals;</a>
<a name="ln189">                  if (t2 &lt; 0)</a>
<a name="ln190">                        coffset = 7;</a>
<a name="ln191">                  }</a>
<a name="ln192">            }</a>
<a name="ln193"> </a>
<a name="ln194">      // naturals should go BEFORE accidentals if style says so</a>
<a name="ln195">      // OR going from sharps to flats or vice versa (i.e. t1 &amp; t2 have opposite signs)</a>
<a name="ln196"> </a>
<a name="ln197">      bool prefixNaturals =</a>
<a name="ln198">            naturalsOn</a>
<a name="ln199">            &amp;&amp; (score()-&gt;styleI(Sid::keySigNaturals) == int(KeySigNatural::BEFORE) || t1 * int(t2) &lt; 0);</a>
<a name="ln200"> </a>
<a name="ln201">      // naturals should go AFTER accidentals if they should not go before!</a>
<a name="ln202">      bool suffixNaturals = naturalsOn &amp;&amp; !prefixNaturals;</a>
<a name="ln203"> </a>
<a name="ln204">      const signed char* lines = ClefInfo::lines(clef);</a>
<a name="ln205"> </a>
<a name="ln206">      // add prefixed naturals, if any</a>
<a name="ln207"> </a>
<a name="ln208">      qreal xo = 0.0;</a>
<a name="ln209">      if (prefixNaturals) {</a>
<a name="ln210">            for (int i = 0; i &lt; 7; ++i) {</a>
<a name="ln211">                  if (naturals &amp; (1 &lt;&lt; i)) {</a>
<a name="ln212">                        addLayout(SymId::accidentalNatural, xo, lines[i + coffset]);</a>
<a name="ln213">                        xo += 1.0;</a>
<a name="ln214">                        }</a>
<a name="ln215">                  }</a>
<a name="ln216">            }</a>
<a name="ln217">      // add accidentals</a>
<a name="ln218">      static const qreal sspread = 1.0;</a>
<a name="ln219">      static const qreal fspread = 1.0;</a>
<a name="ln220"> </a>
<a name="ln221">      switch(t1) {</a>
<a name="ln222">            case 7:  addLayout(SymId::accidentalSharp, xo + 6.0 * sspread, lines[6]);</a>
<a name="ln223">                     // fall through</a>
<a name="ln224">            case 6:  addLayout(SymId::accidentalSharp, xo + 5.0 * sspread, lines[5]);</a>
<a name="ln225">                     // fall through</a>
<a name="ln226">            case 5:  addLayout(SymId::accidentalSharp, xo + 4.0 * sspread, lines[4]);</a>
<a name="ln227">                     // fall through</a>
<a name="ln228">            case 4:  addLayout(SymId::accidentalSharp, xo + 3.0 * sspread, lines[3]);</a>
<a name="ln229">                     // fall through</a>
<a name="ln230">            case 3:  addLayout(SymId::accidentalSharp, xo + 2.0 * sspread, lines[2]);</a>
<a name="ln231">                     // fall through</a>
<a name="ln232">            case 2:  addLayout(SymId::accidentalSharp, xo + 1.0 * sspread, lines[1]);</a>
<a name="ln233">                     // fall through</a>
<a name="ln234">            case 1:  addLayout(SymId::accidentalSharp, xo,                 lines[0]);</a>
<a name="ln235">                     break;</a>
<a name="ln236">            case -7: addLayout(SymId::accidentalFlat, xo + 6.0 * fspread, lines[13]);</a>
<a name="ln237">                     // fall through</a>
<a name="ln238">            case -6: addLayout(SymId::accidentalFlat, xo + 5.0 * fspread, lines[12]);</a>
<a name="ln239">                     // fall through</a>
<a name="ln240">            case -5: addLayout(SymId::accidentalFlat, xo + 4.0 * fspread, lines[11]);</a>
<a name="ln241">                     // fall through</a>
<a name="ln242">            case -4: addLayout(SymId::accidentalFlat, xo + 3.0 * fspread, lines[10]);</a>
<a name="ln243">                     // fall through</a>
<a name="ln244">            case -3: addLayout(SymId::accidentalFlat, xo + 2.0 * fspread, lines[9]);</a>
<a name="ln245">                     // fall through</a>
<a name="ln246">            case -2: addLayout(SymId::accidentalFlat, xo + 1.0 * fspread, lines[8]);</a>
<a name="ln247">                     // fall through</a>
<a name="ln248">            case -1: addLayout(SymId::accidentalFlat, xo,                 lines[7]);</a>
<a name="ln249">            case 0:</a>
<a name="ln250">                  break;</a>
<a name="ln251">            default:</a>
<a name="ln252">                  qDebug(&quot;illegal t1 key %d&quot;, t1);</a>
<a name="ln253">                  break;</a>
<a name="ln254">            }</a>
<a name="ln255">      // add suffixed naturals, if any</a>
<a name="ln256">      if (suffixNaturals) {</a>
<a name="ln257">            xo += qAbs(t1);               // skip accidentals</a>
<a name="ln258">            if (t1 &gt; 0) {                 // after sharps, add a little more space</a>
<a name="ln259">                  xo += 0.15;</a>
<a name="ln260">                  // if last sharp (t1) is above next natural (t1+1)...</a>
<a name="ln261">                  if (lines[t1] &lt; lines[t1+1])</a>
<a name="ln262">                        xo += 0.2;        // ... add more space</a>
<a name="ln263">                  }</a>
<a name="ln264">            for (int i = 0; i &lt; 7; ++i) {</a>
<a name="ln265">                  if (naturals &amp; (1 &lt;&lt; i)) {</a>
<a name="ln266">                        addLayout(SymId::accidentalNatural, xo, lines[i + coffset]);</a>
<a name="ln267">                        xo += 1.0;</a>
<a name="ln268">                        }</a>
<a name="ln269">                  }</a>
<a name="ln270">            }</a>
<a name="ln271"> </a>
<a name="ln272">      // compute bbox</a>
<a name="ln273">      for (KeySym&amp; ks : _sig.keySymbols()) {</a>
<a name="ln274">            ks.pos = ks.spos * _spatium;</a>
<a name="ln275">            addbbox(symBbox(ks.sym).translated(ks.pos));</a>
<a name="ln276">            }</a>
<a name="ln277">      }</a>
<a name="ln278"> </a>
<a name="ln279">//---------------------------------------------------------</a>
<a name="ln280">//   shape</a>
<a name="ln281">//---------------------------------------------------------</a>
<a name="ln282"> </a>
<a name="ln283">Shape KeySig::shape() const</a>
<a name="ln284">      {</a>
<a name="ln285">      QRectF box(bbox());</a>
<a name="ln286">      const Staff* st = staff();</a>
<a name="ln287">      if (st &amp;&amp; addToSkyline()) {</a>
<a name="ln288">            // Extend key signature shape up and down to</a>
<a name="ln289">            // the first ledger line height to ensure that</a>
<a name="ln290">            // no notes will be too close to the keysig.</a>
<a name="ln291">            const qreal sp = spatium();</a>
<a name="ln292">            const qreal y = pos().y();</a>
<a name="ln293">            box.setTop(std::min(-sp - y, box.top()));</a>
<a name="ln294">            box.setBottom(std::max(st-&gt;height() - y + sp, box.bottom()));</a>
<a name="ln295">            }</a>
<a name="ln296">      return Shape(box);</a>
<a name="ln297">      }</a>
<a name="ln298"> </a>
<a name="ln299">//---------------------------------------------------------</a>
<a name="ln300">//   set</a>
<a name="ln301">//---------------------------------------------------------</a>
<a name="ln302"> </a>
<a name="ln303">void KeySig::draw(QPainter* p) const</a>
<a name="ln304">      {</a>
<a name="ln305">      p-&gt;setPen(curColor());</a>
<a name="ln306">      for (const KeySym&amp; ks: _sig.keySymbols())</a>
<a name="ln307">            drawSymbol(ks.sym, p, QPointF(ks.pos.x(), ks.pos.y()));</a>
<a name="ln308">      if (!parent() &amp;&amp; (isAtonal() || isCustom()) &amp;&amp; _sig.keySymbols().empty()) {</a>
<a name="ln309">            // empty custom or atonal key signature - draw something for palette</a>
<a name="ln310">            p-&gt;setPen(Qt::gray);</a>
<a name="ln311">            drawSymbol(SymId::timeSigX, p, QPointF(symWidth(SymId::timeSigX) * -0.5, 2.0 * spatium()));</a>
<a name="ln312">            }</a>
<a name="ln313">      }</a>
<a name="ln314"> </a>
<a name="ln315">//---------------------------------------------------------</a>
<a name="ln316">//   acceptDrop</a>
<a name="ln317">//---------------------------------------------------------</a>
<a name="ln318"> </a>
<a name="ln319">bool KeySig::acceptDrop(EditData&amp; data) const</a>
<a name="ln320">      {</a>
<a name="ln321">      return data.dropElement-&gt;type() == ElementType::KEYSIG;</a>
<a name="ln322">      }</a>
<a name="ln323"> </a>
<a name="ln324">//---------------------------------------------------------</a>
<a name="ln325">//   drop</a>
<a name="ln326">//---------------------------------------------------------</a>
<a name="ln327"> </a>
<a name="ln328">Element* KeySig::drop(EditData&amp; data)</a>
<a name="ln329">      {</a>
<a name="ln330">      KeySig* ks = toKeySig(data.dropElement);</a>
<a name="ln331">      if (ks-&gt;type() != ElementType::KEYSIG) {</a>
<a name="ln332">            delete ks;</a>
<a name="ln333">            return 0;</a>
<a name="ln334">            }</a>
<a name="ln335">      KeySigEvent k = ks-&gt;keySigEvent();</a>
<a name="ln336">      delete ks;</a>
<a name="ln337">      if (data.modifiers &amp; Qt::ControlModifier) {</a>
<a name="ln338">            // apply only to this stave</a>
<a name="ln339">            if (!(k == keySigEvent()))</a>
<a name="ln340">                  score()-&gt;undoChangeKeySig(staff(), tick(), k);</a>
<a name="ln341">            }</a>
<a name="ln342">      else {</a>
<a name="ln343">            // apply to all staves:</a>
<a name="ln344">            foreach(Staff* s, score()-&gt;masterScore()-&gt;staves())</a>
<a name="ln345">                  score()-&gt;undoChangeKeySig(s, tick(), k);</a>
<a name="ln346">            }</a>
<a name="ln347">      return this;</a>
<a name="ln348">      }</a>
<a name="ln349"> </a>
<a name="ln350">//---------------------------------------------------------</a>
<a name="ln351">//   setKey</a>
<a name="ln352">//---------------------------------------------------------</a>
<a name="ln353"> </a>
<a name="ln354">void KeySig::setKey(Key key)</a>
<a name="ln355">      {</a>
<a name="ln356">      KeySigEvent e;</a>
<a name="ln357">      e.setKey(key);</a>
<a name="ln358">      setKeySigEvent(e);</a>
<a name="ln359">      }</a>
<a name="ln360"> </a>
<a name="ln361">//---------------------------------------------------------</a>
<a name="ln362">//   write</a>
<a name="ln363">//---------------------------------------------------------</a>
<a name="ln364"> </a>
<a name="ln365">void KeySig::write(XmlWriter&amp; xml) const</a>
<a name="ln366">      {</a>
<a name="ln367">      xml.stag(this);</a>
<a name="ln368">      Element::writeProperties(xml);</a>
<a name="ln369">      if (_sig.isAtonal()) {</a>
<a name="ln370">            xml.tag(&quot;custom&quot;, 1);</a>
<a name="ln371">            }</a>
<a name="ln372">      else if (_sig.custom()) {</a>
<a name="ln373">            xml.tag(&quot;custom&quot;, 1);</a>
<a name="ln374">            for (const KeySym&amp; ks : _sig.keySymbols()) {</a>
<a name="ln375">                  xml.stag(&quot;KeySym&quot;);</a>
<a name="ln376">                  xml.tag(&quot;sym&quot;, Sym::id2name(ks.sym));</a>
<a name="ln377">                  xml.tag(&quot;pos&quot;, ks.spos);</a>
<a name="ln378">                  xml.etag();</a>
<a name="ln379">                  }</a>
<a name="ln380">            }</a>
<a name="ln381">      else {</a>
<a name="ln382">            xml.tag(&quot;accidental&quot;, int(_sig.key()));</a>
<a name="ln383">            }</a>
<a name="ln384">      switch (_sig.mode()) {</a>
<a name="ln385">            case KeyMode::NONE:       xml.tag(&quot;mode&quot;, &quot;none&quot;); break;</a>
<a name="ln386">            case KeyMode::MAJOR:      xml.tag(&quot;mode&quot;, &quot;major&quot;); break;</a>
<a name="ln387">            case KeyMode::MINOR:      xml.tag(&quot;mode&quot;, &quot;minor&quot;); break;</a>
<a name="ln388">            case KeyMode::DORIAN:     xml.tag(&quot;mode&quot;, &quot;dorian&quot;); break;</a>
<a name="ln389">            case KeyMode::PHRYGIAN:   xml.tag(&quot;mode&quot;, &quot;phrygian&quot;); break;</a>
<a name="ln390">            case KeyMode::LYDIAN:     xml.tag(&quot;mode&quot;, &quot;lydian&quot;); break;</a>
<a name="ln391">            case KeyMode::MIXOLYDIAN: xml.tag(&quot;mode&quot;, &quot;mixolydian&quot;); break;</a>
<a name="ln392">            case KeyMode::AEOLIAN:    xml.tag(&quot;mode&quot;, &quot;aeolian&quot;); break;</a>
<a name="ln393">            case KeyMode::IONIAN:     xml.tag(&quot;mode&quot;, &quot;ionian&quot;); break;</a>
<a name="ln394">            case KeyMode::LOCRIAN:    xml.tag(&quot;mode&quot;, &quot;locrian&quot;); break;</a>
<a name="ln395">            case KeyMode::UNKNOWN:</a>
<a name="ln396">            default:</a>
<a name="ln397">                  ;</a>
<a name="ln398">            }</a>
<a name="ln399">      if (!_showCourtesy)</a>
<a name="ln400">            xml.tag(&quot;showCourtesySig&quot;, _showCourtesy);</a>
<a name="ln401">      xml.etag();</a>
<a name="ln402">      }</a>
<a name="ln403"> </a>
<a name="ln404">//---------------------------------------------------------</a>
<a name="ln405">//   read</a>
<a name="ln406">//---------------------------------------------------------</a>
<a name="ln407"> </a>
<a name="ln408">void KeySig::read(XmlReader&amp; e)</a>
<a name="ln409">      {</a>
<a name="ln410">      _sig = KeySigEvent();   // invalidate _sig</a>
<a name="ln411">      int subtype = 0;</a>
<a name="ln412"> </a>
<a name="ln413">      while (e.readNextStartElement()) {</a>
<a name="ln414">            const QStringRef&amp; tag(e.name());</a>
<a name="ln415">            if (tag == &quot;KeySym&quot;) {</a>
<a name="ln416">                  KeySym ks;</a>
<a name="ln417">                  while (e.readNextStartElement()) {</a>
<a name="ln418">                        const QStringRef&amp; t(e.name());</a>
<a name="ln419">                        if (t == &quot;sym&quot;) {</a>
<a name="ln420">                              QString val(e.readElementText());</a>
<a name="ln421">                              bool valid;</a>
<a name="ln422">                              SymId id = SymId(val.toInt(&amp;valid));</a>
<a name="ln423">                              if (!valid)</a>
<a name="ln424">                                    id = Sym::name2id(val);</a>
<a name="ln425">                              if (score()-&gt;mscVersion() &lt;= 114) {</a>
<a name="ln426">                                    if (valid)</a>
<a name="ln427">                                          id = KeySig::convertFromOldId(val.toInt(&amp;valid));</a>
<a name="ln428">                                    else</a>
<a name="ln429">                                          id = Sym::oldName2id(val);</a>
<a name="ln430">                                    }</a>
<a name="ln431">                              ks.sym = id;</a>
<a name="ln432">                              }</a>
<a name="ln433">                        else if (t == &quot;pos&quot;)</a>
<a name="ln434">                              ks.spos = e.readPoint();</a>
<a name="ln435">                        else</a>
<a name="ln436">                              e.unknown();</a>
<a name="ln437">                        }</a>
<a name="ln438">                  _sig.keySymbols().append(ks);</a>
<a name="ln439">                  }</a>
<a name="ln440">            else if (tag == &quot;showCourtesySig&quot;)</a>
<a name="ln441">                  _showCourtesy = e.readInt();</a>
<a name="ln442">            else if (tag == &quot;showNaturals&quot;)           // obsolete</a>
<a name="ln443">                  e.readInt();</a>
<a name="ln444">            else if (tag == &quot;accidental&quot;)</a>
<a name="ln445">                  _sig.setKey(Key(e.readInt()));</a>
<a name="ln446">            else if (tag == &quot;natural&quot;)                // obsolete</a>
<a name="ln447">                  e.readInt();</a>
<a name="ln448">            else if (tag == &quot;custom&quot;) {</a>
<a name="ln449">                  e.readInt();</a>
<a name="ln450">                  _sig.setCustom(true);</a>
<a name="ln451">                  }</a>
<a name="ln452">            else if (tag == &quot;mode&quot;) {</a>
<a name="ln453">                  QString m(e.readElementText());</a>
<a name="ln454">                  if (m == &quot;none&quot;)</a>
<a name="ln455">                        _sig.setMode(KeyMode::NONE);</a>
<a name="ln456">                  else if (m == &quot;major&quot;)</a>
<a name="ln457">                        _sig.setMode(KeyMode::MAJOR);</a>
<a name="ln458">                  else if (m == &quot;minor&quot;)</a>
<a name="ln459">                        _sig.setMode(KeyMode::MINOR);</a>
<a name="ln460">                  else if (m == &quot;dorian&quot;)</a>
<a name="ln461">                        _sig.setMode(KeyMode::DORIAN);</a>
<a name="ln462">                  else if (m == &quot;phrygian&quot;)</a>
<a name="ln463">                        _sig.setMode(KeyMode::PHRYGIAN);</a>
<a name="ln464">                  else if (m == &quot;lydian&quot;)</a>
<a name="ln465">                        _sig.setMode(KeyMode::LYDIAN);</a>
<a name="ln466">                  else if (m == &quot;mixolydian&quot;)</a>
<a name="ln467">                        _sig.setMode(KeyMode::MIXOLYDIAN);</a>
<a name="ln468">                  else if (m == &quot;aeolian&quot;)</a>
<a name="ln469">                        _sig.setMode(KeyMode::AEOLIAN);</a>
<a name="ln470">                  else if (m == &quot;ionian&quot;)</a>
<a name="ln471">                        _sig.setMode(KeyMode::IONIAN);</a>
<a name="ln472">                  else if (m == &quot;locrian&quot;)</a>
<a name="ln473">                        _sig.setMode(KeyMode::LOCRIAN);</a>
<a name="ln474">                  else</a>
<a name="ln475">                        _sig.setMode(KeyMode::UNKNOWN);</a>
<a name="ln476">                  }</a>
<a name="ln477">            else if (tag == &quot;subtype&quot;)</a>
<a name="ln478">                  subtype = e.readInt();</a>
<a name="ln479">            else if (!Element::readProperties(e))</a>
<a name="ln480">                  e.unknown();</a>
<a name="ln481">            }</a>
<a name="ln482">      // for backward compatibility</a>
<a name="ln483">      if (!_sig.isValid())</a>
<a name="ln484">            _sig.initFromSubtype(subtype);</a>
<a name="ln485">      if (_sig.custom() &amp;&amp; _sig.keySymbols().empty())</a>
<a name="ln486">            _sig.setMode(KeyMode::NONE);</a>
<a name="ln487">      }</a>
<a name="ln488"> </a>
<a name="ln489">//---------------------------------------------------------</a>
<a name="ln490">//   convertFromOldId</a>
<a name="ln491">//</a>
<a name="ln492">//    for import of 1.3 scores</a>
<a name="ln493">//---------------------------------------------------------</a>
<a name="ln494"> </a>
<a name="ln495">SymId KeySig::convertFromOldId(int val) const</a>
<a name="ln496">      {</a>
<a name="ln497">      SymId symId = SymId::noSym;</a>
<a name="ln498">      switch (val) {</a>
<a name="ln499">            case 32: symId = SymId::accidentalSharp; break;</a>
<a name="ln500">            case 33: symId = SymId::accidentalThreeQuarterTonesSharpArrowUp; break;</a>
<a name="ln501">            case 34: symId = SymId::accidentalQuarterToneSharpArrowDown; break;</a>
<a name="ln502">            // case 35: // &quot;sharp arrow both&quot; missing in SMuFL</a>
<a name="ln503">            case 36: symId = SymId::accidentalQuarterToneSharpStein; break;</a>
<a name="ln504">            case 37: symId = SymId::accidentalBuyukMucennebSharp; break;</a>
<a name="ln505">            case 38: symId = SymId::accidentalKomaSharp; break;</a>
<a name="ln506">            case 39: symId = SymId::accidentalThreeQuarterTonesSharpStein; break;</a>
<a name="ln507">            case 40: symId = SymId::accidentalNatural; break;</a>
<a name="ln508">            case 41: symId = SymId::accidentalQuarterToneSharpNaturalArrowUp; break;</a>
<a name="ln509">            case 42: symId = SymId::accidentalQuarterToneFlatNaturalArrowDown; break;</a>
<a name="ln510">            // case 43: // &quot;natural arrow both&quot; missing in SMuFL</a>
<a name="ln511">            case 44: symId = SymId::accidentalFlat; break;</a>
<a name="ln512">            case 45: symId = SymId::accidentalQuarterToneFlatArrowUp; break;</a>
<a name="ln513">            case 46: symId = SymId::accidentalThreeQuarterTonesFlatArrowDown; break;</a>
<a name="ln514">            // case 47: // &quot;flat arrow both&quot; missing in SMuFL</a>
<a name="ln515">            case 48: symId = SymId::accidentalBakiyeFlat; break;</a>
<a name="ln516">            case 49: symId = SymId::accidentalBuyukMucennebFlat; break;</a>
<a name="ln517">            case 50: symId = SymId::accidentalThreeQuarterTonesFlatZimmermann; break;</a>
<a name="ln518">            case 51: symId = SymId::accidentalQuarterToneFlatStein; break;</a>
<a name="ln519">            // case 52: // &quot;mirrored flat slash&quot; missing in SMuFL</a>
<a name="ln520">            case 53: symId = SymId::accidentalDoubleFlat; break;</a>
<a name="ln521">            // case 54: // &quot;flat flat slash&quot; missing in SMuFL</a>
<a name="ln522">            case 55: symId = SymId::accidentalDoubleSharp; break;</a>
<a name="ln523">            case 56: symId = SymId::accidentalSori; break;</a>
<a name="ln524">            case 57: symId = SymId::accidentalKoron; break;</a>
<a name="ln525">            default:</a>
<a name="ln526">                  qDebug(&quot;MuseScore 1.3 symbol id corresponding to &lt;%d&gt; not found&quot;, val);</a>
<a name="ln527">                  symId = SymId::noSym;</a>
<a name="ln528">                  break;</a>
<a name="ln529">            }</a>
<a name="ln530">      return symId;</a>
<a name="ln531">      }</a>
<a name="ln532"> </a>
<a name="ln533">//---------------------------------------------------------</a>
<a name="ln534">//   operator==</a>
<a name="ln535">//---------------------------------------------------------</a>
<a name="ln536"> </a>
<a name="ln537">bool KeySig::operator==(const KeySig&amp; k) const</a>
<a name="ln538">      {</a>
<a name="ln539">      return _sig == k._sig;</a>
<a name="ln540">      }</a>
<a name="ln541"> </a>
<a name="ln542">//---------------------------------------------------------</a>
<a name="ln543">//   isChange</a>
<a name="ln544">//---------------------------------------------------------</a>
<a name="ln545"> </a>
<a name="ln546">bool KeySig::isChange() const</a>
<a name="ln547">      {</a>
<a name="ln548">      if (!staff())</a>
<a name="ln549">            return false;</a>
<a name="ln550">      Fraction keyTick = tick();</a>
<a name="ln551">      return staff()-&gt;currentKeyTick(keyTick) == keyTick;</a>
<a name="ln552">      }</a>
<a name="ln553"> </a>
<a name="ln554">//---------------------------------------------------------</a>
<a name="ln555">//   changeKeySigEvent</a>
<a name="ln556">//---------------------------------------------------------</a>
<a name="ln557"> </a>
<a name="ln558">void KeySig::changeKeySigEvent(const KeySigEvent&amp; t)</a>
<a name="ln559">      {</a>
<a name="ln560">      if (_sig == t)</a>
<a name="ln561">            return;</a>
<a name="ln562">      setKeySigEvent(t);</a>
<a name="ln563">      }</a>
<a name="ln564"> </a>
<a name="ln565">//---------------------------------------------------------</a>
<a name="ln566">//   undoSetShowCourtesy</a>
<a name="ln567">//---------------------------------------------------------</a>
<a name="ln568"> </a>
<a name="ln569">void KeySig::undoSetShowCourtesy(bool v)</a>
<a name="ln570">      {</a>
<a name="ln571">      undoChangeProperty(Pid::SHOW_COURTESY, v);</a>
<a name="ln572">      }</a>
<a name="ln573"> </a>
<a name="ln574">//---------------------------------------------------------</a>
<a name="ln575">//   undoSetMode</a>
<a name="ln576">//---------------------------------------------------------</a>
<a name="ln577"> </a>
<a name="ln578">void KeySig::undoSetMode(KeyMode v)</a>
<a name="ln579">      {</a>
<a name="ln580">      undoChangeProperty(Pid::KEYSIG_MODE, int(v));</a>
<a name="ln581">      }</a>
<a name="ln582"> </a>
<a name="ln583">//---------------------------------------------------------</a>
<a name="ln584">//   getProperty</a>
<a name="ln585">//---------------------------------------------------------</a>
<a name="ln586"> </a>
<a name="ln587">QVariant KeySig::getProperty(Pid propertyId) const</a>
<a name="ln588">      {</a>
<a name="ln589">      switch (propertyId) {</a>
<a name="ln590">            case Pid::KEY:</a>
<a name="ln591">                  return int(key());</a>
<a name="ln592">            case Pid::SHOW_COURTESY:</a>
<a name="ln593">                  return int(showCourtesy());</a>
<a name="ln594">            case Pid::KEYSIG_MODE:</a>
<a name="ln595">                  return int(mode());</a>
<a name="ln596">            default:</a>
<a name="ln597">                  return Element::getProperty(propertyId);</a>
<a name="ln598">            }</a>
<a name="ln599">      }</a>
<a name="ln600"> </a>
<a name="ln601">//---------------------------------------------------------</a>
<a name="ln602">//   setProperty</a>
<a name="ln603">//---------------------------------------------------------</a>
<a name="ln604"> </a>
<a name="ln605">bool KeySig::setProperty(Pid propertyId, const QVariant&amp; v)</a>
<a name="ln606">      {</a>
<a name="ln607">      switch (propertyId) {</a>
<a name="ln608">            case Pid::KEY:</a>
<a name="ln609">                  if (generated())</a>
<a name="ln610">                        return false;</a>
<a name="ln611">                  setKey(Key(v.toInt()));</a>
<a name="ln612">                  break;</a>
<a name="ln613">            case Pid::SHOW_COURTESY:</a>
<a name="ln614">                  if (generated())</a>
<a name="ln615">                        return false;</a>
<a name="ln616">                  setShowCourtesy(v.toBool());</a>
<a name="ln617">                  break;</a>
<a name="ln618">            case Pid::KEYSIG_MODE:</a>
<a name="ln619">                  if (generated())</a>
<a name="ln620">                        return false;</a>
<a name="ln621">                  setMode(KeyMode(v.toInt()));</a>
<a name="ln622">                  break;</a>
<a name="ln623">            default:</a>
<a name="ln624">                  if (!Element::setProperty(propertyId, v))</a>
<a name="ln625">                        return false;</a>
<a name="ln626">                  break;</a>
<a name="ln627">            }</a>
<a name="ln628">      triggerLayoutAll();</a>
<a name="ln629">      setGenerated(false);</a>
<a name="ln630">      return true;</a>
<a name="ln631">      }</a>
<a name="ln632"> </a>
<a name="ln633">//---------------------------------------------------------</a>
<a name="ln634">//   propertyDefault</a>
<a name="ln635">//---------------------------------------------------------</a>
<a name="ln636"> </a>
<a name="ln637">QVariant KeySig::propertyDefault(Pid id) const</a>
<a name="ln638">      {</a>
<a name="ln639">      switch (id) {</a>
<a name="ln640">            case Pid::KEY:</a>
<a name="ln641">                  return int(Key::INVALID);</a>
<a name="ln642">            case Pid::SHOW_COURTESY:</a>
<a name="ln643">                  return true;</a>
<a name="ln644">            case Pid::KEYSIG_MODE:</a>
<a name="ln645">                  return int(KeyMode::UNKNOWN);</a>
<a name="ln646">            default:</a>
<a name="ln647">                  return Element::propertyDefault(id);</a>
<a name="ln648">            }</a>
<a name="ln649">      }</a>
<a name="ln650"> </a>
<a name="ln651">//---------------------------------------------------------</a>
<a name="ln652">//   nextSegmentElement</a>
<a name="ln653">//---------------------------------------------------------</a>
<a name="ln654"> </a>
<a name="ln655">Element* KeySig::nextSegmentElement()</a>
<a name="ln656">      {</a>
<a name="ln657">      return segment()-&gt;firstInNextSegments(staffIdx());</a>
<a name="ln658">      }</a>
<a name="ln659"> </a>
<a name="ln660">//---------------------------------------------------------</a>
<a name="ln661">//   prevSegmentElement</a>
<a name="ln662">//---------------------------------------------------------</a>
<a name="ln663"> </a>
<a name="ln664">Element* KeySig::prevSegmentElement()</a>
<a name="ln665">      {</a>
<a name="ln666">      return segment()-&gt;lastInPrevSegments(staffIdx());</a>
<a name="ln667">      }</a>
<a name="ln668"> </a>
<a name="ln669">//---------------------------------------------------------</a>
<a name="ln670">//   accessibleInfo</a>
<a name="ln671">//---------------------------------------------------------</a>
<a name="ln672"> </a>
<a name="ln673">QString KeySig::accessibleInfo() const</a>
<a name="ln674">      {</a>
<a name="ln675">      QString keySigType;</a>
<a name="ln676">      if (isAtonal())</a>
<a name="ln677">            return QString(&quot;%1: %2&quot;).arg(Element::accessibleInfo()).arg(qApp-&gt;translate(&quot;MuseScore&quot;, keyNames[15]));</a>
<a name="ln678">      else if (isCustom())</a>
<a name="ln679">            return QObject::tr(&quot;%1: Custom&quot;).arg(Element::accessibleInfo());</a>
<a name="ln680"> </a>
<a name="ln681">      if (key() == Key::C)</a>
<a name="ln682">            return QString(&quot;%1: %2&quot;).arg(Element::accessibleInfo()).arg(qApp-&gt;translate(&quot;MuseScore&quot;, keyNames[14]));</a>
<a name="ln683">      int keyInt = static_cast&lt;int&gt;(key());</a>
<a name="ln684">      if (keyInt &lt; 0)</a>
<a name="ln685">            keySigType = qApp-&gt;translate(&quot;MuseScore&quot;, keyNames[(7 + keyInt) * 2 + 1]);</a>
<a name="ln686">      else</a>
<a name="ln687">            keySigType = qApp-&gt;translate(&quot;MuseScore&quot;, keyNames[(keyInt - 1) * 2]);</a>
<a name="ln688">      return QString(&quot;%1: %2&quot;).arg(Element::accessibleInfo()).arg(keySigType);</a>
<a name="ln689">      }</a>
<a name="ln690"> </a>
<a name="ln691">}</a>

</code></pre>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
