
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>importmidi_model.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">#include &quot;importmidi_model.h&quot;</a>
<a name="ln2">#include &quot;importmidi_inner.h&quot;</a>
<a name="ln3">#include &quot;importmidi_clef.h&quot;</a>
<a name="ln4">#include &quot;mscore/preferences.h&quot;</a>
<a name="ln5">#include &quot;libmscore/instrtemplate.h&quot;</a>
<a name="ln6"> </a>
<a name="ln7"> </a>
<a name="ln8">namespace Ms {</a>
<a name="ln9"> </a>
<a name="ln10">class TracksModel::Column</a>
<a name="ln11">      {</a>
<a name="ln12">   public:</a>
<a name="ln13">      explicit Column(MidiOperations::Opers &amp;opers) : _opers(opers) {}</a>
<a name="ln14">      virtual ~Column() {}</a>
<a name="ln15"> </a>
<a name="ln16">      virtual QVariant value(int trackIndex) const = 0;</a>
<a name="ln17">      virtual void setValue(const QVariant &amp;value, int trackIndex) = 0;</a>
<a name="ln18">      virtual QString headerName() const = 0;</a>
<a name="ln19">      virtual bool isVisible(int /*trackIndex*/) const { return true; }</a>
<a name="ln20">      virtual QStringList valueList(int /*trackIndex*/) const { return _values; }</a>
<a name="ln21">      virtual int width() const { return -1; }</a>
<a name="ln22">      virtual bool isEditable(int /*trackIndex*/) const { return true; }</a>
<a name="ln23">      virtual bool isForAllTracksOnly() const { return false; }</a>
<a name="ln24"> </a>
<a name="ln25">   protected:</a>
<a name="ln26">      MidiOperations::Opers &amp;_opers;</a>
<a name="ln27">      QStringList _values;</a>
<a name="ln28">      };</a>
<a name="ln29"> </a>
<a name="ln30"> </a>
<a name="ln31">TracksModel::TracksModel()</a>
<a name="ln32">      : _trackCount(0)</a>
<a name="ln33">      , _frozenColCount(0)</a>
<a name="ln34">      , _isAllApplied(true)</a>
<a name="ln35">      {</a>
<a name="ln36">      }</a>
<a name="ln37"> </a>
<a name="ln38">TracksModel::~TracksModel()</a>
<a name="ln39">      {</a>
<a name="ln40">      }</a>
<a name="ln41"> </a>
<a name="ln42">void TracksModel::reset(const MidiOperations::Opers &amp;opers,</a>
<a name="ln43">                        const QList&lt;std::string&gt; &amp;lyricsList,</a>
<a name="ln44">                        int trackCount,</a>
<a name="ln45">                        const QString &amp;midiFile,</a>
<a name="ln46">                        bool hasHumanBeats,</a>
<a name="ln47">                        bool hasTempoText,</a>
<a name="ln48">                        bool hasChordNames)</a>
<a name="ln49">      {</a>
<a name="ln50">      beginResetModel();</a>
<a name="ln51">      _trackOpers = opers;</a>
<a name="ln52">      _columns.clear();</a>
<a name="ln53">      _trackCount = trackCount;</a>
<a name="ln54">      _frozenColCount = 0;</a>
<a name="ln55">      _midiFile = midiFile;</a>
<a name="ln56">      _isAllApplied = true;</a>
<a name="ln57">      if (trackCount == 0)</a>
<a name="ln58">            return;</a>
<a name="ln59"> </a>
<a name="ln60">      //-----------------------------------------------------------------------</a>
<a name="ln61">      struct Import : Column {</a>
<a name="ln62">            Import(MidiOperations::Opers &amp;opers) : Column(opers) {}</a>
<a name="ln63"> </a>
<a name="ln64">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln65">                                                      &quot;MIDI import operations&quot;, &quot;Import&quot;); }</a>
<a name="ln66">            QVariant value(int trackIndex) const override</a>
<a name="ln67">                  {</a>
<a name="ln68">                  return _opers.doImport.value(trackIndex);</a>
<a name="ln69">                  }</a>
<a name="ln70">            void setValue(const QVariant &amp;value, int trackIndex) override</a>
<a name="ln71">                  {</a>
<a name="ln72">                  _opers.doImport.setValue(trackIndex, value.toBool());</a>
<a name="ln73">                  }</a>
<a name="ln74">            };</a>
<a name="ln75">      ++_frozenColCount;</a>
<a name="ln76">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new Import(_trackOpers)));</a>
<a name="ln77"> </a>
<a name="ln78">      //-----------------------------------------------------------------------</a>
<a name="ln79">      struct Channel : Column {</a>
<a name="ln80">            Channel(MidiOperations::Opers &amp;opers) : Column(opers) {}</a>
<a name="ln81">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln82">                                                      &quot;MIDI import operations&quot;, &quot;Channel&quot;); }</a>
<a name="ln83">            bool isEditable(int /*trackIndex*/) const override { return false; }</a>
<a name="ln84">            QVariant value(int trackIndex) const override</a>
<a name="ln85">                  {</a>
<a name="ln86">                  return QString::number(_opers.channel.value(trackIndex));</a>
<a name="ln87">                  }</a>
<a name="ln88">            void setValue(const QVariant &amp;/*value*/, int /*trackIndex*/) override {}</a>
<a name="ln89">            };</a>
<a name="ln90">      ++_frozenColCount;</a>
<a name="ln91">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new Channel(_trackOpers)));</a>
<a name="ln92"> </a>
<a name="ln93">      //-----------------------------------------------------------------------</a>
<a name="ln94">      bool hasStaffName = false;</a>
<a name="ln95">      for (int i = 0; i != _trackCount; ++i) {</a>
<a name="ln96">            if (_trackOpers.staffName.value(i) != &quot;&quot;) {</a>
<a name="ln97">                  hasStaffName = true;</a>
<a name="ln98">                  break;</a>
<a name="ln99">                  }</a>
<a name="ln100">            }</a>
<a name="ln101">      if (hasStaffName) {</a>
<a name="ln102">            struct StaffName : Column {</a>
<a name="ln103">                  StaffName(MidiOperations::Opers &amp;opers, const QString &amp;midiFile)</a>
<a name="ln104">                        : Column(opers), _midiFile(midiFile)</a>
<a name="ln105">                        {</a>
<a name="ln106">                        }</a>
<a name="ln107">                  int width() const override { return 180; }</a>
<a name="ln108">                  QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln109">                                                      &quot;MIDI import operations&quot;, &quot;Staff name&quot;); }</a>
<a name="ln110">                  bool isEditable(int /*trackIndex*/) const override { return false; }</a>
<a name="ln111">                  QVariant value(int trackIndex) const override</a>
<a name="ln112">                        {</a>
<a name="ln113">                        MidiOperations::Data &amp;opers = midiImportOperations;</a>
<a name="ln114">                        MidiOperations::CurrentMidiFileSetter setCurrentMidiFile(opers, _midiFile);</a>
<a name="ln115"> </a>
<a name="ln116">                        return MidiCharset::convertToCharset(_opers.staffName.value(trackIndex));</a>
<a name="ln117">                        }</a>
<a name="ln118">                  void setValue(const QVariant &amp;/*value*/, int /*trackIndex*/) override {}</a>
<a name="ln119"> </a>
<a name="ln120">               private:</a>
<a name="ln121">                  QString _midiFile;</a>
<a name="ln122">                  };</a>
<a name="ln123">            ++_frozenColCount;</a>
<a name="ln124">            _columns.push_back(std::unique_ptr&lt;Column&gt;(new StaffName(_trackOpers, _midiFile)));</a>
<a name="ln125">            }</a>
<a name="ln126"> </a>
<a name="ln127">      //-----------------------------------------------------------------------</a>
<a name="ln128">      struct MidiInstrumentName : Column {</a>
<a name="ln129">            MidiInstrumentName(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln130">                  {</a>
<a name="ln131">                  }</a>
<a name="ln132">            int width() const override { return 130; }</a>
<a name="ln133">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln134">                                                      &quot;MIDI import operations&quot;, &quot;Sound&quot;); }</a>
<a name="ln135">            bool isEditable(int /*trackIndex*/) const override { return false; }</a>
<a name="ln136">            QVariant value(int trackIndex) const override</a>
<a name="ln137">                  {</a>
<a name="ln138">                  return _opers.midiInstrName.value(trackIndex);</a>
<a name="ln139">                  }</a>
<a name="ln140">            void setValue(const QVariant &amp;/*value*/, int /*trackIndex*/) override {}</a>
<a name="ln141">            };</a>
<a name="ln142">      ++_frozenColCount;</a>
<a name="ln143">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new MidiInstrumentName(_trackOpers)));</a>
<a name="ln144"> </a>
<a name="ln145">      //-----------------------------------------------------------------------</a>
<a name="ln146">      bool hasMsInstrument = false;</a>
<a name="ln147">      for (int i = 0; i != _trackCount; ++i) {</a>
<a name="ln148">            if (!_trackOpers.msInstrList.value(i).empty()) {</a>
<a name="ln149">                  hasMsInstrument = true;</a>
<a name="ln150">                  break;</a>
<a name="ln151">                  }</a>
<a name="ln152">            }</a>
<a name="ln153">      if (hasMsInstrument) {</a>
<a name="ln154">            struct MsInstrument : Column {</a>
<a name="ln155">                  MsInstrument(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln156">                        {</a>
<a name="ln157">                        }</a>
<a name="ln158">                  int width() const override { return 220; }</a>
<a name="ln159">                  QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln160">                                          &quot;MIDI import operations&quot;, &quot;MuseScore instrument&quot;); }</a>
<a name="ln161">                  bool isEditable(int trackIndex) const override</a>
<a name="ln162">                        {</a>
<a name="ln163">                        return _opers.msInstrList.value(trackIndex).size() &gt; 1;</a>
<a name="ln164">                        }</a>
<a name="ln165">                  QVariant value(int trackIndex) const override</a>
<a name="ln166">                        {</a>
<a name="ln167">                        const int instrIndex = _opers.msInstrIndex.value(trackIndex);</a>
<a name="ln168">                        const auto &amp;trackInstrList = _opers.msInstrList.value(trackIndex);</a>
<a name="ln169">                        const InstrumentTemplate *instr = (trackInstrList.empty())</a>
<a name="ln170">                                    ? nullptr : trackInstrList[instrIndex];</a>
<a name="ln171">                        return instrName(instr);</a>
<a name="ln172">                        }</a>
<a name="ln173">                  void setValue(const QVariant &amp;value, int trackIndex) override</a>
<a name="ln174">                        {</a>
<a name="ln175">                        _opers.msInstrIndex.setValue(trackIndex, value.toInt());</a>
<a name="ln176">                        }</a>
<a name="ln177">                  QStringList valueList(int trackIndex) const override</a>
<a name="ln178">                        {</a>
<a name="ln179">                        auto list = QStringList();</a>
<a name="ln180">                        const auto &amp;trackInstrList = _opers.msInstrList.value(trackIndex);</a>
<a name="ln181">                        for (const InstrumentTemplate *instr: trackInstrList)</a>
<a name="ln182">                              list.append(instrName(instr));</a>
<a name="ln183">                        return list;</a>
<a name="ln184">                        }</a>
<a name="ln185"> </a>
<a name="ln186">               private:</a>
<a name="ln187">                  static QString instrName(const InstrumentTemplate *instr)</a>
<a name="ln188">                        {</a>
<a name="ln189">                        if (!instr)</a>
<a name="ln190">                              return &quot;-&quot;;</a>
<a name="ln191">                        if (!instr-&gt;trackName.isEmpty())</a>
<a name="ln192">                              return instr-&gt;trackName;</a>
<a name="ln193">                        if (instr-&gt;longNames.isEmpty())</a>
<a name="ln194">                              return instr-&gt;id;</a>
<a name="ln195">                        return instr-&gt;longNames.front().name();</a>
<a name="ln196">                        }</a>
<a name="ln197">                  };</a>
<a name="ln198">            _columns.push_back(std::unique_ptr&lt;Column&gt;(new MsInstrument(_trackOpers)));</a>
<a name="ln199">            }</a>
<a name="ln200"> </a>
<a name="ln201">      //-----------------------------------------------------------------------</a>
<a name="ln202">      if (!lyricsList.isEmpty()) {</a>
<a name="ln203">            struct Lyrics : Column {</a>
<a name="ln204">                  Lyrics(MidiOperations::Opers &amp;opers,</a>
<a name="ln205">                         const QList&lt;std::string&gt; &amp;lyricsList,</a>
<a name="ln206">                         const QString &amp;midiFile)</a>
<a name="ln207">                        : Column(opers), _lyricsList(lyricsList), _midiFile(midiFile)</a>
<a name="ln208">                        {</a>
<a name="ln209">                        }</a>
<a name="ln210">                  int width() const override { return 185; }</a>
<a name="ln211">                  QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln212">                                                      &quot;MIDI import operations&quot;, &quot;Lyrics&quot;); }</a>
<a name="ln213">                  QVariant value(int trackIndex) const override</a>
<a name="ln214">                        {</a>
<a name="ln215">                        int index = _opers.lyricTrackIndex.value(trackIndex);</a>
<a name="ln216">                        if (index &gt;= 0) {</a>
<a name="ln217">                              MidiOperations::Data &amp;opers = midiImportOperations;</a>
<a name="ln218">                              MidiOperations::CurrentMidiFileSetter setCurrentMidiFile(opers, _midiFile);</a>
<a name="ln219"> </a>
<a name="ln220">                              return MidiCharset::convertToCharset(_lyricsList[index]);</a>
<a name="ln221">                              }</a>
<a name="ln222">                        return &quot;&quot;;</a>
<a name="ln223">                        }</a>
<a name="ln224">                  void setValue(const QVariant &amp;value, int trackIndex) override</a>
<a name="ln225">                        {</a>
<a name="ln226">                                    // GUI lyrics list always have &quot;&quot; row, so: (index - 1)</a>
<a name="ln227">                        _opers.lyricTrackIndex.setValue(trackIndex, value.toInt() - 1);</a>
<a name="ln228">                        }</a>
<a name="ln229">                  QStringList valueList(int /*trackIndex*/) const override</a>
<a name="ln230">                        {</a>
<a name="ln231">                        MidiOperations::Data &amp;opers = midiImportOperations;</a>
<a name="ln232">                        MidiOperations::CurrentMidiFileSetter setCurrentMidiFile(opers, _midiFile);</a>
<a name="ln233"> </a>
<a name="ln234">                        auto list = QStringList(&quot;&quot;);</a>
<a name="ln235">                        for (const auto &amp;lyric: _lyricsList)</a>
<a name="ln236">                              list.append(MidiCharset::convertToCharset(lyric));</a>
<a name="ln237">                        return list;</a>
<a name="ln238">                        }</a>
<a name="ln239">               private:</a>
<a name="ln240">                  QList&lt;std::string&gt; _lyricsList;</a>
<a name="ln241">                  QString _midiFile;</a>
<a name="ln242">                  };</a>
<a name="ln243">            _columns.push_back(std::unique_ptr&lt;Column&gt;(new Lyrics(_trackOpers, lyricsList, _midiFile)));</a>
<a name="ln244">            }</a>
<a name="ln245"> </a>
<a name="ln246">      //-----------------------------------------------------------------------</a>
<a name="ln247">      struct QuantValue : Column {</a>
<a name="ln248">            QuantValue(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln249">                  {</a>
<a name="ln250">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;Quarter&quot;));</a>
<a name="ln251">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;Eighth&quot;));</a>
<a name="ln252">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;16th&quot;));</a>
<a name="ln253">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;32nd&quot;));</a>
<a name="ln254">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;64th&quot;));</a>
<a name="ln255">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;128th&quot;));</a>
<a name="ln256">                  }</a>
<a name="ln257">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln258">                                                &quot;MIDI import operations&quot;, &quot;Max. quantization&quot;); }</a>
<a name="ln259">            QVariant value(int trackIndex) const override</a>
<a name="ln260">                  {</a>
<a name="ln261">                  return _values[(int)_opers.quantValue.value(trackIndex)];</a>
<a name="ln262">                  }</a>
<a name="ln263">            void setValue(const QVariant &amp;value, int trackIndex) override</a>
<a name="ln264">                  {</a>
<a name="ln265">                  _opers.quantValue.setValue(trackIndex, (MidiOperations::QuantValue)value.toInt());</a>
<a name="ln266">                  }</a>
<a name="ln267">            };</a>
<a name="ln268">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new QuantValue(_trackOpers)));</a>
<a name="ln269"> </a>
<a name="ln270">      //-----------------------------------------------------------------------</a>
<a name="ln271">      struct VoiceCount : Column {</a>
<a name="ln272">            VoiceCount(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln273">                  {</a>
<a name="ln274">                  _values.push_back(&quot;1&quot;);</a>
<a name="ln275">                  _values.push_back(&quot;2&quot;);</a>
<a name="ln276">                  _values.push_back(&quot;3&quot;);</a>
<a name="ln277">                  _values.push_back(&quot;4&quot;);</a>
<a name="ln278">                  }</a>
<a name="ln279">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln280">                                                      &quot;MIDI import operations&quot;, &quot;Max. voices&quot;); }</a>
<a name="ln281">            QVariant value(int trackIndex) const override</a>
<a name="ln282">                  {</a>
<a name="ln283">                  return _values[(int)_opers.maxVoiceCount.value(trackIndex)];</a>
<a name="ln284">                  }</a>
<a name="ln285">            void setValue(const QVariant &amp;value, int trackIndex) override</a>
<a name="ln286">                  {</a>
<a name="ln287">                  _opers.maxVoiceCount.setValue(trackIndex, (MidiOperations::VoiceCount)value.toInt());</a>
<a name="ln288">                  }</a>
<a name="ln289">            bool isVisible(int trackIndex) const override</a>
<a name="ln290">                  {</a>
<a name="ln291">                  if (_opers.isDrumTrack.value(trackIndex))</a>
<a name="ln292">                        return false;</a>
<a name="ln293">                  return true;</a>
<a name="ln294">                  }</a>
<a name="ln295">            };</a>
<a name="ln296">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new VoiceCount(_trackOpers)));</a>
<a name="ln297"> </a>
<a name="ln298">      //-----------------------------------------------------------------------</a>
<a name="ln299">      struct Tuplets : Column {</a>
<a name="ln300">            Tuplets(MidiOperations::Opers &amp;opers, int trackCount)</a>
<a name="ln301">                  : Column(opers), _trackCount(trackCount)</a>
<a name="ln302">                  {</a>
<a name="ln303">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;2-plets&quot;));</a>
<a name="ln304">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;3-plets&quot;));</a>
<a name="ln305">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;4-plets&quot;));</a>
<a name="ln306">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;5-plets&quot;));</a>
<a name="ln307">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;7-plets&quot;));</a>
<a name="ln308">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;9-plets&quot;));</a>
<a name="ln309">                  }</a>
<a name="ln310">            int width() const override { return 140; }</a>
<a name="ln311">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln312">                                                      &quot;MIDI import operations&quot;, &quot;Tuplets&quot;); }</a>
<a name="ln313">            QVariant value(int trackIndex) const override</a>
<a name="ln314">                  {</a>
<a name="ln315">                  QString val;</a>
<a name="ln316">                  if (_opers.search2plets.value(trackIndex)) {</a>
<a name="ln317">                        if (val != &quot;&quot;)</a>
<a name="ln318">                              val += &quot;, &quot;;</a>
<a name="ln319">                        val += &quot;2&quot;;</a>
<a name="ln320">                        }</a>
<a name="ln321">                  if (_opers.search3plets.value(trackIndex)) {</a>
<a name="ln322">                        if (val != &quot;&quot;)</a>
<a name="ln323">                              val += &quot;, &quot;;</a>
<a name="ln324">                        val += &quot;3&quot;;</a>
<a name="ln325">                        }</a>
<a name="ln326">                  if (_opers.search4plets.value(trackIndex)) {</a>
<a name="ln327">                        if (val != &quot;&quot;)</a>
<a name="ln328">                              val += &quot;, &quot;;</a>
<a name="ln329">                        val += &quot;4&quot;;</a>
<a name="ln330">                        }</a>
<a name="ln331">                  if (_opers.search5plets.value(trackIndex)) {</a>
<a name="ln332">                        if (val != &quot;&quot;)</a>
<a name="ln333">                              val += &quot;, &quot;;</a>
<a name="ln334">                        val += &quot;5&quot;;</a>
<a name="ln335">                        }</a>
<a name="ln336">                  if (_opers.search7plets.value(trackIndex)) {</a>
<a name="ln337">                        if (val != &quot;&quot;)</a>
<a name="ln338">                              val += &quot;, &quot;;</a>
<a name="ln339">                        val += &quot;7&quot;;</a>
<a name="ln340">                        }</a>
<a name="ln341">                  if (_opers.search9plets.value(trackIndex)) {</a>
<a name="ln342">                        if (val != &quot;&quot;)</a>
<a name="ln343">                              val += &quot;, &quot;;</a>
<a name="ln344">                        val += &quot;9&quot;;</a>
<a name="ln345">                        }</a>
<a name="ln346">                  return val;</a>
<a name="ln347">                  }</a>
<a name="ln348">            void setValue(const QVariant &amp;value, int trackIndex) override</a>
<a name="ln349">                  {</a>
<a name="ln350">                  const QStringList list = value.toStringList();</a>
<a name="ln351"> </a>
<a name="ln352">                  Q_ASSERT_X(list.size() &gt; 5, &quot;Midi import operations&quot;,</a>
<a name="ln353">                             &quot;Invalid size of the tuplets value list&quot;);</a>
<a name="ln354"> </a>
<a name="ln355">                  bool searchTuplets = false;</a>
<a name="ln356">                  if (list[0] != &quot;undefined&quot;) {</a>
<a name="ln357">                        const bool doSearch = (list[0] == &quot;true&quot;);</a>
<a name="ln358">                        _opers.search2plets.setValue(trackIndex, doSearch);</a>
<a name="ln359">                        if (!searchTuplets &amp;&amp; doSearch)</a>
<a name="ln360">                              searchTuplets = true;</a>
<a name="ln361">                        }</a>
<a name="ln362">                  if (list[1] != &quot;undefined&quot;) {</a>
<a name="ln363">                        const bool doSearch = (list[1] == &quot;true&quot;);</a>
<a name="ln364">                        _opers.search3plets.setValue(trackIndex, doSearch);</a>
<a name="ln365">                        if (!searchTuplets &amp;&amp; doSearch)</a>
<a name="ln366">                              searchTuplets = true;</a>
<a name="ln367">                        }</a>
<a name="ln368">                  if (list[2] != &quot;undefined&quot;) {</a>
<a name="ln369">                        const bool doSearch = (list[2] == &quot;true&quot;);</a>
<a name="ln370">                        _opers.search4plets.setValue(trackIndex, doSearch);</a>
<a name="ln371">                        if (!searchTuplets &amp;&amp; doSearch)</a>
<a name="ln372">                              searchTuplets = true;</a>
<a name="ln373">                        }</a>
<a name="ln374">                  if (list[3] != &quot;undefined&quot;) {</a>
<a name="ln375">                        const bool doSearch = (list[3] == &quot;true&quot;);</a>
<a name="ln376">                        _opers.search5plets.setValue(trackIndex, doSearch);</a>
<a name="ln377">                        if (!searchTuplets &amp;&amp; doSearch)</a>
<a name="ln378">                              searchTuplets = true;</a>
<a name="ln379">                        }</a>
<a name="ln380">                  if (list[4] != &quot;undefined&quot;) {</a>
<a name="ln381">                        const bool doSearch = (list[4] == &quot;true&quot;);</a>
<a name="ln382">                        _opers.search7plets.setValue(trackIndex, doSearch);</a>
<a name="ln383">                        if (!searchTuplets &amp;&amp; doSearch)</a>
<a name="ln384">                              searchTuplets = true;</a>
<a name="ln385">                        }</a>
<a name="ln386">                  if (list[5] != &quot;undefined&quot;) {</a>
<a name="ln387">                        const bool doSearch = (list[5] == &quot;true&quot;);</a>
<a name="ln388">                        _opers.search9plets.setValue(trackIndex, doSearch);</a>
<a name="ln389">                        if (!searchTuplets &amp;&amp; doSearch)</a>
<a name="ln390">                              searchTuplets = true;</a>
<a name="ln391">                        }</a>
<a name="ln392">                  _opers.searchTuplets.setValue(trackIndex, searchTuplets);</a>
<a name="ln393">                  }</a>
<a name="ln394">            QStringList valueList(int trackIndex) const override</a>
<a name="ln395">                  {</a>
<a name="ln396">                  auto list = QStringList(&quot;__MultiValue__&quot;);</a>
<a name="ln397"> </a>
<a name="ln398">                  list.append(_values[0]);</a>
<a name="ln399">                  list.append(checkBoxValue(trackIndex, _opers.search2plets));</a>
<a name="ln400">                  list.append(_values[1]);</a>
<a name="ln401">                  list.append(checkBoxValue(trackIndex, _opers.search3plets));</a>
<a name="ln402">                  list.append(_values[2]);</a>
<a name="ln403">                  list.append(checkBoxValue(trackIndex, _opers.search4plets));</a>
<a name="ln404">                  list.append(_values[3]);</a>
<a name="ln405">                  list.append(checkBoxValue(trackIndex, _opers.search5plets));</a>
<a name="ln406">                  list.append(_values[4]);</a>
<a name="ln407">                  list.append(checkBoxValue(trackIndex, _opers.search7plets));</a>
<a name="ln408">                  list.append(_values[5]);</a>
<a name="ln409">                  list.append(checkBoxValue(trackIndex, _opers.search9plets));</a>
<a name="ln410"> </a>
<a name="ln411">                  return list;</a>
<a name="ln412">                  }</a>
<a name="ln413"> </a>
<a name="ln414">         private:</a>
<a name="ln415">            QString checkBoxValue(int trackIndex,</a>
<a name="ln416">                                  const MidiOperations::TrackOp&lt;bool&gt; &amp;operation) const</a>
<a name="ln417">                  {</a>
<a name="ln418">                  if (trackIndex == -1) {       // symbolizes all tracks</a>
<a name="ln419">                        const bool firstValue = operation.value(0);</a>
<a name="ln420">                        for (int i = 1; i &lt; _trackCount; ++i) {</a>
<a name="ln421">                              if (operation.value(i) != firstValue)</a>
<a name="ln422">                                    return &quot;undefined&quot;;</a>
<a name="ln423">                              }</a>
<a name="ln424">                        trackIndex = 0;   // to pick the first track value on return</a>
<a name="ln425">                        }</a>
<a name="ln426">                  return operation.value(trackIndex) ? &quot;true&quot; : &quot;false&quot;;</a>
<a name="ln427">                  }</a>
<a name="ln428"> </a>
<a name="ln429">            int _trackCount;</a>
<a name="ln430">            };</a>
<a name="ln431">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new Tuplets(_trackOpers, _trackCount)));</a>
<a name="ln432"> </a>
<a name="ln433">      //-----------------------------------------------------------------------</a>
<a name="ln434">      if (hasHumanBeats) {</a>
<a name="ln435">            struct TimeSig : Column {</a>
<a name="ln436">                  TimeSig(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln437">                        {</a>
<a name="ln438">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;2&quot;));</a>
<a name="ln439">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;3&quot;));</a>
<a name="ln440">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;4&quot;));</a>
<a name="ln441">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;5&quot;));</a>
<a name="ln442">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;6&quot;));</a>
<a name="ln443">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;7&quot;));</a>
<a name="ln444">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;9&quot;));</a>
<a name="ln445">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;12&quot;));</a>
<a name="ln446">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;15&quot;));</a>
<a name="ln447">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;21&quot;));</a>
<a name="ln448">                        _numeratorCount = _values.size();</a>
<a name="ln449"> </a>
<a name="ln450">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;2&quot;));</a>
<a name="ln451">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;4&quot;));</a>
<a name="ln452">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;8&quot;));</a>
<a name="ln453">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;16&quot;));</a>
<a name="ln454">                        _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;32&quot;));</a>
<a name="ln455">                        }</a>
<a name="ln456">                  QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln457">                                                            &quot;MIDI import operations&quot;, &quot;Time signature&quot;); }</a>
<a name="ln458">                  bool isForAllTracksOnly() const override { return true; }</a>
<a name="ln459">                  QVariant value(int /*trackIndex*/) const override</a>
<a name="ln460">                        {</a>
<a name="ln461">                        const int numeratorIndex = (int)_opers.timeSigNumerator.value();</a>
<a name="ln462">                        const int denominatorIndex = (int)_opers.timeSigDenominator.value();</a>
<a name="ln463"> </a>
<a name="ln464">                        return _values[numeratorIndex] + &quot; / &quot; + _values[_numeratorCount + denominatorIndex];</a>
<a name="ln465">                        }</a>
<a name="ln466">                  void setValue(const QVariant &amp;value, int /*trackIndex*/) override</a>
<a name="ln467">                        {</a>
<a name="ln468">                        const QStringList list = value.toStringList();</a>
<a name="ln469"> </a>
<a name="ln470">                        Q_ASSERT_X(list.size() == 2, &quot;Midi import operations&quot;,</a>
<a name="ln471">                                   &quot;Invalid size of the time signature value list&quot;);</a>
<a name="ln472"> </a>
<a name="ln473">                        bool ok = false;</a>
<a name="ln474">                        _opers.timeSigNumerator.setValue((MidiOperations::TimeSigNumerator)list[0].toInt(&amp;ok));</a>
<a name="ln475"> </a>
<a name="ln476">                        Q_ASSERT_X(ok, &quot;Midi import operations&quot;, &quot;Invalid numerator value&quot;);</a>
<a name="ln477"> </a>
<a name="ln478">                        ok = false;</a>
<a name="ln479">                        _opers.timeSigDenominator.setValue((MidiOperations::TimeSigDenominator)list[1].toInt(&amp;ok));</a>
<a name="ln480"> </a>
<a name="ln481">                        Q_ASSERT_X(ok, &quot;Midi import operations&quot;, &quot;Invalid denominator value&quot;);</a>
<a name="ln482"> </a>
<a name="ln483">                        }</a>
<a name="ln484">                  QStringList valueList(int /*trackIndex*/) const override</a>
<a name="ln485">                        {</a>
<a name="ln486">                        auto list = QStringList(&quot;__TimeSig__&quot;);</a>
<a name="ln487">                        list.append(&quot;__Numerator__&quot;);</a>
<a name="ln488">                        list.append(QString::number((int)_opers.timeSigNumerator.value()));</a>
<a name="ln489">                        for (int i = 0; i != _numeratorCount; ++i)</a>
<a name="ln490">                              list.append(_values[i]);</a>
<a name="ln491">                        list.append(&quot;__Denominator__&quot;);</a>
<a name="ln492">                        list.append(QString::number((int)_opers.timeSigDenominator.value()));</a>
<a name="ln493">                        for (int i = _numeratorCount; i != _values.size(); ++i)</a>
<a name="ln494">                              list.append(_values[i]);</a>
<a name="ln495">                        return list;</a>
<a name="ln496">                        }</a>
<a name="ln497">               private:</a>
<a name="ln498">                  int _numeratorCount;</a>
<a name="ln499">                  };</a>
<a name="ln500">            _columns.push_back(std::unique_ptr&lt;Column&gt;(new TimeSig(_trackOpers)));</a>
<a name="ln501"> </a>
<a name="ln502">            //-----------------------------------------------------------------------</a>
<a name="ln503">            struct MeasureCount2xLess : Column {</a>
<a name="ln504">                  MeasureCount2xLess(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln505">                        {</a>
<a name="ln506">                        }</a>
<a name="ln507">                  QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln508">                                          &quot;MIDI import operations&quot;, &quot;2x less\nmeasure count&quot;); }</a>
<a name="ln509">                  bool isForAllTracksOnly() const override { return true; }</a>
<a name="ln510">                  QVariant value(int /*trackIndex*/) const override</a>
<a name="ln511">                        {</a>
<a name="ln512">                        return _opers.measureCount2xLess.value();</a>
<a name="ln513">                        }</a>
<a name="ln514">                  void setValue(const QVariant &amp;value, int /*trackIndex*/) override</a>
<a name="ln515">                        {</a>
<a name="ln516">                        _opers.measureCount2xLess.setValue(value.toBool());</a>
<a name="ln517">                        }</a>
<a name="ln518">                  };</a>
<a name="ln519">            _columns.push_back(std::unique_ptr&lt;Column&gt;(new MeasureCount2xLess(_trackOpers)));</a>
<a name="ln520">            }</a>
<a name="ln521"> </a>
<a name="ln522">      //-----------------------------------------------------------------------</a>
<a name="ln523">      struct Human : Column {</a>
<a name="ln524">            Human(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln525">                  {</a>
<a name="ln526">                  }</a>
<a name="ln527">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln528">                                                      &quot;MIDI import operations&quot;, &quot;Is human\nperformance&quot;); }</a>
<a name="ln529">            bool isForAllTracksOnly() const override { return true; }</a>
<a name="ln530">            QVariant value(int /*trackIndex*/) const override</a>
<a name="ln531">                  {</a>
<a name="ln532">                  return _opers.isHumanPerformance.value();</a>
<a name="ln533">                  }</a>
<a name="ln534">            void setValue(const QVariant &amp;value, int /*trackIndex*/) override</a>
<a name="ln535">                  {</a>
<a name="ln536">                  _opers.isHumanPerformance.setValue(value.toBool());</a>
<a name="ln537">                  }</a>
<a name="ln538">            };</a>
<a name="ln539">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new Human(_trackOpers)));</a>
<a name="ln540"> </a>
<a name="ln541">      //-----------------------------------------------------------------------</a>
<a name="ln542">      struct StaffSplit : Column {</a>
<a name="ln543">            StaffSplit(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln544">                  {</a>
<a name="ln545">                  }</a>
<a name="ln546">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln547">                                                      &quot;MIDI import operations&quot;, &quot;Split staff&quot;); }</a>
<a name="ln548">            QVariant value(int trackIndex) const override</a>
<a name="ln549">                  {</a>
<a name="ln550">                  return _opers.doStaffSplit.value(trackIndex);</a>
<a name="ln551">                  }</a>
<a name="ln552">            void setValue(const QVariant &amp;value, int trackIndex) override</a>
<a name="ln553">                  {</a>
<a name="ln554">                  _opers.doStaffSplit.setValue(trackIndex, value.toBool());</a>
<a name="ln555">                  }</a>
<a name="ln556">            };</a>
<a name="ln557">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new StaffSplit(_trackOpers)));</a>
<a name="ln558"> </a>
<a name="ln559">      //-----------------------------------------------------------------------</a>
<a name="ln560">      struct ClefChanges : Column {</a>
<a name="ln561">            ClefChanges(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln562">                  {</a>
<a name="ln563">                  }</a>
<a name="ln564">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln565">                                                      &quot;MIDI import operations&quot;, &quot;Clef\nchanges&quot;); }</a>
<a name="ln566">            bool isEditable(int trackIndex) const override</a>
<a name="ln567">                  {</a>
<a name="ln568">                  if (_opers.isDrumTrack.value(trackIndex))</a>
<a name="ln569">                        return false;</a>
<a name="ln570">                  const int instrIndex = _opers.msInstrIndex.value(trackIndex);</a>
<a name="ln571">                  const auto &amp;trackInstrList = _opers.msInstrList.value(trackIndex);</a>
<a name="ln572">                  const InstrumentTemplate *instr = (trackInstrList.empty())</a>
<a name="ln573">                                          ? nullptr : trackInstrList[instrIndex];</a>
<a name="ln574">                  if (instr &amp;&amp; !MidiClef::hasGFclefs(instr))</a>
<a name="ln575">                        return false;</a>
<a name="ln576">                  return true;</a>
<a name="ln577">                  }</a>
<a name="ln578">            QVariant value(int trackIndex) const override</a>
<a name="ln579">                  {</a>
<a name="ln580">                  return _opers.changeClef.value(trackIndex);</a>
<a name="ln581">                  }</a>
<a name="ln582">            void setValue(const QVariant &amp;value, int trackIndex) override</a>
<a name="ln583">                  {</a>
<a name="ln584">                  _opers.changeClef.setValue(trackIndex, value.toBool());</a>
<a name="ln585">                  }</a>
<a name="ln586">            bool isVisible(int trackIndex) const override</a>
<a name="ln587">                  {</a>
<a name="ln588">                  return isEditable(trackIndex);</a>
<a name="ln589">                  }</a>
<a name="ln590">            };</a>
<a name="ln591">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new ClefChanges(_trackOpers)));</a>
<a name="ln592"> </a>
<a name="ln593">      //-----------------------------------------------------------------------</a>
<a name="ln594">      struct Simplify : Column {</a>
<a name="ln595">            Simplify(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln596">                  {</a>
<a name="ln597">                  }</a>
<a name="ln598">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln599">                                                      &quot;MIDI import operations&quot;, &quot;Simplify\ndurations&quot;); }</a>
<a name="ln600">            QVariant value(int trackIndex) const override</a>
<a name="ln601">                  {</a>
<a name="ln602">                  return _opers.simplifyDurations.value(trackIndex);</a>
<a name="ln603">                  }</a>
<a name="ln604">            void setValue(const QVariant &amp;value, int trackIndex) override</a>
<a name="ln605">                  {</a>
<a name="ln606">                  _opers.simplifyDurations.setValue(trackIndex, value.toBool());</a>
<a name="ln607">                  }</a>
<a name="ln608">            };</a>
<a name="ln609">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new Simplify(_trackOpers)));</a>
<a name="ln610"> </a>
<a name="ln611">      //-----------------------------------------------------------------------</a>
<a name="ln612">      struct ShowStaccato : Column {</a>
<a name="ln613">            ShowStaccato(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln614">                  {</a>
<a name="ln615">                  }</a>
<a name="ln616">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln617">                                                      &quot;MIDI import operations&quot;, &quot;Show\nstaccato&quot;); }</a>
<a name="ln618">            QVariant value(int trackIndex) const override</a>
<a name="ln619">                  {</a>
<a name="ln620">                  return _opers.showStaccato.value(trackIndex);</a>
<a name="ln621">                  }</a>
<a name="ln622">            void setValue(const QVariant &amp;value, int trackIndex) override</a>
<a name="ln623">                  {</a>
<a name="ln624">                  _opers.showStaccato.setValue(trackIndex, value.toBool());</a>
<a name="ln625">                  }</a>
<a name="ln626">            };</a>
<a name="ln627">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new ShowStaccato(_trackOpers)));</a>
<a name="ln628"> </a>
<a name="ln629">      //-----------------------------------------------------------------------</a>
<a name="ln630">      struct DottedNotes : Column {</a>
<a name="ln631">            DottedNotes(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln632">                  {</a>
<a name="ln633">                  }</a>
<a name="ln634">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln635">                                                      &quot;MIDI import operations&quot;, &quot;Dotted\nnotes&quot;); }</a>
<a name="ln636">            QVariant value(int trackIndex) const override</a>
<a name="ln637">                  {</a>
<a name="ln638">                  return _opers.useDots.value(trackIndex);</a>
<a name="ln639">                  }</a>
<a name="ln640">            void setValue(const QVariant &amp;value, int trackIndex) override</a>
<a name="ln641">                  {</a>
<a name="ln642">                  _opers.useDots.setValue(trackIndex, value.toBool());</a>
<a name="ln643">                  }</a>
<a name="ln644">            };</a>
<a name="ln645">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new DottedNotes(_trackOpers)));</a>
<a name="ln646"> </a>
<a name="ln647">      //-----------------------------------------------------------------------</a>
<a name="ln648">      if (hasTempoText) {</a>
<a name="ln649">            struct ShowTempoText : Column {</a>
<a name="ln650">                  ShowTempoText(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln651">                        {</a>
<a name="ln652">                        }</a>
<a name="ln653">                  QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln654">                                          &quot;MIDI import operations&quot;, &quot;Show\ntempo text&quot;); }</a>
<a name="ln655">                  bool isForAllTracksOnly() const override { return true; }</a>
<a name="ln656">                  QVariant value(int /*trackIndex*/) const override</a>
<a name="ln657">                        {</a>
<a name="ln658">                        return _opers.showTempoText.value();</a>
<a name="ln659">                        }</a>
<a name="ln660">                  void setValue(const QVariant &amp;value, int /*trackIndex*/) override</a>
<a name="ln661">                        {</a>
<a name="ln662">                        _opers.showTempoText.setValue(value.toBool());</a>
<a name="ln663">                        }</a>
<a name="ln664">                  };</a>
<a name="ln665">            _columns.push_back(std::unique_ptr&lt;Column&gt;(new ShowTempoText(_trackOpers)));</a>
<a name="ln666">            }</a>
<a name="ln667"> </a>
<a name="ln668">      //-----------------------------------------------------------------------</a>
<a name="ln669">      if (hasChordNames) {</a>
<a name="ln670">            struct ShowChordNames : Column {</a>
<a name="ln671">                  ShowChordNames(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln672">                        {</a>
<a name="ln673">                        }</a>
<a name="ln674">                  QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln675">                                          &quot;MIDI import operations&quot;, &quot;Show\nchord symbols&quot;); }</a>
<a name="ln676">                  bool isForAllTracksOnly() const override { return true; }</a>
<a name="ln677">                  QVariant value(int /*trackIndex*/) const override</a>
<a name="ln678">                        {</a>
<a name="ln679">                        return _opers.showChordNames.value();</a>
<a name="ln680">                        }</a>
<a name="ln681">                  void setValue(const QVariant &amp;value, int /*trackIndex*/) override</a>
<a name="ln682">                        {</a>
<a name="ln683">                        _opers.showChordNames.setValue(value.toBool());</a>
<a name="ln684">                        }</a>
<a name="ln685">                  };</a>
<a name="ln686">            _columns.push_back(std::unique_ptr&lt;Column&gt;(new ShowChordNames(_trackOpers)));</a>
<a name="ln687">            }</a>
<a name="ln688"> </a>
<a name="ln689">      //-----------------------------------------------------------------------</a>
<a name="ln690">      struct PickupBar : Column {</a>
<a name="ln691">            PickupBar(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln692">                  {</a>
<a name="ln693">                  }</a>
<a name="ln694">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln695">                                           &quot;MIDI import operations&quot;, &quot;Recognize\npickup measure&quot;); }</a>
<a name="ln696">            bool isForAllTracksOnly() const override { return true; }</a>
<a name="ln697">            QVariant value(int /*trackIndex*/) const override</a>
<a name="ln698">                  {</a>
<a name="ln699">                  return _opers.searchPickupMeasure.value();</a>
<a name="ln700">                  }</a>
<a name="ln701">            void setValue(const QVariant &amp;value, int /*trackIndex*/) override</a>
<a name="ln702">                  {</a>
<a name="ln703">                  _opers.searchPickupMeasure.setValue(value.toBool());</a>
<a name="ln704">                  }</a>
<a name="ln705">            };</a>
<a name="ln706">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new PickupBar(_trackOpers)));</a>
<a name="ln707"> </a>
<a name="ln708">      //-----------------------------------------------------------------------</a>
<a name="ln709">      struct Swing : Column {</a>
<a name="ln710">            Swing(MidiOperations::Opers &amp;opers) : Column(opers)</a>
<a name="ln711">                  {</a>
<a name="ln712">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;None (1:1)&quot;));</a>
<a name="ln713">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;Swing (2:1)&quot;));</a>
<a name="ln714">                  _values.push_back(QCoreApplication::translate(&quot;MIDI import operations&quot;, &quot;Shuffle (3:1)&quot;));</a>
<a name="ln715">                  }</a>
<a name="ln716">            QString headerName() const override { return QCoreApplication::translate(</a>
<a name="ln717">                                                       &quot;MIDI import operations&quot;, &quot;Detect swing&quot;); }</a>
<a name="ln718">            int width() const override { return 130; }</a>
<a name="ln719">            QVariant value(int trackIndex) const override</a>
<a name="ln720">                  {</a>
<a name="ln721">                  return _values[(int)_opers.swing.value(trackIndex)];</a>
<a name="ln722">                  }</a>
<a name="ln723">            void setValue(const QVariant &amp;value, int trackIndex) override</a>
<a name="ln724">                  {</a>
<a name="ln725">                  _opers.swing.setValue(trackIndex, (MidiOperations::Swing)value.toInt());</a>
<a name="ln726">                  }</a>
<a name="ln727">            };</a>
<a name="ln728">      _columns.push_back(std::unique_ptr&lt;Column&gt;(new Swing(_trackOpers)));</a>
<a name="ln729"> </a>
<a name="ln730">      endResetModel();</a>
<a name="ln731">      }</a>
<a name="ln732"> </a>
<a name="ln733">void TracksModel::clear()</a>
<a name="ln734">      {</a>
<a name="ln735">      beginResetModel();</a>
<a name="ln736">      _trackCount = 0;</a>
<a name="ln737">      _frozenColCount = 0;</a>
<a name="ln738">      _trackOpers = MidiOperations::Opers();</a>
<a name="ln739">      _columns.clear();</a>
<a name="ln740">      _isAllApplied = true;</a>
<a name="ln741">      endResetModel();</a>
<a name="ln742">      }</a>
<a name="ln743"> </a>
<a name="ln744">const MidiOperations::Opers&amp; TracksModel::trackOpers() const</a>
<a name="ln745">      {</a>
<a name="ln746">      return _trackOpers;</a>
<a name="ln747">      }</a>
<a name="ln748"> </a>
<a name="ln749">void TracksModel::updateCharset()</a>
<a name="ln750">      {</a>
<a name="ln751">      _isAllApplied = false;</a>
<a name="ln752">      forceAllChanged();</a>
<a name="ln753">      }</a>
<a name="ln754"> </a>
<a name="ln755">void TracksModel::notifyAllApplied()</a>
<a name="ln756">      {</a>
<a name="ln757">      _isAllApplied = true;</a>
<a name="ln758">      }</a>
<a name="ln759"> </a>
<a name="ln760">int TracksModel::rowFromTrackIndex(int trackIndex) const</a>
<a name="ln761">      {</a>
<a name="ln762">                  // first row reserved for all tracks if track count &gt; 1</a>
<a name="ln763">      return (_trackCount &gt; 1) ? trackIndex + 1 : trackIndex;</a>
<a name="ln764">      }</a>
<a name="ln765"> </a>
<a name="ln766">int TracksModel::trackIndexFromRow(int row) const</a>
<a name="ln767">      {</a>
<a name="ln768">                  // first row reserved for all tracks if track count &gt; 1</a>
<a name="ln769">                  // return -1 if row is all tracks row</a>
<a name="ln770">      return (_trackCount &gt; 1) ? row - 1 : row;</a>
<a name="ln771">      }</a>
<a name="ln772"> </a>
<a name="ln773">int TracksModel::trackCountForImport() const</a>
<a name="ln774">      {</a>
<a name="ln775">      int count = 0;</a>
<a name="ln776">      for (int i = 0; i != _trackCount; ++i) {</a>
<a name="ln777">            if (_trackOpers.doImport.value(i))</a>
<a name="ln778">                  ++count;</a>
<a name="ln779">            }</a>
<a name="ln780">      return count;</a>
<a name="ln781">      }</a>
<a name="ln782"> </a>
<a name="ln783">int TracksModel::frozenRowCount() const</a>
<a name="ln784">      {</a>
<a name="ln785">      if (_trackCount &gt; 1)</a>
<a name="ln786">            return 1;</a>
<a name="ln787">      return 0;</a>
<a name="ln788">      }</a>
<a name="ln789"> </a>
<a name="ln790">int TracksModel::frozenColCount() const</a>
<a name="ln791">      {</a>
<a name="ln792">      return _frozenColCount;</a>
<a name="ln793">      }</a>
<a name="ln794"> </a>
<a name="ln795">int TracksModel::rowCount(const QModelIndex &amp;/*parent*/) const</a>
<a name="ln796">      {</a>
<a name="ln797">      return (_trackCount &gt; 1) ? _trackCount + 1 : _trackCount;</a>
<a name="ln798">      }</a>
<a name="ln799"> </a>
<a name="ln800">int TracksModel::columnCount(const QModelIndex &amp;/*parent*/) const</a>
<a name="ln801">      {</a>
<a name="ln802">      return int(_columns.size());</a>
<a name="ln803">      }</a>
<a name="ln804"> </a>
<a name="ln805">bool TracksModel::editableSingleTrack(int trackIndex, int column) const</a>
<a name="ln806">      {</a>
<a name="ln807">      return !(trackIndex &gt;= 0 &amp;&amp; _trackCount != 1 &amp;&amp; _columns[column]-&gt;isForAllTracksOnly());</a>
<a name="ln808">      }</a>
<a name="ln809"> </a>
<a name="ln810">QVariant TracksModel::data(const QModelIndex &amp;index, int role) const</a>
<a name="ln811">      {</a>
<a name="ln812">      if (!index.isValid())</a>
<a name="ln813">            return QVariant();</a>
<a name="ln814">      const int trackIndex = trackIndexFromRow(index.row());</a>
<a name="ln815">      if (!isTrackIndexValid(trackIndex) || !isColumnValid(index.column()))</a>
<a name="ln816">            return QVariant();</a>
<a name="ln817"> </a>
<a name="ln818">      switch (role) {</a>
<a name="ln819">            case Qt::DisplayRole:</a>
<a name="ln820">                  if (trackIndex == -1) {       // all tracks</a>
<a name="ln821">                        if (_columns[index.column()]-&gt;isEditable(-1)) {</a>
<a name="ln822">                              QVariant value = _columns[index.column()]-&gt;value(0);</a>
<a name="ln823">                              if (value.type() == QVariant::String) {</a>
<a name="ln824">                                    value = QVariant();</a>
<a name="ln825">                                    if (!_columns[index.column()]-&gt;isForAllTracksOnly()) {</a>
<a name="ln826">                                          for (int i = 0; i &lt; _trackCount; ++i) {</a>
<a name="ln827">                                                if (!_columns[index.column()]-&gt;isVisible(i))</a>
<a name="ln828">                                                      continue;</a>
<a name="ln829">                                                const auto newValue</a>
<a name="ln830">                                                            = _columns[index.column()]-&gt;value(i);</a>
<a name="ln831">                                                if (!value.isValid()) {       // value to compare with</a>
<a name="ln832">                                                      value = newValue;</a>
<a name="ln833">                                                      continue;</a>
<a name="ln834">                                                      }</a>
<a name="ln835">                                                if (newValue.toString() != value.toString())</a>
<a name="ln836">                                                      return &quot;…&quot;;</a>
<a name="ln837">                                                }</a>
<a name="ln838">                                          }</a>
<a name="ln839">                                    else {</a>
<a name="ln840">                                          value = _columns[index.column()]-&gt;value(0);</a>
<a name="ln841">                                          }</a>
<a name="ln842">                                    if (value.isValid())</a>
<a name="ln843">                                          return value.toString();</a>
<a name="ln844">                                    }</a>
<a name="ln845">                              }</a>
<a name="ln846">                        }</a>
<a name="ln847">                  else if (editableSingleTrack(trackIndex, index.column())</a>
<a name="ln848">                           &amp;&amp; _columns[index.column()]-&gt;isVisible(trackIndex)) {</a>
<a name="ln849">                        QVariant value = _columns[index.column()]-&gt;value(trackIndex);</a>
<a name="ln850">                        if (value.type() == QVariant::String)</a>
<a name="ln851">                              return value.toString();</a>
<a name="ln852">                        }</a>
<a name="ln853">                  break;</a>
<a name="ln854">            case Qt::EditRole:</a>
<a name="ln855">                  if (_columns[index.column()]-&gt;isEditable(trackIndex)</a>
<a name="ln856">                              &amp;&amp; editableSingleTrack(trackIndex, index.column())</a>
<a name="ln857">                              &amp;&amp; _columns[index.column()]-&gt;isVisible(trackIndex)) {</a>
<a name="ln858">                        const auto list = _columns[index.column()]-&gt;valueList(trackIndex);</a>
<a name="ln859">                        if (!list.isEmpty())</a>
<a name="ln860">                              return list;</a>
<a name="ln861">                        }</a>
<a name="ln862">                  break;</a>
<a name="ln863">            case Qt::CheckStateRole:</a>
<a name="ln864">                  if (trackIndex == -1) {</a>
<a name="ln865">                        QVariant value = _columns[index.column()]-&gt;value(0);</a>
<a name="ln866">                        if (value.type() == QVariant::Bool) {</a>
<a name="ln867">                              value = QVariant();</a>
<a name="ln868">                              if (!_columns[index.column()]-&gt;isForAllTracksOnly()) {</a>
<a name="ln869">                                    for (int i = 0; i &lt; _trackCount; ++i) {</a>
<a name="ln870">                                          if (!_columns[index.column()]-&gt;isVisible(i))</a>
<a name="ln871">                                                continue;</a>
<a name="ln872">                                          const auto newValue</a>
<a name="ln873">                                                      = _columns[index.column()]-&gt;value(i);</a>
<a name="ln874">                                          if (!value.isValid()) {       // value to compare with</a>
<a name="ln875">                                                value = newValue;</a>
<a name="ln876">                                                continue;</a>
<a name="ln877">                                                }</a>
<a name="ln878">                                          if (newValue.toBool() != value.toBool()) {</a>
<a name="ln879">                                                return Qt::PartiallyChecked;</a>
<a name="ln880">                                                }</a>
<a name="ln881">                                          }</a>
<a name="ln882">                                    }</a>
<a name="ln883">                              else {</a>
<a name="ln884">                                    value = _columns[index.column()]-&gt;value(0);</a>
<a name="ln885">                                    }</a>
<a name="ln886">                              if (value.isValid())</a>
<a name="ln887">                                    return (value.toBool()) ? Qt::Checked : Qt::Unchecked;</a>
<a name="ln888">                              }</a>
<a name="ln889">                        }</a>
<a name="ln890">                  else if (editableSingleTrack(trackIndex, index.column())</a>
<a name="ln891">                           &amp;&amp; _columns[index.column()]-&gt;isVisible(trackIndex)) {</a>
<a name="ln892">                        QVariant value = _columns[index.column()]-&gt;value(trackIndex);</a>
<a name="ln893">                        if (value.type() == QVariant::Bool)</a>
<a name="ln894">                              return (value.toBool()) ? Qt::Checked : Qt::Unchecked;</a>
<a name="ln895">                        }</a>
<a name="ln896">                  break;</a>
<a name="ln897">            case Qt::TextAlignmentRole:</a>
<a name="ln898">                  return Qt::AlignCenter;</a>
<a name="ln899">                  break;</a>
<a name="ln900">            case Qt::ToolTipRole:</a>
<a name="ln901">                  if (trackIndex != -1 &amp;&amp; _columns[index.column()]-&gt;isVisible(trackIndex)) {</a>
<a name="ln902">                        QVariant value = _columns[index.column()]-&gt;value(trackIndex);</a>
<a name="ln903">                        if (value.type() == QVariant::String</a>
<a name="ln904">                                    &amp;&amp; _columns[index.column()]-&gt;valueList(trackIndex).empty()) {</a>
<a name="ln905">                              MidiOperations::Data &amp;opers = midiImportOperations;</a>
<a name="ln906">                              MidiOperations::CurrentMidiFileSetter setCurrentMidiFile(opers, _midiFile);</a>
<a name="ln907"> </a>
<a name="ln908">                              return MidiCharset::convertToCharset(value.toString().toUtf8().constData());</a>
<a name="ln909">                              }</a>
<a name="ln910">                        }</a>
<a name="ln911">                  break;</a>
<a name="ln912">            case Qt::SizeHintRole:</a>
<a name="ln913">                  return QSize(_columns[index.column()]-&gt;width(), -1);</a>
<a name="ln914">                  break;</a>
<a name="ln915">            default:</a>
<a name="ln916">                  break;</a>
<a name="ln917">            }</a>
<a name="ln918">      return QVariant();</a>
<a name="ln919">      }</a>
<a name="ln920"> </a>
<a name="ln921">Qt::ItemFlags TracksModel::editableFlags(int row, int col) const</a>
<a name="ln922">      {</a>
<a name="ln923">      Qt::ItemFlags flags;</a>
<a name="ln924">      const int trackIndex = trackIndexFromRow(row);</a>
<a name="ln925"> </a>
<a name="ln926">      if (_columns[col]-&gt;isVisible(trackIndex)) {</a>
<a name="ln927">            if (_columns[col]-&gt;value(0).type() == QVariant::Bool) {</a>
<a name="ln928">                  flags |= Qt::ItemIsUserCheckable;</a>
<a name="ln929">                  }</a>
<a name="ln930">            else if (_columns[col]-&gt;isEditable(trackIndex)) {</a>
<a name="ln931">                  if (trackIndex == -1) {</a>
<a name="ln932">                        flags |= Qt::ItemIsEditable;</a>
<a name="ln933">                        }</a>
<a name="ln934">                  else if (editableSingleTrack(trackIndex, col)) {</a>
<a name="ln935">                        QVariant value = _columns[col]-&gt;value(0);</a>
<a name="ln936">                        if (value.type() != QVariant::Bool)       // not checkboxes</a>
<a name="ln937">                              flags |= Qt::ItemIsEditable;</a>
<a name="ln938">                        }</a>
<a name="ln939">                  }</a>
<a name="ln940">            }</a>
<a name="ln941">      return flags;</a>
<a name="ln942">      }</a>
<a name="ln943"> </a>
<a name="ln944">Qt::ItemFlags TracksModel::flags(const QModelIndex &amp;index) const</a>
<a name="ln945">      {</a>
<a name="ln946">      if (!index.isValid())</a>
<a name="ln947">            return 0;</a>
<a name="ln948"> </a>
<a name="ln949">      Qt::ItemFlags flags = Qt::ItemFlags(Qt::ItemIsEnabled | Qt::ItemIsSelectable);</a>
<a name="ln950">      const int trackIndex = trackIndexFromRow(index.row());</a>
<a name="ln951"> </a>
<a name="ln952">      if (trackIndex == -1) {       // all tracks row</a>
<a name="ln953">            if (!_columns[index.column()]-&gt;isForAllTracksOnly()</a>
<a name="ln954">                        &amp;&amp; _columns[index.column()]-&gt;isEditable(-1)) {</a>
<a name="ln955">                  for (int i = 0; i &lt; _trackCount; ++i) {</a>
<a name="ln956">                        const auto newFlags = editableFlags(rowFromTrackIndex(i), index.column());</a>
<a name="ln957">                        if (newFlags) {</a>
<a name="ln958">                              flags |= newFlags;</a>
<a name="ln959">                              break;</a>
<a name="ln960">                              }</a>
<a name="ln961">                        }</a>
<a name="ln962">                  }</a>
<a name="ln963">            else {</a>
<a name="ln964">                  flags |= editableFlags(index.row(), index.column());</a>
<a name="ln965">                  }</a>
<a name="ln966">            }</a>
<a name="ln967">      else {</a>
<a name="ln968">            flags |= editableFlags(index.row(), index.column());</a>
<a name="ln969">            }</a>
<a name="ln970"> </a>
<a name="ln971">      return flags;</a>
<a name="ln972">      }</a>
<a name="ln973"> </a>
<a name="ln974">void TracksModel::forceRowDataChanged(int row)</a>
<a name="ln975">      {</a>
<a name="ln976">      const auto begIndex = this-&gt;index(row, 0);</a>
<a name="ln977">      const auto endIndex = this-&gt;index(row, columnCount(QModelIndex()));</a>
<a name="ln978">      emit dataChanged(begIndex, endIndex);</a>
<a name="ln979">      }</a>
<a name="ln980"> </a>
<a name="ln981">void TracksModel::forceColumnDataChanged(int col)</a>
<a name="ln982">      {</a>
<a name="ln983">      const auto begIndex = this-&gt;index(0, col);</a>
<a name="ln984">      const auto endIndex = this-&gt;index(rowCount(QModelIndex()), col);</a>
<a name="ln985">      emit dataChanged(begIndex, endIndex);</a>
<a name="ln986">      }</a>
<a name="ln987"> </a>
<a name="ln988">void TracksModel::forceAllChanged()</a>
<a name="ln989">      {</a>
<a name="ln990">      const auto begIndex = this-&gt;index(0, 0);</a>
<a name="ln991">      const auto endIndex = this-&gt;index(rowCount(QModelIndex()), columnCount(QModelIndex()));</a>
<a name="ln992">      emit dataChanged(begIndex, endIndex);</a>
<a name="ln993">      }</a>
<a name="ln994"> </a>
<a name="ln995">bool TracksModel::setData(const QModelIndex &amp;index, const QVariant &amp;value, int /*role*/)</a>
<a name="ln996">      {</a>
<a name="ln997">      const int trackIndex = trackIndexFromRow(index.row());</a>
<a name="ln998">      if (!isTrackIndexValid(trackIndex) || !isColumnValid(index.column()))</a>
<a name="ln999">            return false;</a>
<a name="ln1000"> </a>
<a name="ln1001">      if (trackIndex == -1) {   // all tracks row</a>
<a name="ln1002">            if (!_columns[index.column()]-&gt;isForAllTracksOnly()) {</a>
<a name="ln1003">                  for (int i = 0; i != _trackCount; ++i) {</a>
<a name="ln1004">                        if (_columns[index.column()]-&gt;isVisible(i))</a>
<a name="ln1005">                              _columns[index.column()]-&gt;setValue(value, i);</a>
<a name="ln1006">                        }</a>
<a name="ln1007">                  forceColumnDataChanged(index.column());</a>
<a name="ln1008">                  }</a>
<a name="ln1009">            else {</a>
<a name="ln1010">                  _columns[index.column()]-&gt;setValue(value, 0);</a>
<a name="ln1011">                  }</a>
<a name="ln1012">            }</a>
<a name="ln1013">      else if (editableSingleTrack(trackIndex, index.column())</a>
<a name="ln1014">               &amp;&amp; _columns[index.column()]-&gt;isVisible(trackIndex)) {</a>
<a name="ln1015">            _columns[index.column()]-&gt;setValue(value, trackIndex);</a>
<a name="ln1016">            emit dataChanged(index, index);</a>
<a name="ln1017">            if (_trackCount &gt; 1)    // update 'all tracks' row</a>
<a name="ln1018">                  forceRowDataChanged(0);</a>
<a name="ln1019">            }</a>
<a name="ln1020"> </a>
<a name="ln1021">      _isAllApplied = false;</a>
<a name="ln1022">      return true;</a>
<a name="ln1023">      }</a>
<a name="ln1024"> </a>
<a name="ln1025">QVariant TracksModel::headerData(int section, Qt::Orientation orientation, int role) const</a>
<a name="ln1026">      {</a>
<a name="ln1027">      if ((orientation == Qt::Vertical &amp;&amp; !isRowValid(section))</a>
<a name="ln1028">                  || (orientation == Qt::Horizontal &amp;&amp; !isColumnValid(section))) {</a>
<a name="ln1029">            return QVariant();</a>
<a name="ln1030">            }</a>
<a name="ln1031"> </a>
<a name="ln1032">      if (orientation == Qt::Horizontal &amp;&amp; role == Qt::DisplayRole) {</a>
<a name="ln1033">            if (!_columns.empty()) {</a>
<a name="ln1034">                  return QCoreApplication::translate(&quot;MIDI import: tracks model&quot;,</a>
<a name="ln1035">                                      _columns[section]-&gt;headerName().toUtf8().constData());</a>
<a name="ln1036">                  }</a>
<a name="ln1037">            }</a>
<a name="ln1038">      else if (orientation == Qt::Vertical &amp;&amp; role == Qt::DisplayRole) {</a>
<a name="ln1039">            if (_trackCount &gt; 1) {</a>
<a name="ln1040">                  if (section == 0)</a>
<a name="ln1041">                        return QCoreApplication::translate(&quot;MIDI import: tracks model&quot;, &quot;All&quot;);</a>
<a name="ln1042">                  return section;</a>
<a name="ln1043">                  }</a>
<a name="ln1044">            return section + 1;</a>
<a name="ln1045">            }</a>
<a name="ln1046">      return QVariant();</a>
<a name="ln1047">      }</a>
<a name="ln1048"> </a>
<a name="ln1049">bool TracksModel::isTrackIndexValid(int trackIndex) const</a>
<a name="ln1050">      {</a>
<a name="ln1051">      return trackIndex &gt;= -1 &amp;&amp; trackIndex &lt; _trackCount;</a>
<a name="ln1052">      }</a>
<a name="ln1053"> </a>
<a name="ln1054">bool TracksModel::isRowValid(int row) const</a>
<a name="ln1055">      {</a>
<a name="ln1056">      return row &gt;= 0 &amp;&amp; ((_trackCount == 1) ? row &lt; _trackCount : row &lt;= _trackCount);</a>
<a name="ln1057">      }</a>
<a name="ln1058"> </a>
<a name="ln1059">bool TracksModel::isColumnValid(int column) const</a>
<a name="ln1060">      {</a>
<a name="ln1061">      return column &gt;= 0 &amp;&amp; column &lt; (int)_columns.size();</a>
<a name="ln1062">      }</a>
<a name="ln1063"> </a>
<a name="ln1064">} // namespace Ms</a>

</code></pre>
<div class="balloon" rel="359"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v560/" target="_blank">V560</a> A part of conditional expression is always true: !searchTuplets.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
