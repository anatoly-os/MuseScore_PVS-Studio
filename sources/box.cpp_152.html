
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>box.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">//=============================================================================</a>
<a name="ln2">//  MuseScore</a>
<a name="ln3">//  Music Composition &amp; Notation</a>
<a name="ln4">//</a>
<a name="ln5">//  Copyright (C) 2002-2011 Werner Schweer</a>
<a name="ln6">//</a>
<a name="ln7">//  This program is free software; you can redistribute it and/or modify</a>
<a name="ln8">//  it under the terms of the GNU General Public License version 2</a>
<a name="ln9">//  as published by the Free Software Foundation and appearing in</a>
<a name="ln10">//  the file LICENCE.GPL</a>
<a name="ln11">//=============================================================================</a>
<a name="ln12"> </a>
<a name="ln13">#include &quot;box.h&quot;</a>
<a name="ln14">#include &quot;textframe.h&quot;</a>
<a name="ln15">#include &quot;text.h&quot;</a>
<a name="ln16">#include &quot;score.h&quot;</a>
<a name="ln17">#include &quot;barline.h&quot;</a>
<a name="ln18">#include &quot;repeat.h&quot;</a>
<a name="ln19">#include &quot;symbol.h&quot;</a>
<a name="ln20">#include &quot;system.h&quot;</a>
<a name="ln21">#include &quot;image.h&quot;</a>
<a name="ln22">#include &quot;layoutbreak.h&quot;</a>
<a name="ln23">#include &quot;fret.h&quot;</a>
<a name="ln24">#include &quot;mscore.h&quot;</a>
<a name="ln25">#include &quot;stafftext.h&quot;</a>
<a name="ln26">#include &quot;icon.h&quot;</a>
<a name="ln27">#include &quot;xml.h&quot;</a>
<a name="ln28">#include &quot;measure.h&quot;</a>
<a name="ln29">#include &quot;undo.h&quot;</a>
<a name="ln30"> </a>
<a name="ln31">namespace Ms {</a>
<a name="ln32"> </a>
<a name="ln33">static const ElementStyle boxStyle {</a>
<a name="ln34">      { Sid::systemFrameDistance,                Pid::TOP_GAP                 },</a>
<a name="ln35">      { Sid::frameSystemDistance,                Pid::BOTTOM_GAP              },</a>
<a name="ln36">      };</a>
<a name="ln37"> </a>
<a name="ln38">static const ElementStyle hBoxStyle {</a>
<a name="ln39">      };</a>
<a name="ln40"> </a>
<a name="ln41">//---------------------------------------------------------</a>
<a name="ln42">//   Box</a>
<a name="ln43">//---------------------------------------------------------</a>
<a name="ln44"> </a>
<a name="ln45">Box::Box(Score* score)</a>
<a name="ln46">   : MeasureBase(score)</a>
<a name="ln47">      {</a>
<a name="ln48">      }</a>
<a name="ln49"> </a>
<a name="ln50">//---------------------------------------------------------</a>
<a name="ln51">//   layout</a>
<a name="ln52">//---------------------------------------------------------</a>
<a name="ln53"> </a>
<a name="ln54">void Box::layout()</a>
<a name="ln55">      {</a>
<a name="ln56">      MeasureBase::layout();</a>
<a name="ln57">      for (Element* e : el()) {</a>
<a name="ln58">            if (!e-&gt;isLayoutBreak())</a>
<a name="ln59">                  e-&gt;layout();</a>
<a name="ln60">            }</a>
<a name="ln61">      }</a>
<a name="ln62"> </a>
<a name="ln63">//---------------------------------------------------------</a>
<a name="ln64">//   computeMinWidth</a>
<a name="ln65">//---------------------------------------------------------</a>
<a name="ln66"> </a>
<a name="ln67">void HBox::computeMinWidth()</a>
<a name="ln68">      {</a>
<a name="ln69">      setWidth(point(boxWidth()) + topGap() + bottomGap());  // top/bottom is really left/right</a>
<a name="ln70">      }</a>
<a name="ln71"> </a>
<a name="ln72">//---------------------------------------------------------</a>
<a name="ln73">//   draw</a>
<a name="ln74">//---------------------------------------------------------</a>
<a name="ln75"> </a>
<a name="ln76">void Box::draw(QPainter* painter) const</a>
<a name="ln77">      {</a>
<a name="ln78">      if (score() &amp;&amp; score()-&gt;printing())</a>
<a name="ln79">            return;</a>
<a name="ln80">      if (selected() || editMode || dropTarget() || score()-&gt;showFrames()) {</a>
<a name="ln81">            qreal w = spatium() * .15;</a>
<a name="ln82">            QPainterPathStroker stroker;</a>
<a name="ln83">            stroker.setWidth(w);</a>
<a name="ln84">            stroker.setJoinStyle(Qt::MiterJoin);</a>
<a name="ln85">            stroker.setCapStyle(Qt::SquareCap);</a>
<a name="ln86"> </a>
<a name="ln87">            QVector&lt;qreal&gt; dashes ;</a>
<a name="ln88">            dashes.append(1);</a>
<a name="ln89">            dashes.append(3);</a>
<a name="ln90">            stroker.setDashPattern(dashes);</a>
<a name="ln91">            QPainterPath path;</a>
<a name="ln92">            w *= .5;</a>
<a name="ln93">            path.addRect(bbox().adjusted(w, w, -w, -w));</a>
<a name="ln94">            QPainterPath stroke = stroker.createStroke(path);</a>
<a name="ln95">            painter-&gt;setBrush(Qt::NoBrush);</a>
<a name="ln96">            painter-&gt;fillPath(stroke, (selected() || editMode || dropTarget()) ? MScore::selectColor[0] : MScore::frameMarginColor);</a>
<a name="ln97">            }</a>
<a name="ln98">      }</a>
<a name="ln99"> </a>
<a name="ln100">//---------------------------------------------------------</a>
<a name="ln101">//   startEdit</a>
<a name="ln102">//---------------------------------------------------------</a>
<a name="ln103"> </a>
<a name="ln104">void Box::startEdit(EditData&amp; ed)</a>
<a name="ln105">      {</a>
<a name="ln106">      Element::startEdit(ed);</a>
<a name="ln107">      editMode   = true;</a>
<a name="ln108">      }</a>
<a name="ln109"> </a>
<a name="ln110">//---------------------------------------------------------</a>
<a name="ln111">//   edit</a>
<a name="ln112">//---------------------------------------------------------</a>
<a name="ln113"> </a>
<a name="ln114">bool Box::edit(EditData&amp;)</a>
<a name="ln115">      {</a>
<a name="ln116">      return false;</a>
<a name="ln117">      }</a>
<a name="ln118"> </a>
<a name="ln119">//---------------------------------------------------------</a>
<a name="ln120">//   startEditDrag</a>
<a name="ln121">//---------------------------------------------------------</a>
<a name="ln122"> </a>
<a name="ln123">void Box::startEditDrag(EditData&amp; ed)</a>
<a name="ln124">      {</a>
<a name="ln125">      ElementEditData* eed = ed.getData(this);</a>
<a name="ln126">      if (isHBox())</a>
<a name="ln127">            eed-&gt;pushProperty(Pid::BOX_WIDTH);</a>
<a name="ln128">      else</a>
<a name="ln129">            eed-&gt;pushProperty(Pid::BOX_HEIGHT);</a>
<a name="ln130">      }</a>
<a name="ln131"> </a>
<a name="ln132">//---------------------------------------------------------</a>
<a name="ln133">//   editDrag</a>
<a name="ln134">//---------------------------------------------------------</a>
<a name="ln135"> </a>
<a name="ln136">void Box::editDrag(EditData&amp; ed)</a>
<a name="ln137">      {</a>
<a name="ln138">      if (isVBox()) {</a>
<a name="ln139">            _boxHeight = Spatium((ed.pos.y() - abbox().y()) / spatium());</a>
<a name="ln140">            if (ed.vRaster) {</a>
<a name="ln141">                  qreal vRaster = 1.0 / MScore::vRaster();</a>
<a name="ln142">                  int n = lrint(_boxHeight.val() / vRaster);</a>
<a name="ln143">                  _boxHeight = Spatium(vRaster * n);</a>
<a name="ln144">                  }</a>
<a name="ln145">            bbox().setRect(0.0, 0.0, system()-&gt;width(), point(boxHeight()));</a>
<a name="ln146">            system()-&gt;setHeight(height());</a>
<a name="ln147">            triggerLayout();</a>
<a name="ln148">            }</a>
<a name="ln149">      else {</a>
<a name="ln150">            _boxWidth += Spatium(ed.delta.x() / spatium());</a>
<a name="ln151">            if (ed.hRaster) {</a>
<a name="ln152">                  qreal hRaster = 1.0 / MScore::hRaster();</a>
<a name="ln153">                  int n = lrint(_boxWidth.val() / hRaster);</a>
<a name="ln154">                  _boxWidth = Spatium(hRaster * n);</a>
<a name="ln155">                  }</a>
<a name="ln156">            triggerLayout();</a>
<a name="ln157">            }</a>
<a name="ln158">      layout();</a>
<a name="ln159">      }</a>
<a name="ln160"> </a>
<a name="ln161">//---------------------------------------------------------</a>
<a name="ln162">//   endEdit</a>
<a name="ln163">//---------------------------------------------------------</a>
<a name="ln164"> </a>
<a name="ln165">void Box::endEdit(EditData&amp;)</a>
<a name="ln166">      {</a>
<a name="ln167">      editMode = false;</a>
<a name="ln168">      layout();</a>
<a name="ln169">      }</a>
<a name="ln170"> </a>
<a name="ln171">//---------------------------------------------------------</a>
<a name="ln172">//   gripsPositions</a>
<a name="ln173">//---------------------------------------------------------</a>
<a name="ln174"> </a>
<a name="ln175">std::vector&lt;QPointF&gt; HBox::gripsPositions(const EditData&amp;) const</a>
<a name="ln176">      {</a>
<a name="ln177">      QRectF r(abbox());</a>
<a name="ln178">      return { QPointF(r.right(), r.top() + r.height() * .5) };</a>
<a name="ln179">      }</a>
<a name="ln180"> </a>
<a name="ln181">std::vector&lt;QPointF&gt; VBox::gripsPositions(const EditData&amp;) const</a>
<a name="ln182">      {</a>
<a name="ln183">      QRectF r(abbox());</a>
<a name="ln184">      return { QPointF(r.x() + r.width() * .5, r.bottom()) };</a>
<a name="ln185">      }</a>
<a name="ln186"> </a>
<a name="ln187">//---------------------------------------------------------</a>
<a name="ln188">//   write</a>
<a name="ln189">//---------------------------------------------------------</a>
<a name="ln190"> </a>
<a name="ln191">void Box::write(XmlWriter&amp; xml) const</a>
<a name="ln192">      {</a>
<a name="ln193">      xml.stag(this);</a>
<a name="ln194">      writeProperties(xml);</a>
<a name="ln195">      xml.etag();</a>
<a name="ln196">      }</a>
<a name="ln197"> </a>
<a name="ln198">//---------------------------------------------------------</a>
<a name="ln199">//   writeProperties</a>
<a name="ln200">//---------------------------------------------------------</a>
<a name="ln201"> </a>
<a name="ln202">void Box::writeProperties(XmlWriter&amp; xml) const</a>
<a name="ln203">      {</a>
<a name="ln204">      for (Pid id : {</a>
<a name="ln205">         Pid::BOX_HEIGHT, Pid::BOX_WIDTH, Pid::TOP_GAP, Pid::BOTTOM_GAP,</a>
<a name="ln206">         Pid::LEFT_MARGIN, Pid::RIGHT_MARGIN, Pid::TOP_MARGIN, Pid::BOTTOM_MARGIN }) {</a>
<a name="ln207">            writeProperty(xml, id);</a>
<a name="ln208">            }</a>
<a name="ln209">      Element::writeProperties(xml);</a>
<a name="ln210">      for (const Element* e : el())</a>
<a name="ln211">            e-&gt;write(xml);</a>
<a name="ln212">      }</a>
<a name="ln213"> </a>
<a name="ln214">//---------------------------------------------------------</a>
<a name="ln215">//   read</a>
<a name="ln216">//---------------------------------------------------------</a>
<a name="ln217"> </a>
<a name="ln218">void Box::read(XmlReader&amp; e)</a>
<a name="ln219">      {</a>
<a name="ln220">      _leftMargin      = 0.0;</a>
<a name="ln221">      _rightMargin     = 0.0;</a>
<a name="ln222">      _topMargin       = 0.0;</a>
<a name="ln223">      _bottomMargin    = 0.0;</a>
<a name="ln224">      _boxHeight       = Spatium(0);     // override default set in constructor</a>
<a name="ln225">      _boxWidth        = Spatium(0);</a>
<a name="ln226">      MeasureBase::read(e);</a>
<a name="ln227">      }</a>
<a name="ln228"> </a>
<a name="ln229">//---------------------------------------------------------</a>
<a name="ln230">//   readProperties</a>
<a name="ln231">//---------------------------------------------------------</a>
<a name="ln232"> </a>
<a name="ln233">bool Box::readProperties(XmlReader&amp; e)</a>
<a name="ln234">      {</a>
<a name="ln235">      const QStringRef&amp; tag(e.name());</a>
<a name="ln236">      if (tag == &quot;height&quot;)</a>
<a name="ln237">            _boxHeight = Spatium(e.readDouble());</a>
<a name="ln238">      else if (tag == &quot;width&quot;)</a>
<a name="ln239">            _boxWidth = Spatium(e.readDouble());</a>
<a name="ln240">      else if (tag == &quot;topGap&quot;) {</a>
<a name="ln241">            _topGap = e.readDouble();</a>
<a name="ln242">            if (score()-&gt;mscVersion() &gt;= 206)</a>
<a name="ln243">                  _topGap *= score()-&gt;spatium();</a>
<a name="ln244">            setPropertyFlags(Pid::TOP_GAP, PropertyFlags::UNSTYLED);</a>
<a name="ln245">            }</a>
<a name="ln246">      else if (tag == &quot;bottomGap&quot;) {</a>
<a name="ln247">            _bottomGap = e.readDouble();</a>
<a name="ln248">             if (score()-&gt;mscVersion() &gt;= 206)</a>
<a name="ln249">                  _bottomGap *= score()-&gt;spatium();</a>
<a name="ln250">            setPropertyFlags(Pid::BOTTOM_GAP, PropertyFlags::UNSTYLED);</a>
<a name="ln251">            }</a>
<a name="ln252">      else if (tag == &quot;leftMargin&quot;)</a>
<a name="ln253">            _leftMargin = e.readDouble();</a>
<a name="ln254">      else if (tag == &quot;rightMargin&quot;)</a>
<a name="ln255">            _rightMargin = e.readDouble();</a>
<a name="ln256">      else if (tag == &quot;topMargin&quot;)</a>
<a name="ln257">            _topMargin = e.readDouble();</a>
<a name="ln258">      else if (tag == &quot;bottomMargin&quot;)</a>
<a name="ln259">            _bottomMargin = e.readDouble();</a>
<a name="ln260">      else if (tag == &quot;Text&quot;) {</a>
<a name="ln261">            Text* t;</a>
<a name="ln262">            if (isTBox()) {</a>
<a name="ln263">                  t = toTBox(this)-&gt;text();</a>
<a name="ln264">                  t-&gt;read(e);</a>
<a name="ln265">                  }</a>
<a name="ln266">            else {</a>
<a name="ln267">                  t = new Text(score());</a>
<a name="ln268">                  t-&gt;read(e);</a>
<a name="ln269">                  if (t-&gt;empty())</a>
<a name="ln270">                        qDebug(&quot;read empty text&quot;);</a>
<a name="ln271">                  else</a>
<a name="ln272">                        add(t);</a>
<a name="ln273">                  }</a>
<a name="ln274">            }</a>
<a name="ln275">      else if (tag == &quot;Symbol&quot;) {</a>
<a name="ln276">            Symbol* s = new Symbol(score());</a>
<a name="ln277">            s-&gt;read(e);</a>
<a name="ln278">            add(s);</a>
<a name="ln279">            }</a>
<a name="ln280">      else if (tag == &quot;Image&quot;) {</a>
<a name="ln281">            if (MScore::noImages)</a>
<a name="ln282">                  e.skipCurrentElement();</a>
<a name="ln283">            else {</a>
<a name="ln284">                  Image* image = new Image(score());</a>
<a name="ln285">                  image-&gt;setTrack(e.track());</a>
<a name="ln286">                  image-&gt;read(e);</a>
<a name="ln287">                  add(image);</a>
<a name="ln288">                  }</a>
<a name="ln289">            }</a>
<a name="ln290">      else if (tag == &quot;FretDiagram&quot;) {</a>
<a name="ln291">            FretDiagram* f = new FretDiagram(score());</a>
<a name="ln292">            f-&gt;read(e);</a>
<a name="ln293">            add(f);</a>
<a name="ln294">            }</a>
<a name="ln295">      else if (tag == &quot;HBox&quot;) {</a>
<a name="ln296">            HBox* hb = new HBox(score());</a>
<a name="ln297">            hb-&gt;read(e);</a>
<a name="ln298">            add(hb);</a>
<a name="ln299">            }</a>
<a name="ln300">      else if (tag == &quot;VBox&quot;) {</a>
<a name="ln301">            VBox* vb = new VBox(score());</a>
<a name="ln302">            vb-&gt;read(e);</a>
<a name="ln303">            add(vb);</a>
<a name="ln304">            }</a>
<a name="ln305">      else if (MeasureBase::readProperties(e))</a>
<a name="ln306">            ;</a>
<a name="ln307">      else</a>
<a name="ln308">            return false;</a>
<a name="ln309">      return true;</a>
<a name="ln310">      }</a>
<a name="ln311"> </a>
<a name="ln312">//---------------------------------------------------------</a>
<a name="ln313">//   add</a>
<a name="ln314">///   Add new Element \a el to Box</a>
<a name="ln315">//---------------------------------------------------------</a>
<a name="ln316"> </a>
<a name="ln317">void Box::add(Element* e)</a>
<a name="ln318">      {</a>
<a name="ln319">      if (e-&gt;isText())</a>
<a name="ln320">            toText(e)-&gt;setLayoutToParentWidth(true);</a>
<a name="ln321">      MeasureBase::add(e);</a>
<a name="ln322">      }</a>
<a name="ln323"> </a>
<a name="ln324">//---------------------------------------------------------</a>
<a name="ln325">//   getProperty</a>
<a name="ln326">//---------------------------------------------------------</a>
<a name="ln327"> </a>
<a name="ln328">QVariant Box::getProperty(Pid propertyId) const</a>
<a name="ln329">      {</a>
<a name="ln330">      switch(propertyId) {</a>
<a name="ln331">            case Pid::BOX_HEIGHT:</a>
<a name="ln332">                  return _boxHeight;</a>
<a name="ln333">            case Pid::BOX_WIDTH:</a>
<a name="ln334">                  return _boxWidth;</a>
<a name="ln335">            case Pid::TOP_GAP:</a>
<a name="ln336">                  return _topGap;</a>
<a name="ln337">            case Pid::BOTTOM_GAP:</a>
<a name="ln338">                  return _bottomGap;</a>
<a name="ln339">            case Pid::LEFT_MARGIN:</a>
<a name="ln340">                  return _leftMargin;</a>
<a name="ln341">            case Pid::RIGHT_MARGIN:</a>
<a name="ln342">                  return _rightMargin;</a>
<a name="ln343">            case Pid::TOP_MARGIN:</a>
<a name="ln344">                  return _topMargin;</a>
<a name="ln345">            case Pid::BOTTOM_MARGIN:</a>
<a name="ln346">                  return _bottomMargin;</a>
<a name="ln347">            default:</a>
<a name="ln348">                  return MeasureBase::getProperty(propertyId);</a>
<a name="ln349">            }</a>
<a name="ln350">      }</a>
<a name="ln351"> </a>
<a name="ln352">//---------------------------------------------------------</a>
<a name="ln353">//   setProperty</a>
<a name="ln354">//---------------------------------------------------------</a>
<a name="ln355"> </a>
<a name="ln356">bool Box::setProperty(Pid propertyId, const QVariant&amp; v)</a>
<a name="ln357">      {</a>
<a name="ln358">      score()-&gt;addRefresh(canvasBoundingRect());</a>
<a name="ln359">      switch (propertyId) {</a>
<a name="ln360">            case Pid::BOX_HEIGHT:</a>
<a name="ln361">                  _boxHeight = v.value&lt;Spatium&gt;();</a>
<a name="ln362">                  break;</a>
<a name="ln363">            case Pid::BOX_WIDTH:</a>
<a name="ln364">                  _boxWidth = v.value&lt;Spatium&gt;();</a>
<a name="ln365">                  break;</a>
<a name="ln366">            case Pid::TOP_GAP:</a>
<a name="ln367">                  _topGap = v.toDouble();</a>
<a name="ln368">                  break;</a>
<a name="ln369">            case Pid::BOTTOM_GAP:</a>
<a name="ln370">                  _bottomGap = v.toDouble();</a>
<a name="ln371">                  break;</a>
<a name="ln372">            case Pid::LEFT_MARGIN:</a>
<a name="ln373">                  _leftMargin = v.toDouble();</a>
<a name="ln374">                  break;</a>
<a name="ln375">            case Pid::RIGHT_MARGIN:</a>
<a name="ln376">                  _rightMargin = v.toDouble();</a>
<a name="ln377">                  break;</a>
<a name="ln378">            case Pid::TOP_MARGIN:</a>
<a name="ln379">                  _topMargin = v.toDouble();</a>
<a name="ln380">                  break;</a>
<a name="ln381">            case Pid::BOTTOM_MARGIN:</a>
<a name="ln382">                  _bottomMargin = v.toDouble();</a>
<a name="ln383">                  break;</a>
<a name="ln384">            default:</a>
<a name="ln385">                  return MeasureBase::setProperty(propertyId, v);</a>
<a name="ln386">            }</a>
<a name="ln387">      triggerLayout();</a>
<a name="ln388">      return true;</a>
<a name="ln389">      }</a>
<a name="ln390"> </a>
<a name="ln391">//---------------------------------------------------------</a>
<a name="ln392">//   propertyDefault</a>
<a name="ln393">//---------------------------------------------------------</a>
<a name="ln394"> </a>
<a name="ln395">QVariant Box::propertyDefault(Pid id) const</a>
<a name="ln396">      {</a>
<a name="ln397">      switch(id) {</a>
<a name="ln398">            case Pid::BOX_HEIGHT:</a>
<a name="ln399">            case Pid::BOX_WIDTH:</a>
<a name="ln400">                  return Spatium(0.0);</a>
<a name="ln401"> </a>
<a name="ln402">            case Pid::TOP_GAP:</a>
<a name="ln403">                  return isHBox() ? 0.0 : score()-&gt;styleP(Sid::systemFrameDistance);</a>
<a name="ln404">            case Pid::BOTTOM_GAP:</a>
<a name="ln405">                  return isHBox() ? 0.0 : score()-&gt;styleP(Sid::frameSystemDistance);</a>
<a name="ln406"> </a>
<a name="ln407">            case Pid::LEFT_MARGIN:</a>
<a name="ln408">            case Pid::RIGHT_MARGIN:</a>
<a name="ln409">            case Pid::TOP_MARGIN:</a>
<a name="ln410">            case Pid::BOTTOM_MARGIN:</a>
<a name="ln411">                  return 0.0;</a>
<a name="ln412">            default:</a>
<a name="ln413">                  return MeasureBase::propertyDefault(id);</a>
<a name="ln414">            }</a>
<a name="ln415">      }</a>
<a name="ln416"> </a>
<a name="ln417">//---------------------------------------------------------</a>
<a name="ln418">//   copyValues</a>
<a name="ln419">//---------------------------------------------------------</a>
<a name="ln420"> </a>
<a name="ln421">void Box::copyValues(Box* origin)</a>
<a name="ln422">      {</a>
<a name="ln423">      _boxHeight    = origin-&gt;boxHeight();</a>
<a name="ln424">      _boxWidth     = origin-&gt;boxWidth();</a>
<a name="ln425"> </a>
<a name="ln426">      qreal factor  = magS() / origin-&gt;magS();</a>
<a name="ln427">      _bottomGap    = origin-&gt;bottomGap() * factor;</a>
<a name="ln428">      _topGap       = origin-&gt;topGap() * factor;</a>
<a name="ln429">      _bottomMargin = origin-&gt;bottomMargin() * factor;</a>
<a name="ln430">      _topMargin    = origin-&gt;topMargin() * factor;</a>
<a name="ln431">      _leftMargin   = origin-&gt;leftMargin() * factor;</a>
<a name="ln432">      _rightMargin  = origin-&gt;rightMargin() * factor;</a>
<a name="ln433">      }</a>
<a name="ln434"> </a>
<a name="ln435">//---------------------------------------------------------</a>
<a name="ln436">//   HBox</a>
<a name="ln437">//---------------------------------------------------------</a>
<a name="ln438"> </a>
<a name="ln439">HBox::HBox(Score* score)</a>
<a name="ln440">   : Box(score)</a>
<a name="ln441">      {</a>
<a name="ln442">      initElementStyle(&amp;hBoxStyle);</a>
<a name="ln443">      setBoxWidth(Spatium(5.0));</a>
<a name="ln444">      }</a>
<a name="ln445"> </a>
<a name="ln446">//---------------------------------------------------------</a>
<a name="ln447">//   layout</a>
<a name="ln448">//---------------------------------------------------------</a>
<a name="ln449"> </a>
<a name="ln450">void HBox::layout()</a>
<a name="ln451">      {</a>
<a name="ln452">      if (parent() &amp;&amp; parent()-&gt;isVBox()) {</a>
<a name="ln453">            VBox* vb = toVBox(parent());</a>
<a name="ln454">            qreal x = vb-&gt;leftMargin() * DPMM;</a>
<a name="ln455">            qreal y = vb-&gt;topMargin() * DPMM;</a>
<a name="ln456">            qreal w = point(boxWidth());</a>
<a name="ln457">            qreal h = vb-&gt;height() - (vb-&gt;topMargin() + vb-&gt;bottomMargin()) * DPMM;</a>
<a name="ln458">            setPos(x, y);</a>
<a name="ln459">            bbox().setRect(0.0, 0.0, w, h);</a>
<a name="ln460">            }</a>
<a name="ln461">      else if (system()) {</a>
<a name="ln462">            bbox().setRect(0.0, 0.0, point(boxWidth()), system()-&gt;height());</a>
<a name="ln463">            }</a>
<a name="ln464">      else {</a>
<a name="ln465">            bbox().setRect(0.0, 0.0, 50, 50);</a>
<a name="ln466">            }</a>
<a name="ln467">      Box::layout();</a>
<a name="ln468">      }</a>
<a name="ln469"> </a>
<a name="ln470">//---------------------------------------------------------</a>
<a name="ln471">//   layout2</a>
<a name="ln472">//    height (bbox) is defined now</a>
<a name="ln473">//---------------------------------------------------------</a>
<a name="ln474"> </a>
<a name="ln475">void HBox::layout2()</a>
<a name="ln476">      {</a>
<a name="ln477">      Box::layout();</a>
<a name="ln478">      }</a>
<a name="ln479"> </a>
<a name="ln480">//---------------------------------------------------------</a>
<a name="ln481">//   acceptDrop</a>
<a name="ln482">//---------------------------------------------------------</a>
<a name="ln483"> </a>
<a name="ln484">bool Box::acceptDrop(EditData&amp; data) const</a>
<a name="ln485">      {</a>
<a name="ln486">      if (data.dropElement-&gt;flag(ElementFlag::ON_STAFF))</a>
<a name="ln487">            return false;</a>
<a name="ln488">      if (MScore::debugMode)</a>
<a name="ln489">            qDebug(&quot;&lt;%s&gt;&quot;, data.dropElement-&gt;name());</a>
<a name="ln490">      ElementType t = data.dropElement-&gt;type();</a>
<a name="ln491">      switch (t) {</a>
<a name="ln492">            case ElementType::LAYOUT_BREAK:</a>
<a name="ln493">            case ElementType::TEXT:</a>
<a name="ln494">            case ElementType::STAFF_TEXT:</a>
<a name="ln495">            case ElementType::IMAGE:</a>
<a name="ln496">            case ElementType::SYMBOL:</a>
<a name="ln497">                  return true;</a>
<a name="ln498">            case ElementType::ICON:</a>
<a name="ln499">                  switch (toIcon(data.dropElement)-&gt;iconType()) {</a>
<a name="ln500">                        case IconType::VFRAME:</a>
<a name="ln501">                        case IconType::TFRAME:</a>
<a name="ln502">                        case IconType::FFRAME:</a>
<a name="ln503">                        case IconType::MEASURE:</a>
<a name="ln504">                              return true;</a>
<a name="ln505">                        default:</a>
<a name="ln506">                              break;</a>
<a name="ln507">                        }</a>
<a name="ln508">                  break;</a>
<a name="ln509">            case ElementType::BAR_LINE:</a>
<a name="ln510">                  return isHBox();</a>
<a name="ln511">            default:</a>
<a name="ln512">                  break;</a>
<a name="ln513">            }</a>
<a name="ln514">      return false;</a>
<a name="ln515">      }</a>
<a name="ln516"> </a>
<a name="ln517">//---------------------------------------------------------</a>
<a name="ln518">//   drop</a>
<a name="ln519">//---------------------------------------------------------</a>
<a name="ln520"> </a>
<a name="ln521">Element* Box::drop(EditData&amp; data)</a>
<a name="ln522">      {</a>
<a name="ln523">      Element* e = data.dropElement;</a>
<a name="ln524">      if (e-&gt;flag(ElementFlag::ON_STAFF))</a>
<a name="ln525">            return 0;</a>
<a name="ln526">      if (MScore::debugMode)</a>
<a name="ln527">            qDebug(&quot;&lt;%s&gt;&quot;, e-&gt;name());</a>
<a name="ln528">      switch (e-&gt;type()) {</a>
<a name="ln529">            case ElementType::LAYOUT_BREAK:</a>
<a name="ln530">                  {</a>
<a name="ln531">                  LayoutBreak* lb = toLayoutBreak(e);</a>
<a name="ln532">                  if (pageBreak() || lineBreak()) {</a>
<a name="ln533">                        if (</a>
<a name="ln534">                           (lb-&gt;isPageBreak() &amp;&amp; pageBreak())</a>
<a name="ln535">                           || (lb-&gt;isLineBreak() &amp;&amp; lineBreak())</a>
<a name="ln536">                           || (lb-&gt;isSectionBreak() &amp;&amp; sectionBreak())</a>
<a name="ln537">                           ) {</a>
<a name="ln538">                              //</a>
<a name="ln539">                              // if break already set</a>
<a name="ln540">                              //</a>
<a name="ln541">                              delete lb;</a>
<a name="ln542">                              break;</a>
<a name="ln543">                              }</a>
<a name="ln544">                        for (Element* elem : el()) {</a>
<a name="ln545">                              if (elem-&gt;type() == ElementType::LAYOUT_BREAK) {</a>
<a name="ln546">                                    score()-&gt;undoChangeElement(elem, e);</a>
<a name="ln547">                                    break;</a>
<a name="ln548">                                    }</a>
<a name="ln549">                              }</a>
<a name="ln550">                        break;</a>
<a name="ln551">                        }</a>
<a name="ln552">                  lb-&gt;setTrack(-1);       // these are system elements</a>
<a name="ln553">                  lb-&gt;setParent(this);</a>
<a name="ln554">                  score()-&gt;undoAddElement(lb);</a>
<a name="ln555">                  return lb;</a>
<a name="ln556">                  }</a>
<a name="ln557"> </a>
<a name="ln558">            case ElementType::STAFF_TEXT:</a>
<a name="ln559">                  {</a>
<a name="ln560">                  Text* text = new Text(score(), Tid::FRAME);</a>
<a name="ln561">                  text-&gt;setParent(this);</a>
<a name="ln562">                  text-&gt;setXmlText(toStaffText(e)-&gt;xmlText());</a>
<a name="ln563">                  score()-&gt;undoAddElement(text);</a>
<a name="ln564">                  delete e;</a>
<a name="ln565">                  return text;</a>
<a name="ln566">                  }</a>
<a name="ln567"> </a>
<a name="ln568">            case ElementType::ICON:</a>
<a name="ln569">                  switch (toIcon(e)-&gt;iconType()) {</a>
<a name="ln570">                        case IconType::VFRAME:</a>
<a name="ln571">                              score()-&gt;insertMeasure(ElementType::VBOX, this);</a>
<a name="ln572">                              break;</a>
<a name="ln573">                        case IconType::TFRAME:</a>
<a name="ln574">                              score()-&gt;insertMeasure(ElementType::TBOX, this);</a>
<a name="ln575">                              break;</a>
<a name="ln576">                        case IconType::FFRAME:</a>
<a name="ln577">                              score()-&gt;insertMeasure(ElementType::FBOX, this);</a>
<a name="ln578">                              break;</a>
<a name="ln579">                        case IconType::MEASURE:</a>
<a name="ln580">                              score()-&gt;insertMeasure(ElementType::MEASURE, this);</a>
<a name="ln581">                              break;</a>
<a name="ln582">                        default:</a>
<a name="ln583">                              break;</a>
<a name="ln584">                        }</a>
<a name="ln585">                  break;</a>
<a name="ln586"> </a>
<a name="ln587">            case ElementType::TEXT:</a>
<a name="ln588">            case ElementType::IMAGE:</a>
<a name="ln589">            case ElementType::SYMBOL:</a>
<a name="ln590">                  e-&gt;setParent(this);</a>
<a name="ln591">                  score()-&gt;undoAddElement(e);</a>
<a name="ln592">                  return e;</a>
<a name="ln593">            default:</a>
<a name="ln594">                  return 0;</a>
<a name="ln595">            }</a>
<a name="ln596">      return 0;</a>
<a name="ln597">      }</a>
<a name="ln598"> </a>
<a name="ln599">//---------------------------------------------------------</a>
<a name="ln600">//   drag</a>
<a name="ln601">//---------------------------------------------------------</a>
<a name="ln602"> </a>
<a name="ln603">QRectF HBox::drag(EditData&amp; data)</a>
<a name="ln604">      {</a>
<a name="ln605">      QRectF r(canvasBoundingRect());</a>
<a name="ln606">      qreal diff = data.delta.x();</a>
<a name="ln607">      qreal x1   = offset().x() + diff;</a>
<a name="ln608">      if (parent()-&gt;type() == ElementType::VBOX) {</a>
<a name="ln609">            VBox* vb = toVBox(parent());</a>
<a name="ln610">            qreal x2 = parent()-&gt;width() - width() - (vb-&gt;leftMargin() + vb-&gt;rightMargin()) * DPMM;</a>
<a name="ln611">            if (x1 &lt; 0.0)</a>
<a name="ln612">                  x1 = 0.0;</a>
<a name="ln613">            else if (x1 &gt; x2)</a>
<a name="ln614">                  x1 = x2;</a>
<a name="ln615">            }</a>
<a name="ln616">      setOffset(QPointF(x1, 0.0));</a>
<a name="ln617">//      setStartDragPosition(data.delta);</a>
<a name="ln618">      return canvasBoundingRect() | r;</a>
<a name="ln619">      }</a>
<a name="ln620"> </a>
<a name="ln621">//---------------------------------------------------------</a>
<a name="ln622">//   endEditDrag</a>
<a name="ln623">//---------------------------------------------------------</a>
<a name="ln624"> </a>
<a name="ln625">void HBox::endEditDrag(EditData&amp;)</a>
<a name="ln626">      {</a>
<a name="ln627">      triggerLayout();</a>
<a name="ln628">      score()-&gt;update();</a>
<a name="ln629">      }</a>
<a name="ln630"> </a>
<a name="ln631">//---------------------------------------------------------</a>
<a name="ln632">//   isMovable</a>
<a name="ln633">//---------------------------------------------------------</a>
<a name="ln634"> </a>
<a name="ln635">bool HBox::isMovable() const</a>
<a name="ln636">      {</a>
<a name="ln637">      return parent() &amp;&amp; (parent()-&gt;isHBox() || parent()-&gt;isVBox());</a>
<a name="ln638">      }</a>
<a name="ln639"> </a>
<a name="ln640">//---------------------------------------------------------</a>
<a name="ln641">//   writeProperties</a>
<a name="ln642">//---------------------------------------------------------</a>
<a name="ln643"> </a>
<a name="ln644">void HBox::writeProperties(XmlWriter&amp; xml) const</a>
<a name="ln645">      {</a>
<a name="ln646">      writeProperty(xml, Pid::CREATE_SYSTEM_HEADER);</a>
<a name="ln647">      Box::writeProperties(xml);</a>
<a name="ln648">      }</a>
<a name="ln649"> </a>
<a name="ln650">//---------------------------------------------------------</a>
<a name="ln651">//   readProperties</a>
<a name="ln652">//---------------------------------------------------------</a>
<a name="ln653"> </a>
<a name="ln654">bool HBox::readProperties(XmlReader&amp; e)</a>
<a name="ln655">      {</a>
<a name="ln656">      const QStringRef&amp; tag(e.name());</a>
<a name="ln657">      if (readProperty(tag, e, Pid::CREATE_SYSTEM_HEADER))</a>
<a name="ln658">            ;</a>
<a name="ln659">      else if (Box::readProperties(e))</a>
<a name="ln660">            ;</a>
<a name="ln661">      else</a>
<a name="ln662">            return false;</a>
<a name="ln663">      return true;</a>
<a name="ln664">      }</a>
<a name="ln665"> </a>
<a name="ln666">//---------------------------------------------------------</a>
<a name="ln667">//   getProperty</a>
<a name="ln668">//---------------------------------------------------------</a>
<a name="ln669"> </a>
<a name="ln670">QVariant HBox::getProperty(Pid propertyId) const</a>
<a name="ln671">      {</a>
<a name="ln672">      switch (propertyId) {</a>
<a name="ln673">            case Pid::CREATE_SYSTEM_HEADER:</a>
<a name="ln674">                  return createSystemHeader();</a>
<a name="ln675">            default:</a>
<a name="ln676">                  return Box::getProperty(propertyId);</a>
<a name="ln677">            }</a>
<a name="ln678">      }</a>
<a name="ln679"> </a>
<a name="ln680">//---------------------------------------------------------</a>
<a name="ln681">//   setProperty</a>
<a name="ln682">//---------------------------------------------------------</a>
<a name="ln683"> </a>
<a name="ln684">bool HBox::setProperty(Pid propertyId, const QVariant&amp; v)</a>
<a name="ln685">      {</a>
<a name="ln686">      switch (propertyId) {</a>
<a name="ln687">            case Pid::CREATE_SYSTEM_HEADER:</a>
<a name="ln688">                  setCreateSystemHeader(v.toBool());</a>
<a name="ln689">                  triggerLayout();</a>
<a name="ln690">                  break;</a>
<a name="ln691">            default:</a>
<a name="ln692">                  return Box::setProperty(propertyId, v);</a>
<a name="ln693">            }</a>
<a name="ln694">      return true;</a>
<a name="ln695">      }</a>
<a name="ln696"> </a>
<a name="ln697">//---------------------------------------------------------</a>
<a name="ln698">//   propertyDefault</a>
<a name="ln699">//---------------------------------------------------------</a>
<a name="ln700"> </a>
<a name="ln701">QVariant HBox::propertyDefault(Pid id) const</a>
<a name="ln702">      {</a>
<a name="ln703">      switch(id) {</a>
<a name="ln704">            case Pid::CREATE_SYSTEM_HEADER:</a>
<a name="ln705">                  return true;</a>
<a name="ln706">            default:</a>
<a name="ln707">                  return Box::propertyDefault(id);</a>
<a name="ln708">            }</a>
<a name="ln709">      }</a>
<a name="ln710"> </a>
<a name="ln711">//---------------------------------------------------------</a>
<a name="ln712">//   VBox</a>
<a name="ln713">//---------------------------------------------------------</a>
<a name="ln714"> </a>
<a name="ln715">VBox::VBox(Score* score)</a>
<a name="ln716">   : Box(score)</a>
<a name="ln717">      {</a>
<a name="ln718">      initElementStyle(&amp;boxStyle);</a>
<a name="ln719">      setBoxHeight(Spatium(10.0));</a>
<a name="ln720">      setLineBreak(true);</a>
<a name="ln721">      }</a>
<a name="ln722"> </a>
<a name="ln723">//---------------------------------------------------------</a>
<a name="ln724">//   layout</a>
<a name="ln725">//---------------------------------------------------------</a>
<a name="ln726"> </a>
<a name="ln727">void VBox::layout()</a>
<a name="ln728">      {</a>
<a name="ln729">      setPos(QPointF());</a>
<a name="ln730">      if (system())</a>
<a name="ln731">            bbox().setRect(0.0, 0.0, system()-&gt;width(), point(boxHeight()));</a>
<a name="ln732">      else</a>
<a name="ln733">            bbox().setRect(0.0, 0.0, 50, 50);</a>
<a name="ln734">      Box::layout();</a>
<a name="ln735">      }</a>
<a name="ln736"> </a>
<a name="ln737">//---------------------------------------------------------</a>
<a name="ln738">//   layout</a>
<a name="ln739">//---------------------------------------------------------</a>
<a name="ln740"> </a>
<a name="ln741">void FBox::layout()</a>
<a name="ln742">      {</a>
<a name="ln743">//      setPos(QPointF());      // !?</a>
<a name="ln744">      bbox().setRect(0.0, 0.0, system()-&gt;width(), point(boxHeight()));</a>
<a name="ln745">      Box::layout();</a>
<a name="ln746">      }</a>
<a name="ln747"> </a>
<a name="ln748">//---------------------------------------------------------</a>
<a name="ln749">//   add</a>
<a name="ln750">///   Add new Element \a e to fret diagram box</a>
<a name="ln751">//---------------------------------------------------------</a>
<a name="ln752"> </a>
<a name="ln753">void FBox::add(Element* e)</a>
<a name="ln754">      {</a>
<a name="ln755">      e-&gt;setParent(this);</a>
<a name="ln756">      if (e-&gt;isFretDiagram()) {</a>
<a name="ln757">//            FretDiagram* fd = toFretDiagram(e);</a>
<a name="ln758">//            fd-&gt;setFlag(ElementFlag::MOVABLE, false);</a>
<a name="ln759">            }</a>
<a name="ln760">      else {</a>
<a name="ln761">            qDebug(&quot;FBox::add: element not allowed&quot;);</a>
<a name="ln762">            return;</a>
<a name="ln763">            }</a>
<a name="ln764">      el().push_back(e);</a>
<a name="ln765">      }</a>
<a name="ln766"> </a>
<a name="ln767">//---------------------------------------------------------</a>
<a name="ln768">//   accessibleExtraInfo</a>
<a name="ln769">//---------------------------------------------------------</a>
<a name="ln770"> </a>
<a name="ln771">QString Box::accessibleExtraInfo() const</a>
<a name="ln772">      {</a>
<a name="ln773">      QString rez = &quot;&quot;;</a>
<a name="ln774">      for (Element* e : el())</a>
<a name="ln775">            rez += &quot; &quot; + e-&gt;screenReaderInfo();</a>
<a name="ln776">      return rez;</a>
<a name="ln777">      }</a>
<a name="ln778"> </a>
<a name="ln779">//---------------------------------------------------------</a>
<a name="ln780">//   accessibleExtraInfo</a>
<a name="ln781">//---------------------------------------------------------</a>
<a name="ln782"> </a>
<a name="ln783">QString TBox::accessibleExtraInfo() const</a>
<a name="ln784">      {</a>
<a name="ln785">      QString rez = _text-&gt;screenReaderInfo();</a>
<a name="ln786">      return rez;</a>
<a name="ln787">      }</a>
<a name="ln788"> </a>
<a name="ln789">}</a>
<a name="ln790"> </a>

</code></pre>
<div class="balloon" rel="489"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="527"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v618/" target="_blank">V618</a> It's dangerous to call the 'debug' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf("%s", str);</p></div>
<div class="balloon" rel="8"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1042/" target="_blank">V1042</a> This file is marked with copyleft license, which requires you to open the derived source code.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
